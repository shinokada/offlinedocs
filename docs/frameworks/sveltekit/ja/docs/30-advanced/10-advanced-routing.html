<!doctypehtml><html lang="ja"><meta charset="utf-8"><title>高度なルーティング</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="高度なルーティング"class="level1"><h1>高度なルーティング</h1><section id="restパラメータ"class="level2"><h2>Restパラメータ</h2><p>ルートセグメント(route segments)の数がわからない場合は、rest 構文を使用することができます。例えば GitHub のファイルビューアのようなものを実装する場合は…<pre class="language-bash"><code class="language-bash">/<span class="token punctuation">[</span>org<span class="token punctuation">]</span>/<span class="token punctuation">[</span>repo<span class="token punctuation">]</span>/tree/<span class="token punctuation">[</span>branch<span class="token punctuation">]</span>/<span class="token punctuation">[</span><span class="token punctuation">..</span>.file<span class="token punctuation">]</span></code></pre><p>…この場合、<code>/sveltejs/kit/tree/master/documentation/docs/04-advanced-routing.md</code> をリクエストすると、以下のパラメータをページで使うことができます:<pre class="language-js"><code class="language-js"><span class="token comment">// @noErrors</span>
<span class="token punctuation">{</span>
	<span class="token literal-property property">org</span><span class="token operator">:</span> <span class="token string">'sveltejs'</span><span class="token punctuation">,</span>
	<span class="token literal-property property">repo</span><span class="token operator">:</span> <span class="token string">'kit'</span><span class="token punctuation">,</span>
	<span class="token literal-property property">branch</span><span class="token operator">:</span> <span class="token string">'master'</span><span class="token punctuation">,</span>
	<span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'documentation/docs/04-advanced-routing.md'</span>
<span class="token punctuation">}</span></code></pre><blockquote><p><code>src/routes/a/[...rest]/z/+page.svelte</code> は <code>/a/z</code> にも (つまり、パラメータが全くない場合にも)、<code>/a/b/z</code> や <code>/a/b/c/z</code> と同様にマッチします。Rest パラメータの値が正しいことを、例えば <a href="#matching">matcher</a> を使用するなどして確認してください。</blockquote><section id="404-pages"class="level3"><h3>404 pages</h3><p>Rest パラメータによってカスタムの 404 をレンダリングすることができます。これらのルート(routes)があるとして…<pre class="language-text"><code class="language-text">src/routes/
├ marx-brothers/
│ ├ chico/
│ ├ harpo/
│ ├ groucho/
│ └ +error.svelte
└ +error.svelte</code></pre><p>…もし <code>/marx-brothers/karl</code> にリクエストしても、<code>marx-brothers/+error.svelte</code> ファイルはレンダリング <em>されません</em> 。なぜならどのルート(route) にもマッチしないからです。もしネストしたエラーページをレンダリングしたければ、どんな <code>/marx-brothers/*</code> リクエストにもマッチするルート(route)を作成し、そこから 404 を返すようにしてください:<pre class="language-diff"><code class="language-diff">src/routes/
├ marx-brothers/
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">| ├ [...path]/
</span></span>│ ├ chico/
│ ├ harpo/
│ ├ groucho/
│ └ +error.svelte
└ +error.svelte</code></pre><pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/routes/marx-brothers/[...path]/+page.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> error <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./$types'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageLoad<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">throw</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'Not Found'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>もし 404 のケースをハンドリングしていない場合、<a href="../30-advanced/20-hooks.html#shared-hooks-handleerror"><code>handleError</code></a> によって表示が行われます。</blockquote></section></section><section id="optional-parameters"class="level2"><h2>Optional parameters</h2><p><code>[lang]/home</code> というルートに含まれる <code>lang</code> というパラメータは必須です。これらのパラメータをオプションにできると、今回の例では <code>home</code> と <code>en/home</code> のどちらも同じページを指すことができるのでとても便利です。パラメータにもう1つ括弧を付けることでこれができるようになります: <code>[[lang]]/home</code><p>optional のルートパラメータ(route parameter)は rest パラメータに続けて使用すること (<code>[...rest]/[[optional]]</code>) はできません。パラメータは 'greedily' にマッチし、optional のパラメータは使用されないこともあるためです。</section><section id="マッチングmatching"class="level2"><h2>マッチング(Matching)</h2><p><code>src/routes/archive/[page]</code> のようなルート(route)は <code>/archive/3</code> にマッチしますが、<code>/archive/potato</code> にもマッチしてしまいます。これを防ぎたい場合、パラメータ文字列(<code>"3"</code> や <code>"potato"</code>)を引数に取ってそれが有効なら <code>true</code> を返す <em>matcher</em> を <a href="../50-api-reference/10-configuration.html#files"><code>params</code></a> ディレクトリに追加することで、ルート(route)のパラメータを適切に定義することができます…<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/params/integer.js</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ParamMatcher<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">param</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\d+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token method function property-access">test</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>…そしてルート(routes)を拡張します:<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">src/routes/archive/[page]
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">src/routes/archive/[page=integer]</span></span></code></pre><p>もしパス名がマッチしない場合、SvelteKit は (後述のソート順の指定に従って) 他のルートでマッチするか試行し、どれにもマッチしない場合は最終的に 404 を返します。<blockquote><p>Matcher は サーバーとブラウザの両方で動作します。</blockquote></section><section id="ソートsorting"class="level2"><h2>ソート(Sorting)</h2><p>あるパスに対し、マッチするルート(routes)は複数でも構いません。例えば、これらのルート(routes)はどれも <code>/foo-abc</code> にマッチします:<pre class="language-bash"><code class="language-bash">src/routes/<span class="token punctuation">[</span><span class="token punctuation">..</span>.catchall<span class="token punctuation">]</span>/+page.svelte
src/routes/<span class="token punctuation">[</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">]</span>/foo/+page.svelte
src/routes/<span class="token punctuation">[</span>b<span class="token punctuation">]</span>/+page.svelte
src/routes/foo-<span class="token punctuation">[</span>c<span class="token punctuation">]</span>/+page.svelte
src/routes/foo-abc/+page.svelte</code></pre><p>SvelteKit は、どのルート(route)に対してリクエストされているのかを判断しなければなりません。そのため、以下のルールに従ってこれらをソートします…<ul><li>より詳細・明確(specific)なルート(routes)ほど、より優先度が高い (例えば、動的なパラメータが1つあるルートより、パラメータのないルートのほうがより詳細・明確(specific)である、など)<li><a href="#matching">matchers</a> 付きのパラメータ (<code>[name=type]</code>) は matchers なしのパラメータ (<code>[name]</code>) よりも優先度が高い<li><code>[[optional]]</code> と <code>[...rest]</code> パラメータはルート(route)の最後の部分でない限り無視される (最後の部分になっている場合は最も低い優先度として扱われる)。言い換えると、ソートの目的上、<code>x/[[y]]/z</code> と <code>x/z</code> は同等に扱われる<li>優先度が同じ場合はアルファベット順で解決される</ul><p>…この順序で並べると、<code>/foo-abc</code> の場合は <code>src/routes/foo-abc/+page.svelte</code> を呼び出し、<code>/foo-def</code> の場合は <code>src/routes/foo-[c]/+page.svelte</code> を呼び出します:<pre class="language-bash"><code class="language-bash">src/routes/foo-abc/+page.svelte
src/routes/foo-<span class="token punctuation">[</span>c<span class="token punctuation">]</span>/+page.svelte
src/routes/<span class="token punctuation">[</span><span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token punctuation">]</span>/foo/+page.svelte
src/routes/<span class="token punctuation">[</span>b<span class="token punctuation">]</span>/+page.svelte
src/routes/<span class="token punctuation">[</span><span class="token punctuation">..</span>.catchall<span class="token punctuation">]</span>/+page.svelte</code></pre></section><section id="エンコードencoding"class="level2"><h2>エンコード(Encoding)</h2><p>ファイルシステムでは使用できない文字があります — Linux と Mac では <code>/</code>、Windows では <code>\ / : * ? " &#x3C; > |</code> です。URL においては、<code>#</code> と <code>%</code> には特別な意味がありますし、SvelteKit においては <code>[ ] ( )</code> に特別な意味があります。そのため、これらの文字をそのままルート(route)に使用することはできません。<p>これらの文字をルート(route)に使用するには、16進数のエスケープシーケンスを使います。<code>[x+nn]</code> というフォーマットで、<code>nn</code> の部分は16進数の文字コードです:<ul><li><code>\</code> — <code>[x+5c]</code><li><code>/</code> — <code>[x+2f]</code><li><code>:</code> — <code>[x+3a]</code><li><code>*</code> — <code>[x+2a]</code><li><code>?</code> — <code>[x+3f]</code><li><code>"</code> — <code>[x+22]</code><li><code>&#x3C;</code> — <code>[x+3c]</code><li><code>></code> — <code>[x+3e]</code><li><code>|</code> — <code>[x+7c]</code><li><code>#</code> — <code>[x+23]</code><li><code>%</code> — <code>[x+25]</code><li><code>[</code> — <code>[x+5b]</code><li><code>]</code> — <code>[x+5d]</code><li><code>(</code> — <code>[x+28]</code><li><code>)</code> — <code>[x+29]</code></ul><p>例えば、<code>/smileys/:-)</code> というルート(route)を作る場合は、<code>src/routes/smileys/[x+3a]-[x+29]/+page.svelte</code> ファイルを作成します。<p>JavaScript を使って文字の16進数コードを判定することができます:<pre class="language-js"><code class="language-js"><span class="token string">':'</span><span class="token punctuation">.</span><span class="token method function property-access">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// '3a', hence '[x+3a]'</span></code></pre><p>また、Unicode のエスケープシーケンスを使用することもできます。通常、エンコードされていない文字を直接使用することができるので、こうする必要はありませんが、何らかの理由で、例えばファイル名に絵文字を使用することができない場合、エスケープ文字を使用することができます。言い換えると、以下は同じことをしているということです:<pre class="language-text"><code class="language-text">src/routes/[u+d83e][u+dd2a]/+page.svelte
src/routes/🤪/+page.svelte</code></pre><p>Unicode エスケープシーケンスのフォーマットは <code>[u+nnnn]</code> で、<code>nnnn</code> の部分は <code>0000</code> から <code>10ffff</code> までの適切な値です。(JavaScript の文字列エスケープとは異なり、<code>ffff</code> 以上のコードポイントを表現するためにサロゲートペアを使用する必要はありません。) Unicode エンコーディングについてもっと知りたい方は、<a href="https://unicodebook.readthedocs.io/unicode_encodings.html">Programming with Unicode</a> を参照してください。<blockquote><p>ディレクトリの先頭に <code>.</code> 文字があると、TypeScript で <a href="https://github.com/microsoft/TypeScript/issues/13399">問題</a> が起きるため、例えば <a href="https://en.wikipedia.org/wiki/Well-known_URI"><code>.well-known</code></a> のようなルート(route)を作る場合はこれらの文字をエンコードしておくと良いでしょう: <code>src/routes/[x+2e]well-known/...</code></blockquote></section><section id="advanced-layouts"class="level2"><h2>Advanced layouts</h2><p>デフォルトでは、 <em>レイアウトの階層</em> が <em>ルート(route)の階層</em> に反映されます。場合によっては、そうしたくないこともあるかもしれません。<section id="group"class="level3"><h3>(group)</h3><p>'アプリ' のルート(routes)としてのレイアウト (例えば <code>/dashboard</code> や <code>/item</code>) が1つあり、'マーケティング' のルート(routes)としての別のレイアウト (<code>/blog</code> や <code>/testimonials</code>) があるかもしれません。これらのルート(routes)を、ディレクトリの名前を括弧でくくることでグループ化することができます。通常のディレクトリとは異なり、<code>(app)</code> や <code>(marketing)</code> はそれらの中のルート(routes)の URL パス名には影響しません:<pre class="language-diff"><code class="language-diff">src/routes/
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">│ (app)/
</span></span>│ ├ dashboard/
│ ├ item/
│ └ +layout.svelte
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">│ (marketing)/
</span></span>│ ├ about/
│ ├ testimonials/
│ └ +layout.svelte
├ admin/
└ +layout.svelte</code></pre><p><code>+page</code> を <code>(group)</code> の中に直接配置することもできます (例えば、<code>/</code> が <code>(app)</code> や <code>(marketing)</code> のページであるべき場合など)。</section><section id="breaking-out-of-layouts"class="level3"><h3>Breaking out of layouts</h3><p>最上位のレイアウト(root layout)は、アプリの全てのページに適用されます。省略した場合、デフォルトは <code>&#x3C;slot /></code> です。もし、いくつかのページで他のページとは異なるレイアウト階層を持ちたい場合には、アプリ全体を1つまたは複数のグループにして、共通のレイアウトを継承しないルート(route)を分けることができます。<p>上記の例で、<code>/admin</code> ルート(route)は <code>(app)</code> や <code>(marketing)</code> のレイアウトを継承しません。</section><section id="page"class="level3"><h3>+page@</h3><p>ページは、ルート(route)ごとに現在のレイアウト階層から抜け出すことができます。先ほどの例に出てきた <code>(app)</code> グループの中に、<code>/item/[id]/embed</code> ルート(route)があるとします:<pre class="language-diff"><code class="language-diff">src/routes/
├ (app)/
│ ├ item/
│ │ ├ [id]/
│ │ │ ├ embed/
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">│ │ │ │ └ +page.svelte
</span></span>│ │ │ └ +layout.svelte
│ │ └ +layout.svelte
│ └ +layout.svelte
└ +layout.svelte</code></pre><p>通常、これは最上位のレイアウト(root layout)と <code>(app)</code> レイアウトと <code>item</code> レイアウトと <code>[id]</code> レイアウトを継承します。<code>@</code> と、その後ろにセグメント名 (最上位のレイアウト(root layout)の場合は空文字列(empty string)) を追加することで、これらのレイアウトのどれかにリセットすることができます。この例では、以下のオプションから選択できます:<ul><li><code>+page@[id].svelte</code> - <code>src/routes/(app)/item/[id]/+layout.svelte</code> を継承します<li><code>+page@item.svelte</code> - <code>src/routes/(app)/item/+layout.svelte</code> を継承します<li><code>+page@(app).svelte</code> - <code>src/routes/(app)/+layout.svelte</code> を継承します<li><code>+page@.svelte</code> - <code>src/routes/+layout.svelte</code> を継承します</ul><pre class="language-diff"><code class="language-diff">src/routes/
├ (app)/
│ ├ item/
│ │ ├ [id]/
│ │ │ ├ embed/
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">│ │ │ │ └ +page@(app).svelte
</span></span>│ │ │ └ +layout.svelte
│ │ └ +layout.svelte
│ └ +layout.svelte
└ +layout.svelte</code></pre></section><section id="layout"class="level3"><h3>+layout@</h3><p>ページと同じように、同じ方法でレイアウト <em>自体</em> をその親のレイアウトの階層から外すことができます。例えば、<code>+layout@.svelte</code> コンポーネントはその全ての子ルート(routes)の階層をリセットします。<pre class="language-text"><code class="language-text">src/routes/
├ (app)/
│ ├ item/
│ │ ├ [id]/
│ │ │ ├ embed/
│ │ │ │ └ +page.svelte  // (app)/item/[id]/+layout.svelte を使用します
│ │ │ ├ +layout.svelte  // (app)/item/+layout@.svelte を継承します
│ │ │ └ +page.svelte    // (app)/item/+layout@.svelte を使用します
│ │ └ +layout@.svelte   // 最上位のレイアウト(root layout)を継承し、(app)/+layout.svelte をスキップします
│ └ +layout.svelte
└ +layout.svelte</code></pre></section><section id="レイアウトグループを使うときは"class="level3"><h3>レイアウトグループを使うときは</h3><p>全てのユースケースがレイアウトのグループ化に適しているわけではありませんし、無理に使用する必要もありません。あなたのユースケースが複雑な <code>(group)</code> のネストになってしまうかもしれませんし、たった1つの例外ケースのために <code>(group)</code> を導入したくないかもしれません。コンポジション (再利用可能な <code>load</code> 関数や Svelte コンポーネント) や if 文など、他の手段を使用してやりたいことを実現するのは全く問題ありません。以下の例では、最上位のレイアウト(root layout)に戻し、他のレイアウトでも使用できるコンポーネントや関数を再利用したレイアウトを示しています:<pre class="language-svelte"><code class="language-svelte">/// file: src/routes/nested/route/+layout@.svelte
&#x3C;script>
	import ReusableLayout from '$lib/ReusableLayout.svelte';
	export let data;
&#x3C;/script>

&#x3C;ReusableLayout {data}>
	&#x3C;slot />
&#x3C;/ReusableLayout></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/routes/nested/route/+layout.js</span>
<span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">"$lib/reusable-load-function"</span> <span class="token punctuation">{</span>
	<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">reusableLoad</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">LoadEvent</span></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span>string<span class="token punctuation">,</span> any<span class="token operator">>></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> reusableLoad <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$lib/reusable-load-function'</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./$types'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageLoad<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Add additional logic here, if needed</span>
	<span class="token keyword control-flow">return</span> <span class="token function">reusableLoad</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></section>