<!doctype html><html lang="ja"><meta charset="utf-8"><title>Packaging</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="packaging"><h1 id="packaging">Packaging</h1><p>SvelteKit では、アプリを構築するだけでなく、<code>@sveltejs/package</code> パッケージを使用してコンポーネントライブラリを構築することもできます (<code>npm create svelte</code> にはこれを設定するためのオプションがあります)。<p>アプリを作成するとき、<code>src/routes</code> のコンテンツが公開される部分となります。<a href="modules#$lib"><code>src/lib</code></a> にはアプリの内部ライブラリが含まれます。<p>コンポーネントライブラリは SvelteKit アプリと同じ構造ですが、<code>src/lib</code> が公開される部分である点が異なります。パッケージの公開にはプロジェクトの最上位(root)の <code>package.json</code> が使用されます。<code>src/routes</code> を、ライブラリに付属するドキュメントやデモサイト、または開発中に使用するサンドボックスにすることもあるでしょう。<p><code>@sveltejs/package</code> の <code>svelte-package</code> コマンドを実行すると、<code>src/lib</code> の中身を取り込み、以下を含む <code>dist</code> (<a href="#options">設定で変更</a>できます) ディレクトリを生成します:<ul><li><code>src/lib</code> にある全てのファイル。Svelte コンポーネントはプリプロセスされ、TypeScript ファイルは JavaScript にトランスパイルされます。<li>Svelte、JavaScript、TypeScript ファイル向けに生成される型定義 (<code>d.ts</code> ファイル)。このために、<code>typescript >= 4.0.0</code> をインストールする必要があります。型定義はその実装と同じ場所に配置され、手書きの <code>d.ts</code> ファイルはそのままコピーされます。<a href="#options">生成を無効</a>にすることもできますが、それはおすすめできません。あなたのライブラリを使用する人は TypeScript を使用しているかもしれません。その場合、この型定義ファイルが必要になります。</ul><blockquote><p><code>@sveltejs/package</code> バージョン1は <code>package.json</code> を生成していましたが、この仕様は変更され、現在はプロジェクトの <code>package.json</code> を使用しそれが正しいか検証するようになりました。もしまだバージョン1を使用している場合は、<a href="https://github.com/sveltejs/kit/pull/8922">この PR</a> にある移行手順(Migration instructions)をご覧ください。</blockquote><section class="level2"aria-labelledby="packagejson-の構造"><h2 id="packagejson-の構造">package.json の構造</h2><p>公開するライブラリをビルドするのであれば、<code>package.json</code> の内容がとても重要になります。これを通して、パッケージのエントリーポイントや、どのファイルを npm に公開するか、そしてあなたのライブラリの依存関係を設定することができます。それでは、重要なフィールドをひとつずつ見ていきましょう。</section><section class="level2"aria-labelledby="name"><h2 id="name">name</h2><p>これはパッケージの名前です。他の人はこの名前を使用してインストールすることになります。そして <code>https://npmjs.com/package/&#x3C;name></code> のように表示されるようになります。<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"your-library"</span>
<span class="token punctuation">}</span></code></pre><p>詳細については<a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json#name">こちら</a>をお読みください。</section><section class="level2"aria-labelledby="license"><h2 id="license">license</h2><p>すべてのパッケージにはライセンスフィールドがあるべきです。なぜなら、人々はこれによってどのように使用することが許可されているのか知ることができるからです。配布や保証なしの再利用に関してとても寛容で、非常にポピュラーなライセンスとして、<code>MIT</code> があります。<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"MIT"</span>
<span class="token punctuation">}</span></code></pre><p>詳細については<a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json#license">こちら</a>をお読みください。<code>LICENSE</code> ファイルもパッケージに含めるとよいでしょう。</section><section class="level2"aria-labelledby="files"><h2 id="files">files</h2><p>ここではどのファイルを npm にアップロードするかを設定します。出力先フォルダ (デフォルトは <code>dist</code>) も含める必要があります。<code>package.json</code> と <code>README</code> と <code>LICENSE</code> は常に含まれるようになっているため、指定する必要はありません。<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"files"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"dist"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><p>不要なファイル (例えば単体テストや、<code>src/routes</code> からのみインポートされているモジュールなど) を除外するには、<code>.npmignore</code> ファイルにそれらを追加します。これによってより小さいパッケージとなり、インストールも速くなります。<p>詳細については<a href="https://docs.npmjs.com/cli/v9/configuring-npm/package-json#files">こちら</a>をお読みください。</section><section class="level2"aria-labelledby="exports"><h2 id="exports">exports</h2><p><code>"exports"</code> フィールドにはパッケージのエントリーポイントを含めます。<code>npm create svelte@latest</code> を使用して新しいライブラリプロジェクトをセットアップした場合、単一の export として、パッケージの最上位(root)が設定されています:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"."</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"types"</span><span class="token operator">:</span> <span class="token string">"./dist/index.d.ts"</span><span class="token punctuation">,</span>
			<span class="token property">"svelte"</span><span class="token operator">:</span> <span class="token string">"./dist/index.js"</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>これにより、あなたのパッケージにはエントリーポイントが1つだけで、それは最上位(root)で、(以下のように)すべてここを通してインポートされるべきである、ということをバンドラーやツール類に伝えます:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Something</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'your-library'</span><span class="token punctuation">;</span></code></pre><p><code>types</code> と <code>svelte</code> キーは <a href="https://nodejs.org/api/packages.html#conditional-exports">export conditions</a> です。これはツール類に、<code>your-library</code> インポートを検索する際にどのファイルをインポートするかを伝えるものです:<ul><li>TypeScript は <code>types</code> condition を見て、型定義ファイルを検索します。型定義を公開しない場合は、この condition を省略します。<li>Svelte を認識するツール類は <code>svelte</code> condition を見て、これが Svelte コンポーネントライブラリであることを認識します。Svelte コンポーネントをエクスポートせず、Svelte 以外のプロジェクトでも使用できるライブラリ (例えば Svelte store ライブラリ) を公開する場合、この condition を <code>default</code> に置き換えることができます。</ul><blockquote><p>以前のバージョンの <code>@sveltejs/package</code> は <code>package.json</code> export も追加していましたが、現在は違います。すべてのツール類が明示的にエクスポートされていない <code>package.json</code> を扱うことができるようになったからです。</blockquote><p><code>exports</code> を好みに合わせて調整し、より多くのエントリーポイントを提供することができます。例えば、コンポーネントを再エクスポートする <code>src/lib/index.js</code> ファイルの代わりに、<code>src/lib/Foo.svelte</code> コンポーネントを直接公開したい場合、以下のような export map を作成できます…<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"./Foo.svelte"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"types"</span><span class="token operator">:</span> <span class="token string">"./dist/Foo.svelte.d.ts"</span><span class="token punctuation">,</span>
			<span class="token property">"svelte"</span><span class="token operator">:</span> <span class="token string">"./dist/Foo.svelte"</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>…そしてライブラリの使用者はコンポーネントをこのようにインポートできます:<pre class="language-js"><code class="language-js"><span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'your-library/Foo.svelte'</span><span class="token punctuation">;</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Foo</span></span> <span class="token keyword module">from</span> <span class="token string">'your-library/Foo.svelte'</span><span class="token punctuation">;</span></code></pre><blockquote><p>型定義を提供している場合、これを行う際にさらなる注意が必要となることにお気をつけください。注意事項については<a href="#typescript">こちら</a>をお読みください。</blockquote><p>一般的に、exports map の各キーはユーザーがあなたのパッケージからなにかインポートするときに使用すべきパスであり、その値はインポートされるファイルへのパスか、またはそのファイルパスを含む export condition の map です。<p><code>exports</code> の詳細については<a href="https://nodejs.org/docs/latest-v18.x/api/packages.html#package-entry-points">こちら</a>をお読みください。</section><section class="level2"aria-labelledby="svelte"><h2 id="svelte">svelte</h2><p>これはツール類に Svelte コンポーネントライブラリを認識できるようにするレガシーなフィールドです。<code>svelte</code> <a href="#anatomy-of-a-package-json-exports">export condition</a> を使用している場合は必要ありませんが、まだ export condition を認識しない古いツールとの後方互換性のために残しておくとよいでしょう。あなたの最上位(root)のエントリーポイントを指しているはずです。<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"svelte"</span><span class="token operator">:</span> <span class="token string">"./dist/index.js"</span>
<span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="typescript"><h2 id="typescript">TypeScript</h2><p>あなたが TypeScript を使用していないとしても、あなたのライブラリの型定義を公開したほうがよいでしょう。あなたのライブラリを使用する人が、適切なインテリセンスを得られるようになるからです。<code>@sveltejs/package</code> は型生成のプロセスをほとんど隠ぺい(opaque)してくれます。デフォルトでは、ライブラリをパッケージングする際、JavaScript、TypeScript、Svelte ファイル向けに型定義を自動生成します。あなたは <a href="#anatomy-of-a-package-json-exports">exports</a> map の <code>types</code> condition が正しいファイルを指しているか確認するだけです。<code>npm create svelte@latest</code> でライブラリプロジェクトを初期化すると、root export に <code>types</code> condition が設定されます。<p>しかし、root export 以外のもの、例えば <code>your-library/foo</code> インポートを提供する場合などは、型定義を提供する上でさらなる注意が必要です。残念ながら、TypeScript はデフォルトでは <code>{ "./foo": { "types": "./dist/foo.d.ts", ... }}</code> のような export に対して <code>types</code> condition を解決しません。代わりに、ライブラリの root からの相対で <code>foo.d.ts</code> を探します (つまり、<code>your-library/dist/foo.d.ts</code> ではなく <code>your-library/foo.d.ts</code> です)。これを修正する方法として、選択肢が2つあります:<p>1つ目の選択肢は、あなたのライブラリを使用する人に対し、<code>tsconfig.json</code> (または <code>jsconfig.json</code>) の <code>moduleResolution</code> オプション に <code>bundler</code> (TypeScript 5 から利用可能で、将来的にもベストかつ推奨のオプション) か <code>node16</code> か <code>nodenext</code> を設定してもらうように要求することです。これによって TypeScript が実際に exports map を見て正しく型を解決してくれるようになります。<p>2つ目の選択肢は、TypeScript の <code>typesVersions</code> 機能を使用(乱用)して、型を紐付けます。これは、TypeScript が TypeScript のバージョンによって異なる型定義をチェックするために使用している <code>package.json</code> 内のフィールドで、このためにパスマッピング機能があります。このパスマッピング機能を利用して、やりたいことを実現できます。上述の <code>foo</code> export の場合、対応する <code>typesVersions</code> はこのようになります:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
	<span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">"./foo"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"types"</span><span class="token operator">:</span> <span class="token string">"./dist/foo.d.ts"</span><span class="token punctuation">,</span>
			<span class="token property">"svelte"</span><span class="token operator">:</span> <span class="token string">"./dist/foo.js"</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token property">"typesVersions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token property">">4.0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token property">"foo"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"./dist/foo.d.ts"</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><code>>4.0</code> は、TypeScript のバージョンが 4 より大きい場合、内側の map をチェックするよう TypeScript に伝えるものです (実際には常に true となるべきものです)。内側の map は TypeScript に <code>your-library/foo</code> に対する型付けが <code>./dist/foo.d.ts</code> にあることを伝えるためのもので、実質 <code>exports</code> condition を置き換えています。また、ワイルドカードとして <code>*</code> を自由に使用できるので、同じことを繰り返すことなくたくさんの型定義を一度で使用可能にすることができます。もし <code>typesVersions</code> を選択した場合、(<code>"index.d.ts": [..]</code> と定義されている) root import を含む全ての型のインポートを、これを通して宣言しなければならないことにご注意ください。<p>この機能についてより詳しい情報は<a href="https://www.typescriptlang.org/docs/handbook/declaration-files/publishing.html#version-selection-with-typesversions">こちら</a>でお読み頂けます。</section><section class="level2"aria-labelledby="ベストプラクティス"><h2 id="ベストプラクティス">ベストプラクティス</h2><p>他の SvelteKit プロジェクトからのみ使用されることを想定しているのでなければ、<code>$app</code> などの <a href="modules">SvelteKit 固有のモジュール</a>をあなたのパッケージで使用するのは避けたほうがよいでしょう。例えば、<code>import { browser } from '$app/environment'</code> を使用するのではなく、<code>import { BROWSER } from 'esm-env'</code> (<a href="https://github.com/benmccann/esm-env">esm-env ドキュメント参照</a>) を使用します。また、<code>$app/stores</code> や <code>$app/navigation</code> などに直接頼るのではなく、現在の URL や navigation action をプロパティとして渡すこともできます。より一般的な方法でアプリを書くことによって、テストや UI デモなどのツールのセットアップも簡単になります。<p><a href="configuration#alias">エイリアス</a> は <code>svelte.config.js</code> (<code>vite.config.js</code> や <code>tsconfig.json</code> ではなく) を経由して追加するようにしてください。<code>svelte-package</code> で処理されるからです。.<p>パッケージに加えた変更がバグフィックスなのか、新機能なのか、それとも破壊的変更(breaking change)なのかをよく考えて、それに応じてパッケージのバージョンを更新する必要があります。もし既存のライブラリから <code>exports</code> やその中の <code>export</code> condition のパスを削除した場合、breaking change とみなされることにご注意ください。<pre class="language-diff"><code class="language-diff">{
	"exports": {
		".": {
			"types": "./dist/index.d.ts",
// changing `svelte` to `default` is a breaking change:
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">			"svelte": "./dist/index.js"
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">			"default": "./dist/index.js"
</span></span>		},
// removing this is a breaking change:
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">		"./foo": {
</span><span class="token prefix deleted">-</span><span class="token line">			"types": "./dist/foo.d.ts",
</span><span class="token prefix deleted">-</span><span class="token line">			"svelte": "./dist/foo.js",
</span><span class="token prefix deleted">-</span><span class="token line">			"default": "./dist/foo.js"
</span><span class="token prefix deleted">-</span><span class="token line">		},
</span></span>// adding this is ok:
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">		"./bar": {
</span><span class="token prefix inserted">+</span><span class="token line">			"types": "./dist/bar.d.ts",
</span><span class="token prefix inserted">+</span><span class="token line">			"svelte": "./dist/bar.js",
</span><span class="token prefix inserted">+</span><span class="token line">			"default": "./dist/bar.js"
</span><span class="token prefix inserted">+</span><span class="token line">		}
</span></span>	}
}</code></pre></section><section class="level2"aria-labelledby="options"><h2 id="options">Options</h2><p><code>svelte-package</code> は以下のオプションを受け付けます:<ul><li><code>-w</code>/<code>--watch</code> — <code>src/lib</code> にあるファイルの変更を関ししてパッケージを再ビルドします<li><code>-i</code>/<code>--input</code> — パッケージの全てのファイルを含む入力ディレクトリ。デフォルトは <code>src/lib</code> です<li><code>-o</code>/<code>--o</code> — 処理されたファイルが書き込まれる出力ディレクトリ。<code>package.json</code> の <code>exports</code> はここにあるファイルを指さなければならず、<code>files</code> の配列にはこのフォルダを含めなければいけません。デフォルトは <code>dist</code> です<li><code>-t</code>/<code>--types</code> — 型定義 (<code>d.ts</code> ファイル) を作成するかどうか。エコシステムのライブラリの品質を向上させるため、作成することを強く推奨します。デフォルトは <code>true</code> です</ul></section><section class="level2"aria-labelledby="公開publishing"><h2 id="公開publishing">公開(Publishing)</h2><p>生成されたパッケージを公開するには:<pre class="language-sh"><code class="language-sh">npm publish</code></pre></section><section class="level2"aria-labelledby="注意事項"><h2 id="注意事項">注意事項</h2><p>すべての相対ファイルインポートは、Node の ESM アルゴリズムに従って、フルで指定する必要があります。つまり、<code>src/lib/something/index.js</code> のようなファイルには、ファイル名と拡張子を含めなければなりません。<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">import { something } from './something';
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">import { something } from './something/index.js';</span></span></code></pre><p>TypeScript を使用している場合、同じように <code>.ts</code> ファイルをインポートする必要がありますが、<code>.js</code> ファイルの末尾を使用する必要があります、<code>.ts</code> ファイルの末尾ではありません (これは TypeScript の設計上の決定によるもので、私たちの管轄外です)。<code>tsconfig.json</code> または <code>jsconfig.json</code> に <code>"moduleResolution": "NodeNext"</code> を設定すると、これに対処できます。<p>Svelte ファイル (プロプロセスされる) と TypeScript ファイル (JavaScript にトランスパイルされる) を覗いて、全てのファイルはそのままコピーされます。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>