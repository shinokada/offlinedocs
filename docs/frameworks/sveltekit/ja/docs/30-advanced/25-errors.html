<!doctype html><html lang="ja"><meta charset="utf-8"><title>Errors</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="errors"><h1 id="errors">Errors</h1><p>ソフトウェア開発において、エラーは避けられないものです。SvelteKit では、エラーが発生した場所、エラーの種類、受信したリクエストの性質に応じて、異なる方法でエラーを処理します。<section class="level2"aria-labelledby="error-objects"><h2 id="error-objects">Error objects</h2><p>SvelteKit は想定されるエラーと予期せぬエラーを区別します。どちらもデフォルトではシンプルな <code>{ message: string }</code> オブジェクトとして表現されます。<p>以下の例のように、<code>code</code> やトラッキング <code>id</code> を追加することができます。(TypeScript を使用する場合、<a href="errors#type-safety">Type safety</a> で説明したように <code>Error</code> 型を再定義する必要があります)</section><section class="level2"aria-labelledby="expected-errors"><h2 id="expected-errors">Expected errors</h2><p>想定されるエラーとは、<code>@sveltejs/kit</code> からインポートされる <a href="modules#sveltejs-kit-error"><code>error</code></a> を使用して作成されるものを指します:<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/routes/blog/[slug]/+page.server.js</span>
<span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'$lib/server/database'</span> <span class="token punctuation">{</span>
	<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getPost</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">slug</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token punctuation">{</span> # string<span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> string <span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span><span class="token operator">></span>
<span class="token punctuation">}</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> error <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/kit'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> db</span> <span class="token keyword module">from</span> <span class="token string">'$lib/server/database'</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./$types'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>PageServerLoad<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> params <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> post <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">getPost</span><span class="token punctuation">(</span>params<span class="token punctuation">.</span><span class="token property-access">slug</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>post<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword control-flow">throw</span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Not found'</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> post <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>こうすると、SvelteKit はレスポンスのステータスコードを 404 に設定し、<a href="routing#error"><code>+error.svelte</code></a> コンポーネントをレンダリングします。<code>$page.error</code> は <code>error(...)</code> に第二引数として渡されたオブジェクトです。<pre class="language-svelte"><code class="language-svelte">/// file: src/routes/+error.svelte
&#x3C;script>
	import { page } from '$app/stores';
&#x3C;/script>

&#x3C;h1>{$page.error.message}&#x3C;/h1></code></pre><p>必要に応じて、エラーオブジェクトにプロパティを追加することができます…<pre class="language-diff"><code class="language-diff">throw error(404, {
	message: 'Not found',
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">	code: 'NOT_FOUND'
</span></span>});</code></pre><p>…追加しない場合は、便宜上、文字列を第二引数に渡すことができます:<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">throw error(404, { message: 'Not found' });
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">throw error(404, 'Not found');</span></span></code></pre></section><section class="level2"aria-labelledby="unexpected-errors"><h2 id="unexpected-errors">Unexpected errors</h2><p>予期せぬエラーとは、リクエストの処理中に発生するその他の例外のことを指します。これらは機密情報を含むことがあるため、予期せぬエラーのメッセージとスタックトレースはユーザーには公開されません。<p>デフォルトでは、予期せぬエラーはコンソール (または、本番環境では、サーバーログ) に出力され、ユーザーに公開されるエラーはこのように汎用的な形式です。<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span> <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Internal Error"</span> <span class="token punctuation">}</span></code></pre><p>予期せぬエラーは <a href="hooks#shared-hooks-handleerror"><code>handleError</code></a> hook を通ります。ここで、独自のエラーハンドリングを追加することができます。例えば、レポーティングサービスにエラーを送ったり、カスタムのエラーオブジェクトを返したりすることができます。<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token comment">// @errors: 2322 1360 2571 2339</span>
<span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'@sentry/node'</span> <span class="token punctuation">{</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">opts</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">captureException</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">error</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">opts</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">Sentry</span></span> <span class="token keyword module">from</span> <span class="token string">'@sentry/node'</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">Sentry</span><span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HandleServerError<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> error<span class="token punctuation">,</span> event <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// example integration with https://sentry.io/</span>
	<span class="token maybe-class-name">Sentry</span><span class="token punctuation">.</span><span class="token method function property-access">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">extra</span><span class="token operator">:</span> <span class="token punctuation">{</span> event <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Whoops!'</span><span class="token punctuation">,</span>
		<span class="token literal-property property">code</span><span class="token operator">:</span> error<span class="token operator">?.</span>code <span class="token operator">??</span> <span class="token string">'UNKNOWN'</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p><code>handleError</code> では<em>絶対に</em> error をスローしないでください</blockquote></section><section class="level2"aria-labelledby="responses"><h2 id="responses">Responses</h2><p>もし <code>handle</code> の中や <a href="routing#server"><code>+server.js</code></a> リクエストハンドラの中でエラーが発生した場合、SvelteKit はリクエストの <code>Accept</code> ヘッダー に応じて、フォールバックエラーページか、エラーオブジェクトの JSON 表現をレスポンスとして返します。<p><code>src/error.html</code> ファイルを追加することで、フォールバックエラーページをカスタマイズすることができます:<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>head</span><span class="token punctuation">></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>title</span><span class="token punctuation">></span></span>%sveltekit.error.message%<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>title</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>head</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>body</span><span class="token punctuation">></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h1</span><span class="token punctuation">></span></span>My custom error page<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h1</span><span class="token punctuation">></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>Status: %sveltekit.status%<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>p</span><span class="token punctuation">></span></span>Message: %sveltekit.error.message%<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>p</span><span class="token punctuation">></span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>SvelteKit が <code>%sveltekit.status%</code> と <code>%sveltekit.error.message%</code> を、それぞれ対応する値に置き換えます。<p>ページのレンダリング中に <code>load</code> 関数の中でエラーが発生した場合、SvelteKit はエラーが発生した場所に最も近い <a href="routing#error"><code>+error.svelte</code></a> コンポーネントをレンダリングします。<code>+layout(.server).js</code> の <code>load</code> 関数の内側でエラーが発生した場合、ツリーの中で最も近くにあるエラー境界はそのレイアウトの上位にある <code>+error.svelte</code> ファイルです (隣ではありません)。<p>例外は、最上位の <code>+layout.js</code> や <code>+layout.server.js</code> の中でエラーが発生した場合です。通常、最上位のレイアウトには <code>+error.svelte</code> コンポーネントが含まれているためです。この場合、SvelteKit はフォールバックエラーページを使用します。</section><section class="level2"aria-labelledby="type-safety"><h2 id="type-safety">Type safety</h2><p>もし TypeScript を使用していてエラーの形式をカスタマイズする必要がある場合、アプリで <code>App.Error</code> インターフェイスを宣言することでそれができます (慣習ではこれを <code>src/app.d.ts</code> に書きますが、TypeScript が '参照' することができればどこでも構いません):<pre class="language-diff"><code class="language-diff">/// file: src/app.d.ts
declare global {
	namespace App {
		interface Error {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">			code: string;
</span><span class="token prefix inserted">+</span><span class="token line">			id: string;
</span></span>		}
	}
}

export {};</code></pre><p>このインターフェイスは常に <code>message: string</code> プロパティを含んでいます。</section><section class="level2"aria-labelledby="その他の参考資料"><h2 id="その他の参考資料">その他の参考資料</h2><ul><li><a href="https://learn.svelte.jp/tutorial/error-basics">Tutorial: Errors and redirects</a><li><a href="https://learn.svelte.jp/tutorial/handle">Tutorial: Hooks</a> <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></ul></section></section>