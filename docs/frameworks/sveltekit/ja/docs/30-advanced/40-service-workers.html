<!doctype html><html lang="ja"><meta charset="utf-8"><title>Service workers</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="service-workers"><h1 id="service-workers">Service workers</h1><p>Service Worker は、アプリ内部でネットワークリクエストを処理するプロキシサーバーとして機能します。これによりアプリをオフラインで動作させることが可能になります。もしオフラインサポートが不要な場合（または構築するアプリの種類によって現実的に実装できない場合）でも、ビルドした JS と CSS を事前にキャッシュしてナビゲーションを高速化するために Service Worker を使用する価値はあります。<p>SvelteKit では、<code>src/service-worker.js</code> ファイル (や <code>src/service-worker/index.js</code>) がある場合、バンドルされ、自動的に登録されます。必要に応じて、<a href="configuration#files">service worker の ロケーション</a> を変更することができます。<p>service worker を独自のロジックで登録する必要がある場合や、その他のソリューションを使う場合は、<a href="configuration#serviceworker">自動登録を無効化</a> することができます。デフォルトの登録方法は次のようなものです:<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> <span class="token dom variable">navigator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">serviceWorker</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token string">'./path/to/service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><section class="level2"aria-labelledby="service-worker-の内部では-"><h2 id="service-worker-の内部では-">service worker の内部では</h2><p>service worker の内部では、<a href="modules#$service-worker"><code>$service-worker</code> モジュール</a> にアクセスでき、これによって全ての静的なアセット、ビルドファイル、プリレンダリングページへのパスが提供されます。また、アプリのバージョン文字列 (一意なキャッシュ名を作成するのに使用できます) と、デプロイメントの <code>base</code> パスが提供されます。Vite の設定に <code>define</code> (グローバル変数の置換に使用) を指定している場合、それはサーバー/クライアントのビルドだけでなく、service worker にも適用されます。<p>次の例では、ビルドされたアプリと <code>static</code> にあるファイルをすぐに(eagerly)キャッシュし、その他全てのリクエストはそれらの発生時にキャッシュします。これにより、各ページは一度アクセスするとオフラインで動作するようになります。<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2339</span>
<span class="token comment">/// &#x3C;reference types="@sveltejs/kit" /></span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> build<span class="token punctuation">,</span> files<span class="token punctuation">,</span> version <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$service-worker'</span><span class="token punctuation">;</span>

<span class="token comment">// Create a unique cache name for this deployment</span>
<span class="token keyword">const</span> <span class="token constant">CACHE</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cache-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">ASSETS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token spread operator">...</span>build<span class="token punctuation">,</span> <span class="token comment">// the app itself</span>
	<span class="token spread operator">...</span>files  <span class="token comment">// everything in `static`</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token comment">// Create a new cache and add all files to it</span>
	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addFilesToCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token constant">CACHE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword control-flow">await</span> cache<span class="token punctuation">.</span><span class="token method function property-access">addAll</span><span class="token punctuation">(</span><span class="token constant">ASSETS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	event<span class="token punctuation">.</span><span class="token method function property-access">waitUntil</span><span class="token punctuation">(</span><span class="token function">addFilesToCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token comment">// Remove previous cached data from disk</span>
	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token constant">CACHE</span><span class="token punctuation">)</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	event<span class="token punctuation">.</span><span class="token method function property-access">waitUntil</span><span class="token punctuation">(</span><span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token comment">// ignore POST requests etc</span>
	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token property-access">method</span> <span class="token operator">!==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>

	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token constant">CACHE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// `build`/`files` can always be served from the cache</span>
		<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token constant">ASSETS</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> cache<span class="token punctuation">.</span><span class="token method function property-access">match</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// for everything else, try the network first, but</span>
		<span class="token comment">// fall back to the cache if we're offline</span>
		<span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// if we're offline, fetch can return a value that is not a Response</span>
			<span class="token comment">// instead of throwing - and we can't pass this non-Response to respondWith</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>response <span class="token keyword">instanceof</span> <span class="token class-name">Response</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'invalid response from fetch'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				cache<span class="token punctuation">.</span><span class="token method function property-access">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token method function property-access">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> cache<span class="token punctuation">.</span><span class="token method function property-access">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// if there's no cache, then just error out</span>
			<span class="token comment">// as there is nothing we can do to respond to this request</span>
			<span class="token keyword control-flow">throw</span> err<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	event<span class="token punctuation">.</span><span class="token method function property-access">respondWith</span><span class="token punctuation">(</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>キャッシュにはご注意ください！ 場合によっては、オフラインでは利用できないデータよりも古くなったデータのほうが悪いことがあります。ブラウザはキャッシュが一杯になると空にするため、ビデオファイルのような大きなアセットをキャッシュする場合にもご注意ください。</blockquote></section><section class="level2"aria-labelledby="開発中はduring-development"><h2 id="開発中はduring-development">開発中は(During development)</h2><p>service worker はプロダクション向けにはバンドルされますが、開発中はバンドルされません。そのため、<a href="https://web.dev/es-modules-in-sw">modules in service workers</a> をサポートするブラウザのみ、開発時にもそれを使用することができます。service worker を手動で登録する場合、開発時に <code>{ type: 'module' }</code> オプションを渡す必要があります:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> dev <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$app/environment'</span><span class="token punctuation">;</span>

<span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">serviceWorker</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">type</span><span class="token operator">:</span> dev <span class="token operator">?</span> <span class="token string">'module'</span> <span class="token operator">:</span> <span class="token string">'classic'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><code>build</code> と <code>prerendered</code> は開発中は空配列です</blockquote></section><section class="level2"aria-labelledby="型安全性type-safety"><h2 id="型安全性type-safety">型安全性(Type safety)</h2><p>service worker に適切な型を設定するには、マニュアルで設定が必要です。<code>service-worker.js</code> の中で、ファイルの先頭に以下を追加してください:<pre class="language-original-js"><code class="language-original-js">/// &#x3C;reference types="@sveltejs/kit" />
/// &#x3C;reference no-default-lib="true"/>
/// &#x3C;reference lib="esnext" />
/// &#x3C;reference lib="webworker" />

const sw = /** @type {ServiceWorkerGlobalScope} */ (/** @type {unknown} */ (self));</code></pre><pre class="language-generated-ts"><code class="language-generated-ts">/// &#x3C;reference types="@sveltejs/kit" />
/// &#x3C;reference no-default-lib="true"/>
/// &#x3C;reference lib="esnext" />
/// &#x3C;reference lib="webworker" />

const sw = self as unknown as ServiceWorkerGlobalScope;</code></pre><p>これにより、<code>HTMLElement</code> のような service worker の中では使用できない DOM の型付けへのアクセスが無効になり、正しい global が初期化されます。<code>self</code> を <code>sw</code> に再代入することで、プロセス内で型をキャストすることができます (いくつか方法がありますが、これが追加のファイルを必要としない最も簡単な方法です)。ファイルの残りの部分では、<code>self</code> の代わりに <code>sw</code> を使用します。SvelteKit の型を参照することで、<code>$service-worker</code> import に適切な型定義があることを保証することができます。もし <code>$env/static/public</code> をインポートする場合は、そのインポートに <code>// @ts-ignore</code> を追加するか、<code>/// &#x3C;reference types="../.svelte-kit/ambient.d.ts" /></code> を reference types に追加する必要があります。</section><section class="level2"aria-labelledby="その他のソリューション-"><h2 id="その他のソリューション-">その他のソリューション</h2><p>SvelteKit の service worker 実装は意図的に低レベル(low-level)です。より本格的な、よりこだわりが強い(opinionated)ソリューションが必要な場合は、<a href="https://vite-pwa-org.netlify.app/frameworks/sveltekit.html">Vite PWA plugin</a> のようなソリューションをご覧になることをおすすめしております、こちらは <a href="https://web.dev/learn/pwa/workbox">Workbox</a> を使用しています。service worker に関する一般的な情報をもっとお探しであれば、<a href="https://developer.mozilla.org/ja/docs/Web/API/Service_Worker_API/Using_Service_Workers">MDN web docs</a> をおすすめします。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>