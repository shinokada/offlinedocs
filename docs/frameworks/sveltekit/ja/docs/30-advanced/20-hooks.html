<!doctype html><html lang="ja"><meta charset="utf-8"><title>Hooks</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="hooks"><h1 id="hooks">Hooks</h1><p>'Hooks' は、特定のイベントに対して SvelteKit がレスポンスを呼び出すことを宣言するアプリ全体の関数で、これによってフレームワークの動作をきめ細やかに制御できるようになります。<p>hooks ファイルは2つあり、どちらもオプションです:<ul><li><code>src/hooks.server.js</code> — アプリのサーバーの hooks<li><code>src/hooks.client.js</code> — アプリのクライアントの hooks<li><code>src/hooks.js</code> — サーバーとクライアントの両方で実行される hooks</ul><p>これらのモジュールのコードはアプリケーションの起動時に実行されるので、データベースクライアントの初期化などに有用です。<blockquote><p>これらのファイルの場所は <a href="configuration#files"><code>config.kit.files.hooks</code></a> で設定できます。</blockquote><section class="level2"aria-labelledby="server-hooks"><h2 id="server-hooks">Server hooks</h2><p>以下の hooks は <code>src/hooks.server.js</code> に追加することができます:</section><section class="level2"aria-labelledby="handle"><h2 id="handle">handle</h2><p>この関数は SvelteKit のサーバーが <a href="web-standards#fetch-apis-request">リクエスト</a> を受けるたびに (アプリの実行中であろうと、<a href="page-options#prerender">プリレンダリング</a>であろうと) 実行され、<a href="web-standards#fetch-apis-response">レスポンス</a> を決定します。リクエストを表す <code>event</code> オブジェクトと、ルート(route)をレンダリングしレスポンスを生成する <code>resolve</code> という関数を受け取ります。これにより、レスポンスのヘッダーやボディを変更したり、SvelteKitを完全にバイパスすることができます (例えば、プログラムでルート(routes)を実装する場合など)。<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Handle<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">'/custom'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'custom response'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>静的アセット(プリレンダリング済みのページを含む)に対するリクエストは SvelteKit では処理されません。</blockquote><p>未実装の場合、デフォルトは <code>({ event, resolve }) => resolve(event)</code> となります。カスタムデータをリクエストに追加し、<code>+server.js</code> のハンドラーやサーバー(server) <code>load</code> 関数に渡すには、以下のように <code>event.locals</code> オブジェクトに埋め込んでください。<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token comment">// @filename: ambient.d.ts</span>
type <span class="token maybe-class-name">User</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">name</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

declare namespace <span class="token maybe-class-name">App</span> <span class="token punctuation">{</span>
	<span class="token keyword">interface</span> <span class="token class-name">Locals</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUserInformation</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">cookie</span><span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">void</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">User</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Handle<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	event<span class="token punctuation">.</span><span class="token property-access">locals</span><span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getUserInformation</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">cookies</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'sessionid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
	response<span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'x-custom-header'</span><span class="token punctuation">,</span> <span class="token string">'potato'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><a href="modules#sveltejs-kit-hooks"><code>sequence</code> ヘルパー関数</a>を使用すると、複数の <code>handle</code> 関数を定義することができます。<p><code>resolve</code> はオプションの第2引数をサポートしており、レスポンスのレンダリング方法をより詳細にコントロールすることができます。そのパラメータは、以下のフィールドを持つオブジェクトです:<ul><li><code>transformPageChunk(opts: { html: string, done: boolean }): MaybePromise&#x3C;string | undefined></code> — カスタムの変換を HTML に適用します。<code>done</code> が true である場合、それは最後のチャンクです。チャンクが整形された HTML であることは保証されませんが (例えば、要素の開始タグは含むが終了タグは含まれない、など)、常に <code>%sveltekit.head%</code> やレイアウト(layout)/ページ(page)コンポーネントなどのような理にかなった境界 (sensible boundaries) で分割されます。<li><code>filterSerializedResponseHeaders(name: string, value: string): boolean</code> — <code>load</code> 関数が <code>fetch</code> でリソースを読み込むときに、シリアライズされるレスポンスにどのヘッダーを含めるかを決定します。デフォルトでは何も含まれません。<li><code>preload(input: { type: 'js' | 'css' | 'font' | 'asset', path: string }): boolean</code> — <code>&#x3C;head></code> タグにどのファイルをプリロードの対象として追加するか決定します。このメソッドはビルド時、コードチャンクを構築している際に見つかったファイルごとに呼び出されます。これにより、例えば <code>+page.svelte</code> に <code>import './styles.css</code> がある場合、そのページに訪れたときにその CSS ファイルへの解決されたパスを以て <code>preload</code> が呼び出されるようになります。これはビルド時の分析によって行われるため、開発モードでは <code>preload</code> が呼ばれないことにご注意ください。プリロードによってその対象がより早くダウンロードされるようになるためパフォーマンスが改善しますが、不必要に多くのものをダウンロードしてしまうと、core web vitals を悪化させてしまいます。デフォルトでは、<code>js</code>、<code>css</code> ファイルがプリロードされます。現時点では <code>asset</code> ファイルはプリロードされませんが、フィードバックによっては追加されるかもしれません。</ul><pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Handle<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token function-variable function">transformPageChunk</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> html <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> html<span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token string">'old'</span><span class="token punctuation">,</span> <span class="token string">'new'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function-variable function">filterSerializedResponseHeaders</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> name<span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">'x-'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token function-variable function">preload</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> type<span class="token punctuation">,</span> path <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> type <span class="token operator">===</span> <span class="token string">'js'</span> <span class="token operator">||</span> path<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span><span class="token string">'/important/'</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>resolve(...)</code> は決してエラーをスローせず、適切なステータスコードと <code>Promise&#x3C;Response></code> を返すことにご注意ください。もし <code>handle</code> 中に他の場所でエラーがスローされた場合、それは致命的(fatal)なものとして扱われ、SvelteKit は <code>Accept</code> ヘッダーに応じて、そのエラーの JSON 表現か、<code>src/error.html</code> でカスタマイズ可能なフォールバックエラーページをレスポンスとして返します。エラーハンドリングの詳細は <a href="errors">こちら</a> からお読み頂けます。</section><section class="level2"aria-labelledby="handlefetch"><h2 id="handlefetch">handleFetch</h2><p>この関数は、サーバー上で (またはプリレンダリング中に) 実行される <code>load</code> 関数や <code>action</code> 関数の中で発生する <code>fetch</code> リクエストを変更 (または置換) することできます。<p>例えば、ユーザーがクライアントサイドでそれぞれのページに移動する際に、<code>load</code> 関数で <code>https://api.yourapp.com</code> のようなパブリックな URL にリクエストを行うかもしれませんが、SSR の場合には (パブリックなインターネットとの間にあるプロキシやロードバランサーをバイパスして) API を直接呼ぶほうが理にかなっているでしょう。<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HandleFetch<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleFetch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> request<span class="token punctuation">,</span> fetch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://api.yourapp.com/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// clone the original request, but change the URL</span>
		request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span>
			request<span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token string">'https://api.yourapp.com/'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:9999/'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			request
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword control-flow">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><strong>Credentials</strong><p>同一オリジン(same-origin)リクエストの場合、SvelteKit の <code>fetch</code> 実装は、<code>credentials</code> オプションを <code>"omit"</code> にしない限り、 <code>cookie</code> と <code>authorization</code> ヘッダーを転送します。<p>クロスオリジン(cross-origin)リクエストの場合、リクエスト URL がアプリのサブドメインに属するときは <code>cookie</code> はリクエストに含まれます。例えば、あなたのアプリが <code>my-domain.com</code> にあり、あなたの API が <code>api.my-domain.com</code> にある場合、cookie はリクエストに含まれることになります。<p>もしあなたのアプリと API が兄弟関係にあるサブドメイン (例えば <code>www.my-domain.com</code> と <code>api.my-domain.com</code>) の場合は、<code>my-domain.com</code> のような共通の親ドメインに属する cookie は含まれません、なぜなら SvelteKit にはその cookie がどのドメインに属するか判断する方法がないからです。こういったケースでは、<code>handleFetch</code> を使って手動で cookie を含める必要があります:<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token comment">// @errors: 2345</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HandleFetch<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleFetch</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> request<span class="token punctuation">,</span> fetch <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">'https://api.my-domain.com/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		request<span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'cookie'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'cookie'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword control-flow">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="shared-hooks"><h2 id="shared-hooks">Shared hooks</h2><p>以下は <code>src/hooks.server.js</code> <em>と</em> <code>src/hooks.client.js</code> のどちらにも追加できます:</section><section class="level2"aria-labelledby="handleerror"><h2 id="handleerror">handleError</h2><p><a href="/docs/errors#unexpected-errors">予期せぬエラー</a>がロード中またはレンダリング中にスローされると、この関数が <code>error</code>、<code>event</code>、<code>status</code> コード、<code>message</code> を引数にとって呼び出されます。これによって以下の2つのことが可能になります:<ul><li>エラーをログに残すことができます<li>エラーからメッセージやスタックトレースなどの機密情報を省略し、ユーザーに見せても安全なカスタムの表現を生成することができます。戻り値のデフォルトは <code>{ message }</code> で、<code>$page.error</code> の値となります。</ul><p>あなたのコード (またはあなたのコードから呼び出されたライブラリのコード) からスローされたエラーの場合、ステータスは 500 となり、message は "Internal Error" になります。<code>error.message</code> にはユーザーに公開されるべきではない機密情報が含まれている可能性がありますが、<code>message</code> は安全です (一般的なユーザーにとっては無意味ではありますが)。<p><code>$page.error</code> オブジェクトに型安全な方法で情報を追加するには、<code>App.Error</code> interface を宣言することで想定する形にすることができます (適切なフォールバックの動作を保証するため、<code>message: string</code> を含む必要があります)。これにより、例えばユーザーがテクニカルサポートスタッフとの対応の際に引用することができるトラッキング ID を付加することができます:<pre class="language-ts"><code class="language-ts"><span class="token comment">/// file: src/app.d.ts</span>
<span class="token keyword">declare</span> global <span class="token punctuation">{</span>
	<span class="token keyword">namespace</span> <span class="token maybe-class-name">App</span> <span class="token punctuation">{</span>
		<span class="token keyword">interface</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span> <span class="token punctuation">{</span>
			message<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
			errorId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token exports"><span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.server.js</span>
<span class="token comment">// @errors: 2322 2353</span>
<span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'@sentry/sveltekit'</span> <span class="token punctuation">{</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">opts</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">captureException</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">error</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">opts</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">Sentry</span></span> <span class="token keyword module">from</span> <span class="token string">'@sentry/sveltekit'</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">Sentry</span><span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HandleServerError<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> error<span class="token punctuation">,</span> event<span class="token punctuation">,</span> status<span class="token punctuation">,</span> message <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> errorId <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token method function property-access">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// example integration with https://sentry.io/</span>
	<span class="token maybe-class-name">Sentry</span><span class="token punctuation">.</span><span class="token method function property-access">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">extra</span><span class="token operator">:</span> <span class="token punctuation">{</span> event<span class="token punctuation">,</span> errorId<span class="token punctuation">,</span> status <span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Whoops!'</span><span class="token punctuation">,</span>
		errorId
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.client.js</span>
<span class="token comment">// @errors: 2322 2353</span>
<span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'@sentry/sveltekit'</span> <span class="token punctuation">{</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">init</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">opts</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">captureException</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">error</span><span class="token operator">:</span> any<span class="token punctuation">,</span> <span class="token literal-property property">opts</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">Sentry</span></span> <span class="token keyword module">from</span> <span class="token string">'@sentry/sveltekit'</span><span class="token punctuation">;</span>

<span class="token maybe-class-name">Sentry</span><span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token comment">/*...*/</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>HandleClientError<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> error<span class="token punctuation">,</span> event<span class="token punctuation">,</span> status<span class="token punctuation">,</span> message <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> errorId <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token method function property-access">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// example integration with https://sentry.io/</span>
	<span class="token maybe-class-name">Sentry</span><span class="token punctuation">.</span><span class="token method function property-access">captureException</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">extra</span><span class="token operator">:</span> <span class="token punctuation">{</span> event<span class="token punctuation">,</span> errorId<span class="token punctuation">,</span> status <span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Whoops!'</span><span class="token punctuation">,</span>
		errorId
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p><code>src/hooks.client.js</code> では、<code>handleError</code> の型は <code>HandleServerError</code> ではなく <code>HandleClientError</code> で、<code>event</code> は <code>RequestEvent</code> ではなく <code>NavigationEvent</code> です。</blockquote><p>この関数は <em>想定される</em> エラー (<code>@sveltejs/kit</code> からインポートされる <a href="modules#sveltejs-kit-error"><code>error</code></a> 関数でスローされるエラー) の場合は呼び出されません。<p>開発中、Svelte のコードの構文エラーでエラーが発生した場合、渡される error には、エラーの場所のハイライトが付与された <code>frame</code> プロパティがあります。<blockquote><p><code>handleError</code> 自体が決してエラーをスローしないようにしてください。</blockquote></section><section class="level2"aria-labelledby="universal-hooks"><h2 id="universal-hooks">Universal hooks</h2><p>以下は <code>src/hooks.js</code> に追加することができます。universal hooks はサーバーとクライアントの両方で実行されます (shared hooks と混同しないようにしてください、shared hooks は環境依存です)。</section><section class="level2"aria-labelledby="reroute"><h2 id="reroute">reroute</h2><p>この関数は <code>handle</code> より前に実行され、URL をルート(route)に変換する方法を変更することができます。戻り値の pathname (デフォルトは <code>url.pathname</code>) はルート(route)パラメータを選択するのに使用されます。<p>例えば、<code>src/routes/[[lang]]/about/+page.svelte</code> というページがあるとして、<code>/en/about</code> や <code>/de/ueber-uns</code> や <code>/fr/a-propos</code> でアクセスできるようにしたいとします。この場合は <code>reroute</code> を使用して実装することができます:<pre class="language-js"><code class="language-js"><span class="token comment">/// file: src/hooks.js</span>
<span class="token comment">// @errors: 2345</span>
<span class="token comment">// @errors: 2304</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span>Record<span class="token punctuation">&#x3C;</span>string<span class="token punctuation">,</span> string<span class="token punctuation">></span><span class="token punctuation">}</span></span> */</span>
<span class="token keyword">const</span> translated <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token string-property property">'/en/about'</span><span class="token operator">:</span> <span class="token string">'/en/about'</span><span class="token punctuation">,</span>
	<span class="token string-property property">'/de/ueber-uns'</span><span class="token operator">:</span> <span class="token string">'/de/about'</span><span class="token punctuation">,</span>
	<span class="token string-property property">'/fr/a-propos'</span><span class="token operator">:</span> <span class="token string">'/fr/about'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Reroute<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">reroute</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token property-access">pathname</span> <span class="token keyword">in</span> translated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword control-flow">return</span> translated<span class="token punctuation">[</span>url<span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><code>lang</code> パラメータは戻り値の pathname から正しく導くことができます。<p><code>reroute</code> を使用してもブラウザのアドレスバーの内容や <code>event.url</code> の値は変更されません。</section><section class="level2"aria-labelledby="その他の参考資料-"><h2 id="その他の参考資料-">その他の参考資料</h2><ul><li><a href="https://learn.svelte.jp/tutorial/handle">Tutorial: Hooks</a> <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></ul></section></section>