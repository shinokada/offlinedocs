<!doctype html><html lang="ja"><meta charset="utf-8"><title>Server-only modules</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="server-only-modules"><h1 id="server-only-modules">Server-only modules</h1><p>良き友人のように、SvelteKit はあなたの秘密を守ります。バックエンドとフロントエンドが同じリポジトリにある場合、機密データをフロントエンドのコードに誤ってインポートしてしまうことが簡単に起こってしまいます (例えば、API キーを持つ環境変数など)。SvelteKit はこれを完全に防ぐ方法を提供します: サーバー専用のモジュール(server-only modules)です<section class="level2"aria-labelledby="private-environment-variables"><h2 id="private-environment-variables">Private environment variables</h2><p><a href="modules">modules</a> セクションで説明されている <code>$env/static/private</code> モジュールと <code>$env/dynamic/private</code> モジュールは、<a href="hooks#server-hooks"><code>hooks.server.js</code></a> や <a href="routing#page-page-server-js"><code>+page.server.js</code></a> のようなサーバー上でのみ実行されるモジュールにのみインポートすることが可能です。</section><section class="level2"aria-labelledby="server-only-utilities"><h2 id="server-only-utilities">Server-only utilities</h2><p>The <a href="../50-api-reference/30-modules.html#$app-server"><code>$app/server</code></a> module, which contains a <code>read</code> function for reading assets from the filesystem, can likewise only be imported by code that runs on the server.</section><section class="level2"aria-labelledby="your-modules"><h2 id="your-modules">Your modules</h2><p>モジュールをサーバー専用にするには2通りの方法があります:<ul><li>ファイル名に <code>.server</code> を付けます。例: <code>secrets.server.js</code><li>モジュールを <code>$lib/server</code> に置きます。例: <code>$lib/server/secrets.js</code></ul></section><section class="level2"aria-labelledby="how-it-works"><h2 id="how-it-works">How it works</h2><p>パブリックに公開されるコード (public-facing code) にサーバー専用のコードを (直接的かまたは間接的かにかかわらず) インポートすると…<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 7005</span>
<span class="token comment">/// file: $lib/server/secrets.js</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> atlantisCoordinates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token comment">/* redacted */</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307 7006 7005</span>
<span class="token comment">/// file: src/routes/utils.js</span>
<span class="token keyword module">export</span> <span class="token exports"><span class="token punctuation">{</span> atlantisCoordinates <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$lib/server/secrets.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">;</span></code></pre><pre class="language-html"><code class="language-html">/// file: src/routes/+page.svelte
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
	<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> add <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./utils.js'</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>…SvelteKit はエラーとなります:<pre class="language-text"><code class="language-text">Cannot import $lib/server/secrets.js into public-facing code:
- src/routes/+page.svelte
	- src/routes/utils.js
		- $lib/server/secrets.js</code></pre><p>パブリックに公開されるコード <code>src/routes/+page.svelte</code> は、<code>add</code> を使用しているのみで、シークレットの <code>atlantisCoordinates</code> を使用していませんが、ブラウザがダウンロードする JavaScript にシークレットなコードが残ってしまう可能性があり、このインポートチェーンは安全ではないと考えられます。<p>この機能は動的なインポート(dynamic imports)でも動作し、<code>await import(`./${foo}.js`)</code> のような補完されたインポートに対しても有効ですが、小さい注意点があります。もしパブリックに公開されるコードとサーバー専用のモジュールの間に2つ以上の dynamic imports がある場合、コードが最初にロードされるときに不正なインポートが検出されない可能性があります。<blockquote><p>Vitest のようなユニットテストフレームワークはサーバー専用のコードと公開されるコードを区別しません。そのため、テストの実行中、つまり <code>process.env.TEST === 'true'</code> となっているときは、不正なインポートの検出は無効化されます。</blockquote></section><section class="level2"aria-labelledby="その他の参考資料-"><h2 id="その他の参考資料-">その他の参考資料</h2><ul><li><a href="https://learn.svelte.jp/tutorial/env-static-private">Tutorial: Environment variables</a> <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></ul></section></section>