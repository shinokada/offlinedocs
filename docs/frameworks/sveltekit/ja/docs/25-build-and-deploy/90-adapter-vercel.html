<!doctype html><html lang="ja"><meta charset="utf-8"><title>Vercel</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../Vivliostyle/read-html-download-pdf/docs/themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="vercel"><h1 id="vercel">Vercel</h1><p>Vercel にデプロイする場合は、<a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-vercel"><code>adapter-vercel</code></a> を使用します。<p><a href="adapter-auto"><code>adapter-auto</code></a> を使用している場合、この adapter は自動でインストールされますが、この adapter 自体をプロジェクトに追加すれば Vercel 固有のオプションを指定できるようになります。<section class="level2"aria-labelledby="使い方"><h2 id="使い方">使い方</h2><p><code>npm i -D @sveltejs/adapter-vercel</code> を実行してインストールし、<code>svelte.config.js</code> にこの adapter を追加します:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307 2345</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-vercel'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token comment">// 以下の 'デプロイメントの設定' セクションを参照</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="デプロイメントの設定"><h2 id="デプロイメントの設定">デプロイメントの設定</h2><p>Vercel にルート(routes)を function としてデプロイする方法をコントロールするには、デプロイメントの設定を、上記に示すオプションか、<code>+server.js</code>、<code>+page(.server).js</code>、<code>+layout(.server).js</code> ファイルの中の <a href="../20-core-concepts/40-page-options.html#config"><code>export const config</code></a> を使用して、行うことができます。<p>例えば、アプリの一部を <a href="https://vercel.com/docs/concepts/functions/edge-functions">Edge Functions</a> としてデプロイして…<pre class="language-js"><code class="language-js"><span class="token comment">/// file: about/+page.js</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/adapter-vercel'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Config<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">runtime</span><span class="token operator">:</span> <span class="token string">'edge'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>…他の部分を <a href="https://vercel.com/docs/concepts/functions/serverless-functions">Serverless Functions</a> としてデプロイすることができます (layout の内側の <code>config</code> は、すべての子ページに適用されます):<pre class="language-js"><code class="language-js"><span class="token comment">/// file: admin/+layout.js</span>
<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/adapter-vercel'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Config<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">runtime</span><span class="token operator">:</span> <span class="token string">'nodejs18.x'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>以下のオプションはすべての function に適用されます:<ul><li><code>runtime</code>: <code>'edge'</code>、<code>'nodejs16.x'</code>、<code>'nodejs18.x'</code>。デフォルトでは、プロジェクトの Node のバージョンに応じて adapter が <code>'nodejs16.x'</code> か <code>'nodejs18.x'</code> を選択します。プロジェクトの Node バージョンは Vercel のダッシュボードから設定することができます。<li><code>regions</code>: <a href="https://vercel.com/docs/concepts/edge-network/regions">edge network regions</a> の配列 (serverless functions のデフォルトは <code>["iad1"]</code>) か、<code>runtime</code> が <code>edge</code> (デフォルト) の場合は <code>'all'</code> です。serverless functions の場合の複数の regions のサポートは Enterprise Plan のみです。<li><code>split</code>: <code>true</code> の場合、ルート(route)は個別の function としてデプロイされます。<code>split</code> を adapter レベルで <code>true</code> にする場合、すべてのルート(route)が個別の function としてデプロイされます。</ul><p>加えて、以下のオプションは edge function に適用されます:<ul><li><code>envVarsInUse</code>: edge function の内側からアクセスできる環境変数の配列です<li><code>external</code>: esbuild が function をバンドルする際に外部(external)として扱う依存関係(dependencies)の配列です。Node の外側で実行されないオプションの依存関係(optional dependencies)を除外したいときにのみ使用してください</ul><p>そして以下のオプションは serverless function に適用されます:<ul><li><code>memory</code>: function で利用できるメモリ量です。デフォルトは <code>1024</code> Mb で、<code>128</code> Mb まで減らすことができます。また、Pro または Enterprise アカウントの場合は、<code>3008</code> Mb まで<a href="https://vercel.com/docs/concepts/limits/overview#serverless-function-memory">増やす</a>ことができます。間隔は 64Mb 単位です。<li><code>maxDuration</code>: function の最大実行時間。デフォルトで、Hobby アカウントの場合は <code>10</code> 秒、Pro の場合は <code>60</code>、Enterprise の場合は <code>900</code> です。<li><code>isr</code>: Incremental Static Regeneration の設定、詳細は後述</ul><p>function から特定の region のデータにアクセスする必要がある場合は、パフォーマンスを最適化するためそれと同じ region (またはその知覚) にデプロイすることをおすすめします。</section><section class="level2"aria-labelledby="incremental-static-regeneration"><h2 id="incremental-static-regeneration">Incremental Static Regeneration</h2><p>Vercel は <a href="https://vercel.com/docs/concepts/incremental-static-regeneration/overview">Incremental Static Regeneration</a> (ISR) をサポートしており、これにより、プリレンダリングコンテンツが持つパフォーマンスとコストの利点と、ダイナミックレンダリングコンテンツが持つ柔軟性の両方を提供することができます。<p>ISR をルート(route)に追加するには、<code>config</code> オブジェクトに <code>isr</code> プロパティを含めます:<pre class="language-js"><code class="language-js"><span class="token comment">/// file: blog/[slug]/+page.server.js</span>
<span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'$env/static/private'</span> <span class="token punctuation">{</span>
	<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">BYPASS_TOKEN</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token constant">BYPASS_TOKEN</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'$env/static/private'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">isr</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token comment">// キャッシュされたアセットが Serverless Function を呼び出して再生成されるまでの有効期限 (秒単位)。</span>
		<span class="token comment">// 値に `false` を設定すると、無期限になります。</span>
		<span class="token literal-property property">expiration</span><span class="token operator">:</span> <span class="token number">60</span><span class="token punctuation">,</span>

		<span class="token comment">// URL で提供されるランダムな token で、アセットへのリクエストに </span>
		<span class="token comment">// __prerender_bypass=&#x3C;token> cookie を用いることで、アセットのキャッシュされたバージョンを回避することができます。</span>
		<span class="token comment">//</span>
		<span class="token comment">// `GET` や `HEAD` リクエストに `x-prerender-revalidate: &#x3C;token>` を付けると、アセットの再バリデート(re-validated)を強制することができます。</span>
		<span class="token literal-property property">bypassToken</span><span class="token operator">:</span> <span class="token constant">BYPASS_TOKEN</span><span class="token punctuation">,</span>

		<span class="token comment">// 有効なクエリパラメータのリストです。他のパラメータ (例えば utm tracking codes) は無視され、</span>
		<span class="token comment">// コンテンツが不必要に再生成されないようにします</span>
		<span class="token literal-property property">allowQuery</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'search'</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>expiration</code> プロパティは必須で、その他は任意です。</section><section class="level2"aria-labelledby="環境変数"><h2 id="環境変数">環境変数</h2><p>Vercel では<a href="https://vercel.com/docs/concepts/projects/environment-variables#system-environment-variables">デプロイメント固有の環境変数</a>一式を使用できます。他の環境変数と同様、<code>$env/static/private</code> と <code>$env/dynamic/private</code> からアクセスでき (詳細は後述)、public のほうからはアクセスできません。クライアントからこれらの変数にアクセスするには:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2305</span>
<span class="token comment">/// file: +layout.server.js</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token constant">VERCEL_COMMIT_REF</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'$env/static/private'</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./$types'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>LayoutServerLoad<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">deploymentGitBranch</span><span class="token operator">:</span> <span class="token constant">VERCEL_COMMIT_REF</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-svelte"><code class="language-svelte">/// file: +layout.svelte
&#x3C;script>
	/** @type {import('./$types').LayoutServerData} */
	export let data;
&#x3C;/script>

&#x3C;p>This staging environment was deployed from {data.deploymentGitBranch}.&#x3C;/p></code></pre><p>Vercel でビルドする場合、これらの変数は全てビルド時と実行時で変わらないため、<code>$env/dynamic/private</code> ではなく、変数を静的に置換しデッドコードの削除などの最適化ができる <code>$env/static/private</code> の使用をおすすめします。<code>edge: true</code> にしてデプロイする場合は、<code>$env/static/private</code> を使用するか、<code>envVarsInUse</code> 設定を入力する必要があります。</section><section class="level2"aria-labelledby="notes"><h2 id="notes">Notes</h2></section><section class="level2"aria-labelledby="vercel-functions"><h2 id="vercel-functions">Vercel functions</h2><p>プロジェクトの root の <code>api</code> ディレクトリに Vercel functions がある場合、<code>/api/*</code> に対するリクエストは SvelteKit で処理されません。Vercel functions に JavaScript 以外の言語を使用する必要が無いのであれば、SvelteKit アプリの <a href="https://kit.svelte.jp../20-core-concepts/10-routing.html#server">API ルート(routes)</a> として実装すると良いでしょう。逆に Vercel functions に JavaScript 以外の言語を使用する必要がある場合は、SvelteKit アプリに <code>/api/*</code> ルート(routes)を含めないようにしてください。</section><section class="level2"aria-labelledby="node-version"><h2 id="node-version">Node version</h2><p>ある時期より前に作成されたプロジェクトはデフォルトで Node 14 を使用していますが、SvelteKit には Node 16 以降が必要です。<a href="https://vercel.com/docs/concepts/functions/serverless-functions/runtimes/node-js#node.js-version">プロジェクトの設定で Node のバージョンを変更する</a>ことができます。</section><section class="level2"aria-labelledby="トラブルシューティング"><h2 id="トラブルシューティング">トラブルシューティング</h2></section><section class="level2"aria-labelledby="ファイルシステムにアクセスする"><h2 id="ファイルシステムにアクセスする">ファイルシステムにアクセスする</h2><p>Serverless/Edge 環境では、<code>fs.readFileSync</code> などのメソッドでファイルシステムにアクセスすることはできません。もしこのような方法でファイルにアクセスする必要がある場合、アプリのビルド中に<a href="https://kit.svelte.jp../20-core-concepts/40-page-options.html#prerender">プリレンダリング</a>でこれを行ってください。例えば、ブログを持っていて、CMS でコンテンツを管理したくない場合、コンテンツをプリレンダリングし (またはコンテンツを取得するエンドポイントをプリレンダリングし)、新しいコンテンツを追加するたびにブログを再デプロイする必要があります。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>