<!doctype html><html lang="ja"><meta charset="utf-8"><title>Cloudflare Pages</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="cloudflare-pages"><h1 id="cloudflare-pages">Cloudflare Pages</h1><p><a href="https://developers.cloudflare.com/pages/">Cloudflare Pages</a> にデプロイする場合は、<a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-cloudflare"><code>adapter-cloudflare</code></a> を使用します。<p><a href="adapter-auto"><code>adapter-auto</code></a> を使用している場合、この adapter は自動でインストールされますが、それよりもこの adapter 自体をプロジェクトに追加することをおすすめします。<code>event.platform</code> が自動で型付けされるからです。<section class="level2"aria-labelledby="比較"><h2 id="比較">比較</h2><ul><li><code>adapter-cloudflare</code> – SvelteKit の全ての機能をサポートします; <a href="https://blog.cloudflare.com/cloudflare-pages-goes-full-stack/">Cloudflare Pages</a> 向けにビルドします<li><code>adapter-cloudflare-workers</code> – SvelteKit の全ての機能をサポートします; Cloudflare Workers 向けにビルドします<li><code>adapter-static</code> – クライアントサイドの静的なアセットを生成するのみです; Cloudflare Pages と互換性があります</ul><blockquote><p>特別な理由が無い限り、<code>adapter-cloudflare-workers</code> ではなく、この adapter を使用することをおすすめします。どちらの adapter も機能としては同等ですが、Cloudflare Pages は、GitHub インテグレーションによる自動ビルドや自動デプロイ、プレビューデプロイ、即時ロールバックなどの機能を提供します。</blockquote></section><section class="level2"aria-labelledby="使い方"><h2 id="使い方">使い方</h2><p><code>npm i -D @sveltejs/adapter-cloudflare</code> を実行してインストールし、<code>svelte.config.js</code> にこの adapter を追加します:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-cloudflare'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token comment">// See below for an explanation of these options</span>
			<span class="token literal-property property">routes</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/*'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
				<span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'&#x3C;all>'</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="options"><h2 id="options">Options</h2><p>The <code>routes</code> option allows you to customise the <a href="https://developers.cloudflare.com/pages/platform/functions/routing/#create-a-_routesjson-file"><code>_routes.json</code></a> file generated by <code>adapter-cloudflare</code>.<ul><li><code>include</code> defines routes that will invoke a function, and defaults to <code>['/*']</code><li><code>exclude</code> defines routes that will <em>not</em> invoke a function — this is a faster and cheaper way to serve your app's static assets. This array can include the following special values:<ul><li><code>&#x3C;build></code> contains your app's build artifacts (the files generated by Vite)<li><code>&#x3C;files></code> contains the contents of your <code>static</code> directory<li><code>&#x3C;prerendered></code> contains a list of prerendered pages<li><code>&#x3C;all></code> (the default) contains all of the above</ul></ul><p>You can have up to 100 <code>include</code> and <code>exclude</code> rules combined. Generally you can omit the <code>routes</code> options, but if (for example) your <code>&#x3C;prerendered></code> paths exceed that limit, you may find it helpful to manually create an <code>exclude</code> list that includes <code>'/articles/*'</code> instead of the auto-generated <code>['/articles/foo', '/articles/bar', '/articles/baz', ...]</code>.</section><section class="level2"aria-labelledby="デプロイメントdeployment"><h2 id="デプロイメントdeployment">デプロイメント(Deployment)</h2><p>Cloudflare Pages の始め方は、<a href="https://developers.cloudflare.com/pages/get-started">Get Started Guide</a> に従ってください。<p>プロジェクトのセッティングを設定するときは、以下のセッティングを使用しなければなりません:<ul><li><strong>Framework preset</strong> – None<li><strong>Build command</strong> – <code>npm run build</code> または <code>vite build</code><li><strong>Build output directory</strong> – <code>.svelte-kit/cloudflare</code><li><strong>Environment variables</strong><ul><li><code>NODE_VERSION</code>: <code>16</code></ul></ul><blockquote><p>"production" 環境と "preview" 環境のどちらにも、環境変数 <code>NODE_VERSION</code> を追加する必要があります。これは、プロジェクトセットアップ時や、後で Pages プロジェクトのセッティングで追加できます。SvelteKit は Node <code>16.14</code> 以降を要求するため、<code>NODE_VERSION</code> の値として <code>16</code> を使用する必要があります。</blockquote></section><section class="level2"aria-labelledby="環境変数"><h2 id="環境変数">環境変数</h2><p>KV/DO namespaces などを含んでいる <a href="https://developers.cloudflare.com/workers/runtime-apis/fetch-event#parameters"><code>env</code></a> オブジェクトは、<code>context</code> や <code>caches</code> と一緒に <code>platform</code> プロパティ経由で SvelteKit に渡されます。つまり、hooks とエンドポイントの中でアクセスできるということです:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 7031</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> request<span class="token punctuation">,</span> platform <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> x <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">YOUR_DURABLE_OBJECT_NAMESPACE</span><span class="token punctuation">.</span><span class="token method function property-access">idFromName</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>これらの型をアプリで使えるようにするには、<code>src/app.d.ts</code> でこれらを参照します:<pre class="language-diff"><code class="language-diff">/// file: src/app.d.ts
declare global {
	namespace App {
		interface Platform {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">			env?: {
</span><span class="token prefix inserted">+</span><span class="token line">				YOUR_KV_NAMESPACE: KVNamespace;
</span><span class="token prefix inserted">+</span><span class="token line">				YOUR_DURABLE_OBJECT_NAMESPACE: DurableObjectNamespace;
</span><span class="token prefix inserted">+</span><span class="token line">			};
</span></span>		}
	}
}

export {};</code></pre><blockquote><p><code>platform.env</code> は本番向けビルドでのみ利用することができます。ローカルでテストするには <a href="https://developers.cloudflare.com/workers/cli-wrangler">wrangler</a> を使ってください</blockquote></section><section class="level2"aria-labelledby="notes"><h2 id="notes">Notes</h2><p>プロジェクトの root にある <code>/functions</code> ディレクトリに含まれる関数はデプロイメントには含まれず、<a href="https://developers.cloudflare.com/pages/platform/functions/#advanced-mode">1つの <code>_worker.js</code> ファイル</a>にコンパイルされます。関数は、あなたの SvelteKit アプリの <a href="https://kit.svelte.jp../20-core-concepts/10-routing.html#server">サーバーエンドポイント(server endpoints)</a> として実装する必要があります。<p>Cloudflare Pages 固有の <code>_headers</code> ファイルと <code>_redirects</code> ファイルについては、<code>/static</code> フォルダに置くことで、静的アセットのレスポンス (画像など) に使用することができます。<p>しかし、SvelteKit が動的にレンダリングするレスポンスには効果がありません。この場合にカスタムヘッダーやリダイレクトレスポンスを返すには、<a href="https://kit.svelte.jp../20-core-concepts/10-routing.html#server">サーバーエンドポイント(server endpoints)</a> や <a href="https://kit.svelte.jp../30-advanced/20-hooks.html#server-hooks-handle"><code>handle</code></a> hook から返す必要があります。</section><section class="level2"aria-labelledby="トラブルシューティング"><h2 id="トラブルシューティング">トラブルシューティング</h2></section><section class="level2"aria-labelledby="ファイルシステムにアクセスする"><h2 id="ファイルシステムにアクセスする">ファイルシステムにアクセスする</h2><p>Serverless/Edge 環境では、<code>fs.readFileSync</code> などのメソッドでファイルシステムにアクセスすることはできません。もしこのような方法でファイルにアクセスする必要がある場合、アプリのビルド中に<a href="https://kit.svelte.jp../20-core-concepts/40-page-options.html#prerender">プリレンダリング</a>でこれを行ってください。例えば、ブログを持っていて、CMS でコンテンツを管理したくない場合、コンテンツをプリレンダリングし (またはコンテンツを取得するエンドポイントをプリレンダリングし)、新しいコンテンツを追加するたびにブログを再デプロイする必要があります。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>