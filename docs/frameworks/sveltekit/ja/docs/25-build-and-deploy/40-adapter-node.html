<!doctype html><html lang="ja"><meta charset="utf-8"><title>Node サーバー</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../Vivliostyle/read-html-download-pdf/docs/themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="node-サーバー"><h1 id="node-サーバー">Node サーバー</h1><p>スタンドアロンな Node サーバーを作る場合は、<a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-node"><code>adapter-node</code></a> を使います。<section class="level2"aria-labelledby="使い方"><h2 id="使い方">使い方</h2><p><code>npm i -D @sveltejs/adapter-node</code> を実行してインストールし、<code>svelte.config.js</code> にこの adapter を追加します:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-node'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="デプロイdeploying"><h2 id="デプロイdeploying">デプロイ(Deploying)</h2><p>まず、<code>npm run build</code> でアプリをビルドします。これによって adapter のオプションで指定した出力ディレクトリ (デフォルトは <code>build</code>) に本番環境用のサーバーが作成されます。<p>アプリケーションを実行するには、出力ディレクトリ、プロジェクトの <code>package.json</code>、<code>node_modules</code> の本番向けの依存関係(production dependencies)が必要です。本番向けの依存関係は、<code>package.json</code> と <code>package-lock.json</code> をコピーしてから <code>npm ci --omit dev</code> を実行すると生成することができます (あなたのアプリが何の依存関係も持たない場合はこのステップをスキップできます)。そして、このコマンドでアプリを起動することができます:<pre class="language-bash"><code class="language-bash"><span class="token function">node</span> build</code></pre><p><a href="https://rollupjs.org">Rollup</a> を使うと開発用の依存関係(Development dependencies)もアプリにバンドルされます。パッケージをバンドルするか外部化するかコントロールするには、そのパッケージを <code>package.json</code> の <code>devDependencies</code> か <code>dependencies</code> にそれぞれ配置します。</section><section class="level2"aria-labelledby="環境変数"><h2 id="環境変数">環境変数</h2><p><code>dev</code> と <code>preview</code> のときは、SvelteKit は <code>.env</code> ファイル (または <code>.env.local</code> や <code>.env.[mode]</code>、<a href="https://vitejs.dev/guide/env-and-mode.html#env-files">Vite によって決定されているもの</a>) から環境変数を読み取ります。<p>プロダクションでは、<code>.env</code> ファイルは自動的に読み取れらません。そうするには、プロジェクトに <code>dotenv</code> をインストールします…<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> dotenv</code></pre><p>…そしてビルドされたアプリを実行する前にそれを呼び出します:<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">node build
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">node -r dotenv/config build</span></span></code></pre></section><section class="level2"aria-labelledby="port-と-host"><h2 id="port-と-host"><code>PORT</code> と <code>HOST</code></h2><p>デフォルトでは、サーバーは <code>0.0.0.0</code>、port 3000 でコネクションを受け付けます。これは環境変数の <code>PORT</code> と <code>HOST</code> を使ってカスタマイズすることができます。<pre class="language-text"><code class="language-text">HOST=127.0.0.1 PORT=4000 node build</code></pre></section><section class="level2"aria-labelledby="originprotocol_headerhost_header"><h2 id="originprotocol_headerhost_header"><code>ORIGIN</code>、<code>PROTOCOL_HEADER</code>、<code>HOST_HEADER</code></h2><p>HTTP は SvelteKit に現在リクエストされている URL を知るための信頼できる方法を提供しません。アプリがホストされている場所を Sveltekit に伝える最も簡単な方法は、環境変数 <code>ORIGIN</code> を設定することです:<pre class="language-text"><code class="language-text">ORIGIN=https://my.site node build

# or e.g. for local previewing and testing
ORIGIN=http://localhost:3000 node build</code></pre><p>これにより、パス名 <code>/stuff</code> に対するリクエストは正しく <code>https://my.site/stuff</code> に解決されます。別の方法として、リクエストプロトコルとホストを SvelteKit に伝えるヘッダーを指定し、そこから origin URL を組み立てることもできます:<pre class="language-text"><code class="language-text">PROTOCOL_HEADER=x-forwarded-proto HOST_HEADER=x-forwarded-host node build</code></pre><blockquote><p><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Forwarded-Proto"><code>x-forwarded-proto</code></a> と <a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Forwarded-Host"><code>x-forwarded-host</code></a> は事実上の標準となっているヘッダーで、リバースプロキシー (ロードバランサーや CDN などを考えてみてください) を使用している場合に、オリジナルのプロトコルとホストを転送します。これらの変数は、あなたのサーバーが信頼できるリバースプロキシーの後ろにある場合にのみ設定すべきです。そうしないと、クライアントがこれらのヘッダーを偽装することが可能になってしまいます。</blockquote><p><code>adapter-node</code> があなたのデプロイの URL を正しく判断することができない場合、<a href="form-actions">form actions</a> を使用するとこのエラーが発生することがあります:<blockquote><p>クロスサイトの POST フォーム送信は禁止されています</blockquote></section><section class="level2"aria-labelledby="address_header-と-xff_depth"><h2 id="address_header-と-xff_depth"><code>ADDRESS_HEADER</code> と <code>XFF_DEPTH</code></h2><p>hooks とエンドポイントに渡される <a href="types#public-types-requestevent">RequestEvent</a> オブジェクトにはクライアントの IP アドレスを返す <code>event.getClientAddress()</code> 関数が含まれています。デフォルトでは、これは接続中の <code>remoteAddress</code> です。もしサーバーが1つ以上のプロキシー (例えばロードバランサー) の後ろにある場合、この値はクライアントの IP アドレスではなく、最も内側にあるプロキシーの IP アドレスを含むことになるため、アドレスを読み取るために <code>ADDRESS_HEADER</code> を指定する必要があります:<pre class="language-text"><code class="language-text">ADDRESS_HEADER=True-Client-IP node build</code></pre><blockquote><p>ヘッダーは簡単に偽装されます。<code>PROTOCOL_HEADER</code> や <code>HOST_HEADER</code> と同様、これらを設定する前に<a href="https://adam-p.ca/blog/2022/03/x-forwarded-for/">自分が何をしているのか知るべき</a>です。</blockquote><p><code>ADDRESS_HEADER</code> が <code>X-Forwarded-For</code> の場合、ヘッダーの値にはカンマで区切られた IP アドレスのリストが含まれます。環境変数 <code>XFF_DEPTH</code> には、あなたのサーバーの前に信頼できるプロキシーがいくつあるか指定する必要があります。例えば、3つの信頼できるプロキシーがある場合、プロキシー3はオリジナルのコネクションと最初の2つのプロキシーのアドレスを転送します:<pre class="language-text"><code class="language-text">&#x3C;client address>, &#x3C;proxy 1 address>, &#x3C;proxy 2 address></code></pre><p>一番左のアドレスを読め、というガイドもありますが、これだと<a href="https://adam-p.ca/blog/2022/03/x-forwarded-for/">スプーフィング(なりすまし)に対し脆弱</a>なままです:<pre class="language-text"><code class="language-text">&#x3C;spoofed address>, &#x3C;client address>, &#x3C;proxy 1 address>, &#x3C;proxy 2 address></code></pre><p>代わりに、信頼できるプロキシーの数を考慮して<em>右</em>から読み込みます。この場合、<code>XFF_DEPTH=3</code> を使用します。<blockquote><p>もし、一番左のアドレスを読む必要がある場合 (そしてスプーフィングを気にしない場合) — 例えば、位置情報サービスを提供する場合、つまり IP アドレスが<em>信頼できる</em>ことよりも<em>リアル</em>であることが重要な場合、アプリの中で <code>x-forwarded-for</code> ヘッダーを検査することでそれが可能です。</blockquote></section><section class="level2"aria-labelledby="body_size_limit"><h2 id="body_size_limit"><code>BODY_SIZE_LIMIT</code></h2><p>ストリーミング中も含め、受け付けるリクエストボディの最大サイズを byte で指定します。デフォルトは 512kb です。もっと高度な設定が必要な場合は、このオプションの値を 0 にして無効化し、<a href="hooks#server-hooks-handle"><code>handle</code></a> にカスタムのチェックを実装することができます。</section><section class="level2"aria-labelledby="options"><h2 id="options">Options</h2><p>この adapter は様々なオプションで設定を行うことができます:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-node'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token comment">// default options are shown</span>
			<span class="token literal-property property">out</span><span class="token operator">:</span> <span class="token string">'build'</span><span class="token punctuation">,</span>
			<span class="token literal-property property">precompress</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
			<span class="token literal-property property">envPrefix</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
			<span class="token literal-property property">polyfill</span><span class="token operator">:</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="out"><h2 id="out">out</h2><p>サーバーをビルドするディレクトリです。デフォルトは <code>build</code> です。つまり、<code>node build</code> を指定すると、サーバが作成されローカルで起動します。</section><section class="level2"aria-labelledby="precompress"><h2 id="precompress">precompress</h2><p>アセットやプリレンダリングされたページを gzip や brotli を使って事前圧縮(precompress)するのを有効にします。デフォルトは <code>false</code> です。</section><section class="level2"aria-labelledby="envprefix"><h2 id="envprefix">envPrefix</h2><p>デプロイの設定に使用される環境変数の名前を変更する必要がある場合 (例えば、あなたのコントロール下にない環境変数との競合を解消するため)、接頭辞(prefix)を指定することができます:<pre class="language-js"><code class="language-js"><span class="token literal-property property">envPrefix</span><span class="token operator">:</span> <span class="token string">'MY_CUSTOM_'</span><span class="token punctuation">;</span></code></pre><pre class="language-sh"><code class="language-sh">MY_CUSTOM_HOST=127.0.0.1 \
MY_CUSTOM_PORT=4000 \
MY_CUSTOM_ORIGIN=https://my.site \
node build</code></pre></section><section class="level2"aria-labelledby="polyfill"><h2 id="polyfill">polyfill</h2><p>ビルドが存在しないモジュールの polyfill を読み込むかどうかをコントロールします。デフォルトは <code>true</code> で、Node 18.11 以降を使用している場合にのみ無効にしてください。</section><section class="level2"aria-labelledby="カスタムサーバー"><h2 id="カスタムサーバー">カスタムサーバー</h2><p>この adapter は、ビルドのディレクトリに2つのファイルを作成します — <code>index.js</code> と <code>handler.js</code> です。デフォルトのビルドのディレクトリを使用している場合、<code>node build</code> などで <code>index.js</code> を実行すると、設定された port でサーバーが起動されます。<p>別の方法として、<a href="https://github.com/expressjs/expressjs.com">Express</a>、<a href="https://github.com/senchalabs/connect">Connect</a>、<a href="https://github.com/lukeed/polka">Polka</a> (またはビルトインの <a href="https://nodejs.org/dist/latest/docs/api/http.html#httpcreateserveroptions-requestlistener"><code>http.createServer</code></a>) を使用するためのハンドラーをエクスポートする <code>handler.js</code> ファイルをインポートし、独自のサーバーをセットアップすることもできます。<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307 7006</span>
<span class="token comment">/// file: my-server.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> handler <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./build/handler.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">express</span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a route that lives separately from the SvelteKit app</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/healthcheck'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// let SvelteKit handle everything else, including serving prerendered pages and static assets</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'listening on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="トラブルシューティング"><h2 id="トラブルシューティング">トラブルシューティング</h2></section><section class="level2"aria-labelledby="サーバーが終了する前にクリーンアップするための-hook-はありますか"><h2 id="サーバーが終了する前にクリーンアップするための-hook-はありますか">サーバーが終了する前にクリーンアップするための hook はありますか？</h2><p>SvelteKit にはこれに対応するためのビルトインで組み込まれているものはありません。なぜなら、このようなクリーンアップの hook はあなたの実行環境に大きく依存しているからです。Node の場合は、ビルトインの <code>process.on(..)</code> を使用して、サーバーが終了する前に実行されるコールバックを実装することができます:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2304 2580</span>
<span class="token keyword">function</span> <span class="token function">shutdownGracefully</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// anything you need to clean up manually goes in here</span>
	db<span class="token punctuation">.</span><span class="token method function property-access">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> shutdownGracefully<span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">,</span> shutdownGracefully<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>