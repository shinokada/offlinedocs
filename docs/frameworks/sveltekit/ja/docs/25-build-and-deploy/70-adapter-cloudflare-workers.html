<!doctype html><html lang="ja"><meta charset="utf-8"><title>Cloudflare Workers</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="cloudflare-workers"><h1 id="cloudflare-workers">Cloudflare Workers</h1><p><a href="https://workers.cloudflare.com/">Cloudflare Workers</a> にデプロイする場合は、<a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-cloudflare-workers"><code>adapter-cloudflare-workers</code></a> を使用します。<blockquote><p>Unless you have a specific reason to use <code>adapter-cloudflare-workers</code>, it's recommended that you use <code>adapter-cloudflare</code> instead. Both adapters have equivalent functionality, but Cloudflare Pages offers features like GitHub integration with automatic builds and deploys, preview deployments, instant rollback and so on.</blockquote><section class="level2"aria-labelledby="使い方---usage--"><h2 id="使い方---usage--">使い方</h2><p><code>npm i -D @sveltejs/adapter-cloudflare-workers</code> を実行してインストールし、<code>svelte.config.js</code> にこの adapter を追加します:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-cloudflare-workers'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="基本設定---basic-configuration--"><h2 id="基本設定---basic-configuration--">基本設定</h2><p>この adapter では、プロジェクトの root に <a href="https://developers.cloudflare.com/workers/platform/sites/configuration">wrangler.toml</a> ファイルを置くことを想定しています。内容としては以下のようなものです:<pre class="language-toml"><code class="language-toml">/// file: wrangler<span class="token punctuation">.</span>toml
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"&#x3C;your-service-name>"</span>
<span class="token key property">account_id</span> <span class="token punctuation">=</span> <span class="token string">"&#x3C;your-account-id>"</span>

<span class="token key property">main</span> <span class="token punctuation">=</span> <span class="token string">"./.cloudflare/worker.js"</span>
<span class="token key property">site.bucket</span> <span class="token punctuation">=</span> <span class="token string">"./.cloudflare/public"</span>

<span class="token key property">build.command</span> <span class="token punctuation">=</span> <span class="token string">"npm run build"</span>

<span class="token key property">compatibility_date</span> <span class="token punctuation">=</span> <span class="token string">"2021-11-12"</span>
<span class="token key property">workers_dev</span> <span class="token punctuation">=</span> <span class="token boolean">true</span></code></pre><p><code>&#x3C;your-service-name></code> は何でも構いません。<code>&#x3C;your-account-id></code> は、<a href="https://dash.cloudflare.com">Cloudflare dashboard</a> にログインし、URL の末尾から取得できます:<pre class="language-text"><code class="language-text">https://dash.cloudflare.com/&#x3C;your-account-id></code></pre><blockquote><p><code>.cloudflare</code> ディレクトリ (または <code>main</code> と <code>site.bucket</code> に指定したディレクトリ) を <code>.gitignore</code> に追加する必要があります。</blockquote><p><a href="https://developers.cloudflare.com/workers/wrangler/get-started/">wrangler</a> をインストールしてログインする必要がありますが、もしまだやっていなければ:<pre class="language-text"><code class="language-text">npm i -g wrangler
wrangler login</code></pre><p>その後、アプリをビルドしデプロイすることができます:<pre class="language-sh"><code class="language-sh">wrangler publish</code></pre></section><section class="level2"aria-labelledby="カスタム設定---custom-config--"><h2 id="カスタム設定---custom-config--">カスタム設定</h2><p><code>wrangler.toml</code> 以外の設定ファイルを使用したい場合は、以下のようにします:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-cloudflare-workers'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token string">'&#x3C;your-wrangler-name>.toml'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="環境変数---environment-variables--"><h2 id="環境変数---environment-variables--">環境変数</h2><p>KV/DO namespaces などを含んでいる <a href="https://developers.cloudflare.com/workers/runtime-apis/fetch-event#parameters"><code>env</code></a> オブジェクトは、<code>context</code> や <code>caches</code> と一緒に <code>platform</code> プロパティ経由で SvelteKit に渡されます。つまり、hooks とエンドポイントの中でアクセスできるということです:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 7031</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> request<span class="token punctuation">,</span> platform <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> x <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">YOUR_DURABLE_OBJECT_NAMESPACE</span><span class="token punctuation">.</span><span class="token method function property-access">idFromName</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>環境変数については、SvelteKit の組み込みの <code>$env</code> モジュールの使用を推奨します。</blockquote><p>これらの型をアプリで使えるようにするには、<code>src/app.d.ts</code> でこれらを参照します:<pre class="language-diff"><code class="language-diff">/// file: src/app.d.ts
declare global {
	namespace App {
		interface Platform {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">			env?: {
</span><span class="token prefix inserted">+</span><span class="token line">				YOUR_KV_NAMESPACE: KVNamespace;
</span><span class="token prefix inserted">+</span><span class="token line">				YOUR_DURABLE_OBJECT_NAMESPACE: DurableObjectNamespace;
</span><span class="token prefix inserted">+</span><span class="token line">			};
</span></span>		}
	}
}

export {};</code></pre></section><section class="level2"aria-labelledby="testing-locally"><h2 id="testing-locally">Testing Locally</h2><p><code>platform.env</code> is only available in the final build and not in dev mode. For testing the build, you can use <a href="https://developers.cloudflare.com/workers/cli-wrangler">wrangler</a>. Once you have built your site, run <code>wrangler dev</code>. Ensure you have your <a href="https://developers.cloudflare.com/workers/wrangler/configuration/#bindings">bindings</a> in your <code>wrangler.toml</code>. Wrangler version 3 is recommended. <code>platform.env</code> は最終的なビルドでのみ利用可能であり、開発モード (dev mode) では利用できません。ビルドをテストするには、<a href="https://developers.cloudflare.com/workers/cli-wrangler">wrangler</a> をお使いいただけます。サイトをビルドし、<code>wrangler dev</code> を実行してください。<a href="https://developers.cloudflare.com/workers/wrangler/configuration/#bindings">bindings</a> が <code>wrangler.toml</code> にあることを確認してください。Wrangler のバージョンは 3 を推奨します。</section><section class="level2"aria-labelledby="トラブルシューティング---troubleshooting--"><h2 id="トラブルシューティング---troubleshooting--">トラブルシューティング</h2></section><section class="level2"aria-labelledby="worker-size-limits"><h2 id="worker-size-limits">Worker size limits</h2><p>Workers にデプロイする場合、SvelteKit が生成したサーバーは1つのファイルにバンドルされます。minify 後に Worker が <a href="https://developers.cloudflare.com/workers/platform/limits/#worker-size">そのサイズの上限</a> を超過する場合、Wrangler が Worker の公開に失敗します。通常、この制限に引っかかることはほとんどありませんが、一部の大きいライブラリではこれが発生することがあります。その場合、大きいライブラリをクライアントサイドでのみインポートするようにすることで、Worker のサイズを小さくすることができます。詳細は <a href="./faq#how-do-i-use-x-with-sveltekit-how-do-i-use-a-client-side-only-library-that-depends-on-document-or-window">FAQ</a> をご覧ください。</section><section class="level2"aria-labelledby="ファイルシステムにアクセスする---accessing-the-file-system--"><h2 id="ファイルシステムにアクセスする---accessing-the-file-system--">ファイルシステムにアクセスする</h2><p>Serverless/Edge 環境では、<code>fs.readFileSync</code> などのメソッドでファイルシステムにアクセスすることはできません。もしこのような方法でファイルにアクセスする必要がある場合、アプリのビルド中に<a href="https://kit.svelte.jp../20-core-concepts/40-page-options.html#prerender">プリレンダリング</a>でこれを行ってください。例えば、ブログを持っていて、CMS でコンテンツを管理したくない場合、コンテンツをプリレンダリングし (またはコンテンツを取得するエンドポイントをプリレンダリングし)、新しいコンテンツを追加するたびにブログを再デプロイする必要があります。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>