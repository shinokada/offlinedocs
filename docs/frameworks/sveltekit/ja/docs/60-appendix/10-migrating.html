<!doctypehtml><html lang="ja"><meta charset="utf-8"><title>Sapper からの移行</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="sapper-からの移行"class="level1"><h1>Sapper からの移行</h1><p>rank: 1<p>SvelteKit は Sapper の後継であり、その設計の多くの要素を共有しています。<p>もし、既存の Sapper アプリを SvelteKit に移行する予定がある場合、いくつかの変更が必要になります。移行する際には、<a href="../60-appendix/20-additional-resources.html#examples">examples</a> を見ていただくと参考になると思います。<section id="packagejson"class="level2"><h2>package.json</h2><section id="type-module"class="level3"><h3>type: "module"</h3><p><code>package.json</code> に <code>"type": "module"</code> を追加します。もし Sapper 0.29.3 以降を使用している場合は、インクリメンタルマイグレーションの一部として、このステップを他のステップとは別に行うことができます。</section><section id="dependencies"class="level3"><h3>dependencies</h3><p><code>polka</code> や <code>express</code> を使用している場合はそれを削除し、<code>sirv</code> や <code>compression</code> などのミドルウェア(middleware)も削除します。</section><section id="devdependencies"class="level3"><h3>devDependencies</h3><p><code>devDependencies</code> から <code>sapper</code> を削除し、<code>@sveltejs/kit</code> と使用予定の <a href="../20-core-concepts/50-adapters.html">adapter</a>に置き換えます(<a href="/docs/migrating#project-files-configuration">次のセクション</a>をご覧ください)。</section><section id="scripts"class="level3"><h3>scripts</h3><p><code>sapper</code> を参照しているスクリプトを全て更新します:<ul><li><code>sapper build</code> は、Node <a href="../20-core-concepts/50-adapters.html">adapter</a> を使用した <code>vite build</code> に更新します<li><code>sapper export</code> は、static <a href="../20-core-concepts/50-adapters.html">adapter</a> を使用した <code>vite build</code> に更新します<li><code>sapper dev</code> は <code>vite dev</code> に更新します<li><code>node __sapper__/build</code> は <code>node build</code> に更新します</ul></section></section><section id="プロジェクトファイル"class="level2"><h2>プロジェクトファイル</h2><p>アプリの大部分を占める <code>src/routes</code> の中はそのままで大丈夫ですが、いくつかのプロジェクトファイルを移動または更新する必要があります。<section id="configuration"class="level3"><h3>Configuration</h3><p><a href="../50-api-reference/10-configuration.html">こちら</a>に記載されている通り、<code>webpack.config.js</code> または <code>rollup.config.js</code> を <code>svelte.config.js</code> に置き換えてください。Svelte の preprocessor オプション は <code>config.preprocess</code> に移動してください。<p><a href="../20-core-concepts/50-adapters.html">adapter</a> を追加する必要があります。<code>sapper build</code> は <a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-node">adapter-node</a> とおおよそ同じで、<code>sapper export</code> は <a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-static">adapter-static</a> とおおよそ同じですが、デプロイ先のプラットフォーム向けにデザインされた adapter を使用するのも良いでしょう。<p><a href="https://vitejs.dev">Vite</a> では自動的に処理されないファイルタイプのプラグインを使用している場合は、Vite において同等なことを行う方法を探し、<a href="../10-getting-started/30-project-structure.html#project-files-vite-config-js">Vite config</a> に追加する必要があります。</section><section id="srcclientjs"class="level3"><h3>src/client.js</h3><p>SvelteKit にはこのファイルに相当するものはありません。カスタムロジック(<code>sapper.start(...)</code> 以降) は、<code>+layout.svelte</code> ファイルで、<code>onMount</code> コールバック内に記述してくさい。</section><section id="srcserverjs"class="level3"><h3>src/server.js</h3><p><code>adapter-node</code> を使用する場合は、<a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-node#custom-server">custom server</a> がこれと同等のものです。それ以外の場合は、同等のものに該当するものはありません。なぜならSvelteKit アプリはサーバーレス環境でも実行だからです。</section><section id="srcservice-workerjs"class="level3"><h3>src/service-worker.js</h3><p><code>@sapper/service-worker</code> からインポートするほとんどのものは、<a href="../50-api-reference/30-modules.html#$service-worker"><code>$service-worker</code></a> に同等なものがあります:<ul><li><code>files</code> は変更されていません<li><code>routes</code> は削除されました<li><code>shell</code> は現在 <code>build</code> になりました<li><code>timestamp</code> は現在 <code>version</code> になりました</ul></section><section id="srctemplatehtml"class="level3"><h3>src/template.html</h3><p><code>src/template.html</code> は <code>src/app.html</code> にリネームする必要があります。<p><code>%sapper.base%</code>、<code>%sapper.scripts%</code>、<code>%sapper.styles%</code> を削除します。<code>%sapper.head%</code> を <code>%sveltekit.head%</code> に、<code>%sapper.html%</code> を <code>%sveltekit.body%</code> にそれぞれ置き換えます。<code>&#x3C;div id="sapper"></code> はもう必要ありません。</section><section id="srcnode_modules"class="level3"><h3>src/node_modules</h3><p>Sapper アプリでよくあるパターンとして、内部ライブラリを <code>src/node_modules</code> 内のディレクトリに配置する、というものがあります。これは Vite だと動作しないため、代わりに <a href="../50-api-reference/30-modules.html#$lib"><code>src/lib</code></a> を使用します。</section></section><section id="ページとレイアウト"class="level2"><h2>ページとレイアウト</h2><section id="名前が変わったファイル"class="level3"><h3>名前が変わったファイル</h3><p>ルート(Routes)は曖昧さをなくすためフォルダ名のみで構成されるようになり、<code>+page.svelte</code> までのフォルダ名がルート(route)に対応するようになりました。概要は <a href="../20-core-concepts/10-routing.html">ルーティングのドキュメント</a> をご参照ください。以下は 新/旧 の比較です:<table><thead><tr><th>Old<th>New<tbody><tr><td>routes/about/index.svelte<td>routes/about/+page.svelte<tr><td>routes/about.svelte<td>routes/about/+page.svelte</table><p>カスタムのエラーページコンポーネントは <code>_error.svelte</code> から <code>+error.svelte</code> にリネームしてください。また、どの <code>_layout.svelte</code> ファイルも、同様に <code>+layout.svelte</code> にリネームしてください。<a href="../20-core-concepts/10-routing.html#other-files">その他のファイルは無視されます</a>.</section><section id="imports"class="level3"><h3>Imports</h3><p><code>@sapper/app</code> からインポートしていた <code>goto</code>、<code>prefetch</code>、<code>prefetchRoutes</code> は <a href="../50-api-reference/30-modules.html#$app-navigation"><code>$app/navigation</code></a> からのインポートに置き換えてください。<p><code>@sapper/app</code> からインポートしていた <code>stores</code> については置き換える必要があります — 以下の <a href="/docs/migrating#pages-and-layouts-stores">Stores</a>) をご覧ください。<p><code>src/node_modules</code> にあるディレクトリからインポートしてたファイルは、<a href="../50-api-reference/30-modules.html#$lib"><code>$lib</code></a> からのインポートに置き換えてください。</section><section id="preload"class="level3"><h3>Preload</h3><p>以前と同様に、ページやレイアウトではレンダリングが行われる前にデータをロードできる関数をエクスポートすることができます。<p>この関数は <code>preload</code> から <a href="../20-core-concepts/20-load.html"><code>load</code></a> にリネームされ、その API が変更されました。2 つの引数 — <code>page</code> と <code>session</code> — の代わりに、両方を 1 つにまとめた引数と、<code>fetch</code> (<code>this.fetch</code> からの置き換え)、そして新たに <code>stuff</code> オブジェクトが追加されました。<p><code>this</code> オブジェクトはなくなり、その結果 <code>this.fetch</code>、<code>this.error</code>、<code>this.redirect</code> もなくなりました。代わりに、<a href="../20-core-concepts/20-load.html#making-fetch-requests"><code>fetch</code></a> を input メソッドから使用できるようになり、<a href="../20-core-concepts/20-load.html#errors"><code>error</code></a> と <a href="../20-core-concepts/20-load.html#redirects"><code>redirect</code></a> の両方がスローされるようになりました。.</section><section id="stores"class="level3"><h3>Stores</h3><p>Sapper では、提供されるストアをこのように参照していたかと思います:<pre class="language-js"><code class="language-js"><span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'@sapper/app'</span><span class="token punctuation">;</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> stores <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@sapper/app'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> preloading<span class="token punctuation">,</span> page<span class="token punctuation">,</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">stores</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>page</code> と <code>session</code> ストアはまだ存在しています。<code>preloading</code> は、<code>from</code> プロパティと <code>to</code> プロパティを含む <code>navigating</code> ストアに置き換えられました。<code>page</code> は <code>url</code>、<code>params</code> を持つようになりましたが、<code>path</code> と <code>query</code> はありません。<p>SvelteKit では、それらにアクセスする方法が異なります。<code>stores</code> は <code>getStores</code> になりましたが、<a href="../50-api-reference/30-modules.html#$app-stores"><code>$app/stores</code></a> から直接 <code>navigating</code>、<code>page</code>、<code>session</code> をインポートできるので、ほとんどの場合は必要ありません。</section><section id="ルーティング"class="level3"><h3>ルーティング</h3><p>ルート(routes) の正規表現はもうサポートされていません。代わりに、<a href="../30-advanced/10-advanced-routing.html-routing#matching">advanced route matching</a> をお使いください。</section><section id="segments"class="level3"><h3>Segments</h3><p>以前までは、レイアウトコンポーネントは子のセグメントを表す <code>segment</code> プロパティを受け取っていましたが、この機能は削除されました。より柔軟な <code>$page.url.pathname</code> の値を使用し、お望みのセグメントを取得してください。</section><section id="urls"class="level3"><h3>URLs</h3><p>Sapper では、相対 URL は、現在のページに対してではなく、base URL (<code>basepath</code> オプションが使用されていない限り、大抵の場合は <code>/</code>) に対して解決されていました。<p>これによって問題が発生していましたが、SvelteKit ではもうそのようなことはありません。相対 URL が現在のページ (または <code>load</code> 関数の <code>fetch</code> URL の場合は移動先のページ) に対して解決されるようになりました。多くの場合、(例えば、<code>/</code> 始まるような) ルート相対な URL を使用するほうが簡単です。なぜなら、それらの意図がコンテキストに依存しないからです。</section><section id="a-attributes"class="level3"><h3>&#x3C;a> attributes</h3><ul><li><code>sapper:prefetch</code> is now <code>data-sveltekit-prefetch</code><li><code>sapper:noscroll</code> is now <code>data-sveltekit-noscroll</code></ul></section></section><section id="endpoints"class="level2"><h2>Endpoints</h2><p>Sapper では、<a href="../20-core-concepts/10-routing.html#server">サーバールート(server routes)</a> は、Node の <code>http</code> モジュール によって公開される <code>req</code> と <code>res</code> オブジェクト(または Polka や Express などのフレームワークが提供するその拡張版) を受け取っていました。<p>SvelteKit は、アプリが動作する場所に依存しないように設計されています(Node サーバーで動作し、サーバーレスプラットフォームや Cloudflare Worker でも同様に動作します)。そのため、もう <code>req</code> と <code>res</code> を直接扱いません。エンドポイントを、新しいシグネチャに合わせて更新する必要があります。<p>環境非依存な動作をサポートするため、グローバルコンテキストで <code>fetch</code> が利用できるようになり、<code>node-fetch</code> や <code>cross-fetch</code> などのサーバーサイドの fetch 実装をインポートする必要がなくなりました。</section><section id="インテグレーション"class="level2"><h2>インテグレーション</h2><p>インテグレーションに関する詳細情報については <a href="/faq#integrations">FAQ</a> をご参照ください。<section id="html-minifier"class="level3"><h3>HTML minifier</h3><p>Sapper はデフォルトで <code>html-minifier</code> を含んでいました。SvelteKit はこれを含まないのですが、<a href="../30-advanced/20-hooks.html#server-hooks-handle">hook</a> としてこれを追加することができます:<pre class="language-js"><code class="language-js"><span class="token comment">// @filename: ambient.d.ts</span>
<span class="token comment">/// &#x3C;reference types="@sveltejs/kit" /></span>
declare module <span class="token string">'html-minifier'</span><span class="token punctuation">;</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> minify <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'html-minifier'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> prerendering <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$app/environment'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> minification_options <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">collapseBooleanAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">collapseWhitespace</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">conservativeCollapse</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">decodeEntities</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">html5</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">ignoreCustomComments</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^#</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token literal-property property">minifyCSS</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">minifyJS</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeAttributeQuotes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeComments</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// some hydration code needs comments, so leave them in</span>
	<span class="token literal-property property">removeOptionalTags</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeRedundantAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeScriptTypeAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeStyleLinkTypeAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">sortAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">sortClassName</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Handle<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>prerendering <span class="token operator">&#x26;&#x26;</span> response<span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token function">minify</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> response<span class="token punctuation">.</span><span class="token method function property-access">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minification_options<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
			<span class="token literal-property property">status</span><span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token property-access">status</span><span class="token punctuation">,</span>
			<span class="token literal-property property">headers</span><span class="token operator">:</span> response<span class="token punctuation">.</span><span class="token property-access">headers</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>サイトのプロダクションビルドをテストするのに <code>vite preview</code> を使用しているときは、<code>prerendering</code> が <code>false</code> となることにご注意ください。そのため、minify の結果を検証するには、ビルド済の HTML を直接確認する必要があります。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></section>