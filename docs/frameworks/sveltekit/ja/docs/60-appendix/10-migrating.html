<!doctype html><html lang="ja"><meta charset="utf-8"><title>Sapper からの移行</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="sapper-からの移行"><h1 id="sapper-からの移行">Sapper からの移行</h1><p>rank: 1<p>SvelteKit は Sapper の後継であり、その設計の多くの要素を共有しています。<p>もし、既存の Sapper アプリを SvelteKit に移行する予定がある場合、いくつかの変更が必要になります。移行する際には、<a href="additional-resources#examples">examples</a> を見ていただくと参考になると思います。<section class="level2"aria-labelledby="packagejson"><h2 id="packagejson">package.json</h2></section><section class="level2"aria-labelledby="type-module"><h2 id="type-module">type: "module"</h2><p><code>package.json</code> に <code>"type": "module"</code> を追加します。もし Sapper 0.29.3 以降を使用している場合は、インクリメンタルマイグレーションの一部として、このステップを他のステップとは別に行うことができます。</section><section class="level2"aria-labelledby="dependencies"><h2 id="dependencies">dependencies</h2><p><code>polka</code> や <code>express</code> を使用している場合はそれを削除し、<code>sirv</code> や <code>compression</code> などのミドルウェア(middleware)も削除します。</section><section class="level2"aria-labelledby="devdependencies"><h2 id="devdependencies">devDependencies</h2><p><code>devDependencies</code> から <code>sapper</code> を削除し、<code>@sveltejs/kit</code> と使用予定の <a href="adapters">adapter</a>に置き換えます(<a href="migrating#project-files-configuration">次のセクション</a>をご覧ください)。</section><section class="level2"aria-labelledby="scripts"><h2 id="scripts">scripts</h2><p><code>sapper</code> を参照しているスクリプトを全て更新します:<ul><li><code>sapper build</code> は、Node <a href="adapters">adapter</a> を使用した <code>vite build</code> に更新します<li><code>sapper export</code> は、static <a href="adapters">adapter</a> を使用した <code>vite build</code> に更新します<li><code>sapper dev</code> は <code>vite dev</code> に更新します<li><code>node __sapper__/build</code> は <code>node build</code> に更新します</ul></section><section class="level2"aria-labelledby="プロジェクトファイル---project-files--"><h2 id="プロジェクトファイル---project-files--">プロジェクトファイル</h2><p>アプリの大部分を占める <code>src/routes</code> の中はそのままで大丈夫ですが、いくつかのプロジェクトファイルを移動または更新する必要があります。</section><section class="level2"aria-labelledby="configuration"><h2 id="configuration">Configuration</h2><p><a href="configuration">こちら</a>に記載されている通り、<code>webpack.config.js</code> または <code>rollup.config.js</code> を <code>svelte.config.js</code> に置き換えてください。Svelte の preprocessor オプション は <code>config.preprocess</code> に移動してください。<p><a href="adapters">adapter</a> を追加する必要があります。<code>sapper build</code> は <a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-node">adapter-node</a> とおおよそ同じで、<code>sapper export</code> は <a href="https://github.com/sveltejs/kit/tree/master/packages/adapter-static">adapter-static</a> とおおよそ同じですが、デプロイ先のプラットフォーム向けにデザインされた adapter を使用するのも良いでしょう。<p><a href="https://vitejs.dev">Vite</a> では自動的に処理されないファイルタイプのプラグインを使用している場合は、Vite において同等なことを行う方法を探し、<a href="project-structure#project-files-vite-config-js">Vite config</a> に追加する必要があります。</section><section class="level2"aria-labelledby="srcclientjs"><h2 id="srcclientjs">src/client.js</h2><p>SvelteKit にはこのファイルに相当するものはありません。カスタムロジック(<code>sapper.start(...)</code> 以降) は、<code>+layout.svelte</code> ファイルで、<code>onMount</code> コールバック内に記述してくさい。</section><section class="level2"aria-labelledby="srcserverjs"><h2 id="srcserverjs">src/server.js</h2><p><code>adapter-node</code> を使用する場合は、<a href="adapter-node#custom-server">custom server</a> がこれと同等のものです。それ以外の場合は、同等のものに該当するものはありません。なぜなら SvelteKit アプリはサーバーレス環境でも実行可能だからです。</section><section class="level2"aria-labelledby="srcservice-workerjs"><h2 id="srcservice-workerjs">src/service-worker.js</h2><p><code>@sapper/service-worker</code> からインポートするほとんどのものは、<a href="modules#$service-worker"><code>$service-worker</code></a> に同等なものがあります:<ul><li><code>files</code> は変更されていません<li><code>routes</code> は削除されました<li><code>shell</code> は現在 <code>build</code> になりました<li><code>timestamp</code> は現在 <code>version</code> になりました</ul></section><section class="level2"aria-labelledby="srctemplatehtml"><h2 id="srctemplatehtml">src/template.html</h2><p><code>src/template.html</code> は <code>src/app.html</code> にリネームする必要があります。<p><code>%sapper.base%</code>、<code>%sapper.scripts%</code>、<code>%sapper.styles%</code> を削除します。<code>%sapper.head%</code> を <code>%sveltekit.head%</code> に、<code>%sapper.html%</code> を <code>%sveltekit.body%</code> にそれぞれ置き換えます。<code>&#x3C;div id="sapper"></code> はもう必要ありません。</section><section class="level2"aria-labelledby="srcnode_modules"><h2 id="srcnode_modules">src/node_modules</h2><p>Sapper アプリでよくあるパターンとして、内部ライブラリを <code>src/node_modules</code> 内のディレクトリに配置する、というものがあります。これは Vite だと動作しないため、代わりに <a href="modules#$lib"><code>src/lib</code></a> を使用します。</section><section class="level2"aria-labelledby="ページとレイアウト---pages-and-layouts--"><h2 id="ページとレイアウト---pages-and-layouts--">ページとレイアウト</h2></section><section class="level2"aria-labelledby="名前が変わったファイル---renamed-files--"><h2 id="名前が変わったファイル---renamed-files--">名前が変わったファイル</h2><p>ルート(Routes)は曖昧さをなくすためフォルダ名のみで構成されるようになり、<code>+page.svelte</code> までのフォルダ名がルート(route)に対応するようになりました。概要は <a href="routing">ルーティングのドキュメント</a> をご参照ください。以下は 新/旧 の比較です:<table><thead><tr><th>Old<th>New<tbody><tr><td>routes/about/index.svelte<td>routes/about/+page.svelte<tr><td>routes/about.svelte<td>routes/about/+page.svelte</table><p>カスタムのエラーページコンポーネントは <code>_error.svelte</code> から <code>+error.svelte</code> にリネームしてください。また、どの <code>_layout.svelte</code> ファイルも、同様に <code>+layout.svelte</code> にリネームしてください。<a href="routing#other-files">その他のファイルは無視されます</a>.</section><section class="level2"aria-labelledby="imports"><h2 id="imports">Imports</h2><p><code>@sapper/app</code> からインポートしていた <code>goto</code>、<code>prefetch</code>、<code>prefetchRoutes</code> は、<a href="modules#$app-navigation"><code>$app/navigation</code></a> からインポートする <code>goto</code>、<code>preloadData</code>、<code>preloadCode</code> にそれぞれ置き換えてください。<p><code>@sapper/app</code> からインポートしていた <code>stores</code> については置き換える必要があります — 以下の <a href="migrating#pages-and-layouts-stores">Stores</a>) をご覧ください。<p><code>src/node_modules</code> にあるディレクトリからインポートしてたファイルは、<a href="modules#$lib"><code>$lib</code></a> からのインポートに置き換えてください。</section><section class="level2"aria-labelledby="preload"><h2 id="preload">Preload</h2><p>以前と同様に、ページやレイアウトではレンダリングが行われる前にデータをロードできる関数をエクスポートすることができます。<p>この関数は <code>preload</code> から <a href="load"><code>load</code></a> にリネームされ、その API が変更されました。2 つの引数 — <code>page</code> と <code>session</code> — の代わりに、両方を 1 つにまとめた引数と、<code>fetch</code> (<code>this.fetch</code> からの置き換え)、そして新たに <code>stuff</code> オブジェクトが追加されました。<p><code>this</code> オブジェクトはなくなり、その結果 <code>this.fetch</code>、<code>this.error</code>、<code>this.redirect</code> もなくなりました。代わりに、<a href="load#making-fetch-requests"><code>fetch</code></a> を input メソッドから使用できるようになり、<a href="load#errors"><code>error</code></a> と <a href="load#redirects"><code>redirect</code></a> の両方がスローされるようになりました。. This function has been renamed from <code>preload</code> to <a href="load"><code>load</code></a>, it now lives in a <code>+page.js</code> (or <code>+layout.js</code>) next to its <code>+page.svelte</code> (or <code>+layout.svelte</code>), and its API has changed. Instead of two arguments — <code>page</code> and <code>session</code> — there is a single <code>event</code> argument.<p>There is no more <code>this</code> object, and consequently no <code>this.fetch</code>, <code>this.error</code> or <code>this.redirect</code>. Instead, you can get <a href="load#making-fetch-requests"><code>fetch</code></a> from the input methods, and both <a href="load#errors"><code>error</code></a> and <a href="load#redirects"><code>redirect</code></a> are now thrown.</section><section class="level2"aria-labelledby="stores"><h2 id="stores">Stores</h2><p>Sapper では、提供されるストアをこのように参照していたかと思います:<pre class="language-js"><code class="language-js"><span class="token comment">// @filename: ambient.d.ts</span>
declare module <span class="token string">'@sapper/app'</span><span class="token punctuation">;</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> stores <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@sapper/app'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> preloading<span class="token punctuation">,</span> page<span class="token punctuation">,</span> session <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">stores</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>page</code> と <code>session</code> ストアはまだ存在しています。<code>preloading</code> は、<code>from</code> プロパティと <code>to</code> プロパティを含む <code>navigating</code> ストアに置き換えられました。<code>page</code> は <code>url</code>、<code>params</code> を持つようになりましたが、<code>path</code> と <code>query</code> はありません。<p>SvelteKit では、それらにアクセスする方法が異なります。<code>stores</code> は <code>getStores</code> になりましたが、<a href="modules#$app-stores"><code>$app/stores</code></a> から直接 <code>navigating</code>、<code>page</code>、<code>session</code> をインポートできるので、ほとんどの場合は必要ありません。</section><section class="level2"aria-labelledby="ルーティング---routing--"><h2 id="ルーティング---routing--">ルーティング</h2><p>ルート(routes) の正規表現はもうサポートされていません。代わりに、<a href="advanced-routing#matching">advanced route matching</a> をお使いください。</section><section class="level2"aria-labelledby="segments"><h2 id="segments">Segments</h2><p>以前までは、レイアウトコンポーネントは子のセグメントを表す <code>segment</code> プロパティを受け取っていましたが、この機能は削除されました。より柔軟な <code>$page.url.pathname</code> の値を使用し、お望みのセグメントを取得してください。</section><section class="level2"aria-labelledby="urls"><h2 id="urls">URLs</h2><p>Sapper では、相対 URL は、現在のページに対してではなく、base URL (<code>basepath</code> オプションが使用されていない限り、大抵の場合は <code>/</code>) に対して解決されていました。<p>これによって問題が発生していましたが、SvelteKit ではもうそのようなことはありません。相対 URL が現在のページ (または <code>load</code> 関数の <code>fetch</code> URL の場合は移動先のページ) に対して解決されるようになりました。多くの場合、(例えば、<code>/</code> 始まるような) ルート相対な URL を使用するほうが簡単です。なぜなら、それらの意図がコンテキストに依存しないからです。</section><section class="level2"aria-labelledby="a-attributes"><h2 id="a-attributes">&#x3C;a> attributes</h2><ul><li><code>sapper:prefetch</code> は <code>data-sveltekit-preload-data</code> になりました<li><code>sapper:noscroll</code> は <code>data-sveltekit-noscroll</code> になりました</ul></section><section class="level2"aria-labelledby="endpoints"><h2 id="endpoints">Endpoints</h2><p>Sapper では、<a href="routing#server">サーバールート(server routes)</a> は、Node の <code>http</code> モジュール によって公開される <code>req</code> と <code>res</code> オブジェクト(または Polka や Express などのフレームワークが提供するその拡張版) を受け取っていました。<p>SvelteKit は、アプリが動作する場所に依存しないように設計されています(Node サーバーで動作し、サーバーレスプラットフォームや Cloudflare Worker でも同様に動作します)。そのため、もう <code>req</code> と <code>res</code> を直接扱いません。エンドポイントを、新しいシグネチャに合わせて更新する必要があります。<p>環境非依存な動作をサポートするため、グローバルコンテキストで <code>fetch</code> が利用できるようになり、<code>node-fetch</code> や <code>cross-fetch</code> などのサーバーサイドの fetch 実装をインポートする必要がなくなりました。</section><section class="level2"aria-labelledby="インテグレーション---integrations--"><h2 id="インテグレーション---integrations--">インテグレーション</h2><p>インテグレーションに関する詳細情報については <a href="./integrations">インテグレーション</a> をご参照ください。</section><section class="level2"aria-labelledby="html-minifier"><h2 id="html-minifier">HTML minifier</h2><p>Sapper はデフォルトで <code>html-minifier</code> を含んでいました。SvelteKit はこれを含まないのですが、本番環境向けの依存関係(prod dependency)としてこれを追加し、<a href="hooks#server-hooks-handle">hook</a> で使用することができます:<pre class="language-js"><code class="language-js"><span class="token comment">// @filename: ambient.d.ts</span>
<span class="token comment">/// &#x3C;reference types="@sveltejs/kit" /></span>
declare module <span class="token string">'html-minifier'</span><span class="token punctuation">;</span>

<span class="token comment">// @filename: index.js</span>
<span class="token comment">// cut---</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> minify <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'html-minifier'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> building <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$app/environment'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> minification_options <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">collapseBooleanAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">collapseWhitespace</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">conservativeCollapse</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">decodeEntities</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">html5</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">ignoreCustomComments</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^#</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token literal-property property">minifyCSS</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">minifyJS</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeAttributeQuotes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeComments</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// some hydration code needs comments, so leave them in</span>
	<span class="token literal-property property">removeOptionalTags</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeRedundantAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeScriptTypeAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">removeStyleLinkTypeAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">sortAttributes</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
	<span class="token literal-property property">sortClassName</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/** <span class="token keyword">@type</span> <span class="token class-name"><span class="token punctuation">{</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'@sveltejs/kit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Handle<span class="token punctuation">}</span></span> */</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> event<span class="token punctuation">,</span> resolve <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>

	<span class="token keyword control-flow">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token punctuation">{</span>
		<span class="token function-variable function">transformPageChunk</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> html<span class="token punctuation">,</span> done <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
			page <span class="token operator">+=</span> html<span class="token punctuation">;</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword control-flow">return</span> building <span class="token operator">?</span> <span class="token function">minify</span><span class="token punctuation">(</span>page<span class="token punctuation">,</span> minification_options<span class="token punctuation">)</span> <span class="token operator">:</span> page<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>サイトのプロダクションビルドをテストするのに <code>vite preview</code> を使用しているときは、<code>prerendering</code> が <code>false</code> となることにご注意ください。そのため、minify の結果を検証するには、ビルド済の HTML を直接確認する必要があります。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>