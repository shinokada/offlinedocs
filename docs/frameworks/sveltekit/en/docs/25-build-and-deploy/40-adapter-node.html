<!doctype html><html lang="en"><meta charset="utf-8"><title>Node servers</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="node-servers"><h1 id="node-servers">Node servers</h1><p>To generate a standalone Node server, use <a href="https://github.com/sveltejs/kit/tree/main/packages/adapter-node"><code>adapter-node</code></a>.<section class="level2"aria-labelledby="usage"><h2 id="usage">Usage</h2><p>Install with <code>npm i -D @sveltejs/adapter-node</code>, then add the adapter to your <code>svelte.config.js</code>:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-node'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="deploying"><h2 id="deploying">Deploying</h2><p>First, build your app with <code>npm run build</code>. This will create the production server in the output directory specified in the adapter options, defaulting to <code>build</code>.<p>You will need the output directory, the project's <code>package.json</code>, and the production dependencies in <code>node_modules</code> to run the application. Production dependencies can be generated by copying the <code>package.json</code> and <code>package-lock.json</code> and then running <code>npm ci --omit dev</code> (you can skip this step if your app doesn't have any dependencies). You can then start your app with this command:<pre class="language-bash"><code class="language-bash"><span class="token function">node</span> build</code></pre><p>Development dependencies will be bundled into your app using <a href="https://rollupjs.org">Rollup</a>. To control whether a given package is bundled or externalised, place it in <code>devDependencies</code> or <code>dependencies</code> respectively in your <code>package.json</code>.</section><section class="level2"aria-labelledby="compressing-responses"><h2 id="compressing-responses">Compressing responses</h2><p>You will typically want to compress responses coming from the server. If you are already deploying your server behind a reverse proxy for SSL or load balancing, it typically results in better performance to also handle compression at that layer since Node.js is single-threaded.<p>However, if you're building a <a href="#custom-server">custom server</a> and do want to add a compression middleware there, note that we would recommend using <a href="https://www.npmjs.com/package/@polka/compression"><code>@polka/compression</code></a> since SvelteKit streams responses and the more popular <code>compression</code> package does not support streaming and may cause errors when used.</section><section class="level2"aria-labelledby="environment-variables"><h2 id="environment-variables">Environment variables</h2><p>In <code>dev</code> and <code>preview</code>, SvelteKit will read environment variables from your <code>.env</code> file (or <code>.env.local</code>, or <code>.env.[mode]</code>, <a href="https://vitejs.dev/guide/env-and-mode.html#env-files">as determined by Vite</a>.)<p>In production, <code>.env</code> files are <em>not</em> automatically loaded. To do so, install <code>dotenv</code> in your project...<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> dotenv</code></pre><p>...and invoke it before running the built app:<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> node build
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> node -r dotenv/config build</span></span></code></pre><p>If you use Node.js v20.6+, you can use the <a href="https://nodejs.org/en/learn/command-line/how-to-read-environment-variables-from-nodejs"><code>--env-file</code></a> flag instead:<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> node build
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> node --env-file=.env build</span></span></code></pre></section><section class="level2"aria-labelledby="port-host-and-socket_path"><h2 id="port-host-and-socket_path"><code>PORT</code>, <code>HOST</code> and <code>SOCKET_PATH</code></h2><p>By default, the server will accept connections on <code>0.0.0.0</code> using port 3000. These can be customised with the <code>PORT</code> and <code>HOST</code> environment variables:<pre class="language-text"><code class="language-text">HOST=127.0.0.1 PORT=4000 node build</code></pre><p>Alternatively, the server can be configured to accept connections on a specified socket path. When this is done using the <code>SOCKET_PATH</code> environment variable, the <code>HOST</code> and <code>PORT</code> environment variables will be disregarded.<pre class="language-text"><code class="language-text">SOCKET_PATH=/tmp/socket node build</code></pre></section><section class="level2"aria-labelledby="origin-protocol_header-host_header-and-port_header"><h2 id="origin-protocol_header-host_header-and-port_header"><code>ORIGIN</code>, <code>PROTOCOL_HEADER</code>, <code>HOST_HEADER</code>, and <code>PORT_HEADER</code></h2><p>HTTP doesn't give SvelteKit a reliable way to know the URL that is currently being requested. The simplest way to tell SvelteKit where the app is being served is to set the <code>ORIGIN</code> environment variable:<pre class="language-text"><code class="language-text">ORIGIN=https://my.site node build

# or e.g. for local previewing and testing
ORIGIN=http://localhost:3000 node build</code></pre><p>With this, a request for the <code>/stuff</code> pathname will correctly resolve to <code>https://my.site/stuff</code>. Alternatively, you can specify headers that tell SvelteKit about the request protocol and host, from which it can construct the origin URL:<pre class="language-text"><code class="language-text">PROTOCOL_HEADER=x-forwarded-proto HOST_HEADER=x-forwarded-host node build</code></pre><blockquote><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto"><code>x-forwarded-proto</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Host"><code>x-forwarded-host</code></a> are de facto standard headers that forward the original protocol and host if you're using a reverse proxy (think load balancers and CDNs). You should only set these variables if your server is behind a trusted reverse proxy; otherwise, it'd be possible for clients to spoof these headers.<p>If you're hosting your proxy on a non-standard port and your reverse proxy supports <code>x-forwarded-port</code>, you can also set <code>PORT_HEADER=x-forwarded-port</code>.</blockquote><p>If <code>adapter-node</code> can't correctly determine the URL of your deployment, you may experience this error when using <a href="form-actions">form actions</a>:<blockquote><p>Cross-site POST form submissions are forbidden</blockquote></section><section class="level2"aria-labelledby="address_header-and-xff_depth"><h2 id="address_header-and-xff_depth"><code>ADDRESS_HEADER</code> and <code>XFF_DEPTH</code></h2><p>The <a href="types#public-types-requestevent">RequestEvent</a> object passed to hooks and endpoints includes an <code>event.getClientAddress()</code> function that returns the client's IP address. By default this is the connecting <code>remoteAddress</code>. If your server is behind one or more proxies (such as a load balancer), this value will contain the innermost proxy's IP address rather than the client's, so we need to specify an <code>ADDRESS_HEADER</code> to read the address from:<pre class="language-text"><code class="language-text">ADDRESS_HEADER=True-Client-IP node build</code></pre><blockquote><p>Headers can easily be spoofed. As with <code>PROTOCOL_HEADER</code> and <code>HOST_HEADER</code>, you should <a href="https://adam-p.ca/blog/2022/03/x-forwarded-for/">know what you're doing</a> before setting these.</blockquote><p>If the <code>ADDRESS_HEADER</code> is <code>X-Forwarded-For</code>, the header value will contain a comma-separated list of IP addresses. The <code>XFF_DEPTH</code> environment variable should specify how many trusted proxies sit in front of your server. E.g. if there are three trusted proxies, proxy 3 will forward the addresses of the original connection and the first two proxies:<pre class="language-text"><code class="language-text">&#x3C;client address>, &#x3C;proxy 1 address>, &#x3C;proxy 2 address></code></pre><p>Some guides will tell you to read the left-most address, but this leaves you <a href="https://adam-p.ca/blog/2022/03/x-forwarded-for/">vulnerable to spoofing</a>:<pre class="language-text"><code class="language-text">&#x3C;spoofed address>, &#x3C;client address>, &#x3C;proxy 1 address>, &#x3C;proxy 2 address></code></pre><p>We instead read from the <em>right</em>, accounting for the number of trusted proxies. In this case, we would use <code>XFF_DEPTH=3</code>.<blockquote><p>If you need to read the left-most address instead (and don't care about spoofing) — for example, to offer a geolocation service, where it's more important for the IP address to be <em>real</em> than <em>trusted</em>, you can do so by inspecting the <code>x-forwarded-for</code> header within your app.</blockquote></section><section class="level2"aria-labelledby="body_size_limit"><h2 id="body_size_limit"><code>BODY_SIZE_LIMIT</code></h2><p>The maximum request body size to accept in bytes including while streaming. The body size can also be specified with a unit suffix for kilobytes (<code>K</code>), megabytes (<code>M</code>), or gigabytes (<code>G</code>). For example, <code>512K</code> or <code>1M</code>. Defaults to 512kb. You can disable this option with a value of <code>Infinity</code> (0 in older versions of the adapter) and implement a custom check in <a href="hooks#server-hooks-handle"><code>handle</code></a> if you need something more advanced.</section><section class="level2"aria-labelledby="shutdown_timeout"><h2 id="shutdown_timeout"><code>SHUTDOWN_TIMEOUT</code></h2><p>The number of seconds to wait before forcefully closing any remaining connections after receiving a <code>SIGTERM</code> or <code>SIGINT</code> signal. Defaults to <code>30</code>. Internally the adapter calls <a href="https://nodejs.org/api/http.html#servercloseallconnections"><code>closeAllConnections</code></a>. See <a href="#graceful-shutdown">Graceful shutdown</a> for more details.</section><section class="level2"aria-labelledby="idle_timeout"><h2 id="idle_timeout"><code>IDLE_TIMEOUT</code></h2><p>When using systemd socket activation, <code>IDLE_TIMEOUT</code> specifies the number of seconds after which the app is automatically put to sleep when receiving no requests. If not set, the app runs continuously. See <a href="#socket-activation">Socket activation</a> for more details.</section><section class="level2"aria-labelledby="options"><h2 id="options">Options</h2><p>The adapter can be configured with various options:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-node'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token comment">// default options are shown</span>
			<span class="token literal-property property">out</span><span class="token operator">:</span> <span class="token string">'build'</span><span class="token punctuation">,</span>
			<span class="token literal-property property">precompress</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
			<span class="token literal-property property">envPrefix</span><span class="token operator">:</span> <span class="token string">''</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="out"><h2 id="out">out</h2><p>The directory to build the server to. It defaults to <code>build</code> — i.e. <code>node build</code> would start the server locally after it has been created.</section><section class="level2"aria-labelledby="precompress"><h2 id="precompress">precompress</h2><p>Enables precompressing using gzip and brotli for assets and prerendered pages. It defaults to <code>true</code>.</section><section class="level2"aria-labelledby="envprefix"><h2 id="envprefix">envPrefix</h2><p>If you need to change the name of the environment variables used to configure the deployment (for example, to deconflict with environment variables you don't control), you can specify a prefix:<pre class="language-js"><code class="language-js"><span class="token literal-property property">envPrefix</span><span class="token operator">:</span> <span class="token string">'MY_CUSTOM_'</span><span class="token punctuation">;</span></code></pre><pre class="language-sh"><code class="language-sh">MY_CUSTOM_HOST=127.0.0.1 \
MY_CUSTOM_PORT=4000 \
MY_CUSTOM_ORIGIN=https://my.site \
node build</code></pre></section><section class="level2"aria-labelledby="graceful-shutdown"><h2 id="graceful-shutdown">Graceful shutdown</h2><p>By default <code>adapter-node</code> gracefully shuts down the HTTP server when a <code>SIGTERM</code> or <code>SIGINT</code> signal is received. It will:<ol><li>reject new requests (<a href="https://nodejs.org/api/http.html#serverclosecallback"><code>server.close</code></a>)<li>wait for requests that have already been made but not received a response yet to finish and close connections once they become idle (<a href="https://nodejs.org/api/http.html#servercloseidleconnections"><code>server.closeIdleConnections</code></a>)<li>and finally, close any remaining connections that are still active after <a href="#environment-variables-shutdown-timeout"><code>SHUTDOWN_TIMEOUT</code></a> seconds. (<a href="https://nodejs.org/api/http.html#servercloseallconnections"><code>server.closeAllConnections</code></a>)</ol><blockquote><p>If you want to customize this behaviour you can use a <a href="#custom-server">custom server</a>.</blockquote><p>You can listen to the <code>sveltekit:shutdown</code> event which is emitted after the HTTP server has closed all connections. Unlike Node's <code>exit</code> event, the <code>sveltekit:shutdown</code> event supports asynchronous operations and is always emitted when all connections are closed even if the server has dangling work such as open database connections.<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2304</span>
process<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'sveltekit:shutdown'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> jobs<span class="token punctuation">.</span><span class="token method function property-access">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The parameter <code>reason</code> has one of the following values:<ul><li><code>SIGINT</code> - shutdown was triggered by a <code>SIGINT</code> signal<li><code>SIGTERM</code> - shutdown was triggered by a <code>SIGTERM</code> signal<li><code>IDLE</code> - shutdown was triggered by <a href="#environment-variables-idle-timeout"><code>IDLE_TIMEOUT</code></a></ul></section><section class="level2"aria-labelledby="socket-activation"><h2 id="socket-activation">Socket activation</h2><p>Most Linux operating systems today use a modern process manager called systemd to start the server and run and manage services. You can configure your server to allocate a socket and start and scale your app on demand. This is called <a href="http://0pointer.de/blog/projects/socket-activated-containers.html">socket activation</a>. In this case, the OS will pass two environment variables to your app — <code>LISTEN_PID</code> and <code>LISTEN_FDS</code>. The adapter will then listen on file descriptor 3 which refers to a systemd socket unit that you will have to create.<blockquote><p>You can still use <a href="#options-envprefix"><code>envPrefix</code></a> with systemd socket activation. <code>LISTEN_PID</code> and <code>LISTEN_FDS</code> are always read without a prefix.</blockquote><p>To take advantage of socket activation follow these steps.<ol><li>Run your app as a <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html">systemd service</a>. It can either run directly on the host system or inside a container (using Docker or a systemd portable service for example). If you additionally pass an <a href="#environment-variables-idle-timeout"><code>IDLE_TIMEOUT</code></a> environment variable to your app it will gracefully shutdown if there are no requests for <code>IDLE_TIMEOUT</code> seconds. systemd will automatically start your app again when new requests are coming in.</ol><pre class="language-ini"><code class="language-ini">/// file: /etc/systemd/system/myapp.service
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Service</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">Environment</span><span class="token punctuation">=</span><span class="token value attr-value">NODE_ENV=production IDLE_TIMEOUT=60</span>
<span class="token key attr-name">ExecStart</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/bin/node /usr/bin/myapp/build</span></code></pre><ol start="2"><li>Create an accompanying <a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.socket.html">socket unit</a>. The adapter only accepts a single socket.</ol><pre class="language-ini"><code class="language-ini">/// file: /etc/systemd/system/myapp.socket
<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Socket</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">ListenStream</span><span class="token punctuation">=</span><span class="token value attr-value">3000</span>

<span class="token section"><span class="token punctuation">[</span><span class="token section-name selector">Install</span><span class="token punctuation">]</span></span>
<span class="token key attr-name">WantedBy</span><span class="token punctuation">=</span><span class="token value attr-value">sockets.target</span></code></pre><ol start="3"><li>Make sure systemd has recognised both units by running <code>sudo systemctl daemon-reload</code>. Then enable the socket on boot and start it immediately using <code>sudo systemctl enable --now myapp.socket</code>. The app will then automatically start once the first request is made to <code>localhost:3000</code>.</ol></section><section class="level2"aria-labelledby="custom-server"><h2 id="custom-server">Custom server</h2><p>The adapter creates two files in your build directory — <code>index.js</code> and <code>handler.js</code>. Running <code>index.js</code> — e.g. <code>node build</code>, if you use the default build directory — will start a server on the configured port.<p>Alternatively, you can import the <code>handler.js</code> file, which exports a handler suitable for use with <a href="https://github.com/expressjs/express">Express</a>, <a href="https://github.com/senchalabs/connect">Connect</a> or <a href="https://github.com/lukeed/polka">Polka</a> (or even just the built-in <a href="https://nodejs.org/dist/latest/docs/api/http.html#httpcreateserveroptions-requestlistener"><code>http.createServer</code></a>) and set up your own server:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307 7006</span>
<span class="token comment">/// file: my-server.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> handler <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./build/handler.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">express</span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a route that lives separately from the SvelteKit app</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/healthcheck'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	res<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// let SvelteKit handle everything else, including serving prerendered pages and static assets</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'listening on port 3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>