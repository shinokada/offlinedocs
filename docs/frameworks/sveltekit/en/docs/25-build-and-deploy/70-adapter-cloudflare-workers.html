<!doctype html><html lang="en"><meta charset="utf-8"><title>Cloudflare Workers</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="cloudflare-workers"><h1 id="cloudflare-workers">Cloudflare Workers</h1><p>To deploy to <a href="https://workers.cloudflare.com/">Cloudflare Workers</a>, use <a href="https://github.com/sveltejs/kit/tree/main/packages/adapter-cloudflare-workers"><code>adapter-cloudflare-workers</code></a>.<blockquote><p>Unless you have a specific reason to use <code>adapter-cloudflare-workers</code>, it's recommended that you use <code>adapter-cloudflare</code> instead. Both adapters have equivalent functionality, but Cloudflare Pages offers features like GitHub integration with automatic builds and deploys, preview deployments, instant rollback and so on.</blockquote><section class="level2"aria-labelledby="usage"><h2 id="usage">Usage</h2><p>Install with <code>npm i -D @sveltejs/adapter-cloudflare-workers</code>, then add the adapter to your <code>svelte.config.js</code>:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2307</span>
<span class="token comment">/// file: svelte.config.js</span>
<span class="token keyword module">import</span> <span class="token imports">adapter</span> <span class="token keyword module">from</span> <span class="token string">'@sveltejs/adapter-cloudflare-workers'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">kit</span><span class="token operator">:</span> <span class="token punctuation">{</span>
		<span class="token literal-property property">adapter</span><span class="token operator">:</span> <span class="token function">adapter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
			<span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token string">'wrangler.toml'</span><span class="token punctuation">,</span>
			<span class="token literal-property property">platformProxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
				<span class="token literal-property property">configPath</span><span class="token operator">:</span> <span class="token string">'wrangler.toml'</span><span class="token punctuation">,</span>
				<span class="token literal-property property">environment</span><span class="token operator">:</span> <span class="token keyword nil">undefined</span><span class="token punctuation">,</span>
				<span class="token literal-property property">experimentalJsonConfig</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
				<span class="token literal-property property">persist</span><span class="token operator">:</span> <span class="token boolean">false</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre></section><section class="level2"aria-labelledby="options"><h2 id="options">Options</h2></section><section class="level2"aria-labelledby="config"><h2 id="config">config</h2><p>Path to your custom <code>wrangler.toml</code> config file.</section><section class="level2"aria-labelledby="platformproxy"><h2 id="platformproxy">platformProxy</h2><p>Preferences for the emulated <code>platform.env</code> local bindings. See the <a href="https://developers.cloudflare.com/workers/wrangler/api/#syntax">getPlatformProxy</a> Wrangler API documentation for a full list of options.</section><section class="level2"aria-labelledby="basic-configuration"><h2 id="basic-configuration">Basic Configuration</h2><p>This adapter expects to find a <a href="https://developers.cloudflare.com/workers/platform/sites/configuration">wrangler.toml</a> file in the project root. It should look something like this:<pre class="language-toml"><code class="language-toml">/// file: wrangler<span class="token punctuation">.</span>toml
<span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"&#x3C;your-service-name>"</span>
<span class="token key property">account_id</span> <span class="token punctuation">=</span> <span class="token string">"&#x3C;your-account-id>"</span>

<span class="token key property">main</span> <span class="token punctuation">=</span> <span class="token string">"./.cloudflare/worker.js"</span>
<span class="token key property">site.bucket</span> <span class="token punctuation">=</span> <span class="token string">"./.cloudflare/public"</span>

<span class="token key property">build.command</span> <span class="token punctuation">=</span> <span class="token string">"npm run build"</span>

<span class="token key property">compatibility_date</span> <span class="token punctuation">=</span> <span class="token string">"2021-11-12"</span>
<span class="token key property">workers_dev</span> <span class="token punctuation">=</span> <span class="token boolean">true</span></code></pre><p><code>&#x3C;your-service-name></code> can be anything. <code>&#x3C;your-account-id></code> can be found by logging into your <a href="https://dash.cloudflare.com">Cloudflare dashboard</a> and grabbing it from the end of the URL:<pre class="language-text"><code class="language-text">https://dash.cloudflare.com/&#x3C;your-account-id></code></pre><blockquote><p>You should add the <code>.cloudflare</code> directory (or whichever directories you specified for <code>main</code> and <code>site.bucket</code>) to your <code>.gitignore</code>.</blockquote><p>You will need to install <a href="https://developers.cloudflare.com/workers/wrangler/get-started/">wrangler</a> and log in, if you haven't already:<pre class="language-text"><code class="language-text">npm i -g wrangler
wrangler login</code></pre><p>Then, you can build your app and deploy it:<pre class="language-sh"><code class="language-sh">wrangler deploy</code></pre></section><section class="level2"aria-labelledby="custom-config"><h2 id="custom-config">Custom config</h2><p>If you would like to use a config file other than <code>wrangler.toml</code> you can specify so using the <a href="#options-config"><code>config</code> option</a>.<p>If you would like to enable <a href="https://developers.cloudflare.com/workers/runtime-apis/nodejs/#enable-nodejs-from-the-cloudflare-dashboard">Node.js compatibility</a>, you can add "nodejs_compat" flag to <code>wrangler.toml</code>:<pre class="language-toml"><code class="language-toml">/// file: wrangler<span class="token punctuation">.</span>toml
<span class="token key property">compatibility_flags</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span> <span class="token string">"nodejs_compat"</span> <span class="token punctuation">]</span></code></pre></section><section class="level2"aria-labelledby="runtime-apis"><h2 id="runtime-apis">Runtime APIs</h2><p>The <a href="https://developers.cloudflare.com/workers/runtime-apis/fetch-event#parameters"><code>env</code></a> object contains your project's <a href="https://developers.cloudflare.com/pages/platform/functions/bindings/">bindings</a>, which consist of KV/DO namespaces, etc. It is passed to SvelteKit via the <code>platform</code> property, along with <a href="https://developers.cloudflare.com/workers/runtime-apis/handlers/fetch/#contextwaituntil"><code>context</code></a>, <a href="https://developers.cloudflare.com/workers/runtime-apis/cache/"><code>caches</code></a>, and <a href="https://developers.cloudflare.com/workers/runtime-apis/request/#the-cf-property-requestinitcfproperties"><code>cf</code></a>, meaning that you can access it in hooks and endpoints:<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 7031</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token constant">POST</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> request<span class="token punctuation">,</span> platform <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> x <span class="token operator">=</span> platform<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">YOUR_DURABLE_OBJECT_NAMESPACE</span><span class="token punctuation">.</span><span class="token method function property-access">idFromName</span><span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>SvelteKit's built-in <code>$env</code> module should be preferred for environment variables.</blockquote><p>To include type declarations for your bindings, reference them in your <code>src/app.d.ts</code>:<pre class="language-diff"><code class="language-diff">/// file: src/app.d.ts
declare global {
	namespace App {
		interface Platform {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">			env?: {
</span><span class="token prefix inserted">+</span><span class="token line">				YOUR_KV_NAMESPACE: KVNamespace;
</span><span class="token prefix inserted">+</span><span class="token line">				YOUR_DURABLE_OBJECT_NAMESPACE: DurableObjectNamespace;
</span><span class="token prefix inserted">+</span><span class="token line">			};
</span></span>		}
	}
}

export {};</code></pre></section><section class="level2"aria-labelledby="testing-locally"><h2 id="testing-locally">Testing Locally</h2><p>Cloudflare Workers specific values in the <code>platform</code> property are emulated during dev and preview modes. Local <a href="https://developers.cloudflare.com/workers/wrangler/configuration/#bindings">bindings</a> are created based on the configuration in your <code>wrangler.toml</code> file and are used to populate <code>platform.env</code> during development and preview. Use the adapter config <a href="#options-platformproxy"><code>platformProxy</code> option</a> to change your preferences for the bindings.<p>For testing the build, you should use <a href="https://developers.cloudflare.com/workers/cli-wrangler">wrangler</a> <strong>version 3</strong>. Once you have built your site, run <code>wrangler dev</code>.</section><section class="level2"aria-labelledby="troubleshooting"><h2 id="troubleshooting">Troubleshooting</h2></section><section class="level2"aria-labelledby="worker-size-limits"><h2 id="worker-size-limits">Worker size limits</h2><p>When deploying to workers, the server generated by SvelteKit is bundled into a single file. Wrangler will fail to publish your worker if it exceeds <a href="https://developers.cloudflare.com/workers/platform/limits/#worker-size">the size limits</a> after minification. You're unlikely to hit this limit usually, but some large libraries can cause this to happen. In that case, you can try to reduce the size of your worker by only importing such libraries on the client side. See <a href="./faq#how-do-i-use-x-with-sveltekit-how-do-i-use-a-client-side-only-library-that-depends-on-document-or-window">the FAQ</a> for more information.</section><section class="level2"aria-labelledby="accessing-the-file-system"><h2 id="accessing-the-file-system">Accessing the file system</h2><p>You can't use <code>fs</code> in Cloudflare Workers — you must <a href="https://kit.svelte.dev../20-core-concepts/40-page-options.html#prerender">prerender</a> the routes in question. <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>