<!doctype html><html lang="en"><meta charset="utf-8"><title>Service workers</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="service-workers"class="level1"><h1>Service workers</h1><p>Service workers act as proxy servers that handle network requests inside your app. This makes it possible to make your app work offline, but even if you don't need offline support (or can't realistically implement it because of the type of app you're building), it's often worth using service workers to speed up navigation by precaching your built JS and CSS.<p>In SvelteKit, if you have a <code>src/service-worker.js</code> file (or <code>src/service-worker.ts</code>, <code>src/service-worker/index.js</code>, etc) it will be bundled and automatically registered. You can change the <a href="configuration#files">location of your service worker</a> if you need to.<p>You can <a href="configuration#serviceworker">disable automatic registration</a> if you need to register the service worker with your own logic or use another solution. The default registration looks something like this:<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> <span class="token dom variable">navigator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">serviceWorker</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token string">'./path/to/service-worker.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><section id="inside-the-service-worker"class="level2"><h2>Inside the service worker</h2><p>Inside the service worker you have access to the <a href="modules#$service-worker"><code>$service-worker</code> module</a>, which provides you with the paths to all static assets, build files and prerendered pages. You're also provided with an app version string which you can use for creating a unique cache name. If your Vite config specifies <code>define</code> (used for global variable replacements), this will be applied to service workers as well as your server/client builds.<p>The following example caches the built app and any files in <code>static</code> eagerly, and caches all other requests as they happen. This would make each page work offline once visited.<pre class="language-js"><code class="language-js"><span class="token comment">// @errors: 2339</span>
<span class="token comment">/// &#x3C;reference types="@sveltejs/kit" /></span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> build<span class="token punctuation">,</span> files<span class="token punctuation">,</span> version <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$service-worker'</span><span class="token punctuation">;</span>

<span class="token comment">// Create a unique cache name for this deployment</span>
<span class="token keyword">const</span> <span class="token constant">CACHE</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cache-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token constant">ASSETS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
	<span class="token spread operator">...</span>build<span class="token punctuation">,</span> <span class="token comment">// the app itself</span>
	<span class="token spread operator">...</span>files  <span class="token comment">// everything in `static`</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token comment">// Create a new cache and add all files to it</span>
	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addFilesToCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token constant">CACHE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword control-flow">await</span> cache<span class="token punctuation">.</span><span class="token method function property-access">addAll</span><span class="token punctuation">(</span><span class="token constant">ASSETS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	event<span class="token punctuation">.</span><span class="token method function property-access">waitUntil</span><span class="token punctuation">(</span><span class="token function">addFilesToCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token comment">// Remove previous cached data from disk</span>
	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token constant">CACHE</span><span class="token punctuation">)</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	event<span class="token punctuation">.</span><span class="token method function property-access">waitUntil</span><span class="token punctuation">(</span><span class="token function">deleteOldCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token comment">// ignore POST requests etc</span>
	<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token property-access">method</span> <span class="token operator">!==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span><span class="token punctuation">;</span>

	<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">const</span> cache <span class="token operator">=</span> <span class="token keyword control-flow">await</span> caches<span class="token punctuation">.</span><span class="token method function property-access">open</span><span class="token punctuation">(</span><span class="token constant">CACHE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// `build`/`files` can always be served from the cache</span>
		<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token constant">ASSETS</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">return</span> cache<span class="token punctuation">.</span><span class="token method function property-access">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// for everything else, try the network first, but</span>
		<span class="token comment">// fall back to the cache if we're offline</span>
		<span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token property-access">status</span> <span class="token operator">===</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				cache<span class="token punctuation">.</span><span class="token method function property-access">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token method function property-access">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword control-flow">return</span> response<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span>
			<span class="token keyword control-flow">return</span> cache<span class="token punctuation">.</span><span class="token method function property-access">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	event<span class="token punctuation">.</span><span class="token method function property-access">respondWith</span><span class="token punctuation">(</span><span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>Be careful when caching! In some cases, stale data might be worse than data that's unavailable while offline. Since browsers will empty caches if they get too full, you should also be careful about caching large assets like video files.</blockquote></section><section id="during-development"class="level2"><h2>During development</h2><p>The service worker is bundled for production, but not during development. For that reason, only browsers that support <a href="https://web.dev/es-modules-in-sw">modules in service workers</a> will be able to use them at dev time. If you are manually registering your service worker, you will need to pass the <code>{ type: 'module' }</code> option in development:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> dev <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'$app/environment'</span><span class="token punctuation">;</span>

<span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">serviceWorker</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token string">'/service-worker.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
	<span class="token literal-property property">type</span><span class="token operator">:</span> dev <span class="token operator">?</span> <span class="token string">'module'</span> <span class="token operator">:</span> <span class="token string">'classic'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p><code>build</code> and <code>prerendered</code> are empty arrays during development</blockquote></section><section id="type-safety"class="level2"><h2>Type safety</h2><p>Setting up proper types for service workers requires some manual setup. Inside your <code>service-worker.js</code>, add the following to the top of your file:<pre class="language-original-js"><code class="language-original-js">/// &#x3C;reference types="@sveltejs/kit" />
/// &#x3C;reference no-default-lib="true"/>
/// &#x3C;reference lib="esnext" />
/// &#x3C;reference lib="webworker" />

const sw = /** @type {ServiceWorkerGlobalScope} */ (/** @type {unknown} */ (self));</code></pre><pre class="language-generated-ts"><code class="language-generated-ts">/// &#x3C;reference types="@sveltejs/kit" />
/// &#x3C;reference no-default-lib="true"/>
/// &#x3C;reference lib="esnext" />
/// &#x3C;reference lib="webworker" />

const sw = self as unknown as ServiceWorkerGlobalScope;</code></pre><p>This disables access to DOM typings like <code>HTMLElement</code> which are not available inside a service worker and instantiates the correct globals. The reassignment of <code>self</code> to <code>sw</code> allows you to type cast it in the process (there are a couple of ways to do this, but the easiest that requires no additional files). Use <code>sw</code> instead of <code>self</code> in the rest of the file. The reference to the SvelteKit types ensures that the <code>$service-worker</code> import has proper type definitions.</section><section id="other-solutions"class="level2"><h2>Other solutions</h2><p>SvelteKit's service worker implementation is deliberately low-level. If you need a more full-flegded but also more opinionated solution, we recommend looking at solutions like <a href="https://vite-pwa-org.netlify.app/frameworks/sveltekit.html">Vite PWA plugin</a>, which uses <a href="https://web.dev/learn/pwa/workbox">Workbox</a>. For more general information on service workers, we recommend <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API/Using_Service_Workers">the MDN web docs</a>. <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section>