<!doctypehtml><html lang="he"><meta charset="utf-8"><title>גבולות שגיאה</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css"><section id="גבולות-שגיאה"class="level1"><h1>גבולות שגיאה</h1><p>בעבר, שגיאות בתוך קומפוננטות ב-JavaScript הובילו להשחתת המצב הפנימי של React וגרמו ל<a href="https://github.com/facebook/react/issues/4026">פליטת</a> <a href="https://github.com/facebook/react/issues/6895">שגיאות</a> <a href="https://github.com/facebook/react/issues/8579">אניגמטיות</a> ברינדור המסך הבא. מקור הבעיה תמיד נבע משגיאות קודמות בקוד האפליקציה, אבל React לא סיפק דרך לטפל בהם בחן בתוך הקומפוננטות, ולא מצא דרך להתאושש מהם.<section id="introducing-error-boundaries"class="level2"><h2>גבולות השגיאה</h2><p>שגיאת JavaScript בחלק מממשק המשתמש לא אמורה לשבור את כל האפליקציה. כדי לפתור את הבעיה למשתמשי React, גרסה 16 מציגה קונספט חדש של ״גבולות שגיאה״.<p>גבולות שגיאה הם בעצם קומפוננטות ש<strong>תופסות שגיאות JavaScript שקורות בכל אחד מקומפוננטות הילד שלהן, מתעדות אותן ומציגות ממשק חלופי.</strong> במקום להציג את הקומפוננטה השבורה. הן תופסות שגיאות בזמן רינדור, במתודות מחזור חיים ובבנאי הקומפוננטות עבור כל אחת מקומפוננטות הילד שלהן.<blockquote><p>הערה<p>גבולות שגיאה <strong>לא</strong> תופסים שגיאות ב:<ul><li>מטפלי אירועים (<a href="#how-about-event-handlers">מידע נוסף</a>)<li>קוד אסינכרוני (לדוגמא <code>setTimeout</code> או <code>requestAnimationFrame</code>)<li>רינדור בצד השרת<li>שגיאות שקורות בגבול השגיאה עצמו</ul></blockquote><p>קומפוננטת מחלקה הופכת לגבול שגיאה אם היא מגדירה לפחות אחת ממתודות מחזור החיים <a href="./react-component.html#static-getderivedstatefromerror"><code>static getDerivedStateFromError()</code></a> או <a href="./react-component.html#componentdidcatch"><code>componentDidCatch()</code></a>. המתודה <code>static getDerivedStateFromError()</code> משמשת לרנדור ממשק חלופי לאחר שגיאה שנתפסה, ו- <code>componentDidCatch()</code> עוזרת בתיעוד השגיאה.<pre class="language-js{7-10,12-15,18-21}"><code class="language-js{7-10,12-15,18-21}">class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error) {
    // כדי שהרינדור הבא יציג ממשק חלופי state מעדכנת את ה
    return { hasError: true };
  }

  componentDidCatch(error, errorInfo) {
    // אפשר גם לתעד את השגיאה לשירות לוגר
    logErrorToMyService(error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      // מגדירים ממשק חלופי מותאם
      return &#x3C;h1>Something went wrong.&#x3C;/h1>;
    }

    return this.props.children; 
  }
}</code></pre><p>השימוש בגבולות שגיאה זהה לשימוש בכל קומפוננטה רגילה:<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ErrorBoundary</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MyWidget</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ErrorBoundary</span><span class="token operator">></span></code></pre><p>גבולות שגיאה עובדים בצורה דומה לבלוק <code>catch {}</code> ב-JavaScript, אבל בתוך הקומפוננטה. רק קומפוננטות מחלקה יכולות להיות גבולות שגיאה. בפועל, מגדירים בדרך כלל גבול שגיאה אחד ונשתמש בו בצורה אחידה בכל האפליקציה.<p>שימו לב ש<strong>גבולות שגיאה תופסים אך ורק שגיאות בקומפוננטות הילד שלהם</strong>, ולא בתוך עצמם. אם מתרחשת שגיאה בקוד ה- <code>render</code> של גבולות השגיאה לדוגמא, השגיאות תעלה לגבול שגיאה הבא מעליה, בדומה להתנהגות של בלוק ה- <code>catch {}</code> ב-JavaScript.</section><section id="live-demo"class="level2"><h2>הדגמה חיה</h2><p>שימו לב ל<a href="https://codepen.io/gaearon/pen/wqvxGa?editors=0010">דוגמא הבאה של הגדרה ושימוש בגבולות שגיאה</a> עם <a href="/blog/2017/09/26/react-v16.0.html">גרסה 16 של React</a>.</section><section id="where-to-place-error-boundaries"class="level2"><h2>איפה למקם את גבולות שגיאה</h2><p>רמת הפירוט של הגדרת גבולות שגיאה היא לשיקולכם. תוכלו לעטוף קומפוננטות route ברמה העליונה על מנת להציג הודעת ”משהו השתבש“ למשתמש, כמו הצורה שבה מערכות צד-שרת מטפלות בקריסות לעתים קרובות. תוכלו גם לעטוף ווידג'טים אינדיבידואליים בגבולות שגיאה כדי להגן עליהם מהקרסת שאר האפליקציה.</section><section id="new-behavior-for-uncaught-errors"class="level2"><h2>התנהגות חדשה לשגיאות שלא נתפסו</h2><p>גרסה 16 של React מציגה שינוי בהתנהגות עם השלכות חשובות. <strong>שגיאות של נתפסות על ידי גבולות שגיאה יביאו לפירוק מוחלט של עץ הקומפוננטות הראשי</strong>.<p>דנו בהחלטה זו לא מעט, אבל מנסיונינו תמיד כדאי שלא להשתמש בממשק מושחת, אלא להפטר ממנו לגמרי. לדוגמא, באפליקציה כמו מסנג׳ר, להשאיר ממשק שבור בצורה גלויה לעין יכול להוביל לשליחת הודעה לאדם הלא נכון. באותה מידה, באפליקציה שמנהלת כספים עדיף לא להציג כלום מאשר להציג סכום שגוי.<p>השינוי הזה אומר שכשמשדרגים לגרסה 16, בדרך כלל מגלים שגיאות באפליקציה שעד אז לא שמנו לב אליהן. הוספת גבולות שגיאה מאפשר לנו לספק חווית משתמש טובה יותר בכל מצב.<p>לדוגמא, המסנג׳ר של Facebook עוטף תוכן מהסרגל הצידי, חלונית המידע, חלונית השיחה ושדה הקלט של ההודעה בגבולות שגיאה נפרדים. במקרה ואחד מהם קורס, האחרים נשארים זמינים ואינטרקטיביים.<p>אנחנו ממליצים גם להשתמש בשירותי דיווח השגיאות של JavaScript (או לבנות שירותים דומים בעצמכם), על מנת למצוא בעיות בסביבת הייצור ולתקן אותן בקלות ובמהירות.</section><section id="component-stack-traces"class="level2"><h2>stack trace לקומפוננטות</h2><p>בגרסה 16 של React כל השגיאות שקורות בזמן הרינדור בסביבת הפיתוח מודפסות למסוף בדפדפן, אפילו אם האפליקציה בולעת אותם בטעות. בנוסף להודעת השגיאה וה-stack trace של JavaScript, מודפס גם ה-stack trace של הקומפוננטה. עכשיו אפשר לראות בדיוק איפה בקומפוננטה קרתה השגיאה:</p><img src="./docs/error-boundaries-stack-trace.png"style="max-width:100%"alt="שיגאה שנתפסה על ידי גבולות שגיאה"><p>אפשר גם לראות את שם הקובץ ומספר השורה בקוד הקומפוננטה בעזרת ה-stack trace. זה עובד בברירת המחדל בפרויקטים שנוצרו עם <a href="https://github.com/facebookincubator/create-react-app">אפליקצית Create React</a>:</p><img src="./docs/error-boundaries-stack-trace-line-numbers.png"style="max-width:100%"alt="שגיאה שנתפסה על ידי גבולות שגיאה עם מספר שורה"><p>אם לא יצרתם את הפרויקט עם אפליקצית Create React, תוכלו להשתמש <a href="https://www.npmjs.com/package/@babel/plugin-transform-react-jsx-source">בתוסף הזה</a> - הוסיפו אותו לתצורת ה-Babel בפרויקט. שימו לב שהוא מיועד רק לשימוש בסביבת הפיתוח ו<strong>חובה לנטרל אותו בסביבת הייצור</strong>.<blockquote><p>הערה<p>שמות הקומפוננטות שמוצגים במעקב הערימות תלוי בשם שהוגדר במאפיין <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/name"><code>Function.name</code></a>. אם אתם צריכים לתמוך בדפדפנים או מכשירים ישנים יותר שלא תומכים בזה באופן סטנדרטי (כמו IE 11 למשל), תוכלו להוסיף את המאפיין כ- polyfill שיוכלל ב-bundle האפליקציה, כמו <a href="https://github.com/JamesMGreene/Function.name"><code>function.name-polyfill</code></a>. דרך נוספת היא לספק באופן ישיר את המאפיין <a href="./react-component.html#displayname"><code>displayName</code></a> בכל קומפוננטה.</blockquote></section><section id="how-about-trycatch"class="level2"><h2>מה עם בלוק try/catch?</h2><p>בלוק <code>try/catch</code> זה מצוין אבל עובד רק בקוד אימפרטיבי (קוד שמשנה את מצב האפליקציה):<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
  <span class="token function">showButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>לעומת זאת, קומפוננטות React הן דקלרטיביות ורק מציינות <em>מה</em> צריך לרנדר באפליקציה:<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Button</span> <span class="token operator">/</span><span class="token operator">></span></code></pre><p>גבולות שגיאה משמרים את האופן הדקלרטיבי של React ומספקים התנהגות דומה. לדוגמא, אפילו אם שגיאה צצה במתודת ה-<code>componentDidUpdate</code> שנגרמה איפשהו עמוק בתוך העץ בתוך <code>setState</code>, היא תוצף לגבול השגיאה הקרוב ביותר.</section><section id="how-about-event-handlers"class="level2"><h2>מה עם מטפלי אירועים?</h2><p>גבולות שגיאה <strong>לא</strong> תופסים שגיאות מתוך מטפלי אירועים.<p>React לא צריך גבולות שגיאה כדי להתאושש משגיאות במטפלי אירועים. בשונה מהמתודת הרינדור ומתודות מחזור החיים, שגיאות שצצות במטפלי האירועים לא קורות בזמן הרינדור. אז אם צצה שגיאה, React עדיין ידע מה להציג.<p>כשיש צורך לתפוס שגיאה במטפל אירוע, השתמשו בביטוי ה-<code>try</code> / <code>catch</code> הרגיל של JavaScript:<pre class="language-js{9-13,17-20}"><code class="language-js{9-13,17-20}">class MyComponent extends React.Component {
  constructor(props) {
    super(props);
    this.state = { error: null };
    this.handleClick = this.handleClick.bind(this);
  }

  handleClick() {
    try {
      // קוד שזורק שגיאה
    } catch (error) {
      this.setState({ error });
    }
  }

  render() {
    if (this.state.error) {
      return &#x3C;h1>Caught an error.&#x3C;/h1>
    }
    return &#x3C;button onClick={this.handleClick}>Click Me&#x3C;/button>
  }
}</code></pre><p>שימו לב שהדוגמא הנ״ל מדגימה קוד JavaScript סטנדרטי לטיפול בשגיאות ולא קשורה בשום אופן לגבולות שגיאות.</section><section id="naming-changes-from-react-15"class="level2"><h2>שינוי שם מגרסה 15</h2><p>גרסה 15 של React כללה תמיכה מוגבלת ביותר לגבולות שגיאות תחת מתודה בשם אחר: <code>unstable_handleError</code>. המתודה הזאת כבר לא נתמכת, ותאלצו לשנות אותה ל- <code>componentDidCatch</code> בקוד שלכם החל מגרסת הביתא הראשונה של React 16.<p>בשביל השינוי הזה, כללנו <a href="https://github.com/reactjs/react-codemod#error-boundaries">משנה קוד (codemod)</a> כדי לעדכן באופן אוטומטי את הקוד הרלוונטי. <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>