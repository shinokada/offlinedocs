<!doctype html><html lang="zh-hant"><meta charset="utf-8"><title>Render 和 Commit</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="render-和-commit"><h1 id="render-和-commit">Render 和 Commit</h1><intro><p>在你的 component 顯示在畫面上之前，必須被 React render。了解這個過程中的步驟將有助於你思考你的程式碼是如何執行的，並能解釋其行為。</p></intro><youwilllearn><ul><li>在 React 中 rendering 所代表的意思<li>React render component 的時機及原因<li>顯示 component 在畫面上所涉及的步驟<li>為什麼 rendering 不一定會導致 DOM 更新</ul></youwilllearn><p>想像一下，你的 component 就像廚房中的廚師，從食材中組合出美味的菜餚。在這種情況下，React 就像是服務生，接收來自顧客的訂單，並將菜餚送到他們的桌上。這個請求和提供 UI 的過程包含三個步驟：<ol><li><strong>觸發</strong> render (將客人的訂單發送到廚房)<li><strong>Rendering</strong> component (在廚房裡準備菜餚)<li><strong>Commit</strong> 到 DOM (將菜餚送上桌)</ol><illustrationblock sequential=""><illustration caption="Trigger"alt="React as a server in a restaurant, fetching orders from the users and delivering them to the Component Kitchen."src.=""docs=""illustrations=""i_render-and-commit1.png&#x22;=""><illustration caption="Render"alt="The Card Chef gives React a fresh Card component."src.=""docs=""illustrations=""i_render-and-commit2.png&#x22;=""><illustration caption="Commit"alt="React delivers the Card to the user at their table."src.=""docs=""illustrations=""i_render-and-commit3.png&#x22;=""></illustration></illustration></illustration></illustrationblock><section class="level2"aria-labelledby="步驟-1觸發-render-step-1-trigger-a-render"><h2 id="步驟-1觸發-render-step-1-trigger-a-render">步驟 1：觸發 render {/<em>step-1-trigger-a-render</em>/}</h2><p>有兩個原因會使 component 進行 render：<ol><li>這是 component 的初始 render。<li>component（或是他的祖父層之一）的<strong>狀態發生改變。</strong></ol><section class="level3"aria-labelledby="初始-render-initial-render"><h3 id="初始-render-initial-render">初始 render {/<em>initial-render</em>/}</h3><p>當你的應用程式啟動時，會觸發初始 render。有些框架和開發環境可能會隱藏這部分的程式碼，但實際上它是透過使用 <a href="/reference/react-dom/client/createRoot"><code>createRoot</code></a> 的方法來指定目標 DOM 節點，然後再呼叫 <code>render</code> 函式 render component：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Image</span></span> <span class="token keyword module">from</span> <span class="token string">'./Image.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Image</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>img
      src<span class="token operator">=</span><span class="token string">"https://i.imgur.com/ZF6s192.jpg"</span>
      alt<span class="token operator">=</span><span class="token string">"'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"</span>
    <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>請試著將 <code>root.render()</code> 這行程式碼註解掉，然後就會發現 component 消失了！</section><section class="level3"aria-labelledby="當狀態更新時重新-render-re-renders-when-state-updates"><h3 id="當狀態更新時重新-render-re-renders-when-state-updates">當狀態更新時重新 render {/<em>re-renders-when-state-updates</em>/}</h3><p>一但 component 被初始 render，你可以透過使用 <a href="/reference/react/useState#setstate"><code>set</code> 函式</a> 更新其狀態來觸發之後的 render。更新 component 的狀態會自動加入重新 render 的 queue。(你可以將這個過程想像成一位餐廳顧客點完第一道菜後，根據他的口渴或飢餓程度，又繼續點了茶、點心或其他各種菜色的流程。)</p><illustrationblock sequential=""><illustration caption="State update..."alt="React as a server in a restaurant, serving a Card UI to the user, represented as a patron with a cursor for their head. They patron expresses they want a pink card, not a black one!"src.=""docs=""illustrations=""i_rerender1.png&#x22;=""><illustration caption="...triggers..."alt="React returns to the Component Kitchen and tells the Card Chef they need a pink Card."src.=""docs=""illustrations=""i_rerender2.png&#x22;=""><illustration caption="...render!"alt="The Card Chef gives React the pink Card."src.=""docs=""illustrations=""i_rerender3.png&#x22;=""></illustration></illustration></illustration></illustrationblock></section></section><section class="level2"aria-labelledby="步驟-2react-render-你的-component-step-2-react-renders-your-components"><h2 id="步驟-2react-render-你的-component-step-2-react-renders-your-components">步驟 2：React render 你的 component {/<em>step-2-react-renders-your-components</em>/}</h2><p>在觸發 render 之後，React 將呼叫你的 component 以確定什麼該顯示在螢幕畫面上。<strong>「Rendering」 指的是 React 正在呼叫你的 component.</strong><ul><li><strong>當初始 render 時，</strong> React 會呼叫 root component.<li><strong>對於後續的 render，</strong> React 會呼叫因狀態更新而觸發 render 的 function component。</ul><p>這段過程是遞迴的：如果更新的 component 回傳其他的 component，React 將會 render <em>那個</em> component，如果 component 又回傳其他的 component，React 會接著 render <em>下一個</em> component，以此類推。這個過程將一直持續到沒有回傳更多的 component，React 才知道應該在螢幕上顯示什麼。<p>在接下來的範例，React 將會呼叫 <code>Gallery()</code> 和 <code>Image()</code> 幾次</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Gallery</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>section<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token maybe-class-name">Inspiring</span> <span class="token maybe-class-name">Sculptures</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>section<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Image</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>img
      src<span class="token operator">=</span><span class="token string">"https://i.imgur.com/ZF6s192.jpg"</span>
      alt<span class="token operator">=</span><span class="token string">"'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"</span>
    <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Gallery</span></span> <span class="token keyword module">from</span> <span class="token string">'./Gallery.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Gallery</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">img</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><ul><li><strong>當初始 render 時，</strong> React 會為 <code>&#x3C;section></code>、<code>&#x3C;h1></code> 和三個 <code>&#x3C;img></code> 標籤<a href="https://developer.mozilla.org/docs/Web/API/Document/createElement">建立 DOM 節點</a><li><strong>當重新 render 時，</strong> React 會計算他們的屬性（如果有的話），是否與上一次 render 時有所不同。在下一個步驟 - commit 階段之前，它不會進行任何動作。</ul><pitfall><p>Rendering 必須永遠是一個<a href="/learn/keeping-components-pure">純運算</a><ul><li><strong>相同的輸入，會得到相同的輸出。</strong> 當輸入相同的值時，component 應該永遠回傳相同的 JSX。(當有人點了一份番茄沙拉時，他們不應該拿到一份洋蔥沙拉！)<li><strong>它只做自己的事情。</strong> 在 rendering 之前，不應該改變任何先前已存在的任何物件或變數。（一份訂單不應該改變其他任何人的訂單。）</ul><p>否則，你的程式碼會變得越來越複雜，可能會遇到令人困惑的錯誤和不可預測的行為。在「嚴格模式」下開發時，React 將呼叫每個 component 函式兩次，這可以幫助你發現由不純函數引發的錯誤。</p></pitfall><deepdive><section class="level4"aria-labelledby="效能最佳化-optimizing-performance"><h4 id="效能最佳化-optimizing-performance">效能最佳化 {/<em>optimizing-performance</em>/}</h4><p>如果要更新的 component 在 tree 的非常頂部，預設情況下對擁有巢狀子元件的 component 更新元件時，每個子元件都將被重新 render，這不會獲得最佳的效能。如果遇到效能問題，可以在<a href="https://reactjs.org/docs/optimizing-performance.html">效能</a>中找到幾個解決方法。<strong>但不要太早進行最佳化！</strong></section></deepdive></section><section class="level2"aria-labelledby="步驟-3react-把更改-commit-到-dom-step-3-react-commits-changes-to-the-dom"><h2 id="步驟-3react-把更改-commit-到-dom-step-3-react-commits-changes-to-the-dom">步驟 3：React 把更改 commit 到 DOM {/<em>step-3-react-commits-changes-to-the-dom</em>/}</h2><p>在 rendering（呼叫）你的 component 後，React 將會更改你的 DOM。<ul><li><strong>對於初始 render，</strong> React 會使用 <a href="https://developer.mozilla.org/docs/Web/API/Node/appendChild"><code>appendChild()</code></a> DOM API 在螢幕上顯示所有你建立的 DOM 節點。<li><strong>對於重新 render，</strong> React 會採取最小必要的操作 (在 rendering 時計算！)，以使得 DOM 與 rendering 後的的輸出相符。</ul><p><strong>React 只有在 render 時有差異才會更改 DOM 節點。</strong> 例如，這裡有一個 component，每秒從其 parent 傳遞不同的 props 重新 render。請注意，你可以在 <code>&#x3C;input></code> 中輸入一些文字，更新它的 <code>value</code>，但是這些文字不會在 conponent 重新 render 時消失。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Clock</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> time <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>time<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Clock</span></span> <span class="token keyword module">from</span> <span class="token string">'./Clock.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> setTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">useTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Clock</span> time<span class="token operator">=</span><span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>這個範例之所以能夠運作，是因為在最後一步中，React 只會依據新的 <code>time</code> 去更新 <code>&#x3C;h1></code> 的內容。React 發現這個 <code>&#x3C;input></code> 在 JSX 中出現的位置與上一次相同，因此不會修改 <code>&#x3C;input></code> 或其 <code>value</code> 值。 ## 結語：瀏覽器繪製 {/<em>epilogue-browser-paint</em>/}<p>在 rendering 完成並且在 React 更新 DOM 後，瀏覽器將會重新繪製螢幕畫面。儘管這個過程被稱為「瀏覽器 rendering」，我們更傾向於將它稱為「繪製」，以避免混淆。<p>&#x3C;Illustration alt="A browser painting 'still life with card element'." src./docs/illustrations/i_browser-paint.png" /></p><recap><ul><li>在 React 應用程式中，任何螢幕畫面更新都會發生三個步驟：<ol><li>觸發<li>Render<li>Commit</ol><li>你可以使用嚴格模式去找到 component 中的錯誤<li>如果 rendering 後的結果與上次相同，React 將不會更改 DOM。</ul></recap><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>