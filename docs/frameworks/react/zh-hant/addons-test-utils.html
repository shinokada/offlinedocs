<!doctype html>
<html lang="zh-hant">
  <head>
    <meta charset="utf-8">
    <title>Test Utilities</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css">
  </head>
  <body>
    <section id="test-utilities" class="level1">
      <h1>Test Utilities</h1>
      <p><strong>如何 Import</strong></p>
      <pre class="language-javascript"><code class="language-javascript"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">ReactTestUtils</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/test-utils'</span><span class="token punctuation">;</span> <span class="token comment">// ES6</span>
<span class="token keyword">var</span> <span class="token maybe-class-name">ReactTestUtils</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react-dom/test-utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ES5 with npm</span></code></pre>
      <section id="overview" class="level2">
        <h2>概觀</h2>
        <p><code>ReactTestUtils</code> 使你可以輕鬆在你選擇的測試框架中測試 React component。在 Facebook，我們使用 <a href="https://facebook.github.io/jest/">Jest</a> 以方便地進行 JavaScript 測試。你可以從 Jest 網站的 <a href="https://jestjs.io/docs/tutorial-react">React 教學</a>學習如何使用 Jest。</p>
        <blockquote>
          <p>注意：</p>
        </blockquote>
        <blockquote>
          <p>我們推薦使用 <a href="https://testing-library.com/react">React Testing Library</a>，它促使你寫出的測試能像使用者一樣地使用 component。</p>
          <p>對於 React &#x3C;= 16 的版本，<a href="https://airbnb.io/enzyme/">Enzyme</a> 的測試工具，讓你能輕易 assert、操作及遍歷 React component 的輸出。</p>
        </blockquote>
        <ul>
          <li><a href="#act"><code>act()</code></a></li>
          <li><a href="#mockcomponent"><code>mockComponent()</code></a></li>
          <li><a href="#iselement"><code>isElement()</code></a></li>
          <li><a href="#iselementoftype"><code>isElementOfType()</code></a></li>
          <li><a href="#isdomcomponent"><code>isDOMComponent()</code></a></li>
          <li><a href="#iscompositecomponent"><code>isCompositeComponent()</code></a></li>
          <li><a href="#iscompositecomponentwithtype"><code>isCompositeComponentWithType()</code></a></li>
          <li><a href="#findallinrenderedtree"><code>findAllInRenderedTree()</code></a></li>
          <li><a href="#scryrendereddomcomponentswithclass"><code>scryRenderedDOMComponentsWithClass()</code></a></li>
          <li><a href="#findrendereddomcomponentwithclass"><code>findRenderedDOMComponentWithClass()</code></a></li>
          <li><a href="#scryrendereddomcomponentswithtag"><code>scryRenderedDOMComponentsWithTag()</code></a></li>
          <li><a href="#findrendereddomcomponentwithtag"><code>findRenderedDOMComponentWithTag()</code></a></li>
          <li><a href="#scryrenderedcomponentswithtype"><code>scryRenderedComponentsWithType()</code></a></li>
          <li><a href="#findrenderedcomponentwithtype"><code>findRenderedComponentWithType()</code></a></li>
          <li><a href="#renderintodocument"><code>renderIntoDocument()</code></a></li>
          <li><a href="#simulate"><code>Simulate</code></a></li>
        </ul>
      </section>
      <section id="reference" class="level2">
        <h2>參考資料</h2>
        <section id="act-act" class="level3">
          <h3><code>act()</code> {#act}</h3>
          <p>為了準備讓 component 進行 assert，將 render component 及執行更新的程式碼放在 <code>act()</code> 中。這讓你的測試更貼近 React 在瀏覽器中的運作方式。</p>
          <blockquote>
            <p>注意</p>
            <p>如果你使用 <code>react-test-renderer</code>，它也提供行為相同的 <code>act</code> function。</p>
          </blockquote>
          <p>舉例來說，假設我們有個 <code>Counter</code> component：</p>
          <pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You clicked </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> times</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">You</span> clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span> times<span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token maybe-class-name">Click</span> me
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
          <p>我們可以這樣測試：</p>
          <pre class="language-js{3,20-22,29-31}"><code class="language-js{3,20-22,29-31}">import React from 'react';
import ReactDOM from 'react-dom/client';
import { act } from 'react-dom/test-utils';
import Counter from './Counter';

let container;

beforeEach(() => {
  container = document.createElement('div');
  document.body.appendChild(container);
});

afterEach(() => {
  document.body.removeChild(container);
  container = null;
});

it('can render and update a counter', () => {
  // Test first render and componentDidMount
  act(() => {
    ReactDOM.createRoot(container).render(&#x3C;Counter />);
  });
  const button = container.querySelector('button');
  const label = container.querySelector('p');
  expect(label.textContent).toBe('You clicked 0 times');
  expect(document.title).toBe('You clicked 0 times');

  // Test second render and componentDidUpdate
  act(() => {
    button.dispatchEvent(new MouseEvent('click', {bubbles: true}));
  });
  expect(label.textContent).toBe('You clicked 1 times');
  expect(document.title).toBe('You clicked 1 times');
});</code></pre>
          <ul>
            <li>
              <p>不要忘記，只有在 DOM container 已加到 <code>document</code> 裡面時，才可以 dispatch DOM event。你可以使用如 <a href="https://github.com/kentcdodds/react-testing-library"><code>react-testing-library</code></a> 的 helper 來減少 boilerplate 程式碼。</p>
            </li>
            <li>
              <p><a href="./testing-recipes.html"><code>recipes</code></a> 說明文件內包含了 <code>act()</code> 的詳細資訊，包含範例以及用法。</p>
            </li>
          </ul>
          <hr>
        </section>
        <section id="mockcomponent-mockcomponent" class="level3">
          <h3><code>mockComponent()</code> {#mockcomponent}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">mockComponent</span><span class="token punctuation">(</span>
  componentClass<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>mockTagName<span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
          <p>傳遞一個被 mock 的 component module 到這個方法後，它會增加有用的方法，讓它能做為虛擬的 React component。component 不會像平常一樣 render，它會變成一個簡單的 <code>&#x3C;div></code>（或其他標籤，如果有提供 <code>mockTagName</code>），包含任何提供的 children。</p>
          <blockquote>
            <p>注意：</p>
            <p><code>mockComponent()</code> 是 legacy API。我們建議以 <a href="https://jestjs.io/docs/tutorial-react-native#mock-native-modules-using-jestmock"><code>jest.mock()</code></a> 作為替代。</p>
          </blockquote>
          <hr>
        </section>
        <section id="iselement-iselement" class="level3">
          <h3><code>isElement()</code> {#iselement}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">isElement</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span></code></pre>
          <p>如果 <code>element</code> 是 React element 的話就回傳 <code>true</code>。</p>
          <hr>
        </section>
        <section id="iselementoftype-iselementoftype" class="level3">
          <h3><code>isElementOfType()</code> {#iselementoftype}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">isElementOfType</span><span class="token punctuation">(</span>
  element<span class="token punctuation">,</span>
  componentClass
<span class="token punctuation">)</span></code></pre>
          <p>如果 <code>element</code> 是 type 為 <code>componentClass</code> 的 React element 就回傳 <code>true</code>。</p>
          <hr>
        </section>
        <section id="isdomcomponent-isdomcomponent" class="level3">
          <h3><code>isDOMComponent()</code> {#isdomcomponent}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">isDOMComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span></code></pre>
          <p>如果 <code>instance</code> 是 DOM component（如 <code>&#x3C;div></code> 或 <code>&#x3C;span></code>）就回傳 <code>true</code>。</p>
          <hr>
        </section>
        <section id="iscompositecomponent-iscompositecomponent" class="level3">
          <h3><code>isCompositeComponent()</code> {#iscompositecomponent}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">isCompositeComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span></code></pre>
          <p>如果 <code>instance</code> 是使用者定義的 component，例如 class 或 function，就回傳 <code>true</code>。</p>
          <hr>
        </section>
        <section id="iscompositecomponentwithtype-iscompositecomponentwithtype" class="level3">
          <h3><code>isCompositeComponentWithType()</code> {#iscompositecomponentwithtype}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">isCompositeComponentWithType</span><span class="token punctuation">(</span>
  instance<span class="token punctuation">,</span>
  componentClass
<span class="token punctuation">)</span></code></pre>
          <p>如果 <code>instance</code> 是 type 為 <code>componentClass</code> 的 component 就回傳 <code>true</code>。</p>
          <hr>
        </section>
        <section id="findallinrenderedtree-findallinrenderedtree" class="level3">
          <h3><code>findAllInRenderedTree()</code> {#findallinrenderedtree}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">findAllInRenderedTree</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  test
<span class="token punctuation">)</span></code></pre>
          <p>遍歷 <code>tree</code> 中的所有 component，並收集 <code>test(component)</code> 為 <code>true</code> 的所有 component。這個方法本身不是那麼好用，但是它被其他測試工具做為基礎使用。</p>
          <hr>
        </section>
        <section id="scryrendereddomcomponentswithclass-scryrendereddomcomponentswithclass" class="level3">
          <h3><code>scryRenderedDOMComponentsWithClass()</code> {#scryrendereddomcomponentswithclass}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">scryRenderedDOMComponentsWithClass</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  className
<span class="token punctuation">)</span></code></pre>
          <p>在已經被 render 的 tree 中尋找所有 DOM element，回傳 class 名稱符合 <code>className</code> 的 DOM component。</p>
          <hr>
        </section>
        <section id="findrendereddomcomponentwithclass-findrendereddomcomponentwithclass" class="level3">
          <h3><code>findRenderedDOMComponentWithClass()</code> {#findrendereddomcomponentwithclass}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">findRenderedDOMComponentWithClass</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  className
<span class="token punctuation">)</span></code></pre>
          <p>與 <a href="#scryrendereddomcomponentswithclass"><code>scryRenderedDOMComponentsWithClass()</code></a> 相似，不過預期只有一個結果。如果符合預期則回傳那個結果，否則拋出例外。</p>
          <hr>
        </section>
        <section id="scryrendereddomcomponentswithtag-scryrendereddomcomponentswithtag" class="level3">
          <h3><code>scryRenderedDOMComponentsWithTag()</code> {#scryrendereddomcomponentswithtag}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">scryRenderedDOMComponentsWithTag</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  tagName
<span class="token punctuation">)</span></code></pre>
          <p>在已經被 render 的 tree 中尋找所有 DOM element，回傳 tag 名稱符合 <code>tagName</code> 的 DOM component。</p>
          <hr>
        </section>
        <section id="findrendereddomcomponentwithtag-findrendereddomcomponentwithtag" class="level3">
          <h3><code>findRenderedDOMComponentWithTag()</code> {#findrendereddomcomponentwithtag}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">findRenderedDOMComponentWithTag</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  tagName
<span class="token punctuation">)</span></code></pre>
          <p>與 <a href="#scryrendereddomcomponentswithtag"><code>scryRenderedDOMComponentsWithTag()</code></a> 相似，不過預期只有一個結果。如果符合預期則回傳那個結果，否則拋出例外。</p>
          <hr>
        </section>
        <section id="scryrenderedcomponentswithtype-scryrenderedcomponentswithtype" class="level3">
          <h3><code>scryRenderedComponentsWithType()</code> {#scryrenderedcomponentswithtype}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">scryRenderedComponentsWithType</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  componentClass
<span class="token punctuation">)</span></code></pre>
          <p>尋找所有 component type 與 <code>componentClass</code> 相同的 instance。</p>
          <hr>
        </section>
        <section id="findrenderedcomponentwithtype-findrenderedcomponentwithtype" class="level3">
          <h3><code>findRenderedComponentWithType()</code> {#findrenderedcomponentwithtype}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">findRenderedComponentWithType</span><span class="token punctuation">(</span>
  tree<span class="token punctuation">,</span>
  componentClass
<span class="token punctuation">)</span></code></pre>
          <p>與 <a href="#scryrenderedcomponentswithtype"><code>scryRenderedComponentsWithType()</code></a> 相似，不過預期只有一個結果。如果符合預期則回傳那個結果，否則拋出例外。</p>
          <hr>
        </section>
        <section id="renderintodocument-renderintodocument" class="level3">
          <h3><code>renderIntoDocument()</code> {#renderintodocument}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token function">renderIntoDocument</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span></code></pre>
          <p>Render React element 到 document 中獨立的 DOM node 裡。<strong>這個 function 需要 DOM。</strong>它等效於：</p>
          <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> domContainer <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">createRoot</span><span class="token punctuation">(</span>domContainer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <blockquote>
            <p>注意：</p>
            <p>在 import <code>React</code> <strong>前</strong>，你需要讓 <code>window</code>、<code>window.document</code> 和 <code>window.document.createElement</code> 在全域可以使用。否則 React 會認為它無法存取 DOM，像 <code>setState</code> 之類的方法也將無法運作。</p>
          </blockquote>
          <hr>
        </section>
      </section>
      <section id="other-utilities" class="level2">
        <h2>其他工具</h2>
        <section id="simulate-simulate" class="level3">
          <h3><code>Simulate</code> {#simulate}</h3>
          <pre class="language-javascript"><code class="language-javascript"><span class="token maybe-class-name">Simulate</span><span class="token punctuation">.</span><span class="token punctuation">{</span>eventName<span class="token punctuation">}</span><span class="token punctuation">(</span>
  element<span class="token punctuation">,</span>
  <span class="token punctuation">[</span>eventData<span class="token punctuation">]</span>
<span class="token punctuation">)</span></code></pre>
          <p>在 DOM node 上用可選的 <code>eventData</code> 事件資料模擬 event dispatch。</p>
          <p><a href="./events.html#supported-events">每一個 React 支援的事件</a>在 <code>Simulate</code> 都有對應的方法。</p>
          <p><strong>點擊 element</strong></p>
          <pre class="language-javascript"><code class="language-javascript"><span class="token comment">// &#x3C;button ref={(node) => this.button = node}>...&#x3C;/button></span>
<span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">button</span><span class="token punctuation">;</span>
<span class="token maybe-class-name">ReactTestUtils</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Simulate</span></span><span class="token punctuation">.</span><span class="token method function property-access">click</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p><strong>更改輸入欄位的值，然後按 ENTER 鍵。</strong></p>
          <pre class="language-javascript"><code class="language-javascript"><span class="token comment">// &#x3C;input ref={(node) => this.textInput = node} /></span>
<span class="token keyword">const</span> node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">textInput</span><span class="token punctuation">;</span>
node<span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token operator">=</span> <span class="token string">'giraffe'</span><span class="token punctuation">;</span>
<span class="token maybe-class-name">ReactTestUtils</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Simulate</span></span><span class="token punctuation">.</span><span class="token method function property-access">change</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token maybe-class-name">ReactTestUtils</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Simulate</span></span><span class="token punctuation">.</span><span class="token method function property-access">keyDown</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">"Enter"</span><span class="token punctuation">,</span> <span class="token literal-property property">keyCode</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token literal-property property">which</span><span class="token operator">:</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <blockquote>
            <p>注意：</p>
            <p>你需要提供所有在你的 component 中有使用的事件屬性（如 keyCode、which 等等），因為 React 不會為你建立這些東西。</p>
          </blockquote>
          <hr>
          <p><span style="float: footnote;"><a href="./index.html#toc">Go to TOC</a></span></p>
        </section>
      </section>
    </section>
  </body>
</html>
