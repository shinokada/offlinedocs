<!doctype html><html lang="de"><meta charset="utf-8"><title>renderToPipeableStream</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="rendertopipeablestream"><h1 id="rendertopipeablestream">renderToPipeableStream</h1><intro><p><code>renderToPipeableStream</code> renders a React tree to a pipeable <a href="https://nodejs.org/api/stream.html">Node.js Stream.</a><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe<span class="token punctuation">,</span> abort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span>reactNode<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><note><p>This API is specific to Node.js. Environments with <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">Web Streams,</a> like Deno and modern edge runtimes, should use <a href="/reference/react-dom/server/renderToReadableStream"><code>renderToReadableStream</code></a> instead.</p></note><section class="level2"aria-labelledby="reference-reference"><h2 id="reference-reference">Reference {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="rendertopipeablestreamreactnode-options-rendertopipeablestream"><h3 id="rendertopipeablestreamreactnode-options-rendertopipeablestream"><code>renderToPipeableStream(reactNode, options?)</code> {/<em>rendertopipeablestream</em>/}</h3><p>Call <code>renderToPipeableStream</code> to render your React tree as HTML into a <a href="https://nodejs.org/api/stream.html#writable-streams">Node.js Stream.</a><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToPipeableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>On the client, call <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a> to make the server-generated HTML interactive.<p><a href="#usage">See more examples below.</a><section class="level4"aria-labelledby="parameters-parameters"><h4 id="parameters-parameters">Parameters {/<em>parameters</em>/}</h4><ul><li><p><code>reactNode</code>: A React node you want to render to HTML. For example, a JSX element like <code>&#x3C;App /></code>. It is expected to represent the entire document, so the <code>App</code> component should render the <code>&#x3C;html></code> tag.<li><p><strong>optional</strong> <code>options</code>: An object with streaming options.<ul><li><strong>optional</strong> <code>bootstrapScriptContent</code>: If specified, this string will be placed in an inline <code>&#x3C;script></code> tag.<li><strong>optional</strong> <code>bootstrapScripts</code>: An array of string URLs for the <code>&#x3C;script></code> tags to emit on the page. Use this to include the <code>&#x3C;script></code> that calls <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code>.</a> Omit it if you don't want to run React on the client at all.<li><strong>optional</strong> <code>bootstrapModules</code>: Like <code>bootstrapScripts</code>, but emits <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules"><code>&#x3C;script type="module"></code></a> instead.<li><strong>optional</strong> <code>identifierPrefix</code>: A string prefix React uses for IDs generated by <a href="/reference/react/useId"><code>useId</code>.</a> Useful to avoid conflicts when using multiple roots on the same page. Must be the same prefix as passed to <a href="/reference/react-dom/client/hydrateRoot#parameters"><code>hydrateRoot</code>.</a><li><strong>optional</strong> <code>namespaceURI</code>: A string with the root <a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/createElementNS#important_namespace_uris">namespace URI</a> for the stream. Defaults to regular HTML. Pass <code>'http://www.w3.org/2000/svg'</code> for SVG or <code>'http://www.w3.org/1998/Math/MathML'</code> for MathML.<li><strong>optional</strong> <code>nonce</code>: A <a href="http://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#nonce"><code>nonce</code></a> string to allow scripts for <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src"><code>script-src</code> Content-Security-Policy</a>.<li><strong>optional</strong> <code>onAllReady</code>: A callback that fires when all rendering is complete, including both the <a href="#specifying-what-goes-into-the-shell">shell</a> and all additional <a href="#streaming-more-content-as-it-loads">content.</a> You can use this instead of <code>onShellReady</code> <a href="#waiting-for-all-content-to-load-for-crawlers-and-static-generation">for crawlers and static generation.</a> If you start streaming here, you won't get any progressive loading. The stream will contain the final HTML.<li><strong>optional</strong> <code>onError</code>: A callback that fires whenever there is a server error, whether <a href="#recovering-from-errors-outside-the-shell">recoverable</a> or <a href="#recovering-from-errors-inside-the-shell">not.</a> By default, this only calls <code>console.error</code>. If you override it to <a href="#logging-crashes-on-the-server">log crash reports,</a> make sure that you still call <code>console.error</code>. You can also use it to <a href="#setting-the-status-code">adjust the status code</a> before the shell is emitted.<li><strong>optional</strong> <code>onShellReady</code>: A callback that fires right after the <a href="#specifying-what-goes-into-the-shell">initial shell</a> has been rendered. You can <a href="#setting-the-status-code">set the status code</a> and call <code>pipe</code> here to start streaming. React will <a href="#streaming-more-content-as-it-loads">stream the additional content</a> after the shell along with the inline <code>&#x3C;script></code> tags that place that replace the HTML loading fallbacks with the content.<li><strong>optional</strong> <code>onShellError</code>: A callback that fires if there was an error rendering the initial shell. It receives the error as an argument. No bytes were emitted from the stream yet, and neither <code>onShellReady</code> nor <code>onAllReady</code> will get called, so you can <a href="#recovering-from-errors-inside-the-shell">output a fallback HTML shell.</a><li><strong>optional</strong> <code>progressiveChunkSize</code>: The number of bytes in a chunk. <a href="https://github.com/facebook/react/blob/14c2be8dac2d5482fda8a0906a31d239df8551fc/packages/react-server/src/ReactFizzServer.js#L210-L225">Read more about the default heuristic.</a></ul></ul></section><section class="level4"aria-labelledby="returns-returns"><h4 id="returns-returns">Returns {/<em>returns</em>/}</h4><p><code>renderToPipeableStream</code> returns an object with two methods:<ul><li><code>pipe</code> outputs the HTML into the provided <a href="https://nodejs.org/api/stream.html#writable-streams">Writable Node.js Stream.</a> Call <code>pipe</code> in <code>onShellReady</code> if you want to enable streaming, or in <code>onAllReady</code> for crawlers and static generation.<li><code>abort</code> lets you <a href="#aborting-server-rendering">abort server rendering</a> and render the rest on the client.</ul></section></section></section><section class="level2"aria-labelledby="usage-usage"><h2 id="usage-usage">Usage {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="rendering-a-react-tree-as-html-to-a-nodejs-stream-rendering-a-react-tree-as-html-to-a-nodejs-stream"><h3 id="rendering-a-react-tree-as-html-to-a-nodejs-stream-rendering-a-react-tree-as-html-to-a-nodejs-stream">Rendering a React tree as HTML to a Node.js Stream {/<em>rendering-a-react-tree-as-html-to-a-nodejs-stream</em>/}</h3><p>Call <code>renderToPipeableStream</code> to render your React tree as HTML into a <a href="https://nodejs.org/api/stream.html#writable-streams">Node.js Stream:</a><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToPipeableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token comment">// The route handler syntax depends on your backend framework</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Along with the<codestep step="{1}">root component</codestep>, you need to provide a list of<codestep step="{2}">bootstrap <code>&#x3C;script></code> paths</codestep>. Your root component should return <strong>the entire document including the root <code>&#x3C;html></code> tag.</strong><p>For example, it might look like this:<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta charSet<span class="token operator">=</span><span class="token string">"utf-8"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/styles.css"</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>title<span class="token operator">></span><span class="token maybe-class-name">My</span> app<span class="token operator">&#x3C;</span><span class="token operator">/</span>title<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>body<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Router</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>body<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React will inject the <a href="https://developer.mozilla.org/en-US/docs/Glossary/Doctype">doctype</a> and your<codestep step="{2}">bootstrap <code>&#x3C;script></code> tags</codestep>into the resulting HTML stream:<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&#x3C;!-- ... HTML from your components ... --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/main.js<span class="token punctuation">"</span></span> <span class="token attr-name">async</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>On the client, your bootstrap script should <a href="/reference/react-dom/client/hydrateRoot#hydrating-an-entire-document">hydrate the entire <code>document</code> with a call to <code>hydrateRoot</code>:</a><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This will attach event listeners to the server-generated HTML and make it interactive.</p><deepdive><section class="level4"aria-labelledby="reading-css-and-js-asset-paths-from-the-build-output-reading-css-and-js-asset-paths-from-the-build-output"><h4 id="reading-css-and-js-asset-paths-from-the-build-output-reading-css-and-js-asset-paths-from-the-build-output">Reading CSS and JS asset paths from the build output {/<em>reading-css-and-js-asset-paths-from-the-build-output</em>/}</h4><p>The final asset URLs (like JavaScript and CSS files) are often hashed after the build. For example, instead of <code>styles.css</code> you might end up with <code>styles.123456.css</code>. Hashing static asset filenames guarantees that every distinct build of the same asset will have a different filename. This is useful because it lets you safely enable long-term caching for static assets: a file with a certain name would never change content.<p>However, if you don't know the asset URLs until after the build, there's no way for you to put them in the source code. For example, hardcoding <code>"/styles.css"</code> into JSX like earlier wouldn't work. To keep them out of your source code, your root component can read the real filenames from a map passed as a prop:<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> assetMap <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token spread operator">...</span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">[</span><span class="token string">'styles.css'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token spread operator">...</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token spread operator">...</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>On the server, render <code>&#x3C;App assetMap={assetMap} /></code> and pass your <code>assetMap</code> with the asset URLs:<pre class="language-js"><code class="language-js"><span class="token comment">// You'd need to get this JSON from your build tooling, e.g. read it from the build output.</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Since your server is now rendering <code>&#x3C;App assetMap={assetMap} /></code>, you need to render it with <code>assetMap</code> on the client too to avoid hydration errors. You can serialize and pass <code>assetMap</code> to the client like this:<pre class="language-js"><code class="language-js"><span class="token comment">// You'd need to get this JSON from your build tooling.</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// Careful: It's safe to stringify() this because this data isn't user-generated.</span>
    <span class="token literal-property property">bootstrapScriptContent</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">window.assetMap = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>assetMap<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In the example above, the <code>bootstrapScriptContent</code> option adds an extra inline <code>&#x3C;script></code> tag that sets the global <code>window.assetMap</code> variable on the client. This lets the client code read the same <code>assetMap</code>:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">assetMap</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Both client and server render <code>App</code> with the same <code>assetMap</code> prop, so there are no hydration errors.</section></deepdive></section><section class="level3"aria-labelledby="streaming-more-content-as-it-loads-streaming-more-content-as-it-loads"><h3 id="streaming-more-content-as-it-loads-streaming-more-content-as-it-loads">Streaming more content as it loads {/<em>streaming-more-content-as-it-loads</em>/}</h3><p>Streaming allows the user to start seeing the content even before all the data has loaded on the server. For example, consider a profile page that shows a cover, a sidebar with friends and photos, and a list of posts:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Imagine that loading data for <code>&#x3C;Posts /></code> takes some time. Ideally, you'd want to show the rest of the profile page content to the user without waiting for the posts. To do this, <a href="/reference/react/Suspense#displaying-a-fallback-while-content-is-loading">wrap <code>Posts</code> in a <code>&#x3C;Suspense></code> boundary:</a><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>This tells React to start streaming the HTML before <code>Posts</code> loads its data. React will send the HTML for the loading fallback (<code>PostsGlimmer</code>) first, and then, when <code>Posts</code> finishes loading its data, React will send the remaining HTML along with an inline <code>&#x3C;script></code> tag that replaces the loading fallback with that HTML. From the user's perspective, the page will first appear with the <code>PostsGlimmer</code>, later replaced by the <code>Posts</code>.<p>You can further <a href="/reference/react/Suspense#revealing-nested-content-as-it-loads">nest <code>&#x3C;Suspense></code> boundaries</a> to create a more granular loading sequence:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>In this example, React can start streaming the page even earlier. Only <code>ProfileLayout</code> and <code>ProfileCover</code> must finish rendering first because they are not wrapped in any <code>&#x3C;Suspense></code> boundary. However, if <code>Sidebar</code>, <code>Friends</code>, or <code>Photos</code> need to load some data, React will send the HTML for the <code>BigSpinner</code> fallback instead. Then, as more data becomes available, more content will continue to be revealed until all of it becomes visible.<p>Streaming does not need to wait for React itself to load in the browser, or for your app to become interactive. The HTML content from the server will get progressively revealed before any of the <code>&#x3C;script></code> tags load.<p><a href="https://github.com/reactwg/react-18/discussions/37">Read more about how streaming HTML works.</a></p><note><p><strong>Only Suspense-enabled data sources will activate the Suspense component.</strong> They include:<ul><li>Data fetching with Suspense-enabled frameworks like <a href="https://relay.dev/docs/guided-tour/rendering/loading-states/">Relay</a> and <a href="https://nextjs.org/docs/getting-started/react-essentials">Next.js</a><li>Lazy-loading component code with <a href="/reference/react/lazy"><code>lazy</code></a><li>Reading the value of a Promise with <a href="/reference/react/use"><code>use</code></a></ul><p>Suspense <strong>does not</strong> detect when data is fetched inside an Effect or event handler.<p>The exact way you would load data in the <code>Posts</code> component above depends on your framework. If you use a Suspense-enabled framework, you'll find the details in its data fetching documentation.<p>Suspense-enabled data fetching without the use of an opinionated framework is not yet supported. The requirements for implementing a Suspense-enabled data source are unstable and undocumented. An official API for integrating data sources with Suspense will be released in a future version of React.</p></note></section><section class="level3"aria-labelledby="specifying-what-goes-into-the-shell-specifying-what-goes-into-the-shell"><h3 id="specifying-what-goes-into-the-shell-specifying-what-goes-into-the-shell">Specifying what goes into the shell {/<em>specifying-what-goes-into-the-shell</em>/}</h3><p>The part of your app outside of any <code>&#x3C;Suspense></code> boundaries is called <em>the shell:</em><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>It determines the earliest loading state that the user may see:<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span></code></pre><p>If you wrap the whole app into a <code>&#x3C;Suspense></code> boundary at the root, the shell will only contain that spinner. However, that's not a pleasant user experience because seeing a big spinner on the screen can feel slower and more annoying than waiting a bit more and seeing the real layout. This is why usually you'll want to place the <code>&#x3C;Suspense></code> boundaries so that the shell feels <em>minimal but complete</em>--like a skeleton of the entire page layout.<p>The <code>onShellReady</code> callback fires when the entire shell has been rendered. Usually, you'll start streaming then:<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>By the time <code>onShellReady</code> fires, components in nested <code>&#x3C;Suspense></code> boundaries might still be loading data.</section><section class="level3"aria-labelledby="logging-crashes-on-the-server-logging-crashes-on-the-server"><h3 id="logging-crashes-on-the-server-logging-crashes-on-the-server">Logging crashes on the server {/<em>logging-crashes-on-the-server</em>/}</h3><p>By default, all errors on the server are logged to console. You can override this behavior to log crash reports:<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If you provide a custom <code>onError</code> implementation, don't forget to also log errors to the console like above.</section><section class="level3"aria-labelledby="recovering-from-errors-inside-the-shell-recovering-from-errors-inside-the-shell"><h3 id="recovering-from-errors-inside-the-shell-recovering-from-errors-inside-the-shell">Recovering from errors inside the shell {/<em>recovering-from-errors-inside-the-shell</em>/}</h3><p>In this example, the shell contains <code>ProfileLayout</code>, <code>ProfileCover</code>, and <code>PostsGlimmer</code>:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If an error occurs while rendering those components, React won't have any meaningful HTML to send to the client. Override <code>onShellError</code> to send a fallback HTML that doesn't rely on server rendering as the last resort:<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If there is an error while generating the shell, both <code>onError</code> and <code>onShellError</code> will fire. Use <code>onError</code> for error reporting and use <code>onShellError</code> to send the fallback HTML document. Your fallback HTML does not have to be an error page. Instead, you may include an alternative shell that renders your app on the client only.</section><section class="level3"aria-labelledby="recovering-from-errors-outside-the-shell-recovering-from-errors-outside-the-shell"><h3 id="recovering-from-errors-outside-the-shell-recovering-from-errors-outside-the-shell">Recovering from errors outside the shell {/<em>recovering-from-errors-outside-the-shell</em>/}</h3><p>In this example, the <code>&#x3C;Posts /></code> component is wrapped in <code>&#x3C;Suspense></code> so it is <em>not</em> a part of the shell:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If an error happens in the <code>Posts</code> component or somewhere inside it, React will <a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-client-only-content">try to recover from it:</a><ol><li>It will emit the loading fallback for the closest <code>&#x3C;Suspense></code> boundary (<code>PostsGlimmer</code>) into the HTML.<li>It will "give up" on trying to render the <code>Posts</code> content on the server anymore.<li>When the JavaScript code loads on the client, React will <em>retry</em> rendering <code>Posts</code> on the client.</ol><p>If retrying rendering <code>Posts</code> on the client <em>also</em> fails, React will throw the error on the client. As with all the errors thrown during rendering, the <a href="/reference/react/Component#static-getderivedstatefromerror">closest parent error boundary</a> determines how to present the error to the user. In practice, this means that the user will see a loading indicator until it is certain that the error is not recoverable.<p>If retrying rendering <code>Posts</code> on the client succeeds, the loading fallback from the server will be replaced with the client rendering output. The user will not know that there was a server error. However, the server <code>onError</code> callback and the client <a href="/reference/react-dom/client/hydrateRoot#hydrateroot"><code>onRecoverableError</code></a> callbacks will fire so that you can get notified about the error.</section><section class="level3"aria-labelledby="setting-the-status-code-setting-the-status-code"><h3 id="setting-the-status-code-setting-the-status-code">Setting the status code {/<em>setting-the-status-code</em>/}</h3><p>Streaming introduces a tradeoff. You want to start streaming the page as early as possible so that the user can see the content sooner. However, once you start streaming, you can no longer set the response status code.<p>By <a href="#specifying-what-goes-into-the-shell">dividing your app</a> into the shell (above all <code>&#x3C;Suspense></code> boundaries) and the rest of the content, you've already solved a part of this problem. If the shell errors, you'll get the <code>onShellError</code> callback which lets you set the error status code. Otherwise, you know that the app may recover on the client, so you can send "OK".<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>If a component <em>outside</em> the shell (i.e. inside a <code>&#x3C;Suspense></code> boundary) throws an error, React will not stop rendering. This means that the <code>onError</code> callback will fire, but you will still get <code>onShellReady</code> instead of <code>onShellError</code>. This is because React will try to recover from that error on the client, <a href="#recovering-from-errors-outside-the-shell">as described above.</a><p>However, if you'd like, you can use the fact that something has errored to set the status code:<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This will only catch errors outside the shell that happened while generating the initial shell content, so it's not exhaustive. If knowing whether an error occurred for some content is critical, you can move it up into the shell.</section><section class="level3"aria-labelledby="handling-different-errors-in-different-ways-handling-different-errors-in-different-ways"><h3 id="handling-different-errors-in-different-ways-handling-different-errors-in-different-ways">Handling different errors in different ways {/<em>handling-different-errors-in-different-ways</em>/}</h3><p>You can <a href="https://javascript.info/custom-errors">create your own <code>Error</code> subclasses</a> and use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof"><code>instanceof</code></a> operator to check which error is thrown. For example, you can define a custom <code>NotFoundError</code> and throw it from your component. Then your <code>onError</code>, <code>onShellReady</code>, and <code>onShellError</code> callbacks can do something different depending on the error type:<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> caughtError <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>didError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>caughtError <span class="token keyword">instanceof</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    caughtError <span class="token operator">=</span> error<span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Keep in mind that once you emit the shell and start streaming, you can't change the status code.</section><section class="level3"aria-labelledby="waiting-for-all-content-to-load-for-crawlers-and-static-generation-waiting-for-all-content-to-load-for-crawlers-and-static-generation"><h3 id="waiting-for-all-content-to-load-for-crawlers-and-static-generation-waiting-for-all-content-to-load-for-crawlers-and-static-generation">Waiting for all content to load for crawlers and static generation {/<em>waiting-for-all-content-to-load-for-crawlers-and-static-generation</em>/}</h3><p>Streaming offers a better user experience because the user can see the content as it becomes available.<p>However, when a crawler visits your page, or if you're generating the pages at the build time, you might want to let all of the content load first and then produce the final HTML output instead of revealing it progressively.<p>You can wait for all the content to load using the <code>onAllReady</code> callback:<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> isCrawler <span class="token operator">=</span> <span class="token comment">// ... depends on your bot detection strategy ...</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCrawler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onAllReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isCrawler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>A regular visitor will get a stream of progressively loaded content. A crawler will receive the final HTML output after all the data loads. However, this also means that the crawler will have to wait for <em>all</em> data, some of which might be slow to load or error. Depending on your app, you could choose to send the shell to the crawlers too.</section><section class="level3"aria-labelledby="aborting-server-rendering-aborting-server-rendering"><h3 id="aborting-server-rendering-aborting-server-rendering">Aborting server rendering {/<em>aborting-server-rendering</em>/}</h3><p>You can force the server rendering to "give up" after a timeout:<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe<span class="token punctuation">,</span> abort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>React will flush the remaining loading fallbacks as HTML, and will attempt to render the rest on the client. <span style="float:footnote"><a href="../../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>