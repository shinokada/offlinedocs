<!doctype html><html lang="fr"><meta charset="utf-8"><title>'Référencer des valeurs avec les refs'</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="référencer-des-valeurs-avec-les-refs"><h1 id="référencer-des-valeurs-avec-les-refs">'Référencer des valeurs avec les refs'</h1><intro><p>Lorsque vous souhaitez que votre composant « se souvienne » de quelque chose, mais que vous voulez éviter que l’évolution de ces données <a href="/learn/render-and-commit">déclenche de nouveaux rendus</a>, vous pouvez utiliser une <em>ref</em>.</p></intro><youwilllearn><ul><li>Comment ajouter une ref à votre composant<li>Comment mettre à jour la valeur d'une ref<li>En quoi les refs diffèrent des variables d'état<li>Comment utiliser les refs de façon fiable</ul></youwilllearn><section class="level2"aria-labelledby="ajouter-une-ref-à-votre-composant-adding-a-ref-to-your-component"><h2 id="ajouter-une-ref-à-votre-composant-adding-a-ref-to-your-component">Ajouter une ref à votre composant {/<em>adding-a-ref-to-your-component</em>/}</h2><p>Vous pouvez ajouter une ref à votre composant en important le Hook <code>useRef</code> de React :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span></code></pre><p>Au sein de votre composant, appelez le Hook <code>useRef</code> et passez-lui comme unique argument la valeur initiale que vous souhaitez référencer. Par exemple, voici une ref vers la valeur <code>0</code> :<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>useRef</code> renvoie un objet comme celui-ci :<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">current</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">// La valeur que vous avez passée à useRef</span>
<span class="token punctuation">}</span></code></pre><p>&#x3C;Illustration src./docs/illustrations/i_ref.png" alt="Une flèche labellisée “current” au sein d'une poche avec “ref” écrit dessus." /><p>Vous pouvez accéder à la valeur actuelle de cette ref au travers de la propriété <code>ref.current</code>. Cette valeur est volontairement modifiable, ce qui signifie que vous pouvez aussi bien la lire que l'écrire. C'est un peu comme une poche secrète de votre composant que React ne peut pas surveiller. (C'est ce qui en fait une « échappatoire » du flux de données unidirectionnel de React--on va détailler ça dans un instant !)<p>Voici maintenant un bouton qui incrémente <code>ref.current</code> à chaque clic :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Vous avez cliqué '</span> <span class="token operator">+</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">+</span> <span class="token string">' fois !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token maybe-class-name">Cliquez</span> ici
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>La ref pointe vers un nombre, mais tout comme pour <a href="/learn/state-a-components-memory">l'état</a>, vous pouvez pointer vers ce que vous voulez : une chaîne de caractères, un objet, ou même une fonction. Contrairement aux variables d'état, une ref est juste un objet JavaScript brut avec une propriété <code>current</code> que vous pouvez lire et modifier.<p>Remarquez que <strong>le composant ne refait pas de rendu à chaque incrémentation</strong>. Comme les variables d'état, les refs sont préservées par React d'un rendu à l'autre. Cependant, modifier un état entraîne un nouveau rendu du composant, tandis que modifier une ref ne le fait pas !</section><section class="level2"aria-labelledby="exemple-construire-un-chronomètre-example-building-a-stopwatch"><h2 id="exemple-construire-un-chronomètre-example-building-a-stopwatch">Exemple : construire un chronomètre {/<em>example-building-a-stopwatch</em>/}</h2><p>Vous pouvez combiner des refs et des variables d'état dans un même composant. Construisons par exemple un chronomètre que l'utilisateur peut démarrer et arrêter en pressant un bouton. Afin de pouvoir afficher le temps écoulé depuis que l'utilisateur a pressé « Démarrer », vous allez devoir garder trace du moment auquel ce bouton a été pressé, et du moment courant. <strong>Ces informations sont nécessaires au rendu, de sorte que vous les stockez dans des variables d'état :</strong><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>startTime<span class="token punctuation">,</span> setStartTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>now<span class="token punctuation">,</span> setNow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Lorsque l'utilisateur pressera « Démarrer », vous utiliserez <a href="https://developer.mozilla.org/en-US/docs/Web/API/setInterval"><code>setInterval</code></a> afin de mettre à jour le moment courant toutes les 10 millisecondes :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Stopwatch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>startTime<span class="token punctuation">,</span> setStartTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>now<span class="token punctuation">,</span> setNow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Commencer à chronométrer.</span>
    <span class="token function">setStartTime</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// Mettre à jour le temps toutes les 10ms.</span>
      <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> secondsPassed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">!=</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> now <span class="token operator">!=</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    secondsPassed <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token maybe-class-name">Temps</span> écoulé <span class="token operator">:</span> <span class="token punctuation">{</span>secondsPassed<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleStart<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token constant">D</span>émarrer
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>Lorsque le bouton « Arrêter » est pressé, vous devez annuler l'intervalle pour qu'il cesse de mettre à jour la variable d'état <code>now</code>. Vous pouvez faire ça en appelant <a href="https://developer.mozilla.org/fr/docs/Web/API/clearInterval"><code>clearInterval</code></a>, mais vous avez besoin de lui fournir l'ID du timer renvoyé précédemment par votre appel à <code>setInterval</code> lorsque l'utilisateur avait pressé « Démarrer ». Il faut donc bien conserver cet ID quelque part. <strong>Puisque l'ID de l'intervalle n'est pas nécessaire au rendu, vous pouvez le conserver dans une ref :</strong></p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Stopwatch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>startTime<span class="token punctuation">,</span> setStartTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>now<span class="token punctuation">,</span> setNow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> intervalRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setStartTime</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">clearInterval</span><span class="token punctuation">(</span>intervalRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intervalRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>intervalRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> secondsPassed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">!=</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> now <span class="token operator">!=</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    secondsPassed <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token maybe-class-name">Temps</span> écoulé <span class="token operator">:</span> <span class="token punctuation">{</span>secondsPassed<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleStart<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token constant">D</span>émarrer
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleStop<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Arrêter</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>Lorsqu'une information est utilisée pour le rendu, conservez-la dans une variable d'état. Lorsqu'elle n'est nécessaire qu'aux gestionnaires d'événements, et que la modifier ne doit pas entraîner un nouveau rendu, il est plus efficace de passer par une ref.</section><section class="level2"aria-labelledby="différences-entre-refs-et-variables-détat-differences-between-refs-and-state"><h2 id="différences-entre-refs-et-variables-détat-differences-between-refs-and-state">Différences entre refs et variables d'état {/<em>differences-between-refs-and-state</em>/}</h2><p>Vous trouvez peut-être que les refs semblent moins « strictes » que les variables d'état--vous pouvez les modifier plutôt que de devoir passer par une fonction de mise à jour d'état, par exemple. Pourtant dans la majorité des cas, vous voudrez utiliser des états. Les refs sont une « échappatoire » dont vous n'aurez pas souvent besoin. Voici un comparatif entre variables d'état et refs :<table><thead><tr><th>Ref<th>Variable d'état<tbody><tr><td><code>useRef(initialValue)</code> renvoie <code>{ current: initialValue }</code>.<td><code>useState(initialValue)</code> renvoie la valeur actuelle d'une variable d'état et une fonction de modification de cette valeur (<code>[value, setValue]</code>).<tr><td>Ne redéclenche pas un rendu quand vous la modifiez.<td>Déclenche un nouveau rendu quand vous la modifiez.<tr><td>Modifiable : vous pouvez changer la valeur de <code>current</code> hors du rendu.<td>« Immuable » : vous devez passer par la fonction de mise à jour de l'état pour changer la variable d'état, ce qui est mis en attente pour le prochain rendu.<tr><td>Vous ne devriez pas lire (ou écrire) la valeur de <code>current</code> pendant le rendu.<td>Vous pouvez lire l'état à tout moment. En revanche, chaque rendu a son propre <a href="/learn/state-as-a-snapshot">instantané</a> de l'état, qui ne change pas.</table><p>Voici un bouton de compteur implémenté avec une variable d'état :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token maybe-class-name">Vous</span> avez cliqué <span class="token punctuation">{</span>count<span class="token punctuation">}</span> fois
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>Étant donné que la valeur <code>count</code> est affichée, il est logique d'utiliser une variable d'état pour la stocker. Quand la valeur du compteur est modifiée via <code>setCount()</code>, React fait un nouveau rendu du composant et l'écran est mis à jour pour refléter le nouveau compteur.<p>Si vous utilisiez une ref, React ne déclencherait jamais un nouveau rendu du composant, et vous ne verriez jamais la valeur changer ! Essayez ci-dessous de cliquer le bouton, <strong>ça ne met pas à jour le texte</strong> :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> countRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Le composant ne refait pas son rendu !</span>
    countRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> countRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token maybe-class-name">Vous</span> avez cliqué <span class="token punctuation">{</span>countRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">}</span> fois
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>Voilà pourquoi la lecture de <code>ref.current</code> pendant le rendu n'est pas une pratique fiable. Si vous avez besoin de ça, utilisez plutôt une variable d'état.</p><deepdive><section class="level4"aria-labelledby="comment-fonctionne-useref-en-interne-how-does-use-ref-work-inside"><h4 id="comment-fonctionne-useref-en-interne-how-does-use-ref-work-inside">Comment fonctionne <code>useRef</code> en interne ? {/<em>how-does-use-ref-work-inside</em>/}</h4><p>Même si <code>useState</code> et <code>useRef</code> sont fournis par React, en principe <code>useRef</code> pourrait être implémenté <em>par-dessus</em> <code>useState</code>. On pourrait imaginer que dans le code de React, <code>useRef</code> serait peut-être implémenté de la façon suivante :<pre class="language-js"><code class="language-js"><span class="token comment">// Dans React…</span>
<span class="token keyword">function</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token parameter">initialValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>ref<span class="token punctuation">,</span> unused<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">current</span><span class="token operator">:</span> initialValue <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Lors du premier rendu, <code>useRef</code> renvoie <code>{ current: initialValue}</code>. Cet objet est stocké par React, de sorte qu'au prochain rendu il renverra le même objet. Remarquez que la fonction de modification de l'état est inutilisée dans ce code. Elle est superflue puisque <code>useRef</code> renvoie toujours le même objet !<p>React fournit directement <code>useRef</code> parce qu'il s'agit d'un cas d'usage suffisamment courant. Mais vous pouvez le voir comme une variable d'état classique mais sans fonction modificatrice. Si vous avez l'habitude de la programmation orientée objet, les refs vous font peut-être penser à des champs d'instance--sauf qu'au lieu d'écrire <code>this.something</code> vous écrivez <code>somethingRef.current</code>.</section></deepdive></section><section class="level2"aria-labelledby="quand-utiliser-des-refs-when-to-use-refs"><h2 id="quand-utiliser-des-refs-when-to-use-refs">Quand utiliser des refs {/<em>when-to-use-refs</em>/}</h2><p>En général, vous utiliserez une ref lorsque votre composant a besoin de « sortir » de React et communiquer avec des API extérieures (souvent une API du navigateur qui n'impactera pas l'apparence du composant). Voici quelques-unes de ces situations peu fréquentes :<ul><li>Conserver des <a href="https://developer.mozilla.org/fr/docs/Web/API/setTimeout">ID de timers</a>.<li>Référencer puis manipuler des <a href="https://developer.mozilla.org/fr/docs/Web/API/Element">éléments du DOM</a>, comme nous le verrons en détail <a href="/learn/manipulating-the-dom-with-refs">dans la prochaine page</a>.<li>Référencer d'autres objets qui ne sont pas nécessaires au calcul du JSX.</ul><p>Si votre composant a besoin de stocker une valeur, mais que cette valeur n'impacte pas la logique de rendu, optez pour une ref.</section><section class="level2"aria-labelledby="meilleures-pratiques-pour-les-refs-best-practices-for-refs"><h2 id="meilleures-pratiques-pour-les-refs-best-practices-for-refs">Meilleures pratiques pour les refs {/<em>best-practices-for-refs</em>/}</h2><p>Pour rendre vos composants plus prévisibles, respectez les principes suivants :<ul><li><strong>Traitez les refs comme une échappatoire.</strong> Les refs sont utiles lorsque vous travaillez avec des systèmes extérieurs ou des API du navigateur. Mais si une large part de votre logique applicative et de votre flux de données repose sur les refs, vous devriez probablement repenser votre approche.<li><strong>Ne lisez pas et n'écrivez pas dans <code>ref.current</code> pendant le rendu.</strong> Si une information est nécessaire au rendu, utilisez plutôt <a href="/learn/state-a-components-memory">un état</a>. Comme React ne sait pas que <code>ref.current</code> change, même le simple fait de la lire pendant le rendu peut introduire des comportements déroutants dans votre composant. (La seule exception concerne du code du style <code>if (!ref.current) ref.current = new Thing()</code>, qui ne met à jour la ref qu'une fois lors du rendu initial.)</ul><p>Les contraintes des états React ne s'appliquent pas aux refs. Par exemple, l'état se comporte comme un <a href="/learn/state-as-a-snapshot">instantané pour chaque rendu</a> et <a href="/learn/queueing-a-series-of-state-updates">est mis à jour en asynchrone</a>. En revanche, lorsque vous modifiez la valeur actuelle d'une ref, c'est immédiat :<pre class="language-js"><code class="language-js">ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span></code></pre><p>C'est parce que <strong>la ref elle-même n'est qu'un objet JavaScript brut</strong>, et se comporte donc comme tel.<p>Vous n'avez pas non plus à vous préoccuper <a href="/learn/updating-objects-in-state">d'éviter les mutations</a> lorsque vous travaillez avec une ref. Du moment que l'objet que vous modifiez n'est pas utilisé pour le rendu, React se fiche de ce que vous faites avec la ref et son contenu.</section><section class="level2"aria-labelledby="les-refs-et-le-dom-refs-and-the-dom"><h2 id="les-refs-et-le-dom-refs-and-the-dom">Les refs et le DOM {/<em>refs-and-the-dom</em>/}</h2><p>Vous pouvez faire pointer votre ref vers ce que vous voulez. Ceci dit, le cas le plus courant pour une ref consiste à accéder à un élément du DOM. C'est par exemple bien pratique pour gérer le focus programmatiquement. Quand vous passez une ref à la prop <code>ref</code> d'un élément en JSX, comme dans <code>&#x3C;div ref={myRef}></code>, React référencera l'élément DOM correspondant dans <code>myRef.current</code>. Lorsque l'élément sera retiré du DOM, React recalera <code>ref.current</code> à <code>null</code>. Vous pouvez en apprendre davantage dans <a href="/learn/manipulating-the-dom-with-refs">Manipuler le DOM avec des refs</a>.</p><recap><ul><li>Les refs sont une échappatoire qui vous permet de conserver des valeurs qui ne servent pas au rendu. Vous n'en aurez pas souvent besoin.<li>Une ref est un objet JavaScript brut avec une unique propriété <code>current</code>, que vous pouvez lire et écrire.<li>Vous pouvez demander à React de vous fournir une ref en appelant le Hook <code>useRef</code>.<li>Tout comme les variables d'état, les refs préservent leur information d'un rendu à l'autre du composant.<li>Contrairement aux états, modifier la valeur <code>current</code> d'une ref ne déclenche pas un nouveau rendu.<li>Évitez de lire ou d'écrire dans <code>ref.current</code> pendant le rendu ; le comportement de votre composant deviendrait imprévisible.</ul></recap><challenges><section class="level4"aria-labelledby="corriger-un-bouton-de-discussion-fix-a-broken-chat-input"><h4 id="corriger-un-bouton-de-discussion-fix-a-broken-chat-input">Corriger un bouton de discussion {/<em>fix-a-broken-chat-input</em>/}</h4><p>Tapez un message et cliquez sur « Envoyer ». Vous remarquerez un délai de trois secondes avant de voir la notification « Envoyé ! ». Dans l'intervalle, vous pouvez voir un bouton « Annuler ». Ce bouton est supposé empêcher l'apparition de la notification « Envoyé ! ». Pour cela, il appelle <a href="https://developer.mozilla.org/en-US/docs/Web/API/clearTimeout"><code>clearTimeout</code></a> sur l'ID de timer sauvegardé lors de <code>handleSend</code>. Pourtant, même après avoir cliqué sur « Annuler », la notification « Envoyé ! » apparaît. Trouvez ce qui cloche et corrigez-le.</p><hint><p>Les simples variables comme <code>let timeoutID</code> ne « survivent » pas d'un rendu à l'autre, car chaque rendu réexécute votre composant (et donc initialise ses variables) à partir de zéro. Peut-être devriez-vous conserver l'ID du timer ailleurs ?</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isSending<span class="token punctuation">,</span> setIsSending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> timeoutID <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Envoyé !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleUndo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>isSending <span class="token operator">?</span> <span class="token string">'Envoi...'</span> <span class="token operator">:</span> <span class="token string">'Envoyer'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>isSending <span class="token operator">&#x26;&#x26;</span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleUndo<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token maybe-class-name">Annuler</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>Chaque fois que votre composant fait un nouveau rendu (par exemple suite à un changement d'état), toutes les variables locales sont réinitialisées. C'est pourquoi vous ne pouvez pas préserver un ID de timer dans une variable locale comme <code>timeoutID</code> et vous attendre à ce que votre gestionnaire d'événement la « voie » par la suite. Conservez-le plutôt dans une ref, que React préservera d'un rendu à l'autre.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isSending<span class="token punctuation">,</span> setIsSending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> timeoutRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Envoyé !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleUndo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>isSending <span class="token operator">?</span> <span class="token string">'Envoi...'</span> <span class="token operator">:</span> <span class="token string">'Envoyer'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>isSending <span class="token operator">&#x26;&#x26;</span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleUndo<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token maybe-class-name">Annuler</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="re-déclencher-le-rendu-fix-a-component-failing-to-re-render"><h4 id="re-déclencher-le-rendu-fix-a-component-failing-to-re-render">Re-déclencher le rendu {/<em>fix-a-component-failing-to-re-render</em>/}</h4><p>Ce bouton est censé basculer entre un affichage "On" et "Off". Pourtant, il affiche toujours "Off". Quel est le problème ? Corrigez ça.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Toggle</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      isOnRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token operator">!</span>isOnRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOnRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">?</span> <span class="token string">'On'</span> <span class="token operator">:</span> <span class="token string">'Off'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>Dans cet exemple, la valeur actuelle de la ref est utilisée pour calculer le résultat du rendu : <code>{isOnRef.current ? 'On' : 'Off'}</code>. C'est le signe que cette information ne devrait pas figurer dans une ref, mais aurait dû être stockée dans une variable d'état. Pour corriger ça, retirez la ref et remplacez-la par une variable d'état :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Toggle</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOn<span class="token punctuation">,</span> setIsOn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setIsOn</span><span class="token punctuation">(</span><span class="token operator">!</span>isOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOn <span class="token operator">?</span> <span class="token string">'On'</span> <span class="token operator">:</span> <span class="token string">'Off'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="corriger-le-debouncing-fix-debouncing"><h4 id="corriger-le-debouncing-fix-debouncing">Corriger le <em>debouncing</em> {/<em>fix-debouncing</em>/}</h4><p>Dans l'exemple qui suit, tous les gestionnaires de clic des boutons sont <em><a href="https://redd.one/blog/debounce-vs-throttle">"debounced"</a></em>. Pour saisir ce que ça signifie, pressez l'un des boutons. Remarquez que le message apparaît une seconde plus tard. Si vous pressez le bouton pendant que vous attendez le message, le timer sera réinitialisé. Du coup, si vous cliquez en rafale sur le même bouton, le message n'apparaîtra qu'une seconde <em>après</em> que vous aurez arrêté de cliquer. Le <em>debouncing</em> permet de retarder une action jusqu'à ce que l'utilisateur « termine ce qu'il est en train de faire ».<p>Cet exemple fonctionne, mais pas tout à fait comme prévu. Les boutons ne sont pas indépendants. Pour comprendre le problème, cliquez sur l'un des boutons, puis cliquez immédiatement sur un autre bouton. Vous vous attendriez à ce qu'une fois le délai écoulé, vous obteniez les messages des deux boutons. Mais seul le message du dernier bouton apparaît. Celui du premier bouton est perdu.<p>Pourquoi ces boutons interfèrent-ils l'un avec l'autre ? Trouvez et corrigez le problème.</p><hint><p>La variable contenant l'ID du dernier timer en date est partagée par tous les composants <code>DebouncedButton</code>. C'est pour ça que cliquer sur un des boutons réinitialise aussi le timer des autres boutons. Comment stocker un ID de timer distinct pour chaque bouton ?</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> timeoutID<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">DebouncedButton</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onClick<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Dashboard</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Décollage !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Faire</span> décoller le vaisseau
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'À la soupe !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Faire</span> cuire la soupe
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Bonne nuit !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Chanter</span> une berceuse
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><solution><p>Une variable comme <code>timeoutID</code> est partagée par tous les composants, c'est pourquoi cliquer sur le deuxième bouton réinitialise le timer en cours du premier bouton. Pour corriger ça, vous pouvez conserver l'ID de timer dans une ref. Chaque bouton gardera ainsi sa propre ref, et il n'y aura plus de conflit. Essayez de cliquer rapidement sur deux boutons : vous devriez voir les deux messages.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">DebouncedButton</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onClick<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timeoutRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Dashboard</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Décollage !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Faire</span> décoller le vaisseau
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'À la soupe !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Faire</span> cuire la soupe
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Bonne nuit !'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Chanter</span> une berceuse
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="lire-la-dernière-valeur-à-jour-read-the-latest-state"><h4 id="lire-la-dernière-valeur-à-jour-read-the-latest-state">Lire la dernière valeur à jour {/<em>read-the-latest-state</em>/}</h4><p>Dans cet exemple, lorsque vous pressez « Envoyer », un message est affiché après un petit délai. Tapez « bonjour », pressez « Envoyer », puis modifiez rapidement la saisie. Malgré vos changements, le message devrait rester « bonjour » (qui était la valeur de l'état <a href="/learn/state-as-a-snapshot#state-over-time">au moment</a> où vous avez cliqué sur le bouton).<p>D'habitude, c'est bien le comportement que vous souhaitez. Toutefois, il arrive parfois que vous souhaitiez que du code asynchrone lise la <em>dernière</em> version d'une donnée. Avez-vous une idée pour faire que le message affiche la version <em>à jour</em> du champ de saisie, plutôt que celle en vigueur au moment du clic ?</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Envoi : '</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Envoyer</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>L'état fonctionne <a href="/learn/state-as-a-snapshot">comme un instantané</a>, de sorte que vous ne pouvez pas lire le dernier état à jour depuis un traitement asynchrone comme un timer. En revanche, vous pouvez conserver la valeur saisie dans une ref. Une ref est modifiable, donc vous pouvez lire sa propriété <code>current</code> à tout moment. Comme le texte saisi est aussi utilisé pour le rendu, dans cet exemple il vous faudra <em>à la fois</em> une variable d'état (pour le rendu) <em>et</em> une ref (pour la lire depuis le timeout). Vous aurez besoin de mettre à jour la valeur de la ref manuellement.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> textRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Envoi : '</span> <span class="token operator">+</span> textRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Envoyer</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></challenges></section></section>