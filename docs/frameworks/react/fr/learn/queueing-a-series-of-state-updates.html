<!doctype html><html lang="fr"><meta charset="utf-8"><title>Cumuler les mises à jour d’un même état</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="cumuler-les-mises-à-jour-dun-même-état"><h1 id="cumuler-les-mises-à-jour-dun-même-état">Cumuler les mises à jour d’un même état</h1><intro><p>Modifier une variable d'état va planifier un nouveau rendu. Mais parfois vous souhaitez effectuer plusieurs opérations sur la valeur avant de passer au rendu suivant. Pour y parvenir, il est utile de comprendre comment React regroupe les mises à jour d'états en lots.</p></intro><youwilllearn><ul><li>Ce qu'est le « traitement par lots » <em>(batching, NdT)</em> et la façon React s'en sert pour traiter plusieurs mises à jour d'état successives<li>Comment appliquer plusieurs mises à jour d'affilée à la même variable d'état</ul></youwilllearn><section class="level2"aria-labelledby="react-regroupe-les-mises-à-jour-détat-en-lots-react-batches-state-updates"><h2 id="react-regroupe-les-mises-à-jour-détat-en-lots-react-batches-state-updates">React regroupe les mises à jour d'état en lots {/<em>react-batches-state-updates</em>/}</h2><p>Vous vous attendez peut-être à ce que cliquer le bouton « +3 » incrémente le compteur trois fois, parce qu'il appelle <code>setNumber(number + 1)</code> trois fois :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>Pourtant, comme vous vous en souvenez peut-être après avoir lu la page précédente, <a href="/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time">les valeurs d'état de chaque rendu sont figées</a>, de sorte que la valeur de <code>number</code> au sein du gestionnaire d'événement du rendu initial sera toujours <code>0</code>, peu importe le nombre de fois que vous appelez <code>setNumber(1)</code> :<pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Un autre facteur entre cependant en ligne de compte. <strong>React attendra que <em>tout</em> le code de vos gestionnaires d'événements ait été exécuté avant de traiter vos mises à jour d'état.</strong> C'est pourquoi le nouveau rendu ne survient <em>qu'après</em> tous les appels à <code>setNumber()</code>.<p>Ça vous rappelle peut-être la prise de commande par un serveur dans un restaurant. Un serveur ne se précipite pas à la cuisine dès que le premier plat est demandé ! Il vous laisse plutôt terminer votre commande, vous permet de l'ajuster si besoin, et prendra même les commandes des autres convives à la même table.<p>&#x3C;Illustration src./docs/illustrations/i_react-batching.png" alt="Un curseur élégant dans un restaurant passe plusieurs versions de sa commande à React, qui joue le rôle du serveur. Après les multiples appels à setState(), le serveur inscrit le dernier appel comme sa commande définitive." /><p>Ça vous permet de mettre à jour plusieurs variables d'état (même au sein de plusieurs composants) sans déclencher trop de <a href="/learn/render-and-commit#re-renders-when-state-updates">nouveaux rendus</a>. Mais ça signifie aussi que l'interface utilisateur (UI) ne sera mise à jour <em>qu'après</em> que votre gestionnaire d'événement, et tout code qu'il contient, aura terminé son exécution. Ce comportement, connu sous le nom de <strong>traitement par lots</strong> <em>(batching, NdT)</em> permet d'accélérer considérablement votre appli React. Il évite aussi d'avoir à gérer des rendus « pas finis » qui dérouteraient l'utilisateur, si seulement certaines variables étaient mises à jour.<p><strong>React ne crée pas de lots regroupant <em>plusieurs</em> événements intentionnels tels que des clics</strong> : chaque clic est traité séparément. Rassurez-vous, React ne regroupe par lots que lorsque c'est sans danger. Ça garantit par exemple que si le premier clic d'un bouton désactive un formulaire, le second ne pourra pas soumettre à nouveau ce même formulaire.</section><section class="level2"aria-labelledby="mettre-à-jour-un-même-état-plusieurs-fois-avant-le-prochain-rendu-updating-the-same-state-multiple-times-before-the-next-render"><h2 id="mettre-à-jour-un-même-état-plusieurs-fois-avant-le-prochain-rendu-updating-the-same-state-multiple-times-before-the-next-render">Mettre à jour un même état plusieurs fois avant le prochain rendu {/<em>updating-the-same-state-multiple-times-before-the-next-render</em>/}</h2><p>Il s'agit d'un scénario assez inhabituel, mais si vous souhaitiez mettre à jour la même variable d'état plusieurs fois avant le prochain rendu, au lieu de passer <em>la prochaine valeur d'état</em> comme dans <code>setNumber(number + 1)</code>, vous pouvez passer une <em>fonction</em> qui va calculer le prochain état sur base du précédent dans la file des mises à jour, comme dans <code>setNumber(n => n + 1)</code>. C'est une façon de dire à React de « faire un truc avec la valeur de l'état » au lieu de simplement la remplacer.<p>Essayez d'incrémenter le compteur désormais :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>Ici, <code>n => n + 1</code> est ce qu'on appelle une <strong>fonction de mise à jour</strong>. Lorsque vous la passez à une fonction de modification d'état :<ol><li>React met votre fonction en file d'attente, pour la traiter après que tout le reste du code du gestionnaire d'événement aura terminé.<li>Lors du prochain rendu, React traitera toute la file et vous donnera le résultat final des mises à jour.</ol><pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Voici comment React traite ces lignes de code en exécutant le gestionnaire d'événement :<ol><li><code>setNumber(n => n + 1)</code> : <code>n => n + 1</code> est une fonction. React l'ajoute à la file d'attente.<li><code>setNumber(n => n + 1)</code> : <code>n => n + 1</code> est une fonction. React l'ajoute à la file d'attente.<li><code>setNumber(n => n + 1)</code> : <code>n => n + 1</code> est une fonction. React l'ajoute à la file d'attente.</ol><p>Lorsque vous appelez <code>useState</code> lors du rendu suivant, React traite toute la file dans l'ordre. L'état précédent pour <code>number</code> valait <code>0</code>, c'est donc ce que passe React à la première fonction de mise à jour, au travers de son argument <code>n</code>. Puis React prend la valeur renvoyée et la passe en tant que <code>n</code> à la fonction de mise à jour suivante, et ainsi de suite :<table><thead><tr><th>mise à jour en attente<th><code>n</code><th>valeur renvoyée<tbody><tr><td><code>n => n + 1</code><td><code>0</code><td><code>0 + 1 = 1</code><tr><td><code>n => n + 1</code><td><code>1</code><td><code>1 + 1 = 2</code><tr><td><code>n => n + 1</code><td><code>2</code><td><code>2 + 1 = 3</code></table><p>React stocke <code>3</code> comme résultat final et le renvoie depuis <code>useState</code>.<p>C'est pour ça qu'en cliquant sur « +3 » dans l'exemple ci-dessus, on incrémente correctement la valeur par 3.<section class="level3"aria-labelledby="ce-qui-se-passe-si-vous-mettez-à-jour-létat-après-lavoir-remplacé-what-happens-if-you-update-state-after-replacing-it"><h3 id="ce-qui-se-passe-si-vous-mettez-à-jour-létat-après-lavoir-remplacé-what-happens-if-you-update-state-after-replacing-it">Ce qui se passe si vous mettez à jour l'état après l'avoir remplacé {/<em>what-happens-if-you-update-state-after-replacing-it</em>/}</h3><p>Et pour ce gestionnaire d'événement ? Quelle sera selon vous la valeur de <code>number</code> au prochain rendu ?<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Incrémenter</span> le nombre<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>Voici ce que le gestionnaire d'événement demande à React :<ol><li><code>setNumber(number + 5)</code> : <code>number</code> vaut <code>0</code>, donc <code>setNumber(0 + 5)</code>. React ajoute <em>« remplacer par <code>5</code> »</em> dans la file d'attente.<li><code>setNumber(n => n + 1)</code> : <code>n => n + 1</code> est une fonction de mise à jour. React ajoute <em>cette fonction</em> dans la file d'attente.</ol><p>Lors du prochain rendu, React traite la file dans l'ordre :<table><thead><tr><th>mise à jour en attente<th><code>n</code><th>valeur renvoyée<tbody><tr><td>« remplacer par <code>5</code> »<td><code>0</code> (ignoré)<td><code>5</code><tr><td><code>n => n + 1</code><td><code>5</code><td><code>5 + 1 = 6</code></table><p>React stocke <code>6</code> comme résultat final et le renvoie depuis <code>useState</code>.</p><note><p>Vous avez peut-être remarqué que <code>setState(5)</code> revient à faire <code>setState(n => 5)</code>, en ignorant <code>n</code> !</p></note></section><section class="level3"aria-labelledby="ce-qui-se-passe-si-vous-remplacez-létat-après-lavoir-mis-à-jour-what-happens-if-you-replace-state-after-updating-it"><h3 id="ce-qui-se-passe-si-vous-remplacez-létat-après-lavoir-mis-à-jour-what-happens-if-you-replace-state-after-updating-it">Ce qui se passe si vous remplacez l'état après l'avoir mis à jour {/<em>what-happens-if-you-replace-state-after-updating-it</em>/}</h3><p>Allez, encore un exemple. Quelle sera selon vous la valeur de <code>number</code> au prochain rendu ?<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Incrémenter</span> le nombre<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>Voici comment React traite ces lignes de code à l'exécution du gestionnaire d'événement :<ol><li><code>setNumber(number + 5)</code> : <code>number</code> vaut <code>0</code>, donc <code>setNumber(0 + 5)</code>. React ajoute <em>« remplacer par <code>5</code> »</em> dans la file d'attente.<li><code>setNumber(n => n + 1)</code> : <code>n => n + 1</code> est une fonction de mise à jour. React ajoute <em>cette fonction</em> dans la file d'attente.<li><code>setNumber(42)</code> : React ajoute <em>« remplacer par <code>42</code> »</em> dans la file d'attente.</ol><p>Lors du prochain rendu, React traite la file dans l'ordre :<table><thead><tr><th>mise à jour en attente<th><code>n</code><th>valeur renvoyée<tbody><tr><td>« remplacer par <code>5</code> »<td><code>0</code> (ignoré)<td><code>5</code><tr><td><code>n => n + 1</code><td><code>5</code><td><code>5 + 1 = 6</code><tr><td>« remplacer par <code>42</code> »<td><code>6</code> (ignoré)<td><code>42</code></table><p>React stocke alors <code>42</code> comme résultat final et le renvoie depuis <code>useState</code>.<p>En résumé, voici comment interpréter l'argument que vous passez à une fonction de modification d'état comme <code>setNumber</code> :<ul><li><strong>Une fonction de mise à jour</strong> (ex. <code>n => n + 1</code>) est ajoutée à la file d'attente.<li><strong>N'importe quelle autre valeur</strong> (ex. le nombre <code>5</code>) ajoute « remplacer par <code>5</code> » à la file d'attente, ce qui revient à ignorer les étapes précédentes de la file.</ul><p>Après que le gestionnaire d'événement a terminé, React déclenche un nouveau rendu. Durant celui-ci, React traite la file d'attente. Les fonctions de mise à jour sont exécutées lors du rendu, ce qui implique que <strong>les fonctions de mise à jour doivent être <a href="/learn/keeping-components-pure">pures</a></strong> et se contenter de <em>renvoyer</em> leur résultat. N'essayez pas de mettre à jour l'état depuis les fonctions de mise à jour, ou de déclencher quelque autre effet de bord que ce soit. En Mode Strict, React exécutera chaque fonction de mise à jour deux fois (en ignorant le second résultat) pour vous aider à détecter des erreurs.</section><section class="level3"aria-labelledby="conventions-de-nommage-naming-conventions"><h3 id="conventions-de-nommage-naming-conventions">Conventions de nommage {/<em>naming-conventions</em>/}</h3><p>L'usage veut qu'on nomme généralement l'argument d'une fonction de mise à jour d'après les initiales de la variable d'état correspondante :<pre class="language-js"><code class="language-js"><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setLastName</span><span class="token punctuation">(</span><span class="token parameter">ln</span> <span class="token arrow operator">=></span> ln<span class="token punctuation">.</span><span class="token method function property-access">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setFriendCount</span><span class="token punctuation">(</span><span class="token parameter">fc</span> <span class="token arrow operator">=></span> fc <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Si vous préférez du code plus verbeux, une autre convention usuelle consiste à reprendre le nom complet de la variable d'état, comme dans <code>setEnabled(enabled => !enabled)</code> ; on peut aussi ajouter un préfixe comme dans <code>setEnabled(prevEnabled => !prevEnabled)</code>.</p><recap><ul><li>Définir l'état ne change pas la variable du rendu en cours, mais demande un nouveau rendu.<li>React traite les mises à jour d'état après que les gestionnaires d'événements ont fini leur exécution. On parle de traitement par lots.<li>Pour mettre à jour un état plusieurs fois au sein d'un même événement, passez une fonction de mise à jour comme dans <code>setNumber(n => n + 1)</code>.</ul></recap><challenges><section class="level4"aria-labelledby="corriger-un-compteur-de-requêtes-fix-a-request-counter"><h4 id="corriger-un-compteur-de-requêtes-fix-a-request-counter">Corriger un compteur de requêtes {/<em>fix-a-request-counter</em>/}</h4><p>Vous travaillez sur une appli de place de marché artistique qui permet à l'utilisateur d'envoyer plusieurs commandes à la fois pour une même œuvre d'art. Chaque fois que l'utilisateur appuie sur le bouton « Acheter », le compteur « En attente » devrait augmenter de un. Après trois secondes, le compteur « En attente » devrait être décrémenté, et le compteur « Finalisé » devrait augmenter d'autant.<p>Pourtant, le compteur « En attente » ne se comporte pas comme prévu. Lorsque vous appuyez sur « Acheter », il descend à <code>-1</code> (ce qui devrait être impossible !). Et si vous cliquez en rafale, les deux compteurs se comportent bizarrement.<p>Que se passe-t-il ? Corrigez les deux compteurs.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">RequestTracker</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>completed<span class="token punctuation">,</span> setCompleted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span>pending <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span>pending <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCompleted</span><span class="token punctuation">(</span>completed <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token maybe-class-name">En</span> attente <span class="token operator">:</span> <span class="token punctuation">{</span>pending<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token literal-property property">Finalisé</span> <span class="token operator">:</span> <span class="token punctuation">{</span>completed<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Acheter</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>Au sein du gestionnaire d'événement <code>handleClick</code>, les valeurs de <code>pending</code> et <code>completed</code> correspondent à ce qu'elles étaient au moment du clic. Lors du rendu initial, <code>pending</code> était à <code>0</code>, de sorte que <code>setPending(pending - 1)</code> revient à <code>setPending(-1)</code>, un résultat clairement incorrect. Puisque vous souhaitez <em>incrémenter</em> ou <em>décrémenter</em> les compteurs, plutôt que d'en définir les valeurs absolues pendant le clic, préférez passer des fonctions de mise à jour :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">RequestTracker</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>completed<span class="token punctuation">,</span> setCompleted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token arrow operator">=></span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token arrow operator">=></span> p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCompleted</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token maybe-class-name">En</span> attente <span class="token operator">:</span> <span class="token punctuation">{</span>pending<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token literal-property property">Finalisé</span> <span class="token operator">:</span> <span class="token punctuation">{</span>completed<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Acheter</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>Ça garantit que lorsque vous incrémentez ou décrémentez un compteur, vous le faites par rapport à sa <em>dernière</em> valeur en date plutôt que la valeur qu'avait l'état au moment du clic.</p></solution></section><section class="level4"aria-labelledby="implémenter-la-file-dattente-vous-même-implement-the-state-queue-yourself"><h4 id="implémenter-la-file-dattente-vous-même-implement-the-state-queue-yourself">Implémenter la file d'attente vous-même {/<em>implement-the-state-queue-yourself</em>/}</h4><p>Dans ce défi, vous allez réimplémenter une toute petite partie de React à partir de zéro ! Rassurez-vous, ce n'est pas aussi ardu que ça en a l'air.<p>Faites défiler le panneau de prévisualisation du bac à sable. Remarquez qu'il affiche <strong>quatre scénarios de tests</strong>. Ils correspondent aux exemples que vous avez vu plus haut sur cette page. Votre objectif consiste à implémenter la fonction <code>getFinalState</code> pour qu'elle renvoie le résultat correct dans chaque scénario. Si vous l'implémentez correctement, les quatre scénarios de test passeront.<p>Vous recevrez deux arguments : <code>baseState</code> sera l'état initial (ex. <code>0</code>) et la <code>queue</code> sera un tableau contenant un mix de nombres (ex. <code>5</code>) et de fonctions de mise à jour (ex. <code>n => n + 1</code>), dans l'ordre de leurs ajouts.<p>Vous devez renvoyer l'état final, comme dans les tableaux vus sur cette page !</p><hint><p>Si vous êtes coincé·e, commencez par ce squelette de code :<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> update <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: appliquer la fonction de mise à jour</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: remplacer l'état</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>À vous de remplir les blancs !</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token comment">// TODO: faire le nécessaire avec la file...</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getFinalState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./processQueue.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
increment<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'n => n+1'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          increment<span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          increment
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          <span class="token number">42</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TestCase</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  expected
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>État de départ <span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>baseState<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">File </span><span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">{</span>queue<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token constant">R</span>ésultat attendu <span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>expected<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'green'</span> <span class="token operator">:</span>
          <span class="token string">'red'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Votre</span> résultat <span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>actual<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'correct'</span> <span class="token operator">:</span>
          <span class="token string">'wrong'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>Voici l'algorithme exact décrit sur cette page, que React utilise pour calculer l'état final :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> update <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Appliquer la fonction de mise à jour.</span>
      finalState <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>finalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Remplacer le prochain état.</span>
      finalState <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getFinalState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./processQueue.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
increment<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'n => n+1'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          increment<span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          increment
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          <span class="token number">42</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TestCase</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  expected
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>État de départ <span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>baseState<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">File </span><span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">{</span>queue<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token constant">R</span>ésultat attendu <span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>expected<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'green'</span> <span class="token operator">:</span>
          <span class="token string">'red'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Votre</span> résultat <span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>actual<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'correct'</span> <span class="token operator">:</span>
          <span class="token string">'wrong'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>À présent vous savez comment fonctionne cette partie de React !</p></solution><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></challenges></section></section></section>