<!doctype html><html lang="fr"><meta charset="utf-8"><title>renderToReadableStream</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="rendertoreadablestream"><h1 id="rendertoreadablestream">renderToReadableStream</h1><intro><p><code>renderToReadableStream</code> fait le rendu d'un arbre React dans un <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">flux Readable Web Stream</a>.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span>reactNode<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><note><p>Cette API dépend des <a href="https://developer.mozilla.org/fr/docs/Web/API/Streams_API">Web Streams</a>. Pour Node.js, utilisez plutôt <a href="/reference/react-dom/server/renderToPipeableStream"><code>renderToPipeableStream</code></a>.</p></note><section class="level2"aria-labelledby="référence-reference"><h2 id="référence-reference">Référence {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="rendertoreadablestreamreactnode-options-rendertoreadablestream"><h3 id="rendertoreadablestreamreactnode-options-rendertoreadablestream"><code>renderToReadableStream(reactNode, options?)</code> {/<em>rendertoreadablestream</em>/}</h3><p>Appelez <code>renderToReadableStream</code> pour faire le rendu HTML d'un arbre React au moyen d'un <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">flux Readable Web Stream</a>.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToReadableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Côté client, appelez <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a> pour rendre interactif ce HTML généré côté serveur.<p><a href="#usage">Voir d'autres exemples ci-dessous</a>.<section class="level4"aria-labelledby="paramètres-parameters"><h4 id="paramètres-parameters">Paramètres {/<em>parameters</em>/}</h4><ul><li><p><code>reactNode</code> : un nœud React dont vous souhaitez produire le HTML. Ça pourrait par exemple être un élément JSX tel que <code>&#x3C;App /></code>. C'est censé produire le document entier, de sorte que le composant <code>App</code> devrait produire la balise <code>&#x3C;html></code>.<li><p><code>options</code> <strong>optionnelles</strong> : un objet avec des options de streaming.<ul><li><code>bootstrapScriptContent</code> <strong>optionnel</strong> : s'il est fourni, ce code source sera placé dans une balise <code>&#x3C;script></code> en ligne du flux de sortie.<li><code>bootstrapScripts</code> <strong>optionnels</strong> : un tableau d'URL sous format texte pour des balises <code>&#x3C;script></code> à émettre dans la page. Utilisez-le pour inclure le <code>&#x3C;script></code> qui appellera <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a>. Vous pouvez vous en passer si vous ne souhaitez pas exécuter React côté client.<li><code>bootstrapModules</code> <strong>optionnels</strong> : joue le même rôle que <code>bootstrapScripts</code>, mais émet plutôt des balises <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Guide/Modules"><code>&#x3C;script type="module"></code></a>.<li><code>identifierPrefix</code> <strong>optionnel</strong> : un préfixe textuel utilisé pour les ID générés par <a href="/reference/react/useId"><code>useId</code></a>. Pratique pour éviter les conflits entre les ID au sein de racines multiples sur une même page. Doit être le même préfixe que celui passé à<a href="/reference/react-dom/client/hydrateRoot#parameters"><code>hydrateRoot</code></a>.<li><code>namespaceURI</code> <strong>optionnel</strong> : l'URI textuel de <a href="https://developer.mozilla.org/fr/docs/Web/API/Document/createElementNS#uri_despaces_de_nom_valides">l'espace de noms racine</a> pour le flux. Par défaut, celui du HTML standard. Passez <code>'http://www.w3.org/2000/svg'</code> pour SVG ou <code>'http://www.w3.org/1998/Math/MathML'</code> pour MathML.<li><code>nonce</code> <strong>optionnel</strong> : un <a href="https://developer.mozilla.org/fr/docs/Web/HTML/Element/script#nonce"><code>nonce</code></a> textuel pour permettre les scripts avec une <a href="https://developer.mozilla.org/fr/docs/Web/HTTP/Headers/Content-Security-Policy/script-src"><em>Content-Security-Policy</em> contenant <code>script-src</code></a>.<li><code>onError</code> <strong>optionnelle</strong> : une fonction de rappel déclenchée pour toute erreur serveur, qu'elle soit <a href="#recovering-from-errors-outside-the-shell">récupérable</a> ou <a href="#recovering-from-errors-inside-the-shell">pas</a>. Par défaut, ça fait juste un <code>console.error</code>. Si vous l'écrasez pour <a href="#logging-crashes-on-the-server">journaliser les rapports de plantage</a>, assurez-vous de continuer à appeler <code>console.error</code>. Vous pouvez aussi vous en servir pour <a href="#setting-the-status-code">ajuster le code de réponse HTTP</a> avant que l'enveloppe ne soit émise.<li><code>progressiveChunkSize</code> <strong>optionnel</strong> : le nombre d'octets dans un segment d'envoi progressif. <a href="https://github.com/facebook/react/blob/14c2be8dac2d5482fda8a0906a31d239df8551fc/packages/react-server/src/ReactFizzServer.js#L210-L225">Apprenez-en davantage sur l'heuristique par défaut</a>.<li><code>signal</code> <strong>optionnel</strong> : un <a href="https://developer.mozilla.org/fr/docs/Web/API/AbortSignal"><code>AbortSignal</code></a> qui vous permettra <a href="#aborting-server-rendering">d'abandonner le rendu côté serveur</a> pour faire le reste du rendu côté client.</ul></ul></section><section class="level4"aria-labelledby="valeur-renvoyée-returns"><h4 id="valeur-renvoyée-returns">Valeur renvoyée {/<em>returns</em>/}</h4><p><code>renderToReadableStream</code> renvoie une promesse (<code>Promise</code>) :<ul><li>Si le rendu de <a href="#specifying-what-goes-into-the-shell">l'enveloppe</a> réussit, cette promesse s'accomplira avec un <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">flux Readable Web Stream</a>.<li>Si le rendu de l'enveloppe échoue, cette promesse sera rejetée. <a href="#recovering-from-errors-inside-the-shell">Utilisez ce scénario pour produire une enveloppe de secours</a>.</ul><p>Le flux obtenu expose une propriété complémentaire :<ul><li><code>allReady</code> : une promesse qui s'accomplira lorsque le rendu sera complètement terminé, y compris l'<a href="#specifying-what-goes-into-the-shell">enveloppe</a> et tout le <a href="#streaming-more-content-as-it-loads">contenu</a> additionnel. Vous pouvez faire un <code>await stream.allReady</code> avant de renvoyer une réponse <a href="#waiting-for-all-content-to-load-for-crawlers-and-static-generation">pour les moteurs d'indexation web et la génération statique</a>. Si vous optez pour cette approche, vous n'aurez pas de chargement progressif. Le flux contiendra le HTML final.</ul></section></section></section><section class="level2"aria-labelledby="utilisation-usage"><h2 id="utilisation-usage">Utilisation {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="faire-le-rendu-dun-arbre-react-sous-forme-html-au-moyen-dun-flux-readable-web-stream-rendering-a-react-tree-as-html-to-a-readable-web-stream"><h3 id="faire-le-rendu-dun-arbre-react-sous-forme-html-au-moyen-dun-flux-readable-web-stream-rendering-a-react-tree-as-html-to-a-readable-web-stream">Faire le rendu d'un arbre React sous forme HTML au moyen d'un flux Readable Web Stream {/<em>rendering-a-react-tree-as-html-to-a-readable-web-stream</em>/}</h3><p>Appelez <code>renderToReadableStream</code> pour faire le rendu d'un arbre React sous forme HTML dans un <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">flux Readable Web Stream</a> :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToReadableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>En plus du<codestep step="{1}">composant racine</codestep>, vous devrez fournir une liste des<codestep step="{2}">chemins de <code>&#x3C;script></code> de démarrage</codestep>. Votre composant racine doit renvoyer <strong>le document intégral, donc la balise <code>&#x3C;html></code> racine</strong>.<p>Il pourrait par exemple ressembler à ça :<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html lang<span class="token operator">=</span><span class="token string">"fr"</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta charSet<span class="token operator">=</span><span class="token string">"utf-8"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/styles.css"</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>title<span class="token operator">></span><span class="token maybe-class-name">Mon</span> appli<span class="token operator">&#x3C;</span><span class="token operator">/</span>title<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>body<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Router</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>body<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React injectera le <a href="https://developer.mozilla.org/fr/docs/Glossary/Doctype">doctype</a> et vos<codestep step="{2}">balises <code>&#x3C;script></code> de démarrage</codestep>dans le flux HTML résultant :<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&#x3C;!-- ... HTML de vos composants ... --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/main.js<span class="token punctuation">"</span></span> <span class="token attr-name">async</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>Côté client, votre script de démarrage devrait <a href="/reference/react-dom/client/hydrateRoot#hydrating-an-entire-document">hydrater le <code>document</code> entier avec un appel à <code>hydrateRoot</code></a> :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Ça attachera les gestionnaires d'événements au HTML généré côté serveur pour le rendre interactif.</p><deepdive><section class="level4"aria-labelledby="lire-les-chemins-de-ressources-css-et-js-depuis-la-sortie-du-build-reading-css-and-js-asset-paths-from-the-build-output"><h4 id="lire-les-chemins-de-ressources-css-et-js-depuis-la-sortie-du-build-reading-css-and-js-asset-paths-from-the-build-output">Lire les chemins de ressources CSS et JS depuis la sortie du <em>build</em> {/<em>reading-css-and-js-asset-paths-from-the-build-output</em>/}</h4><p>Les URL finales de ressources (telles que les fichiers JavaScript et CSS) contiennent souvent une empreinte générée par le <em>build</em> Par exemple, plutôt que <code>styles.css</code>, vous pourriez vous retrouver avec <code>styles.123456.css</code>. L'injection d'empreinte dans les noms de fichiers des ressources statiques garantit que chaque nouveau <em>build</em> d'une même ressource aura un nom différent (si son contenu a changé). C'est pratique pour mettre en place sans danger des stratégies de cache à long terme pour les ressources statiques : un fichier avec un nom donné ne changera jamais de contenu.<p>Seulement voilà, si vous ne connaissez pas les URL des ressources avant la fin du <em>build</em>, vous n'avez aucun moyen de les mettre dans votre code source. Par exemple, ça ne servirait à rien de coder en dur <code>"/styles.css"</code> dans votre JSX, comme dans le code vu plus haut. Pour garder les noms finaux hors de votre code source, votre composant racine peut lire les véritables noms depuis une table de correspondance qui lui serait passée en prop :<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> assetMap <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token spread operator">...</span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">[</span><span class="token string">'styles.css'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token spread operator">...</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token spread operator">...</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Côté serveur, faites le rendu de <code>&#x3C;App assetMap={assetMap} /></code> et passez-lui une <code>assetMap</code> avec les URL des ressources :<pre class="language-js"><code class="language-js"><span class="token comment">// Vous devrez récupérer ce JSON depuis votre outil de build,</span>
<span class="token comment">// par exemple en lisant son affichage résultat.</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Dans la mesure où votre serveur fait désormais le rendu de <code>&#x3C;App assetMap={assetMap} /></code>, vous devez lui passer cette <code>assetMap</code> côté client aussi, pour éviter toute erreur lors de l'hydratation. Vous pouvez la sérialiser et la passer au client comme ceci :<pre class="language-js"><code class="language-js"><span class="token comment">// Vous récupérereriez ce JSON depuis votre outil de build.</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// Attention : on peut stringify() ça sans danger parce que ça ne vient pas des utilisateurs.</span>
    <span class="token literal-property property">bootstrapScriptContent</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">window.assetMap = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>assetMap<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Dans l'exemple ci-dessus, l'option <code>bootstrapScriptContent</code> ajoute une balise <code>&#x3C;script></code> en ligne complémentaire qui définit la variable globale <code>window.assetMap</code> côté client. Ça permet au code client de lire la même <code>assetMap</code> :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">assetMap</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>À présent le client comme le serveur font le rendu d'<code>App</code> avec la même prop <code>assetMap</code>, on n'a donc pas d'erreur d'hydratation.</section></deepdive></section><section class="level3"aria-labelledby="streamer-plus-de-contenu-au-fil-du-chargement-streaming-more-content-as-it-loads"><h3 id="streamer-plus-de-contenu-au-fil-du-chargement-streaming-more-content-as-it-loads">Streamer plus de contenu au fil du chargement {/<em>streaming-more-content-as-it-loads</em>/}</h3><p>Le streaming permet à l'utilisateur de commencer à voir votre contenu avant même que toutes les données soient chargées côté serveur. Imaginez par exemple une page de profil qui affiche une image de couverture, une barre latérale avec des ami·e·s et leurs photos, et une liste d'articles :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Imaginez que le chargement des données de <code>&#x3C;Posts /></code> prenne du temps. Dans l'idéal, vous aimeriez afficher le reste du contenu de la page profil à l'utilisateur, sans le forcer à attendre d'abord les articles. Pour y parvenir, <a href="/reference/react/Suspense#displaying-a-fallback-while-content-is-loading">enrobez <code>Posts</code> dans un périmètre <code>&#x3C;Suspense></code></a> :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Ça demande à React de commencer à streamer le HTML avant que <code>Posts</code> ne charge ses données. React enverra dans un premier temps le HTML du contenu de secours (<code>PostsGlimmer</code>) puis, quand <code>Posts</code> aura fini de charger ses données, React enverra le HTML restant ainsi qu'une balise <code>&#x3C;script></code> intégrée qui remplacera le contenu de secours avec ce HTML. Du point de vue de l'utilisateur, la page apparaîtra d'abord avec le <code>PostsGlimmer</code>, qui sera ensuite remplacé par les <code>Posts</code>.<p>Vous pouvez même <a href="/reference/react/Suspense#revealing-nested-content-as-it-loads">imbriquer les périmètres <code>&#x3C;Suspense></code></a> afin de créer des séquences de chargement avec une granularité plus fine :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Dans cet exemple, React commencera à streamer la page encore plus tôt. Seuls <code>ProfileLayout</code> et <code>ProfileCover</code> devront d'abord terminer leur rendu, car ils ne sont enrobés dans aucun périmètre <code>&#x3C;Suspense></code>. En revanche, si <code>Sidebar</code>, <code>Friends</code> ou <code>Photos</code> ont besoin de charger des données, React enverra le HTML du contenu de secours <code>BigSpinner</code> à leur place. Ainsi, au fil de la mise à disposition des données, davantage de contenu continuera à être affiché jusqu'à ce que tout soit enfin visible.<p>Le streaming n'a pas besoin d'attendre que React lui-même soit chargé dans le navigateur, ou que votre appli soit devenue interactive. Le contenu HTML généré côté serveur sera envoyé et affiché progressivement avant le chargement de n'importe quelle balise <code>&#x3C;script></code>.<p><a href="https://github.com/reactwg/react-18/discussions/37">Apprenez-en davantage sur le fonctionnement du streaming HTML</a>.</p><note><p><strong>Seules les sources de données compatibles Suspense activeront le composant Suspense.</strong> Elles comprennent :<ul><li>Le chargement de données fourni par des frameworks intégrant Suspense tels que <a href="https://relay.dev/docs/guided-tour/rendering/loading-states/">Relay</a> et <a href="https://nextjs.org/docs/getting-started/react-essentials">Next.js</a><li>Le chargement à la demande du code de composants avec <a href="/reference/react/lazy"><code>lazy</code></a><li>La lecture de la valeur d'une promesse avec <a href="/reference/react/use"><code>use</code></a></ul><p>Suspense <strong>ne détecte pas</strong> le chargement de données depuis un Effet ou un gestionnaire d'événement.<p>Les modalités exactes de votre chargement de données dans le composant <code>Posts</code> ci-dessus dépenderont de votre framework. Si vous utilisez un framework intégrant Suspense, vous trouverez tous les détails dans sa documentation sur le chargement de données.<p>Le chargement de données compatible avec Suspense sans recourir à un framework spécifique n'est pas encore pris en charge. Les spécifications d'implémentation d'une source de données intégrant Suspense sont encore instables et non documentées. Une API officielle pour intégrer les sources de données avec Suspense sera publiée dans une future version de React.</p></note></section><section class="level3"aria-labelledby="spécifier-le-contenu-de-lenveloppe-specifying-what-goes-into-the-shell"><h3 id="spécifier-le-contenu-de-lenveloppe-specifying-what-goes-into-the-shell">Spécifier le contenu de l'enveloppe {/<em>specifying-what-goes-into-the-shell</em>/}</h3><p>La partie de votre appli à l'extérieur de tout périmètre <code>&#x3C;Suspense></code> est appelée <em>l'enveloppe</em> :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Elle détermine le tout premier état de chargement que vos utilisateurs sont susceptibles de voir :<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span></code></pre><p>Si vous enrobez toute l'appli dans un périmètre <code>&#x3C;Suspense></code> à la racine, l'enveloppe ne contiendra qu'un indicateur de chargement. Ce n'est hélas pas une expérience utilisateur agréable, car voir un gros indicateur de chargement à l'écran peut sembler plus lent et plus irritant que d'attendre un instant pour voir arriver la véritable mise en page. C'est pourquoi vous voudrez généralement positionner vos périmètres <code>&#x3C;Suspense></code> de façon à ce que l'enveloppe donne une impression <em>minimale mais complète</em> — comme si elle représentait un squelette intégral de la page.<p>Un appel asynchrone à <code>renderToReadableStream</code> s'accomplira avec un <code>stream</code> lorsque l'enveloppe entière a fini son rendu. C'est généralement là que vous commencerez le streaming en créant puis renvoyant une réponse basée sur le <code>stream</code> :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Lorsque la réponse basée sur le <code>stream</code> est renvoyée, les composants à l'intérieur des périmètres <code>&#x3C;Suspense></code> peuvent encore être en train de charger leurs données.</section><section class="level3"aria-labelledby="journaliser-les-plantages-côté-serveur-logging-crashes-on-the-server"><h3 id="journaliser-les-plantages-côté-serveur-logging-crashes-on-the-server">Journaliser les plantages côté serveur {/<em>logging-crashes-on-the-server</em>/}</h3><p>Par défaut, toutes les erreurs côté serveur sont affichées dans la console. Vous pouvez remplacer ce comportement pour journaliser vos rapports de plantage :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Si vous fournissez votre propre implémentation pour <code>onError</code>, n'oubliez pas de continuer à afficher les erreurs en console, comme ci-dessus.</section><section class="level3"aria-labelledby="se-rétablir-après-une-erreur-dans-lenveloppe-recovering-from-errors-inside-the-shell"><h3 id="se-rétablir-après-une-erreur-dans-lenveloppe-recovering-from-errors-inside-the-shell">Se rétablir après une erreur dans l'enveloppe {/<em>recovering-from-errors-inside-the-shell</em>/}</h3><p>Dans l'exemple ci-dessous, l'enveloppe contient <code>ProfileLayout</code>, <code>ProfileCover</code> et <code>PostsGlimmer</code> :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Si une erreur survient lors du rendu de ces composants, React n'aura pas de HTML exploitable à envoyer au client. Enrobez votre appel à <code>renderToReadableStream</code> dans un <code>try...catch</code> pour envoyer en dernier recours un HTML de secours qui n'aurait pas besoin d'un rendu côté serveur :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Ça sent le pâté…&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Si une erreur est survenue lors de la génération de l'enveloppe, tant <code>onError</code> que votre bloc <code>catch</code> seront déclenchés. Utilisez <code>onError</code> pour signaler l'erreur et votre bloc <code>catch</code> pour envoyer le document HTML de secours. Votre HTML de secours n'est d'ailleurs pas nécessairement une page d'erreur. Vous pourriez plutôt proposer une enveloppe alternative qui affiche votre appli en mode 100% client.</section><section class="level3"aria-labelledby="se-rétablir-après-une-erreur-hors-de-lenveloppe-recovering-from-errors-outside-the-shell"><h3 id="se-rétablir-après-une-erreur-hors-de-lenveloppe-recovering-from-errors-outside-the-shell">Se rétablir après une erreur hors de l'enveloppe {/<em>recovering-from-errors-outside-the-shell</em>/}</h3><p>Dans l'exemple qui suit, le composant <code>&#x3C;Posts /></code> est enrobé par <code>&#x3C;Suspense></code>, ce qui signifie qu'il ne fait <em>pas</em> partie de l'enveloppe :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Si une erreur survient au sein du composant <code>Posts</code> ou d'un de ses enfants, React <a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-client-only-content">tentera automatiquement de retomber sur ses pieds</a> :<ol><li>Il émettra le contenu de secours du périmètre <code>&#x3C;Suspense></code> le plus proche (<code>PostsGlimmer</code>) dans le HTML.<li>Il « laissera tomber » le rendu côté serveur du contenu de <code>Posts</code>.<li>Lorsque le code JavaScript côté client aura fini de charger, React <em>retentera</em> le rendu de <code>Posts</code>, côté client.</ol><p>Si la tentative de rendu de <code>Posts</code> côté client plante <em>aussi</em>, React lèvera l'erreur côté client. Comme pour toutes les erreurs survenant lors du rendu, le <a href="/reference/react/Component#static-getderivedstatefromerror">périmètre d'erreur le plus proche</a> détermine la façon dont l'erreur sera présentée à l'utilisateur. En pratique, ça signifie que l'utilisateur verra un indicateur de chargement jusqu'à ce que React soit certain que l'erreur n'est pas récupérable.<p>Si la tentative de rendu de <code>Posts</code> côté client réussit, l'indicateur de chargement issu du serveur sera remplacé par le résultat du rendu côté client. L'utilisateur ne saura pas qu'une erreur est survenue côté serveur. En revanche, les fonctions de rappel <code>onError</code> côté serveur et <a href="/reference/react-dom/client/hydrateRoot#hydrateroot"><code>onRecoverableError</code></a> côté client seront déclenchées pour que vous soyez notifié·e de l'erreur.</section><section class="level3"aria-labelledby="définir-le-code-de-réponse-http-setting-the-status-code"><h3 id="définir-le-code-de-réponse-http-setting-the-status-code">Définir le code de réponse HTTP {/<em>setting-the-status-code</em>/}</h3><p>Le streaming implique des compromis. Vous souhaitez commencer à streamer la page aussitôt que possible, pour que l'utilisateur voie du contenu plus tôt. Seulement, dès que vous commencer à streamer, vous ne pouvez plus définir le code de réponse HTTP.<p>En <a href="#specifying-what-goes-into-the-shell">découpant votre appli</a> avec d'un côté l'enveloppe (au-dessus de tous les périmètres <code>&#x3C;Suspense></code>) et de l'autre le reste du contenu, vous avez déjà en partie résolu ce problème. Si l'enveloppe rencontre une erreur, ça exécutera votre bloc <code>catch</code> qui vous permettra de définir le code de réponse pour l'erreur. Dans le cas contraire, vous savez que l'appli devrait être capable de se rétablir côté client, vous pouvez donc envoyer « OK ».<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Ça sent le pâté…&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Si un composant <em>hors</em> de l'enveloppe (par exemple dans un périmètre <code>&#x3C;Suspense></code>) lève une erreur, React n'arrêtera pas le rendu. Ça signifie que la fonction de rappel <code>onError</code> sera déclenchée, mais votre code continuera à s'exécuter sans entrer dans le bloc <code>catch</code>. C'est parce que React tentera de retomber sur ses pieds côté client, <a href="#recovering-from-errors-outside-the-shell">comme décrit plus haut</a>.<p>Ceci étant dit, si vous préférez, vous pouvez prendre en compte la survenue d'une erreur pour ajuster votre code de réponse HTTP :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Ça sent le pâté…&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Ça ne capturera que les erreurs hors de l'enveloppe qui sont survenues pendant le rendu initial de l'enveloppe, ce n'est donc pas exhaustif. Si vous estimez impératif de savoir si une erreur est survenue pour un contenu donné, vous pouvez le déplacer dans l'enveloppe.</section><section class="level3"aria-labelledby="différencier-la-gestion-selon-lerreur-rencontrée-handling-different-errors-in-different-ways"><h3 id="différencier-la-gestion-selon-lerreur-rencontrée-handling-different-errors-in-different-ways">Différencier la gestion selon l'erreur rencontrée {/<em>handling-different-errors-in-different-ways</em>/}</h3><p>Vous pouvez <a href="https://fr.javascript.info/custom-errors">créer vos propres sous-classes d'<code>Error</code></a> et utiliser l'opérateur <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Operators/instanceof"><code>instanceof</code></a> pour déterminer quelle erreur est survenue. Vous pouvez par exemple définir une <code>NotFoundError</code> sur-mesure et la lever depuis votre composant. À partir de là, vous pouvez sauvegarder l'erreur dans <code>onError</code> pour différencier ensuite votre gestion en fonction du type d'erreur :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> caughtError <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>didError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>caughtError <span class="token keyword">instanceof</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token number">500</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        caughtError <span class="token operator">=</span> error<span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Ça sent le pâté…&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Gardez à l'esprit qu'une fois que vous avez émis l'enveloppe et commencé à streamer, vous ne pourrez plus changer le code de réponse HTTP.</section><section class="level3"aria-labelledby="attendre-que-tout-le-contenu-soit-chargé-pour-les-moteurs-dindexation-web-et-la-génération-statique-waiting-for-all-content-to-load-for-crawlers-and-static-generation"><h3 id="attendre-que-tout-le-contenu-soit-chargé-pour-les-moteurs-dindexation-web-et-la-génération-statique-waiting-for-all-content-to-load-for-crawlers-and-static-generation">Attendre que tout le contenu soit chargé pour les moteurs d'indexation web et la génération statique {/<em>waiting-for-all-content-to-load-for-crawlers-and-static-generation</em>/}</h3><p>Le streaming offre une meilleure expérience utilisateur parce que l'utilisateur peut voir le contenu au fur et à mesure de sa mise à disposition.<p>Ceci étant, lorsqu'un moteur d'indexation web visite votre page, ou si vous générez ces pages au moment du <em>build</em>, vous pourriez vouloir attendre que tout le contenu soit d'abord chargé pour ensuite produire le résultat HTML final, plutôt que de le révéler progressivement.<p>Vous pouvez attendre que tout le contenu soit disponible en attendant la promesse <code>stream.allReady</code> :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> isCrawler <span class="token operator">=</span> <span class="token comment">// ... dépend de votre stratégie de détection de bot ...</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isCrawler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">await</span> stream<span class="token punctuation">.</span><span class="token property-access">allReady</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Ça sent le pâté…&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Un visiteur normal recevra le flux de contenu chargé progressivement. Un moteur d'indexation web recevra le résultat HTML final, une fois toutes les données chargées. Ça signifie cependant que ce moteur devra attendre <em>toutes</em> les données, dont certaines peuvent être lentes à charger ou causer une erreur. Selon la nature de votre appli, vous pourriez choisir d'envoyer juste l'enveloppe aux moteurs d'indexation web.</section><section class="level3"aria-labelledby="abandonner-le-rendu-côté-serveur-aborting-server-rendering"><h3 id="abandonner-le-rendu-côté-serveur-aborting-server-rendering">Abandonner le rendu côté serveur {/<em>aborting-server-rendering</em>/}</h3><p>Vous pouvez forcer le rendu côté serveur à « laisser tomber » au bout d'un certain temps :<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      controller<span class="token punctuation">.</span><span class="token method function property-access">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">signal</span><span class="token operator">:</span> controller<span class="token punctuation">.</span><span class="token property-access">signal</span><span class="token punctuation">,</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span></code></pre><p>React enverra les contenus de secours restants en HTML puis tentera de faire la fin du rendu côté client. <span style="float:footnote"><a href="../../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>