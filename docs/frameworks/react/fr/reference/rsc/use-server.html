<!doctype html><html lang="fr"><meta charset="utf-8"><title>"'use server'"</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="use-server"><h1 id="use-server">"'use server'"</h1><p>titleForTitleTag: "Directive 'use server'" canary: true</p><canary><p><code>'use server'</code> n'est utile que si vous <a href="/learn/start-a-new-react-project#bleeding-edge-react-frameworks">utilisez React Server Components</a> ou créez une bibliothèque compatible avec eux.</p></canary><intro><p><code>'use server'</code> marque les fonctions côté serveur qui peuvent être appelées par du code React côté client.</p></intro><inlinetoc><section class="level2"aria-labelledby="référence-reference"><h2 id="référence-reference">Référence {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="use-server-use-server"><h3 id="use-server-use-server"><code>'use server'</code> {/<em>use-server</em>/}</h3><p>Ajoutez <code>'use server';</code> tout en haut d'une fonction asynchrone pour indiquer que cette fonction peut être appelée par du code côté client. Nous appelons ces fonctions des <em>Actions Serveur</em>.<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use server'</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Lorsque vous appelez une Action Serveur côté client, elle fait une requête réseau auprès du serveur en incluant une copie sérialisée des arguments que vous avez passés. Si l'Action Serveur renvoie une valeur, cette valeur sera sérialisée puis renvoyée au client.<p>Plutôt que de marquer chaque fonction concernée avec <code>'use server'</code>, vous pouvez ajouter cette directive tout en haut d'un fichier afin d'en marquer tous les exports comme des Actions Serveur utilisables n'importe où, y compris au travers d'imports par du code client.<section class="level4"aria-labelledby="limitations-caveats"><h4 id="limitations-caveats">Limitations {/<em>caveats</em>/}</h4><ul><li><code>'use server'</code> doit être placé au tout début de la fonction ou du module concerné ; au-dessus notamment de tout code, y compris les imports (mais il peut y avoir des commentaires avant les directives). La directive doit utiliser des apostrophes (<code>'</code>) ou guillemets (<code>"</code>), mais pas des <em>backticks</em> (<code>`</code>).<li><code>'use server'</code> ne peut être utilisé qu'au sein de fichiers côté serveur. Les Actions Serveur résultantes peuvent être passées à des Composants Client au moyen des props. Consultez la liste des <a href="#serializable-parameters-and-return-values">types sérialisables</a>.<li>Pour importer une Action Serveur depuis du <a href="/reference/rsc/use-client">code côté client</a>, la directive doit obligatoirement être utilisée au niveau du module.<li>Dans la mesure où les appels réseau sous-jacents sont forcément asynchrones, <code>'use server'</code> n'est utilisable qu'au sein de fonctions asynchrones.<li>Considérez toujours les arguments de vos Actions Serveur comme des données non validées, et soumettez toute mutation à un processus d'autorisation. Allez voir les <a href="#security">considérations sécuritaires</a>.<li>Les Actions Serveur devraient toujours être appelées au sein d'une <a href="/reference/react/useTransition">Transition</a>. Les Actions Serveur passées à <a href="/reference/react-dom/components/form#props"><code>&#x3C;form action></code></a> ou <a href="/reference/react-dom/components/input#props"><code>formAction</code></a> seront automatiquement enrobées par une transition.<li>Les Actions Serveur sont conçues pour des mutations qui mettent à jour l'état côté serveur ; il est déconseillé de s'en servir pour du simple chargement de données. Dans cet esprit, les frameworks qui implémentent les Actions Serveur traitent généralement une action à la fois et ne permettent pas la mise en cache de leur valeur renvoyée.</ul></section></section><section class="level3"aria-labelledby="considérations-sécuritaires-security"><h3 id="considérations-sécuritaires-security">Considérations sécuritaires {/<em>security</em>/}</h3><p>Les arguments passés aux Actions Serveur sont entièrement contrôlés par le côté client. Pour des raisons de sécurité, traitez-les toujours comme des données non validées, et assurez-vous d'en vérifier la structure et le contenu, et de procéder à leur échappement lorsque c'est nécessaire.<p>Par ailleurs, et quelle que soit l'Action Serveur, assurez-vous toujours que l'utilisateur authentifié a le droit d'effectuer cette action.</p><wip><p>Pour éviter le renvoi de données sensibles par une Action Serveur, nous proposons des API expérimentales empêchant l'envoi vers du code côté client de valeurs et objets uniques « ternis ».<p>Allez jeter un coup d'œil à <a href="/reference/react/experimental_taintUniqueValue">experimental_taintUniqueValue</a> et <a href="/reference/react/experimental_taintObjectReference">experimental_taintObjectReference</a>.</p></wip></section><section class="level3"aria-labelledby="arguments-et-valeurs-renvoyées-sérialisables-serializable-parameters-and-return-values"><h3 id="arguments-et-valeurs-renvoyées-sérialisables-serializable-parameters-and-return-values">Arguments et valeurs renvoyées sérialisables {/<em>serializable-parameters-and-return-values</em>/}</h3><p>Lorsque du code côté client appelle l'Action Serveur au travers du réseau, tout argument passé aura besoin d'être sérialisé.<p>Voici les types pris en charge pour les arguments d'une Action Serveur :<ul><li>Types primitifs<ul><li><a href="https://developer.mozilla.org/fr/docs/Glossary/String">string</a><li><a href="https://developer.mozilla.org/fr/docs/Glossary/Number">number</a><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/BigInt">bigint</a><li><a href="https://developer.mozilla.org/fr/docs/Glossary/Boolean">boolean</a><li><a href="https://developer.mozilla.org/fr/docs/Glossary/Undefined">undefined</a><li><a href="https://developer.mozilla.org/fr/docs/Glossary/Null">null</a><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Symbol">symbol</a>, mais uniquement pour ceux inscrits auprès du référentiel global de symboles <em>via</em> <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Symbol/for"><code>Symbol.for</code></a></ul><li>Les itérables contenant des valeurs sérialisables<ul><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/String">String</a><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Array">Array</a><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Set">Set</a><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">TypedArray</a> et <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a></ul><li><a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Date">Date</a><li>Les instances de <a href="https://developer.mozilla.org/fr/docs/Web/API/FormData">FormData</a><li>Les <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Object">objets</a> bruts : ceux créés via des <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Operators/Object_initializer">initialiseurs d'objets</a>, dont les propriétés sont sérialisables<li>Les fonctions qui sont des Actions Serveur<li>Les <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Promise">promesses</a></ul><p>En particulier, les types suivants ne sont <strong>pas</strong> pris en charge :<ul><li>Les éléments React, ainsi que <a href="/learn/writing-markup-with-jsx">JSX</a><li>Les fonctions, y compris les fonctions composants, et de façon plus générale toute fonction qui ne serait pas une Action Serveur<li>Les <a href="https://developer.mozilla.org/fr/docs/Learn/JavaScript/Objects/Classes_in_JavaScript">classes</a><li>Les objets de quelque classe que ce soit (hormis les classes natives explicitement listées plus haut) ainsi que les objets ayant <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object#null-prototype_objects">un prototype nul</a><li>Les symboles non inscrits au global, ex. <code>Symbol('my new symbol')</code></ul><p>Les valeurs renvoyées sérialisables sont les mêmes que pour les <a href="/reference/rsc/use-client#passing-props-from-server-to-client-components">props sérialisables</a> d'un Composant Client agissant comme « point de césure » entre le code côté client et le code côté serveur.</section></section><section class="level2"aria-labelledby="utilisation-usage"><h2 id="utilisation-usage">Utilisation {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="les-actions-serveur-dans-les-formulaires-server-actions-in-forms"><h3 id="les-actions-serveur-dans-les-formulaires-server-actions-in-forms">Les Actions Serveur dans les formulaires {/<em>server-actions-in-forms</em>/}</h3><p>Le cas le plus courant d'Actions Serveur consiste à appeler des fonctions côté serveur pour modifier des données. Dans le navigateur, on utilise traditionnellement <a href="https://developer.mozilla.org/fr/docs/Web/HTML/Element/form">l'élément HTML <code>form</code></a> pour permettre à l'utilisateur de demander une mutation de données. Avec les React Server Components, React prend désormais pleinement en charge les Actions Serveur dans les <a href="/reference/react-dom/components/form">formulaires</a>.<p>Voici un formulaire qui permet à l'utilisateur de réserver un identifiant.<pre class="language-js"><code class="language-js"><span class="token comment">// App.js</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestUsername</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use server'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>requestUsername<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token constant">R</span>éserver<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Dans cet exemple, <code>requestUsername</code> est une Action Serveur passée à un <code>&#x3C;form></code>. Lorsque l'utilisateur envoie le formulaire, une requête réseau est faite à l'Action Serveur <code>requestUsername</code>. Puisque celle-ci est appelée au travers d'un formulaire, React fournit les<codestep step="{1}"><a href="https://developer.mozilla.org/fr/docs/Web/API/FormData">FormData</a></codestep>du formulaire comme premier argument à l'Action Serveur.<p>Grâce au passage d'une Action Serveur comme <code>action</code> du formulaire, React peut faire <a href="https://developer.mozilla.org/fr/docs/Glossary/Progressive_Enhancement">l'amélioration progressive</a> du formulaire. Ça signifie que les formulaires peuvent être envoyés avant même que le <em>bundle</em> JavaScript ne soit chargé et exécuté.<section class="level4"aria-labelledby="gérer-les-valeurs-renvoyées-dans-les-formulaires-handling-return-values"><h4 id="gérer-les-valeurs-renvoyées-dans-les-formulaires-handling-return-values">Gérer les valeurs renvoyées dans les formulaires {/<em>handling-return-values</em>/}</h4><p>Pour revenir à notre formulaire de réservation d'identifiant, il peut arriver que l'identifiant ne soit plus disponible. <code>requestUsername</code> devrait nous indiquer si elle a réussi ou non sa réservation.<p>Pour mettre à jour l'UI sur base du résultat d'une Action Serveur, tout en proposant une amélioration progressive, utilisez <a href="/reference/react/useActionState"><code>useActionState</code></a>.<pre class="language-js"><code class="language-js"><span class="token comment">// requestUsername.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestUsername</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">canRequest</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'réussie'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token string">'échouée'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// UsernameForm.js</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useActionState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">requestUsername</span> <span class="token keyword module">from</span> <span class="token string">'./requestUsername'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">UsernameForm</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> action<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useActionState</span><span class="token punctuation">(</span>requestUsername<span class="token punctuation">,</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token string">'n/d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>action<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token constant">R</span>éserver<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token constant">R</span>ésultat de la dernière réservation <span class="token operator">:</span> <span class="token punctuation">{</span>state<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Remarquez que <code>useActionState</code>, au même titre que la plupart des Hooks, ne peut être appelé que depuis du<codestep step="{1}"><a href="/reference/rsc/use-client">code côté client</a></codestep>.</section></section><section class="level3"aria-labelledby="appeler-une-action-serveur-hors-dun--calling-a-server-action-outside-of-form"><h3 id="appeler-une-action-serveur-hors-dun--calling-a-server-action-outside-of-form">Appeler une Action Serveur hors d'un <code>&#x3C;form></code> {/<em>calling-a-server-action-outside-of-form</em>/}</h3><p>Les Actions Serveur exposent en pratique des points d'entrée côté serveur, et peuvent être appelées n'importe où dans du code client.<p>Pour utiliser une Action Serveur hors d'un <a href="/reference/react-dom/components/form">formulaire</a>, appelez l'Action Serveur au sein d'une <a href="/reference/react/useTransition">Transition</a>, ce qui vous permettra non seulement d'afficher un indicateur de chargement, mais aussi de réaliser des <a href="/reference/react/useOptimistic">mises à jour optimistes d'état</a> et de gérer les éventuelles erreurs. Les formulaires enrobent automatiquement vos Actions Serveur dans une transition.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">incrementLike</span> <span class="token keyword module">from</span> <span class="token string">'./actions'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useTransition <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">LikeButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> startTransition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>likeCount<span class="token punctuation">,</span> setLikeCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentCount <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">incrementLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setLikeCount</span><span class="token punctuation">(</span>currentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Total</span> des <span class="token maybe-class-name">Likes </span><span class="token operator">:</span> <span class="token punctuation">{</span>likeCount<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span> disabled<span class="token operator">=</span><span class="token punctuation">{</span>isPending<span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Like</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// actions.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> likeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">incrementLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  likeCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> likeCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Pour obtenir la valeur renvoyée par une Action Serveur, vous aurez besoin d'un <code>await</code> sur la promesse renvoyée. <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>