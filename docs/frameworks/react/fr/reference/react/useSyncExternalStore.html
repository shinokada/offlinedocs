<!doctype html><html lang="fr"><meta charset="utf-8"><title>useSyncExternalStore</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="usesyncexternalstore"><h1 id="usesyncexternalstore">useSyncExternalStore</h1><intro><p><code>useSyncExternalStore</code> est un Hook React qui vous permet de vous abonner à une source de données extérieure.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="référence-reference"><h2 id="référence-reference">Référence {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><h3 id="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><code>useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot?)</code> {/<em>usesyncexternalstore</em>/}</h3><p>Appelez <code>useSyncExternalStore</code> à la racine de votre composant pour lire une valeur provenant d'une source de données extérieure.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Il renvoie un instantané de cette donnée issue de la source. Vous aurez besoin de passer deux fonctions comme arguments :<ol><li>La fonction <code>subscribe</code> est censée s'abonner à la source et renvoyer une fonction de désabonnement.<li>La fonction <code>getSnapshot</code> est censée lire un instantané de la donnée souhaitée au sein de la source.</ol><p><a href="#usage">Voir d'autres exemples ci-dessous</a>.<section class="level4"aria-labelledby="paramètres-parameters"><h4 id="paramètres-parameters">Paramètres {/<em>parameters</em>/}</h4><ul><li><p><code>subscribe</code> : une fonction acceptant un unique argument <code>callback</code> qui s'abonne à la source de données. Lorsque la source évolue, elle est censée invoquer <code>callback</code>. Ça permettra au composant de refaire un rendu. La fonction <code>subscribe</code> est censée renvoyer une fonction qui procède au désabonnement associé.<li><p><code>getSnapshot</code> : une fonction qui renvoie un instantané de la donnée requise par le composant au sein de la source. Tant que la source n'évolue pas, des appels répétés à <code>getSnapshot</code> sont censés renvoyer la même valeur. Si la source évolue et que la valeur renvoyée diffère soudain (en comparant à l'aide de <a href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a>), React refait un rendu du composant.<li><p><code>getServerSnapshot</code> <strong>optionnelle</strong> : une fonction qui renvoie un premier instantané de la donnée au sein de la source. Elle ne sera utilisée que pour le rendu côté serveur, et pendant la phase d'hydratation du contenu fourni par le serveur une fois côté client. L'instantané serveur doit être identique qu'il soit exécuté côté serveur ou côté client : il est donc généralement sérialisé et passé du serveur au client. Si vous omettez cet argument, toute tentative de rendu côté serveur de votre composant lèvera une erreur.</ul></section><section class="level4"aria-labelledby="valeur-renvoyée-returns"><h4 id="valeur-renvoyée-returns">Valeur renvoyée {/<em>returns</em>/}</h4><p>L'instantané actuel de la valeur issue de la source, que vous pouvez utiliser pour votre logique de rendu.</section><section class="level4"aria-labelledby="limitations-caveats"><h4 id="limitations-caveats">Limitations {/<em>caveats</em>/}</h4><ul><li><p>L'instantané de la source renvoyé par <code>getSnapshot</code> doit être immuable. Si la source de données sous-jacente a des données modifiables, renvoyez une copie immuable comme instantané lorsque la donnée change. À défaut, renvoyez une version mise en cache de l'instantané précédent.<li><p>Si une fonction <code>subscribe</code> différente est passée lors d'un nouveau rendu, React se réabonnera à la source de données en utilisant cette nouvelle fonction <code>subscribe</code>. Vous pouvez éviter ça en déclarant <code>subscribe</code> hors du composant.</ul></section></section></section><section class="level2"aria-labelledby="utilisation-usage"><h2 id="utilisation-usage">Utilisation {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="sabonner-à-une-source-de-données-extérieure-subscribing-to-an-external-store"><h3 id="sabonner-à-une-source-de-données-extérieure-subscribing-to-an-external-store">S'abonner à une source de données extérieure {/<em>subscribing-to-an-external-store</em>/}</h3><p>La plupart des composants React n'ont besoin de lire des données que depuis leurs <a href="/learn/passing-props-to-a-component">props</a>, leur <a href="/reference/react/useState">état</a> et leur <a href="/reference/react/useContext">contexte</a>. Néanmoins, il arrive parfois qu'un composant ait besoin de lire des données dont la source est extérieure à React, données qui évoluent avec le temps. Ça inclut notamment :<ul><li>Les bibliothèques tierces de gestion d'état applicatif, qui stockent leur état hors de React.<li>Les API navigateur qui exposent une valeur modifiable et des événements pour s'abonner à ses modifications.</ul><p>Appelez <code>useSyncExternalStore</code> à la racine de votre composant pour lire une valeur depuis une source de données extérieure.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Elle renvoie un<codestep step="{3}">instantané</codestep>de la donnée issue de la source. Vous devrez lui passer deux arguments fonctions :<ol><li>La fonction<codestep step="{1}"><code>subscribe</code></codestep>est censée s'abonner à la source et renvoyer une fonction de désabonnement.<li>La fonction<codestep step="{2}"><code>getSnapshot</code></codestep>est censée lire un instantané de la donnée souhaitée au sein de la source.</ol><p>React utilisera ces fonctions pour garder votre composant abonné à la source et refaire un rendu lorsque la donnée change.<p>Par exemple, dans le bac à sable ci-dessous, <code>todosStore</code> est implementé <em>via</em> une source de données extérieure, dont l'état est stocké hors de React. Le composant <code>TodosApp</code> se connecte à cette source extérieure avec le Hook <code>useSyncExternalStore</code>.</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> todosStore<span class="token punctuation">.</span><span class="token method function property-access">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Ajouter</span> une tâche<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>ul<span class="token operator">></span>
        <span class="token punctuation">{</span>todos<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">todo</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
          <span class="token operator">&#x3C;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>li<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>ul<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Voici un exemple de source de données tierce</span>
<span class="token comment">// que vous pourriez avoir besoin d'intégrer dans React.</span>

<span class="token comment">// Si votre appli est intégralement construite avec</span>
<span class="token comment">// React, nous vous recommandons de plutôt utiliser</span>
<span class="token comment">// l'état local React pour ça.</span>

<span class="token keyword">let</span> nextId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> todosStore <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>listeners<span class="token punctuation">,</span> listener<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      listeners <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">l</span> <span class="token arrow operator">=></span> l <span class="token operator">!==</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> todos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> listener <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack><note><p>Autant que possible, nous vous recommandons de plutôt utiliser l'état local React avec <a href="/reference/react/useState"><code>useState</code></a> et <a href="/reference/react/useReducer"><code>useReducer</code></a>. L'API <code>useSyncExternalStore</code> est surtout utile pour vous intégrer avec du code existant non basé sur React.</p></note></section><section class="level3"aria-labelledby="sabonner-à-une-api-navigateur-subscribing-to-a-browser-api"><h3 id="sabonner-à-une-api-navigateur-subscribing-to-a-browser-api">S'abonner à une API navigateur {/<em>subscribing-to-a-browser-api</em>/}</h3><p><code>useSyncExternalStore</code> est également bien utile pour vous abonner à une valeur exposée par le navigateur et susceptible de changer au fil du temps. Supposez par exemple que vous souhaitiez que votre composant affiche l'état actif ou non de la connexion réseau. Le navigateur expose cette information au travers d'une propriété <a href="https://developer.mozilla.org/docs/Web/API/Navigator/onLine"><code>navigator.onLine</code></a>.<p>Cette valeur peut changer sans que React le sache, vous devriez donc la lire avec <code>useSyncExternalStore</code>.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Pour implémenter la fonction <code>getSnapshot</code>, lisez la valeur actuelle <em>via</em> l'API navigateur :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Vous devez ensuite implémenter la fonction <code>subscribe</code>. Il se trouve que lorsque <code>navigation.onLine</code> change, le navigateur déclenche l'événement <a href="https://developer.mozilla.org/docs/Web/API/Window/online_event"><code>online</code></a> ou <a href="https://developer.mozilla.org/docs/Web/API/Window/offline_event"><code>offline</code></a> sur l'objet <code>window</code>. Vous devez abonner l'argument <code>callback</code> à ces événements, et renvoyer une fonction qui fait le désabonnement correspondant :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>À présent React sait comment lire cette valeur depuis l'API extérieure <code>navigation.onLine</code>, et comment s'abonner pour être au courant de ses changements. Déconnectez votre appareil du réseau et remarquez que le composant réagit en se rafraîchissant :<sandpack></sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'✅ En ligne'</span> <span class="token operator">:</span> <span class="token string">'❌ Déconnecté'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section class="level3"aria-labelledby="extraire-la-logique-dans-un-hook-personnalisé-extracting-the-logic-to-a-custom-hook"><h3 id="extraire-la-logique-dans-un-hook-personnalisé-extracting-the-logic-to-a-custom-hook">Extraire la logique dans un Hook personnalisé {/<em>extracting-the-logic-to-a-custom-hook</em>/}</h3><p>En temps normal vous n'appellerez pas <code>useSyncExternalStore</code> directement dans vos composants. Vous l'enroberez généralement plutôt dans votre propre Hook personnalisé. Ça vous permet d'utiliser la même source de données extérieure depuis plusieurs composants.<p>Par exemple, ce Hook personnalisé <code>useOnlineStatus</code> surveille l'état connecté ou non du réseau :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Grâce à ça, plusieurs composants distincts peuvent utiliser <code>useOnlineStatus</code> sans avoir à répéter l'implémentation sous-jacente :</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useOnlineStatus <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./useOnlineStatus.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">StatusBar</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'✅ En ligne'</span> <span class="token operator">:</span> <span class="token string">'❌ Déconnecté'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">SaveButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSaveClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'✅ Progression enregistrée'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button disabled<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">!</span>isOnline<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSaveClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'Enregistrer la progression'</span> <span class="token operator">:</span> <span class="token string">'Reconnexion...'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">SaveButton</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">StatusBar</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></section><section class="level3"aria-labelledby="prendre-en-charge-le-rendu-côté-serveur-adding-support-for-server-rendering"><h3 id="prendre-en-charge-le-rendu-côté-serveur-adding-support-for-server-rendering">Prendre en charge le rendu côté serveur {/<em>adding-support-for-server-rendering</em>/}</h3><p>Si votre appli React utilise le <a href="/reference/react-dom/server">rendu côté serveur</a>, vos composants React seront aussi exécutés hors d'un environnement navigateur pour générer le HTML initial. Ça complexifie un peu la connexion à la source de données extérieure :<ul><li>Si vous vous connectez à une API strictement navigateur, ça ne marchera pas car elle n'existera pas, par définition, côté serveur.<li>Si vous vous connectez à une source de données tierce, vous aurez besoin que ses données correspondent côté serveur et côté client.</ul><p>Pour pouvoir résoudre ces problématiques, passez une fonction <code>getServerSnapshot</code> comme troisième argument à <code>useSyncExternalStore</code> :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getServerSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Toujours dire « En ligne » pour le HTML généré côté serveur</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>La fonction <code>getServerSnapshot</code> est similaire à <code>getSnapshot</code>, mais elle n'est exécutée que dans deux cas :<ul><li>Côté serveur pour générer le HTML.<li>Côté client lors de <a href="/reference/react-dom/client/hydrateRoot">l'hydratation</a>, c'est-à-dire lorsque React reprend la main sur le HTML renvoyé par le serveur pour le rendre interactif.</ul><p>Ça vous permet de fournir une valeur initiale de l'instantané que vous pourrez utiliser avant que l'appli devienne interactive. Si vous n'avez pas de valeur initiale pertinente à fournir lors du rendu côté serveur, omettez cet argument pour <a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-server-only-content">forcer le rendu côté client</a>.</p><note><p>Assurez-vous que <code>getServerSnapshot</code> renvoie exactement la même valeur lors du rendu client initial et lors du rendu côté serveur. Par exemple, si <code>getServerSnapshot</code> renvoie un contenu prérempli de la source de données côté serveur, vous devez transférer ce contenu au client. Une façon d'y parvenir consiste à émettre une balise <code>&#x3C;script></code> pendant le rendu côté serveur qui définit une globale du genre <code>window.MY_STORE_DATA</code>, puis de lire cette globale côté client au sein de <code>getServerSnapshot</code>. Votre source de donneés extérieure documente probablement comment faire ça.</p></note></section></section><section class="level2"aria-labelledby="dépannage-troubleshooting"><h2 id="dépannage-troubleshooting">Dépannage {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="jai-une-erreur-the-result-of-getsnapshot-should-be-cached-im-getting-an-error-the-result-of-getsnapshot-should-be-cached"><h3 id="jai-une-erreur-the-result-of-getsnapshot-should-be-cached-im-getting-an-error-the-result-of-getsnapshot-should-be-cached">J'ai une erreur : “The result of <code>getSnapshot</code> should be cached” {/<em>im-getting-an-error-the-result-of-getsnapshot-should-be-cached</em>/}</h3><p><em>(« Le résultat de <code>getSnapshot</code> devrait être mis en cache », NdT.)</em><p>Cette erreur signifie que la fonction <code>getSnapshot</code> renvoie un nouvel objet à chaque fois qu'on l'appelle :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 🔴 Ne renvoyez pas un nouvel objet à chaque fois depuis getSnapshot</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">todos</span><span class="token operator">:</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React refera le rendu du composant si la valeur renvoyée par <code>getSnapshot</code> diffère de celle du dernier appel. C'est pourquoi, si vous renvoyez à chaque fois une nouvelle valeur, vous aboutirez à un cycle infini de rendus et obtiendrez cette erreur.<p>Votre fonction <code>getSnapshot</code> ne devrait renvoyer un objet différent que si quelque chose a vraiment changé. Si votre source de données contient des données immuables, vous pouvez les renvoyer directement :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Vous pouvez renvoyer directement des données immuables</span>
  <span class="token keyword control-flow">return</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Si les données de votre source sont modifiables, votre fonction <code>getSnapshot</code> devrait en renvoyer un instantané immuable. Ça implique en effet qu'elle <em>doive</em> créer de nouveaux objets, mais pas à chaque appel. Elle devrait plutôt stocker le dernier instantané produit, et renvoyer ce même instantané jusqu'à ce que la donnée à la source ait changé. Les détails de détection de ce changement varient selon la source exploitée.</section><section class="level3"aria-labelledby="ma-fonction-subscribe-est-appelée-après-chaque-rendu-my-subscribe-function-gets-called-after-every-re-render"><h3 id="ma-fonction-subscribe-est-appelée-après-chaque-rendu-my-subscribe-function-gets-called-after-every-re-render">Ma fonction <code>subscribe</code> est appelée après chaque rendu {/<em>my-subscribe-function-gets-called-after-every-re-render</em>/}</h3><p>La fonction <code>subscribe</code> est définie <em>au sein</em> du composant, du coup elle diffère à chaque rendu :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 🚩 Toujours une fonction différente, donc React se réabonne à chaque rendu</span>
  <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>React se réabonnera à votre source de données dès que vous passez une fonction <code>subscribe</code> différente d'un rendu à l'autre. Si ça nuit aux performances et que vous souhaitez éviter un réabonnement, sortez la fonction <code>subscribe</code> du composant :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ✅ Toujours la même fonction, donc React ne se réabonne pas</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Vous pouvez aussi enrober <code>subscribe</code> dans un appel à <a href="/reference/react/useCallback"><code>useCallback</code></a> pour ne vous réabonner que lorsqu'une dépendance change :<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ✅ Même fonction tant que userId ne change pas</span>
  <span class="token keyword">const</span> subscribe <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>