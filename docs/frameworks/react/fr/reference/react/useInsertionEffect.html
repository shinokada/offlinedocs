<!doctype html><html lang="fr"><meta charset="utf-8"><title>useInsertionEffect</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="useinsertioneffect"><h1 id="useinsertioneffect">useInsertionEffect</h1><pitfall><p><code>useInsertionEffect</code> s'adresse aux auteurs de bibliothèques de CSS-en-JS. À moins que vous ne travailliez sur une bibliothèque de CSS-en-JS et ayez besoin d'injecter des styles, vous voudrez probablement utiliser plutôt <a href="/reference/react/useEffect"><code>useEffect</code></a> ou <a href="/reference/react/useLayoutEffect"><code>useLayoutEffect</code></a>.</p></pitfall><intro><p><code>useInsertionEffect</code> permet l'insertion d'éléments dans le DOM avant que les Effets de mise en page ne soient déclenchés.<pre class="language-js"><code class="language-js"><span class="token function">useInsertionEffect</span><span class="token punctuation">(</span>setup<span class="token punctuation">,</span> dependencies<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="référence-reference"><h2 id="référence-reference">Référence {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="useinsertioneffectsetup-dependencies-useinsertioneffect"><h3 id="useinsertioneffectsetup-dependencies-useinsertioneffect"><code>useInsertionEffect(setup, dependencies?)</code> {/<em>useinsertioneffect</em>/}</h3><p>Appelez <code>useInsertionEffect</code> pour insérer des styles avant que des Effets ayant besoin de consulter la mise en page soient déclenchés :<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useInsertionEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token comment">// Dans votre bibliothèque de CSS-en-JS</span>
<span class="token keyword">function</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ... injectez des balises &#x3C;style> ici ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><a href="#usage">Voir d'autres exemples ci-dessous</a>.<section class="level4"aria-labelledby="paramètres-parameters"><h4 id="paramètres-parameters">Paramètres {/<em>parameters</em>/}</h4><ul><li><p><code>setup</code> : la fonction contenant la logique de votre Effet. Votre fonction de mise en place peut par ailleurs renvoyer une fonction de <em>nettoyage</em>. Quand votre composant sera ajouté au DOM, mais avant le déclenchement des Effets de mise en page, React exécutera votre fonction de mise en place. Après chaque nouveau rendu dont les dépendances ont changé, React commencera par exécuter votre fonction de nettoyage (si vous en avez fourni une) avec les anciennes valeurs, puis exécutera votre fonction de mise en place avec les nouvelles valeurs. Une fois votre composant retiré du DOM, React exécutera votre fonction de nettoyage une dernière fois.<li><p><code>dependencies</code> <strong>optionnelles</strong> : la liste des valeurs réactives référencées par le code de <code>setup</code>. Les valeurs réactives comprennent les props, les variables d'état et toutes les variables et fonctions déclarées localement dans le corps de votre composant. Si votre <em>linter</em> est <a href="/learn/editor-setup#linting">configuré pour React</a>, il vérifiera que chaque valeur réactive concernée est bien spécifiée comme dépendance. La liste des dépendances doit avoir un nombre constant d'éléments et utiliser un littéral défini à la volée, du genre <code>[dep1, dep2, dep3]</code>. React comparera chaque dépendance à sa valeur précédente au moyen de la comparaison <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a>. Si vous omettez cet argument, votre Effet sera re-exécuté après chaque rendu du composant.</ul></section><section class="level4"aria-labelledby="valeur-renvoyée-returns"><h4 id="valeur-renvoyée-returns">Valeur renvoyée {/<em>returns</em>/}</h4><p><code>useInsertionEffect</code> renvoie <code>undefined</code>.</section><section class="level4"aria-labelledby="limitations-caveats"><h4 id="limitations-caveats">Limitations {/<em>caveats</em>/}</h4><ul><li>Les Effets ne sont exécutés que côté client. Ils sont ignorés lors du rendu côté serveur.<li>Vous ne pouvez pas mettre à jour l'état au sein de <code>useInsertionEffect</code>.<li>Au moment où <code>useInsertionEffect</code> est exécuté, les refs ne sont pas encore associées.<li><code>useInsertionEffect</code> est susceptible d'exécuter votre code avant ou après que le DOM a été mis à jour. Vous ne devriez pas vous baser sur une chronologie spécifique de mise à jour du DOM.<li>Contrairement aux autres types d'Effets, qui exécutent leurs nettoyages pour chaque Effet puis les mises en place pour chaque Effet, <code>useInsertionEffect</code> exécutera en séquence le nettoyage et la mise en place un composant à la fois. Ça entraîne donc un « entrelacement » des exécutions de nettoyage et de mise en place.</ul></section></section></section><section class="level2"aria-labelledby="utilisation-usage"><h2 id="utilisation-usage">Utilisation {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="injecter-des-styles-dynamiques-depuis-des-bibliothèques-de-css-en-js-injecting-dynamic-styles-from-css-in-js-libraries"><h3 id="injecter-des-styles-dynamiques-depuis-des-bibliothèques-de-css-en-js-injecting-dynamic-styles-from-css-in-js-libraries">Injecter des styles dynamiques depuis des bibliothèques de CSS-en-JS {/<em>injecting-dynamic-styles-from-css-in-js-libraries</em>/}</h3><p>D'habitude, vous styleriez vos composants React avec du CSS normal.<pre class="language-js"><code class="language-js"><span class="token comment">// Dans votre fichier JS :</span>
<span class="token operator">&#x3C;</span>button className<span class="token operator">=</span><span class="token string">"success"</span> <span class="token operator">/</span><span class="token operator">></span>

<span class="token comment">// Dans votre fichier CSS :</span>
<span class="token punctuation">.</span><span class="token property-access">success</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> green<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><p>Certaines équipes préfèrent gérer les styles directement dans le code JavaScript, plutôt que de recourir à des fichiers CSS. Ça nécessite habituellement une bibliothèque de CSS-en-JS ou un outil. On recense trois approches fréquentes pour du CSS-en-JS :<ol><li>L'extraction statique de fichiers CSS par un compilateur<li>Les styles en ligne, par exemple <code>&#x3C;div style={{ opacity: 1 }}></code><li>L'injection à l'exécution de balises <code>&#x3C;style></code></ol><p>Si vous utilisez du CSS-en-JS, nous vous recommandons de combiner les deux premières approches (les fichiers CSS pour les styles statiques, et les styles en ligne pour les styles dynamiques). <strong>Nous ne recommandons pas l'injection à l'exécution de balise <code>&#x3C;style></code> pour deux raisons :</strong><ol><li>L'injection à l'exécution force le navigateur à recalculer les styles beaucoup plus souvent.<li>L'injection à l'exécution peut être très lente si elle survient au mauvais moment du cycle de vie de React.</ol><p>Le premier problème est incontournable, mais <code>useInsertionEffect</code> vous aide à résoudre le second.<p>Appelez <code>useInsertionEffect</code> pour insérer des styles avant que les Effets de mise en page soient déclenchés :<pre class="language-js"><code class="language-js"><span class="token comment">// Dans votre bibliothèque de CSS-en-JS</span>
<span class="token keyword">let</span> isInserted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// Comme expliqué plus haut, nous ne recommandons pas l'injection à l'exécution de balise &#x3C;style>.</span>
    <span class="token comment">// Mais si vous devez absolument le faire, alors il est important de le faire dans un</span>
    <span class="token comment">// useInsertionEffect.</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInserted<span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isInserted<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token function">getStyleForRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Button</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> className <span class="token operator">=</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Tout comme <code>useEffect</code>, <code>useInsertionEffect</code> est ignoré côté serveur. Si vous avez besoin de collecter les règles CSS utilisées côté serveur, vous pouvez le faire durant le rendu :<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> collectedRulesSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token dom variable">window</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    collectedRulesSet<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><a href="https://github.com/reactwg/react-18/discussions/110">Apprenez-en davantage sur la mise à jour des bibliothèques de CSS-en-JS faisant de l'injection à l'exécution pour tirer parti de <code>useInsertionEffect</code>.</a></p><deepdive><section class="level4"aria-labelledby="en-quoi-est-ce-préférable-à-linjection-de-styles-durant-le-rendu-ou-à-uselayouteffect-how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect"><h4 id="en-quoi-est-ce-préférable-à-linjection-de-styles-durant-le-rendu-ou-à-uselayouteffect-how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect">En quoi est-ce préférable à l'injection de styles durant le rendu ou à <code>useLayoutEffect</code> ? {/<em>how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect</em>/}</h4><p>Si vous insérez des styles pendant le rendu et que React traite une <a href="/reference/react/useTransition#marking-a-state-update-as-a-non-blocking-transition">mise à jour non bloquante</a>, le navigateur recalculera les styles à chaque étape du rendu de l'arborescence de composants, ce qui peut être <strong>extrêmement lent</strong>.<p><code>useInsertionEffect</code> est préférable à l'insertion de styles dans <a href="/reference/react/useLayoutEffect"><code>useLayoutEffect</code></a> ou <a href="/reference/react/useEffect"><code>useEffect</code></a> parce qu'il garantit qu'au moment de l'exécution des autres Effets de vos composants, les balises <code>&#x3C;style></code> auront déjà été insérées. Faute de ça, les calculs de mise en page au sein d'Effets classiques seraient erronés en raison de styles obsolètes.</p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></deepdive></section></section></inlinetoc></section>