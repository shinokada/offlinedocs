<!doctype html><html lang="fr"><meta charset="utf-8"><title>cache</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="cache"><h1 id="cache">cache</h1><p>canary: true</p><canary><ul><li><p><code>cache</code> n'est destinée qu'aux <a href="/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-server-components">React Server Components</a>. Découvrez quels <a href="/learn/start-a-new-react-project#bleeding-edge-react-frameworks">frameworks</a> prennent en charge les Composants Serveur.<li><p><code>cache</code> n'est disponible que dans les canaux de livraison <a href="/community/versioning-policy#canary-channel">Canary</a> et <a href="/community/versioning-policy#experimental-channel">Expérimental</a>. Assurez-vous d'en comprendre les limitations avant d'utiliser <code>cache</code> en production. Apprenez-en davantage sur les <a href="/community/versioning-policy#all-release-channels">canaux de livraison React</a>.</ul></canary><intro><p><code>cache</code> vous permet de mettre en cache le résultat d'un chargement de données ou d'un calcul.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cachedFn <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="référence-reference"><h2 id="référence-reference">Référence {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="cachefn-cache"><h3 id="cachefn-cache"><code>cache(fn)</code> {/<em>cache</em>/}</h3><p>Appelez <code>cache</code> hors de tout composant pour créer une variante d'une fonction dotée de mise en cache.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">calculateMetrics</span> <span class="token keyword module">from</span> <span class="token string">'lib/metrics'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getMetrics <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chart</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getMetrics</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Lors du premier appel de <code>getMetrics</code> avec <code>data</code>, <code>getMetrics</code> appellera <code>calculateMetrics(data)</code> et mettra le résultat en cache. Si <code>getMetrics</code> est rappelée avec le même argument <code>data</code>, elle renverra le résultat mis en cache plutôt que de rappeler <code>calculateMetrics(data)</code>.<p><a href="#usage">Voir d'autres exemples plus bas</a>.<section class="level4"aria-labelledby="paramètres-parameters"><h4 id="paramètres-parameters">Paramètres {/<em>parameters</em>/}</h4><ul><li><code>fn</code> : la fonction dont vous voulez mettre les résultats en cache. <code>fn</code> peut prendre un nombre quelconque d'arguments et renvoyer n'importe quel type de résultat.</ul></section><section class="level4"aria-labelledby="valeur-renvoyée-returns"><h4 id="valeur-renvoyée-returns">Valeur renvoyée {/<em>returns</em>/}</h4><p><code>cache</code> renvoie une version de <code>fn</code> dotée d'un cache, avec la même signature de type. Elle n'appelle pas <code>fn</code> à ce moment-là.<p>Lors d'un appel à <code>cachedFn</code> avec des arguments donnés, elle vérifiera d'abord si un résultat correspondant existe dans le cache. Si tel est le cas, elle renverra ce résultat. Dans le cas contraire, elle appellera <code>fn</code> avec les arguments, mettra le résultat en cache et le renverra. <code>fn</code> n'est appelée qu'en cas d'absence de correspondance dans le cache <em>(cache miss, NdT)</em>.</p><note><p>L'optimisation qui consiste à mettre en cache les valeurs résultats sur base des arguments passés est généralement appelée <a href="https://fr.wikipedia.org/wiki/M%C3%A9mo%C3%AFsation"><em>mémoïsation</em></a>. La fonction renvoyée par <code>cache</code> est dite « fonction mémoïsée ».</p></note></section><section class="level4"aria-labelledby="limitations-caveats"><h4 id="limitations-caveats">Limitations {/<em>caveats</em>/}</h4><ul><li>React invalidera le cache de toutes les fonctions mémoïsées à chaque requête serveur.<li>Chaque appel à <code>cache</code> crée une nouvelle fonction. Ça signifie qu'appeler <code>cache</code> plusieurs fois avec la même fonction renverra plusieurs fonctions mémoïsées distinctes, avec chacune leur propre cache.<li><code>cachedFn</code> mettra également les erreurs en cache. Si <code>fn</code> lève une exception pour certains arguments, ce sera mis en cache, et la même erreur sera levée lorsque <code>cachedFn</code> sera rappelée avec ces mêmes arguments.<li><code>cache</code> est destinée uniquement aux <a href="/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-server-components">Composants Serveur</a>.</ul></section></section></section><section class="level2"aria-labelledby="utilisation-usage"><h2 id="utilisation-usage">Utilisation {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="mettre-en-cache-un-calcul-coûteux-cache-expensive-computation"><h3 id="mettre-en-cache-un-calcul-coûteux-cache-expensive-computation">Mettre en cache un calcul coûteux {/<em>cache-expensive-computation</em>/}</h3><p>Utilisez <code>cache</code> pour éviter de dupliquer un traitement.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">calculateUserMetrics</span> <span class="token keyword module">from</span> <span class="token string">'lib/user'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getUserMetrics <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateUserMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Profile</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token function">getUserMetrics</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TeamReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>users<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> user <span class="token keyword">of</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token function">getUserMetrics</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Si le même objet <code>user</code> est affiché dans <code>Profile</code> et <code>TeamReport</code>, les deux composants peuvent mutualiser le travail et n'appeler <code>calculateUserMetrics</code> qu'une fois pour ce <code>user</code>.<p>Supposons que <code>Profile</code> fasse son rendu en premier. Il appellera<codestep step="{1}"><code>getUserMetrics</code></codestep>, qui vérifiera si un résultat existe en cache. Comme il s'agit du premier appel de <code>getUserMetrics</code> pour ce <code>user</code>, elle ne trouvera aucune correspondance. <code>getUserMetrics</code> appellera alors effectivement <code>calculateUserMetrics</code> avec ce <code>user</code> puis mettra le résultat en cache.<p>Lorsque <code>TeamReport</code> affichera sa liste de <code>users</code> et atteindra le même objet <code>user</code>, il appellera<codestep step="{2}"><code>getUserMetrics</code></codestep>qui lira le résultat depuis son cache.</p><pitfall><section class="level4"aria-labelledby="appeler-des-fonctions-mémoïsées-distinctes-lira-des-caches-distincts-pitfall-different-memoized-functions"><h4 id="appeler-des-fonctions-mémoïsées-distinctes-lira-des-caches-distincts-pitfall-different-memoized-functions">Appeler des fonctions mémoïsées distinctes lira des caches distincts {/<em>pitfall-different-memoized-functions</em>/}</h4><p>Pour partager un cache, des composants doivent appeler la même fonction mémoïsée.<pre class="language-js"><code class="language-js"><span class="token comment">// Temperature.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>calculateWeekReport<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./report'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Temperature</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 🚩 Erroné : Appeler `cache` au sein du composant</span>
  <span class="token comment">// crée une nouvelle `getWeekReport` à chaque rendu</span>
  <span class="token keyword">const</span> getWeekReport <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateWeekReport<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Precipitation.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>calculateWeekReport<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./report'</span><span class="token punctuation">;</span>

<span class="token comment">// 🚩 Erroné : `getWeekReport` n’est accessible que depuis</span>
<span class="token comment">// le composant `Precipitation`.</span>
<span class="token keyword">const</span> getWeekReport <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateWeekReport<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Precipitation</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Dans l'exemple ci-dessus,<codestep step="{2}"><code>Precipitation</code></codestep>et<codestep step="{1}"><code>Temperature</code></codestep>appellent chacun <code>cache</code> pour créer une nouvelle fonction mémoïsée, qui dispose à chaque fois de son propre cache. Si les deux composants s'affichent avec les mêmes <code>cityData</code>, ils dupliqueront tout de même le travail en appelant à chaque fois <code>calculateWeekReport</code>.<p>Qui plus est, <code>Temperature</code> crée une<codestep step="{1}">nouvelle fonction mémoïsée</codestep>à chaque rendu, ce qui ne permet aucun partage de cache.<p>Pour maximiser les correspondances trouvées et réduire la charge de calcul, les deux composants devraient s'assurer de partager la même fonction mémoïsée, pour pouvoir accéder au même cache. Définissez plutôt la fonction mémoïsée dans un module dédié qui peut faire l'objet d'un <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Statements/import"><code>import</code></a> dans les divers composants.<pre class="language-js"><code class="language-js"><span class="token comment">// getWeekReport.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>calculateWeekReport<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./report'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateWeekReport<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Temperature.js</span>
<span class="token keyword module">import</span> <span class="token imports">getWeekReport</span> <span class="token keyword module">from</span> <span class="token string">'./getWeekReport'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Temperature</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Precipitation.js</span>
<span class="token keyword module">import</span> <span class="token imports">getWeekReport</span> <span class="token keyword module">from</span> <span class="token string">'./getWeekReport'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Precipitation</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Désormais les deux composants appellent la<codestep step="{3}">même fonction mémoïsée</codestep>, exportée depuis <code>./getWeekReport.js</code>, afin de lire et d'écrire dans le même cache.</section></pitfall></section><section class="level3"aria-labelledby="partager-un-instantané-de-données-take-and-share-snapshot-of-data"><h3 id="partager-un-instantané-de-données-take-and-share-snapshot-of-data">Partager un instantané de données {/<em>take-and-share-snapshot-of-data</em>/}</h3><p>Pour partager un instantané de données d'un composant à l'autre, appelez <code>cache</code> sur une fonction de chargement de données telle que <code>fetch</code>. Lorsque plusieurs composants feront le même chargement de données, seule une requête sera faite, et ses données résultantes mises en cache et partagées à travers plusieurs composants. Tous les composants utiliseront le même instantané de ces données au sein du rendu côté serveur.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>fetchTemperature<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./api.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getTemperature <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> <span class="token function">fetchTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">AnimatedWeatherCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MinimalWeatherCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>Si <code>AnimatedWeatherCard</code> et <code>MinimalWeatherCard</code> s'affichent tous deux avec la même<codestep step="{1}">city</codestep>, ils recevront le même instantané de données depuis la<codestep step="{2}">fonction mémoïsée</codestep>.<p>Si <code>AnimatedWeatherCard</code> et <code>MinimalWeatherCard</code> fournissent un argument<codestep step="{1}">city</codestep>différent à<codestep step="{2}"><code>getTemperature</code></codestep>, alors <code>fetchTemperature</code> sera appelée deux fois, et chaque point d'appel recevra ses données spécifiques.<p>La<codestep step="{1}">city</codestep>agit comme une clé de cache.</p><note><p><codestep step="{3}">Le rendu asynchrone</codestep>n'est possible que dans les Composants Serveur.<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">AnimatedWeatherCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></note></section><section class="level3"aria-labelledby="précharger-des-données-preload-data"><h3 id="précharger-des-données-preload-data">Précharger des données {/<em>preload-data</em>/}</h3><p>En mettant en cache un chargement de données qui prendrait du temps, vous pouvez démarrer des traitements asynchrones avant de faire le rendu d'un composant.<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> getUser <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Profile</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>section</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span><span class="token property-access">profilePic</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>user<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>section</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Page</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Malin : commence à charger les données utilisateur</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... des calculs ici</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">Profile</span></span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Lorsque <code>Page</code> fait son rendu, le composant appelle<codestep step="{1}"><code>getUser</code></codestep>, mais remarquez qu'il n'utilise pas les données renvoyées. Cet appel anticipé à<codestep step="{1}"><code>getUser</code></codestep>déclenche la requête asynchrone à la base de données, qui s'exécute pendant que <code>Page</code> fait d'autres calculs puis déclenche le rendu de ses enfants.<p>Lorsque <code>Profile</code> fait son rendu, nous appelons à nouveau<codestep step="{2}"><code>getUser</code></codestep>. Si l'appel initial à<codestep step="{1}"><code>getUser</code></codestep>a fini son chargement et mis en cache les données utilisateur, lorsque <code>Profile</code><codestep step="{2}">demande ces données puis attend</codestep>, il n'a plus qu'à les lire du cache, sans relancer un appel réseau. Si la<codestep step="{1}">requête de données initiale</codestep>n'est pas encore terminée, cette approche de préchargement réduit tout de même le délai d'obtention des données.</p><deepdive><section class="level4"aria-labelledby="mettre-en-cache-un-traitement-asynchrone-caching-asynchronous-work"><h4 id="mettre-en-cache-un-traitement-asynchrone-caching-asynchronous-work">Mettre en cache un traitement asynchrone {/<em>caching-asynchronous-work</em>/}</h4><p>Lorsque vous évaluez une <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Statements/async_function">fonction asynchrone</a>, vous recevez une <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a> représentant le traitement. La promesse maintient un état pour le traitement (<em>en attente</em>, <em>accompli</em> ou <em>rejeté</em>) ainsi que l'aboutissement du traitement à terme.<p>Dans cet exemple, la fonction asynchrone<codestep step="{1}"><code>fetchData</code></codestep>renvoie une promesse pour le résultat de notre appel à <code>fetch</code>.<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> getData <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>fetchData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MyComponent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... des calculs ici</span>
  <span class="token keyword control-flow">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>En appelant<codestep step="{2}"><code>getData</code></codestep>pour la première fois, la promesse renvoyée par<codestep step="{1}"><code>fetchData</code></codestep>est mise en cache. Les appels ultérieurs utiliseront la même promesse.<p>Remarquez que le premier appel à<codestep step="{2}"><code>getData</code></codestep>n'appelle pas <code>await</code>, alors que le<codestep step="{3}">second</codestep>le fait. <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Operators/await"><code>await</code></a> est un opérateur JavaScript qui attend l'établissement de la promesse et renvoie son résultat accompli (ou lève son erreur de rejet). Le premier appel à<codestep step="{2}"><code>getData</code></codestep>lance simplement le chargement (<code>fetch</code>) pour mettre la promesse en cache, afin que le deuxième<codestep step="{3}"><code>getData</code></codestep>la trouve déjà en cours d'exécution.<p>Si lors du<codestep step="{3}">deuxième appel</codestep>la promesse est toujours <em>en attente</em>, alors <code>await</code> attendra son résultat. L'optimisation tient à ce que, pendant le <code>fetch</code> issu du premier appel, React peut continuer son travail de calcul, ce qui réduit l'attente pour le<codestep step="{3}">deuxième appel</codestep>.<p>Si la promesse est déjà établie à ce moment-là, <code>await</code> renverra immédiatement la valeur accomplie (ou lèvera immédiatement l'erreur de rejet). Dans les deux cas, on améliore la performance perçue.</section></deepdive><pitfall><section class="level4"aria-labelledby="appeler-une-fonction-mémoïsée-hors-dun-composant-nutilisera-pas-le-cache-pitfall-memoized-call-outside-component"><h4 id="appeler-une-fonction-mémoïsée-hors-dun-composant-nutilisera-pas-le-cache-pitfall-memoized-call-outside-component">Appeler une fonction mémoïsée hors d'un composant n'utilisera pas le cache {/<em>pitfall-memoized-call-outside-component</em>/}</h4><pre class="language-jsx"><code class="language-jsx"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getUser <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 🚩 Erroné : Appeler une fontion mémoïsée hors d’un composant</span>
<span class="token comment">// n’exploitera pas le cache.</span>
<span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">'demo-id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">DemoProfile</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Correct : `getUser` exploitera le cache.</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">'demo-id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">Profile</span></span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React ne fournit un accès au cache pour les fonctions mémoïsées qu'au sein d'un composant. Si vous appelez<codestep step="{1}"><code>getUser</code></codestep>hors d'un composant, il évaluera la fonction mais n'utilisera pas le cache (ni en lecture ni en écriture).<p>C'est parce que l'accès au cache est fourni via un <a href="/learn/passing-data-deeply-with-context">contexte</a>, et que les contextes ne sont accessibles que depuis les composants.</section></pitfall><deepdive><section class="level4"aria-labelledby="comment-choisir-entre-cache-memo-et-usememo-cache-memo-usememo"><h4 id="comment-choisir-entre-cache-memo-et-usememo-cache-memo-usememo">Comment choisir entre <code>cache</code>, <a href="/reference/react/memo"><code>memo</code></a> et <a href="/reference/react/useMemo"><code>useMemo</code></a> ? {/<em>cache-memo-usememo</em>/}</h4><p>Toutes ces API proposent de la mémoïsation, mais diffèrent sur ce que vous cherchez à mémoïser, sur les destinataires du cache, et sur les méthodes d'invalidation de ce cache.</section><section class="level4"aria-labelledby="usememo-deep-dive-use-memo"><h4 id="usememo-deep-dive-use-memo"><code>useMemo</code> {/<em>deep-dive-use-memo</em>/}</h4><p>Vous devriez généralement utiliser <a href="/reference/react/useMemo"><code>useMemo</code></a> pour mettre en cache d'un rendu à l'autre un calcul coûteux dans un Composant Client. Ça pourrait par exemple mémoïser une transformation de données dans un composant.<pre class="language-jsx"><code class="language-jsx"><span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">WeatherReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> avgTemp <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">calculateAvg</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token function">getRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">WeatherReport</span></span> <span class="token attr-name">record</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">WeatherReport</span></span> <span class="token attr-name">record</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Dans cet exemple, <code>App</code> affiche deux <code>WeatherReport</code> avec le même enregistrement. Même si les deux composants font le même travail, ils ne peuvent pas partager des traitements. Le cache de <code>useMemo</code> est local à chaque composant.<p>En revanche, <code>useMemo</code> s'assure bien que si <code>App</code> refait un rendu et que l'objet <code>record</code> n'a pas changé, chaque instance du composant évitera son calcul et utilisera plutôt sa valeur <code>avgTemp</code> mémoïsée. <code>useMemo</code> mettra le dernier calcul d'<code>avgTemp</code> en cache sur base des dépendances qu'on lui fournit.</section><section class="level4"aria-labelledby="cache-deep-dive-cache"><h4 id="cache-deep-dive-cache"><code>cache</code> {/<em>deep-dive-cache</em>/}</h4><p>Vous utiliserez <code>cache</code> dans des Composants Serveur pour mémoïser du travail à partager entre plusieurs composants.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cachedFetchReport <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>fetchReport<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">WeatherReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">cachedFetchReport</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> city <span class="token operator">=</span> <span class="token string">"Paris"</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">WeatherReport</span> city<span class="token operator">=</span><span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">WeatherReport</span> city<span class="token operator">=</span><span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>En réécrivant l'exemple précédent pour utiliser <code>cache</code>, cette fois la<codestep step="{3}">deuxième instance de <code>WeatherReport</code></codestep>pourra s'éviter une duplication d'effort et lira depuis le même cache que le<codestep step="{1}">premier <code>WeatherReport</code></codestep>. Une autre différence avec l'exemple précédent, c'est que <code>cache</code> est également conseillée pour<codestep step="{2}">mémoïser des chargements de données</codestep>, contrairement à <code>useMemo</code> qui ne devrait être utilisée que pour des calculs.<p>Pour le moment, <code>cache</code> ne devrait être utilisée que dans des Composants Serveur, et le cache sera invalidé à chaque requête serveur.</section><section class="level4"aria-labelledby="memo-deep-dive-memo"><h4 id="memo-deep-dive-memo"><code>memo</code> {/<em>deep-dive-memo</em>/}</h4><p>Vous devriez utiliser <a href="reference/react/memo"><code>memo</code></a> pour éviter qu'un composant ne recalcule son rendu alors que ses props n'ont pas changé.<pre class="language-js"><code class="language-js"><span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">WeatherReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> avgTemp <span class="token operator">=</span> <span class="token function">calculateAvg</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">MemoWeatherReport</span> <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token maybe-class-name">WeatherReport</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token function">getRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MemoWeatherReport</span> record<span class="token operator">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MemoWeatherReport</span> record<span class="token operator">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Dans cet exemple, les deux composants <code>MemoWeatherReport</code> appelleront <code>calculateAvg</code> lors de leur premier rendu. Cependant, si <code>App</code> refait son rendu, sans pour autant changer <code>record</code>, aucune des props n'aura changé et <code>MemoWeatherReport</code> ne refera pas son rendu.<p>Comparé à <code>useMemo</code>, <code>memo</code> mémoïse le rendu du composant sur base de ses props, au lieu de mémoïser des calculs spécifiques. Un peu comme avec <code>useMemo</code>, le composant mémoïsé ne met en cache que le dernier rendu, avec les dernières valeurs de props. Dès que les props changent, le cache est invalidé et le composant refait son rendu.</section></deepdive></section></section><section class="level2"aria-labelledby="dépannage-troubleshooting"><h2 id="dépannage-troubleshooting">Dépannage {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="ma-fonction-mémoïsée-est-ré-exécutée-alors-que-je-lai-appelée-avec-les-mêmes-arguments-memoized-function-still-runs"><h3 id="ma-fonction-mémoïsée-est-ré-exécutée-alors-que-je-lai-appelée-avec-les-mêmes-arguments-memoized-function-still-runs">Ma fonction mémoïsée est ré-exécutée alors que je l'ai appelée avec les mêmes arguments {/<em>memoized-function-still-runs</em>/}</h3><p>Voyez déjà les pièges signalés plus haut :<ul><li><a href="#pitfall-different-memoized-functions">Appeler des fonctions mémoïsées distinctes lira des caches distincts</a><li><a href="#pitfall-memoized-call-outside-component">Appeler une fonction mémoïsée hors d'un composant n'utilisera pas le cache</a></ul><p>Si rien de tout ça ne s'applique, le problème peut être lié à la façon dont React vérifie l'existence de quelque chose dans le cache.<p>Si vos arguments ne sont pas des <a href="https://developer.mozilla.org/fr/docs/Glossary/Primitive">primitives</a> (ce sont par exemple des objets, des fonctions, des tableaux), assurez-vous de toujours passer la même référence d'objet.<p>Lors d'un appel à une fonction mémoïsée, React utilisera les arguments passés pour déterminer si un résultat existe déjà dans le cache. React utilisera pour ce faire une comparaison superficielle des arguments.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> calculateNorm <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vector</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MapMarker</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 🚩 Erroné : les props sont un objet différent à chaque rendu.</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">calculateNorm</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Dans le cas ci-dessus, les deux <code>MapMarker</code> semblent faire exactement la même chose et appeler <code>calculateNorm</code> avec les mêmes valeurs <code>{x: 10, y: 10, z:10}</code>. Même si les objets contiennent des valeurs identiques, il ne s'agit pas d'une unique référence à un même objet, car chaque composant crée son propre objet <code>props</code>.<p>React appellera <a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> sur chaque argument pour vérifier l'existence dans le cache.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> calculateNorm <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MapMarker</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Correct : passe des primitives à la fonction mémoïsée</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">calculateNorm</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token property-access">z</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Une façon de remédier à ça consiste à passer les dimensions du vecteur à <code>calculateNorm</code>. Ça fonctionne parce que chaque dimension passée est une valeur primitive.<p>Vous pourriez aussi passer l'objet vecteur lui-même comme prop au composant. Il vous faudrait toutefois passer le même objet en mémoire aux deux instances du composant.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> calculateNorm <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vector</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MapMarker</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Correct : passe le même objet `vector`</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">calculateNorm</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token property-access">vector</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vector <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> vector<span class="token operator">=</span><span class="token punctuation">{</span>vector<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> vector<span class="token operator">=</span><span class="token punctuation">{</span>vector<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>