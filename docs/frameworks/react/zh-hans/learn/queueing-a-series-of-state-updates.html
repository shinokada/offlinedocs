<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>把一系列 state 更新加入队列</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="把一系列-state-更新加入队列"><h1 id="把一系列-state-更新加入队列">把一系列 state 更新加入队列</h1><p>translators:<ul><li>Jiacheng787<li>Neo42</ul><intro><p>设置组件 state 会把一次重新渲染加入队列。但有时你可能会希望在下次渲染加入队列之前对 state 的值执行多次操作。为此，了解 React 如何批量更新 state 会很有帮助。</p></intro><youwilllearn><ul><li>什么是“批处理”以及 React 如何使用它来处理多个 state 更新<li>如何连续多次对同一 state 变量进行更新</ul></youwilllearn><section class="level2"aria-labelledby="react-会对-state-更新进行批处理-react-batches-state-updates"><h2 id="react-会对-state-更新进行批处理-react-batches-state-updates">React 会对 state 更新进行批处理 {/<em>react-batches-state-updates</em>/}</h2><p>在下面的示例中，你可能会认为点击 “+3” 按钮会使计数器递增三次，因为它调用了 <code>setNumber(number + 1)</code> 三次：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>但是，你可能还记得上一节中的内容，<a href="/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time">每一次渲染的 state 值都是固定的</a>，因此无论你调用多少次 <code>setNumber(1)</code>，在第一次渲染的事件处理函数内部的 <code>number</code> 值总是 <code>0</code> ：<pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>但是这里还有另外一个影响因素需要讨论。<strong>React 会等到事件处理函数中的</strong> 所有 <strong>代码都运行完毕再处理你的 state 更新。</strong> 这就是为什么重新渲染只会发生在所有这些 <code>setNumber()</code> 调用 <strong>之后</strong> 的原因。<p>这可能会让你想起餐厅里帮你点菜的服务员。服务员不会在你说第一道菜的时候就跑到厨房！相反，他们会让你把菜点完，让你修改菜品，甚至会帮桌上的其他人点菜。<p>&#x3C;Illustration src./docs/illustrations/i_react-batching.png" alt="在餐厅里，优雅的光标跟扮演服务员角色的 React 多次点菜。在她多次调用 setState() 之后，服务员将她所点的最后一个作为她的最终订单记录下来。" /><p>这让你可以更新多个 state 变量——甚至来自多个组件的 state 变量——而不会触发太多的 <a href="/learn/render-and-commit#re-renders-when-state-updates">重新渲染</a>。但这也意味着只有在你的事件处理函数及其中任何代码执行完成 <strong>之后</strong>，UI 才会更新。这种特性也就是 <strong>批处理</strong>，它会使你的 React 应用运行得更快。它还会帮你避免处理只​​更新了一部分 state 变量的令人困惑的“半成品”渲染。<p><strong>React 不会跨 <em>多个</em> 需要刻意触发的事件（如点击）进行批处理</strong>——每次点击都是单独处理的。请放心，React 只会在一般来说安全的情况下才进行批处理。这可以确保，例如，如果第一次点击按钮会禁用表单，那么第二次点击就不会再次提交它。</section><section class="level2"aria-labelledby="在下次渲染前多次更新同一个-state-updating-the-same-state-multiple-times-before-the-next-render"><h2 id="在下次渲染前多次更新同一个-state-updating-the-same-state-multiple-times-before-the-next-render">在下次渲染前多次更新同一个 state {/<em>updating-the-same-state-multiple-times-before-the-next-render</em>/}</h2><p>这是一个不常见的用例，但是如果你想在下次渲染之前多次更新同一个 state，你可以像 <code>setNumber(n => n + 1)</code> 这样传入一个根据队列中的前一个 state 计算下一个 state 的 <strong>函数</strong>，而不是像 <code>setNumber(number + 1)</code> 这样传入 <strong>下一个 state 值</strong>。这是一种告诉 React “用 state 值做某事”而不是仅仅替换它的方法。<p>现在尝试递增计数器：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>在这里，<code>n => n + 1</code> 被称为 <strong>更新函数</strong>。当你将它传递给一个 state 设置函数时：<ol><li>React 会将此函数加入队列，以便在事件处理函数中的所有其他代码运行后进行处理。<li>在下一次渲染期间，React 会遍历队列并给你更新之后的最终 state。</ol><pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>下面是 React 在执行事件处理函数时处理这几行代码的过程：<ol><li><code>setNumber(n => n + 1)</code>：<code>n => n + 1</code> 是一个函数。React 将它加入队列。<li><code>setNumber(n => n + 1)</code>：<code>n => n + 1</code> 是一个函数。React 将它加入队列。<li><code>setNumber(n => n + 1)</code>：<code>n => n + 1</code> 是一个函数。React 将它加入队列。</ol><p>当你在下次渲染期间调用 <code>useState</code> 时，React 会遍历队列。之前的 <code>number</code> state 的值是 <code>0</code>，所以这就是 React 作为参数 <code>n</code> 传递给第一个更新函数的值。然后 React 会获取你上一个更新函数的返回值，并将其作为 <code>n</code> 传递给下一个更新函数，以此类推：<table><thead><tr><th>更新队列<th><code>n</code><th>返回值<tbody><tr><td><code>n => n + 1</code><td><code>0</code><td><code>0 + 1 = 1</code><tr><td><code>n => n + 1</code><td><code>1</code><td><code>1 + 1 = 2</code><tr><td><code>n => n + 1</code><td><code>2</code><td><code>2 + 1 = 3</code></table><p>React 会保存 <code>3</code> 为最终结果并从 <code>useState</code> 中返回。<p>这就是为什么在上面的示例中点击“+3”正确地将值增加“+3”。 ### 如果你在替换 state 后更新 state 会发生什么 {/<em>what-happens-if-you-update-state-after-replacing-it</em>/}<p>这个事件处理函数会怎么样？你认为 <code>number</code> 在下一次渲染中的值是什么？<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>增加数字<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>这是事件处理函数告诉 React 要做的事情：<ol><li><code>setNumber(number + 5)</code>：<code>number</code> 为 <code>0</code>，所以 <code>setNumber(0 + 5)</code>。React 将 <em>“替换为 <code>5</code>”</em> 添加到其队列中。<li><code>setNumber(n => n + 1)</code>：<code>n => n + 1</code> 是一个更新函数。 React 将 <strong>该函数</strong> 添加到其队列中。</ol><p>在下一次渲染期间，React 会遍历 state 队列：<table><thead><tr><th>更新队列<th><code>n</code><th>返回值<tbody><tr><td>“替换为 <code>5</code>”<td><code>0</code>（未使用）<td><code>5</code><tr><td><code>n => n + 1</code><td><code>5</code><td><code>5 + 1 = 6</code></table><p>React 会保存 <code>6</code> 为最终结果并从 <code>useState</code> 中返回。</p><note><p>你可能已经注意到，<code>setState(x)</code> 实际上会像 <code>setState(n => x)</code> 一样运行，只是没有使用 <code>n</code>！</p></note><section class="level3"aria-labelledby="如果你在更新-state-后替换-state-会发生什么-what-happens-if-you-replace-state-after-updating-it"><h3 id="如果你在更新-state-后替换-state-会发生什么-what-happens-if-you-replace-state-after-updating-it">如果你在更新 state 后替换 state 会发生什么 {/<em>what-happens-if-you-replace-state-after-updating-it</em>/}</h3><p>让我们再看一个例子。你认为 <code>number</code> 在下一次渲染中的值是什么？<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>增加数字<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>以下是 React 在执行事件处理函数时处理这几行代码的过程：<ol><li><code>setNumber(number + 5)</code>：<code>number</code> 为 <code>0</code>，所以 <code>setNumber(0 + 5)</code>。React 将 <em>“替换为 <code>5</code>”</em> 添加到其队列中。<li><code>setNumber(n => n + 1)</code>：<code>n => n + 1</code> 是一个更新函数。React 将该函数添加到其队列中。<li><code>setNumber(42)</code>：React 将 <em>“替换为 <code>42</code>”</em> 添加到其队列中。</ol><p>在下一次渲染期间，React 会遍历 state 队列：<table><thead><tr><th>更新队列<th><code>n</code><th>返回值<tbody><tr><td>“替换为 <code>5</code>”<td><code>0</code>（未使用）<td><code>5</code><tr><td><code>n => n + 1</code><td><code>5</code><td><code>5 + 1 = 6</code><tr><td>“替换为 <code>42</code>”<td><code>6</code>（未使用）<td><code>42</code></table><p>然后 React 会保存 <code>42</code> 为最终结果并从 <code>useState</code> 中返回。<p>总而言之，以下是你可以考虑传递给 <code>setNumber</code> state 设置函数的内容：<ul><li><strong>一个更新函数</strong>（例如：<code>n => n + 1</code>）会被添加到队列中。<li><strong>任何其他的值</strong>（例如：数字 <code>5</code>）会导致“替换为 <code>5</code>”被添加到队列中，已经在队列中的内容会被忽略。</ul><p>事件处理函数执行完成后，React 将触发重新渲染。在重新渲染期间，React 将处理队列。更新函数会在渲染期间执行，因此 <strong>更新函数必须是 <a href="/learn/keeping-components-pure">纯函数</a></strong> 并且只 <strong>返回</strong> 结果。不要尝试从它们内部设置 state 或者执行其他副作用。在严格模式下，React 会执行每个更新函数两次（但是丢弃第二个结果）以便帮助你发现错误。</section><section class="level3"aria-labelledby="命名惯例-naming-conventions"><h3 id="命名惯例-naming-conventions">命名惯例 {/<em>naming-conventions</em>/}</h3><p>通常可以通过相应 state 变量的第一个字母来命名更新函数的参数：<pre class="language-js"><code class="language-js"><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setLastName</span><span class="token punctuation">(</span><span class="token parameter">ln</span> <span class="token arrow operator">=></span> ln<span class="token punctuation">.</span><span class="token method function property-access">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setFriendCount</span><span class="token punctuation">(</span><span class="token parameter">fc</span> <span class="token arrow operator">=></span> fc <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如果你喜欢更冗长的代码，另一个常见的惯例是重复使用完整的 state 变量名称，如 <code>setEnabled(enabled => !enabled)</code>，或使用前缀，如 <code>setEnabled(prevEnabled => !prevEnabled)</code>。</p><recap><ul><li>设置 state 不会更改现有渲染中的变量，但会请求一次新的渲染。<li>React 会在事件处理函数执行完成之后处理 state 更新。这被称为批处理。<li>要在一个事件中多次更新某些 state，你可以使用 <code>setNumber(n => n + 1)</code> 更新函数。</ul></recap><challenges><section class="level4"aria-labelledby="修复请求计数器-fix-a-request-counter"><h4 id="修复请求计数器-fix-a-request-counter">修复请求计数器 {/<em>fix-a-request-counter</em>/}</h4><p>你正在开发一个艺术市场应用，该应用允许一个用户为一个艺术品同时提交多个订单。每次用户按下“购买”按钮，“等待”计数器应该增加一。三秒后，“等待”计数器应该减少，“完成”计数器应该增加。<p>但是，“等待”计数器的行为并不符合预期。当你按下“购买”按钮时，它会减少到 <code>-1</code>（这本应该是不可能的）。如果你快速点击两次，两个计数器似乎都会出现无法预测的行为。<p>为什么会发生这种情况？修复两个计数器。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">RequestTracker</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>completed<span class="token punctuation">,</span> setCompleted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span>pending <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span>pending <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCompleted</span><span class="token punctuation">(</span>completed <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        等待：<span class="token punctuation">{</span>pending<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        完成：<span class="token punctuation">{</span>completed<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        购买
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>在 <code>handleClick</code> 事件处理函数内部，<code>pending</code> 和 <code>completed</code> 的值与他们在点击事件发生时的值相对应。对于第一次渲染，<code>pending</code> 为 <code>0</code> ，因此 <code>setPending(pending - 1)</code> 变成了 <code>setPending(-1)</code>，而这是错误的。既然你想要 <em>增加</em> 或 <em>减少</em> 计数器，你可以改为传递更新函数，而不是将计数器设置为在点击期间确定的具体值：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">RequestTracker</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>completed<span class="token punctuation">,</span> setCompleted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token arrow operator">=></span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token arrow operator">=></span> p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCompleted</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        等待：<span class="token punctuation">{</span>pending<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        完成：<span class="token punctuation">{</span>completed<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        购买
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>这可以确保你在增加或减少计数器时是根据其 <strong>最新</strong> 的 state 而不是点击时的 state 来进行增减的。</p></solution></section><section class="level4"aria-labelledby="自己实现状态队列-implement-the-state-queue-yourself"><h4 id="自己实现状态队列-implement-the-state-queue-yourself">自己实现状态队列 {/<em>implement-the-state-queue-yourself</em>/}</h4><p>在这个挑战中，你将从头开始重新实现 React 的一小部分！这并不像听起来那么难。<p>滚动 sandbox 进行预览。请注意，它显示了 <strong>四个测试用例</strong> 。它们与你之前在本页上看到过的示例相对应。你的任务是实现 <code>getFinalState</code> 函数，让它为每种情况返回正确的结果。如果你对它进行了正确的实现的话，那么所有四个测试用例都应该会通过。<p>你将收到两个参数：<code>baseState</code> 是初始状态（例如：<code>0</code>），<code>queue</code> 是一个既包含数字（例如：<code>5</code>）也包含更新函数（例如：<code>n => n + 1</code>）的数组，这些数字和数组会被按照它们被添加进来的顺序排列。<p>你的任务是返回最终的 state，如同页面上的表格展示的那样！</p><hint><p>如果你没有思路，可以从下面的代码结构开始:<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> update <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: 调用更新函数</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: 替换 state</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>补全缺失的几行代码！</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token comment">// TODO: 对队列做些什么...</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getFinalState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./processQueue.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
increment<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'n => n+1'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          increment<span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          increment
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          <span class="token number">42</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TestCase</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  expected
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>初始 state：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>baseState<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>队列：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">{</span>queue<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>预期结果：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>expected<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> actual <span class="token operator">===</span> expected <span class="token operator">?</span>
        <span class="token string-property property">'green'</span> <span class="token operator">:</span>
        <span class="token string">'red'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        你的结果：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>actual<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'正确'</span> <span class="token operator">:</span>
          <span class="token string">'错误'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>这其实就是这一页中所描述的 React 用来计算最终 state 的算法:</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> update <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 调用更新函数</span>
      finalState <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>finalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 替换下一个 state</span>
      finalState <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getFinalState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./processQueue.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
increment<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'n => n+1'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          increment<span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          increment
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          <span class="token number">42</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TestCase</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  expected
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>初始 state：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>baseState<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>队列：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">{</span>queue<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>预期结果：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>expected<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> actual <span class="token operator">===</span> expected <span class="token operator">?</span>
        <span class="token string-property property">'green'</span> <span class="token operator">:</span>
        <span class="token string">'red'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        你的结果：<span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>actual<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'正确'</span> <span class="token operator">:</span>
          <span class="token string">'错误'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>现在你知道 React 的这一部分是如何运行的了吧！</p></solution><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></challenges></section></section></section>