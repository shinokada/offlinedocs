<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>渲染和提交</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="渲染和提交"><h1 id="渲染和提交">渲染和提交</h1><p>translators:<ul><li>oceanlvr<li>KimYangOfCat<li>Neo42<li>TinaaaaP<li>KnowsCount</ul><intro><p>组件显示到屏幕之前，其必须被 React 渲染。理解这些处理步骤将帮助您思考代码的执行过程并能解释其行为。</p></intro><youwilllearn><ul><li>在 React 中渲染的含义是什么<li>为什么以及什么时候 React 会渲染一个组件<li>在屏幕上显示组件所涉及的步骤<li>为什么渲染并不一定会导致 DOM 更新</ul></youwilllearn><p>想象一下，您的组件是厨房里的厨师，把食材烹制成美味的菜肴。在这种场景下，React 就是一名服务员，他会帮客户们下单并为他们送来所点的菜品。这种请求和提供 UI 的过程总共包括三个步骤：<ol><li><strong>触发</strong> 一次渲染（把客人的点单分发到厨房）<li><strong>渲染</strong> 组件（在厨房准备订单）<li><strong>提交</strong> 到 DOM（将菜品放在桌子上）</ol><illustrationblock sequential=""><illustration caption="触发"alt="React 作为餐厅里的服务员，从用户那里获取点单并把它们分发到组件厨房。"src.=""docs=""illustrations=""i_render-and-commit1.png&#x22;=""><illustration caption="渲染"alt="Card 主厨交给 React 一个新鲜的 Card 组件。"src.=""docs=""illustrations=""i_render-and-commit2.png&#x22;=""><illustration caption="提交"alt="React 把 Card 送到用户桌上。"src.=""docs=""illustrations=""i_render-and-commit3.png&#x22;=""></illustration></illustration></illustration></illustrationblock><section class="level2"aria-labelledby="步骤-1-触发一次渲染-step-1-trigger-a-render"><h2 id="步骤-1-触发一次渲染-step-1-trigger-a-render">步骤 1: 触发一次渲染 {/<em>step-1-trigger-a-render</em>/}</h2><p>有两种原因会导致组件的渲染:<ol><li>组件的 <strong>初次渲染。</strong><li>组件（或者其祖先之一）的 <strong>状态发生了改变。</strong></ol><section class="level3"aria-labelledby="初次渲染-initial-render"><h3 id="初次渲染-initial-render">初次渲染 {/<em>initial-render</em>/}</h3><p>当应用启动时，会触发初次渲染。框架和沙箱有时会隐藏这部分代码，但它是通过调用目标 DOM 节点的 <a href="/reference/react-dom/client/createRoot"><code>createRoot</code></a>，然后用你的组件调用 <code>render</code> 函数完成的：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Image</span></span> <span class="token keyword module">from</span> <span class="token string">'./Image.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Image</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>img
      src<span class="token operator">=</span><span class="token string">"https://i.imgur.com/ZF6s192.jpg"</span>
      alt<span class="token operator">=</span><span class="token string">"'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"</span>
    <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>试着注释掉 <code>root.render()</code>，然后您将会看到组件消失。</section><section class="level3"aria-labelledby="状态更新时重新渲染-re-renders-when-state-updates"><h3 id="状态更新时重新渲染-re-renders-when-state-updates">状态更新时重新渲染 {/<em>re-renders-when-state-updates</em>/}</h3><p>一旦组件被初次渲染，您就可以通过使用 <a href="/reference/react/useState#setstate"><code>set</code> 函数</a> 更新其状态来触发之后的渲染。更新组件的状态会自动将一次渲染送入队列。（您可以想象这种情况成餐厅客人在第一次下单之后又点了茶、点心和各种东西，具体取决于他们的胃口。）</p><illustrationblock sequential=""><illustration caption="状态更新..."alt="React 作为餐厅服务员将一份 Card UI 送到用户那里，这里的用户以头部为光标的顾客表示。顾客说她想要一个粉色的 Card，而不是黑色的。"src.=""docs=""illustrations=""i_rerender1.png&#x22;=""><illustration caption="...触发..."alt="React 回到组件厨房并告诉 Card 主厨他们需要一个粉色 Card。"src.=""docs=""illustrations=""i_rerender2.png&#x22;=""><illustration caption="...渲染!"alt="Card 主厨把粉色 Card 交给 React。"src.=""docs=""illustrations=""i_rerender3.png&#x22;=""></illustration></illustration></illustration></illustrationblock></section></section><section class="level2"aria-labelledby="步骤-2-react-渲染您的组件-step-2-react-renders-your-components"><h2 id="步骤-2-react-渲染您的组件-step-2-react-renders-your-components">步骤 2: React 渲染您的组件 {/<em>step-2-react-renders-your-components</em>/}</h2><p>在您触发渲染后，React 会调用您的组件来确定要在屏幕上显示的内容。<strong>"渲染中" 即 React 在调用您的组件。</strong><ul><li><strong>在进行初次渲染时,</strong> React 会调用根组件。<li><strong>对于后续的渲染,</strong> React 会调用内部状态更新触发了渲染的函数组件。</ul><p>这个过程是递归的：如果更新后的组件会返回某个另外的组件，那么 React 接下来就会渲染 <em>那个</em> 组件，而如果那个组件又返回了某个组件，那么 React 接下来就会渲染 <em>那个</em> 组件，以此类推。这个过程会持续下去，直到没有更多的嵌套组件并且 React 确切知道哪些东西应该显示到屏幕上为止。<p>在接下来的例子中，React 将会调用 <code>Gallery()</code> 和 <code>Image()</code> 若干次：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Gallery</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>section<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span>鼓舞人心的雕塑<span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>section<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Image</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>img
      src<span class="token operator">=</span><span class="token string">"https://i.imgur.com/ZF6s192.jpg"</span>
      alt<span class="token operator">=</span><span class="token string">"'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"</span>
    <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Gallery</span></span> <span class="token keyword module">from</span> <span class="token string">'./Gallery.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Gallery</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">img</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><ul><li><strong>在初次渲染中，</strong> React 将会为<code>&#x3C;section></code>、<code>&#x3C;h1></code> 和三个 <code>&#x3C;img></code> 标签 <a href="https://developer.mozilla.org/docs/Web/API/Document/createElement">创建 DOM 节点</a>。<li><strong>在一次重渲染过程中,</strong> React 将计算它们的哪些属性（如果有的话）自上次渲染以来已更改。在下一步（提交阶段）之前，它不会对这些信息执行任何操作。</ul><pitfall><p>渲染必须始终是一次 <a href="/learn/keeping-components-pure">纯计算</a>:<ul><li><strong>输入相同，输出相同。</strong> 给定相同的输入，组件应始终返回相同的 JSX。（当有人点了西红柿沙拉时，他们不应该收到洋葱沙拉！）<li><strong>只做它自己的事情。</strong> 它不应更改任何存在于渲染之前的对象或变量。（一个订单不应更改其他任何人的订单。）</ul><p>否则，随着代码库复杂性的增加，您可能会遇到令人困惑的错误和不可预测的行为。在 "严格模式" 下开发时，React 会调用每个组件的函数两次，这可以帮助发现由不纯函数引起的错误。</p></pitfall><deepdive><section class="level4"aria-labelledby="性能优化-optimizing-performance"><h4 id="性能优化-optimizing-performance">性能优化 {/<em>optimizing-performance</em>/}</h4><p>如果更新的组件在树中的位置非常高，渲染更新后的组件内部所有嵌套组件的默认行为将不会获得最佳性能。如果您遇到了性能问题，<a href="https://reactjs.org/docs/optimizing-performance.html">性能</a> 章节描述了几种可选的解决方案 。<strong>不要过早进行优化！</strong></section></deepdive></section><section class="level2"aria-labelledby="步骤-3-react-把更改提交到-dom-上-step-3-react-commits-changes-to-the-dom"><h2 id="步骤-3-react-把更改提交到-dom-上-step-3-react-commits-changes-to-the-dom">步骤 3: React 把更改提交到 DOM 上 {/<em>step-3-react-commits-changes-to-the-dom</em>/}</h2><p>在渲染（调用）您的组件之后，React 将会修改 DOM。<ul><li><strong>对于初次渲染，</strong> React 会使用 <a href="https://developer.mozilla.org/docs/Web/API/Node/appendChild"><code>appendChild()</code></a> DOM API 将其创建的所有 DOM 节点放在屏幕上。<li><strong>对于重渲染，</strong> React 将应用最少的必要操作（在渲染时计算！），以使得 DOM 与最新的渲染输出相互匹配。</ul><p><strong>React 仅在渲染之间存在差异时才会更改 DOM 节点。</strong> 例如，有一个组件，它每秒使用从父组件传递下来的不同属性重新渲染一次。注意，您可以添加一些文本到 <code>&#x3C;input></code> 标签，更新它的 <code>value</code>，但是文本不会在组件重渲染时消失：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Clock</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> time <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>time<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Clock</span></span> <span class="token keyword module">from</span> <span class="token string">'./Clock.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> setTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">useTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Clock</span> time<span class="token operator">=</span><span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>这个例子之所以会正常运行，是因为在最后一步中，React 只会使用最新的 <code>time</code> 更新 <code>&#x3C;h1></code> 标签的内容。它看到 <code>&#x3C;input></code> 标签出现在 JSX 中与上次相同的位置，因此 React 不会修改 <code>&#x3C;input></code> 标签或它的 <code>value</code>！ ## 尾声：浏览器绘制 {/<em>epilogue-browser-paint</em>/}<p>在渲染完成并且 React 更新 DOM 之后，浏览器就会重新绘制屏幕。尽管这个过程被称为“浏览器渲染”（“browser rendering”），但我们还是将它称为“绘制”（“painting”），以避免在这些文档的其余部分中出现混淆。<p>&#x3C;Illustration alt="浏览器正在绘制《静物：Card 元素》" src./docs/illustrations/i_browser-paint.png" /></p><recap><ul><li>在一个 React 应用中一次屏幕更新都会发生以下三个步骤：<ol><li>触发<li>渲染<li>提交</ol><li>您可以使用严格模式去找到组件中的错误<li>如果渲染结果与上次一样，那么 React 将不会修改 DOM</ul></recap><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>