<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>'使用 ref 引用值'</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="使用-ref-引用值"><h1 id="使用-ref-引用值">'使用 ref 引用值'</h1><p>translators:<ul><li>SylviaZ89<li>Neo42</ul><intro><p>当你希望组件“记住”某些信息，但又不想让这些信息 <a href="/learn/render-and-commit">触发新的渲染</a> 时，你可以使用 <strong>ref</strong> 。</p></intro><youwilllearn><ul><li>如何向组件添加 ref<li>如何更新 ref 的值<li>ref 与 state 有何不同<li>如何安全地使用 ref</ul></youwilllearn><section class="level2"aria-labelledby="给你的组件添加-ref-adding-a-ref-to-your-component"><h2 id="给你的组件添加-ref-adding-a-ref-to-your-component">给你的组件添加 ref {/<em>adding-a-ref-to-your-component</em>/}</h2><p>你可以通过从 React 导入 <code>useRef</code> Hook 来为你的组件添加一个 ref：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span></code></pre><p>在你的组件内，调用 <code>useRef</code> Hook 并传入你想要引用的初始值作为唯一参数。例如，这里的 ref 引用的值是“0”：<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>useRef</code> 返回一个这样的对象:<pre class="language-js"><code class="language-js"><span class="token punctuation">{</span> 
  <span class="token literal-property property">current</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">// 你向 useRef 传入的值</span>
<span class="token punctuation">}</span></code></pre><p>&#x3C;Illustration src./docs/illustrations/i_ref.png" alt="An arrow with 'current' written on it stuffed into a pocket with 'ref' written on it." /><p>你可以用 <code>ref.current</code> 属性访问该 ref 的当前值。这个值是有意被设置为可变的，意味着你既可以读取它也可以写入它。就像一个 React 追踪不到的、用来存储组件信息的秘密“口袋”。（这就是让它成为 React 单向数据流的“脱围机制”的原因 —— 详见下文！）<p>这里，每次点击按钮时会使 <code>ref.current</code> 递增：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'你点击了 '</span> <span class="token operator">+</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">+</span> <span class="token string">' 次！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
      点击我！
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>这里的 ref 指向一个数字，但是，像 <a href="/learn/state-a-components-memory">state</a> 一样，你可以让它指向任何东西：字符串、对象，甚至是函数。与 state 不同的是，ref 是一个普通的 JavaScript 对象，具有可以被读取和修改的 <code>current</code> 属性。<p>请注意，<strong>组件不会在每次递增时重新渲染。</strong> 与 state 一样，React 会在每次重新渲染之间保留 ref。但是，设置 state 会重新渲染组件，更改 ref 不会！</section><section class="level2"aria-labelledby="示例制作秒表-example-building-a-stopwatch"><h2 id="示例制作秒表-example-building-a-stopwatch">示例：制作秒表 {/<em>example-building-a-stopwatch</em>/}</h2><p>你可以在单个组件中把 ref 和 state 结合起来使用。例如，让我们制作一个秒表，用户可以通过按按钮来使其启动或停止。为了显示从用户按下“开始”以来经过的时间长度，你需要追踪按下“开始”按钮的时间和当前时间。<strong>此信息用于渲染，所以你会把它保存在 state 中：</strong><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>startTime<span class="token punctuation">,</span> setStartTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">[</span>now<span class="token punctuation">,</span> setNow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>当用户按下“开始”时，你将用 <a href="https://developer.mozilla.org/docs/Web/API/setInterval"><code>setInterval</code></a> 每 10 毫秒更新一次时间：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Stopwatch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>startTime<span class="token punctuation">,</span> setStartTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>now<span class="token punctuation">,</span> setNow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 开始计时。</span>
    <span class="token function">setStartTime</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// 每 10ms 更新一次当前时间。</span>
      <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> secondsPassed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">!=</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> now <span class="token operator">!=</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    secondsPassed <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span>时间过去了： <span class="token punctuation">{</span>secondsPassed<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleStart<span class="token punctuation">}</span><span class="token operator">></span>
        开始
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>当按下“停止”按钮时，你需要取消现有的 interval，以便让它停止更新 <code>now</code> state 变量。你可以通过调用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/clearInterval"><code>clearInterval</code></a> 来完成此操作。但你需要为其提供 interval ID，此 ID 是之前用户按下 Start、调用 <code>setInterval</code> 时返回的。你需要将 interval ID 保留在某处。 <strong>由于 interval ID 不用于渲染，你可以将其保存在 ref 中：</strong></p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Stopwatch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>startTime<span class="token punctuation">,</span> setStartTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>now<span class="token punctuation">,</span> setNow<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> intervalRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setStartTime</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">clearInterval</span><span class="token punctuation">(</span>intervalRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    intervalRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setNow</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>intervalRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> secondsPassed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>startTime <span class="token operator">!=</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> now <span class="token operator">!=</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    secondsPassed <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> startTime<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span>时间过去了： <span class="token punctuation">{</span>secondsPassed<span class="token punctuation">.</span><span class="token method function property-access">toFixed</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleStart<span class="token punctuation">}</span><span class="token operator">></span>
        开始
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleStop<span class="token punctuation">}</span><span class="token operator">></span>
        停止
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>当一条信息用于渲染时，将它保存在 state 中。当一条信息仅被事件处理器需要，并且更改它不需要重新渲染时，使用 ref 可能会更高效。</section><section class="level2"aria-labelledby="ref-和-state-的不同之处-differences-between-refs-and-state"><h2 id="ref-和-state-的不同之处-differences-between-refs-and-state">ref 和 state 的不同之处 {/<em>differences-between-refs-and-state</em>/}</h2><p>也许你觉得 ref 似乎没有 state 那样“严格” —— 例如，你可以改变它们而非总是必须使用 state 设置函数。但在大多数情况下，我们建议你使用 state。ref 是一种“脱围机制”，你并不会经常用到它。 以下是 state 和 ref 的对比：<table><thead><tr><th>ref<th>state<tbody><tr><td><code>useRef(initialValue)</code>返回 <code>{ current: initialValue }</code><td><code>useState(initialValue)</code> 返回 state 变量的当前值和一个 state 设置函数 ( <code>[value, setValue]</code>)<tr><td>更改时不会触发重新渲染<td>更改时触发重新渲染。<tr><td>可变 —— 你可以在渲染过程之外修改和更新 <code>current</code> 的值。<td>“不可变” —— 你必须使用 state 设置函数来修改 state 变量，从而排队重新渲染。<tr><td>你不应在渲染期间读取（或写入） <code>current</code> 值。<td>你可以随时读取 state。但是，每次渲染都有自己不变的 state <a href="/learn/state-as-a-snapshot">快照</a>。</table><p>这是一个使用 state 实现的计数器按钮：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setCount</span><span class="token punctuation">(</span>count <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
      你点击了 <span class="token punctuation">{</span>count<span class="token punctuation">}</span> 次
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>因为 <code>count</code> 的值将会被显示，所以为其使用 state 是合理的。当使用 setCount() 设置计数器的值时，React 会重新渲染组件，并且屏幕会更新以展示新的计数。<p>如果你试图用 ref 来实现它，React 永远不会重新渲染组件，所以你永远不会看到计数变化！看看点击这个按钮如何 <strong>不更新它的文本</strong>：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> countRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 这样并未重新渲染组件！</span>
    countRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> countRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
      你点击了 <span class="token punctuation">{</span>countRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">}</span> 次
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>这就是在渲染期间读取 <code>ref.current</code> 会导致代码不可靠的原因。如果需要，请改用 state。</p><deepdive><section class="level4"aria-labelledby="useref-内部是如何运行的-how-does-use-ref-work-inside"><h4 id="useref-内部是如何运行的-how-does-use-ref-work-inside">useRef 内部是如何运行的？ {/<em>how-does-use-ref-work-inside</em>/}</h4><p>尽管 <code>useState</code> 和 <code>useRef</code> 都是由 React 提供的，原则上 <code>useRef</code> 可以在 <code>useState</code> <strong>的基础上</strong> 实现。 你可以想象在 React 内部，<code>useRef</code> 是这样实现的：<pre class="language-js"><code class="language-js"><span class="token comment">// React 内部</span>
<span class="token keyword">function</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token parameter">initialValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>ref<span class="token punctuation">,</span> unused<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">current</span><span class="token operator">:</span> initialValue <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>第一次渲染期间，<code>useRef</code> 返回 <code>{ current: initialValue }</code>。 该对象由 React 存储，因此在下一次渲染期间将返回相同的对象。 请注意，在这个示例中，state 设置函数没有被用到。它是不必要的，因为 <code>useRef</code> 总是需要返回相同的对象！<p>React 提供了一个内置版本的 <code>useRef</code>，因为它在实践中很常见。 但是你可以将其视为没有设置函数的常规 state 变量。 如果你熟悉面向对象编程，ref 可能会让你想起实例字段 —— 但是你写的不是 <code>this.something</code>，而是 <code>somethingRef.current</code>。</section></deepdive></section><section class="level2"aria-labelledby="何时使用-ref-when-to-use-refs"><h2 id="何时使用-ref-when-to-use-refs">何时使用 ref {/<em>when-to-use-refs</em>/}</h2><p>通常，当你的组件需要“跳出” React 并与外部 API 通信时，你会用到 ref —— 通常是不会影响组件外观的浏览器 API。以下是这些罕见情况中的几个：<ul><li>存储 <a href="https://developer.mozilla.org/docs/Web/API/setTimeout">timeout ID</a><li>存储和操作 <a href="https://developer.mozilla.org/docs/Web/API/Element">DOM 元素</a>，我们将在 <a href="/learn/manipulating-the-dom-with-refs">下一页</a> 中介绍<li>存储不需要被用来计算 JSX 的其他对象。</ul><p>如果你的组件需要存储一些值，但不影响渲染逻辑，请选择 ref。</section><section class="level2"aria-labelledby="ref-的最佳实践-best-practices-for-refs"><h2 id="ref-的最佳实践-best-practices-for-refs">ref 的最佳实践 {/<em>best-practices-for-refs</em>/}</h2><p>遵循这些原则将使你的组件更具可预测性：<ul><li><strong>将 ref 视为脱围机制</strong>。当你使用外部系统或浏览器 API 时，ref 很有用。如果你很大一部分应用程序逻辑和数据流都依赖于 ref，你可能需要重新考虑你的方法。<li><strong>不要在渲染过程中读取或写入 <code>ref.current</code>。</strong> 如果渲染过程中需要某些信息，请使用 <a href="/learn/state-a-components-memory">state</a> 代替。由于 React 不知道 <code>ref.current</code> 何时发生变化，即使在渲染时读取它也会使组件的行为难以预测。（唯一的例外是像 <code>if (!ref.current) ref.current = new Thing()</code> 这样的代码，它只在第一次渲染期间设置一次 ref。）</ul><p>React state 的限制不适用于 ref。例如，state 就像 <a href="/learn/state-as-a-snapshot">每次渲染的快照</a>，并且 <a href="/learn/queueing-a-series-of-state-updates">不会同步更新</a>。但是当你改变 ref 的 current 值时，它会立即改变：<pre class="language-js"><code class="language-js">ref<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5</span></code></pre><p>这是因为 <strong>ref 本身是一个普通的 JavaScript 对象，</strong> 所以它的行为就像对象那样。<p>当你使用 ref 时，也无需担心 <a href="/learn/updating-objects-in-state">避免变更</a>。只要你改变的对象不用于渲染，React 就不会关心你对 ref 或其内容做了什么。</section><section class="level2"aria-labelledby="ref-和-dom-refs-and-the-dom"><h2 id="ref-和-dom-refs-and-the-dom">ref 和 DOM {/<em>refs-and-the-dom</em>/}</h2><p>你可以将 ref 指向任何值。但是，ref 最常见的用法是访问 DOM 元素。例如，如果你想以编程方式聚焦一个输入框，这种用法就会派上用场。当你将 ref 传递给 JSX 中的 <code>ref</code> 属性时，比如 <code>&#x3C;div ref={myRef}></code>，React 会将相应的 DOM 元素放入 <code>myRef.current</code> 中。当元素从 DOM 中删除时，React 会将 <code>myRef.current</code> 更新为 <code>null</code>。你可以在 <a href="/learn/manipulating-the-dom-with-refs">使用 ref 操作 DOM</a> 中阅读更多相关信息。</p><recap><ul><li>ref 是一种脱围机制，用于保留不用于渲染的值。 你不会经常需要它们。<li>ref 是一个普通的 JavaScript 对象，具有一个名为 <code>current</code> 的属性，你可以对其进行读取或设置。<li>你可以通过调用 <code>useRef</code> Hook 来让 React 给你一个 ref。<li>与 state 一样，ref 允许你在组件的重新渲染之间保留信息。<li>与 state 不同，设置 ref 的 <code>current</code> 值不会触发重新渲染。<li>不要在渲染过程中读取或写入 <code>ref.current</code>。这使你的组件难以预测。</ul></recap><challenges><section class="level4"aria-labelledby="修复坏掉的聊天输入框-fix-a-broken-chat-input"><h4 id="修复坏掉的聊天输入框-fix-a-broken-chat-input">修复坏掉的聊天输入框 {/<em>fix-a-broken-chat-input</em>/}</h4><p>输入消息并单击“发送”。你会注意到，在看到“已发送！”提示框之前有 3 秒的延迟。在此延迟期间，你可以看到一个“撤消”按钮。点击它。这个“撤消”按钮应该阻止“发送！”消息弹出。它通过调用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/clearTimeout"><code>clearTimeout</code></a> 来做到这点，这一步骤需要使用在 <code>handleSend</code> 时保存的 timeout ID。但是，即使在单击“撤消”后，“已发送！”消息仍然出现。找出它不起作用的原因，然后修复它。</p><hint><p>像<code>let timeoutID</code> 这样的常规变量不会在重新渲染之间“存活”，因为每次渲染都从头开始运行你的组件（并初始化其变量）。你应该将 timeout ID 保存在其他地方吗？</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isSending<span class="token punctuation">,</span> setIsSending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> timeoutID <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'已发送！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleUndo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>isSending <span class="token operator">?</span> <span class="token string">'发送中……'</span> <span class="token operator">:</span> <span class="token string">'发送'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>isSending <span class="token operator">&#x26;&#x26;</span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleUndo<span class="token punctuation">}</span><span class="token operator">></span>
          撤销
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>每当你的组件重新渲染时（例如当你设置 state 时），所有局部变量都会从头开始初始化。这就是为什么你不能将 timeout ID 保存在像 <code>timeoutID</code> 这样的局部变量中，然后期望未来另一个事件处理器“看到”它。相反，将它存储在一个 ref 中，React 将在渲染之间保留它。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isSending<span class="token punctuation">,</span> setIsSending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> timeoutRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'已发送!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleUndo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setIsSending</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isSending<span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>isSending <span class="token operator">?</span> <span class="token string">'发送中……'</span> <span class="token operator">:</span> <span class="token string">'发送'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>isSending <span class="token operator">&#x26;&#x26;</span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleUndo<span class="token punctuation">}</span><span class="token operator">></span>
          撤销
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="修复无法重新渲染的组件-fix-a-component-failing-to-re-render"><h4 id="修复无法重新渲染的组件-fix-a-component-failing-to-re-render">修复无法重新渲染的组件 {/<em>fix-a-component-failing-to-re-render</em>/}</h4><p>这个按钮本该在显示“开”和“关”之间切换。但是，它始终显示“关”。这段代码有什么问题？修复它。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Toggle</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      isOnRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token operator">!</span>isOnRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOnRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">?</span> <span class="token string">'开'</span> <span class="token operator">:</span> <span class="token string">'关'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>在这个例子中，ref 的 current 值被用于计算渲染输出：<code>{isOnRef.current ? '开'：'关'}</code>。这表明此信息本来不应该在 ref 中，而应该放在 state 里。要修复它，请删除 ref ，使用 state 代替：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Toggle</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isOn<span class="token punctuation">,</span> setIsOn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setIsOn</span><span class="token punctuation">(</span><span class="token operator">!</span>isOn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOn <span class="token operator">?</span> <span class="token string">'开'</span> <span class="token operator">:</span> <span class="token string">'关'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="修复防抖-fix-debouncing"><h4 id="修复防抖-fix-debouncing">修复防抖 {/<em>fix-debouncing</em>/}</h4><p>在这个例子中，所有按钮点击处理器都是 <a href="https://redd.one/blog/debounce-vs-throttle">"防抖的"</a>。 要了解这意味着什么，请按下其中一个按钮。注意消息在一秒后显示。如果你在等待消息时按下按钮，计时器将重置。因此如果你多次快速单击同一个按钮，则直到你停止单击 <strong>之后</strong> 1 秒钟，该消息才会显示。防抖可以让你将一些动作推迟到用户“停止动作”之后。<p>这个例子可以正常运行，但并不完全符合预期。按钮不是独立的。要查看问题，请单击其中一个按钮，然后立即单击另一个按钮。你本来期望在延迟之后，你会看到两个按钮的消息。但只有最后一个按钮的消息出现了。第一个按钮的消息丢失了。<p>为什么按钮会相互干扰呢？查找并修复问题。</p><hint><p>最后一个 timeout ID 变量是被所有 <code>DebouncedButton</code> 组件所共享的。这就是为什么单击一个按钮会重置另一个按钮的 timeout 时间。你能为每个按钮存储一个单独的 timeout ID 吗？</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword">let</span> timeoutID<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">DebouncedButton</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onClick<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutID<span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutID <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Dashboard</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'宇宙飞船已发射！'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        发射宇宙飞船
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'汤煮好了！'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        煮点儿汤
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'摇篮曲唱完了！'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        唱首摇篮曲
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><solution><p>像 <code>timeoutID</code> 这样的变量是被所有组件共享的。这就是单击第二个按钮会重置第一个按钮未完成的 timeout 的原因。要解决此问题，你可以把 timeout 保存在 ref 中。每个按钮都有自己的 ref，因此它们不会相互冲突。请注意快速单击两个按钮如何显示两个消息。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">DebouncedButton</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> onClick<span class="token punctuation">,</span> children <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timeoutRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeoutRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Dashboard</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'宇宙飞船已发射！'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        发射宇宙飞船
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'汤煮好了！'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        煮点儿汤
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">DebouncedButton</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'摇篮曲唱完了！'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        唱首摇篮曲
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">DebouncedButton</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="读取最新的-state-read-the-latest-state"><h4 id="读取最新的-state-read-the-latest-state">读取最新的 state {/<em>read-the-latest-state</em>/}</h4><p>在此示例中，当你按下“发送”后，在显示消息之前会有一小段延迟。输入“你好”，按下发送，然后再次快速编辑输入。尽管你进行了编辑，提示框仍会显示“你好”（这是按钮被点击 <a href="/learn/state-as-a-snapshot#state-over-time">那一刻</a> state 的值）。<p>通常，这种行为是你在应用程序中想要的。但是，有时可能需要一些异步代码来读取某些 state 的 <strong>最新</strong> 版本。你能想出一种方法，让提示框显示 <strong>当前</strong> 输入文本而不是点击时的内容吗？</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'正在发送：'</span> <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        发送
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>state 运作起来 <a href="/learn/state-as-a-snapshot">就像快照</a>，因此你无法从 timeout 等异步操作中读取最新的 state。但是，你可以在 ref 中保存最新的输入文本。ref 是可变的，因此你可以随时读取 <code>current</code> 属性。由于当前文本也用于渲染，在这个例子中，你需要 <strong>同时</strong> 使用一个 state 变量（用于渲染）<strong>和</strong> 一个 ref（在 timeout 时读取它）。你需要手动更新当前的 ref 值。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chat</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> textRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setText</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    textRef<span class="token punctuation">.</span><span class="token property-access">current</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleSend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'正在发送：'</span> <span class="token operator">+</span> textRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input
        value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSend<span class="token punctuation">}</span><span class="token operator">></span>
        发送
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></challenges></section></section>