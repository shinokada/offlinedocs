<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>flushSync</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="flushsync"><h1 id="flushsync">flushSync</h1><pitfall><p>使用 <code>flushSync</code> 是不常见的行为，并且可能损伤应用程序的性能。</p></pitfall><intro><p><code>flushSync</code> 允许你强制 React 在提供的回调函数内同步刷新任何更新，这将确保 DOM 立即更新。<pre class="language-js"><code class="language-js"><span class="token function">flushSync</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="参考-reference"><h2 id="参考-reference">参考 {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="flushsynccallback-flushsync"><h3 id="flushsynccallback-flushsync"><code>flushSync(callback)</code> {/<em>flushsync</em>/}</h3><p>调用 <code>flushSync</code> 强制 React 刷新所有挂起的工作，并同步更新 DOM。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> flushSync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setSomething</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>大多数时候都不需要使用 <code>flushSync</code>，请将其作为最后的手段使用。<p><a href="#usage">参见下面更多示例</a>。<section class="level4"aria-labelledby="参数-parameters"><h4 id="参数-parameters">参数 {/<em>parameters</em>/}</h4><ul><li><code>callback</code>：一个函数。React 会立即调用这个回调函数，并同步刷新其中包含的任何更新。它也可能会刷新任何挂起的更新、Effect 或 Effect 内部的更新。如果因为调用 <code>flushSync</code> 而导致更新挂起（suspend），则可能会重新显示后备方案。</ul></section><section class="level4"aria-labelledby="返回值-returns"><h4 id="返回值-returns">返回值 {/<em>returns</em>/}</h4><p><code>flushSync</code> 返回 <code>undefined</code>。</section><section class="level4"aria-labelledby="注意-caveats"><h4 id="注意-caveats">注意 {/<em>caveats</em>/}</h4><ul><li><code>flushSync</code> 可能会严重影响性能，因此请谨慎使用。<li><code>flushSync</code> 可能会强制挂起的 Suspense 边界显示其 <code>fallback</code> 状态。<li><code>flushSync</code> 可能会在返回之前运行挂起的 Effect，并同步应用其包含的任何更新。<li><code>flushSync</code> 可能会在必要时刷新回调函数之外的更新，以便刷新回调函数内部的更新。例如，如果有来自点击事件的挂起更新，React 可能会在刷新回调函数内部的更新之前刷新这些更新。</ul></section></section></section><section class="level2"aria-labelledby="用法-usage"><h2 id="用法-usage">用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="刷新第三方集成更新-flushing-updates-for-third-party-integrations"><h3 id="刷新第三方集成更新-flushing-updates-for-third-party-integrations">刷新第三方集成更新 {/<em>flushing-updates-for-third-party-integrations</em>/}</h3><p>当与浏览器 API 或 UI 库等第三方代码集成时，可能需要强制 React 刷新更新。调用 <code>flushSync</code> 以强制 React 同步刷新在回调函数内的任何状态更新：<pre class="language-js"><code class="language-js"><span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setSomething</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 这一行代码运行之后，DOM 将被更新。</span></code></pre><p>这确保了在下一行代码运行时，React 已经更新了 DOM。<p><strong>使用 <code>flushSync</code> 是不常见的行为，频繁调用可能会严重影响应用程序的性能</strong>。如果你的应用只使用 React API，并且不与第三方库集成，那么 <code>flushSync</code> 应该是不必要的。<p>然而，它对于与浏览器 API 等第三方代码集成可能会有帮助。<p>一些浏览器 API 希望回调函数内的结果同步写入 DOM，以便在回调函数结束时，浏览器可以对渲染的 DOM 进行操作。在大多数情况下，React 会自动处理这个问题。但在某些情况下，可能需要强制进行同步更新。<p>例如，浏览器的 <code>onbeforeprint</code> API 允许你在打印对话框打开之前立即更改页面。这对于应用自定义打印样式，使文档在打印时能够更好地显示非常有用。在下面的示例中，你在 <code>onbeforeprint</code> 回调函数内调用 <code>flushSync</code> 来立即将 React 状态“刷新”到 DOM 中。然后，当打印对话框打开时，<code>isPrinting</code> 会显示为“是”：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> flushSync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">PrintApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPrinting<span class="token punctuation">,</span> setIsPrinting<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">handleBeforePrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setIsPrinting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">handleAfterPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setIsPrinting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeprint'</span><span class="token punctuation">,</span> handleBeforePrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'afterprint'</span><span class="token punctuation">,</span> handleAfterPrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeprint'</span><span class="token punctuation">,</span> handleBeforePrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'afterprint'</span><span class="token punctuation">,</span> handleAfterPrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span>是否打印：<span class="token punctuation">{</span>isPrinting <span class="token operator">?</span> <span class="token string">'是'</span> <span class="token operator">:</span> <span class="token string">'否'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        打印
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>如果没有使用 <code>flushSync</code>，打印对话框会将 <code>isPrinting</code> 显示为“否”。这是因为 React 将异步批处理更新，而打印对话框在状态更新之前就显示出来了。</p><pitfall><p><code>flushSync</code> 可能会严重影响性能，并且可能会意外地强制挂起的 Suspense 边界显示其后备状态。<p>大多数时候都不需要使用 <code>flushSync</code>，请将其作为最后的手段使用。</p></pitfall><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>