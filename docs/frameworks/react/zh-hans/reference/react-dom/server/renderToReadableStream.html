<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>renderToReadableStream</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="rendertoreadablestream"><h1 id="rendertoreadablestream">renderToReadableStream</h1><intro><p><code>renderToReadableStream</code> 将 React 树渲染后发送至 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream">Web 可读流</a>。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span>reactNode<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><note><p>这个 API 依赖 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Streams_API">Web 流</a>，因此在 Node.js 中使用 <a href="/reference/react-dom/server/renderToPipeableStream"><code>renderToPipeableStream</code></a> 代替。</p></note><section class="level2"aria-labelledby="参考-reference"><h2 id="参考-reference">参考 {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="rendertoreadablestreamreactnode-options-rendertoreadablestream"><h3 id="rendertoreadablestreamreactnode-options-rendertoreadablestream"><code>renderToReadableStream(reactNode, options?)</code> {/<em>rendertoreadablestream</em>/}</h3><p>调用 <code>renderToReadableStream</code>，将 React 树渲染为 HTML 后，发送至 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream">Web 可读流</a> 中。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToReadableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>在客户端上，调用 <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a> 使服务器生成的 HTML 变得可交互。<p><a href="#usage">请参阅下面的更多示例</a>。<section class="level4"aria-labelledby="参数-parameters"><h4 id="参数-parameters">参数 {/<em>parameters</em>/}</h4><ul><li><p><code>reactNode</code>：要渲染为 HTML 的 React 节点。例如，类似 <code>&#x3C;App /></code> 的 JSX 元素。它应该表示整个文档，因此 <code>App</code> 组件应该渲染 <code>&#x3C;html></code> 标签。<li><p><strong>可选参数</strong> <code>options</code>：一个对象，用于对流进行配置。<ul><li><strong>可选属性</strong> <code>bootstrapScriptContent</code>：如果指定了这个属性值，那么这个字符串会被放置在内联 <code>&#x3C;script></code> 标签中。<li><strong>可选属性</strong> <code>bootstrapScripts</code>：一个字符串 URL 的数组， 用于在页面上生成 <code>&#x3C;script></code> 标签。使用它的话，可在 <code>&#x3C;script></code> 中调用 <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a>。如果你根本不想在客户端上运行 React，则忽略它。<li><strong>可选属性</strong> <code>bootstrapModules</code>：就像 <code>bootstrapScripts</code>, 但不同的是，生成 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules"><code>&#x3C;script type="module"></code></a> 标签。<li><strong>可选属性</strong> <code>identifierPrefix</code>：一个字符串前缀，React 通过 <a href="/reference/react/useId"><code>useId</code></a> 来生成 ID。在同一页面上使用多个根组件时，有助于避免冲突。必须与传递给 <a href="/reference/react-dom/client/hydrateRoot#parameters"><code>hydrateRoot</code></a> 的前缀相同。<li><strong>可选属性</strong> <code>namespaceURI</code>：是一个字符串，带有流的根 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/createElementNS#important_namespace_uris">命名空间URI</a>。默认为常规 HTML。如果用于 SVG，传入 <code>'http://www.w3.org/2000/svg'</code>，如果用于 MathML，传入 <code>'http://www.w3.org/1998/Math/MathML'</code>。<li><strong>可选属性</strong> <code>nonce</code>：一个 <a href="http://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/script#nonce"><code>nonce</code></a> 字符串，用以使脚本通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/script-src"><code>script-src</code> 内容安全策略</a>。<li><strong>可选属性</strong> <code>onError</code>：一个回调函数，只要服务器出错就会触发，无论错误是 <a href="#recovering-from-errors-inside-the-shell">否</a> 可 <a href="#recovering-from-errors-outside-the-shell">恢复</a>。默认情况下，它只调用 <code>console.error</code>。如果你用 <a href="#logging-crashes-on-the-server">log crash reports</a> 重写，请确保你仍然调用 <code>console.error</code>。你还可以使用它在 shell 触发之前 <a href="#setting-the-status-code">调整状态代码</a>。<li><strong>可选属性</strong> <code>progressiveChunkSize</code>：块中的字节数。<a href="https://github.com/facebook/react/blob/14c2be8dac2d5482fda8a0906a31d239df8551fc/packages/react-server/src/ReactFizzServer.js#L210-L225">阅读更多默认启发式方法</a>。<li><strong>可选属性</strong> <code>signal</code>：一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/AbortSignal">中止信号</a>，用于 <a href="#aborting-server-rendering">中止服务端渲染</a> 并在客户端上渲染其余部分。</ul></ul></section><section class="level4"aria-labelledby="返回值-returns"><h4 id="返回值-returns">返回值 {/<em>returns</em>/}</h4><p><code>renderToReadableStream</code> 返回一个 Promise：<ul><li>如果渲染 <a href="#specifying-what-goes-into-the-shell">shell</a> 成功，那么 Promise 将 resolve <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream">Web 可读流</a>。<li>如果渲染 shell 失败，Promise 将 reject。<a href="#recovering-from-errors-inside-the-shell">使用这个输出后备 shell </a>。</ul><p>返回的流具有附加属性：<ul><li><code>allReady</code>：一个 Promise，在所有的渲染完成后 resolve，包括 <a href="#specifying-what-goes-into-the-shell">shell</a> 和所有额外的 <a href="#streaming-more-content-as-it-loads">内容</a>。你可以在响应爬虫和静态资源之前执行 <code>await stream.allReady</code>，这样就不会得到任何渐进的加载内容，流会包含最终的 HTML。</ul></section></section></section><section class="level2"aria-labelledby="用法-usage"><h2 id="用法-usage">用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="将-react-树渲染为-html-并发送至-web-可读流-rendering-a-react-tree-as-html-to-a-readable-web-stream"><h3 id="将-react-树渲染为-html-并发送至-web-可读流-rendering-a-react-tree-as-html-to-a-readable-web-stream">将 React 树渲染为 HTML 并发送至 Web 可读流 {/<em>rendering-a-react-tree-as-html-to-a-readable-web-stream</em>/}</h3><p>调用 <code>renderToReadableStream</code> 将 React 渲染为 HTML 并发送至 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream">Web 可读流</a>：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToReadableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>除了<codestep step="{1}">根组件</codestep>，你还需要提供<codestep step="{2}">启动 <code>&#x3C;script></code> 路由</codestep>列表，你的根组件应该返回 <strong>包括根 <code>&#x3C;html></code> 标签的整个 document</strong><p>例如，它可能是这样的：<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta charSet<span class="token operator">=</span><span class="token string">"utf-8"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/styles.css"</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>title<span class="token operator">></span><span class="token maybe-class-name">My</span> app<span class="token operator">&#x3C;</span><span class="token operator">/</span>title<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>body<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Router</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>body<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React 将把 <a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Doctype">doctype</a> 和你的<codestep step="{2}">启动 <code>&#x3C;script></code> 标签</codestep>注入到生成的 HTML 流中：<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&#x3C;!-- ... 来自于组件的 HTML ... --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/main.js<span class="token punctuation">"</span></span> <span class="token attr-name">async</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>在客户端上，启动脚本应该 <a href="/reference/react-dom/client/hydrateRoot#hydrating-an-entire-document">用 <code>hydrateRoot</code> 混合整个 <code>document</code> </a>：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如此一来，监听事件就挂到了服务器生成的 HTML 上，就可以交互了。</p><deepdive><section class="level4"aria-labelledby="从构建输出中读取-css-和-js-的资源路径-reading-css-and-js-asset-paths-from-the-build-output"><h4 id="从构建输出中读取-css-和-js-的资源路径-reading-css-and-js-asset-paths-from-the-build-output">从构建输出中读取 CSS 和 JS 的资源路径 {/<em>reading-css-and-js-asset-paths-from-the-build-output</em>/}</h4><p>最终的资源 URL（像 JavaScript 和 CSS 文件）通常在构建后进行散列。例如，你可能最终得到的不是 <code>styles.css</code> 而是 <code>styles.123456.css</code>。散列静态资源文件名可以保证同一资源的每个不同构建都有不同的文件名。这个方案是有用处的，因为它可以安全地为静态资源开启长期缓存：有了特定名字的文件，其内容就永远不会变。<p>但是，如果构建之后才能知道静态资源的 URL，那就无法将它们放到源代码中。例如，像前面那样将 <code>"/styles.css"</code> 硬编码到 JSX 中是行不通的。为了将它们保持在源代码之外，根组件可以从 prop 传递的映射中读取真实文件名：<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> assetMap <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>title<span class="token operator">></span><span class="token maybe-class-name">My</span> app<span class="token operator">&#x3C;</span><span class="token operator">/</span>title<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">[</span><span class="token string">'styles.css'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token spread operator">...</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>在服务器上，渲染 <code>&#x3C;App assetMap={assetMap} /></code> 并用资源 URL 传递 <code>assetMap</code>：<pre class="language-js"><code class="language-js"><span class="token comment">// 你需要从构建工具中获得这个 JSON，例如，从构建输出中读取。</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>因为服务器正在渲染 <code>&#x3C;App assetMap={assetMap}/></code>，所以客户端上也需使用 <code>assetMap</code> 来渲染，以避产生混合错误。你可以序列化 <code>assetMap</code> 并将其传递给客户端，如下所示：<pre class="language-js"><code class="language-js"><span class="token comment">// 你需要从构建工具中获得这个 JSON。</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意：序列化是安全的，因为这个数据不是用户生成的。</span>
    <span class="token literal-property property">bootstrapScriptContent</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">window.assetMap = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>assetMap<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>在上面的示例中，<code>bootstrapScriptContent</code> 配置项添加了一个额外的内联 <code>&#x3C;script></code> 标签，用于设置客户端上的全局变量 <code>window.assetMap</code>。这允许客户端代码读取相同的 <code>assetMap</code>：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">assetMap</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>因为客户端和服务器都使用相同的 <code>assetMap</code> prop 渲染 <code>App</code>，因此没有混合错误。</section></deepdive></section><section class="level3"aria-labelledby="加载时流传输更多内容-streaming-more-content-as-it-loads"><h3 id="加载时流传输更多内容-streaming-more-content-as-it-loads">加载时，流传输更多内容 {/<em>streaming-more-content-as-it-loads</em>/}</h3><p>流式传输允许用户在服务器上加载所有数据前就开始查看内容。例如，有一个个人资料页面，它显示一个封面、一个包含朋友和照片的侧边栏和一个帖子列表：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>想象一下，加载 <code>&#x3C;Posts/></code> 的数据是需要一些时间的。理想情况是希望在不等帖子内容返回的情况下，向用户显示个人资料页面的其余内容。要做到这一点，需要 <a href="/reference/react/Suspense#displaying-a-fallback-while-content-is-loading">将 <code>Posts</code> 包裹在 <code>&#x3C;Suspense></code> 边界里</a>：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>告诉 React 在 <code>Posts</code> 加载数据之前开始流式传输 HTML。React 将首先发送加载后备 HTML（<code>PostsGlimmer</code>），然后，当 <code>Posts</code> 完成数据加载后，React 将发送剩余的 HTML，并用该 HTML 替换之前替代内联 <code>&#x3C;script></code> 标签的后备方案。从用户视角看，该页面会首先显示 <code>PostsGlimmer</code> 的内容，然后被替换为 <code>Posts</code> 的内容。<p>你可以进一步 <a href="/reference/react/Suspense#revealing-nested-content-as-it-loads">嵌套 <code>&#x3C;Suspense></code> 边界</a> 来创建更细粒度的加载序列：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>在本例中，React 可以更早地开始对页面进行流式传输。只有 <code>ProfileLayout</code> 和 <code>ProfileCover</code> 是必须先完成渲染的，因为它们没有封装进任何 <code>&#x3C;Suspense></code> 边界中。但是，如果 <code>Sidebar</code>、<code>Friends</code> 或 <code>Photos</code> 需要加载一些数据，React 将发送 HTML 以供回退 <code>BigSpinner</code>。然后，随着更多的数据变得可用，更多的内容将会被显示，直到所有的内容都可见。<p>在浏览器中，流不需要等待 React 自身的加载，也不需等待应用变得可交互。在任何 <code>&#x3C;script></code> 标签加载之前，来自服务器中的 HTML 内容将会逐步的显示出来。<p><a href="https://github.com/reactwg/react-18/discussions/37">阅读流式 HTML 工作原理的更多信息</a>。</p><note><p><strong>只有支持 Suspense 的数据源将会激活 Suspense 组件</strong>。它们包括：<ul><li>使用支持 Suspense 的框架获取数据，如 <a href="https://relay.dev/docs/guided-tour/rendering/loading-states/">Relay</a> 和 <a href="https://nextjs.org/docs/getting-started/react-essentials">Next.js</a><li>用 <a href="/reference/react/lazy"><code>lazy</code></a> 来懒加载组件代码<li>使用 <a href="/reference/react/use"><code>use</code></a> 读取 Promise 的值</ul><p>suspense <strong>不会去探测</strong> Effect 内部或事件处理器中获取的数据。<p>在上面的 <code>Posts</code> 组件中加载数据的具体方式取决于你的框架。如果你使用一个支持 Suspense 的框架，你可以在其数据获取文档中找到详细信息。<p>目前还不支持在不使用已提到的框架的情况下使用 Suspense 功能的数据提取。实现支持 Suspense 数据源的需求不稳定且没有记录。用 Suspense 集成数据源的官方 API 将在 React 的未来版本中发布。</p></note></section><section class="level3"aria-labelledby="指定放入-shell-的内容-specifying-what-goes-into-the-shell"><h3 id="指定放入-shell-的内容-specifying-what-goes-into-the-shell">指定放入 shell 的内容 {/<em>specifying-what-goes-into-the-shell</em>/}</h3><p>应用中任何 <code>&#x3C;Suspense></code> 边界之外的部分称为 <em>shell</em>：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>它决定了用户可以看到的最早的载入状态：<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span></code></pre><p>如果将整个应用包装进根组件的 <code>&#x3C;Suspense></code> 边界中，则 shell 将只包括 spinner。但这种用户体验不好，因为在屏幕上看到一个大 spinner 会比多等一段时间看到真实的布局感觉更慢、更烦人。这就是为什么通常希望放置 <code>&#x3C;Suspense></code> 边界，以便 shell 看起来是 <strong>最小但完整</strong> 的——就像一整个页面布局的骨架。<p>只要整个 shell 被渲染了，异步调用 <code>renderToReadableStream</code> 会 resolve 一个 <code>stream</code>。通常情况下，可以创建并返回带有 <code>stream</code> 的响应来开始流式传输。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>当返回 <code>stream</code> 时，嵌套在 <code>&#x3C;Suspense></code> 里的组件可能仍在加载数据。</section><section class="level3"aria-labelledby="服务器上的崩溃日志-logging-crashes-on-the-server"><h3 id="服务器上的崩溃日志-logging-crashes-on-the-server">服务器上的崩溃日志 {/<em>logging-crashes-on-the-server</em>/}</h3><p>默认情况下，服务器上的所有错误都会被记录到控制台。你可以覆盖此行为，来记录崩溃报告：<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>如果你提供了自定义的 <code>onError</code> 实现，请不要忘记像上面那样将错误记录到控制台。</section><section class="level3"aria-labelledby="shell-内部从报错中恢复程序-recovering-from-errors-inside-the-shell"><h3 id="shell-内部从报错中恢复程序-recovering-from-errors-inside-the-shell">shell 内部，从报错中恢复程序 {/<em>recovering-from-errors-inside-the-shell</em>/}</h3><p>在本例中，shell 包含 <code>ProfileLayout</code>、<code>ProfileCover</code> 和 <code>PostsGlimmer</code>：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>如果在渲染这些组件时发生错误，React 将不会向客户端发送任何有意义的 HTML。将 <code>renderToReadableStream</code> 的调用放到 <code>try...catch</code> 里，发送一个不依赖服务端渲染的回滚 HTML 作为最后的后备方案：<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>如果在生成 shell 时出错，<code>onError</code> 和 <code>catch</code> 都会被触发。用 <code>onError</code> 报告错误，并用 <code>catch</code> 发送后备 HTML。你的后备 HTML 不一定必须是个错误页面。相反，你可以返回一个替代的 shell，这个 shell 只在客户端上渲染你的应用。</section><section class="level3"aria-labelledby="shell-外部从报错中恢复程序-recovering-from-errors-outside-the-shell"><h3 id="shell-外部从报错中恢复程序-recovering-from-errors-outside-the-shell">shell 外部，从报错中恢复程序 {/<em>recovering-from-errors-outside-the-shell</em>/}</h3><p>在本例中，<code>&#x3C;Posts/></code> 组件被包装在 <code>&#x3C;Suspense></code> 中，因此它不是 shell 的一部分：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If an error happens in the <code>Posts</code> component or somewhere inside it, React will <a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-client-only-content">try to recover from it:</a><ol><li>它将为最近的 <code>&#x3C;Suspense></code> 边界（<code>PostsGlimmer</code>）触发加载中的后备方案到 HTML。<li>它将 <strong>放弃</strong> 再尝试在服务器上渲染 <code>Posts</code>。<li>当 JavaScript 代码加载到客户端上时，React <strong>重新尝试</strong> 在客户端上渲染 <code>Posts</code>。</ol><p>如果在客户端上重新尝试渲染 <code>Posts</code> <strong>也</strong> 失败，React 将在客户端上抛出错误。与渲染过程中抛出的所有错误一样，<a href="/reference/reflect/Component#staticgetderivedstatefromwerror">最近的父级错误边界</a> 决定如何向用户展示错误。在实践中，这意味着用户将看到加载指示符，直到确定错误不可恢复为止。<p>如果在客户端上重新尝试渲染 <code>Posts</code> 成功，则从服务器加载中的后备方案将被客户端渲染的输出所取代。用户不会知道有服务器错误。但是，服务器的 <code>onError</code> 回调和客户端的 <a href="/reference/react-dom/client/hydrateRoot#hydrateroot"><code>onRecoverableError</code></a> 回调将被触发，以便你可以收到有关错误通知。</section><section class="level3"aria-labelledby="设置状态码-setting-the-status-code"><h3 id="设置状态码-setting-the-status-code">设置状态码 {/<em>setting-the-status-code</em>/}</h3><p>流传输需要权衡利弊。你希望尽早开始流式传输页面，以便用户能够更快地看到内容。但是，一旦开始流式传输，就无法再设置响应状态码。<p>通过 <a href="#specifying-what-goes-into-the-shell">把你的应用分割</a> 为 shell（最重要的是 <code>&#x3C;Suspense></code> 边界）和其他内容，你已经解决了这个问题的一部分。如果 shell 出错，会运行你的 <code>catch</code> 块，允许你设置错误状态码。否则，应用可能会在客户端上恢复，所以你可以发送 <strong>OK</strong>。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>如果 shell <strong>外</strong> 的组件（即 <code>&#x3C;Suspense></code> 边界内）抛出错误，React 将不会停止渲染。这意味着会触发 <code>onError</code> 回调，但你的代码会继续运行，不会进入 <code>catch</code> 块。这是因为 React 将尝试从客户端的错误中恢复，<a href="#recovering-from-errors-outside-the-shell">就像上面描述的那样</a>。<p>但是，如果你愿意，你可以使用出现错误的实际情况来设置状态码：<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>这只会捕获 shell 外的报错，那些报错发生在生成初始 shell 内容时，所以它没有具体的报错信息。如果知道某些内容是否发生错误是很重要的，则可以将其向上移动到 shell 中。</section><section class="level3"aria-labelledby="以不同的方式处理不同的错误-handling-different-errors-in-different-ways"><h3 id="以不同的方式处理不同的错误-handling-different-errors-in-different-ways">以不同的方式处理不同的错误 {/<em>handling-different-errors-in-different-ways</em>/}</h3><p>你可以 <a href="https://javascript.info/custom-errors">创建自己的 <code>Error</code> 子类</a> 并使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/instanceof"><code>instanceof</code></a> 运算符来检查抛出的错误。例如，你可以自定义一个 <code>NotFoundError</code> 并将其从组件中抛出。然后，你可以将错误保存在 <code>onError</code> 中，并根据错误类型在返回响应之前执行不同的操作：<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> caughtError <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>didError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>caughtError <span class="token keyword">instanceof</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token number">500</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        caughtError <span class="token operator">=</span> error<span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>记住，一旦发出 shell 并开始流传输，就无法更改状态码。</section><section class="level3"aria-labelledby="等待加载所有爬虫和静态生成的内容-waiting-for-all-content-to-load-for-crawlers-and-static-generation"><h3 id="等待加载所有爬虫和静态生成的内容-waiting-for-all-content-to-load-for-crawlers-and-static-generation">等待加载所有爬虫和静态生成的内容 {/<em>waiting-for-all-content-to-load-for-crawlers-and-static-generation</em>/}</h3><p>流提供了更好的用户体验，因为用户可以在内容可用时看到内容。<p>但是，当爬虫访问你的页面时，或者如果你在构建时生成页面，你可能希望先加载所有内容，然后生成最终的 HTML 输出，而不是逐步显示。<p>你可以等 <code>stream.allReady</code> Promise 来加载所有内容：<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> isCrawler <span class="token operator">=</span> <span class="token comment">// ... 取决于你的机器人检测策略 ...</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isCrawler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">await</span> stream<span class="token punctuation">.</span><span class="token property-access">allReady</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span>stream<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Response</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
      <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token string-property property">'content-type'</span><span class="token operator">:</span> <span class="token string">'text/html'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>普通访问者将获得一个逐步加载的流。所有数据加载之后，爬虫将接收最终的 HTML 输出。然而，这也意味着爬虫将不得不等待 <strong>所有</strong> 数据，其中一些数据可能加载缓慢或出错。根据你的应用，你也可以选择将 shell 发给爬虫。</section><section class="level3"aria-labelledby="中止服务端渲染-aborting-server-rendering"><h3 id="中止服务端渲染-aborting-server-rendering">中止服务端渲染 {/<em>aborting-server-rendering</em>/}</h3><p>可以在超时后强制服务器 <strong>放弃</strong> 渲染：<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      controller<span class="token punctuation">.</span><span class="token method function property-access">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">renderToReadableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">signal</span><span class="token operator">:</span> controller<span class="token punctuation">.</span><span class="token property-access">signal</span><span class="token punctuation">,</span>
      <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span></code></pre><p>React 会把剩余的加载中的后备方案刷新为 HTML，并尝试在客户端上渲染其余部分。 <span style="float:footnote"><a href="../../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>