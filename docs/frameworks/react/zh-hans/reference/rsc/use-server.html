<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>"'use server'"</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="use-server"><h1 id="use-server">"'use server'"</h1><p>titleForTitleTag: "'use server' 指示符" canary: true</p><canary><p><code>'use server'</code> 仅在 <a href="/learn/start-a-new-react-project#bleeding-edge-react-frameworks">使用 React 服务器组件</a> 或构建可适配库时需要。</p></canary><intro><p><code>'use server'</code> 标记可以从客户端代码调用的服务器函数。</p></intro><inlinetoc><section class="level2"aria-labelledby="参考-reference"><h2 id="参考-reference">参考 {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="use-server-use-server"><h3 id="use-server-use-server"><code>'use server'</code> {/<em>use-server</em>/}</h3><p>在异步函数顶部添加 <code>'use server'</code> 以将该函数标记为可由客户端调用。我们将这些函数称为 <strong>Server Action</strong>。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use server'</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>在客户端调用 Server Action 时，它将向服务器发出网络请求，其中包含传递的任何参数的序列化副本。如果 Server Action 返回一个值，该值将被序列化并返回给客户端。<p>可以将 <code>'use server'</code> 指示符添加到文件顶部来代替逐个在函数中添加它。位于文件顶部的指示符会将所有导出都标记为可在任何地方使用的 Server Action，包括在客户端代码中导入。<section class="level4"aria-labelledby="注意-caveats"><h4 id="注意-caveats">注意 {/<em>caveats</em>/}</h4><ul><li><code>'use server'</code> 必须位于函数或模块的顶部，在任何导入或其他代码之前（可以位于代码顶部的注释之后）。它们必须用单引号或双引号编写，但不能用反引号。<li><code>'use server'</code> 只能在服务器端文件中使用。生成的 Server Action 可以通过 props 传递给客户端组件。请参阅支持的 <a href="#serializable-parameters-and-return-values">序列化参数和返回值类型</a>。<li>要从 <a href="/reference/react/use-client">客户端代码</a> 导入 Server Action，必须在模块级别使用该指示符。<li>由于底层网络调用始终是异步的，<code>'use server'</code> 只能用于异步函数。<li>始终将 Server Action 的参数视为不受信任的输入，并授权任何变更。请参阅 <a href="#security">安全考虑</a>。<li>应在 <a href="/reference/react/useTransition">transition</a> 中调用 Server Action。传递给 <a href="/reference/react-dom/components/form#props"><code>&#x3C;form action></code></a> 或 <a href="/reference/react-dom/components/input#props"><code>formAction</code></a> 的 Server Action 将自动在 Transition 中被调用。<li>Server Action 专为更新服务器端状态的变更而设计，不建议用于数据获取。因此，实现 Server Action 的框架通常一次只处理一个 Action，没有缓存返回值的方式。</ul></section></section><section class="level3"aria-labelledby="安全考虑-security"><h3 id="安全考虑-security">安全考虑 {/<em>security</em>/}</h3><p>Server Action 的参数完全由客户端控制。出于安全考虑，始终将它们视为不受信任的输入，并确保根据需要验证和转义参数。<p>在任何 Server Action 中，请确保验证已登录的用户是否被允许执行该操作。</p><wip><p>为防止从 Server Action 中发送敏感数据，提供了实验性的污染 API 用于阻止唯一值和对象传递到客户端代码。<p>请参阅 <a href="/reference/react/experimental_taintUniqueValue">experimental_taintUniqueValue</a> 与 <a href="/reference/react/experimental_taintObjectReference">experimental_taintObjectReference</a> 以了解更多。</p></wip></section><section class="level3"aria-labelledby="可序列化参数和返回值-serializable-parameters-and-return-values"><h3 id="可序列化参数和返回值-serializable-parameters-and-return-values">可序列化参数和返回值 {/<em>serializable-parameters-and-return-values</em>/}</h3><p>当客户端代码通过网络调用 Server Action 时，传递的任何参数都必须是可序列化的。<p>以下是 Server Action 参数支持的类型：<ul><li>原始类型<ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/String">string</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Number">number</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/BigInt">bigint</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Boolean">boolean</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Undefined">undefined</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Glossary/Null">null</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol">symbol</a>，仅包含在全局符号注册表中使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Symbol/for"><code>Symbol.for</code></a> 注册的符号。</ul><li>包含可序列化值的迭代类型<ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/String">String</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array">Array</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Set">Set</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">TypedArray</a> 与 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a></ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Date">Date</a><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData">FormData</a> 实例<li>普通 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object">对象</a>：使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Object_initializer">对象初始化器</a> 创建的、具有可序列化属性<li>充当 Server Action 的函数<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a></ul><p>值得注意的是，以下内容不受支持：<ul><li>React 元素或 <a href="/learn/writing-markup-with-jsx">JSX</a><li>函数，包括组件函数和其他并非 Server Action 的函数<li><a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Objects/Classes_in_JavaScript">类</a><li>任何类的实例对象（除了提到的内置类）或 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object#null-prototype_objects">使用 null 作为原型</a> 的对象<li>未全局注册的符号，例如 <code>Symbol('my new symbol')</code></ul><p>支持的可序列化返回值与边界客户端组件的 <a href="/reference/rsc/use-client#passing-props-from-server-to-client-components">可序列化 props</a> 相同。</section></section><section class="level2"aria-labelledby="用法-usage"><h2 id="用法-usage">用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="表格中的-server-action-server-actions-in-forms"><h3 id="表格中的-server-action-server-actions-in-forms">表格中的 Server Action {/<em>server-actions-in-forms</em>/}</h3><p>Server Action 的最常见用法将是调用会更改数据的服务器函数。在浏览器中，<a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/form">HTML form 元素</a> 是用户提交变更的传统方法。通过 React 服务器组件，React 在 <a href="/reference/react-dom/components/form">表单</a> 中首次引入了对 Server Action 的一流支持。<p>以下是一个允许用户请求用户名的表单。<pre class="language-js"><code class="language-js"><span class="token comment">// App.js</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestUsername</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use server'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>requestUsername<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token maybe-class-name">Request</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>在这个示例中，<code>requestUsername</code> 是一个传递给 <code>&#x3C;form></code> 的 Server Action。当用户提交此表单时，会发起一个网络请求到服务器函数 <code>requestUsername</code>。在调用表单中的 Server Action 时，React 将 <code>FormData</code> 作为第一个参数提供给 Server Action。<p>通过将 Server Action 传递给表单的 <code>action</code>，React 可以 <a href="https://developer.mozilla.org/en-US/docs/Glossary/Progressive_Enhancement">逐步增强</a> 表单。这意味着表单可以在 JavaScript 捆绑加载之前提交。<section class="level4"aria-labelledby="处理表单中的返回值-handling-return-values"><h4 id="处理表单中的返回值-handling-return-values">处理表单中的返回值 {/<em>handling-return-values</em>/}</h4><p>在用户名请求表单中，可能存在用户名不可用的情况。<code>requestUsername</code> 应该告诉我们它是否失败。<p>请使用 <a href="/reference/react/useActionState"><code>useActionState</code></a> 以根据 Server Action 的结果更新 UI 并支持逐步增强。<pre class="language-js"><code class="language-js"><span class="token comment">// requestUsername.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestUsername</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">canRequest</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'successful'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token string">'failed'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// UsernameForm.js</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useActionState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">requestUsername</span> <span class="token keyword module">from</span> <span class="token string">'./requestUsername'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">UsernameForm</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>state<span class="token punctuation">,</span> action<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useActionState</span><span class="token punctuation">(</span>requestUsername<span class="token punctuation">,</span> <span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token string">'n/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>action<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span>请求<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>最后一次提交的请求的返回值： <span class="token punctuation">{</span>returnValue<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>请注意，与大多数 Hook 一样，<code>useActionState</code> 只能在<codestep step="{1}"><a href="/reference/react/use-client">客户端代码</a></codestep>中调用。</section></section><section class="level3"aria-labelledby="在--之外调用-server-action-calling-a-server-action-outside-of-form"><h3 id="在--之外调用-server-action-calling-a-server-action-outside-of-form">在 <code>&#x3C;form></code> 之外调用 Server Action {/<em>calling-a-server-action-outside-of-form</em>/}</h3><p>Server Action 是暴露的服务器端点，可以在客户端代码的任何位置调用。<p>在 <code>&#x3C;form></code> 之外使用 Server Action 时，调用 Server Action 时请使用 <a href="/reference/react/useTransition">transition</a>，这允许显示加载指示器、显示 <a href="/reference/react/useOptimistic">乐观状态更新</a> 和处理意外错误。表单会自动在 Transition 中包装 Server Action。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">incrementLike</span> <span class="token keyword module">from</span> <span class="token string">'./actions'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useTransition <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">LikeButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> startTransition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>likeCount<span class="token punctuation">,</span> setLikeCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentCount <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">incrementLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setLikeCount</span><span class="token punctuation">(</span>currentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>点赞数量： <span class="token punctuation">{</span>likeCount<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span> disabled<span class="token operator">=</span><span class="token punctuation">{</span>isPending<span class="token punctuation">}</span><span class="token operator">></span>点赞<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// actions.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> likeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">incrementLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  likeCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> likeCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>可以使用 <code>await</code> 获取 Promise 的返回值以读取 Server Action 的返回值。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>