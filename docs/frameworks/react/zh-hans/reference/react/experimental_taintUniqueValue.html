<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>experimental_taintUniqueValue</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="experimental_taintuniquevalue"><h1 id="experimental_taintuniquevalue">experimental_taintUniqueValue</h1><wip><p><strong>此实验性 API 尚未在 React 的稳定版本中提供</strong>。<p>可以尝试升级 React 包到最新的实验版本：<ul><li><code>react@experimental</code><li><code>react-dom@experimental</code><li><code>eslint-plugin-react-hooks@experimental</code></ul><p>React 的实验版本可能有一些问题，请勿在生产环境中使用。<p>此 API 仅在 <a href="/reference/react/use-client">React 服务器组件</a> 内可用。</p></wip><intro><p><code>taintUniqueValue</code> 允许防止将唯一值传递给客户端组件，例如密码、密钥或令牌。<pre class="language-js"><code class="language-js"><span class="token function">taintUniqueValue</span><span class="token punctuation">(</span>errMessage<span class="token punctuation">,</span> lifetime<span class="token punctuation">,</span> value<span class="token punctuation">)</span></code></pre><p>参阅 <a href="/reference/react/experimental_taintObjectReference"><code>taintObjectReference</code></a> 以了解更多关于防止传递包含敏感数据的对象的更多信息。</p></intro><inlinetoc><section class="level2"aria-labelledby="参考-reference"><h2 id="参考-reference">参考 {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="taintuniquevaluemessage-lifetime-value-taintuniquevalue"><h3 id="taintuniquevaluemessage-lifetime-value-taintuniquevalue"><code>taintUniqueValue(message, lifetime, value)</code> {/<em>taintuniquevalue</em>/}</h3><p>调用 <code>taintUniqueValue</code> 并传递密码、令牌、密钥或哈希作为参数，然后将其注册到 React 中，并标记为不允许直接传递给客户端的内容：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintUniqueValue<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token function">experimental_taintUniqueValue</span><span class="token punctuation">(</span>
  <span class="token string">'Do not pass secret keys to the client.'</span><span class="token punctuation">,</span>
  process<span class="token punctuation">,</span>
  process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">SECRET_KEY</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><a href="#usage">参见下方更多示例</a>。<section class="level4"aria-labelledby="参数-parameters"><h4 id="参数-parameters">参数 {/<em>parameters</em>/}</h4><ul><li><p><code>message</code>：<code>value</code> 被传递给客户端组件时显示的消息。如果将 <code>value</code> 传递给客户端组件，此消息将作为错误的一部分显示。<li><p><code>lifetime</code>：指示 <code>value</code> 应该被污染多长时间的任何对象。只要此对象仍然存在，将阻止把 <code>value</code> 发送到任何客户端组件。例如，传递 <code>globalThis</code> 将在应用程序的生命周期内阻止该值的传递。<code>lifetime</code> 通常是一个包含 <code>value</code> 属性的对象。<li><p><code>value</code>：字符串、bigint 或 TypedArray。<code>value</code> 必须是具有高熵的字符或字节的唯一序列，例如加密令牌、私钥、哈希值或长密码。<code>value</code> 将被阻止发送到任何客户端组件。</ul></section><section class="level4"aria-labelledby="返回-returns"><h4 id="返回-returns">返回 {/<em>returns</em>/}</h4><p><code>experimental_taintUniqueValue</code> 返回 <code>undefined</code>。</section><section class="level4"aria-labelledby="注意-caveats"><h4 id="注意-caveats">注意 {/<em>caveats</em>/}</h4><ul><li>从被污染的值派生新值可能会破坏污点标记保护。通过将被污染的值大写、将被污染的字符串值连接成较大的字符串、将被污染的值转换为 base64、对被污染的值进行子字符串操作以及其他类似的转换来创建的新值，除非明确调用 <code>taintUniqueValue</code> 污染这些新创建的值，否则它们不会被污染。<li>不要使用 <code>taintUniqueValue</code> 保护诸如 PIN 码与电话号码这类低熵值。如果请求中的任何值都可以受攻击者控制，那么他们可以秘密枚举所有值来判断那个值是被污染的</ul></section></section></section><section class="level2"aria-labelledby="用法-usage"><h2 id="用法-usage">用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="防止将令牌传递给客户端组件-prevent-a-token-from-being-passed-to-client-components"><h3 id="防止将令牌传递给客户端组件-prevent-a-token-from-being-passed-to-client-components">防止将令牌传递给客户端组件 {/<em>prevent-a-token-from-being-passed-to-client-components</em>/}</h3><p>为了确保敏感信息（如密码、会话令牌或其他唯一值）不会被意外地传递给客户端组件，<code>taintUniqueValue</code> 函数提供了一层保护。当一个值被污染时，任何尝试将其传递给客户端组件的操作都将导致错误。<p><code>lifetime</code> 参数定义了值保持被污染的状态的持续时间。对于应该永久保持被污染的状态的值，可以使用像 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/globalThis"><code>globalThis</code></a> 或 <code>process</code> 这样的对象作为 <code>lifetime</code> 参数。这些对象的生命周期跨越应用程序执行的整个持续时间。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintUniqueValue<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token function">experimental_taintUniqueValue</span><span class="token punctuation">(</span>
  <span class="token string">'Do not pass a user password to the client.'</span><span class="token punctuation">,</span>
  globalThis<span class="token punctuation">,</span>
  process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">SECRET_KEY</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如果被污染的值的寿命与某个对象相关联，那么 <code>lifetime</code> 应该是封装该值的对象。这样可以确保被污染的值在封装对象的生命周期内保持受保护状态。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintUniqueValue<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT * FROM users WHERE id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token function">experimental_taintUniqueValue</span><span class="token punctuation">(</span>
    <span class="token string">'Do not pass a user session token to the client.'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
    user<span class="token punctuation">.</span><span class="token property-access">session</span><span class="token punctuation">.</span><span class="token property-access">token</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>在此示例中，<code>user</code> 对象用作 <code>lifetime</code> 参数。如果此对象存储在全局缓存中或可以被其他请求访问，会话令牌将保持被污染的状态。</p><pitfall><p><strong>不要仅依赖于污点标记来确保安全</strong>。污染一个值不会阻止每一个可能派生出的值。例如，通过将被污染的字符串大写来创建新值，将不会污染新值。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintUniqueValue<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> password <span class="token operator">=</span> <span class="token string">'correct horse battery staple'</span><span class="token punctuation">;</span>

<span class="token function">experimental_taintUniqueValue</span><span class="token punctuation">(</span>
  <span class="token string">'Do not pass the password to the client.'</span><span class="token punctuation">,</span>
  globalThis<span class="token punctuation">,</span>
  password
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> uppercasePassword <span class="token operator">=</span> password<span class="token punctuation">.</span><span class="token method function property-access">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// `uppercasePassword` 不被污染</span></code></pre><p>在此示例中，常量 <code>password</code> 被污染。然后，通过在 <code>password</code> 上调用 <code>toUpperCase</code> 方法使用 <code>password</code> 创建新值 <code>uppercasePassword</code>。新创建的 <code>uppercasePassword</code> 不被污染。<p>从被污染的值派生新值的其他类似方式，如将其连接到较大的字符串中、将其转换为 base64 或返回子字符串，会创建未被污染的值。<p>污点标记仅保护免受简单错误的影响，比如明确将机密值传递给客户端的错误。在调用 <code>taintUniqueValue</code> 时出现的错误，例如在 React 外部使用全局存储，没有相应的生命周期对象，可能会导致被污染的值变为未被污染。污点标记是一层保护，安全的应用程序将具有多层保护、精心设计的 API 和隔离模式。</p></pitfall><deepdive><section class="level4"aria-labelledby="使用-server-only-与-taintuniquevalue-防止机密信息泄露-using-server-only-and-taintuniquevalue-to-prevent-leaking-secrets"><h4 id="使用-server-only-与-taintuniquevalue-防止机密信息泄露-using-server-only-and-taintuniquevalue-to-prevent-leaking-secrets">使用 <code>server-only</code> 与 <code>taintUniqueValue</code> 防止机密信息泄露 {/<em>using-server-only-and-taintuniquevalue-to-prevent-leaking-secrets</em>/}</h4><p>如果正在运行具有访问私钥或密码（如数据库密码）的服务器组件环境，必须小心不要将其传递给客户端组件。<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Dashboard</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 不要这样做</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Overview</span> password<span class="token operator">=</span><span class="token punctuation">{</span>process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">API_PASSWORD</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token string">"use client"</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>useEffect<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'...'</span>

<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Overview</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> password <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">Authorization</span><span class="token operator">:</span> password <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>password<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span></code></pre><p>这个示例会将秘密的 API 令牌泄漏给客户端。如果这个 API 令牌可以用来访问此特定用户不应该访问的数据，可能会导致数据泄露。<p>[comment]: &#x3C;> (TODO: 一旦 <code>server-only</code> 文档写好就就将其链接到对应处)<p>理想情况下，像这样的机密信息应该被抽象到一个单独的辅助文件中，只有服务器上的可信数据工具才能导入它。这个辅助文件甚至可以被污染为 <a href="https://www.npmjs.com/package/server-only"><code>server-only</code></a>，以确保此文件不会在客户端被导入。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token string">"server-only"</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">fetchAPI</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">Authorization</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">API_PASSWORD</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>有时，在重构过程中可能会发生错误，而且不是所有同事都可能知道这一点。 为了防止此类错误在后续发生，我们可以对实际密码进行“污染”：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token string">"server-only"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintUniqueValue<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token function">experimental_taintUniqueValue</span><span class="token punctuation">(</span>
  <span class="token string">'Do not pass the API token password to the client. '</span> <span class="token operator">+</span>
    <span class="token string">'Instead do all fetches on the server.'</span>
  process<span class="token punctuation">,</span>
  process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">API_PASSWORD</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>现在无论何时有人试图将此密码传递给客户端组件，或者通过服务器操作将密码发送给客户端组件时都会引发一个错误，错误消息则是在调用 <code>taintUniqueValue</code> 时定义的。<p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></deepdive></section></section></inlinetoc></section>