<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>experimental_taintObjectReference</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="experimental_taintobjectreference"><h1 id="experimental_taintobjectreference">experimental_taintObjectReference</h1><wip><p><strong>此实验性 API 尚未在 React 的稳定版本中提供</strong>。<p>可以尝试升级 React 包到最新的实验版本：<ul><li><code>react@experimental</code><li><code>react-dom@experimental</code><li><code>eslint-plugin-react-hooks@experimental</code></ul><p>React 的实验版本可能有一些问题，请勿在生产环境中使用。<p>此 API 仅在 React 服务器组件内可用。</p></wip><intro><p><code>taintObjectReference</code> 允许阻止特定对象实例被传递给客户端组件，例如 <code>user</code> 对象。<pre class="language-js"><code class="language-js"><span class="token function">experimental_taintObjectReference</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> object<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>请参阅 <a href="/reference/react/experimental_taintUniqueValue"><code>taintUniqueValue</code></a> 以了解关于防止传递密钥、哈希或令牌的更多信息。</p></intro><inlinetoc><section class="level2"aria-labelledby="参考-reference"><h2 id="参考-reference">参考 {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="taintobjectreferencemessage-object-taintobjectreference"><h3 id="taintobjectreferencemessage-object-taintobjectreference"><code>taintObjectReference(message, object)</code> {/<em>taintobjectreference</em>/}</h3><p>调用 <code>taintObjectReference</code>，并传递一个对象作为参数，然后将其注册到 React 中，表示不允许直接传递给客户端：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintObjectReference<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token function">experimental_taintObjectReference</span><span class="token punctuation">(</span>
  <span class="token string">'Do not pass ALL environment variables to the client.'</span><span class="token punctuation">,</span>
  process<span class="token punctuation">.</span><span class="token property-access">env</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><a href="#usage">参见下方更多示例</a>。<section class="level4"aria-labelledby="参数-parameters"><h4 id="参数-parameters">参数 {/<em>parameters</em>/}</h4><ul><li><p><code>message</code>：对象被传递给客户端组件时显示的消息。如果对象被传递给客户端组件，此消息将作为错误的一部分显示。<li><p><code>object</code>：被污染的对象。函数和类实例可以作为 <code>object</code> 传递给 <code>taintObjectReference</code>。React 会阻止直接将函数和类传递给客户端组件，并把默认的错误消息替换为在 <code>message</code> 中定义的内容。当将特定类型数组的实例作为 <code>object</code> 传递给 <code>taintObjectReference</code> 时，该类型数组的其他副本将不会被污染。</ul></section><section class="level4"aria-labelledby="返回值-returns"><h4 id="返回值-returns">返回值 {/<em>returns</em>/}</h4><p><code>experimental_taintObjectReference</code> 返回 <code>undefined</code>。</section><section class="level4"aria-labelledby="注意-caveats"><h4 id="注意-caveats">注意 {/<em>caveats</em>/}</h4><ul><li>重新创建或克隆一个被污染的对象会创建一个新的未被污染的对象，其中可能包含敏感数据。如果有一个被污染的 <code>user</code> 对象，执行 <code>const userInfo = {name: user.name, ssn: user.ssn}</code> 或 <code>{...user}</code> 将创建新的未被污染的对象。<code>taintObjectReference</code> 只能防止把未修改的对象传递给客户端组件这种简单的错误。</ul><pitfall><p><strong>不要仅依赖于污点标记来确保安全</strong>。被污染的对象并不防止泄露每一个可能的派生值。例如，被污染的对象的克隆将创建一个新的未被污染的对象。使用来自被污染的对象的数据（例如 <code>{secret: taintedObj.secret}</code>）将创建一个新的值或对象，它不被污染。污点标记只是一层保护，安全的应用程序应该有多层保护、精心设计的 API 和隔离模式。</p></pitfall></section></section></section><section class="level2"aria-labelledby="用法-usage"><h2 id="用法-usage">用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="防止用户数据被无意间传递到客户端-prevent-user-data-from-unintentionally-reaching-the-client"><h3 id="防止用户数据被无意间传递到客户端-prevent-user-data-from-unintentionally-reaching-the-client">防止用户数据被无意间传递到客户端 {/<em>prevent-user-data-from-unintentionally-reaching-the-client</em>/}</h3><p>客户端组件不应接受携带敏感数据的对象。理想情况下数据获取函数不应暴露当前用户不允许访问的数据。有时在重构过程中会发生错误。为了防止这些错误在以后发生，我们可以在数据 API 中“污染”用户对象。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintObjectReference<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT * FROM users WHERE id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token function">experimental_taintObjectReference</span><span class="token punctuation">(</span>
    <span class="token string">'Do not pass the entire user object to the client. '</span> <span class="token operator">+</span>
      <span class="token string">'Instead, pick off the specific properties you need for this use case.'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>现在，无论谁试图将此对象传递给客户端组件，都将抛出一个带有传入错误消息的错误。</p><deepdive><section class="level4"aria-labelledby="防止数据获取中的泄漏-protecting-against-leaks-in-data-fetching"><h4 id="防止数据获取中的泄漏-protecting-against-leaks-in-data-fetching">防止数据获取中的泄漏 {/<em>protecting-against-leaks-in-data-fetching</em>/}</h4><p>如果处于对敏感数据具有访问权限的服务器组件环境，必须牢记不要直接传递对象：<pre class="language-js"><code class="language-js"><span class="token comment">// api.js</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT * FROM users WHERE id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getUser <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'api.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">InfoCard</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'components.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Profile</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token property-access">userId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// DO NOT DO THIS</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">InfoCard</span> user<span class="token operator">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// components.js</span>
<span class="token string">"use client"</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">InfoCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> user <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token punctuation">{</span>user<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>理想情况下 <code>getUser</code> 不应暴露当前用户不允许访问的数据。为了防止将来把 <code>user</code> 对象传递给客户端组件，我们可以对用户对象进行“污染”：<pre class="language-js"><code class="language-js"><span class="token comment">// api.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>experimental_taintObjectReference<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT * FROM users WHERE id = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token function">experimental_taintObjectReference</span><span class="token punctuation">(</span>
    <span class="token string">'Do not pass the entire user object to the client. '</span> <span class="token operator">+</span>
      <span class="token string">'Instead, pick off the specific properties you need for this use case.'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> user<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>现在，如果有人试图将 <code>user</code> 对象传递给客户端组件，将会抛出一个带有传入错误消息的错误。</p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></deepdive></section></section></inlinetoc></section>