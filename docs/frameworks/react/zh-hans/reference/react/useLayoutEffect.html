<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>useLayoutEffect</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="uselayouteffect"><h1 id="uselayouteffect">useLayoutEffect</h1><pitfall><p><code>useLayoutEffect</code> 可能会影响性能。尽可能使用 <a href="/reference/react/useEffect"><code>useEffect</code></a>。</p></pitfall><intro><p><code>useLayoutEffect</code> 是 <a href="/reference/react/useEffect"><code>useEffect</code></a> 的一个版本，在浏览器重新绘制屏幕之前触发。<pre class="language-js"><code class="language-js"><span class="token function">useLayoutEffect</span><span class="token punctuation">(</span>setup<span class="token punctuation">,</span> dependencies<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="参考-reference"><h2 id="参考-reference">参考 {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="uselayouteffectsetup-dependencies-useinsertioneffect"><h3 id="uselayouteffectsetup-dependencies-useinsertioneffect"><code>useLayoutEffect(setup, dependencies?)</code> {/<em>useinsertioneffect</em>/}</h3><p>调用 <code>useLayoutEffect</code> 在浏览器重新绘制屏幕之前进行布局测量：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef<span class="token punctuation">,</span> useLayoutEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Tooltip</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>tooltipHeight<span class="token punctuation">,</span> setTooltipHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTooltipHeight</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span></code></pre><p><a href="#usage">请看下面的更多例子</a>。<section class="level4"aria-labelledby="参数-parameters"><h4 id="参数-parameters">参数 {/<em>parameters</em>/}</h4><ul><li><p><code>setup</code>：处理副作用的函数。setup 函数选择性返回一个<em>清理</em>（cleanup）函数。在将组件首次添加到 DOM 之前，React 将运行 setup 函数。在每次因为依赖项变更而重新渲染后，React 将首先使用旧值运行 cleanup 函数（如果你提供了该函数），然后使用新值运行 setup 函数。在组件从 DOM 中移除之前，React 将最后一次运行 cleanup 函数。<li><p><strong>可选</strong> <code>dependencies</code>：<code>setup</code> 代码中引用的所有响应式值的列表。响应式值包括 props、state 以及所有直接在组件内部声明的变量和函数。如果你的代码检查工具 <a href="/learn/editor-setup#linting">配置了 React</a>，那么它将验证每个响应式值都被正确地指定为一个依赖项。依赖项列表必须具有固定数量的项，并且必须像 <code>[dep1, dep2, dep3]</code> 这样内联编写。React 将使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> 来比较每个依赖项和它先前的值。如果省略此参数，则在每次重新渲染组件之后，将重新运行副作用函数。</ul></section><section class="level4"aria-labelledby="返回值-returns"><h4 id="返回值-returns">返回值 {/<em>returns</em>/}</h4><p><code>useLayoutEffect</code> 返回 <code>undefined</code>。</section><section class="level4"aria-labelledby="注意事项-caveats"><h4 id="注意事项-caveats">注意事项 {/<em>caveats</em>/}</h4><ul><li><p><code>useLayoutEffect</code> 是一个 Hook，因此只能在 <strong>组件的顶层</strong> 或自己的 Hook 中调用它。不能在循环或者条件内部调用它。如果你需要的话，抽离出一个组件并将副作用处理移动到那里。<li><p>当 StrictMode 启用时，React 将在真正的 setup 函数首次运行前，<strong>运行一个额外的开发专有的 setup + cleanup 周期</strong>。这是一个压力测试，确保 cleanup 逻辑“映照”到 setup 逻辑，并停止或撤消 setup 函数正在做的任何事情。如果这导致一个问题，<a href="/learn/synchronizing-with-effects#how-to-handle-the-effect-firing-twice-in-development">请实现清理函数</a>。<li><p>如果你的一些依赖项是组件内部定义的对象或函数，则存在这样的风险，即它们将 <strong>导致 Effect 重新运行的次数多于所需的次数</strong>。要解决这个问题，请删除不必要的 <a href="/reference/react/useEffect#removing-unnecessary-object-dependencies">对象</a> 和 <a href="/reference/react/useEffect#removing-unnecessary-function-dependencies">函数</a> 依赖项。你还可以 <a href="/reference/react/useEffect#updating-state-based-on-previous-state-from-an-effect">抽离状态更新</a> 和 <a href="/reference/react/useEffect#reading-the-latest-props-and-state-from-an-effect">非响应式逻辑</a> 到 Effect 之外。<li><p>Effect <strong>只在客户端上运行</strong>，在服务端渲染中不会运行。<li><p><code>useLayoutEffect</code> 内部的代码和所有计划的状态更新阻塞了浏览器重新绘制屏幕。如果过度使用，这会使你的应用程序变慢。如果可能的话，尽量选择 <a href="/reference/react/useEffect"><code>useEffect</code></a>。<li><p>如果你在 <code>useLayoutEffect</code> 内部触发状态更新，React 将立即执行所有剩余的 Effects，包括 <code>useEffect</code>。</ul></section></section></section><section class="level2"aria-labelledby="用法-usage"><h2 id="用法-usage">用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="在浏览器重新绘制屏幕前计算布局-measuring-layout-before-the-browser-repaints-the-screen"><h3 id="在浏览器重新绘制屏幕前计算布局-measuring-layout-before-the-browser-repaints-the-screen">在浏览器重新绘制屏幕前计算布局 {/<em>measuring-layout-before-the-browser-repaints-the-screen</em>/}</h3><p>大多数组件不需要依靠它们在屏幕上的位置和大小来决定渲染什么。他们只返回一些 JSX，然后浏览器计算他们的 <strong>布局</strong>（位置和大小）并重新绘制屏幕。<p>有时候，这还不够。想象一下悬停时出现在某个元素旁边的 tooltip。如果有足够的空间，tooltip 应该出现在元素的上方，但是如果不合适，它应该出现在下面。为了让 tooltip 渲染在最终正确的位置，你需要知道它的高度（即它是否适合放在顶部）。<p>要做到这一点，你需要分两步渲染：<ol><li>将 tooltip 渲染到任何地方（即使位置不对）。<li>测量它的高度并决定放置 tooltip 的位置。<li>把 tooltip 渲染放在正确的位置。</ol><p><strong>所有这些都需要在浏览器重新绘制屏幕之前完成</strong>。你不希望用户看到 tooltip 在移动。调用 <code>useLayoutEffect</code> 在浏览器重新绘制屏幕之前执行布局测量：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Tooltip</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>tooltipHeight<span class="token punctuation">,</span> setTooltipHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 你还不知道真正的高度</span>

  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTooltipHeight</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 现在重新渲染，你知道了真实的高度</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ... 在下方的渲染逻辑中使用 tooltipHeight ...</span>
<span class="token punctuation">}</span></code></pre><p>下面是这如何一步步工作的：<ol><li><code>Tooltip</code> 使用初始值 <code>tooltipHeight = 0</code> 进行渲染（因此 tooltip 可能被错误地放置）。<li>React 将它放在 DOM 中，然后运行 <code>useLayoutEffect</code> 中的代码。<li><code>useLayoutEffect</code> <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getBoundingClientRect">测量</a> 了 tooltip 内容的高度，并立即触发重新渲染。<li>使用实际的 <code>tooltipHeight</code> 再次渲染 <code>Tooltip</code>（这样 tooltip 的位置就正确了）。<li>React 在 DOM 中对它进行更新，浏览器最终显示出 tooltip。</ol><p>将鼠标悬停在下面的按钮上，看看 tooltip 是如何根据它是否合适来调整它的位置：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">ButtonWithTooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./ButtonWithTooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
            <span class="token maybe-class-name">This</span> tooltip does not fit above the button<span class="token punctuation">.</span>
            <span class="token operator">&#x3C;</span>br <span class="token operator">/</span><span class="token operator">></span>
            <span class="token maybe-class-name">This</span> is why it's displayed below instead<span class="token operator">!</span>
          <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip above<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Tooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./Tooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ButtonWithTooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> tooltipContent<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>targetRect<span class="token punctuation">,</span> setTargetRect<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> buttonRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        <span class="token punctuation">{</span><span class="token spread operator">...</span>rest<span class="token punctuation">}</span>
        ref<span class="token operator">=</span><span class="token punctuation">{</span>buttonRef<span class="token punctuation">}</span>
        onPointerEnter<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> rect <span class="token operator">=</span> buttonRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">left</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span>
            <span class="token literal-property property">top</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">,</span>
            <span class="token literal-property property">right</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">right</span><span class="token punctuation">,</span>
            <span class="token literal-property property">bottom</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
        onPointerLeave<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token punctuation">{</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Tooltip</span> targetRect<span class="token operator">=</span><span class="token punctuation">{</span>targetRect<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>tooltipContent<span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Tooltip</span><span class="token operator">></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useLayoutEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createPortal <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">TooltipContainer</span></span> <span class="token keyword module">from</span> <span class="token string">'./TooltipContainer.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Tooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> targetRect <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>tooltipHeight<span class="token punctuation">,</span> setTooltipHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTooltipHeight</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Measured tooltip height: '</span> <span class="token operator">+</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> tooltipX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tooltipY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tooltipX <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">;</span>
    tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">top</span> <span class="token operator">-</span> tooltipHeight<span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>tooltipY <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 它不适合上方，因此把它放在下面。</span>
      tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token function">createPortal</span><span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TooltipContainer</span> x<span class="token operator">=</span><span class="token punctuation">{</span>tooltipX<span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span>tooltipY<span class="token punctuation">}</span> contentRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">TooltipContainer</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TooltipContainer</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> contentRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pointerEvents</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>contentRef<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"tooltip"</span><span class="token operator">></span>
        <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.tooltip</span></span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">white</span><span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode color">#222</span><span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>注意，即使 <code>Tooltip</code> 组件需要两次渲染（首先，使用初始值为 0 的 <code>tooltipHeight</code> 渲染，然后使用实际测量的高度渲染），你也只能看到最终结果。这就是在这个例子中需要 <code>useLayoutEffect</code> 而不是 <a href="/reference/react/useEffect"><code>useEffect</code></a> 的原因。让我们来看看下面的细节差别。</p><recipes titletext="useLayoutEffect vs useEffect"titleid="examples"><section class="level4"aria-labelledby="uselayouteffect-阻塞浏览器重新绘制-uselayouteffect-blocks-the-browser-from-repainting"><h4 id="uselayouteffect-阻塞浏览器重新绘制-uselayouteffect-blocks-the-browser-from-repainting"><code>useLayoutEffect</code> 阻塞浏览器重新绘制 {/<em>uselayouteffect-blocks-the-browser-from-repainting</em>/}</h4><p>React 保证了 <code>useLayoutEffect</code> 中的代码以及其中任何计划的状态更新都会在浏览器重新绘制屏幕之前得到处理。这样你就可以渲染 tooltip，测量它，然后在用户没有注意到第一个额外渲染的情况下再次重新渲染。换句话说，<code>useLayoutEffect</code> 阻塞了浏览器的绘制。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">ButtonWithTooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./ButtonWithTooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
            <span class="token maybe-class-name">This</span> tooltip does not fit above the button<span class="token punctuation">.</span>
            <span class="token operator">&#x3C;</span>br <span class="token operator">/</span><span class="token operator">></span>
            <span class="token maybe-class-name">This</span> is why it's displayed below instead<span class="token operator">!</span>
          <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip above<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Tooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./Tooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ButtonWithTooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> tooltipContent<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>targetRect<span class="token punctuation">,</span> setTargetRect<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> buttonRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        <span class="token punctuation">{</span><span class="token spread operator">...</span>rest<span class="token punctuation">}</span>
        ref<span class="token operator">=</span><span class="token punctuation">{</span>buttonRef<span class="token punctuation">}</span>
        onPointerEnter<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> rect <span class="token operator">=</span> buttonRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">left</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span>
            <span class="token literal-property property">top</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">,</span>
            <span class="token literal-property property">right</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">right</span><span class="token punctuation">,</span>
            <span class="token literal-property property">bottom</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
        onPointerLeave<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token punctuation">{</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Tooltip</span> targetRect<span class="token operator">=</span><span class="token punctuation">{</span>targetRect<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>tooltipContent<span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Tooltip</span><span class="token operator">></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useLayoutEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createPortal <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">TooltipContainer</span></span> <span class="token keyword module">from</span> <span class="token string">'./TooltipContainer.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Tooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> targetRect <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>tooltipHeight<span class="token punctuation">,</span> setTooltipHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useLayoutEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTooltipHeight</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> tooltipX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tooltipY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tooltipX <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">;</span>
    tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">top</span> <span class="token operator">-</span> tooltipHeight<span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>tooltipY <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 它不适合上方，因此把它放在下面。</span>
      tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token function">createPortal</span><span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TooltipContainer</span> x<span class="token operator">=</span><span class="token punctuation">{</span>tooltipX<span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span>tooltipY<span class="token punctuation">}</span> contentRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">TooltipContainer</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TooltipContainer</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> contentRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pointerEvents</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>contentRef<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"tooltip"</span><span class="token operator">></span>
        <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.tooltip</span></span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">white</span><span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode color">#222</span><span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution></solution></section><section class="level4"aria-labelledby="useeffect-不阻塞浏览器绘制-useeffect-does-not-block-the-browser"><h4 id="useeffect-不阻塞浏览器绘制-useeffect-does-not-block-the-browser"><code>useEffect</code> 不阻塞浏览器绘制 {/<em>useeffect-does-not-block-the-browser</em>/}</h4><p>下面是同样的例子，但是使用 <a href="/reference/react/useEffect"><code>useEffect</code></a> 代替 <code>useLayoutEffect</code>。如果你使用的是速度较慢的设备，你可能注意到有时 tooltip 会“闪烁”，并且会在更正位置之前短暂地看到初始位置。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">ButtonWithTooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./ButtonWithTooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
            <span class="token maybe-class-name">This</span> tooltip does not fit above the button<span class="token punctuation">.</span>
            <span class="token operator">&#x3C;</span>br <span class="token operator">/</span><span class="token operator">></span>
            <span class="token maybe-class-name">This</span> is why it's displayed below instead<span class="token operator">!</span>
          <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip above<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Tooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./Tooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ButtonWithTooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> tooltipContent<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>targetRect<span class="token punctuation">,</span> setTargetRect<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> buttonRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        <span class="token punctuation">{</span><span class="token spread operator">...</span>rest<span class="token punctuation">}</span>
        ref<span class="token operator">=</span><span class="token punctuation">{</span>buttonRef<span class="token punctuation">}</span>
        onPointerEnter<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> rect <span class="token operator">=</span> buttonRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">left</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span>
            <span class="token literal-property property">top</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">,</span>
            <span class="token literal-property property">right</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">right</span><span class="token punctuation">,</span>
            <span class="token literal-property property">bottom</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
        onPointerLeave<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token punctuation">{</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Tooltip</span> targetRect<span class="token operator">=</span><span class="token punctuation">{</span>targetRect<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>tooltipContent<span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Tooltip</span><span class="token operator">></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createPortal <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">TooltipContainer</span></span> <span class="token keyword module">from</span> <span class="token string">'./TooltipContainer.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Tooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> targetRect <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>tooltipHeight<span class="token punctuation">,</span> setTooltipHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTooltipHeight</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> tooltipX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tooltipY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tooltipX <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">;</span>
    tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">top</span> <span class="token operator">-</span> tooltipHeight<span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>tooltipY <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 它不适合上方，因此把它放在下面。</span>
      tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token function">createPortal</span><span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TooltipContainer</span> x<span class="token operator">=</span><span class="token punctuation">{</span>tooltipX<span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span>tooltipY<span class="token punctuation">}</span> contentRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">TooltipContainer</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TooltipContainer</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> contentRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pointerEvents</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>contentRef<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"tooltip"</span><span class="token operator">></span>
        <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.tooltip</span></span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">white</span><span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode color">#222</span><span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>为了使 bug 更容易重现，此版本在渲染期间人为地添加了延迟。React 将在处理 <code>useEffect</code> 内部的状态更新之前让浏览器绘制屏幕。结果，tooltip 会闪烁：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">ButtonWithTooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./ButtonWithTooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
            <span class="token maybe-class-name">This</span> tooltip does not fit above the button<span class="token punctuation">.</span>
            <span class="token operator">&#x3C;</span>br <span class="token operator">/</span><span class="token operator">></span>
            <span class="token maybe-class-name">This</span> is why it's displayed below instead<span class="token operator">!</span>
          <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip above<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ButtonWithTooltip</span>
        tooltipContent<span class="token operator">=</span><span class="token punctuation">{</span>
          <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token maybe-class-name">This</span> tooltip fits above the button<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
        <span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Hover</span> over <span class="token function">me</span> <span class="token punctuation">(</span>tooltip below<span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ButtonWithTooltip</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Tooltip</span></span> <span class="token keyword module">from</span> <span class="token string">'./Tooltip.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ButtonWithTooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> tooltipContent<span class="token punctuation">,</span> <span class="token spread operator">...</span>rest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>targetRect<span class="token punctuation">,</span> setTargetRect<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> buttonRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        <span class="token punctuation">{</span><span class="token spread operator">...</span>rest<span class="token punctuation">}</span>
        ref<span class="token operator">=</span><span class="token punctuation">{</span>buttonRef<span class="token punctuation">}</span>
        onPointerEnter<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> rect <span class="token operator">=</span> buttonRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">left</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">,</span>
            <span class="token literal-property property">top</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">top</span><span class="token punctuation">,</span>
            <span class="token literal-property property">right</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">right</span><span class="token punctuation">,</span>
            <span class="token literal-property property">bottom</span><span class="token operator">:</span> rect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
        onPointerLeave<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">setTargetRect</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token punctuation">{</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span> <span class="token operator">&#x26;&#x26;</span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Tooltip</span> targetRect<span class="token operator">=</span><span class="token punctuation">{</span>targetRect<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>tooltipContent<span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Tooltip</span><span class="token operator">></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useRef<span class="token punctuation">,</span> useEffect<span class="token punctuation">,</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createPortal <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">TooltipContainer</span></span> <span class="token keyword module">from</span> <span class="token string">'./TooltipContainer.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Tooltip</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> targetRect <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>tooltipHeight<span class="token punctuation">,</span> setTooltipHeight<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 人为地减慢了渲染</span>
  <span class="token keyword">let</span> now <span class="token operator">=</span> <span class="token dom variable">performance</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">while</span> <span class="token punctuation">(</span><span class="token dom variable">performance</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now <span class="token operator">&#x3C;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不做任何事情...</span>
  <span class="token punctuation">}</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> height <span class="token punctuation">}</span> <span class="token operator">=</span> ref<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTooltipHeight</span><span class="token punctuation">(</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> tooltipX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> tooltipY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>targetRect <span class="token operator">!==</span> <span class="token keyword null nil">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tooltipX <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">left</span><span class="token punctuation">;</span>
    tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">top</span> <span class="token operator">-</span> tooltipHeight<span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>tooltipY <span class="token operator">&#x3C;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 它不适合上方，因此把它放在下面。</span>
      tooltipY <span class="token operator">=</span> targetRect<span class="token punctuation">.</span><span class="token property-access">bottom</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token function">createPortal</span><span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TooltipContainer</span> x<span class="token operator">=</span><span class="token punctuation">{</span>tooltipX<span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span>tooltipY<span class="token punctuation">}</span> contentRef<span class="token operator">=</span><span class="token punctuation">{</span>ref<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">TooltipContainer</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TooltipContainer</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> children<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> contentRef <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pointerEvents</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>y<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span>contentRef<span class="token punctuation">}</span> className<span class="token operator">=</span><span class="token string">"tooltip"</span><span class="token operator">></span>
        <span class="token punctuation">{</span>children<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector"><span class="token class">.tooltip</span></span> <span class="token punctuation">{</span>
  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token color">white</span><span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> <span class="token hexcode color">#222</span><span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token unit">px</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>使用 <code>useLayoutEffect</code> 编辑这个例子，可以观察到即使渲染速度减慢，它也会阻塞绘制。</p><solution></solution></section></recipes><note><p>两次渲染并阻塞浏览器绘制会影响性能。尽量避免这种情况。</p></note></section></section><section class="level2"aria-labelledby="疑难解答-troubleshooting"><h2 id="疑难解答-troubleshooting">疑难解答 {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="我收到一个错误-uselayouteffect-在服务端没有任何作用-im-getting-an-error-uselayouteffect-does-nothing-on-the-server"><h3 id="我收到一个错误-uselayouteffect-在服务端没有任何作用-im-getting-an-error-uselayouteffect-does-nothing-on-the-server">我收到一个错误：“ <code>useLayoutEffect</code> 在服务端没有任何作用” {/<em>im-getting-an-error-uselayouteffect-does-nothing-on-the-server</em>/}</h3><p><code>useLayoutEffect</code> 的目的是让你的组件 <a href="#measuring-layout-before-the-browser-repaints-the-screen">使用布局信息来渲染</a>：<ol><li>渲染初始的内容。<li>在 <em>浏览器重新绘制屏幕之前</em> 测量布局。<li>使用所读取的布局信息渲染最终内容。</ol><p>当你或你的框架使用 <a href="/reference/react-dom/server">服务端渲染</a> 时，你的 React 应用将在服务端渲染 HTML 以进行初始渲染。这使你可以在加载 JavaScript 代码之前显示初始的 HTML。<p>问题是在服务器上没有布局信息。<p>在 <a href="#measuring-layout-before-the-browser-repaints-the-screen">前面的示例</a> 中，<code>Tooltip</code> 组件中的 <code>useLayoutEffect</code> 调用允许它根据内容高度正确定位自己的位置（高于或低于内容）。如果你试图将 <code>Tooltip</code> 作为服务端初始 HTML 的一部分渲染，那么这是不可能确定的。在服务端，还没有布局！因此，即使你在服务端渲染它，它的位置也会在 JavaScript 加载和运行之后在客户端上“跳动”。<p>通常，依赖于布局信息的组件不需要在服务器上渲染。例如，在初始渲染时显示 <code>Tooltip</code> 可能就没有意义了。它是通过客户端交互触发的。<p>然而，如果你遇到这个问题，你有几个不同的选择：<ul><li><p>用 <a href="/reference/react/useEffect"><code>useEffect</code></a> 替换 <code>useLayoutEffect</code>。React 可以在不阻塞绘制的情况下显示初始的渲染结果（因为初始的 HTML 将在 Effect 运行之前显示出来）。<li><p>或者，<a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-client-only-content">将你的组件标记为仅在客户端上渲染</a> 。这告诉 React 在服务器渲染期间将其内容替换为最接近的 <a href="/reference/react/Suspense"><code>&#x3C;Suspense></code></a> 处的表示加载中的后备方案（例如，一个加载动画或者光效）。<li><p>或者，只有在激活之后，使用 <code>useLayoutEffect</code> 渲染组件。保留一个初始化为 <code>false</code> 的 <code>isMounted</code> 布尔状态，并在 <code>useEffect</code> 调用中将其设置为 <code>true</code>。然后你的渲染逻辑就会像 <code>return isMounted ? &#x3C;RealContent /> : &#x3C;FallbackContent /></code> 这样。在服务端和激活过程中，用户将看到 <code>FallbackContent</code>，它不应该调用 <code>useLayoutEffect</code>。然后 React 将用 <code>RealContent</code> 替换它，<code>RealContent</code> 仅在客户端上运行并且可以包含 <code>useLayoutEffect</code> 调用。<li><p>如果你将组件与外部数据存储同步，并且依赖 <code>useLayouteffect</code> 的原因不同于测量布局，可以考虑使用 <a href="/reference/react/useSyncExternalStore#adding-support-for-server-rendering">支持服务端渲染</a> 的 <a href="/reference/react/useSyncExternalStore"><code>useSyncExternalStore</code></a>。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></ul></section></section></inlinetoc></section>