<!doctype html><html lang="zh-hans"><meta charset="utf-8"><title>useInsertionEffect</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="useinsertioneffect"><h1 id="useinsertioneffect">useInsertionEffect</h1><pitfall><p><code>useInsertionEffect</code> is for CSS-in-JS library authors. Unless you are working on a CSS-in-JS library and need a place to inject the styles, you probably want <a href="/reference/react/useEffect"><code>useEffect</code></a> or <a href="/reference/react/useLayoutEffect"><code>useLayoutEffect</code></a> instead.</p></pitfall><intro><p><code>useInsertionEffect</code> is a version of <a href="/reference/react/useEffect"><code>useEffect</code></a> that fires before any DOM mutations.<pre class="language-js"><code class="language-js"><span class="token function">useInsertionEffect</span><span class="token punctuation">(</span>setup<span class="token punctuation">,</span> dependencies<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="reference-reference"><h2 id="reference-reference">Reference {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="useinsertioneffectsetup-dependencies-useinsertioneffect"><h3 id="useinsertioneffectsetup-dependencies-useinsertioneffect"><code>useInsertionEffect(setup, dependencies?)</code> {/<em>useinsertioneffect</em>/}</h3><p>Call <code>useInsertionEffect</code> to insert the styles before any DOM mutations:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useInsertionEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token comment">// Inside your CSS-in-JS library</span>
<span class="token keyword">function</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ... inject &#x3C;style> tags here ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><a href="#usage">See more examples below.</a><section class="level4"aria-labelledby="parameters-parameters"><h4 id="parameters-parameters">Parameters {/<em>parameters</em>/}</h4><ul><li><p><code>setup</code>: The function with your Effect's logic. Your setup function may also optionally return a <em>cleanup</em> function. Before your component is added to the DOM, React will run your setup function. After every re-render with changed dependencies, React will first run the cleanup function (if you provided it) with the old values, and then run your setup function with the new values. Before your component is removed from the DOM, React will run your cleanup function.<li><p><strong>optional</strong> <code>dependencies</code>: The list of all reactive values referenced inside of the <code>setup</code> code. Reactive values include props, state, and all the variables and functions declared directly inside your component body. If your linter is <a href="/learn/editor-setup#linting">configured for React</a>, it will verify that every reactive value is correctly specified as a dependency. The list of dependencies must have a constant number of items and be written inline like <code>[dep1, dep2, dep3]</code>. React will compare each dependency with its previous value using the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> comparison algorithm. If you don't specify the dependencies at all, your Effect will re-run after every re-render of the component.</ul></section><section class="level4"aria-labelledby="returns-returns"><h4 id="returns-returns">Returns {/<em>returns</em>/}</h4><p><code>useInsertionEffect</code> returns <code>undefined</code>.</section><section class="level4"aria-labelledby="caveats-caveats"><h4 id="caveats-caveats">Caveats {/<em>caveats</em>/}</h4><ul><li>Effects only run on the client. They don't run during server rendering.<li>You can't update state from inside <code>useInsertionEffect</code>.<li>By the time <code>useInsertionEffect</code> runs, refs are not attached yet, and DOM is not yet updated.</ul></section></section></section><section class="level2"aria-labelledby="usage-usage"><h2 id="usage-usage">Usage {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="injecting-dynamic-styles-from-css-in-js-libraries-injecting-dynamic-styles-from-css-in-js-libraries"><h3 id="injecting-dynamic-styles-from-css-in-js-libraries-injecting-dynamic-styles-from-css-in-js-libraries">Injecting dynamic styles from CSS-in-JS libraries {/<em>injecting-dynamic-styles-from-css-in-js-libraries</em>/}</h3><p>Traditionally, you would style React components using plain CSS.<pre class="language-js"><code class="language-js"><span class="token comment">// In your JS file:</span>
<span class="token operator">&#x3C;</span>button className<span class="token operator">=</span><span class="token string">"success"</span> <span class="token operator">/</span><span class="token operator">></span>

<span class="token comment">// In your CSS file:</span>
<span class="token punctuation">.</span><span class="token property-access">success</span> <span class="token punctuation">{</span> <span class="token literal-property property">color</span><span class="token operator">:</span> green<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><p>Some teams prefer to author styles directly in JavaScript code instead of writing CSS files. This usually requires using a CSS-in-JS library or a tool. There are three common approaches to CSS-in-JS:<ol><li>Static extraction to CSS files with a compiler<li>Inline styles, e.g. <code>&#x3C;div style={{ opacity: 1 }}></code><li>Runtime injection of <code>&#x3C;style></code> tags</ol><p>If you use CSS-in-JS, we recommend a combination of the first two approaches (CSS files for static styles, inline styles for dynamic styles). <strong>We don't recommend runtime <code>&#x3C;style></code> tag injection for two reasons:</strong><ol><li>Runtime injection forces the browser to recalculate the styles a lot more often.<li>Runtime injection can be very slow if it happens at the wrong time in the React lifecycle.</ol><p>The first problem is not solvable, but <code>useInsertionEffect</code> helps you solve the second problem.<p>Call <code>useInsertionEffect</code> to insert the styles before any DOM mutations:<pre class="language-js"><code class="language-js"><span class="token comment">// Inside your CSS-in-JS library</span>
<span class="token keyword">let</span> isInserted <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// As explained earlier, we don't recommend runtime injection of &#x3C;style> tags.</span>
    <span class="token comment">// But if you have to do it, then it's important to do in useInsertionEffect.</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isInserted<span class="token punctuation">.</span><span class="token method function property-access">has</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isInserted<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">head</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span><span class="token function">getStyleForRule</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Button</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> className <span class="token operator">=</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div className<span class="token operator">=</span><span class="token punctuation">{</span>className<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Similarly to <code>useEffect</code>, <code>useInsertionEffect</code> does not run on the server. If you need to collect which CSS rules have been used on the server, you can do it during rendering:<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> collectedRulesSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useCSS</span><span class="token punctuation">(</span><span class="token parameter">rule</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token dom variable">window</span> <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    collectedRulesSet<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">useInsertionEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> rule<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><a href="https://github.com/reactwg/react-18/discussions/110">Read more about upgrading CSS-in-JS libraries with runtime injection to <code>useInsertionEffect</code>.</a></p><deepdive><section class="level4"aria-labelledby="how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect-how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect"><h4 id="how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect-how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect">How is this better than injecting styles during rendering or useLayoutEffect? {/<em>how-is-this-better-than-injecting-styles-during-rendering-or-uselayouteffect</em>/}</h4><p>If you insert styles during rendering and React is processing a <a href="/reference/react/useTransition#marking-a-state-update-as-a-non-blocking-transition">non-blocking update,</a> the browser will recalculate the styles every single frame while rendering a component tree, which can be <strong>extremely slow.</strong><p><code>useInsertionEffect</code> is better than inserting styles during <a href="/reference/react/useLayoutEffect"><code>useLayoutEffect</code></a> or <a href="/reference/react/useEffect"><code>useEffect</code></a> because it ensures that by the time other Effects run in your components, the <code>&#x3C;style></code> tags have already been inserted. Otherwise, layout calculations in regular Effects would be wrong due to outdated styles.</p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></deepdive></section></section></inlinetoc></section>