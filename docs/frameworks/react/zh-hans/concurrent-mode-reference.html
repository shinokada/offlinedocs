<!doctype html>
<html lang="zh-hans">
  <head>
    <meta charset="utf-8">
    <title>Concurrent 模式 API 参考（实验版）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css">
  </head>
  <body>
    <section id="concurrent-模式-api-参考实验版" class="level1">
      <h1>Concurrent 模式 API 参考（实验版）</h1>
      <style>.scary > blockquote {
background-color: rgba(237, 51, 21, 0.2);
border-left-color: #ed3315;
}</style>
      <div class="scary">
        <blockquote>
          <p>注意：</p>
          <p>本章节所描述的功能还处于实验阶段，在稳定版本中尚不可用。它面向的人群是早期使用者以及好奇心较强的人。</p>
          <p>本页面中许多信息现已过时，仅仅是为了存档而存在。欲了解最新信息，<strong>请参阅 <a href="/blog/2021/06/08/the-plan-for-react-18.html">React 18 Alpha 版公告</a></strong>。</p>
          <p>在 React 18 发布前，我们将用稳定的文档替代此章节。</p>
        </blockquote>
      </div>
      <p>本章节为 <a href="./concurrent-mode-intro.html">Concurrent 模式</a>的 React API 参考。如果你想找使用指南，请查阅 <a href="./concurrent-mode-patterns.html">Concurrent UI 模式</a>。</p>
      <p><strong>注意：这是社区的预览版，并不是最终的稳定版本。这些 API 将来可能会发生变化。请自行承担风险！</strong></p>
      <ul>
        <li><a href="#concurrent-mode">启用 Concurrent 模式</a>
          <ul>
            <li><a href="#createroot"><code>createRoot</code></a></li>
          </ul>
        </li>
        <li><a href="#suspense">Suspense</a>
          <ul>
            <li><a href="#suspensecomponent"><code>Suspense</code></a></li>
            <li><a href="#suspenselist"><code>SuspenseList</code></a></li>
            <li><a href="#usetransition"><code>useTransition</code></a></li>
            <li><a href="#usedeferredvalue"><code>useDeferredValue</code></a></li>
          </ul>
        </li>
      </ul>
      <section id="concurrent-mode" class="level2">
        <h2>启用 Concurrent 模式</h2>
        <section id="createroot-createroot" class="level3">
          <h3><code>createRoot</code> {#createroot}</h3>
          <pre class="language-js"><code class="language-js"><span class="token maybe-class-name">ReactDOM</span><span class="token punctuation">.</span><span class="token method function property-access">createRoot</span><span class="token punctuation">(</span>rootNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p>使用上述代码替换 <code>ReactDOM.render(&#x3C;App />, rootNode)</code> 并启用 Concurrent 模式。</p>
          <p>欲了解有关 Concurrent 模式的更多信息，请查阅 <a href="./concurrent-mode-intro.html">Concurrent 模式文档</a></p>
        </section>
      </section>
      <section id="suspense" class="level2">
        <h2>Suspense API</h2>
        <section id="suspense-suspensecomponent" class="level3">
          <h3><code>Suspense</code> {#suspensecomponent}</h3>
          <pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span>h1<span class="token operator">></span>加载中<span class="token spread operator">...</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfilePhoto</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileDetails</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span></code></pre>
          <p><code>Suspense</code> 让你的组件在渲染之前进行“等待”，并在等待时显示 fallback 的内容。</p>
          <p>在这个示例中，<code>ProfileDetails</code> 正在等待异步 API 调用来获取某些数据。在等待 <code>ProfileDetails</code> 和 <code>ProfilePhoto</code> 时，我们将显示<code>加载中...</code>的 fallback。请注意，在 <code>&#x3C;Suspense></code> 中的所有子组件都加载之前，我们将继续显示这个 fallback。</p>
          <p><code>Suspense</code> 接受两个 props：</p>
          <ul>
            <li><strong>fallback</strong> 接受一个加载指示器。这个 fallback 在 <code>Suspense</code> 所有子组件完成渲染之前将会一直显示。</li>
            <li><strong>unstable_avoidThisFallback</strong> 接受一个布尔值。它告诉 React 是否在初始加载时“跳过”显示这个边界，这个 API 可能会在后续版本中删除。</li>
          </ul>
        </section>
        <section id="suspenselist-suspenselist" class="level3">
          <h3><code>&#x3C;SuspenseList></code> {#suspenselist}</h3>
          <pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">SuspenseList</span> revealOrder<span class="token operator">=</span><span class="token string">"forwards"</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'加载中...'</span><span class="token punctuation">}</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfilePicture</span> id<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'加载中...'</span><span class="token punctuation">}</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfilePicture</span> id<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'加载中...'</span><span class="token punctuation">}</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfilePicture</span> id<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
  <span class="token spread operator">...</span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">SuspenseList</span><span class="token operator">></span></code></pre>
          <p><code>SuspenseList</code> 通过编排向用户显示这些组件的顺序，来帮助协调许多可以挂起的组件。</p>
          <p>当多个组件需要获取数据时，这些数据可能会以不可预知的顺序到达。不过，如果你将这些项目包装在 <code>SuspenseList</code> 中，React 将不会在列表中显示这个项目，直到它之前的项目已经显示（此行为可调整）。</p>
          <p><code>SuspenseList</code> 接受两个 props：</p>
          <ul>
            <li><strong>revealOrder (forwards, backwards, together)</strong> 定义了 <code>SuspenseList</code> 子组件应该显示的顺序。
              <ul>
                <li><code>together</code> 在<em>所有</em>的子组件都准备好了的时候显示它们，而不是一个接着一个显示。</li>
              </ul>
            </li>
            <li><strong>tail (collapsed, hidden)</strong> 指定如何显示 <code>SuspenseList</code> 中未加载的项目。
              <ul>
                <li>默认情况下，<code>SuspenseList</code> 将显示列表中的所有 fallback。</li>
                <li><code>collapsed</code> 仅显示列表中下一个 fallback。</li>
                <li><code>hidden</code> 未加载的项目不显示任何信息。</li>
              </ul>
            </li>
          </ul>
          <p>请注意，<code>SuspenseList</code> 只对其下方最近的 <code>Suspense</code> 和 <code>SuspenseList</code> 组件进行操作。它不会搜索深度超过一级的边界。不过，可以将多个 <code>SuspenseList</code> 组件相互嵌套来构建栅格。</p>
        </section>
        <section id="usetransition-usetransition" class="level3">
          <h3><code>useTransition</code> {#usetransition}</h3>
          <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">SUSPENSE_CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeoutMs</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>startTransition<span class="token punctuation">,</span> isPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token constant">SUSPENSE_CONFIG</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p><code>useTransition</code> 允许组件在<strong>切换到下一个界面</strong>之前等待内容加载，从而避免不必要的加载状态。它还允许组件将速度较慢的数据获取更新推迟到随后渲染，以便能够立即渲染更重要的更新。</p>
          <p><code>useTransition</code> hook 返回两个值的数组。</p>
          <ul>
            <li><code>startTransition</code> 是一个接受回调的函数。我们用它来告诉 React 需要推迟的 state。</li>
            <li><code>isPending</code> 是一个布尔值。这是 React 通知我们是否正在等待过渡的完成的方式。</li>
          </ul>
          <p><strong>如果某个 state 更新导致组件挂起，则该 state 更新应包装在 transition 中</strong></p>
          <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">SUSPENSE_CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeoutMs</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>resource<span class="token punctuation">,</span> setResource<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span>initialResource<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>startTransition<span class="token punctuation">,</span> isPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token constant">SUSPENSE_CONFIG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        disabled<span class="token operator">=</span><span class="token punctuation">{</span>isPending<span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> nextUserId <span class="token operator">=</span> <span class="token function">getNextId</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token property-access">userId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setResource</span><span class="token punctuation">(</span><span class="token function">fetchProfileData</span><span class="token punctuation">(</span>nextUserId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Next</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>isPending <span class="token operator">?</span> <span class="token string">" 加载中..."</span> <span class="token operator">:</span> <span class="token keyword null nil">null</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Spinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfilePage</span> resource<span class="token operator">=</span><span class="token punctuation">{</span>resource<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
          <p>在这段代码中，我们使用 <code>startTransition</code> 包装了我们的数据获取。这使我们可以立即开始获取用户资料的数据，同时推迟下一个用户资料页面以及其关联的 <code>Spinner</code> 的渲染 2 秒钟（<code>timeoutMs</code> 中显示的时间）。</p>
          <p><code>isPending</code> 布尔值让 React 知道我们的组件正在切换，因此我们可以通过在之前的用户资料页面上显示一些加载文本来让用户知道这一点。</p>
          <p><strong>深入了解 transition，可以阅读 <a href="./concurrent-mode-patterns.html#transitions">Concurrent UI 模式</a>.</strong></p>
          <section id="usetransition-config" class="level4">
            <h4>useTransition 配置</h4>
            <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">SUSPENSE_CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeoutMs</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
            <p><code>useTransition</code> 接受带有 <code>timeoutMs</code> 的<strong>可选的 Suspense 配置</strong>。 此超时（毫秒）告诉 React 在显示下一个状态（上例中为新的用户资料页面）之前等待多长时间。</p>
            <p><strong>注意：我们建议你在不同的模块之间共享 Suspense 配置。</strong></p>
          </section>
        </section>
        <section id="usedeferredvalue-usedeferredvalue" class="level3">
          <h3><code>useDeferredValue</code> {#usedeferredvalue}</h3>
          <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> deferredValue <span class="token operator">=</span> <span class="token function">useDeferredValue</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeoutMs</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p>返回一个延迟响应的值，该值可能“延后”的最长时间为 <code>timeoutMs</code>。</p>
          <p>这通常用于在具有基于用户输入立即渲染的内容，以及需要等待数据获取的内容时，保持接口的可响应性。</p>
          <p>文本输入框是个不错的示例。</p>
          <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>text<span class="token punctuation">,</span> setText<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> deferredText <span class="token operator">=</span> <span class="token function">useDeferredValue</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeoutMs</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div className<span class="token operator">=</span><span class="token string">"App"</span><span class="token operator">></span>
      <span class="token punctuation">{</span><span class="token comment">/* 保持将当前文本传递给 input */</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span>input value<span class="token operator">=</span><span class="token punctuation">{</span>text<span class="token punctuation">}</span> onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token spread operator">...</span>
      <span class="token punctuation">{</span><span class="token comment">/* 但在必要时可以将列表“延后” */</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MySlowList</span> text<span class="token operator">=</span><span class="token punctuation">{</span>deferredText<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span></code></pre>
          <p>这让我们可以立即显示 <code>input</code> 的新文本，从而感觉到网页的响应。同时，<code>MySlowList</code> “延后” 2 秒，根据 <code>timeoutMs</code> ，更新之前，允许它在后台渲染当前文本。</p>
          <p><strong>深入了解延迟值，可以阅读 <a href="./concurrent-mode-patterns.html#deferring-a-value">Concurrent UI 模式</a>。</strong></p>
          <section id="usedeferredvalue-config" class="level4">
            <h4>useDeferredValue 配置</h4>
            <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token constant">SUSPENSE_CONFIG</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">timeoutMs</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
            <p><code>useDeferredValue</code> 所接受的<strong>配置参数 Suspense 可选</strong>，该参数包含 <code>timeoutMs</code> 字段。此超时（以毫秒为单位）表示延迟的值允许延后多长时间。</p>
            <p>
              当网络和设备允许时，React 始终会尝试使用较短的延迟。
              <span style="float: footnote;"><a href="./index.html#toc">Go to TOC</a></span>
            </p>
          </section>
        </section>
      </section>
    </section>
  </body>
</html>
