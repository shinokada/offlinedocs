<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>パフォーマンス最適化</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css">
  </head>
  <body>
    <section id="パフォーマンス最適化" class="level1">
      <h1>パフォーマンス最適化</h1>
      <p>React は UI の更新時に必要となる高コストな DOM 操作の回数を最小化するために、内部的にいくつかの賢いテクニックを使用しています。多くのアプリケーションでは React を使用するだけで、パフォーマンス向上のための特別な最適化を苦労して行わなくても、レスポンスの良いユーザインターフェースを実現できますが、それでもなお、React アプリケーションを高速化するための方法はいくつか存在します。</p>
      <section id="use-the-production-build" class="level2">
        <h2>本番用ビルドを使用する</h2>
        <p>React アプリケーションでベンチマークを行う場合やパフォーマンスの問題が発生している場合には、ミニファイされた本番用ビルドでテストしていることを確認してください。</p>
        <p>デフォルトで React は多くの有用な警告チェックを行い、開発時にはとても有用です。しかしそれによって React アプリケーションのサイズが肥大化し、速度が低下してしまうため、アプリケーションのデプロイ時には本番バージョンを使用していることを確認してください。</p>
        <p>ビルドプロセスが正しく設定されているか分からない場合、<a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React Developer Tools for Chrome</a> をインストールして確認できます。本番用モードの React のサイトを訪れた場合、アイコンは暗い背景となっています。</p>
        <img src="../images/docs/devtools-prod.png" style="max-width:100%" alt="React DevTools on a website with production version of React">
        <p>開発モードの React のサイトを訪れた場合、アイコンは赤い背景となっています。</p>
        <img src="../images/docs/devtools-dev.png" style="max-width:100%" alt="React DevTools on a website with development version of React">
        <p>アプリケーションに対して作業をしているときは開発モードを使用し、利用者に配布する場合には本番用モードを使用することをお勧めします。</p>
        <p>本番用にアプリを構築するためのそれぞれのツールにおける手順を以下に示します。</p>
        <section id="create-react-app" class="level3">
          <h3>Create React App</h3>
          <p>プロジェクトが <a href="https://github.com/facebookincubator/create-react-app">Create React App</a> で構築されているなら、以下のコードを実行してください。</p>
          <pre class="language-text"><code class="language-text">npm run build</code></pre>
          <p>これでアプリケーションの本番用ビルドがプロジェクト内の <code>build/</code> フォルダに作成されます。</p>
          <p>これが必要なのは本番用ビルドだけであることに留意してください。通常の開発作業では、<code>npm start</code> を使用してください。</p>
        </section>
        <section id="single-file-builds" class="level3">
          <h3>単一ファイル版ビルド</h3>
          <p>React と ReactDOM をそれぞれ単一ファイル化した本番環境用のバージョンを提供しています。</p>
          <pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react@18/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@18/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre>
          <p>本番用に適しているのは、React ファイル名の末尾が <code>.production.min.js</code> であるもののみであることに留意ください。</p>
        </section>
        <section id="brunch" class="level3">
          <h3>Brunch</h3>
          <p>Brunch で最も効率のよい本番用ビルドを行うには、<a href="https://github.com/brunch/terser-brunch"><code>terser-brunch</code></a> をインストールしてください：</p>
          <pre class="language-text"><code class="language-text"># If you use npm
npm install --save-dev terser-brunch

# If you use Yarn
yarn add --dev terser-brunch</code></pre>
          <p>そして、本番用ビルドを作成するために、<code>build</code> コマンドに<code>-p</code> オプションを指定して実行します。</p>
          <pre class="language-text"><code class="language-text">brunch build -p</code></pre>
          <p>これが必要なのは本番用ビルドだけであることに留意してください。React の有用な警告表示が隠されたり、ビルド速度が大幅に遅くなったりしますので、開発用では <code>-p</code> フラグを指定したり、<code>uglify-js-brunch</code> プラグインを適用したりしないでください。</p>
        </section>
        <section id="browserify" class="level3">
          <h3>Browserify</h3>
          <p>Browserify で最も効率の良い本番用ビルドを行うには、いくつかのプラグインをインストールしてください。</p>
          <pre class="language-text"><code class="language-text"># If you use npm
npm install --save-dev envify terser uglifyify

# If you use Yarn
yarn add --dev envify terser uglifyify</code></pre>
          <p>本番用ビルドを作成するには、以下の変換 (transform) を追加してください（<strong>順番は重要です</strong>）。</p>
          <ul>
            <li><a href="https://github.com/hughsk/envify"><code>envify</code></a> 変換は正しいビルド用の環境変数が確実に設定されるようにします。グローバルに設定してください (<code>-g</code>)。</li>
            <li><a href="https://github.com/hughsk/uglifyify"><code>uglifyify</code></a> 変換は開発用にインポートしたライブラリを削除します。これもグローバルに設定してください (<code>-g</code>)。</li>
            <li>最後に結果として出力されたものを、名前の圧縮のために <a href="https://github.com/terser-js/terser"><code>terser</code></a> にパイプします（<a href="https://github.com/hughsk/uglifyify#motivationusage">理由を読む</a>）。</li>
          </ul>
          <p>以下に例を示します。</p>
          <pre class="language-text"><code class="language-text">browserify ./index.js \
  -g [ envify --NODE_ENV production ] \
  -g uglifyify \
  | terser --compress --mangle > ./bundle.js</code></pre>
          <p>これが必要なのは本番用ビルドだけであることに留意してください。React の有用な警告文が隠されたり、ビルド速度が大幅に遅くなったりしますので、開発用ではこれらのプラグインを適用しないでください。</p>
        </section>
        <section id="rollup" class="level3">
          <h3>Rollup</h3>
          <p>Rollup で最も効率のよい本番用ビルドを行うには、いくつかのプラグインを以下のようにインストールします。</p>
          <pre class="language-bash"><code class="language-bash"><span class="token comment"># If you use npm</span>
<span class="token function">npm</span> <span class="token function">install</span> --save-dev rollup-plugin-commonjs rollup-plugin-replace rollup-plugin-terser

<span class="token comment"># If you use Yarn</span>
<span class="token function">yarn</span> <span class="token function">add</span> --dev rollup-plugin-commonjs rollup-plugin-replace rollup-plugin-terser</code></pre>
          <p>本番用ビルドを作成するには、以下のプラグインを追加してください（<strong>順番は重要</strong>です）。</p>
          <ul>
            <li><a href="https://github.com/rollup/rollup-plugin-replace"><code>replace</code></a> プラグインは正しいビルド用の環境変数が確実に設定されるようにします。</li>
            <li><a href="https://github.com/rollup/rollup-plugin-commonjs"><code>commonjs</code></a> プラグインは Rollup で CommonJS をサポートできるようにします。</li>
            <li><a href="https://github.com/TrySound/rollup-plugin-terser"><code>terser</code></a> プラグインは出力された最終的なバンドルを圧縮し、mangle（訳注：変数名や識別子を短縮）します。</li>
          </ul>
          <pre class="language-js"><code class="language-js"><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token comment">// ...</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup-plugin-replace'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup-plugin-commonjs'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup-plugin-terser'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">]</span></code></pre>
          <p>設定例の全体はこの <a href="https://gist.github.com/Rich-Harris/cb14f4bc0670c47d00d191565be36bf0">gist を参照</a>してください。</p>
          <p>これらが必要なのは本番用ビルドだけであることに留意してください。React の有用な警告表示が隠されたり、ビルド速度が大幅に遅くなったりしますので、開発用では <code>terser</code> プラグインもしくは <code>replace</code> プラグインを <code>'production'</code> という値で適用しないでください。</p>
        </section>
        <section id="webpack" class="level3">
          <h3>webpack</h3>
          <blockquote>
            <p><strong>補足：</strong></p>
            <p>Create React App を利用している場合は、<a href="#create-react-app">Create React App についての前述の説明</a>に従ってください。<br>このセクションは直接 webpack の設定を行いたい人向けです。</p>
          </blockquote>
          <p>Webpack v4 以降では本番 (production) モードでコードの minify を自動で行います。</p>
          <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">TerserPlugin</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">/* additional options here */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
          <p>より詳細な説明については <a href="https://webpack.js.org/guides/production/">webpack のドキュメント</a>を参照ください。</p>
          <p>これらが必要なのは本番用ビルドだけであることに留意してください。React の有用な警告文が隠されたり、ビルド速度が大幅に遅くなったりしますので、開発時には <code>TerserPlugin</code> を適用しないでください。</p>
        </section>
      </section>
      <section id="profiling-components-with-the-devtools-profiler" class="level2">
        <h2>DevTools プロファイラを使用したコンポーネントのプロファイリング</h2>
        <p>
          <code>react-dom</code> 16.5 以降と <code>react-native</code> 0.57 以降では、開発モードにおける強化されたプロファイリング機能を React DevTools プロファイラにて提供しています。
          このプロファイラの概要はブログ記事 <a href="/blog/2018/09/10/introducing-the-react-profiler.html">"Introducing the React Profiler"</a> で説明されています。
          チュートリアル動画も <a href="https://www.youtube.com/watch?v=nySib7ipZdk">YouTube で閲覧できます</a>。
        </p>
        <p>React DevTools をまだインストールしていない場合は、以下で見つけることができます。</p>
        <ul>
          <li><a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi?hl=en">Chrome ブラウザ拡張</a></li>
          <li><a href="https://addons.mozilla.org/en-GB/firefox/addon/react-devtools/">Firefox ブラウザ拡張</a></li>
          <li><a href="https://www.npmjs.com/package/react-devtools">スタンドアロンの Node パッケージ</a></li>
        </ul>
        <blockquote>
          <p>補足</p>
          <p>
            本番ビルド版 <code>react-dom</code> のプロファイリング可能なバンドルとして <code>react-dom/profiling</code> が利用可能です。
            このバンドルの使い方の詳細については、<a href="https://fb.me/react-profiling">fb.me/react-profiling</a> を参照してください。
          </p>
        </blockquote>
        <blockquote>
          <p>補足</p>
          <p>
            React 17 より前のバージョンでは、標準の <a href="https://developer.mozilla.org/en-US/docs/Web/API/User_Timing_API">User Timing API</a> を用いて Chrome のパフォーマンスタブでコンポーネントのプロファイリングが行われていました。
            これについての概要は <a href="https://calibreapp.com/blog/react-performance-profiling-optimization">Ben Schwarz によるこの記事</a>を参照してください。
          </p>
        </blockquote>
      </section>
      <section id="virtualize-long-lists" class="level2">
        <h2>長いリストの仮想化</h2>
        <p>アプリケーションが長いデータのリスト（数百〜数千行）をレンダーする場合は、「ウィンドウイング」として知られるテクニックを使うことをおすすめします。このテクニックでは、ある瞬間ごとにはリストの小さな部分集合のみを描画することで、生成する DOM ノードの数およびコンポーネントの再描画にかかる時間を大幅に削減することができます。</p>
        <p><a href="https://react-window.now.sh/">react-window</a> と <a href="https://bvaughn.github.io/react-virtualized/">react-virtualized</a> は人気があるウィンドウイング処理のライブラリです。これらはリスト、グリッド、および表形式のデータを表示するための、いくつかの再利用可能コンポーネントを提供しています。アプリケーションの特定のユースケースに合わせた追加的な処理をする場合は、<a href="https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3">Twitter</a> が行なっているように、独自のウィンドウイング処理のコンポーネントを作成することもできます。</p>
      </section>
      <section id="avoid-reconciliation" class="level2">
        <h2>リコンシリエーション（差分検出処理）を避ける</h2>
        <p>React はレンダーされた UI の内部表現を構築し、維持します。その内部表現にはコンポーネントが返した React 要素も含まれています。React はこの内部表現を使うことによって、DOM ノードの不要な作成やアクセス（これらは JavaScript オブジェクト操作よりも低速です）を回避します。この内部表現はしばしば "仮想 DOM" と呼ばれますが、React Native 上でも同様に動くものです。</p>
        <p>コンポーネントの props や state が変更された場合、React は新しく返された要素と以前にレンダーされたものとを比較することで、実際の DOM の更新が必要かを判断します。それらが等しくない場合、React は DOM を更新します。</p>
        <p>React は変更された DOM ノードだけを更新するとはいえ、再レンダーには時間がかかります。多少の時間がかかっても多くの場合は問題にはなりませんが、遅延が目立つ場合、再レンダープロセスが開始される前にトリガーされるライフサイクル関数 <code>shouldComponentUpdate</code> をオーバーライド定義することで、スピードを抜本的に向上できます。この関数のデフォルトの実装は <code>true</code> を返し、React に更新処理をそのまま実行させます：</p>
        <pre class="language-javascript"><code class="language-javascript"><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>ある状況においてコンポーネントを更新する必要がないと分かっているなら、<code>shouldComponentUpdate</code> から <code>false</code> を返すことにより、該当コンポーネントおよび配下への <code>render()</code> 呼び出しを含む、レンダー処理の全体をスキップすることができます。</p>
        <p>ほとんどの場合には、手書きの <code>shouldComponentUpdate()</code> を定義する代わりに <a href="./react-api.html#reactpurecomponent"><code>React.PureComponent</code></a> を継承できます。これは現在と直前の props と state に対する浅い (shallow) 比較を行う <code>shouldComponentUpdate()</code> を実装することと同じです。</p>
      </section>
      <section id="shouldcomponentupdate-in-action" class="level2">
        <h2>shouldComponentUpdate の実際の動作</h2>
        <p>以下のようなコンポーネントのサブツリーがあるとします。それぞれ、<code>SCU</code> は <code>shouldComponentUpdate</code> が返した値（訳注：緑は true、赤は false）を示し、<code>vDOMEq</code> はレンダーされた React 要素が等しかったかどうか（訳注：緑は等しい、赤は等しくない）を示します。最後に、円の色はコンポーネントに対してツリーの差分を検出するリコンシリエーション処理を必要としたのかどうか（訳注：緑は不要、赤は必要）を示します。</p>
        <figure>
          <img src="../images/docs/should-component-update.png" style="max-width:100%">
        </figure>
        <p>C2 をルートとするサブツリーでは <code>shouldComponentUpdate</code> が <code>false</code> を返したので、React は C2 をレンダーしようとしませんでした。したがって C4 と C5 については <code>shouldComponentUpdate</code> を実行する必要すらなかったわけです。</p>
        <p>C1 と C3 では、<code>shouldComponentUpdate</code> が <code>true</code> を返したので、React は葉ノードにも移動してチェックする必要がありました。C6 では <code>shouldComponentUpdate</code> が <code>true</code> を返し、そしてレンダーされた React 要素も等しくなかったので、React は DOM を更新する必要がありました。</p>
        <p>最後の興味深いケースが C8 です。React はこのコンポーネントをレンダーする必要がありましたが、返された React 要素は前回レンダーされたときものと同じだったので、DOM の更新は必要ありませんでした。</p>
        <p>React が実 DOM を更新しなければならなかったのは、C6 だけだったことに注目してください。C6 の更新は避けられないものでした。C8 では、レンダーされた React 要素の比較のおかげで実 DOM を修正せずに済みました。C2 のサブツリーと C7 のケースでは <code>shouldComponentUpdate</code> のおかげで、<code>render</code> メソッドの呼び出しや React 要素の比較処理すらスキップすることができました。</p>
      </section>
      <section id="examples" class="level2">
        <h2>例</h2>
        <p>コンポーネントが変化するのが <code>props.color</code> または <code>state.count</code> 変数が変化した時だけだとしたら、<code>shouldComponentUpdate</code> では以下のようなチェックを行えます。</p>
        <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">CounterButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">color</span> <span class="token operator">!==</span> nextProps<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">!==</span> nextState<span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>button
        color<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token literal-property property">Count</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        <p>このコードは、<code>shouldComponentUpdate</code> は <code>props.color</code> または <code>state.count</code> の変化の有無を単にチェックしているだけです。これらの値が変化していなければコンポーネントは更新されません。コンポーネントがもっと複雑な場合は、<code>props</code> と <code>state</code> のすべてのフィールドに対して「浅い比較」をするという同種のパターンでコンポーネント更新の必要性を決定できます。このパターンはとても一般的なので、React はこのロジックのためのヘルパーを用意しており、<code>React.PureComponent</code> から継承するだけで使用できます。なので以下のコードで前述のコードと同じことをよりシンプルに実装できます。</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">CounterButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>button
        color<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token literal-property property">Count</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        <p>ほとんどの場合、自分で <code>shouldComponentUpdate</code> を記述する代わりに <code>React.PureComponent</code> を使うことができます。もっとも、浅い比較を行うだけですので、浅い比較では検出できない形で props や state がミューテート（mutate; 書き換え）されている可能性がある場合には使えません。</p>
        <p>この事はより複雑なデータ構造の場合には問題となります。例えば、カンマ区切りで単語をレンダーする <code>ListOfWords</code> コンポーネントと、ボタンをクリックしてリストに単語を追加できる親コンポーネント <code>WordAdder</code> が必要だとして、以下のコードは正しく動作しません。</p>
        <pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ListOfWords</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">WordAdder</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">words</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'marklar'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This section is bad style and causes a bug</span>
    <span class="token keyword">const</span> words <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">;</span>
    words<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">'marklar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">words</span><span class="token operator">:</span> words<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ListOfWords</span> words<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        <p>問題は <code>PureComponent</code> が <code>this.props.words</code> の古い値と新しい値を単純に比較していることにあります。上記のコードでは <code>WordAdder</code> の handleClick メソッド内で <code>words</code> 配列の内容をミューテートしてしまうので、<code>this.props.words</code> の新旧の値は、たとえ配列内の実際の単語が変更されていたとしても、比較の結果同じだとみなしてしまうのです。そのため <code>ListOfWords</code> はレンダーすべき新しい単語が追加されているにも関わらず、更新されません。</p>
      </section>
      <section id="the-power-of-not-mutating-data" class="level2">
        <h2>データを変更しないことの効果</h2>
        <p>この問題を避ける最も単純な方法は、props や state として使用する値のミューテートを避けることです。例えば、上記の <code>handleClick</code> メソッドは <code>concat</code> を使って以下のように書き換えることができます：</p>
        <pre class="language-javascript"><code class="language-javascript"><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">words</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'marklar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>ES6 はこれをより簡潔に実装できる配列の<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_operator">スプレッド構文</a>をサポートしています。Create React App を使用していれば、この構文はデフォルトで利用できます。</p>
        <pre class="language-js"><code class="language-js"><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">words</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>state<span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">,</span> <span class="token string">'marklar'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
        <p>同様に、オブジェクトについてもミューテートするコードをしないように書き換えることができます。例えば、<code>colormap</code> というオブジェクトがあり、<code>colormap.right</code> を <code>'blue'</code> に更新する関数が必要だとしましょう。以下のように書くことも可能ですが、</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  colormap<span class="token punctuation">.</span><span class="token property-access">right</span> <span class="token operator">=</span> <span class="token string">'blue'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>この処理を、元オブジェクトをミューテートせずに実装するために、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a> を使用できます。</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> colormap<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>これで、<code>updateColorMap</code> は古いオブジェクトをミューテートするのではなく新しいオブジェクトを返すようになります。<code>Object.assign</code> は ES6 からの機能であり、ポリフィルが必要です（訳注：ブラウザや処理系が ES6 に未対応の場合）。</p>
        <p>同様に、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">オブジェクトのスプレッドプロパティ構文</a>を使うことで、ミューテートを避けてのオブジェクト更新が容易になります。</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span><span class="token spread operator">...</span>colormap<span class="token punctuation">,</span> <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>この機能は ES2018 で JavaScript に追加されたものです。</p>
        <p>Create React App を使用しているなら、<code>Object.assign</code> およびオブジェクトのスプレッド構文の両方がデフォルトで利用できます。</p>
        <p>
          深くネストされたオブジェクトを扱っている場合、ミューテートを行わない形式で更新することが複雑に感じることがあります。このような問題がある場合は <a href="https://github.com/mweststrate/immer">Immer</a> や <a href="https://github.com/kolodny/immutability-helper">immutability-helper</a> を試してみてください。これらのライブラリはミューテートを行わないことによる利点を損なわずに、読みやすいコードを書くのに役立ちます。
          <span style="float: footnote;"><a href="./index.html#toc">Go to TOC</a></span>
        </p>
      </section>
    </section>
  </body>
</html>
