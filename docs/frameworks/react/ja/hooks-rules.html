<!doctypehtml><html lang="ja"><meta charset="utf-8"><title>フックのルール</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css"><section id="フックのルール"class="level1"><h1>フックのルール</h1><p><em>フック (hook)</em> は React 16.8 で追加された新機能です。state などの React の機能を、クラスを書かずに使えるようになります。<p>フックは JavaScript の関数ですが、それらを使う際には以下の 2 つのルールに従う必要があります。我々は自動的にこのルールを強制するための <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks">linter プラグイン</a> を提供しています。<section id="only-call-hooks-at-the-top-level"class="level3"><h3>フックを呼び出すのはトップレベルのみ</h3><p><strong>フックをループや条件分岐、あるいはネストされた関数内で呼び出してはいけません。</strong>代わりに、あなたの React の関数のトップレベルでのみ、あらゆる早期 return 文よりも前の場所で呼び出してください。これを守ることで、コンポーネントがレンダーされる際に毎回同じ順番で呼び出されるということが保証されます。これが、複数回 <code>useState</code> や <code>useEffect</code> が呼び出された場合でも React がフックの状態を正しく保持するための仕組みです（興味がある場合は<a href="#explanation">ページ下部</a>で詳しく説明しています）。</section><section id="only-call-hooks-from-react-functions"class="level3"><h3>フックを呼び出すのは React の関数内のみ</h3><p><strong>フックを通常の JavaScript 関数から呼び出さないでください。</strong>代わりに以下のようにします。<ul><li>✅ React の関数コンポーネント内から呼び出す。<li>✅ カスタムフック内（<a href="./hooks-custom.html">次のページで説明します</a>）から呼び出す。</ul><p>このルールを守ることで、コンポーネント内のすべての state を使うロジックがソースコードから間違いなく参照可能になります。</section><section id="eslint-plugin"class="level2"><h2>ESLint プラグイン</h2><p>これらの 2 つのルールを強制できる <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks"><code>eslint-plugin-react-hooks</code></a> という ESLint のプラグインをリリースしました。試したい場合はあなたのプロジェクトに以下のようにして加えることができます。<p>このプラグインは <a href="./create-a-new-react-app.html#create-react-app">Create React App</a> ではデフォルトで含まれています。<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> eslint-plugin-react-hooks --save-dev</code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Your ESLint configuration</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">"plugins"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// ...</span>
    <span class="token string">"react-hooks"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"rules"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token string-property property">"react-hooks/rules-of-hooks"</span><span class="token operator">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token comment">// Checks rules of Hooks</span>
    <span class="token string-property property">"react-hooks/exhaustive-deps"</span><span class="token operator">:</span> <span class="token string">"warn"</span> <span class="token comment">// Checks effect dependencies</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><strong>次のページまで飛ばして<a href="./hooks-custom.html">独自のフック</a>を書く方法について学んでも構いません。</strong>このページの続きの部分ではこれらのルールの背後にある根拠について述べていきます。</section><section id="explanation"class="level2"><h2>解説</h2><p><a href="./hooks-state.html#tip-using-multiple-state-variables">既に学んだ通り</a>、ひとつのコンポーネント内で複数の state や副作用を使うことができます。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. Use the name state variable</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>name<span class="token punctuation">,</span> setName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Mary'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. Use an effect for persisting the form</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">persistForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token dom variable">localStorage</span><span class="token punctuation">.</span><span class="token method function property-access">setItem</span><span class="token punctuation">(</span><span class="token string">'formData'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 3. Use the surname state variable</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>surname<span class="token punctuation">,</span> setSurname<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Poppins'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. Use an effect for updating the title</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">updateTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> surname<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>では React は、どの <code>useState</code> の呼び出しがどの state に対応するのか、どうやって知るのでしょうか？ その答えは「<strong>React はフックが呼ばれる順番に依存している</strong>」です。我々の例が動作するのは、フックの呼び出しの順序が毎回のレンダーごとに同じだからです。<pre class="language-js"><code class="language-js"><span class="token comment">// ---------</span>
<span class="token comment">// First render</span>
<span class="token comment">// ---------</span>
<span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Mary'</span><span class="token punctuation">)</span>           <span class="token comment">// 1. Initialize the name state variable with 'Mary'</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span>persistForm<span class="token punctuation">)</span>     <span class="token comment">// 2. Add an effect for persisting the form</span>
<span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Poppins'</span><span class="token punctuation">)</span>        <span class="token comment">// 3. Initialize the surname state variable with 'Poppins'</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span>updateTitle<span class="token punctuation">)</span>     <span class="token comment">// 4. Add an effect for updating the title</span>

<span class="token comment">// ----------</span>
<span class="token comment">// Second render</span>
<span class="token comment">// ----------</span>
<span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Mary'</span><span class="token punctuation">)</span>           <span class="token comment">// 1. Read the name state variable (argument is ignored)</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span>persistForm<span class="token punctuation">)</span>     <span class="token comment">// 2. Replace the effect for persisting the form</span>
<span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Poppins'</span><span class="token punctuation">)</span>        <span class="token comment">// 3. Read the surname state variable (argument is ignored)</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span>updateTitle<span class="token punctuation">)</span>     <span class="token comment">// 4. Replace the effect for updating the title</span>

<span class="token comment">// ...</span></code></pre><p>フックへの呼び出しの順番がレンダー間で変わらない限り、React はそれらのフックにローカル state を割り当てることができます。ですがフックの呼び出しを条件分岐内（例えば <code>persistForm</code> 副作用の内部で）で行ったらどうなるでしょうか？<pre class="language-js"><code class="language-js">  <span class="token comment">// 🔴 We're breaking the first rule by using a Hook in a condition</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">persistForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token dom variable">localStorage</span><span class="token punctuation">.</span><span class="token method function property-access">setItem</span><span class="token punctuation">(</span><span class="token string">'formData'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre><p><code>name !== ''</code> という条件は初回のレンダー時には <code>true</code> なので、フックは実行されます。しかし次回のレンダー時にはユーザがフォームをクリアしているかもしれず、その場合にこの条件は <code>false</code> になります。するとレンダー途中でこのフックがスキップされるため、フックの呼ばれる順番が変わってしまいます。<pre class="language-js"><code class="language-js"><span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Mary'</span><span class="token punctuation">)</span>           <span class="token comment">// 1. Read the name state variable (argument is ignored)</span>
<span class="token comment">// useEffect(persistForm)  // 🔴 This Hook was skipped!</span>
<span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Poppins'</span><span class="token punctuation">)</span>        <span class="token comment">// 🔴 2 (but was 3). Fail to read the surname state variable</span>
<span class="token function">useEffect</span><span class="token punctuation">(</span>updateTitle<span class="token punctuation">)</span>     <span class="token comment">// 🔴 3 (but was 4). Fail to replace the effect</span></code></pre><p>React は 2 つ目の <code>useState</code> の呼び出しに対して何を返せばいいのか分からなくなります。React は 2 つめのフックの呼び出しは前回レンダー時と同様に <code>persistForm</code> に対応するものだと期待しているのですが、それが成り立たなくなっています。この部分より先では、スキップされたもの以降のすべてのフックがひとつずつずれているため、バグを引き起こします。<p><strong>これがフックを呼び出すのがトップレベルのみでなければならない理由です。</strong>条件付きで副作用を走らせたい場合は、その条件をフックの<em>内部</em>に入れることができます：<pre class="language-js"><code class="language-js">  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">persistForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 👍 We're not breaking the first rule anymore</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>name <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token dom variable">localStorage</span><span class="token punctuation">.</span><span class="token method function property-access">setItem</span><span class="token punctuation">(</span><span class="token string">'formData'</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong><a href="https://www.npmjs.com/package/eslint-plugin-react-hooks">上記の lint ルール</a>を使えばこの問題について心配する必要はない、ということに注意してください。</strong>しかしフックが<em>なぜ</em>このように動作するのか、このルールがどんな問題を防いでいるのかについて学びました。</section><section id="next-steps"class="level2"><h2>次のステップ</h2><p>ついに<a href="./hooks-custom.html">自分独自のフックの書き方</a>について学ぶ準備ができました！ カスタムフックを使えば React から提供されるフックを組み合わせて自分独自の抽象化を作り出し、複数の異なるコンポーネント間で state を使う共通のロジックを再利用することができるようになります。 <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>