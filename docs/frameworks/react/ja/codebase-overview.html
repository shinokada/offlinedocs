<!doctypehtml><html lang="ja"><meta charset="utf-8"><title>コードベースの概要</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css"><section id="コードベースの概要"class="level1"><h1>コードベースの概要</h1><p>このセクションでは React コードベースの構成や規則そして実装についての概要を説明します。<p>あなたが <a href="./how-to-contribute.html">React にコントリビュート</a>したい場合に、このガイドがあなたがより快適に変更を行えるように手助けとなる事を願っています。<p>これらの規約のいずれかをあなたの React アプリケーションで推奨しているというわけでは必ずしもありません。規約の多くは歴史的な理由で存在しており、時間とともに変化する可能性があります。<section id="top-level-folders"class="level3"><h3>最上位フォルダ</h3><p><a href="https://github.com/facebook/react">React リポジトリ</a>をクローンした後、プロジェクトのルートディレクトリに複数のフォルダがあることに気がつくでしょう：<ul><li><a href="https://github.com/facebook/react/tree/main/packages"><code>packages</code></a> には React リポジトリの全てのパッケージのメタデータ（<code>package.json</code> など）や、ソースコード（<code>src</code> サブディレクトリ）が含まれています。<strong>あなたの変更がコードに関するものなら、各パッケージの <code>src</code> サブディレクトリが作業時間のほとんどを過ごす場所となります</strong>。<li><a href="https://github.com/facebook/react/tree/main/fixtures"><code>fixtures</code></a> にはコントリビューター向けの React の小さなテスト用アプリケーションが含まれています。<li><code>build</code> は React のビルド出力です。リポジトリには存在しませんが、最初に <a href="./how-to-contribute.html#development-workflow">React をビルドした</a>後に clone した React ディレクトリに現れます。</ul><p>ドキュメントは <a href="https://github.com/reactjs/reactjs.org">React 本体とは異なるリポジトリ</a>にホスティングされています。<p>他にも最上位にあるフォルダがありますが、ほとんどはツールが使用するためのもので、コントリビュートする場合にそれらに直面することはほぼありません。</section><section id="colocated-tests"class="level3"><h3>テストコードをソースコードのそばに格納する</h3><p>ユニットテスト用の最上位ディレクトリはありません。代わりに、テスト対象のファイルのすぐ隣の <code>__tests__</code> というディレクトリに置いています。<p>例えば、<a href="https://github.com/facebook/react/blob/87724bd87506325fcaf2648c70fc1f43411a87be/src/renderers/dom/client/utils/setInnerHTML.js"><code>setInnerHTML.js</code></a> のテストは、すぐ隣の <a href="https://github.com/facebook/react/blob/87724bd87506325fcaf2648c70fc1f43411a87be/src/renderers/dom/client/utils/__tests__/setInnerHTML-test.js"><code>__tests__/setInnerHTML-test.js</code></a> にあります。</section><section id="warnings-and-invariants"class="level3"><h3>警告と不変数 (Invariant)</h3><p>React のコードベースは警告の表示に <code>console.error</code> を使用しています：<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">'Something is wrong.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>警告は開発時にのみ有効になります。本番時には警告は完全に取り除かれます。コードの一部の実行を禁止する必要がある場合は、代わりに <code>invariant</code> モジュールを使用してください：<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> invariant <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'invariant'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">invariant</span><span class="token punctuation">(</span>
  <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">===</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token string">'You shall not pass!'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>invariant は <code>invariant</code> 内の条件が <code>false</code> のときスローされます。</strong><p>"Invariant" とは "この条件は常に true である" ということの単なる言い換えです。アサーションを作成していると考えることができます。<p>開発バージョンと本番バージョンで同じ動作となるようにしておく事は重要ですので、<code>invariant</code> は両方の環境でスローされます。本番バージョンではエラーメッセージは自動的にエラーコードに変換され、バイト数に悪影響が出ることを避けます。</section><section id="development-and-production"class="level3"><h3>開発バージョンと本番バージョン</h3><p>コードベース内で <code>__DEV__</code> 擬似グローバル変数を使用して、開発用のコードブロックを保護することができます。<p>コンパイル時にインライン化され、CommonJS のビルド時には <code>process.env.NODE_ENV !== 'production'</code> というチェックに変換されます。<p>スタンドアロンなビルドにおいては、minify されないビルドでは <code>true</code> となり、minify されたビルドではそれを囲む <code>if</code> ブロックごと完全に除去されます。<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// This code will only run in development.</span>
<span class="token punctuation">}</span></code></pre></section><section id="flow"class="level3"><h3>Flow</h3><p>最近私たちはコードベースに <a href="https://flow.org/">Flow</a> によるチェックを導入し始めました。ライセンスヘッダで <code>@flow</code> アノテーションがマークされているファイルは型チェックをされています。<p><a href="https://github.com/facebook/react/pull/7600/files">既存のコードに Flow アノテーションを追加する</a>プルリクエストを受けつけています。Flow アノテーションは以下のようになります：<pre class="language-js"><code class="language-js"><span class="token maybe-class-name">ReactRef</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">detachRefs</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">instance</span><span class="token operator">:</span> <span class="token maybe-class-name">ReactInstance</span><span class="token punctuation">,</span>
  <span class="token literal-property property">element</span><span class="token operator">:</span> <span class="token maybe-class-name">ReactElement</span> <span class="token operator">|</span> string <span class="token operator">|</span> number <span class="token operator">|</span> <span class="token keyword null nil">null</span> <span class="token operator">|</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>可能であれば、新しいコードは Flow アノテーションを使うべきです。 <code>yarn flow</code> を実行することでローカル環境で Flow を使ってコードをチェックできます。</section><section id="multiple-packages"class="level3"><h3>複数のパッケージ</h3><p>React は<a href="http://danluu.com/monorepo/">単一リポジトリ (monorepo)</a> です。そのリポジトリには複数の別々のパッケージが含まれているので、それらの変更はまとめて調整でき、issue も 1 箇所にまとまっています。</section><section id="react-core"class="level3"><h3>React コア (core)</h3><p>React の「コア (core)」は<a href="./react-api.html#react">最上位の React API</a> を全て含んでいます。例えば：<ul><li><code>React.createElement()</code><li><code>React.Component</code><li><code>React.Children</code></ul><p><strong>React core にはコンポーネントの定義に必要な API のみが含まれています。</strong><a href="./reconciliation.html">リコンシリエーション</a>のアルゴリズムやあらゆるプラットフォーム固有のコードは含まれません。コアは React DOM や React Native コンポーネントに使われています。<p>React core のコードはソースツリーの <a href="https://github.com/facebook/react/tree/main/packages/react"><code>packages/react</code></a> に格納されています。npm では <a href="https://www.npmjs.com/package/react"><code>react</code></a> パッケージとして利用可能です。対応するスタンドアロンなブラウザ向けのビルドは <code>react.js</code> と呼ばれ、<code>React</code> というグローバル変数をエクスポートします。</section><section id="renderers"class="level3"><h3>レンダラ</h3><p>React は元々 DOM のために作成されましたが、後になって <a href="https://reactnative.dev/">React Native</a> によりネイティブなプラットフォームもサポートするようになりました。これにより React の内部に "レンダラ (renderer)" の概念が導入されました。<p><strong>レンダラは React ツリーを、基盤となるプラットフォーム固有の呼び出しへと変換する方法を管理します。</strong><p>レンダラは <a href="https://github.com/facebook/react/tree/main/packages/"><code>packages/</code></a> にも格納されています：<ul><li><a href="https://github.com/facebook/react/tree/main/packages/react-dom">React DOM Renderer</a> は React コンポーネントを DOM に変換します。<a href="./react-dom.html">トップレベルの <code>ReactDOM</code> API</a> を実装し、npm では <a href="https://www.npmjs.com/package/react-dom"><code>react-dom</code></a> パッケージとして利用可能です。<code>react-dom.js</code> と呼ばれるスタンドアロンなブラウザ向けバンドルとしても使用でき、<code>ReactDOM</code> というグローバル変数をエクスポートします。<li><a href="https://github.com/facebook/react/tree/main/packages/react-native-renderer">React Native Renderer</a> は React コンポーネントをネイティブのビューに変換します。React Native の内部で使われています。<li><a href="https://github.com/facebook/react/tree/main/packages/react-test-renderer">React Test Renderer</a> は React コンポーネントを JSON ツリーに変換します。<a href="https://facebook.github.io/jest">Jest</a> の<a href="https://facebook.github.io/jest/blog/2016/07/27/jest-14.html">スナップショットテスト機能</a>で使用され、npm では <a href="https://www.npmjs.com/package/react-test-renderer">react-test-renderer</a> パッケージとして利用可能です。</ul><p>その他に公式にサポートしているレンダラは <a href="https://github.com/facebook/react/tree/main/packages/react-art"><code>react-art</code></a> だけです。個別の <a href="https://github.com/reactjs/react-art">GitHub リポジトリ</a>にありましたが、現在はメインのソースツリーに移動しました。<blockquote><p><strong>補足：</strong><p>技術的に、<a href="https://github.com/facebook/react/tree/main/packages/react-native-renderer"><code>react-native-renderer</code></a> は React に React Native の実装とやり取りの方法を教える非常に薄い層です。ネイティブのビューを管理する実際のプラットフォーム固有のコードは、コンポーネントと共に <a href="https://github.com/facebook/react-native">React Native リポジトリ</a> にあります。</blockquote></section><section id="reconcilers"class="level3"><h3>リコンサイラ (reconciler)</h3><p>React DOM と React Native のように大幅に異なるレンダラでも多くのロジックを共有する必要があります。特に、ツリーの<a href="./reconciliation.html">リコンシリエーション</a>のアルゴリズムは可能なかぎり同じものにして、宣言型レンダリング、独自コンポーネント、state、ライフサイクルメソッドおよび ref がプラットフォーム間で一貫した動作となるようにするべきです。<p>異なるレンダラ間でコードの一部を共有することでこの課題を解決します。React のこの箇所を "リコンサイラ（reconciler, 差分検出処理）" と呼んでいます。<code>setState()</code> のような更新がスケジュールされると、差分検出処理ではツリー内のコンポーネントで <code>render()</code> を呼び出して、コンポーネントをマウント、更新、もしくはアンマウントします。<p>リコンサイラは、パブリック API がないため、個別にパッケージ化されていません。代わりに、それらは React DOM や React Native などのレンダラーによってのみ使用されます。</section><section id="stack-reconciler"class="level3"><h3>スタック (stack) リコンサイラ</h3><p>"stack" リコンサイラは React 15 およびそれ以前で実装されています。それ以降は使用されていませんが、<a href="./implementation-notes.html">次のセクション</a>では詳細に説明されています。</section><section id="fiber-reconciler"class="level3"><h3>Fiber リコンサイラ</h3><p>"fiber" リコンサイラは stack リコンサイラが内在的に抱える問題を解決し、いくつかの長年の問題を修正することを目的とした新しい取り組みです。React 16 以降はデフォルトのリコンサイラとなっています。<p>主な目的は以下の通りです：<ul><li>中断可能な作業を小分けに分割する機能<li>進行中の作業に優先順位を付けたり、再配置や再利用をする機能<li>React でレイアウトをサポートするための親子間を行き来しながらレンダーする機能<li>render() から複数の要素を返す機能<li>error boundary のサポートの向上</ul><p>React Fiber のアーキテクチャに関して<a href="https://github.com/acdlite/react-fiber-architecture">ここ</a>や<a href="https://blog.ag-grid.com/inside-fiber-an-in-depth-overview-of-the-new-reconciliation-algorithm-in-react">ここ</a>で読むことができます。React 16 と共にリリースされていますが、非同期機能についてはデフォルトではまだ有効化されていません。<p>ソースコードは <a href="https://github.com/facebook/react/tree/main/packages/react-reconciler"><code>packages/react-reconciler</code></a> に格納されています。</section><section id="event-system"class="level3"><h3>イベントシステム</h3><p>React はブラウザ間でのイベント挙動の差異を吸収するため、ネイティブイベントの上にレイヤーを実装しています。ソースコードは <a href="https://github.com/facebook/react/tree/main/packages/react-dom/src/events"><code>packages/react-dom/src/events</code></a> にあります。</section><section id="what-next"class="level3"><h3>この次は？</h3><p>React 16 以前のリコンサイラについてより詳細に学ぶには<a href="./implementation-notes.html">次のセクション</a>を読んでください。新しいリコンサイラの内部についてはまだドキュメント化していません。 <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>