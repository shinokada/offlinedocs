<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>ステートフックの利用法</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css">
  </head>
  <body>
    <section id="ステートフックの利用法" class="level1">
      <h1>ステートフックの利用法</h1>
      <p><em>フック (hook)</em> は React 16.8 で追加された新機能です。state などの React の機能を、クラスを書かずに使えるようになります。</p>
      <p><a href="./hooks-intro.html">フックの導入のページ</a>で以下の例を挙げてフックの紹介を行いました：</p>
      <pre class="language-js{4-5}"><code class="language-js{4-5}">import React, { useState } from 'react';

function Example() {
  // Declare a new state variable, which we'll call "count"
  const [count, setCount] = useState(0);

  return (
    &#x3C;div>
      &#x3C;p>You clicked {count} times&#x3C;/p>
      &#x3C;button onClick={() => setCount(count + 1)}>
        Click me
      &#x3C;/button>
    &#x3C;/div>
  );
}</code></pre>
      <p>このコードをクラスによる等価版と比較しながらフックについて学び始めましょう。</p>
      <section id="equivalent-class-example" class="level2">
        <h2>クラスによる同等の例</h2>
        <p>以前 React でクラスを使っていたなら、このコードに馴染みがあるでしょう。</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">Example</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">You</span> clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span> times<span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token maybe-class-name">Click</span> me
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
        <p>state は <code>{ count: 0 }</code> から始まり、ユーザがボタンをクリックした時に <code>this.setState()</code> を呼ぶことで <code>state.count</code> をインクリメントします。このページの全体にわたってこのクラスからの例が出てきます。</p>
        <blockquote>
          <p>補足</p>
          <p>もっと現実的な例ではなくカウンタを使っているのはなぜか気になるかもしれません。フックについての第一歩の説明ですので API にフォーカスするためです。</p>
        </blockquote>
      </section>
      <section id="hooks-and-function-components" class="level2">
        <h2>フックと関数コンポーネント</h2>
        <p>念のため、React の関数コンポーネントとはこのようなものです：</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Example</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// You can use Hooks here!</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>あるいはこのようなものです：</p>
        <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Example</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// You can use Hooks here!</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
        <p>これらのことを「ステートレスコンポーネント (stateless component)」だと理解していたかもしれません。今からこれらの内部で React の state を利用できるようにしているので、「関数コンポーネント (function component)」という名前を使用しましょう。</p>
        <p>フックはクラスの内部では動作<strong>しません</strong>。クラスを書く代わりに使うものです。</p>
      </section>
      <section id="whats-a-hook" class="level2">
        <h2>フックとは何か？</h2>
        <p>この新しい例では、React から <code>useState</code> をインポートするところから始めましょう。</p>
        <pre class="language-js{1}"><code class="language-js{1}">import React, { useState } from 'react';

function Example() {
  // ...
}</code></pre>
        <p><strong>フックとは何？</strong> フックとは React の機能に「接続 (hook into)」するための特別な関数です。例えば <code>useState</code> によって React の state の機能を関数コンポーネントに追加できます。他のフックについても後で学びます。</p>
        <p><strong>フックをいつ使うべき？</strong> 関数コンポーネントを書いていて state が必要だと気付いた場合、これまではコンポーネントをクラスに変換する必要がありました。今後は、既に書いた関数コンポーネントの中でフックを使うことができます。早速やってみましょう！</p>
        <blockquote>
          <p>補足：</p>
          <p>コンポーネント内のどこでフックが使えてどこで使えないかに関する特別なルールがあります。これについては<a href="./hooks-rules.html">フックのルール</a>で学びます。</p>
        </blockquote>
      </section>
      <section id="declaring-a-state-variable" class="level2">
        <h2>state 変数の宣言</h2>
        <p>クラスでは、コンストラクタ内で <code>this.state</code> を <code>{ count: 0 }</code> にセットするという方法で、state である <code>count</code> を <code>0</code> へと初期化します。</p>
        <pre class="language-js{4-6}"><code class="language-js{4-6}">class Example extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      count: 0
    };
  }</code></pre>
        <p>関数コンポーネントには <code>this</code> は存在しませんので、<code>this.state</code> を読み書きすることはできません。その代わりに、コンポーネントの内部で直接 <code>useState</code> フックを使いましょう。</p>
        <pre class="language-js{4,5}"><code class="language-js{4,5}">import React, { useState } from 'react';

function Example() {
  // Declare a new state variable, which we'll call "count"
  const [count, setCount] = useState(0);</code></pre>
        <p><strong><code>useState</code> を呼ぶと何が起きるの？</strong> これにより『state 変数』が宣言されます。我々の例では変数を <code>count</code> と名付けましたが、<code>banana</code> でも何でも好きな名前にすることができます。これが関数コールの間で値を『保持』しておくための方法です ― <code>useState</code> は、クラスにおいて <code>this.state</code> が提供するのと全く同じ機能を実現するための新しい方法です。通常、関数が終了すると変数は『消えて』しまいますが、state 変数は React によって保持されます。</p>
        <p><strong>引数として <code>useState</code> に何を渡すのか？</strong> <code>useState()</code> フックの唯一の引数は state の初期値です。クラスの場合とは異なり、state はオブジェクトである必要はありません。数字や文字列が欲しいだけであればそれらを保持することができます。我々の例ではユーザがクリックした回数に対応する数字が欲しいだけですので、<code>0</code> を state 変数の初期値として渡します（もし違う値を保持したい場合は <code>useState()</code> を 2 回呼ぶことになります）。</p>
        <p><strong><code>useState</code> は何を返すのか？</strong> 現在の state と、それを更新するための関数とを、ペアにして返します。これが <code>const [count, setCount] = useState()</code> という書き方をした理由です。これはクラスにおける <code>this.state.count</code> と <code>this.setState</code> に似ていますが、それをペアとして手に入れる点が異なります。もしもここで使った構文になじみがない場合は、<a href="./hooks-state.html#tip-what-do-square-brackets-mean">このページの下部</a>で改めて説明します。</p>
        <p><code>useState</code> が何をやるのかが分かったので、最初の例の意味がより分かりやすくなりました：</p>
        <pre class="language-js{4,5}"><code class="language-js{4,5}">import React, { useState } from 'react';

function Example() {
  // Declare a new state variable, which we'll call "count"
  const [count, setCount] = useState(0);</code></pre>
        <p><code>count</code> という名前の state 変数を宣言しており、それを <code>0</code> にセットします。再レンダー間で React はその変数の現在値を記憶しており、最新の値を関数に渡します。現在の <code>count</code> の値を更新したい場合は、<code>setCount</code> を呼ぶことができます。</p>
        <blockquote>
          <p>補足</p>
          <p>どうして <code>createState</code> ではなく <code>useState</code> という名前なのか気になるでしょうか？</p>
          <p>state が「作成」されるのはコンポーネントの初回レンダー時だけですので、<code>createState</code> という名前はあまり正確ではありません。次回以降のレンダー時には、<code>useState</code> からは既存の state の現在値を受け取ります。毎回作成していたのではそもそも「状態」になりませんね。また、フックの名前が<em>常に</em> <code>use</code> から始まることには理由があります。<a href="./hooks-rules.html">フックのルール</a>で改めて説明します。</p>
        </blockquote>
      </section>
      <section id="reading-state" class="level2">
        <h2>state の読み出し</h2>
        <p>クラス内で現在のカウント値を表示したい場合、<code>this.state.count</code> を読み出します：</p>
        <pre class="language-js"><code class="language-js">  <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">You</span> clicked <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span> times<span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span></code></pre>
        <p>関数内では、直接 <code>count</code> を使うことができます：</p>
        <pre class="language-js"><code class="language-js">  <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">You</span> clicked <span class="token punctuation">{</span>count<span class="token punctuation">}</span> times<span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span></code></pre>
      </section>
      <section id="updating-state" class="level2">
        <h2>state の更新</h2>
        <p>クラスでは、<code>this.setState()</code> を呼ぶことで <code>count</code> ステートを更新します：</p>
        <pre class="language-js{1}"><code class="language-js{1}">  &#x3C;button onClick={() => this.setState({ count: this.state.count + 1 })}>
    Click me
  &#x3C;/button></code></pre>
        <p>関数内では、すでに <code>setCount</code> と <code>count</code> を変数として受け取っていますので、<code>this</code> は必要ありません：</p>
        <pre class="language-js{1}"><code class="language-js{1}">  &#x3C;button onClick={() => setCount(count + 1)}>
    Click me
  &#x3C;/button></code></pre>
      </section>
      <section id="recap" class="level2">
        <h2>まとめ</h2>
        <p>では<strong>これまで学んだことを 1 行ずつまとめて</strong>、理解を確認しましょう。</p><!--
          I'm not proud of this line markup. Please somebody fix this.
          But if GitHub got away with it for years we can cheat.
        -->
        <pre class="language-js{1,4,9}"><code class="language-js{1,4,9}"> 1:  import React, { useState } from 'react';
 2:
 3:  function Example() {
 4:    const [count, setCount] = useState(0);
 5:
 6:    return (
 7:      &#x3C;div>
 8:        &#x3C;p>You clicked {count} times&#x3C;/p>
 9:        &#x3C;button onClick={() => setCount(count + 1)}>
10:         Click me
11:        &#x3C;/button>
12:      &#x3C;/div>
13:    );
14:  }</code></pre>
        <ul>
          <li><strong>1 行目：</strong> <code>useState</code> フックを React からインポートします。これにより関数コンポーネント内でローカル state が使えるようにになります。</li>
          <li><strong>4 行目：</strong> <code>Example</code> コンポーネント内で <code>useState</code> フックを呼び出すことで新しい state 変数を宣言します。2 つの値のペアが返されるので、それらに名前を与えます。ボタンのクリック回数を保持するための変数ですので <code>count</code> と名付けましょう。<code>useState</code> 唯一の引数として <code>0</code> を渡すことで、変数をゼロへと初期化します。返り値の 2 つ目はそれ自体が関数です。これにより <code>count</code> を更新するので、<code>setCount</code> という名前にします。</li>
          <li><strong>9 行目：</strong> ユーザがクリックした時に、新しい値で <code>setCount</code> を呼びます。React は <code>Example</code> コンポーネントを再レンダーし、その際には新たな <code>count</code> の値を渡します。</li>
        </ul>
        <p>最初は飲み込むのに時間がかかるかもしれません。急がないようにしましょう！ 途中で分からなくなった場合は上記のコードを最初から最後まで読み直してください。一旦クラスで state がどう動くのかを「忘れて」新鮮な目でこのコードを見るようにすれば、必ず理解できるようになるはずです。</p>
        <section id="tip-what-do-square-brackets-mean" class="level3">
          <h3>ヒント：この角カッコの意味は？</h3>
          <p>state 変数を宣言するときのこの角カッコに気付かれたでしょうか：</p>
          <pre class="language-js"><code class="language-js">  <span class="token keyword">const</span> <span class="token punctuation">[</span>count<span class="token punctuation">,</span> setCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p>左辺に書かれている名前は、React の API の一部ではありません。state 変数には好きな名前を付けることができます：</p>
          <pre class="language-js"><code class="language-js">  <span class="token keyword">const</span> <span class="token punctuation">[</span>fruit<span class="token punctuation">,</span> setFruit<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p>この JavaScript の構文は <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#Array_destructuring">"分割代入 (destructuring)"</a> と呼ばれています。これが意味するところは、<code>fruit</code> と <code>setFruit</code> という名前の 2 つの変数を作って、<code>useState</code> から返される値のうち 1 つ目を <code>fruit</code> に、2 つ目を <code>setFruit</code> に代入する、ということです。これは以下のコードと等価です：</p>
          <pre class="language-js"><code class="language-js">  <span class="token keyword">var</span> fruitStateVariable <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Returns a pair</span>
  <span class="token keyword">var</span> fruit <span class="token operator">=</span> fruitStateVariable<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// First item in a pair</span>
  <span class="token keyword">var</span> setFruit <span class="token operator">=</span> fruitStateVariable<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// Second item in a pair</span></code></pre>
          <p><code>useState</code> で state 変数を宣言する際、ペア、つまり 2 つの要素を含んだ配列が返されます。1 つ目の要素は state の現在の値、2 つ目の要素はそれを更新するための関数です。これらには特定の意味があるので、アクセスするのに <code>[0]</code> や <code>[1]</code> を使うのではちょっと分かりづらくなります。だから代わりに分割代入を使うというわけです。</p>
          <blockquote>
            <p>補足</p>
            <p>React に対して <code>this</code> のようなものを一切渡していないので、どのようにコンポーネントと <code>useState</code> の呼び出しの対応を知るのか不思議に思うかもしれません。FAQ セクションで、<a href="./hooks-faq.html#how-does-react-associate-hook-calls-with-components">この質問</a>およびその他の疑問についてお答えしています。</p>
          </blockquote>
        </section>
        <section id="tip-using-multiple-state-variables" class="level3">
          <h3>ヒント：複数の state 変数を使う</h3>
          <p>state 変数の宣言を <code>[something, setSomething]</code> のペアの形で行うのが便利であるもうひとつの理由は、state 変数を複数使いたくなった場合にそれらに<em>異なる</em>名前をつけることができるからです：</p>
          <pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ExampleWithManyStates</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Declare multiple state variables!</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>age<span class="token punctuation">,</span> setAge<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>fruit<span class="token punctuation">,</span> setFruit<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'banana'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>todos<span class="token punctuation">,</span> setTodos<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Learn Hooks'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
          <p>上記の例では、ローカル変数として <code>age</code>、<code>fruit</code>、<code>todos</code> があり、それぞれを個別に更新することができます。</p>
          <pre class="language-js"><code class="language-js">  <span class="token keyword">function</span> <span class="token function">handleOrangeClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Similar to this.setState({ fruit: 'orange' })</span>
    <span class="token function">setFruit</span><span class="token punctuation">(</span><span class="token string">'orange'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span></code></pre>
          <p>たくさんの state 変数を使う<strong>必要は</strong>ありません。state 変数はオブジェクトや配列も何ら問題なく保持できますので、関連する値をいっしょにまとめておくこともできます。しかしクラスでの <code>this.setState</code> とは異なり、state 変数の更新は、マージではなく必ず古い値を<em>置換</em>します。</p>
          <p>独立した state 変数を分割する際の推奨事項については <a href="./hooks-faq.html#should-i-use-one-or-many-state-variables">FAQ で</a>詳しく述べています。</p>
        </section>
      </section>
      <section id="next-steps" class="level2">
        <h2>次のステップ</h2>
        <p>このページでは React によって提供されるフックのうちのひとつである <code>useState</code> について学びました。これからは「ステートフック」という名前でも呼ぶことにします。ステートフックによって、React の歴史上はじめて、React の関数コンポーネントにローカル state を加えることができます！</p>
        <p>またフックが一体何なのかについても少々学びました。フックとは関数コンポーネント内から React の機能に「接続する (hook into)」ための関数のことです。フックの名前は必ず <code>use</code> から始まり、他にもまだ説明していない様々なフックがあります。</p>
        <p>
          <strong>それでは<a href="./hooks-effect.html">次のフックである <code>useEffect</code> について学びましょう。</a></strong>これらはクラスにおけるライフサイクルメソッドと似ており、コンポーネント内で副作用を実行することができるようにするものです。
          <span style="float: footnote;"><a href="./index.html#toc">Go to TOC</a></span>
        </p>
      </section>
    </section>
  </body>
</html>
