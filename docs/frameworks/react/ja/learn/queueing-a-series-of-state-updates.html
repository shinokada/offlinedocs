<!doctype html><html lang="ja"><meta charset="utf-8"><title>一連の state の更新をキューに入れる</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="一連の-state-の更新をキューに入れる"><h1 id="一連の-state-の更新をキューに入れる">一連の state の更新をキューに入れる</h1><intro><p>state 変数をセットすることで、新しいレンダーがキューに予約されます。しかし、次のレンダーをキューに入れる前に、state の値に対して複数の操作を行いたい場合があります。そのためには、React が state の更新をバッチ処理（batching, 一括処理）する方法についての理解が役に立ちます。</p></intro><youwilllearn><ul><li>「バッチ処理」とは何か、React が複数の state 更新を処理する際にどのように使用されるのか<li>同じ state 変数に対し連続して複数の更新を適用する方法</ul></youwilllearn><section class="level2"aria-labelledby="react-は-state-更新をまとめて処理する-react-batches-state-updates"><h2 id="react-は-state-更新をまとめて処理する-react-batches-state-updates">React は state 更新をまとめて処理する {/<em>react-batches-state-updates</em>/}</h2><p>以下で "+3" ボタンをクリックした場合、<code>setNumber(number + 1)</code> を 3 回呼び出しているので、カウンタが 3 回インクリメントされると思うかもしれません。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>しかし、前のセクションで説明したように、<a href="/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time">個々のレンダー内の state 値は固定です</a>。従って <code>setNumber(1)</code> を何度呼び出しても、最初のレンダー内ではイベントハンドラ内の <code>number</code> の値は常に <code>0</code> です。<pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>しかしながら、ここにもう 1 つ別の要素が関わってきます。<strong>イベントハンドラ内のすべてのコードが実行されるまで、React は state の更新処理を待機します</strong>。このため、再レンダーはこれらの <code>setNumber()</code> 呼び出しがすべて終わった後で行われます。<p>レストランで注文を取るウェイターの話を思い出すかもしれません。ウェイターは最初の料理の注文を聞いた瞬間にキッチンにかけこむわけではありません！ 代わりに、客の注文を最後まで聞き、訂正がある場合はそれも聞き取り、さらにはテーブルの他の客からの注文もまとめて受け取るはずです。<p>&#x3C;Illustration src./docs/illustrations/i_react-batching.png" alt="レストランで何度も注文をしている客と、それを聞き取っているウェイター役の React。客が何度も setState() したとしても、ウェイターは最後のものだけを最終的な注文として聞き取って用紙に書き込む。" /><p>これにより、複数の state 変数（複数のコンポーネントからの場合も含む）の更新を、<a href="/learn/render-and-commit#re-renders-when-state-updates">再レンダー</a>の過剰なトリガなしに行うことができます。これは、イベントハンドラおよびその中のコードがすべて完了した<em>後</em>まで、UI は更新されないということでもあります。このような動作は<strong>バッチ処理</strong>（バッチング）とも呼ばれ、これにより React アプリの動作が格段に素早くなります。またこれは、変数のうち一部のみが更新された「中途半端な」レンダー結果に混乱させられずに済むということでもあります。<p><strong>React は、クリックのような意図的なイベントが<em>複数回</em>発生した場合、それらにまたがったバッチ処理までは行いません</strong>。各クリックは別々に処理されます。React は一般的に安全と判断される場合にのみバッチ処理を行いますので、安心してください。たとえば、最初のボタンクリックでフォームを無効にしたのであれば、2 度目のクリックでフォームが再び送信されてしまわないことが保証されます。</section><section class="level2"aria-labelledby="次のレンダー前に同じ-state-を複数回更新する-updating-the-same-state-multiple-times-before-the-next-render"><h2 id="次のレンダー前に同じ-state-を複数回更新する-updating-the-same-state-multiple-times-before-the-next-render">次のレンダー前に同じ state を複数回更新する {/<em>updating-the-same-state-multiple-times-before-the-next-render</em>/}</h2><p>一般的なユースケースではありませんが、次のレンダー前に同じ state 変数を複数回更新する場合、<code>setNumber(number + 1)</code> のようにして<em>次の state 値</em>を渡すのではなく、代わりに <code>setNumber(n => n + 1)</code> のようなキュー内のひとつ前の state に基づいて次の state を計算する<em>関数</em>を渡すことができます。これは、state の値を単に置き換えるのではなく、代わりに React に「その state の値に対してこのようにせよ」と伝えるための手段です。<p>このカウンタをインクリメントしてみてください。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>ここで、<code>n => n + 1</code> は<strong>更新用関数 (updater function)</strong> と呼ばれます。これを state のセッタに渡すと：<ol><li>React はこの関数をキューに入れて、イベントハンドラ内の他のコードがすべて実行された後に処理されるようにします。<li>次のレンダー中に、React はキューを処理し、最後に更新された state を返します。</ol><pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>以下に、イベントハンドラを実行するときに、React はこれらのコードをどのように処理するかを示します。<ol><li><code>setNumber(n => n + 1)</code>: <code>n => n + 1</code> は関数。React はこれをキューに追加する。<li><code>setNumber(n => n + 1)</code>: <code>n => n + 1</code> は関数。React はこれをキューに追加する。<li><code>setNumber(n => n + 1)</code>: <code>n => n + 1</code> は関数。React はこれをキューに追加する。</ol><p>次のレンダー中に <code>useState</code> が呼び出されると、React はこのキューを処理します。前回 <code>number</code> という state の値は <code>0</code> だったので、それがひとつ目の更新用関数の引数 <code>n</code> に渡されます。React はひとつ前の更新用関数の返り値を取得し、それを次の更新用関数の <code>n</code> に渡し、というように続いていきます：<table><thead><tr><th>キュー内の更新処理<th><code>n</code><th>返り値<tbody><tr><td><code>n => n + 1</code><td><code>0</code><td><code>0 + 1 = 1</code><tr><td><code>n => n + 1</code><td><code>1</code><td><code>1 + 1 = 2</code><tr><td><code>n => n + 1</code><td><code>2</code><td><code>2 + 1 = 3</code></table><p>React は <code>3</code> を最終結果として保存し、<code>useState</code> から返します。<p>このような理由で、上記の例で "+3" をクリックしたときに、値が正しく 3 ずつ増加するのです。 ### state を置き換えた後に更新するとどうなるか {/<em>what-happens-if-you-update-state-after-replacing-it</em>/}<p>では、このイベントハンドラはどうでしょうか？ 次回のレンダーで <code>number</code> の値はどうなっていると思いますか？<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Increase</span> the number<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>このイベントハンドラでは、React に次のように指示しています。<ol><li><code>setNumber(number + 5)</code>: <code>number</code> は <code>0</code> なので、<code>setNumber(0 + 5)</code>。React はキューに <em>"<code>5</code> に置き換えよ"</em> という命令を追加する。<li><code>setNumber(n => n + 1)</code>: <code>n => n + 1</code> は更新用関数。React は<em>その関数</em>をキューに追加する。</ol><p>次のレンダー時、React は state 更新キューを処理します。<table><thead><tr><th>キュー内の更新処理<th><code>n</code><th>返り値<tbody><tr><td>"<code>5</code> に置き換えよ"<td><code>0</code> (未使用)<td><code>5</code><tr><td><code>n => n + 1</code><td><code>5</code><td><code>5 + 1 = 6</code></table><p>React は <code>6</code> を最終結果として保存し、<code>useState</code> から返します。</p><note><p>お気づきかもしれませんが、<code>setState(5)</code> とは、実際には <code>n</code> の使用されない <code>setState(n => 5)</code> と同じように動作します！</p></note><section class="level3"aria-labelledby="state-を更新した後に置き換えるとどうなるか-what-happens-if-you-replace-state-after-updating-it"><h3 id="state-を更新した後に置き換えるとどうなるか-what-happens-if-you-replace-state-after-updating-it">state を更新した後に置き換えるとどうなるか {/<em>what-happens-if-you-replace-state-after-updating-it</em>/}</h3><p>もうひとつ別の例を試してみましょう。次回のレンダーで <code>number</code> は何になると思いますか？<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span></code></pre><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token parameter">n</span> <span class="token arrow operator">=></span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Increase</span> the number<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>このイベントハンドラを実行する際、React は以下の順番でコードを処理します。<ol><li><code>setNumber(number + 5)</code>: <code>number</code> は <code>0</code> なので <code>setNumber(0 + 5)</code>。React はキューに <em>"<code>5</code> に置き換えよ"</em> という命令を追加する。<li><code>setNumber(n => n + 1)</code>: <code>n => n + 1</code> は更新用関数。React は<em>その関数</em>をキューに追加する。<li><code>setNumber(42)</code>: React はキューに <em>"<code>42</code> に置き換えよ"</em> という命令を追加する。</ol><p>次のレンダー中に、React は state 更新キューを処理します。<table><thead><tr><th>キュー内の更新処理<th><code>n</code><th>返り値<tbody><tr><td>"<code>5</code> に置き換えよ"<td><code>0</code> （未使用）<td><code>5</code><tr><td><code>n => n + 1</code><td><code>5</code><td><code>5 + 1 = 6</code><tr><td>"<code>42</code> に置き換えよ"<td><code>6</code> （未使用）<td><code>42</code></table><p>というわけで、React は最終結果として <code>42</code> を保存し、<code>useState</code> から返します。<p>まとめると、<code>setNumber</code> という state セッタに渡すものを、以下のように考えることができます。<ul><li><strong>更新用関数</strong>（例：<code>n => n + 1</code>）の場合、それがキューに追加されます。<li><strong>それ以外の値</strong>（例：数値 <code>5</code>）の場合、ここまでのキューの内容を無視する "<code>5</code> に置き換えよ" のような命令を追加します。</ul><p>イベントハンドラが完了した後、React は再レンダーをトリガします。再レンダー中に React はキューを処理します。更新用関数はレンダー中に実行されるため、<strong>更新用関数は<a href="/learn/keeping-components-pure">純関数</a>である必要があり</strong>、結果だけを<em>返す</em>ようにする必要があります。その中で state をセットしたり、他の副作用を実行したりしないでください。Strict Mode では、React は各更新用関数を 2 回実行します（ただし 2 つ目の結果は破棄されます）が、これによって間違いを見つけやすくなります。</section><section class="level3"aria-labelledby="命名規則-naming-conventions"><h3 id="命名規則-naming-conventions">命名規則 {/<em>naming-conventions</em>/}</h3><p>対応する state 変数の頭文字を使って更新用関数の引数の名前を付けることが一般的です。<pre class="language-js"><code class="language-js"><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setLastName</span><span class="token punctuation">(</span><span class="token parameter">ln</span> <span class="token arrow operator">=></span> ln<span class="token punctuation">.</span><span class="token method function property-access">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setFriendCount</span><span class="token punctuation">(</span><span class="token parameter">fc</span> <span class="token arrow operator">=></span> fc <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>もっと長いコードが好きな場合、別の一般的な慣習としては、<code>setEnabled(enabled => !enabled)</code> のように完全な state 変数名を繰り返すか、<code>setEnabled(prevEnabled => !prevEnabled)</code> のようなプレフィックスを使用することがあります。</p><recap><ul><li>state をセットしても既存のレンダーの変数は変更されず、代わりに新しいレンダーが要求される。<li>React は、イベントハンドラが完了してから state の更新を処理する。これをバッチ処理と呼ぶ。<li>1 つのイベントで複数回 state を更新したい場合 <code>setNumber(n => n + 1)</code> という形の更新用関数を使用できる。</ul></recap><challenges><section class="level4"aria-labelledby="リクエストカウンタの修正-fix-a-request-counter"><h4 id="リクエストカウンタの修正-fix-a-request-counter">リクエストカウンタの修正 {/<em>fix-a-request-counter</em>/}</h4><p>あなたは、ユーザが美術品に対して複数の注文処理を同時並行で行える、アートマーケットアプリの開発をしています。ユーザが "Buy" ボタンを押すたびに、"Pending"（処理中）カウンタが 1 つずつ増えるようにする必要があります。3 秒後に "Pending" カウンタが 1 減り、"Completed" カウンタが 1 増える必要があります。<p>しかし、"Pending" カウンタは意図した通りに動作していません。"Buy" を押すと、"Pending" が <code>-1</code> に減少します（あり得ない！）。また、2 回素早くクリックすると、両方のカウンタが予測不可能な挙動を示します。<p>なぜこれが起こるのでしょうか？ 両方のカウンタを修正してください。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">RequestTracker</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>completed<span class="token punctuation">,</span> setCompleted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span>pending <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span>pending <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCompleted</span><span class="token punctuation">(</span>completed <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token literal-property property">Pending</span><span class="token operator">:</span> <span class="token punctuation">{</span>pending<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token literal-property property">Completed</span><span class="token operator">:</span> <span class="token punctuation">{</span>completed<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Buy</span>     
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p><code>handleClick</code> イベントハンドラ内では、<code>pending</code> と <code>completed</code> の値はクリックイベントが起きた時点での値に対応しています。最初のレンダーでは、<code>pending</code> は <code>0</code> だったため、<code>setPending(pending - 1)</code> は <code>setPending(-1)</code> となり、これは間違いです。カウンタを<em>インクリメント</em>または<em>デクリメント</em>したいので、クリック時に決まる具体的な値をセットするのではなく、代わりに更新用関数を渡すことができます。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">RequestTracker</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>pending<span class="token punctuation">,</span> setPending<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>completed<span class="token punctuation">,</span> setCompleted<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token arrow operator">=></span> p <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setPending</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token arrow operator">=></span> p <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCompleted</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token literal-property property">Pending</span><span class="token operator">:</span> <span class="token punctuation">{</span>pending<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h3<span class="token operator">></span>
        <span class="token literal-property property">Completed</span><span class="token operator">:</span> <span class="token punctuation">{</span>completed<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h3<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Buy</span>     
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">ms</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>これにより、カウンタをインクリメントまたはデクリメントする際に、クリック時の state ではなく、最新の state に対して行われることが保証されます。</p></solution></section><section class="level4"aria-labelledby="state-キューの独自実装-implement-the-state-queue-yourself"><h4 id="state-キューの独自実装-implement-the-state-queue-yourself">state キューの独自実装 {/<em>implement-the-state-queue-yourself</em>/}</h4><p>このチャレンジ問題では、React のごく一部をゼロから再実装します！ それほど難しくありません。<p>サンドボックスプレビューをスクロールしてください。<strong>4 つのテストケース</strong>が表示されていることに注意してください。それらはこのページの先ほどの例に対応しています。あなたの仕事は、<code>getFinalState</code> 関数を実装して、それぞれのケースに対して正しい結果を返すことです。正しく実装すると、すべてのテストが通るはずです。<p>2 つの引数を受け取ることになります。<code>baseState</code> は初期 state（例えば <code>0</code>）であり、<code>queue</code> は数値（例えば <code>5</code>）または更新用関数（例えば <code>n => n + 1</code>）のいずれかが、キューに入れられた順番で入っている配列です。<p>あなたの仕事は、このページ内の表で見たような処理を行って、最終的な state を返すことです！</p><hint><p>難しいと感じたら、次のコード構造から始めてください：<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> update <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: apply the updater function</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// TODO: replace the state</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>足りない行を埋めてください！</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token comment">// TODO: do something with the queue...</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getFinalState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./processQueue.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
increment<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'n => n+1'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          increment<span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          increment
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          <span class="token number">42</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TestCase</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  expected
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Base</span> state<span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>baseState<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Queue</span><span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">{</span>queue<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Expected</span> result<span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>expected<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'green'</span> <span class="token operator">:</span>
          <span class="token string">'red'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Your</span> result<span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>actual<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'correct'</span> <span class="token operator">:</span>
          <span class="token string">'wrong'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>以下が、このページで説明してきたような形で React が最終 state を計算するために使用しているアルゴリズムそのものです：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span><span class="token parameter">baseState<span class="token punctuation">,</span> queue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> finalState <span class="token operator">=</span> baseState<span class="token punctuation">;</span>

  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> update <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> update <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Apply the updater function.</span>
      finalState <span class="token operator">=</span> <span class="token function">update</span><span class="token punctuation">(</span>finalState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// Replace the next state.</span>
      finalState <span class="token operator">=</span> update<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> finalState<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getFinalState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./processQueue.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
increment<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">toString</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'n => n+1'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          increment<span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          increment
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">TestCase</span>
        baseState<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span>
        queue<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">[</span>
          <span class="token number">5</span><span class="token punctuation">,</span>
          increment<span class="token punctuation">,</span>
          <span class="token number">42</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">}</span>
        expected<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TestCase</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  baseState<span class="token punctuation">,</span>
  queue<span class="token punctuation">,</span>
  expected
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> actual <span class="token operator">=</span> <span class="token function">getFinalState</span><span class="token punctuation">(</span>baseState<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Base</span> state<span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>baseState<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Queue</span><span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">{</span>queue<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Expected</span> result<span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>expected<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'green'</span> <span class="token operator">:</span>
          <span class="token string">'red'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Your</span> result<span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>actual<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>actual <span class="token operator">===</span> expected <span class="token operator">?</span>
          <span class="token string-property property">'correct'</span> <span class="token operator">:</span>
          <span class="token string">'wrong'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>これで、React のこの部分がどのように動作するのかが分かりましたね！</p></solution><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></challenges></section></section></section>