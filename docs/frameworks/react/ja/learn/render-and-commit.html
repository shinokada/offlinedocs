<!doctype html><html lang="ja"><meta charset="utf-8"><title>レンダーとコミット</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="レンダーとコミット"><h1 id="レンダーとコミット">レンダーとコミット</h1><intro><p>コンポーネントは、画面上に表示される前に React によってレンダーされる必要があります。このプロセスが踏む段階を理解すると、コードがどのように実行されるのか考える際や、コードの振る舞いを説明する際に役立ちます。</p></intro><youwilllearn><ul><li>React での「レンダー」の意味<li>いつ、なぜ React はコンポーネントをレンダーするのか<li>画面上にコンポーネントが表示されるステップ<li>レンダーしたからといって DOM が更新されるとは限らない理由</ul></youwilllearn><p>コンポーネントが料理人として厨房に立ち、食材を調理して美味しい料理を作っている様子をイメージしてみてください。このシナリオにおいて React はウェイターです。お客様の注文を伝えて、できた料理をお客様に渡します。この UI の「注文」と「提供」のプロセスは、次の 3 つのステップからなります：<ol><li>レンダーの<strong>トリガ</strong>（お客様の注文を厨房に伝える）<li>コンポーネントの<strong>レンダー</strong>（厨房で注文の品を料理する）<li>DOM への<strong>コミット</strong>（テーブルに注文の品を提供する）</ol><illustrationblock sequential=""><illustration caption="トリガ"alt="レストランのウェイター役の React が、ユーザから注文を聞き取って、コンポーネントの厨房に渡している。"src.=""docs=""illustrations=""i_render-and-commit1.png&#x22;=""><illustration caption="レンダー"alt="Card シェフが React に出来立ての Card コンポーネントを渡している。"src.=""docs=""illustrations=""i_render-and-commit2.png&#x22;=""><illustration caption="コミット"alt="React がユーザの座っているテーブルに Card を提供している。"src.=""docs=""illustrations=""i_render-and-commit3.png&#x22;=""></illustration></illustration></illustration></illustrationblock><section class="level2"aria-labelledby="ステップ-1レンダーのトリガ-step-1-trigger-a-render"><h2 id="ステップ-1レンダーのトリガ-step-1-trigger-a-render">ステップ 1：レンダーのトリガ {/<em>step-1-trigger-a-render</em>/}</h2><p>コンポーネントがレンダーされる理由には 2 つあります。<ol><li>コンポーネントの<strong>初回レンダー</strong>。<li>コンポーネント（またはその祖先のいずれか）の <strong>state の更新</strong>。</ol><section class="level3"aria-labelledby="初回レンダー-initial-render"><h3 id="初回レンダー-initial-render">初回レンダー {/<em>initial-render</em>/}</h3><p>アプリが開始するときには、初回のレンダーをトリガする必要があります。フレームワークやサンドボックスは、しばしばこのコードを隠蔽しますが、自力で行う場合には、ターゲットとなる DOM ノードに対して <a href="/reference/react-dom/client/createRoot"><code>createRoot</code></a> を呼び出し、作成されたルートの <code>render</code> メソッドを、コンポーネントに対して呼び出します。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Image</span></span> <span class="token keyword module">from</span> <span class="token string">'./Image.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Image</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>img
      src<span class="token operator">=</span><span class="token string">"https://i.imgur.com/ZF6s192.jpg"</span>
      alt<span class="token operator">=</span><span class="token string">"'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"</span>
    <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p><code>root.render()</code> の呼び出しをコメントアウトして、コンポーネントが消えるのを確認してみてください！</section><section class="level3"aria-labelledby="state-更新後の再レンダー-re-renders-when-state-updates"><h3 id="state-更新後の再レンダー-re-renders-when-state-updates">state 更新後の再レンダー {/<em>re-renders-when-state-updates</em>/}</h3><p>コンポーネントが最初にレンダーされた後、<a href="/reference/react/useState#setstate"><code>set</code> 関数</a>を使って state を更新することで、さらなるレンダーをトリガすることができます。コンポーネントの state を更新すると、自動的にレンダーがキューイングされます。（これは、レストランの客が最初の注文の後に、喉の渇きや空腹の状態に応じてお茶やデザートなどいろいろなものを注文するようなものだと考えることができます。）</p><illustrationblock sequential=""><illustration caption="state の更新が..."alt="レストランのウェイター役の React が Card UI を提供したところ。矢印頭の顧客は、黒ではなく、ピンクのカードが欲しいのだと注文している。"src.=""docs=""illustrations=""i_rerender1.png&#x22;=""><illustration caption="... トリガになって ..."alt="React はコンポーネントの厨房に戻り、ピンクの Card が必要だと Card シェフに伝える。"src.=""docs=""illustrations=""i_rerender2.png&#x22;=""><illustration caption="... レンダーされる！"alt="Card シェフはピンクのカードを React に渡している。"src.=""docs=""illustrations=""i_rerender3.png&#x22;=""></illustration></illustration></illustration></illustrationblock></section></section><section class="level2"aria-labelledby="ステップ-2react-がコンポーネントをレンダー-step-2-react-renders-your-components"><h2 id="ステップ-2react-がコンポーネントをレンダー-step-2-react-renders-your-components">ステップ 2：React がコンポーネントをレンダー {/<em>step-2-react-renders-your-components</em>/}</h2><p>あなたがレンダーをトリガした後、React はコンポーネントを呼び出して画面に表示する内容を把握します。<strong>「レンダー」とは、React がコンポーネントを呼び出すことです。</strong><ul><li><strong>初回レンダー時</strong>、React はルート (root) コンポーネントを呼び出します。<li><strong>次回以降のレンダー</strong>では、state の更新によってレンダーがトリガされた関数コンポーネントを、React が呼び出します。</ul><p>このプロセスは再帰的に発生します。更新されたコンポーネントが他のコンポーネントを返す場合、次に<em>その</em>コンポーネントを React がレンダーし、そのコンポーネントも何かコンポーネントを返す場合、<em>その</em>コンポーネントも次にレンダーし、といった具合に続きます。このプロセスは、ネストされたコンポーネントがなくなり、React が画面に表示されるべき内容を知り尽くすまで続きます。<p>次の例では、React は <code>Gallery()</code> を呼び出した後、<code>Image()</code> を何度も呼び出します。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Gallery</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>section<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token maybe-class-name">Inspiring</span> <span class="token maybe-class-name">Sculptures</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Image</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>section<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Image</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>img
      src<span class="token operator">=</span><span class="token string">"https://i.imgur.com/ZF6s192.jpg"</span>
      alt<span class="token operator">=</span><span class="token string">"'Floralis Genérica' by Eduardo Catalano: a gigantic metallic flower sculpture with reflective petals"</span>
    <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Gallery</span></span> <span class="token keyword module">from</span> <span class="token string">'./Gallery.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
root<span class="token punctuation">.</span><span class="token method function property-access">render</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Gallery</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">img</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><ul><li><strong>初回レンダー時には</strong>、React は <code>&#x3C;section></code>、<code>&#x3C;h1></code>、および 3 つの <code>&#x3C;img></code> タグの <a href="https://developer.mozilla.org/docs/Web/API/Document/createElement">DOM ノードを作成</a>します。<li><strong>再レンダー時には</strong>、React は前回のレンダーからどの部分が変わったのか、あるいは変わらなかったのかを計算します。次のステップであるコミットフェーズまでこの情報は使われません。</ul><pitfall><p>レンダーは常に<a href="/learn/keeping-components-pure">純粋な計算</a>であるべきです。<ul><li><strong>同じ入力には同じ出力</strong>。同じ入力が与えられた場合、コンポーネントは常に同じ JSX を返す必要がある。（トマトサラダを注文した人がオニオンサラダを受け取ってはいけない！）<li><strong>自分の仕事に専念する</strong>。レンダー前に存在したオブジェクトや変数を変更しない。（ある注文が他の誰かの注文を変更してはいけない。）</ul><p>これを守らなかった場合、コードベースが複雑になるにつれて、ややこしいバグや予測不能な挙動に遭遇することになります。"Strict Mode" で開発している場合、React は各コンポーネントの関数を 2 回呼び出すことで、純粋でない関数が引き起こす間違いに気づきやすくしてくれます。</p></pitfall><deepdive><section class="level4"aria-labelledby="パフォーマンスの最適化-optimizing-performance"><h4 id="パフォーマンスの最適化-optimizing-performance">パフォーマンスの最適化 {/<em>optimizing-performance</em>/}</h4><p>更新されたコンポーネントがツリー内で非常に高い位置にある場合、その内部にネストされたすべてのコンポーネントを再レンダーするというデフォルトの挙動は、パフォーマンスにとって理想的ではありません。パフォーマンスの問題に遭遇した場合、<a href="https://reactjs.org/docs/optimizing-performance.html">パフォーマンス</a>セクションで述べられているいくつかのオプトインによる解決方法があります。<strong>早まった最適化をしてしまってはいけません！</strong></section></deepdive></section><section class="level2"aria-labelledby="ステップ-3react-が-dom-への変更をコミットする-step-3-react-commits-changes-to-the-dom"><h2 id="ステップ-3react-が-dom-への変更をコミットする-step-3-react-commits-changes-to-the-dom">ステップ 3：React が DOM への変更をコミットする {/<em>step-3-react-commits-changes-to-the-dom</em>/}</h2><p>あなたのコンポーネントをレンダー（関数として呼び出し）した後、React は DOM を変更します。<ul><li><strong>初回レンダー時には</strong>、React は <a href="https://developer.mozilla.org/docs/Web/API/Node/appendChild"><code>appendChild()</code></a> DOM API を使用して、作成したすべての DOM ノードを画面に表示します。<li><strong>再レンダー時には</strong>、React は最新のレンダー出力に合わせて DOM を変更するため、必要な最小限の操作（レンダー中に計算されたもの！）を適用します。</ul><p><strong>React はレンダー間で違いがあった場合にのみ DOM ノードを変更します</strong>。例えば、以下のコンポーネントは親から渡された異なる props で毎秒再レンダーされます。実際に試してみてください。<code>&#x3C;input></code> にテキストを追加して <code>value</code> を更新することができますが、コンポーネントが再レンダーされる瞬間もテキストが消えることはありません：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Clock</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> time <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>time<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Clock</span></span> <span class="token keyword module">from</span> <span class="token string">'./Clock.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">useTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>time<span class="token punctuation">,</span> setTime<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">useTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Clock</span> time<span class="token operator">=</span><span class="token punctuation">{</span>time<span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p>これが上手く動作するのは、最終ステップで React によって更新されるのが、新しい <code>time</code> の値で更新される <code>&#x3C;h1></code> の中身だけだからです。<code>&#x3C;input></code> は JSX 内で前回と同じ場所にあるので、React は <code>&#x3C;input></code> やその <code>value</code> に触れません！ ## エピローグ：ブラウザのペイント {/<em>epilogue-browser-paint</em>/}<p>レンダーが完了し、React が DOM を更新した後、ブラウザは画面を再描画します。このプロセスは「ブラウザレンダリング」として知られていますが、我々は、混乱を避けるために、ドキュメント全体を通して「ペイント」と呼ぶことにします。<p>&#x3C;Illustration alt="ブラウザが「カード要素と静物画」をペイントしている" src./docs/illustrations/i_browser-paint.png" /></p><recap><ul><li>React アプリでの画面更新は、以下の 3 つのステップで行われる：<ol><li>トリガ<li>レンダー<li>コミット</ol><li>Strict Mode を使って、コンポーネントの間違いを発見できる。<li>レンダー結果が前回と同一である場合、React は DOM を触らない。</ul></recap><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>