<!doctype html><html lang="ja"><meta charset="utf-8"><title>state はスナップショットである</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="state-はスナップショットである"><h1 id="state-はスナップショットである">state はスナップショットである</h1><intro><p>state 変数は、読んだり書いたりできる普通の JavaScript の変数のように見えるかもしれません。しかし、state はむしろ、スナップショットのように振る舞います。state をセットしても、既にある state 変数は変更されず、かわりに再レンダーがトリガされます。</p></intro><youwilllearn><ul><li>state のセットが再レンダーをどのようにトリガするのか<li>state がいつどのように更新されるか<li>state がセットされた直後に更新されない理由<li>イベントハンドラが state の「スナップショット」にどのようにアクセスするのか</ul></youwilllearn><section class="level2"aria-labelledby="state-のセットでレンダーがトリガされる-setting-state-triggers-renders"><h2 id="state-のセットでレンダーがトリガされる-setting-state-triggers-renders">state のセットでレンダーがトリガされる {/<em>setting-state-triggers-renders</em>/}</h2><p>ユーザインターフェースとはクリックなどのユーザイベントに直接反応して更新されるものだ、と考えているかもしれません。React の動作は、このような考え方とは少し異なります。前のページで、<a href="/learn/render-and-commit#step-1-trigger-a-render">state をセットすることで再レンダーを React に要求</a>しているのだ、ということを見てきました。これは、インターフェースがイベントに応答するためには、<em>state を更新</em>する必要があることを意味します。<p>この例では、"Send" を押すと、<code>setIsSent(true)</code> が React に UI の再レンダーを指示します。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isSent<span class="token punctuation">,</span> setIsSent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>message<span class="token punctuation">,</span> setMessage<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Hi!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isSent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token maybe-class-name">Your</span> message is on its way<span class="token operator">!</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>form onSubmit<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token method function property-access">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setIsSent</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">sendMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>textarea
        placeholder<span class="token operator">=</span><span class="token string">"Message"</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token maybe-class-name">Send</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label<span class="token punctuation">,</span> textarea</span> <span class="token punctuation">{</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>ボタンをクリックすると次のような処理が行われます：<ol><li><code>onSubmit</code> イベントハンドラが実行されます。<li><code>setIsSent(true)</code> が <code>isSent</code> を <code>true</code> にセットし、新しいレンダーを予約します。<li>React が新しい <code>isSent</code> の値を使ってコンポーネントを再レンダーします。</ol><p>state とレンダーの関係をもう少し詳しく見ていきましょう。</section><section class="level2"aria-labelledby="レンダーは時間を切り取ってスナップショットを取る-rendering-takes-a-snapshot-in-time"><h2 id="レンダーは時間を切り取ってスナップショットを取る-rendering-takes-a-snapshot-in-time">レンダーは時間を切り取ってスナップショットを取る {/<em>rendering-takes-a-snapshot-in-time</em>/}</h2><p><a href="/learn/render-and-commit#step-2-react-renders-your-components">「レンダーする」</a>とは、React があなたのコンポーネント（関数）を呼び出すということです。関数から返される JSX は、その時点での UI のスナップショットのようなものです。その JSX 内の props、イベントハンドラ、ローカル変数はすべて、<strong>レンダー時の state を使用して計算されます</strong>。<p>写真や映画のフレームとは違い、返される「UI のスナップショット」はインタラクティブです。イベントハンドラのような、入力に対する応答を指定するためのロジックが含まれています。React は画面をこのスナップショットに合わせて更新し、イベントハンドラを接続します。その結果として、ボタンを押すと JSX に書いたクリックハンドラがトリガされます。<p>React がコンポーネントを再レンダーする際には：<ol><li>React が再度あなたの関数を呼び出します。<li>関数は新しい JSX のスナップショットを返します。<li>React は返されたスナップショットに合わせて画面を更新します。</ol><illustrationblock sequential=""><illustration caption="React が関数を実行"src.=""docs=""illustrations=""i_render1.png&#x22;=""><illustration caption="スナップショットを計算"src.=""docs=""illustrations=""i_render2.png&#x22;=""><illustration caption="DOM ツリーを更新"src.=""docs=""illustrations=""i_render3.png&#x22;=""></illustration></illustration></illustration></illustrationblock><p>コンポーネントのメモリとしての state は、関数が終了したら消えてしまう通常の変数とは異なります。state は実際には React 自体の中で「生存」しています。まるで棚に保管しているかのように、関数の外部で存在し続けます。React がコンポーネントを呼び出すとき、React はその特定のレンダーに対する state のスナップショットを提供します。あなたのコンポーネントは、props やイベントハンドラの新たな一式を揃えた JSX という形で UI のスナップショットを返し、それらはすべて<strong>その特定のレンダー時の state の値を使って計算されます！</strong></p><illustrationblock sequential=""><illustration caption="state の更新を React に指示"src.=""docs=""illustrations=""i_state-snapshot1.png&#x22;=""><illustration caption="React が state の値を更新"src.=""docs=""illustrations=""i_state-snapshot2.png&#x22;=""><illustration caption="React がコンポーネントに state のスナップショットを渡す"src.=""docs=""illustrations=""i_state-snapshot3.png&#x22;=""></illustration></illustration></illustration></illustrationblock><p>これがどのように動作するかを示す小さな実験をしましょう。この例では、"+3" ボタンをクリックすると <code>setNumber(number + 1)</code> を 3 回呼び出すので、カウンタが 3 回インクリメントされると予想するかもしれません。<p>"+3" ボタンをクリックすると何が起こるか見てみましょう。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p><code>number</code> がクリックごとに 1 しか増えていませんね！<p><strong>state をセットしても、それが本当に変更されるのは<em>次回の</em>レンダーです</strong>。最初のレンダーでは <code>number</code> が <code>0</code> でした。だから、<em>そのレンダーの</em> <code>onClick</code> ハンドラにおいては、<code>setNumber(number + 1)</code> が呼ばれた後も <code>number</code> が <code>0</code> のままだったのです。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span></code></pre><p>このボタンのクリックハンドラは、以下のように React に指示しています。<ol><li><code>setNumber(number + 1)</code>: <code>number</code> が <code>0</code> なので <code>setNumber(0 + 1)</code>。<ul><li>React は次回のレンダーで <code>number</code> を <code>1</code> に更新する準備をする。</ul><li><code>setNumber(number + 1)</code>: <code>number</code> が <code>0</code> なので <code>setNumber(0 + 1)</code>。<ul><li>React は次回のレンダーで <code>number</code> を <code>1</code> に更新する準備をする。</ul><li><code>setNumber(number + 1)</code>: <code>number</code> が <code>0</code> なので <code>setNumber(0 + 1)</code>。<ul><li>React は次回のレンダーで <code>number</code> を <code>1</code> に更新する準備をする。</ul></ol><p><code>setNumber(number + 1)</code> を 3 回呼び出しましたが、<em>今回のレンダーの</em>イベントハンドラでは <code>number</code> は常に <code>0</code> なので、state を 3 回連続して <code>1</code> にセットしていることになります。これが、イベントハンドラが終了した後、React が <code>number</code> を <code>3</code> ではなく <code>1</code> とした上でコンポーネントを再レンダーする理由です。<p>もっと分かりやすくするために、頭の中でコード内の state 変数を実際の値に置換してみることもできます。<em>このレンダーでは</em> <code>number</code> という state 変数は <code>0</code> なので、イベントハンドラは次のようになっています。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span></code></pre><p>次のレンダーでは、<code>number</code> が <code>1</code> になるため、<em>そちらのレンダーの</em> クリックハンドラは、次のようになります。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">3</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span></code></pre><p>以上が、ボタンを再度クリックするとカウンタが <code>2</code> にセットされ、次のクリックでは <code>3</code> にセットされ、というようになる理由です。</section><section class="level2"aria-labelledby="時間経過と-state-state-over-time"><h2 id="時間経過と-state-state-over-time">時間経過と state {/<em>state-over-time</em>/}</h2><p>なかなか面白い話でした。それでは、このボタンをクリックするとアラートに何が表示されるか予想してみてください。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">alert</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>上記で説明した置換メソッドを使えば、アラートには "0" と表示されることがわかりますね。<pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>でも、アラートにタイマーを設定して、コンポーネントが再レンダーされた<em>後に</em>発火するようにしたらどうなるでしょうか？ "0" と表示されるのか、"5" と表示されるのか推測してみてください。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Counter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>number<span class="token punctuation">,</span> setNumber<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>number<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setNumber</span><span class="token punctuation">(</span>number <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token function">alert</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">+</span><span class="token number">5</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">button</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>驚いたでしょうか？ さきほどの置換メソッドを使ってみれば、アラートに渡された state が「スナップショット」であることが分かるでしょう。<pre class="language-js"><code class="language-js"><span class="token function">setNumber</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>アラートが実行される時点では React に格納されている state は既に更新されているかもしれませんが、アラートはユーザがボタンを操作した時点での state のスナップショットを使ってスケジューリングされました！<p>イベントハンドラのコードが非同期であっても、<strong>レンダー内の state 変数の値は決して変わりません</strong>。<em>そのレンダーの</em> <code>onClick</code> 内では、<code>setNumber(number + 5)</code> が呼ばれた後も <code>number</code> の値は <code>0</code> のままです。その値は React があなたのコンポーネントを呼び出して UI の「スナップショットを取った」時に、「固定」されたのです。<p>ここで、このお陰でタイミングにまつわる問題が起きづらくなっている、という例をお示しします。以下のフォームは、5 秒の遅延後にメッセージを送信します。ここでこんなシナリオを想像してみてください：<ol><li>"Send" ボタンを押して、"Hello" というメッセージをアリスに送る。<li>5 秒の遅延が終わる前に、"To" フィールドの値を "Bob" に変更する。</ol><p><code>alert</code> に何が表示されると思いますか？ "You said Hello to Alice" と表示されるのでしょうか？ それとも "You said Hello to Bob" でしょうか？ ここまでの知識に基づいて推測し、実際に試してみましょう。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>to<span class="token punctuation">,</span> setTo<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Alice'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>message<span class="token punctuation">,</span> setMessage<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">'Hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSubmit</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token method function property-access">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You said </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>to<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>form onSubmit<span class="token operator">=</span><span class="token punctuation">{</span>handleSubmit<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">To</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span>select
          value<span class="token operator">=</span><span class="token punctuation">{</span>to<span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setTo</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"Alice"</span><span class="token operator">></span><span class="token maybe-class-name">Alice</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
          <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"Bob"</span><span class="token operator">></span><span class="token maybe-class-name">Bob</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>select<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>textarea
        placeholder<span class="token operator">=</span><span class="token string">"Message"</span>
        value<span class="token operator">=</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token function">setMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token maybe-class-name">Send</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label<span class="token punctuation">,</span> textarea</span> <span class="token punctuation">{</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p><strong>React は、レンダー内の state の値を「固定」し、イベントハンドラ内で保持します</strong>。コードが実行されている途中で state が変更されたかどうか心配する必要はありません。<p>しかし、再レンダー前に最新の state を読み取りたい場合はどうでしょうか？ <a href="/learn/queueing-a-series-of-state-updates">state 更新用関数</a>を使うことができます。これについては次のページで説明します！</p><recap><ul><li>state のセットは新しいレンダーをリクエストする。<li>React は state をコンポーネントの外側で、まるで棚に保管しておくかのようにして保持する。<li><code>useState</code> を呼び出すと、React は<em>そのレンダーのための</em> state のスナップショットを返す。<li>変数やイベントハンドラは複数レンダーをまたいで「生き残る」ことはない。すべてのレンダーは固有のイベントハンドラを持つ。<li>各レンダー（およびその中の関数）からは、常に、React が <em>その</em>レンダーに渡した state のスナップショットが「見える」。<li>レンダーされた JSX を考える時と同様にして、イベントハンドラ内の state を頭の中で実際の値に置換してみることができる。<li>過去に作成されたイベントハンドラは、それが作成されたレンダーにおける state の値を持っている。</ul></recap><challenges><section class="level4"aria-labelledby="信号機を実装-implement-a-traffic-light"><h4 id="信号機を実装-implement-a-traffic-light">信号機を実装 {/<em>implement-a-traffic-light</em>/}</h4><p>以下は、ボタンが押されると切り替わる歩行者用信号機のコンポーネントです。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TrafficLight</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>walk<span class="token punctuation">,</span> setWalk<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setWalk</span><span class="token punctuation">(</span><span class="token operator">!</span>walk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Change</span> to <span class="token punctuation">{</span>walk <span class="token operator">?</span> <span class="token string">'Stop'</span> <span class="token operator">:</span> <span class="token string">'Walk'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1 style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> walk <span class="token operator">?</span> <span class="token string">'darkgreen'</span> <span class="token operator">:</span> <span class="token string">'darkred'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>walk <span class="token operator">?</span> <span class="token string">'Walk'</span> <span class="token operator">:</span> <span class="token string">'Stop'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">margin-top</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>クリックハンドラに <code>alert</code> を追加してください。信号が緑で "Walk" と表示されている場合、ボタンをクリックすると "Stop is next" と表示され、信号が赤で "Stop" と表示されている場合、ボタンをクリックすると "Walk is next" と表示されるようにしてください。<p><code>alert</code> を <code>setWalk</code> の前に置いた場合と後に置いた場合で、違いはありますか？</p><solution><p><code>alert</code> は以下のように書けます。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TrafficLight</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>walk<span class="token punctuation">,</span> setWalk<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setWalk</span><span class="token punctuation">(</span><span class="token operator">!</span>walk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">alert</span><span class="token punctuation">(</span>walk <span class="token operator">?</span> <span class="token string">'Stop is next'</span> <span class="token operator">:</span> <span class="token string">'Walk is next'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleClick<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Change</span> to <span class="token punctuation">{</span>walk <span class="token operator">?</span> <span class="token string">'Stop'</span> <span class="token operator">:</span> <span class="token string">'Walk'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1 style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">color</span><span class="token operator">:</span> walk <span class="token operator">?</span> <span class="token string">'darkgreen'</span> <span class="token operator">:</span> <span class="token string">'darkred'</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token punctuation">{</span>walk <span class="token operator">?</span> <span class="token string">'Walk'</span> <span class="token operator">:</span> <span class="token string">'Stop'</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">h1</span> <span class="token punctuation">{</span> <span class="token property">margin-top</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p><code>alert</code> を <code>setWalk</code> の前に置いた場合と後に置いた場合で、違いはありません。このレンダー中、<code>walk</code> の値は固定です。<code>setWalk</code> を呼び出しても、<em>次の</em>レンダーまで実際の変更は起きず、現在レンダーのイベントハンドラには影響しません。<p>この行は最初は直感に反しているように思えるかもしれません。<pre class="language-js"><code class="language-js"><span class="token function">alert</span><span class="token punctuation">(</span>walk <span class="token operator">?</span> <span class="token string">'Stop is next'</span> <span class="token operator">:</span> <span class="token string">'Walk is next'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>しかし、これを「もし信号が今 "Walk" を表示しているなら、メッセージは "Stop is next" と言うべきだ」のように読めば、理に適っていることが分かります。イベントハンドラ内の <code>walk</code> 変数は、そのレンダーの <code>walk</code> の値と一致しており、変わることはありません。<p>上記で説明している置換メソッドを適用して、このことが正しいことを確認することができます。<code>walk</code> が <code>true</code> の場合、次のようになります。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setWalk</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Stop is next'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
  <span class="token maybe-class-name">Change</span> to <span class="token maybe-class-name">Stop</span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
<span class="token operator">&#x3C;</span>h1 style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'darkgreen'</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
  <span class="token maybe-class-name">Walk</span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span></code></pre><p>すなわち、"Change to Stop" をクリックすると、<code>walk</code> が <code>false</code> にセットされたレンダーがキューに入り、"Stop is next" というアラートが表示されます。</p></solution><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></challenges></section></section>