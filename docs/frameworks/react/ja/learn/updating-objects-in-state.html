<!doctype html><html lang="ja"><meta charset="utf-8"><title>state 内のオブジェクトの更新</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="state-内のオブジェクトの更新"><h1 id="state-内のオブジェクトの更新">state 内のオブジェクトの更新</h1><intro><p>state にはどのような JavaScript の値でも保持することができます。これにはオブジェクトも含まれます。しかし、React の state に保持されたオブジェクトを直接書き換えるべきではありません。オブジェクトを更新したい場合、代わりに新しいオブジェクトを作成（または既存のもののコピーを作成）し、それを使って state をセットする必要があります。</p></intro><youwilllearn><ul><li>React の state 内のオブジェクトを正しく更新する方法<li>ミューテートせずにネストされたオブジェクトを更新する方法<li>イミュータビリティとは何で、どのようにして遵守するのか<li>Immer を使ってオブジェクトコピーのためのコードの冗長さを緩和する方法</ul></youwilllearn><section class="level2"aria-labelledby="ミューテーションとは-whats-a-mutation"><h2 id="ミューテーションとは-whats-a-mutation">ミューテーションとは？ {/<em>whats-a-mutation</em>/}</h2><p>state には、どのような JavaScript の値でも格納することができます。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>x<span class="token punctuation">,</span> setX<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>これまでに扱ってきたのは、数値、文字列、および真偽値です。これらの種類の JavaScript 値は "イミュータブル"（不変, immutable）、つまり値が変わることがなく「読み取り専用」なものです。再レンダーをトリガするには値を<em>置き換え</em>ます。<pre class="language-js"><code class="language-js"><span class="token function">setX</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>x</code> という state の値は <code>0</code> から <code>5</code> に置き換わりましたが、<em><code>0</code> という数字そのもの</em>が変化したわけではありません。JavaScript の数値、文字列、真偽値のような組み込みプリミティブの値そのものを変化させることは不可能です。<p>さて、state にオブジェクトが入っている場合を考えてみましょう。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> setPosition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>技術的には、<em>オブジェクト自体</em>の内容を書き換えることが可能です。<strong>これをミューテーション (mutation) と呼びます</strong>。<pre class="language-js"><code class="language-js">position<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></code></pre><p>しかし、React の state 内にあるオブジェクトは技術的にはミュータブル（mutable, 書き換え可能）であるとしても、数値、真偽値、文字列と同様に、イミュータブルなものであるかのように扱うべきです。書き換えるのではなく、常に置き換えるべきです。</section><section class="level2"aria-labelledby="state-を読み取り専用として扱う-treat-state-as-read-only"><h2 id="state-を読み取り専用として扱う-treat-state-as-read-only">state を読み取り専用として扱う {/<em>treat-state-as-read-only</em>/}</h2><p>言い換えると、<strong>state として格納するすべての JavaScript オブジェクトは読み取り専用</strong>として扱う必要があります。<p>以下の例では、現在のポインタ位置を表すオブジェクトを state に保持しています。プレビュー領域でタッチしたりマウスカーソルを動かしたりすると、赤い点が動いて欲しいと思っています。しかし、点が初期位置から動きません：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MovingDot</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> setPosition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        position<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">;</span>
        position<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'relative'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token string">'100vw'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token string">'100vh'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">borderRadius</span><span class="token operator">:</span> <span class="token string">'50%'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">250</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>問題は、このコードにあります。<pre class="language-js"><code class="language-js">onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  position<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">;</span>
  position<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>このコードは、<a href="/learn/state-as-a-snapshot#rendering-takes-a-snapshot-in-time">直近のレンダー</a>で <code>position</code> に割り当てられたオブジェクトを書き換え、つまりミューテートしています。しかし、state セット関数が使用されないと、React はそのオブジェクトが変更されたことを認識できません。そのため、React は何の反応もしません。これは料理をすでに食べた後で注文を変更しようとするようなものです。state のミューテートは一部のケースでは機能することがありますが、おすすめしません。レンダー内でアクセスできる state 値は、読み取り専用として扱うべきです。<p>この場合、実際に<a href="/learn/state-as-a-snapshot#setting-state-triggers-renders">再レンダーをトリガする</a>ためには、<strong><em>新しい</em>オブジェクトを作成し、それを state セット関数に渡す必要があります。</strong><pre class="language-js"><code class="language-js">onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><code>setPosition</code> を使うことで、React に次のことを伝えます。<ul><li><code>position</code> をこの新しいオブジェクトに置き換えよ<li>そしてもう一度このコンポーネントをレンダーせよ</ul><p>プレビューエリアでタッチするかマウスホバーすることで、赤い点がポインタに追随するようになりましたね。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MovingDot</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>position<span class="token punctuation">,</span> setPosition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span><span class="token parameter">e</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
          <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'relative'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token string">'100vw'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token string">'100vh'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">borderRadius</span><span class="token operator">:</span> <span class="token string">'50%'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">left</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">250</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><deepdive><section class="level4"aria-labelledby="ローカルミューテーションは問題なし-local-mutation-is-fine"><h4 id="ローカルミューテーションは問題なし-local-mutation-is-fine">ローカルミューテーションは問題なし {/<em>local-mutation-is-fine</em>/}</h4><p>以下のようなコードは、state の<em>既存の</em>オブジェクトを変更しているため、問題があります。<pre class="language-js"><code class="language-js">position<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">;</span>
position<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">;</span></code></pre><p>しかし、以下のようなコードは<strong>全く問題ありません</strong>。なぜなら、<em>作成したばかりの</em>新しいオブジェクトを書き換えているからです。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> nextPosition <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
nextPosition<span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">;</span>
nextPosition<span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">;</span>
<span class="token function">setPosition</span><span class="token punctuation">(</span>nextPosition<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>実際、これは以下のように書くことと全く同等です。<pre class="language-js"><code class="language-js"><span class="token function">setPosition</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>state として存在する<em>既存の</em>オブジェクトを変更する場合にのみ、ミューテーションは問題になります。作成したばかりのオブジェクトであれば<em>他のコードはまだそれを参照していない</em>ので、書き換えても問題ありません。それを書き換えてもそれに依存する何かに誤って影響を与えることはありません。これを "ローカルミューテーション (local mutation)" と呼びます。<a href="/learn/keeping-components-pure#local-mutation-your-components-little-secret">レンダー中にも</a>ローカルミューテーションを行うことができます。とても便利で、全く問題ありません！</section></deepdive></section><section class="level2"aria-labelledby="スプレッド構文を使ったオブジェクトのコピー-copying-objects-with-the-spread-syntax"><h2 id="スプレッド構文を使ったオブジェクトのコピー-copying-objects-with-the-spread-syntax">スプレッド構文を使ったオブジェクトのコピー {/<em>copying-objects-with-the-spread-syntax</em>/}</h2><p>前の例では、<code>position</code> オブジェクトは現在のカーソル位置から常に新規作成されます。しかし、多くの場合、新しく作成するオブジェクトに<em>既存の</em>データも含めたいことがあります。例えば、フォームの <em>1 つの</em>フィールドだけを更新し、他のすべてのフィールドについては以前の値を保持したい、ということがあります。<p>以下の入力フィールドは、<code>onChange</code> ハンドラが state を書き換えているため、動作しません。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Barbara'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Hepworth'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">'bhepworth@sculpture.com'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleFirstNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    person<span class="token punctuation">.</span><span class="token property-access">firstName</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleLastNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    person<span class="token punctuation">.</span><span class="token property-access">lastName</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleEmailChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    person<span class="token punctuation">.</span><span class="token property-access">email</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">First</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleFirstNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">Last</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleLastNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Email</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">email</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleEmailChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">email</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>例えば、以下の行は過去のレンダーからの state を書き換えてしまっています。<pre class="language-js"><code class="language-js">person<span class="token punctuation">.</span><span class="token property-access">firstName</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span></code></pre><p>望んだ動作を得る確実な方法は、新しいオブジェクトを作成して <code>setPerson</code> に渡すことです。しかし、ここではフィールドのうちの 1 つだけが変更されているため、<strong>既存のデータもコピーしたい</strong>でしょう。<pre class="language-js"><code class="language-js"><span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">,</span> <span class="token comment">// New first name from the input</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">,</span>
  <span class="token literal-property property">email</span><span class="token operator">:</span> person<span class="token punctuation">.</span><span class="token property-access">email</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>...</code> という<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax#spread_in_object_literals">オブジェクトスプレッド</a>構文を使用することで、すべてのプロパティを個別にコピーする必要がなくなります。<pre class="language-js"><code class="language-js"><span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token spread operator">...</span>person<span class="token punctuation">,</span> <span class="token comment">// Copy the old fields</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span> <span class="token comment">// But override this one</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>これでフォームが機能します！<p>各入力フィールドに対して state 変数を別々に宣言していないことに注目してください。大きなフォームでは、すべてのデータをオブジェクトにまとめて保持することが非常に便利です。正しく更新さえしていれば！</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Barbara'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Hepworth'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">'bhepworth@sculpture.com'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleFirstNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleLastNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleEmailChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">email</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">First</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleFirstNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">Last</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleLastNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Email</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">email</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleEmailChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">email</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p><code>...</code> スプレッド構文は「浅い (shallow)」ことに注意してください。これは 1 レベルの深さでのみコピーを行います。これは高速ですが、ネストされたプロパティを更新したい場合は、スプレッド構文を複数回使用する必要があるということでもあります。</p><deepdive><section class="level4"aria-labelledby="複数のフィールドに単一のイベントハンドラを使う-using-a-single-event-handler-for-multiple-fields"><h4 id="複数のフィールドに単一のイベントハンドラを使う-using-a-single-event-handler-for-multiple-fields">複数のフィールドに単一のイベントハンドラを使う {/<em>using-a-single-event-handler-for-multiple-fields</em>/}</h4><p>オブジェクト定義内で <code>[</code> と <code>]</code> 括弧を使って、動的な名前のプロパティを指定することもできます。以下は上記と例ですが、3 つの異なるイベントハンドラの代わりに 1 つのイベントハンドラを使用しています。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Barbara'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Hepworth'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">email</span><span class="token operator">:</span> <span class="token string">'bhepworth@sculpture.com'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token punctuation">[</span>e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">]</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">First</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          name<span class="token operator">=</span><span class="token string">"firstName"</span>
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">Last</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          name<span class="token operator">=</span><span class="token string">"lastName"</span>
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Email</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          name<span class="token operator">=</span><span class="token string">"email"</span>
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">email</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token punctuation">(</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">email</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>ここでは、<code>e.target.name</code> は、<code>&#x3C;input></code> DOM 要素に与えられた <code>name</code> プロパティを指しています。</section></deepdive></section><section class="level2"aria-labelledby="ネストされたオブジェクトの更新-updating-a-nested-object"><h2 id="ネストされたオブジェクトの更新-updating-a-nested-object">ネストされたオブジェクトの更新 {/<em>updating-a-nested-object</em>/}</h2><p>以下のようなネストされたオブジェクト構造を考えてみましょう。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Niki de Saint Phalle'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    # <span class="token string">'Blue Nana'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'Hamburg'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token string">'https://i.imgur.com/Sd1AgUOm.jpg'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>person.artwork.city</code> を更新したい場合、ミューテーションで変更する方法は明らかです。<pre class="language-js"><code class="language-js">person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span> <span class="token operator">=</span> <span class="token string">'New Delhi'</span><span class="token punctuation">;</span></code></pre><p>しかし、React では state をイミュータブルなものとして扱います！ <code>city</code> を更新するためには、まず（既存のデータも含まれた）新しい <code>artwork</code> オブジェクトを生成する必要があります。そして、新しい <code>artwork</code> を含む新しい <code>person</code> オブジェクトを生成します。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> nextArtwork <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">,</span> <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'New Delhi'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nextPerson <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>person<span class="token punctuation">,</span> <span class="token literal-property property">artwork</span><span class="token operator">:</span> nextArtwork <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">setPerson</span><span class="token punctuation">(</span>nextPerson<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>あるいは、単一の関数呼び出しとして記述する場合は以下のようになります。<pre class="language-js"><code class="language-js"><span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token spread operator">...</span>person<span class="token punctuation">,</span> <span class="token comment">// Copy other fields</span>
  <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// but replace the artwork</span>
    <span class="token spread operator">...</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">,</span> <span class="token comment">// with the same one</span>
    <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'New Delhi'</span> <span class="token comment">// but in New Delhi!</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>これは少し冗長ですが、多くのケースでうまく機能します。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> setPerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Niki de Saint Phalle'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      # <span class="token string">'Blue Nana'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'Hamburg'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token string">'https://i.imgur.com/Sd1AgUOm.jpg'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleTitleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token spread operator">...</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">,</span>
        # e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleCityChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token spread operator">...</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">,</span>
        <span class="token literal-property property">city</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleImageChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPerson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>person<span class="token punctuation">,</span>
      <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token spread operator">...</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">,</span>
        <span class="token literal-property property">image</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Name</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Title</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleTitleChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">City</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleCityChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Image</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">image</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleImageChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>i<span class="token operator">></span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>i<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' by '</span><span class="token punctuation">}</span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span>br <span class="token operator">/</span><span class="token operator">></span>
        <span class="token punctuation">(</span>located <span class="token keyword">in</span> <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>img 
        src<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">image</span><span class="token punctuation">}</span> 
        alt<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">img</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><deepdive><section class="level4"aria-labelledby="オブジェクトは実際にはネストされない-objects-are-not-really-nested"><h4 id="オブジェクトは実際にはネストされない-objects-are-not-really-nested">オブジェクトは実際にはネストされない {/<em>objects-are-not-really-nested</em>/}</h4><p>このようなオブジェクトはコード内で「ネストされている」ように見えるでしょう：<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Niki de Saint Phalle'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    # <span class="token string">'Blue Nana'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'Hamburg'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token string">'https://i.imgur.com/Sd1AgUOm.jpg'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>しかし、オブジェクトの振る舞いを考える場合、「ネスト」という考え方は正確ではありません。コードが実行されてしまえば「ネストされた」オブジェクトというものは存在しません。実際には、2 つの異なるオブジェクトを見ているだけです：<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  # <span class="token string">'Blue Nana'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'Hamburg'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token string">'https://i.imgur.com/Sd1AgUOm.jpg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Niki de Saint Phalle'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">artwork</span><span class="token operator">:</span> obj1
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>obj1</code> オブジェクトは <code>obj2</code> の「内部」にあるのではありません。例えば、<code>obj3</code> も <code>obj1</code> を「参照する」ことができます：<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  # <span class="token string">'Blue Nana'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'Hamburg'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token string">'https://i.imgur.com/Sd1AgUOm.jpg'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj2 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Niki de Saint Phalle'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">artwork</span><span class="token operator">:</span> obj1
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> obj3 <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Copycat'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">artwork</span><span class="token operator">:</span> obj1
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>obj3.artwork.city</code> を変更すると、<code>obj2.artwork.city</code> と <code>obj1.city</code> の両方に影響を与えます。これは、<code>obj3.artwork</code>、<code>obj2.artwork</code>、および <code>obj1</code> が同一のオブジェクトであるためです。これは、オブジェクトが「ネストされている」と考えると理解しにくくなります。そうではなく、これらはあくまで別々のオブジェクトであり、プロパティで互いを「参照している」のです。</section><section class="level3"aria-labelledby="immer-で簡潔な更新ロジックを書く-write-concise-update-logic-with-immer"><h3 id="immer-で簡潔な更新ロジックを書く-write-concise-update-logic-with-immer">Immer で簡潔な更新ロジックを書く {/<em>write-concise-update-logic-with-immer</em>/}</h3><p>もし state が深くネストされている場合、<a href="/learn/choosing-the-state-structure#avoid-deeply-nested-state">フラットにすることを検討する</a>べきかもしれません。しかし、state の構造を変更したくない場合は、スプレッド構文をネストして使うより短いやり方が欲しくなるかもしれません。人気ライブラリである <a href="https://github.com/immerjs/use-immer">Immer</a> は、使いやすいミューテート型の構文を使って書きつつ、コピーを自動的に作成してくれるというものです。Immer を使うと、あなたのコードは一見オブジェクトをミューテートして「ルール違反」をしているかのように見えます。<pre class="language-js"><code class="language-js"><span class="token function">updatePerson</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  draft<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span> <span class="token operator">=</span> <span class="token string">'Lagos'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>しかし、通常のミューテーションとは異なり、過去の state は上書きされません！</p><deepdive><section class="level4"aria-labelledby="immer-はどのように動作するのか-how-does-immer-work"><h4 id="immer-はどのように動作するのか-how-does-immer-work">Immer はどのように動作するのか？ {/<em>how-does-immer-work</em>/}</h4><p>Immer から渡される <code>draft</code> は、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">プロキシ (Proxy)</a>と呼ばれる特殊なタイプのオブジェクトで、それに対して何を行ったのかを「記録」します。これが好きなだけミューテートができる理由です！ 内部では、Immer は <code>draft</code> のどの部分が変更されたかを把握し、あなたの編集内容を反映した完全に新しいオブジェクトを生成します。<p>Immer を試すには：<ol><li><code>npm install use-immer</code> を実行し、Immer を依存ライブラリとして追加する<li>次に <code>import { useState } from 'react'</code> を <code>import { useImmer } from 'use-immer'</code> に置き換える</ol><p>以下は、Immer に変換された上記の例です：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useImmer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'use-immer'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Form</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>person<span class="token punctuation">,</span> updatePerson<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useImmer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Niki de Saint Phalle'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">artwork</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      # <span class="token string">'Blue Nana'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">city</span><span class="token operator">:</span> <span class="token string">'Hamburg'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">image</span><span class="token operator">:</span> <span class="token string">'https://i.imgur.com/Sd1AgUOm.jpg'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updatePerson</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      draft<span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleTitleChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updatePerson</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      draft<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleCityChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updatePerson</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      draft<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleImageChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updatePerson</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      draft<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">image</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Name</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Title</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleTitleChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">City</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleCityChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Image</span><span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">image</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleImageChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>i<span class="token operator">></span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>i<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' by '</span><span class="token punctuation">}</span>
        <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span>br <span class="token operator">/</span><span class="token operator">></span>
        <span class="token punctuation">(</span>located <span class="token keyword">in</span> <span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">city</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>img 
        src<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">image</span><span class="token punctuation">}</span> 
        alt<span class="token operator">=</span><span class="token punctuation">{</span>person<span class="token punctuation">.</span><span class="token property-access">artwork</span><span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"immer"</span><span class="token operator">:</span> <span class="token string">"1.7.3"</span><span class="token punctuation">,</span>
    <span class="token property">"react"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"use-immer"</span><span class="token operator">:</span> <span class="token string">"0.5.1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"react-scripts start"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"react-scripts build"</span><span class="token punctuation">,</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"react-scripts test --env=jsdom"</span><span class="token punctuation">,</span>
    <span class="token property">"eject"</span><span class="token operator">:</span> <span class="token string">"react-scripts eject"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">img</span> <span class="token punctuation">{</span> <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">200</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p>イベントハンドラがどれほど簡潔になったか注目してください。<code>useState</code> と <code>useImmer</code> は 1 つのコンポーネント内で自由に組み合わせることができます。Immer は、state がネストしておりオブジェクトのコピーのためのコードが冗長になりそうな場合でも、更新を行うハンドラを簡潔に保つことができる素晴らしい方法です。</p><deepdive></deepdive></section><section class="level4"aria-labelledby="react-ではなぜ-state-の変更が非推奨なのか-why-is-mutating-state-not-recommended-in-react"><h4 id="react-ではなぜ-state-の変更が非推奨なのか-why-is-mutating-state-not-recommended-in-react">React ではなぜ state の変更が非推奨なのか？ {/<em>why-is-mutating-state-not-recommended-in-react</em>/}</h4><p>いくつかの理由があります。<ul><li><strong>デバッグ</strong>：<code>console.log</code> を使用しているなら、state を書き換えないことにより、古いログの内容が後に起きた state 変更によって上書きされる心配をしなくて済むようになります。つまり、レンダー間で state がどのように変化したかはっきり見ることができるようになります。<li><strong>最適化</strong>：React の一般的な<a href="/reference/react/memo">最適化戦略</a>は、前の props や state が次のものと同一である場合作業をスキップする、ということに依存しています。state を書き換えないことで、変更があったかどうかを非常に素早くチェックすることができます。<code>prevObj === obj</code> であれば、内部で何も変更されていないと自信を持って言えるようになります。<li><strong>新機能</strong>：開発中の新しい React の機能は、state が<a href="/learn/state-as-a-snapshot">スナップショットのように扱われること</a>を前提としています。過去の state の書き換えを行うと、新しい機能を使用できなくなる可能性があります。<li><strong>仕様変更のしやすさ</strong>：一部のアプリケーション機能（取り消し/やり直し、履歴の表示、フォームを以前の値にリセットするなど）は、ミューテーションが起きないのであれば実装が容易です。これはメモリ内に過去の state のコピーを保持しておけば、必要に応じて再利用できるからです。ミューテーションを行うアプローチで始めてしまうと、このような機能を後で追加するのが困難になることがあります。<li><strong>実装のシンプルさ</strong>：React はミューテーションの仕組みに依存しないため、オブジェクトに特別なことを一切しなくてすみます。他の多くの「リアクティブ」系ソリューションは、オブジェクトのプロパティを乗っ取ったり、プロキシにラップしたり、初期化時にその他もろもろの作業を行ったりしていますが、React ではその必要がありません。これが、React がどんな大きさのオブジェクトでも、パフォーマンスや正確性の問題を心配せずに state に入れることができる理由でもあります。</ul><p>実際には、React の state をミューテートしても「やり過ごせる」場合も多いのですが、そうしないことを強くお勧めします。上記のようなアプローチを念頭に開発された React の新機能を使用できるようにするためです。将来のコントリビュータや、将来のあなた自身が、あなたに感謝することでしょう！</p><recap><ul><li>React のすべての state はイミュータブルとして扱う。<li>state にオブジェクトを格納する場合、それらをミューテートしてもレンダーがトリガされない。それは過去のレンダー内の state の「スナップショット」を書き換えているだけである。<li>オブジェクトを書き換えるのではなく、代わりに新たなバージョンのオブジェクトを作成して、その新しいバージョンを新しい値として state をセットすることで再レンダーをトリガする。<li><code>{...obj, something: 'newValue'}</code> というオブジェクトスプレッド構文を使ってオブジェクトのコピーを作成できる。<li>スプレッド構文は「浅い」、つまり 1 レベルのみのコピーを行う。<li>ネストされたオブジェクトを更新するには、更新している場所から一番上までの全オブジェクトのコピーを作成する必要がある。<li>コピーのためのコードが冗長になったら Immer を使う。</ul></recap><challenges></challenges></section><section class="level4"aria-labelledby="間違った-state-更新を修正-fix-incorrect-state-updates"><h4 id="間違った-state-更新を修正-fix-incorrect-state-updates">間違った state 更新を修正 {/<em>fix-incorrect-state-updates</em>/}</h4><p>このフォームにはいくつかのバグがあります。スコアを増やすボタンを何度かクリックしてみてください。スコアが増えないことに気付くと思います。次に、ファーストネーム欄に入力をしようとすると、思い出したかのようにスコアが最新の値に更新されることを確認してください。最後に、ラストネームを入力してみてください。今度はスコアが完全に消えてしまいます。<p>あなたの仕事はこれらのバグをすべて修正することです。修正しながら、それぞれのバグがなぜ発生するのかを説明してください。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Scoreboard</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>player<span class="token punctuation">,</span> setPlayer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Ranjani'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Shettar'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">score</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handlePlusClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    player<span class="token punctuation">.</span><span class="token property-access">score</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleFirstNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>player<span class="token punctuation">,</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleLastNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Score</span><span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>player<span class="token punctuation">.</span><span class="token property-access">score</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handlePlusClick<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">+</span><span class="token number">1</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">First</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>player<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleFirstNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">Last</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>player<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleLastNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><solution><p>こちらが両方のバグを修正したバージョンです：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Scoreboard</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>player<span class="token punctuation">,</span> setPlayer<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Ranjani'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Shettar'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">score</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handlePlusClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>player<span class="token punctuation">,</span>
      <span class="token literal-property property">score</span><span class="token operator">:</span> player<span class="token punctuation">.</span><span class="token property-access">score</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleFirstNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>player<span class="token punctuation">,</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleLastNameChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setPlayer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>player<span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token literal-property property">Score</span><span class="token operator">:</span> <span class="token operator">&#x3C;</span>b<span class="token operator">></span><span class="token punctuation">{</span>player<span class="token punctuation">.</span><span class="token property-access">score</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>b<span class="token operator">></span>
        <span class="token punctuation">{</span><span class="token string">' '</span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>handlePlusClick<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">+</span><span class="token number">1</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">First</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>player<span class="token punctuation">.</span><span class="token property-access">firstName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleFirstNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>label<span class="token operator">></span>
        <span class="token maybe-class-name">Last</span> name<span class="token operator">:</span>
        <span class="token operator">&#x3C;</span>input
          value<span class="token operator">=</span><span class="token punctuation">{</span>player<span class="token punctuation">.</span><span class="token property-access">lastName</span><span class="token punctuation">}</span>
          onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleLastNameChange<span class="token punctuation">}</span>
        <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>label<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">label</span> <span class="token punctuation">{</span> <span class="token property">display</span><span class="token punctuation">:</span> block<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">input</span> <span class="token punctuation">{</span> <span class="token property">margin-left</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><p><code>handlePlusClick</code> の問題は、<code>player</code> オブジェクトを書き換えてしまっていたことです。その結果、React は再レンダーの必要性を認識せず、画面上のスコアは更新されませんでした。ですがファーストネームを編集すると、対応する state が更新されてレンダーがトリガされるので、その際に画面上の<em>スコアも併せて</em>最新の値になった、というわけです。<p><code>handleLastNameChange</code> の問題は、新しいオブジェクトに既存の <code>...player</code> フィールドをコピーしなかったことです。これが、ラストネームを編集した後にスコアが消えてしまった理由です。</p></solution></section><section class="level4"aria-labelledby="ミューテーションを探して修正-find-and-fix-the-mutation"><h4 id="ミューテーションを探して修正-find-and-fix-the-mutation">ミューテーションを探して修正 {/<em>find-and-fix-the-mutation</em>/}</h4><p>固定された背景の上にドラッグ可能なボックスが配置されています。ボックスの色は選択ボックスを使って変更できます。<p>しかし、バグがあります。まずボックスを移動し、次にその色を変更しようとすると、（動かないはずの）背景が、ボックスの位置まで「ジャンプ」してしまいます。<code>Background</code> の <code>position</code> プロパティは <code>initialPosition</code> に設定されており、それは <code>{ x: 0, y: 0 }</code> となっているのですから、こんなことは起きないはずではないでしょうか。どうして色を変更すると背景が動いてしまうのでしょうか。<p>バグを見つけて修正してください。</p><hint><p>予期しない変化が起きたということは、ミューテーションがあるということです。<code>App.js</code> のミューテーションを見つけて修正してください。</p></hint><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Background</span></span> <span class="token keyword module">from</span> <span class="token string">'./Background.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Box</span></span> <span class="token keyword module">from</span> <span class="token string">'./Box.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialPosition <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Canvas</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shape<span class="token punctuation">,</span> setShape<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> initialPosition
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleMove</span><span class="token punctuation">(</span><span class="token parameter">dx<span class="token punctuation">,</span> dy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">+=</span> dx<span class="token punctuation">;</span>
    shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">+=</span> dy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleColorChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setShape</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>shape<span class="token punctuation">,</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>select
        value<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleColorChange<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"orange"</span><span class="token operator">></span>orange<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"lightpink"</span><span class="token operator">></span>lightpink<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"aliceblue"</span><span class="token operator">></span>aliceblue<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>select<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Background</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>initialPosition<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Box</span>
        color<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">}</span>
        onMove<span class="token operator">=</span><span class="token punctuation">{</span>handleMove<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Drag</span> me<span class="token operator">!</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Box</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Box</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  color<span class="token punctuation">,</span>
  position<span class="token punctuation">,</span>
  onMove
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>
    lastCoordinates<span class="token punctuation">,</span>
    setLastCoordinates
  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerDown</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token method function property-access">setPointerCapture</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">pointerId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerMove</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>lastCoordinates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dx <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dy <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">;</span>
      <span class="token function">onMove</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerUp</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      onPointerDown<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerDown<span class="token punctuation">}</span>
      onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerMove<span class="token punctuation">}</span>
      onPointerUp<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerUp<span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cursor</span><span class="token operator">:</span> <span class="token string">'grab'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token string">'1px solid black'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">display</span><span class="token operator">:</span> <span class="token string">'flex'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">justifyContent</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alignItems</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
        )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Background</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  position
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
      )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'rgba(200, 200, 0, 0.2)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">280</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">select</span> <span class="token punctuation">{</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack><solution><p>問題は <code>handleMove</code> 内のミューテーションにあります。<code>shape.position</code> を書き換えていますが、それは <code>initialPosition</code> が指しているのと同一のオブジェクトです。これが、ボックスと背景が両方動いてしまった原因です。（ミューテーションをしていたためすぐには画面に反映されず、色の変更という無関係な更新により再レンダーがトリガされて初めて、位置の変化が画面に反映されたのです。）<p>修正方法は、<code>handleMove</code> からミューテーションを除去し、スプレッド構文を使って shape をコピーすることです。<code>+=</code> はミューテーションですので、通常の <code>+</code> 操作を使って書き直す必要があります。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Background</span></span> <span class="token keyword module">from</span> <span class="token string">'./Background.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Box</span></span> <span class="token keyword module">from</span> <span class="token string">'./Box.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialPosition <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Canvas</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shape<span class="token punctuation">,</span> setShape<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> initialPosition
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleMove</span><span class="token punctuation">(</span><span class="token parameter">dx<span class="token punctuation">,</span> dy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setShape</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>shape<span class="token punctuation">,</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">+</span> dx<span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">+</span> dy<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleColorChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setShape</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>shape<span class="token punctuation">,</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>select
        value<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleColorChange<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"orange"</span><span class="token operator">></span>orange<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"lightpink"</span><span class="token operator">></span>lightpink<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"aliceblue"</span><span class="token operator">></span>aliceblue<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>select<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Background</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>initialPosition<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Box</span>
        color<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">}</span>
        onMove<span class="token operator">=</span><span class="token punctuation">{</span>handleMove<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Drag</span> me<span class="token operator">!</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Box</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Box</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  color<span class="token punctuation">,</span>
  position<span class="token punctuation">,</span>
  onMove
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>
    lastCoordinates<span class="token punctuation">,</span>
    setLastCoordinates
  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerDown</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token method function property-access">setPointerCapture</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">pointerId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerMove</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>lastCoordinates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dx <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dy <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">;</span>
      <span class="token function">onMove</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerUp</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      onPointerDown<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerDown<span class="token punctuation">}</span>
      onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerMove<span class="token punctuation">}</span>
      onPointerUp<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerUp<span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cursor</span><span class="token operator">:</span> <span class="token string">'grab'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token string">'1px solid black'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">display</span><span class="token operator">:</span> <span class="token string">'flex'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">justifyContent</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alignItems</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
        )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Background</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  position
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
      )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'rgba(200, 200, 0, 0.2)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">280</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">select</span> <span class="token punctuation">{</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre></sandpack></solution></section><section class="level4"aria-labelledby="immer-を使ってオブジェクトを更新-update-an-object-with-immer"><h4 id="immer-を使ってオブジェクトを更新-update-an-object-with-immer">Immer を使ってオブジェクトを更新 {/<em>update-an-object-with-immer</em>/}</h4><p>これはひとつ前のチャレンジと同じ、バグのある例です。今回は、Immer を使ってミューテーションを修正してください。<code>useImmer</code> はすでにインポートされているので、<code>shape</code> という state 変数の部分を変更して <code>useImmer</code> を使うようにしてください。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useImmer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'use-immer'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Background</span></span> <span class="token keyword module">from</span> <span class="token string">'./Background.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Box</span></span> <span class="token keyword module">from</span> <span class="token string">'./Box.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialPosition <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Canvas</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shape<span class="token punctuation">,</span> setShape<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> initialPosition
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleMove</span><span class="token punctuation">(</span><span class="token parameter">dx<span class="token punctuation">,</span> dy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">+=</span> dx<span class="token punctuation">;</span>
    shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">+=</span> dy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleColorChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setShape</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>shape<span class="token punctuation">,</span>
      <span class="token literal-property property">color</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>select
        value<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleColorChange<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"orange"</span><span class="token operator">></span>orange<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"lightpink"</span><span class="token operator">></span>lightpink<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"aliceblue"</span><span class="token operator">></span>aliceblue<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>select<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Background</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>initialPosition<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Box</span>
        color<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">}</span>
        onMove<span class="token operator">=</span><span class="token punctuation">{</span>handleMove<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Drag</span> me<span class="token operator">!</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Box</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Box</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  color<span class="token punctuation">,</span>
  position<span class="token punctuation">,</span>
  onMove
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>
    lastCoordinates<span class="token punctuation">,</span>
    setLastCoordinates
  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerDown</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token method function property-access">setPointerCapture</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">pointerId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerMove</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>lastCoordinates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dx <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dy <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">;</span>
      <span class="token function">onMove</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerUp</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      onPointerDown<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerDown<span class="token punctuation">}</span>
      onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerMove<span class="token punctuation">}</span>
      onPointerUp<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerUp<span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cursor</span><span class="token operator">:</span> <span class="token string">'grab'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token string">'1px solid black'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">display</span><span class="token operator">:</span> <span class="token string">'flex'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">justifyContent</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alignItems</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
        )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Background</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  position
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
      )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'rgba(200, 200, 0, 0.2)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">280</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">select</span> <span class="token punctuation">{</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"immer"</span><span class="token operator">:</span> <span class="token string">"1.7.3"</span><span class="token punctuation">,</span>
    <span class="token property">"react"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"use-immer"</span><span class="token operator">:</span> <span class="token string">"0.5.1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"react-scripts start"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"react-scripts build"</span><span class="token punctuation">,</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"react-scripts test --env=jsdom"</span><span class="token punctuation">,</span>
    <span class="token property">"eject"</span><span class="token operator">:</span> <span class="token string">"react-scripts eject"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack><solution><p>以下が Immer で書き直した解法です。イベントハンドラがミューテーション形式の書き方になっていますが、バグは発生しないことに注目しましょう。これは、Immer は実際には裏側で、既存のオブジェクトが決して書き換わらないようにしているためです。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useImmer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'use-immer'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Background</span></span> <span class="token keyword module">from</span> <span class="token string">'./Background.js'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Box</span></span> <span class="token keyword module">from</span> <span class="token string">'./Box.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> initialPosition <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Canvas</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>shape<span class="token punctuation">,</span> updateShape<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useImmer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'orange'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">position</span><span class="token operator">:</span> initialPosition
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleMove</span><span class="token punctuation">(</span><span class="token parameter">dx<span class="token punctuation">,</span> dy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateShape</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      draft<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">x</span> <span class="token operator">+=</span> dx<span class="token punctuation">;</span>
      draft<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">.</span><span class="token property-access">y</span> <span class="token operator">+=</span> dy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleColorChange</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">updateShape</span><span class="token punctuation">(</span><span class="token parameter">draft</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      draft<span class="token punctuation">.</span><span class="token property-access">color</span> <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>select
        value<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onChange<span class="token operator">=</span><span class="token punctuation">{</span>handleColorChange<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"orange"</span><span class="token operator">></span>orange<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"lightpink"</span><span class="token operator">></span>lightpink<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>option value<span class="token operator">=</span><span class="token string">"aliceblue"</span><span class="token operator">></span>aliceblue<span class="token operator">&#x3C;</span><span class="token operator">/</span>option<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>select<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Background</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>initialPosition<span class="token punctuation">}</span>
      <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Box</span>
        color<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        position<span class="token operator">=</span><span class="token punctuation">{</span>shape<span class="token punctuation">.</span><span class="token property-access">position</span><span class="token punctuation">}</span>
        onMove<span class="token operator">=</span><span class="token punctuation">{</span>handleMove<span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Drag</span> me<span class="token operator">!</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Box</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Box</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  children<span class="token punctuation">,</span>
  color<span class="token punctuation">,</span>
  position<span class="token punctuation">,</span>
  onMove
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>
    lastCoordinates<span class="token punctuation">,</span>
    setLastCoordinates
  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerDown</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token property-access">target</span><span class="token punctuation">.</span><span class="token method function property-access">setPointerCapture</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">pointerId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
      <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerMove</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>lastCoordinates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">x</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span><span class="token punctuation">,</span>
        <span class="token literal-property property">y</span><span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dx <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientX</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dy <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token property-access">clientY</span> <span class="token operator">-</span> lastCoordinates<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">;</span>
      <span class="token function">onMove</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handlePointerUp</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setLastCoordinates</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div
      onPointerDown<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerDown<span class="token punctuation">}</span>
      onPointerMove<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerMove<span class="token punctuation">}</span>
      onPointerUp<span class="token operator">=</span><span class="token punctuation">{</span>handlePointerUp<span class="token punctuation">}</span>
      style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cursor</span><span class="token operator">:</span> <span class="token string">'grab'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> color<span class="token punctuation">,</span>
        <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">border</span><span class="token operator">:</span> <span class="token string">'1px solid black'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">display</span><span class="token operator">:</span> <span class="token string">'flex'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">justifyContent</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">alignItems</span><span class="token operator">:</span> <span class="token string">'center'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
          </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
        )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">></span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Background</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>
  position
<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div style<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>
      <span class="token literal-property property">position</span><span class="token operator">:</span> <span class="token string">'absolute'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">transform</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate(
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px,
        </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px
      )</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">250</span><span class="token punctuation">,</span>
      <span class="token literal-property property">backgroundColor</span><span class="token operator">:</span> <span class="token string">'rgba(200, 200, 0, 0.2)'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><pre class="language-css"><code class="language-css"><span class="token selector">body</span> <span class="token punctuation">{</span> <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">280</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token selector">select</span> <span class="token punctuation">{</span> <span class="token property">margin-bottom</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token unit">px</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></code></pre><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"immer"</span><span class="token operator">:</span> <span class="token string">"1.7.3"</span><span class="token punctuation">,</span>
    <span class="token property">"react"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"latest"</span><span class="token punctuation">,</span>
    <span class="token property">"use-immer"</span><span class="token operator">:</span> <span class="token string">"0.5.1"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"react-scripts start"</span><span class="token punctuation">,</span>
    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"react-scripts build"</span><span class="token punctuation">,</span>
    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"react-scripts test --env=jsdom"</span><span class="token punctuation">,</span>
    <span class="token property">"eject"</span><span class="token operator">:</span> <span class="token string">"react-scripts eject"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack></solution><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></deepdive></section></deepdive></section></section>