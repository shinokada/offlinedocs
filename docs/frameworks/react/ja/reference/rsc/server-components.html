<!doctype html><html lang="ja"><meta charset="utf-8"><title>React Server Components</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="react-server-components"><h1 id="react-server-components">React Server Components</h1><p>canary: true</p><intro><p>サーバコンポーネントは新しいタイプのコンポーネントです。クライアントアプリケーションや SSR サーバとは別の環境で、バンドル前に事前にレンダーされます。</p></intro><p>React Server Components の "server" とはこの別の環境を指しています。サーバコンポーネントは、CI サーバでビルド時に一度だけ実行することも、ウェブサーバを使用してリクエストごとに実行することもできます。</p><inlinetoc><note><section class="level4"aria-labelledby="サーバコンポーネントのサポートを追加する方法-how-do-i-build-support-for-server-components"><h4 id="サーバコンポーネントのサポートを追加する方法-how-do-i-build-support-for-server-components">サーバコンポーネントのサポートを追加する方法 {/<em>how-do-i-build-support-for-server-components</em>/}</h4><p>React 19 の React Server Components は安定しており、マイナーバージョン間での破壊的変更はありませんが、サーバコンポーネントのバンドラやフレームワークを実装するために使用される基盤となる API は semver に従いません。React 19.x のマイナーバージョン間で変更が生じる可能性があります。<p>React Server Components をバンドラやフレームワークでサポートする場合は、特定の React バージョンに固定するか、Canary リリースを使用することをお勧めします。React Server Components を実装するために使用される API を安定化させるため、今後もバンドラやフレームワークと連携を続けていきます。</section></note><section class="level3"aria-labelledby="サーバを使用しないサーバコンポーネント-server-components-without-a-server"><h3 id="サーバを使用しないサーバコンポーネント-server-components-without-a-server">サーバを使用しないサーバコンポーネント {/<em>server-components-without-a-server</em>/}</h3><p>サーバコンポーネントはビルド時に実行でき、ファイルシステムから読み取ったり静的なコンテンツをフェッチしたりすることが可能です。したがってウェブサーバは必須ではありません。たとえばコンテンツ管理システムから静的データを読み取ることもできるでしょう。<p>サーバコンポーネントがない場合、静的データは一般的に、クライアントでエフェクトを使って以下のようにフェッチします。<pre class="language-js"><code class="language-js"><span class="token comment">// bundle.js</span>
<span class="token keyword module">import</span> <span class="token imports">marked</span> <span class="token keyword module">from</span> <span class="token string">'marked'</span><span class="token punctuation">;</span> <span class="token comment">// 35.9K (11.2K gzipped)</span>
<span class="token keyword module">import</span> <span class="token imports">sanitizeHtml</span> <span class="token keyword module">from</span> <span class="token string">'sanitize-html'</span><span class="token punctuation">;</span> <span class="token comment">// 206K (63.3K gzipped)</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Page</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>page<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>content<span class="token punctuation">,</span> setContent<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// NOTE: loads *after* first page render.</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/content/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setContent</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token property-access">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>page<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token punctuation">{</span><span class="token function">sanitizeHtml</span><span class="token punctuation">(</span><span class="token function">marked</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// api.js</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/content/:page</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> page <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token property-access">params</span><span class="token punctuation">.</span><span class="token property-access">page</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword control-flow">await</span> file<span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.md</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>content<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>このパターンを使用すると、ページの表示期間中に変化しない静的なコンテンツをただレンダーするためだけに、ユーザは 75K（gzip 後）のライブラリを追加でダウンロードしてパースし、さらにページのロード後に別のリクエストがデータをフェッチしてくるのを待つ必要があることになります。<p>サーバコンポーネントを使用することで、これらのコンポーネントをビルド時に一度だけレンダーすることができます。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">marked</span> <span class="token keyword module">from</span> <span class="token string">'marked'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in bundle</span>
<span class="token keyword module">import</span> <span class="token imports">sanitizeHtml</span> <span class="token keyword module">from</span> <span class="token string">'sanitize-html'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in bundle</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Page</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>page<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: loads *during* render, when the app is built.</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword control-flow">await</span> file<span class="token punctuation">.</span><span class="token method function property-access">readFile</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.md</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token punctuation">{</span><span class="token function">sanitizeHtml</span><span class="token punctuation">(</span><span class="token function">marked</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>このレンダー出力は、サーバサイドレンダリング (SSR) で HTML に変換され、CDN にアップロードできます。アプリがロードされる際、クライアントには元の <code>Page</code> コンポーネントの存在や、Markdown をレンダーするための高コストなライブラリの存在は見えません。レンダーされた出力が見えるだけです。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">!</span><span class="token operator">--</span> html <span class="token keyword control-flow">for</span> markdown <span class="token operator">--</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span></code></pre><p>つまり、コンテンツは最初のページロード時にすぐ表示され、静的コンテンツをレンダーするためだけの高コストなライブラリをバンドルに含めなくともよくなるのです。</p><note><p>上記のサーバコンポーネントが非同期関数であることに気付かれたかもしれません。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Page</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>page<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span></code></pre><p>非同期コンポーネントは、レンダー中に <code>await</code> できるというサーバコンポーネントの新機能です。<p>以下の<a href="#async-components-with-server-components">サーバコンポーネントでの非同期コンポーネント処理</a>を参照してください。</p></note></section><section class="level3"aria-labelledby="サーバを使用するサーバコンポーネント-server-components-with-a-server"><h3 id="サーバを使用するサーバコンポーネント-server-components-with-a-server">サーバを使用するサーバコンポーネント {/<em>server-components-with-a-server</em>/}</h3><p>サーバコンポーネントは、ページのリクエスト時にウェブサーバ内で実行することも可能であり、これにより API を構築することなくデータレイヤにアクセスできます。アプリケーションがバンドルされる前にレンダーされ、データと JSX をクライアントコンポーネントに props として渡すことができます。<p>サーバコンポーネントがない場合、一般的には以下のようにして、動的データをクライアントでエフェクトを使ってフェッチします。<pre class="language-js"><code class="language-js"><span class="token comment">// bundle.js</span>
<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Note</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>note<span class="token punctuation">,</span> setNote<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// NOTE: loads *after* first render.</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/notes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setNote</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token property-access">note</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Author</span> id<span class="token operator">=</span><span class="token punctuation">{</span>note<span class="token punctuation">.</span><span class="token property-access">authorId</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token punctuation">{</span>note<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Author</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>author<span class="token punctuation">,</span> setAuthor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// NOTE: loads *after* Note renders.</span>
  <span class="token comment">// Causing an expensive client-server waterfall.</span>
  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/authors/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">setAuthor</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token property-access">author</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>span<span class="token operator">></span><span class="token maybe-class-name">By</span><span class="token operator">:</span> <span class="token punctuation">{</span>author<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// api</span>
<span class="token keyword module">import</span> <span class="token imports">db</span> <span class="token keyword module">from</span> <span class="token string">'./database'</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/notes/:id</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">notes</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>note<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/authors/:id</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> author <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">authors</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>author<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>サーバコンポーネントを使用することで、コンポーネントの中で直接データを読み取ってレンダーできます。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">db</span> <span class="token keyword module">from</span> <span class="token string">'./database'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Note</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: loads *during* render.</span>
  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">notes</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Author</span> id<span class="token operator">=</span><span class="token punctuation">{</span>note<span class="token punctuation">.</span><span class="token property-access">authorId</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token punctuation">{</span>note<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Author</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: loads *after* Note,</span>
  <span class="token comment">// but is fast if data is co-located.</span>
  <span class="token keyword">const</span> author <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">authors</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>span<span class="token operator">></span><span class="token maybe-class-name">By</span><span class="token operator">:</span> <span class="token punctuation">{</span>author<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>span<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>この後バンドラは、データ、レンダー済みのサーバコンポーネント、および動的なクライアントコンポーネントをバンドルとして結合します。オプションとして、そのバンドルをサーバサイドレンダリング (SSR) して、ページの初期 HTML を作成できます。ページがロードされると、ブラウザには元の <code>Note</code> および <code>Author</code> コンポーネントの存在は見えません。クライアントにはレンダーされた出力のみが送信されます。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>div<span class="token operator">></span>
  <span class="token operator">&#x3C;</span>span<span class="token operator">></span><span class="token maybe-class-name">By</span><span class="token operator">:</span> <span class="token maybe-class-name">The</span> <span class="token maybe-class-name">React</span> <span class="token maybe-class-name">Team</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>span<span class="token operator">></span>
  <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">React</span> <span class="token number">19</span> is<span class="token spread operator">...</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span></code></pre><p>サーバコンポーネントをサーバから再フェッチして、サーバではデータにアクセスして再レンダーする、という形で、サーバコンポーネントを動的に扱うことができます。この新しいアプリケーションアーキテクチャは、サーバセントリックなマルチページアプリにおける単純な「リクエスト/レスポンス」式のメンタルモデルと、クライアントセントリックなシングルページアプリケーションにおけるシームレスな操作性を組み合わせ、両方の利点を提供できるものです。</section><section class="level3"aria-labelledby="サーバコンポーネントにインタラクティビティを追加する-adding-interactivity-to-server-components"><h3 id="サーバコンポーネントにインタラクティビティを追加する-adding-interactivity-to-server-components">サーバコンポーネントにインタラクティビティを追加する {/<em>adding-interactivity-to-server-components</em>/}</h3><p>サーバコンポーネントはブラウザに送信されないため、<code>useState</code> のようなインタラクティブな API を使用できません。サーバコンポーネントにインタラクティビティを追加するには、<code>"use client"</code> ディレクティブを使用してクライアントコンポーネントと組み合わせます。</p><note><section class="level4"aria-labelledby="サーバコンポーネントのためのディレクティブはない-there-is-no-directive-for-server-components"><h4 id="サーバコンポーネントのためのディレクティブはない-there-is-no-directive-for-server-components">サーバコンポーネントのためのディレクティブはない {/<em>there-is-no-directive-for-server-components</em>/}</h4><p>よくある誤解として、サーバコンポーネントを "use server" を用いて定義するものだと考えるというものがあります。サーバコンポーネントにはディレクティブがありません。"use server" ディレクティブは、サーバアクションのためのものです。<p>詳細については、<a href="/reference/rsc/directives">ディレクティブ</a> のドキュメントをご覧ください。</section></note><p>以下の例では、サーバコンポーネントである <code>Notes</code> がクライアントコンポーネントである <code>Expandable</code> をインポートしており、そこで state を使用して <code>expanded</code> をトグルしています。<pre class="language-js"><code class="language-js"><span class="token comment">// Server Component</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">Expandable</span></span> <span class="token keyword module">from</span> <span class="token string">'./Expandable'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Notes</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> notes <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">notes</span><span class="token punctuation">.</span><span class="token method function property-access">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token punctuation">{</span>notes<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">note</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Expandable</span> key<span class="token operator">=</span><span class="token punctuation">{</span>note<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span>p note<span class="token operator">=</span><span class="token punctuation">{</span>note<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Expandable</span><span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Client Component</span>
<span class="token string">"use client"</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Expandable</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>children<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>expanded<span class="token punctuation">,</span> setExpanded<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setExpanded</span><span class="token punctuation">(</span><span class="token operator">!</span>expanded<span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">></span>
        <span class="token maybe-class-name">Toggle</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token punctuation">{</span>expanded <span class="token operator">&#x26;&#x26;</span> children<span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>動作としては、最初に <code>Notes</code> がサーバコンポーネントとしてレンダーされ、次にバンドラに <code>Expandable</code> というクライアントコンポーネントのバンドルを作成するよう指示しています。ブラウザ側では、クライアントコンポーネントには props 経由で渡されるサーバコンポーネントの出力だけが見えることになります。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span>head<span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token operator">!</span><span class="token operator">--</span> the bundle <span class="token keyword control-flow">for</span> <span class="token maybe-class-name">Client</span> <span class="token maybe-class-name">Components</span> <span class="token operator">--</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span>script src<span class="token operator">=</span><span class="token string">"bundle.js"</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
<span class="token operator">&#x3C;</span>body<span class="token operator">></span>
  <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Expandable</span> key<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token keyword">this</span> is the first note<span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Expandable</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Expandable</span> key<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token keyword">this</span> is the second note<span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Expandable</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token spread operator">...</span><span class="token operator">--</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span> 
<span class="token operator">&#x3C;</span><span class="token operator">/</span>body<span class="token operator">></span></code></pre></section><section class="level3"aria-labelledby="サーバコンポーネントでの非同期コンポーネント処理-async-components-with-server-components"><h3 id="サーバコンポーネントでの非同期コンポーネント処理-async-components-with-server-components">サーバコンポーネントでの非同期コンポーネント処理 {/<em>async-components-with-server-components</em>/}</h3><p>サーバコンポーネントにより、async/await を使用してコンポーネントを書くという新しい手法が導入されます。非同期コンポーネント内で <code>await</code> すると、React はサスペンド (suspend) し、プロミスが解決 (resolve) されるのを待ってからレンダーを再開します。サスペンスのストリーミングサポートのおかげで、これはサーバ／クライアントの境界をまたいで機能します。<p>サーバでプロミスを作成し、それをクライアント側で待機することすら可能です。<pre class="language-js"><code class="language-js"><span class="token comment">// Server Component</span>
<span class="token keyword module">import</span> <span class="token imports">db</span> <span class="token keyword module">from</span> <span class="token string">'./database'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Page</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Will suspend the Server Component.</span>
  <span class="token keyword">const</span> note <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">notes</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// NOTE: not awaited, will start here and await on the client. </span>
  <span class="token keyword">const</span> commentsPromise <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token property-access">comments</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>note<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
      <span class="token punctuation">{</span>note<span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Loading</span> <span class="token maybe-class-name">Comments</span><span class="token spread operator">...</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Comments</span> commentsPromise<span class="token operator">=</span><span class="token punctuation">{</span>commentsPromise<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Client Component</span>
<span class="token string">"use client"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>use<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Comments</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>commentsPromise<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// NOTE: this will resume the promise from the server.</span>
  <span class="token comment">// It will suspend until the data is available.</span>
  <span class="token keyword">const</span> comments <span class="token operator">=</span> <span class="token function">use</span><span class="token punctuation">(</span>commentsPromise<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> comments<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">commment</span> <span class="token arrow operator">=></span> <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token punctuation">{</span>comment<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>note</code> の内容はページをレンダーするために重要なデータなので、サーバ側で <code>await</code> します。コメントは折りたたまれており優先度が低いため、サーバではプロミスを開始だけして、クライアントで <code>use</code> API を使用してそれを待機します。これによりクライアント側でサスペンドが起きますが、<code>note</code> の内容のレンダーをブロックしないで済みます。<p>非同期コンポーネントは<a href="#why-cant-i-use-async-components-on-the-client">クライアントではサポートされていない</a> ため、プロミスの待機は <code>use</code> を使用して行います。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></inlinetoc></section>