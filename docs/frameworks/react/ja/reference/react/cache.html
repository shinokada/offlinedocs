<!doctype html><html lang="ja"><meta charset="utf-8"><title>cache</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="cache"><h1 id="cache">cache</h1><p>canary: true</p><canary>* `cache` は、[React サーバコンポーネント](/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-server-components)で使用するためのものです。React サーバコンポーネントをサポートする[フレームワーク](https://react.dev/learn/start-a-new-react-project#bleeding-edge-react-frameworks)をご覧ください。<ul><li><code>cache</code> は、React の <a href="/community/versioning-policy#canary-channel">Canary</a> と <a href="/community/versioning-policy#experimental-channel">experimental</a> チャンネルでのみ利用可能です。本番環境で <code>cache</code> を使用する前に、制限事項を理解してください。<a href="/community/versioning-policy#all-release-channels">React のリリースチャンネルについてはこちら</a>をご覧ください。</ul><intro><p><code>cache</code> を使い、データフェッチや計算結果をキャッシュすることができます。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cachedFn <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="リファレンス-reference"><h2 id="リファレンス-reference">リファレンス {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="cachefn-cache"><h3 id="cachefn-cache"><code>cache(fn)</code> {/<em>cache</em>/}</h3><p>コンポーネントの外部で <code>cache</code> を呼び出して、キャッシュが有効化されたバージョンの関数を作成します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">calculateMetrics</span> <span class="token keyword module">from</span> <span class="token string">'lib/metrics'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getMetrics <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Chart</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>data<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getMetrics</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><code>getMetrics</code> が初めて <code>data</code> とともに呼び出されると、<code>getMetrics</code> は <code>calculateMetrics(data)</code> を呼び出し、その結果をキャッシュに保存します。もし <code>getMetrics</code> が同じ <code>data</code> で再度呼び出されると、<code>calculateMetrics(data)</code> を再度呼び出す代わりにキャッシュされた結果を返します。<p><a href="#usage">さらに例を見る</a><section class="level4"aria-labelledby="引数-parameters"><h4 id="引数-parameters">引数 {/<em>parameters</em>/}</h4><ul><li><code>fn</code>: 結果をキャッシュしたい関数。<code>fn</code> は任意の引数を取り、任意の値を返すことができます。</ul></section><section class="level4"aria-labelledby="返り値-returns"><h4 id="返り値-returns">返り値 {/<em>returns</em>/}</h4><p><code>cache</code> は、同じ型シグネチャを持ち、キャッシュが有効化されたバージョンの <code>fn</code> を返します。その際に <code>fn</code> 自体は呼び出されません。<p>何らかの引数で <code>cachedFn</code> を呼び出すと、まずキャッシュにキャッシュ済みの結果が存在するかどうかを確認します。キャッシュ済みの結果が存在する場合、その結果を返します。存在しない場合、与えられた引数で <code>fn</code> を呼び出し、結果をキャッシュに保存し、その結果を返します。<code>fn</code> が呼び出されるのはキャッシュミスが発生したときだけです。</p><note><p>入力に基づいて返り値をキャッシュする最適化は、<a href="https://en.wikipedia.org/wiki/Memoization"><em>メモ化 (memoization)</em></a> として知られています。<code>cache</code> から返される関数をメモ化された関数 (memoized function) と呼びます。</p></note></section><section class="level4"aria-labelledby="注意点-caveats"><h4 id="注意点-caveats">注意点 {/<em>caveats</em>/}</h4><ul><li>React は、サーバへの各リクエストごとにすべてのメモ化された関数のキャッシュを無効化します。<li><code>cache</code> を呼び出すたびに新しい関数が作成されます。これは、同じ関数で <code>cache</code> を複数回呼び出すと、同じキャッシュを共有しない異なるメモ化された関数が返されることを意味します。<li><code>cachedFn</code> はエラーもキャッシュします。特定の引数で <code>fn</code> がエラーをスローすると、それがキャッシュされ、同じ引数で <code>cachedFn</code> が呼び出されると同じエラーが再スローされます。<li><code>cache</code> は、<a href="/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-server-components">サーバコンポーネント</a>でのみ使用できます。</ul></section></section></section><section class="level2"aria-labelledby="使用法-usage"><h2 id="使用法-usage">使用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="高コストな計算をキャッシュする-cache-expensive-computation"><h3 id="高コストな計算をキャッシュする-cache-expensive-computation">高コストな計算をキャッシュする {/<em>cache-expensive-computation</em>/}</h3><p>重複する処理をスキップするために <code>cache</code> を使用します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">calculateUserMetrics</span> <span class="token keyword module">from</span> <span class="token string">'lib/user'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getUserMetrics <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateUserMetrics<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Profile</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token function">getUserMetrics</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TeamReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>users<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> user <span class="token keyword">in</span> users<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> metrics <span class="token operator">=</span> <span class="token function">getUserMetrics</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>同じ <code>user</code> オブジェクトが <code>Profile</code> と <code>TeamReport</code> の両方でレンダーされる場合、2 つのコンポーネントは処理を共有でき、その <code>user</code> に対して <code>calculateUserMetrics</code> が一度だけ呼び出されるようになります。<p>最初に <code>Profile</code> がレンダーされると仮定します。<codestep step="{1}"><code>getUserMetrics</code></codestep>が呼び出され、キャッシュされた結果があるかどうかを確認します。その <code>user</code> で <code>getUserMetrics</code> を呼び出すのは初めてなので、キャッシュミスが発生します。<code>getUserMetrics</code> はその後、その <code>user</code> で <code>calculateUserMetrics</code> を呼び出し、結果をキャッシュに書き込みます。<p><code>TeamReport</code> が <code>users</code> のリストをレンダーし、同じ <code>user</code> オブジェクトに到達すると、<codestep step="{2}"><code>getUserMetrics</code></codestep>を呼び出し、結果をキャッシュから読み取ります。</p><pitfall><section class="level5"aria-labelledby="メモ化された関数を複数作って呼び出すと異なるキャッシュから読み取られる-pitfall-different-memoized-functions"><h5 id="メモ化された関数を複数作って呼び出すと異なるキャッシュから読み取られる-pitfall-different-memoized-functions">メモ化された関数を複数作って呼び出すと異なるキャッシュから読み取られる {/<em>pitfall-different-memoized-functions</em>/}</h5><p>同じキャッシュにアクセスするためには、コンポーネントは同じメモ化された関数を呼び出さなければなりません。<pre class="language-js"><code class="language-js"><span class="token comment">// Temperature.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>calculateWeekReport<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./report'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Temperature</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 🚩 Wrong: Calling `cache` in component creates new `getWeekReport` for each render</span>
  <span class="token keyword">const</span> getWeekReport <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateWeekReport<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Precipitation.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>calculateWeekReport<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./report'</span><span class="token punctuation">;</span>

<span class="token comment">// 🚩 Wrong: `getWeekReport` is only accessible for `Precipitation` component.</span>
<span class="token keyword">const</span> getWeekReport <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateWeekReport<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Precipitation</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>上記の例では、<codestep step="{2}"><code>Precipitation</code></codestep>と<codestep step="{1}"><code>Temperature</code></codestep>はそれぞれ <code>cache</code> を呼び出して、それぞれ独自のキャッシュテーブルを持つ新しいメモ化された関数を作成しています。両方のコンポーネントが同じ <code>cityData</code> でレンダーする場合、それぞれが <code>calculateWeekReport</code> を呼び出すため、重複した処理が行われることになります。<p>さらに、<code>Temperature</code> はコンポーネントがレンダーされるたびに<codestep step="{1}">新しいメモ化された関数</codestep>を作成しているため、キャッシュによる共有はそもそも一切行えません。<p>キャッシュヒットを最大化し、処理を減らすためには、2 つのコンポーネントは同じメモ化された関数を呼び出して同じキャッシュにアクセスするべきです。上記のようにするのではなく、複数のコンポーネントから <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import"><code>import</code></a> が行えるよう、メモ化された関数をそれ専用のモジュールで定義してください。<pre class="language-js"><code class="language-js"><span class="token comment">// getWeekReport.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>calculateWeekReport<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./report'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">cache</span><span class="token punctuation">(</span>calculateWeekReport<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Temperature.js</span>
<span class="token keyword module">import</span> <span class="token imports">getWeekReport</span> <span class="token keyword module">from</span> <span class="token string">'./getWeekReport'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Temperature</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Precipitation.js</span>
<span class="token keyword module">import</span> <span class="token imports">getWeekReport</span> <span class="token keyword module">from</span> <span class="token string">'./getWeekReport'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Precipitation</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>cityData<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">getWeekReport</span><span class="token punctuation">(</span>cityData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>これで、両方のコンポーネントが <code>./getWeekReport.js</code> からエクスポートされた<codestep step="{3}">同じメモ化された関数</codestep>を呼び出して、同じキャッシュを読み書きするようになります。</section></pitfall></section><section class="level3"aria-labelledby="データのスナップショットを共有する-take-and-share-snapshot-of-data"><h3 id="データのスナップショットを共有する-take-and-share-snapshot-of-data">データのスナップショットを共有する {/<em>take-and-share-snapshot-of-data</em>/}</h3><p>コンポーネント間でデータのスナップショットを共有するためには、<code>fetch</code> のようなデータ取得関数を引数にして <code>cache</code> を呼び出します。複数のコンポーネントが同じデータを取得すると、リクエストは 1 回だけ行われ、返されたデータはキャッシュされ、コンポーネント間で共有されます。すべてのコンポーネントはサーバレンダー全体で同一のデータスナップショットを参照します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>fetchTemperature<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./api.js'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getTemperature <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">city</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
	<span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> <span class="token function">fetchTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">AnimatedWeatherCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MinimalWeatherCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><code>AnimatedWeatherCard</code> と <code>MinimalWeatherCard</code> の両方が同じ<codestep step="{1}">city</codestep>でレンダーする場合、<codestep step="{2}">メモ化された関数</codestep>から同じデータのスナップショットを受け取ります。<p><code>AnimatedWeatherCard</code> と <code>MinimalWeatherCard</code> が異なる<codestep step="{1}">city</codestep>引数を<codestep step="{2}"><code>getTemperature</code></codestep>に渡した場合、<code>fetchTemperature</code> は 2 回呼び出され、それぞれの呼び出しが異なるデータを受け取ります。<p><codestep step="{1}">city</codestep>はキャッシュキーとして機能します。</p><note><p><codestep step="{3}">非同期レンダー</codestep>はサーバコンポーネントでのみサポートされています。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">AnimatedWeatherCard</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> temperature <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getTemperature</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre></note></section><section class="level3"aria-labelledby="データをプリロードする-preload-data"><h3 id="データをプリロードする-preload-data">データをプリロードする {/<em>preload-data</em>/}</h3><p>時間のかかるデータ取得をキャッシュすることで、コンポーネントのレンダー前に非同期処理を開始することができます。<pre class="language-jsx"><code class="language-jsx"><span class="token keyword">const</span> getUser <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Profile</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>section</span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>img</span> <span class="token attr-name">src</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">.</span><span class="token property-access">profilePic</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>h2</span><span class="token punctuation">></span></span><span class="token punctuation">{</span>user<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>h2</span><span class="token punctuation">></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>section</span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Page</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Good: start fetching the user data</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... some computational work</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">Profile</span></span> <span class="token attr-name">id</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>id<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>Page</code> のレンダー時にコンポーネントは<codestep step="{1}"><code>getUser</code></codestep>を呼び出していますが、返されたデータを使用していないことに着目してください。この早期の<codestep step="{1}"><code>getUser</code></codestep>呼び出しは、<code>Page</code> が他の計算処理を行ったり子をレンダーしたりしている間に実行される、非同期のデータベースクエリを開始します。<p><code>Profile</code> をレンダーするとき、再び<codestep step="{2}"><code>getUser</code></codestep>を呼び出します。最初の<codestep step="{1}"><code>getUser</code></codestep>呼び出しがすでに完了しユーザデータをキャッシュしている場合、<code>Profile</code> が<codestep step="{2}">このデータを要求して待機する時点</codestep>では、新たなリモートプロシージャ呼び出しを必要とせずにキャッシュから単に読み取ることができます。もし<codestep step="{1}">最初のデータリクエスト</codestep>がまだ完了していない場合でも、このパターンでデータをプリロードすることで、データ取得の遅延を減らすことができます。</p><deepdive><section class="level4"aria-labelledby="非同期処理のキャッシュ-caching-asynchronous-work"><h4 id="非同期処理のキャッシュ-caching-asynchronous-work">非同期処理のキャッシュ {/<em>caching-asynchronous-work</em>/}</h4><p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function">非同期関数</a>を評価すると、その処理の<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">プロミス (Promise)</a> を受け取ります。プロミスはその処理の状態 (<em>pending</em>、<em>fulfilled</em>、<em>failed</em>) とその最終的な結果を保持します。<p>この例では、非同期関数<codestep step="{1}"><code>fetchData</code></codestep>は <code>fetch</code> 結果を待機するプロミスを返します。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> getData <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>fetchData<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MyComponent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... some computational work  </span>
  <span class="token keyword control-flow">await</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>最初の<codestep step="{2}"><code>getData</code></codestep>呼び出しでは、<codestep step="{1}"><code>fetchData</code></codestep>から返されたプロミスがキャッシュされます。その後のキャッシュ探索では、同じプロミスが返されます。<p>最初の<codestep step="{2}"><code>getData</code></codestep>呼び出しでは <code>await</code> しておらず、<codestep step="{3}">2 回目の呼び出し</codestep>では <code>await</code> していることに注目してください。<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/await"><code>await</code></a> は JavaScript の演算子であり、プロミスの結果を待機して返します。最初の<codestep step="{2}"><code>getData</code></codestep>呼び出しは単に <code>fetch</code> を開始してプロミスをキャッシュし、2 回目の<codestep step="{3}"><code>getData</code></codestep>のときに見つかるようにしているのです。<p><codestep step="{3}">2 回目の呼び出し</codestep>時点でプロミスがまだ <em>pending</em> の場合、<code>await</code> は結果を待ちます。<code>fetch</code> を待っている間に React が計算処理を続けることができるため、<codestep step="{3}">2 回目の呼び出し</codestep>の待ち時間を短縮できる、という最適化になります。<p>プロミスの最終状態がすでに決定 (settled) している場合、結果がエラーの場合でも正常終了 (fulfilled) の場合でも、<code>await</code> はその値をすぐに返します。どちらの結果でも、パフォーマンス上の利点があります。</p><pitfall><section class="level5"aria-labelledby="メモ化された関数をコンポーネント外で呼び出すとキャッシュは使用されない-pitfall-memoized-call-outside-component"><h5 id="メモ化された関数をコンポーネント外で呼び出すとキャッシュは使用されない-pitfall-memoized-call-outside-component">メモ化された関数をコンポーネント外で呼び出すとキャッシュは使用されない {/<em>pitfall-memoized-call-outside-component</em>/}</h5><pre class="language-jsx"><code class="language-jsx"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> getUser <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token property-access">user</span><span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 🚩 Wrong: Calling memoized function outside of component will not memoize.</span>
<span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">'demo-id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">DemoProfile</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Good: `getUser` will memoize.</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">'demo-id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">Profile</span></span> <span class="token attr-name">user</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>user<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React がメモ化された関数に対してキャッシュアクセスを提供するのはコンポーネント内のみです。コンポーネントの外部で<codestep step="{1}"><code>getUser</code></codestep>を呼び出した場合も関数は評価されますが、キャッシュは読み取られず、更新もされません。<p>これは、キャッシュアクセスがコンポーネントからのみアクセス可能な<a href="/learn/passing-data-deeply-with-context">コンテクスト</a>を通じて提供されるためです。</p><deepdive></deepdive></section></pitfall></section><section class="level4"aria-labelledby="cachememousememo-のどれをいつ使うべきか-cache-memo-usememo"><h4 id="cachememousememo-のどれをいつ使うべきか-cache-memo-usememo"><code>cache</code>、<a href="/reference/react/memo"><code>memo</code></a>、<a href="/reference/react/useMemo"><code>useMemo</code></a> のどれをいつ使うべきか {/<em>cache-memo-usememo</em>/}</h4><p>上記のすべての API はメモ化を提供しますが、それらが何をメモ化することを意図しているか、誰がキャッシュにアクセスできるか、そしてキャッシュが無効になるタイミングはいつか、という点で違いがあります。</section><section class="level4"aria-labelledby="usememo-deep-dive-use-memo"><h4 id="usememo-deep-dive-use-memo"><code>useMemo</code> {/<em>deep-dive-use-memo</em>/}</h4><p>一般的に、<a href="/reference/react/useMemo"><code>useMemo</code></a> は、レンダー間でクライアントコンポーネント内の高コストな計算をキャッシュするために使用すべきです。例えば、コンポーネント内のデータの変換をメモ化するために使用します。<pre class="language-jsx"><code class="language-jsx"><span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">WeatherReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> avgTemp <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">calculateAvg</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token function">getRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span></span><span class="token punctuation">></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">WeatherReport</span></span> <span class="token attr-name">record</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span><span class="token class-name">WeatherReport</span></span> <span class="token attr-name">record</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text">
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span></span><span class="token punctuation">></span></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>この例では、<code>App</code> は同じレコードで 2 つの <code>WeatherReport</code> をレンダーしています。両方のコンポーネントが同じ処理を行っていますが、処理を共有することはできません。<code>useMemo</code> のキャッシュはコンポーネントのローカルにしか存在しません。<p>しかし <code>useMemo</code> は、<code>App</code> が再レンダーされるが <code>record</code> オブジェクトが変わらない場合に、コンポーネントの各インスタンスが処理をスキップしてメモ化された <code>avgTemp</code> 値を使用できるようにします。<code>useMemo</code> は、与えられた依存配列に対応する <code>avgTemp</code> の最後の計算結果のみをキャッシュします。</section><section class="level4"aria-labelledby="cache-deep-dive-cache"><h4 id="cache-deep-dive-cache"><code>cache</code> {/<em>deep-dive-cache</em>/}</h4><p>一般的に、<code>cache</code> は、コンポーネント間で共有できる処理をメモ化するために、サーバコンポーネントで使用すべきです。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cachedFetchReport <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span>fetchReport<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">WeatherReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>city<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token function">cachedFetchReport</span><span class="token punctuation">(</span>city<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> city <span class="token operator">=</span> <span class="token string">"Los Angeles"</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">WeatherReport</span> city<span class="token operator">=</span><span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">WeatherReport</span> city<span class="token operator">=</span><span class="token punctuation">{</span>city<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>前の例を <code>cache</code> を使用して書き直すと、この場合<codestep step="{3}">2 番目の <code>WeatherReport</code> インスタンス</codestep>は重複する処理をスキップし、<codestep step="{1}">最初の <code>WeatherReport</code></codestep>と同じキャッシュから読み取ることができます。前の例とのもうひとつの違いは、<code>cache</code> が<codestep step="{2}">データフェッチのメモ化</codestep>にも推奨されているということです。これは <code>useMemo</code> が計算のみに使用すべきであることとは対照的です。<p>現時点では、<code>cache</code> はサーバコンポーネントでのみ使用すべきです。キャッシュはサーバリクエストをまたぐと無効化されます。</section><section class="level4"aria-labelledby="memo-deep-dive-memo"><h4 id="memo-deep-dive-memo"><code>memo</code> {/<em>deep-dive-memo</em>/}</h4><p><a href="reference/react/memo"><code>memo</code></a> は、props が変わらない場合にコンポーネントの再レンダーを防ぐために使用すべきです。<pre class="language-js"><code class="language-js"><span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">WeatherReport</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>record<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> avgTemp <span class="token operator">=</span> <span class="token function">calculateAvg</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">MemoWeatherReport</span> <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token maybe-class-name">WeatherReport</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token function">getRecord</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MemoWeatherReport</span> record<span class="token operator">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MemoWeatherReport</span> record<span class="token operator">=</span><span class="token punctuation">{</span>record<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>この例では、両方の <code>MemoWeatherReport</code> コンポーネントは最初にレンダーされたときに <code>calculateAvg</code> を呼び出します。しかし、<code>App</code> が再レンダーされ、<code>record</code> に変更がない場合、props は一切変わらないため <code>MemoWeatherReport</code> は再レンダーされません。<p><code>useMemo</code> とは異なり、<code>memo</code> は特定の計算ではなく props に基づいてコンポーネントのレンダーをメモ化します。一方で最後の props の値に対応する最後のレンダー結果だけがキャッシュされるという点では <code>useMemo</code> と似ています。props が変更されるとキャッシュは無効化され、コンポーネントは再レンダーされます。</section></deepdive></section></section><section class="level2"aria-labelledby="トラブルシューティング-troubleshooting"><h2 id="トラブルシューティング-troubleshooting">トラブルシューティング {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="メモ化された関数が同じ引数で呼び出されても実行される-memoized-function-still-runs"><h3 id="メモ化された関数が同じ引数で呼び出されても実行される-memoized-function-still-runs">メモ化された関数が、同じ引数で呼び出されても実行される {/<em>memoized-function-still-runs</em>/}</h3><p>上で述べた落とし穴を参照してください。<ul><li><a href="#pitfall-different-memoized-functions">メモ化された関数を複数呼び出すと、別々のキャッシュから読み取られてしまいます</a>。<li><a href="#pitfall-memoized-call-outside-component">メモ化された関数をコンポーネントの外部で呼び出すと、キャッシュは使用されません</a>。</ul><p>上記のいずれも該当しない場合、何かがキャッシュに存在するかどうかを React がチェックする方法に関連した問題かもしれません。<p>引数が<a href="https://developer.mozilla.org/en-US/docs/Glossary/Primitive">プリミティブ</a>でない場合（例：オブジェクト、関数、配列）、同じオブジェクト参照を渡していることを確認してください。<p>メモ化された関数を呼び出すとき、React は入力された引数を調べて結果がすでにキャッシュされているかどうかを確認します。React は引数に対して浅い (shallow) 比較を行い、キャッシュヒットがあるかどうかを判断します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> calculateNorm <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vector</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MapMarker</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 🚩 Wrong: props is an object that changes every render.</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">calculateNorm</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>この例では、2 つの <code>MapMarker</code> が同じ処理を行っており、<code>calculateNorm</code> を <code>{x: 10, y: 10, z:10}</code> という同じ値で呼び出しているように見えます。しかしそれぞれのコンポーネントが別々に <code>props</code> オブジェクトを作成しているため、これらのオブジェクトは同じ値を含んでいますが、同じオブジェクト参照ではありません。<p>React は入力に対して <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> を呼び出し、キャッシュヒットがあるかどうかを確認します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> calculateNorm <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MapMarker</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Good: Pass primitives to memoized function</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">calculateNorm</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token property-access">x</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token property-access">y</span><span class="token punctuation">,</span> props<span class="token punctuation">.</span><span class="token property-access">z</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> x<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> y<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> z<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">10</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>これを解決するひとつの方法は、ベクトルの各次元の値を別々に <code>calculateNorm</code> に渡すことです。各次元の値はプリミティブであるため、これは機能します。<p>ありえる別の解決策は、ベクトルオブジェクト自体をコンポーネントの props として渡すことです。同じオブジェクトを両方のコンポーネントインスタンスに渡す必要があります。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>cache<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> calculateNorm <span class="token operator">=</span> <span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">vector</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">MapMarker</span></span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ Good: Pass the same `vector` object</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> <span class="token function">calculateNorm</span><span class="token punctuation">(</span>props<span class="token punctuation">.</span><span class="token property-access">vector</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vector <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> vector<span class="token operator">=</span><span class="token punctuation">{</span>vector<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">MapMarker</span> vector<span class="token operator">=</span><span class="token punctuation">{</span>vector<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></canary></section>