<!doctype html><html lang="ja"><meta charset="utf-8"><title>useOptimistic</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="useoptimistic"><h1 id="useoptimistic">useOptimistic</h1><p>canary: true</p><canary><p><code>useOptimistic</code> フックは、現在 React の Canary および experimental チャンネルでのみ利用可能です。<a href="/community/versioning-policy#all-release-channels">React のリリースチャンネルについてはこちらをご覧ください</a>。</p></canary><intro><p><code>useOptimistic</code> は、UI を楽観的に (optimistically) 更新するための React フックです。<pre class="language-js"><code class="language-js">  <span class="token keyword">const</span> <span class="token punctuation">[</span>optimisticState<span class="token punctuation">,</span> addOptimistic<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useOptimistic</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> updateFn<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="リファレンス-reference"><h2 id="リファレンス-reference">リファレンス {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="useoptimisticstate-updatefn-use"><h3 id="useoptimisticstate-updatefn-use"><code>useOptimistic(state, updateFn)</code> {/<em>use</em>/}</h3><p><code>useOptimistic</code> は、何らかの非同期アクションが進行中の間だけ、異なる state を表示するための React フックです。ある state を引数として受け取ってそのコピーを返しますが、ネットワークリクエストなどの非同期アクションが実行中の場合に異なる値を返すことができます。現在の state とアクションへの入力を受け取り、アクション実行中に使用される楽観的 state を返すような関数を渡します。<p>このような state が「楽観的」state と呼ばれるのは、実際にはアクションの完了には時間がかかるにも関わらず、そのアクションの実行結果をユーザに即座に提示するために通常使用されるものだからです。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useOptimistic <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">AppContainer</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>optimisticState<span class="token punctuation">,</span> addOptimistic<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useOptimistic</span><span class="token punctuation">(</span>
    state<span class="token punctuation">,</span>
    <span class="token comment">// updateFn</span>
    <span class="token punctuation">(</span><span class="token parameter">currentState<span class="token punctuation">,</span> optimisticValue</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// merge and return new state</span>
      <span class="token comment">// with optimistic value</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><a href="#usage">さらに例を見る</a><section class="level4"aria-labelledby="引数-parameters"><h4 id="引数-parameters">引数 {/<em>parameters</em>/}</h4><ul><li><code>state</code>: 初期状態や、実行中のアクションが存在しない場合に返される値。<li><code>updateFn(currentState, optimisticValue)</code>: state の現在値と、<code>addOptimistic</code> に渡された楽観的更新に使用する値 (optimistic value) を受け取り、結果としての楽観的 state を返す関数。純関数でなければなりません。<code>updateFn</code> は <code>currentState</code> と <code>optimisticValue</code> の 2 つの引数を受け取ります。返り値は <code>currentState</code> に <code>optimisticValue</code> の値を反映させたものとなります。</ul></section><section class="level4"aria-labelledby="返り値-returns"><h4 id="返り値-returns">返り値 {/<em>returns</em>/}</h4><ul><li><code>optimisticState</code>: 結果としての楽観的 state。実行中のアクションがない場合は <code>state</code> と等しくなり、何らかのアクションが実行中の場合は <code>updateFn</code> が返す値と等しくなります。<li><code>addOptimistic</code>: 楽観的な更新を行う際に呼び出すためのディスパッチ関数。任意の型の引数 <code>optimisticValue</code> を 1 つだけ受け取ります。それにより、<code>state</code> と <code>optimisticValue</code> を引数にして <code>updateFn</code> が呼び出されます。</ul></section></section></section><section class="level2"aria-labelledby="使用法-usage"><h2 id="使用法-usage">使用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="フォームの楽観的な更新-optimistically-updating-with-forms"><h3 id="フォームの楽観的な更新-optimistically-updating-with-forms">フォームの楽観的な更新 {/<em>optimistically-updating-with-forms</em>/}</h3><p><code>useOptimistic</code> フックは、ネットワークリクエストのようなバックグラウンド作業が完了する前に、ユーザインターフェースを楽観的に更新する方法を提供します。フォームにおいては、この技術はアプリをよりレスポンシブに感じさせるために役立ちます。ユーザがフォームを送信した際に、サーバのレスポンスを待たずに、予想される結果を用いてインターフェースを即座に更新しておきます。<p>例えば、ユーザがフォームにメッセージを入力して送信ボタンを押すと、<code>useOptimistic</code> フックにより、メッセージが実際にサーバに送信される前であっても、リストに "Sending..." というラベル付きでメッセージを即座に表示できるようになります。この「楽観的」アプローチにより、アプリの印象が高速でレスポンシブになります。その後フォームはバックグラウンドでメッセージの実際の送信を試みます。サーバにメッセージが到着したことを確認すると、"Sending..." ラベルが取り除かれます。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useOptimistic<span class="token punctuation">,</span> useState<span class="token punctuation">,</span> useRef <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"react"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> deliverMessage <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./actions.js"</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">Thread</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> messages<span class="token punctuation">,</span> sendMessage <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> formRef <span class="token operator">=</span> <span class="token function">useRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">formAction</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">addOptimisticMessage</span><span class="token punctuation">(</span>formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    formRef<span class="token punctuation">.</span><span class="token property-access">current</span><span class="token punctuation">.</span><span class="token method function property-access">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span>formData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>optimisticMessages<span class="token punctuation">,</span> addOptimisticMessage<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useOptimistic</span><span class="token punctuation">(</span>
    messages<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> newMessage</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span>
      <span class="token spread operator">...</span>state<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">text</span><span class="token operator">:</span> newMessage<span class="token punctuation">,</span>
        <span class="token literal-property property">sending</span><span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token punctuation">{</span>optimisticMessages<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
        <span class="token operator">&#x3C;</span>div key<span class="token operator">=</span><span class="token punctuation">{</span>index<span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token punctuation">{</span>message<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">}</span>
          <span class="token punctuation">{</span><span class="token operator">!</span><span class="token operator">!</span>message<span class="token punctuation">.</span><span class="token property-access">sending</span> <span class="token operator">&#x26;&#x26;</span> <span class="token operator">&#x3C;</span>small<span class="token operator">></span> <span class="token punctuation">(</span><span class="token maybe-class-name">Sending</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>small<span class="token operator">></span><span class="token punctuation">}</span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>formAction<span class="token punctuation">}</span> ref<span class="token operator">=</span><span class="token punctuation">{</span>formRef<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"message"</span> placeholder<span class="token operator">=</span><span class="token string">"Hello!"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token maybe-class-name">Send</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>messages<span class="token punctuation">,</span> setMessages<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">"Hello there!"</span><span class="token punctuation">,</span> <span class="token literal-property property">sending</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> sentMessage <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">deliverMessage</span><span class="token punctuation">(</span>formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setMessages</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">messages</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token spread operator">...</span>messages<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">text</span><span class="token operator">:</span> sentMessage <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Thread</span> messages<span class="token operator">=</span><span class="token punctuation">{</span>messages<span class="token punctuation">}</span> sendMessage<span class="token operator">=</span><span class="token punctuation">{</span>sendMessage<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deliverMessage</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> message<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"react"</span><span class="token operator">:</span> <span class="token string">"18.3.0-canary-6db7f4209-20231021"</span><span class="token punctuation">,</span>
    <span class="token property">"react-dom"</span><span class="token operator">:</span> <span class="token string">"18.3.0-canary-6db7f4209-20231021"</span><span class="token punctuation">,</span>
    <span class="token property">"react-scripts"</span><span class="token operator">:</span> <span class="token string">"^5.0.0"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"/index.js"</span><span class="token punctuation">,</span>
  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>