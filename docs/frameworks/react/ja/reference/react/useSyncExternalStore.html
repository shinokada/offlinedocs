<!doctype html><html lang="ja"><meta charset="utf-8"><title>useSyncExternalStore</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="usesyncexternalstore"><h1 id="usesyncexternalstore">useSyncExternalStore</h1><intro><p><code>useSyncExternalStore</code> は、外部ストアへのサブスクライブを可能にする React のフックです。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> snapshot <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="リファレンス-reference"><h2 id="リファレンス-reference">リファレンス {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><h3 id="usesyncexternalstoresubscribe-getsnapshot-getserversnapshot-usesyncexternalstore"><code>useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot?)</code> {/<em>usesyncexternalstore</em>/}</h3><p>外部データストアから値を読み取るために、コンポーネントのトップレベルで useSyncExternalStore を呼び出します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>これは、ストアにあるデータのスナップショットを返します。引数として 2 つの関数を渡す必要があります：<ol><li><code>subscribe</code> 関数はストアへのサブスクライブを開始します。サブスクライブを解除する関数を返す必要があります。<li><code>getSnapshot</code> 関数は、ストアからデータのスナップショットを読み取る必要があります。</ol><p><a href="#usage">さらに例を見る</a><section class="level4"aria-labelledby="引数-parameters"><h4 id="引数-parameters">引数 {/<em>parameters</em>/}</h4><ul><li><p><code>subscribe</code>: ストアにサブスクライブを開始し、また callback 引数を受け取る関数。ストアが変更された際に渡された callback を呼び出す必要があります。これにより、コンポーネントが再レンダーされます。<code>subscribe</code> 関数は、サブスクリプションをクリーンアップする関数を返す必要があります。<li><p><code>getSnapshot</code>: コンポーネントが必要とするストアにあるデータのスナップショットを返す関数。ストアが変更されていない場合、<code>getSnapshot</code> への再呼び出しは同じ値を返す必要があります。ストアが変更されて返された値が（<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/is"><code>Object.is</code></a> で比較して）異なる場合、React はコンポーネントを再レンダーします。<li><p><strong>省略可能</strong> <code>getServerSnapshot</code>: ストアのデータの初期スナップショットを返す関数。これはサーバレンダリング中、およびクライアント上でのサーバレンダリングされたコンテンツのハイドレーション中にのみ使用されます。サーバスナップショットはクライアントとサーバ間で同一でなければならず、通常はサーバからクライアントに渡されるシリアライズされたものです。この引数を省略すると、サーバ上でのコンポーネントのレンダリングはエラーを発生させます。</ul></section><section class="level4"aria-labelledby="返り値-returns"><h4 id="返り値-returns">返り値 {/<em>returns</em>/}</h4><p>レンダリングロジックで使用できるストアの現在のスナップショット。</section><section class="level4"aria-labelledby="注意点-caveats"><h4 id="注意点-caveats">注意点 {/<em>caveats</em>/}</h4><ul><li><p><code>getSnapshot</code> によって返されるストアのスナップショットはイミュータブル（immutable; 書き換え不能）でなければなりません。背後で使っているストアがミュータブルなデータを持っている場合、データが変更された場合は新しいイミュータブルなスナップショットを返し、それ以外の場合はキャッシュされた最後のスナップショットを返すようにします。<li><p>再レンダー中に異なる <code>subscribe</code> 関数が渡された場合、React は新しく渡された <code>subscribe</code> 関数を使ってストアに再サブスクライブします。これを防ぐには、<code>subscribe</code> をコンポーネントの外で宣言します。<li><p><a href="/reference/react/useTransition">ノンブロッキング型のトランジション更新</a>の最中にストアの書き換えが発生した場合、React はその更新をブロッキング型で行うようにフォールバックします。具体的には、トランザクションによる更新のたびに、React は DOM に更新を適用する前に <code>getSnapshot</code> を再度呼び出します。そこで最初の値とは異なる値が返された場合、React は更新を最初からやり直しますが、再試行時にはブロッキング型の更新を行うことで、画面上の全コンポーネントがストアからの同一バージョンの値を反映していることを保証します。<li><p><code>useSyncExternalStore</code> から返される値に基づいてレンダーを<em>サスペンド</em>させることは推奨されていません。外部ストアで起きた変更は<a href="/reference/react/useTransition">ノンブロッキング型のトランジション更新</a>としてマークすることができないため、直近の <a href="/reference/react/Suspense"><code>Suspense</code> フォールバック</a>が起動してしまいます。既に画面上に表示されているコンテンツがローディングスピナで隠れてしまうため、通常は望ましくないユーザ体験につながります。<p>例えば以下のようなコードは推奨されません。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">LazyProductDetailPage</span> <span class="token operator">=</span> <span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./ProductDetailPage.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ShoppingApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> selectedProductId <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ❌ Calling `use` with a Promise dependent on `selectedProductId`</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token function">fetchItem</span><span class="token punctuation">(</span>selectedProductId<span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token comment">// ❌ Conditionally rendering a lazy component based on `selectedProductId`</span>
  <span class="token keyword control-flow">return</span> selectedProductId <span class="token operator">!=</span> <span class="token keyword null nil">null</span> <span class="token operator">?</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">LazyProductDetailPage</span> <span class="token operator">/</span><span class="token operator">></span> <span class="token operator">:</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">FeaturedProducts</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></ul></section></section></section><section class="level2"aria-labelledby="使用法-usage"><h2 id="使用法-usage">使用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="外部ストアへのサブスクライブ-subscribing-to-an-external-store"><h3 id="外部ストアへのサブスクライブ-subscribing-to-an-external-store">外部ストアへのサブスクライブ {/<em>subscribing-to-an-external-store</em>/}</h3><p>React コンポーネントのほとんどは、<a href="/learn/passing-props-to-a-component">props</a>、<a href="/reference/react/useState">state</a> および<a href="/reference/react/useContext">コンテクスト</a>からのみデータを読み取ります。しかし、コンポーネントは時間と共に変化する React 外のストアからデータを読み取る必要がある場合があります。これには以下のようなものが含まれます：<ul><li>React の外部で状態を保持するサードパーティの状態管理ライブラリ。<li>可変の値を、その変更にサブスクライブするためのイベントともに公開するブラウザ API。</ul><p>外部データストアから値を読み取るために、コンポーネントの最上位で <code>useSyncExternalStore</code> を呼び出します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>これはストア内のデータの<codestep step="{3}">スナップショット</codestep>を返します。引数として 2 つの関数を渡す必要があります：<ol><li><codestep step="{1}"><code>subscribe</code> 関数</codestep>は、ストアへのサブスクライブを行い、またサブスクライブを解除する関数を返します。<li><codestep step="{2}"><code>getSnapshot</code> 関数</codestep>は、ストアからデータのスナップショットを読み取ります。</ol><p>React はこれらの関数を使ってコンポーネントをストアにサブスクライブされた状態に保ち、変更があるたびに再レンダーします。<p>例えば、以下のサンドボックスでは、<code>todosStore</code> は React の外部にデータを保存する外部ストアとして実装されています。<code>TodosApp</code> コンポーネントは、<code>useSyncExternalStore</code> フックを使ってその外部ストアに接続します。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> todosStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./todoStore.js'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">TodosApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> todos <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>todosStore<span class="token punctuation">.</span><span class="token property-access">subscribe</span><span class="token punctuation">,</span> todosStore<span class="token punctuation">.</span><span class="token property-access">getSnapshot</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> todosStore<span class="token punctuation">.</span><span class="token method function property-access">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Add</span> todo<span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>hr <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>ul<span class="token operator">></span>
        <span class="token punctuation">{</span>todos<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token parameter">todo</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span>
          <span class="token operator">&#x3C;</span>li key<span class="token operator">=</span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token punctuation">{</span>todo<span class="token punctuation">.</span><span class="token property-access">text</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>li<span class="token operator">></span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>ul<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// This is an example of a third-party store</span>
<span class="token comment">// that you might need to integrate with React.</span>

<span class="token comment">// If your app is fully built with React,</span>
<span class="token comment">// we recommend using React state instead.</span>

<span class="token keyword">let</span> nextId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> todosStore <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">addTodo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>listeners<span class="token punctuation">,</span> listener<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      listeners <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token method function property-access">filter</span><span class="token punctuation">(</span><span class="token parameter">l</span> <span class="token arrow operator">=></span> l <span class="token operator">!==</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> todos<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">emitChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> listener <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></sandpack><note><p>可能であれば、React 組み込みの state 管理機能である <a href="/reference/react/useState"><code>useState</code></a> および <a href="/reference/react/useReducer"><code>useReducer</code></a> を代わりに使用することをお勧めします。<code>useSyncExternalStore</code> API は、既存の非 React コードと統合する必要がある場合に主に役立ちます。</p></note></section><section class="level3"aria-labelledby="ブラウザ-api-へのサブスクライブ-subscribing-to-a-browser-api"><h3 id="ブラウザ-api-へのサブスクライブ-subscribing-to-a-browser-api">ブラウザ API へのサブスクライブ {/<em>subscribing-to-a-browser-api</em>/}</h3><p><code>useSyncExternalStore</code> を追加するもう 1 つの理由は、時間とともに変化する、ブラウザが公開する値にサブスクライブしたい場合です。たとえば、コンポーネントがネットワーク接続がアクティブかどうかを表示したいとします。ブラウザは、この情報を <a href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/onLine"><code>navigator.onLine</code></a> というプロパティを介して公開します。<p>この値は React の知らないところで変更される可能性があるので、<code>useSyncExternalStore</code> でそれを読み取るべきです。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><code>getSnapshot</code> 関数を実装するためには、ブラウザ API から現在の値を読み取ることが必要です：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>次に、<code>subscribe</code> 関数を実装する必要があります。例えば、<code>navigator.onLine</code> が変化すると、ブラウザは <code>window</code> オブジェクト上で <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/online_event"><code>online</code></a> および <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/offline_event"><code>offline</code></a> というイベントを発火します。これら対応するイベントに <code>callback</code> 引数を登録し、それを解除する関数を返す必要があります：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>これで React は、外部の <code>navigator.onLine</code> API から値を読み取る方法と、その変更にサブスクライブする方法を知ることができます。ネットワークからデバイスを切断すると、コンポーネントが反応して再レンダーされることに注目してください：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'✅ Online'</span> <span class="token operator">:</span> <span class="token string">'❌ Disconnected'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></section><section class="level3"aria-labelledby="ロジックをカスタムフックに抽出する-extracting-the-logic-to-a-custom-hook"><h3 id="ロジックをカスタムフックに抽出する-extracting-the-logic-to-a-custom-hook">ロジックをカスタムフックに抽出する {/<em>extracting-the-logic-to-a-custom-hook</em>/}</h3><p>通常、<code>useSyncExternalStore</code> を直接コンポーネント内に記述することはありません。代わりに、自分自身のカスタムフックから呼び出すことが一般的です。これにより、異なるコンポーネントから同じ外部ストアを使用できます。<p>例えば、このカスタム <code>useOnlineStatus</code> フックはネットワークがオンラインであるかどうかを追跡します：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>これで、異なるコンポーネントが、基本的な実装を繰り返すことなく <code>useOnlineStatus</code> を呼び出せるようになりました：</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useOnlineStatus <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./useOnlineStatus.js'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">StatusBar</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>h1<span class="token operator">></span><span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'✅ Online'</span> <span class="token operator">:</span> <span class="token string">'❌ Disconnected'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">SaveButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleSaveClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'✅ Progress saved'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>button disabled<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">!</span>isOnline<span class="token punctuation">}</span> onClick<span class="token operator">=</span><span class="token punctuation">{</span>handleSaveClick<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token punctuation">{</span>isOnline <span class="token operator">?</span> <span class="token string">'Save progress'</span> <span class="token operator">:</span> <span class="token string">'Reconnecting...'</span><span class="token punctuation">}</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">SaveButton</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">StatusBar</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'online'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack></section><section class="level3"aria-labelledby="サーバーレンダリングのサポートを追加する-adding-support-for-server-rendering"><h3 id="サーバーレンダリングのサポートを追加する-adding-support-for-server-rendering">サーバーレンダリングのサポートを追加する {/<em>adding-support-for-server-rendering</em>/}</h3><p>React アプリが<a href="/reference/react-dom/server">サーバレンダリング</a>を使用している場合、React コンポーネントは初期 HTML を生成するためにブラウザ環境外でも実行されます。これにより、外部ストアへの接続に関するいくつかの課題が生じます。<ul><li>ブラウザ専用の API に接続している場合、それはサーバ上では存在しないため動作しません。<li>サードパーティのデータストアに接続している場合、サーバとクライアント間でそのデータを一致させる必要があります。</ul><p>これらの問題を解決するために、<code>useSyncExternalStore</code> に <code>getServerSnapshot</code> 関数を第 3 引数として渡します：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useSyncExternalStore <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useOnlineStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">,</span> getServerSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> isOnline<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token dom variable">navigator</span><span class="token punctuation">.</span><span class="token property-access">onLine</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getServerSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// Always show "Online" for server-generated HTML</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><code>getServerSnapshot</code> 関数は <code>getSnapshot</code> と似ていますが、以下の 2 つの状況でのみ実行されます：<ul><li>サーバ上で、HTML を生成する際に実行される。<li>クライアント上で、React がサーバ HTML をインタラクティブにするとき、つまり<a href="/reference/react-dom/client/hydrateRoot">ハイドレーション</a>中に実行される。</ul><p>これにより、アプリがインタラクティブになる前に使用される初期のスナップショット値を指定できます。サーバレンダリング中に意味のある初期値が存在しない場合は、この引数を省略して、<a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-client-only-content">強制的にクライアントでレンダーする</a>ようにします。</p><note><p>初回のクライアントレンダリングでは、<code>getServerSnapshot</code> はサーバで返したものと必ず正確に同一のデータを返すようにしてください。例えば、<code>getServerSnapshot</code> がサーバ上で事前に準備されたストアコンテンツを返した場合、このコンテンツをクライアントに転送する必要があります。これを行う 1 つの方法は、サーバレンダリング中に <code>window.MY_STORE_DATA</code> のようなグローバル変数を設定する <code>&#x3C;script></code> タグを発行しておき、クライアントの <code>getServerSnapshot</code> でそのグローバル変数から読み込むことです。あなたが使う外部ストアにその方法が記載されているはずです。</p></note></section></section><section class="level2"aria-labelledby="トラブルシューティング-troubleshooting"><h2 id="トラブルシューティング-troubleshooting">トラブルシューティング {/<em>troubleshooting</em>/}</h2><section class="level3"aria-labelledby="the-result-of-getsnapshot-should-be-cached-というエラーが出る-im-getting-an-error-the-result-of-getsnapshot-should-be-cached"><h3 id="the-result-of-getsnapshot-should-be-cached-というエラーが出る-im-getting-an-error-the-result-of-getsnapshot-should-be-cached">"The result of <code>getSnapshot</code> should be cached" というエラーが出る {/<em>im-getting-an-error-the-result-of-getsnapshot-should-be-cached</em>/}</h3><p>このエラーは、<code>getSnapshot</code> 関数が呼ばれるたびに新しいオブジェクトを返していることを意味します。例えば：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 🔴 Do not return always different objects from getSnapshot</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">todos</span><span class="token operator">:</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>getSnapshot</code> の返り値が前回と異なる場合、React はコンポーネントを再レンダーします。このため、常に異なる値を返すと無限ループに入り、このエラーが発生します。<p><code>getSnapshot</code> オブジェクトは、実際に何かが変更された場合にのみ、別のオブジェクトを返す必要があります。ストアにイミュータブルなデータが含まれている場合は、そのデータを直接返すことができます：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">getSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ✅ You can return immutable data</span>
  <span class="token keyword control-flow">return</span> myStore<span class="token punctuation">.</span><span class="token property-access">todos</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>ストアデータがミュータブルな場合、<code>getSnapshot</code> 関数はそのイミュータブルなスナップショットを返す必要があります。つまり、新しいオブジェクトを作成する必要は<strong>あります</strong>が、毎回作成してはいけないということです。その代わりに、最後に計算されたスナップショットを保存しておき、ストア内のデータが変更されていない場合は前回と同じスナップショットを返すようにします。ミュータブルなデータが変更されたかどうかを判断する方法は、ミュータブルなストアによって異なります。</section><section class="level3"aria-labelledby="subscribe-が毎レンダーごとに呼び出される-my-subscribe-function-gets-called-after-every-re-render"><h3 id="subscribe-が毎レンダーごとに呼び出される-my-subscribe-function-gets-called-after-every-re-render"><code>subscribe</code> が毎レンダーごとに呼び出される {/<em>my-subscribe-function-gets-called-after-every-re-render</em>/}</h3><p>この <code>subscribe</code> 関数はコンポーネントの<strong>内部</strong>で定義されているため、再レンダーするたびに異なった値になります：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 🚩 Always a different function, so React will resubscribe on every re-render</span>
  <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>React は、再レンダー間で異なる <code>subscribe</code> 関数を渡すと、ストアに再サブスクライブします。これがパフォーマンスの問題を引き起こし、再サブスクライブを避けたい場合は、<code>subscribe</code> 関数を外部に移動してください：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ✅ Always the same function, so React won't need to resubscribe</span>
<span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>あるいは、<code>subscribe</code> を <a href="/reference/react/useCallback"><code>useCallback</code></a> でラップすることで、引数が変更されたときのみ再サブスクライブすることができます：<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ChatIndicator</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> userId <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isOnline <span class="token operator">=</span> <span class="token function">useSyncExternalStore</span><span class="token punctuation">(</span>subscribe<span class="token punctuation">,</span> getSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ✅ Same function as long as userId doesn't change</span>
  <span class="token keyword">const</span> subscribe <span class="token operator">=</span> <span class="token function">useCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>userId<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>