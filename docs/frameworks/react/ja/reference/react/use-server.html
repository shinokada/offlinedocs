<!doctype html><html lang="ja"><meta charset="utf-8"><title>"'use server'"</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="use-server"><h1 id="use-server">"'use server'"</h1><p>titleForTitleTag: "'use server' ディレクティブ" canary: true</p><canary><p><code>'use server'</code> は、<a href="/learn/start-a-new-react-project#bleeding-edge-react-frameworks">React Server Components を使用している</a>場合や、それらと互換性のあるライブラリを構築している場合にのみ必要です。</p></canary><intro><p><code>'use server'</code> は、クライアントサイドのコードから呼び出せる、サーバサイドの関数をマークします。</p></intro><inlinetoc><section class="level2"aria-labelledby="リファレンス-reference"><h2 id="リファレンス-reference">リファレンス {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="use-server-use-server"><h3 id="use-server-use-server"><code>'use server'</code> {/<em>use-server</em>/}</h3><p>非同期 (async) 関数の本体の冒頭に <code>'use server';</code> を追加することで、その関数がクライアントから実行可能であるとマークします。そのような関数のことを<em>サーバアクション (Server Action)</em> と呼びます。<pre class="language-js"><code class="language-js"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">addToCart</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use server'</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>クライアント上でサーバアクションを呼び出すと、渡された引数のシリアライズされたコピーを含んだネットワークリクエストがサーバに送信されます。サーバアクションが値を返す場合は、その値がシリアライズされてクライアントに返されます。<p>個々の関数に <code>'use server'</code> をマークする代わりに、このディレクティブをファイルの先頭に追加することもできます。その場合はそのファイル内のすべてのエクスポートが、クライアントコードでインポートされる場合も含み、あらゆる場所で使用できるサーバアクションとしてマークされます。<section class="level4"aria-labelledby="注意点-caveats"><h4 id="注意点-caveats">注意点 {/<em>caveats</em>/}</h4><ul><li><code>'use server'</code> は、関数やモジュールの冒頭、つまりインポートも含む他のコードよりも上にある必要があります（ディレクティブの上にコメントを書くことは OK）。シングルクォートまたはダブルクォートで書かれていなければならず、バックティックは無効です。<li><code>'use server'</code> は、サーバサイドのファイルでのみ使用できます。結果として得られるサーバアクションは、props を通じてクライアントコンポーネントに渡せるようになります。サポートされている<a href="#serializable-parameters-and-return-values">シリアライズ可能な型</a>を参照してください。<li><a href="/reference/react/use-client">クライアントコード</a>からサーバアクションをインポートする場合は、ディレクティブをモジュールレベルで使用する必要があります。<li>内部で使用されるネットワーク呼び出しは常に非同期であるため、<code>'use server'</code> は非同期関数でのみ使用できます。<li>サーバアクションへの引数は常に信頼できない入力として扱い、あらゆるデータ書き換えを検証してください。<a href="#security">セキュリティに関する考慮事項</a>を参照してください。<li>サーバアクションは<a href="/reference/react/useTransition">トランジション</a>の中で呼び出すようにしてください。サーバアクションが <a href="/reference/react-dom/components/form#props"><code>&#x3C;form action></code></a> または <a href="/reference/react-dom/components/input#props"><code>formAction</code></a> に渡される場合、自動的にトランジション内で呼び出されます。<li>サーバアクションは、サーバ側の状態を書き換える、更新目的のために設計されています。データの取得には推奨されません。したがって、サーバアクションを実装するフレームワークは通常、一度にひとつのアクションのみを処理し、返り値をキャッシュしないようにします。</ul></section></section><section class="level3"aria-labelledby="セキュリティについての考慮事項-security"><h3 id="セキュリティについての考慮事項-security">セキュリティについての考慮事項 {/<em>security</em>/}</h3><p>サーバアクションへの引数は、完全にクライアントで制御されるものです。セキュリティのため、入力は常に信頼できないものとして扱い、引数の検証やエスケープを適切に行ってください。<p>あらゆるサーバアクションにおいて、ログイン済みのユーザがそのアクションを実行できることを確認してください。</p><wip><p>サーバアクションから機密データが送信されるのを防ぐために、ユニークな値やオブジェクトがクライアントコードに渡されるのを防ぐ実験的な汚染 API (taint API) があります。<p><a href="/reference/react/experimental_taintUniqueValue">experimental_taintUniqueValue</a> と <a href="/reference/react/experimental_taintObjectReference">experimental_taintObjectReference</a> を参照してください。</p></wip></section><section class="level3"aria-labelledby="シリアライズ可能な引数と返り値-serializable-parameters-and-return-values"><h3 id="シリアライズ可能な引数と返り値-serializable-parameters-and-return-values">シリアライズ可能な引数と返り値 {/<em>serializable-parameters-and-return-values</em>/}</h3><p>クライアントコードのサーバアクション呼び出しはネットワーク経由で行われるため、関数に渡すあらゆる引数はシリアライズ可能である必要があります。<p>以下は、サーバアクションの引数としてサポートされる型です。<ul><li>プリミティブ<ul><li><a href="https://developer.mozilla.org/en-US/docs/Glossary/String">文字列</a><li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Number">数値</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt">bigint</a><li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Boolean">ブーリアン</a><li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Undefined">undefined</a><li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Null">null</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol">シンボル</a>、ただし <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/for"><code>Symbol.for</code></a> を通じてグローバルシンボルレジストリに登録されたシンボルのみ</ul><li>シリアライズ可能な値を含んだ Iterable<ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String">文字列</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array">配列</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map">Map</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set">Set</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray">TypedArray</a> と <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer">ArrayBuffer</a></ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date">Date</a><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData">FormData</a> のインスタンス<li>プレーンな<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object">オブジェクト</a>: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer">オブジェクト初期化子</a>で作成され、シリアライズ可能なプロパティを持つもの<li><a href="/reference/react/use-server">サーバアクション (server action)</a> としての関数<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">プロミス</a></ul><p>以下のものはサポートされていません。<ul><li>React 要素すなわち <a href="https://react.dev/learn/writing-markup-with-jsx">JSX</a><li>関数。関数コンポーネントや、サーバアクションでない他のあらゆる関数を含む。<li><a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Classes_in_JavaScript">クラス</a><li>任意のクラスのインスタンス（上記の組み込みクラスを除く）や、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object#null-prototype_objects">null プロトタイプのオブジェクト</a><li>グローバルに登録されていないシンボル、例：<code>Symbol('my new symbol')</code></ul><p>サポートされるシリアライズ可能な返り値は、クライアントコンポーネントに渡せる<a href="/reference/react/use-client#passing-props-from-server-to-client-components">シリアライズ可能な props</a> の型と同じです。</section></section><section class="level2"aria-labelledby="使用法-usage"><h2 id="使用法-usage">使用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="フォームでサーバアクションを使用する-server-actions-in-forms"><h3 id="フォームでサーバアクションを使用する-server-actions-in-forms">フォームでサーバアクションを使用する {/<em>server-actions-in-forms</em>/}</h3><p>サーバアクションの最も一般的なユースケースは、データを更新するためにサーバ関数を呼び出すことです。ブラウザ上においては <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/form">HTML フォーム要素</a>が、ユーザが更新処理を送信する際の伝統的な方法です。React Server Components により、<a href="/reference/react-dom/components/form">フォーム</a>に書かれたサーバアクションに対する第 1 級サポートが導入されます。<p>以下は、ユーザがユーザ名をリクエストできるフォームです。<pre class="language-js"><code class="language-js"><span class="token comment">// App.js</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestUsername</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token string">'use server'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>requestUsername<span class="token punctuation">}</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token maybe-class-name">Request</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>この例では、<code>requestUsername</code> は <code>&#x3C;form></code> に渡されるサーバアクションとなります。ユーザがこのフォームを送信すると、サーバ関数 <code>requestUsername</code> へのネットワークリクエストが発生します。フォーム内でサーバアクションを呼び出すとき、React はフォームの<codestep step="{1}"><a href="https://developer.mozilla.org/en-US/docs/Web/API/FormData">FormData</a></codestep>をサーバアクションの最初の引数として提供します。<p>フォームの <code>action</code> にサーバアクションを渡すことで、React によるフォームの<a href="https://developer.mozilla.org/en-US/docs/Glossary/Progressive_Enhancement">プログレッシブエンハンスメント (progressive enhancement)</a> が有効になります。つまり JavaScript バンドルがロードされる前にフォームを送信できるようになるということです。<section class="level4"aria-labelledby="フォームでの返り値の取り扱い-handling-return-values"><h4 id="フォームでの返り値の取り扱い-handling-return-values">フォームでの返り値の取り扱い {/<em>handling-return-values</em>/}</h4><p>上記のユーザ名リクエストフォームでは、ユーザ名が利用できない可能性もあります。<code>requestUsername</code> は成功したか失敗したかを伝えられるべきです。<p>プログレッシブエンハンスメントをサポートしつつサーバアクションの結果に基づいて UI を更新するには、<a href="/reference/react-dom/hooks/useFormState"><code>useFormState</code></a> を使用します。<pre class="language-js"><code class="language-js"><span class="token comment">// requestUsername.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">requestUsername</span><span class="token punctuation">(</span><span class="token parameter">formData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> username <span class="token operator">=</span> formData<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">canRequest</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'successful'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token string">'failed'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// UsernameForm.js</span>
<span class="token string">'use client'</span><span class="token punctuation">;</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>useFormState<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports">requestUsername</span> <span class="token keyword module">from</span> <span class="token string">'./requestUsername'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">UsernameForm</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>returnValue<span class="token punctuation">,</span> action<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useFormState</span><span class="token punctuation">(</span>requestUsername<span class="token punctuation">,</span> <span class="token string">'n/a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token punctuation">{</span>action<span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>input type<span class="token operator">=</span><span class="token string">"text"</span> name<span class="token operator">=</span><span class="token string">"username"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button type<span class="token operator">=</span><span class="token string">"submit"</span><span class="token operator">></span><span class="token maybe-class-name">Request</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Last</span> submission request returned<span class="token operator">:</span> <span class="token punctuation">{</span>returnValue<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>ほとんどのフックと同様に、<code>useFormState</code> は<codestep step="{1}"><a href="/reference/react/use-client">クライアントコード</a></codestep>内でしか呼び出せないことに注意してください。</section></section><section class="level3"aria-labelledby="form-の外部でサーバアクションを呼び出す-calling-a-server-action-outside-of-form"><h3 id="form-の外部でサーバアクションを呼び出す-calling-a-server-action-outside-of-form"><code>&#x3C;form></code> の外部でサーバアクションを呼び出す {/<em>calling-a-server-action-outside-of-form</em>/}</h3><p>サーバアクションはサーバ側の公開エンドポイントであり、クライアントコードのどこからでも呼び出すことができます。<p><a href="/reference/react-dom/components/form">フォーム</a>の外部でサーバアクションを使用する場合、<a href="/reference/react/useTransition">トランジション</a>内でサーバアクションを呼び出すようにしてください。これによりローディングインジケータを表示したり、<a href="/reference/react/useOptimistic">楽観的に state 更新結果を表示</a>したり、予期せぬエラーを処理したりすることができるようになります。フォームではサーバアクションは自動的にトランジション内にラップされます。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports">incrementLike</span> <span class="token keyword module">from</span> <span class="token string">'./actions'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useTransition <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">LikeButton</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPending<span class="token punctuation">,</span> startTransition<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>likeCount<span class="token punctuation">,</span> setLikeCount<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> currentCount <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">incrementLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setLikeCount</span><span class="token punctuation">(</span>currentCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>p<span class="token operator">></span><span class="token maybe-class-name">Total</span> <span class="token maybe-class-name">Likes</span><span class="token operator">:</span> <span class="token punctuation">{</span>likeCount<span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>p<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span>onClick<span class="token punctuation">}</span> disabled<span class="token operator">=</span><span class="token punctuation">{</span>isPending<span class="token punctuation">}</span><span class="token operator">></span><span class="token maybe-class-name">Like</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span><span class="token punctuation">;</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// actions.js</span>
<span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> likeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">async</span> <span class="token function">incrementLike</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  likeCount<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> likeCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>サーバアクションからの返り値を読み取るには、返されたプロミスを <code>await</code> する必要があります。 <span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>