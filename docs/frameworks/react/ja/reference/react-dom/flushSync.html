<!doctype html><html lang="ja"><meta charset="utf-8"><title>flushSync</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="flushsync"><h1 id="flushsync">flushSync</h1><pitfall><p><code>flushSync</code> の使用は一般的ではなく、アプリのパフォーマンスを低下させる可能性があります。</p></pitfall><intro><p><code>flushSync</code> は、渡されたコールバック関数内のあらゆる更新作業を強制的かつ同期的にフラッシュ (flush) するように React に指示します。これにより、DOM が直ちに更新されることが保証されます。<pre class="language-js"><code class="language-js"><span class="token function">flushSync</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span></code></pre></intro><inlinetoc><section class="level2"aria-labelledby="リファレンス-reference"><h2 id="リファレンス-reference">リファレンス {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="flushsynccallback-flushsync"><h3 id="flushsynccallback-flushsync"><code>flushSync(callback)</code> {/<em>flushsync</em>/}</h3><p><code>flushSync</code> を呼び出して、保留中の作業をフラッシュし、DOM を同期的に更新するよう React に強制します。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> flushSync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setSomething</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>ほとんどの場合、<code>flushSync</code> の使用は避けることができます。<code>flushSync</code> は最後の手段として使用してください。<p><a href="#usage">さらに例を見る</a><section class="level4"aria-labelledby="引数-parameters"><h4 id="引数-parameters">引数 {/<em>parameters</em>/}</h4><ul><li><code>callback</code>: 関数。React はこのコールバックを直ちに呼び出し、そこに含まれるすべての更新作業を同期的にフラッシュします。また、保留中の更新、エフェクト、エフェクト内の更新もフラッシュすることがあります。この <code>flushSync</code> 呼び出しの結果として更新のサスペンドが起きると、フォールバックが再表示される可能性があります。</ul></section><section class="level4"aria-labelledby="返り値-returns"><h4 id="返り値-returns">返り値 {/<em>returns</em>/}</h4><p><code>flushSync</code> は <code>undefined</code> を返します。</section><section class="level4"aria-labelledby="注意点-caveats"><h4 id="注意点-caveats">注意点 {/<em>caveats</em>/}</h4><ul><li><code>flushSync</code> はパフォーマンスを大幅に低下させる可能性があります。控え目に使用してください。<li><code>flushSync</code> は保留中のサスペンスバウンダリを強制的に <code>fallback</code> 状態にする可能性があります。<li><code>flushSync</code> はリターンの前に、保留中のエフェクトを実行し、そこに含まれた任意の更新も同期的に適用する場合があります。<li><code>flushSync</code> は、コールバック内の更新をフラッシュするために必要な場合、コールバック外の更新もフラッシュすることがあります。例えば、クリックによる保留中の更新作業がある場合、React はコールバック内の更新をフラッシュする前に先にそれらをフラッシュするかもしれません。</ul></section></section></section><section class="level2"aria-labelledby="使用法-usage"><h2 id="使用法-usage">使用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="サードパーティコードとの統合のために更新作業をフラッシュ-flushing-updates-for-third-party-integrations"><h3 id="サードパーティコードとの統合のために更新作業をフラッシュ-flushing-updates-for-third-party-integrations">サードパーティコードとの統合のために更新作業をフラッシュ {/<em>flushing-updates-for-third-party-integrations</em>/}</h3><p>ブラウザ API や UI ライブラリなどのサードパーティのコードと統合作業を行う際には、React に更新をフラッシュするように強制する必要があるかもしれません。コールバック内の任意の<codestep step="{1}">state 更新</codestep>を同期的にフラッシュするよう React に強制するために <code>flushSync</code> を使用します。<pre class="language-js"><code class="language-js"><span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setSomething</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// By this line, the DOM is updated.</span></code></pre><p>これにより、コードの次の行が実行される時点で、React はすでに DOM を更新しているということが保証されます。<p><strong><code>flushSync</code> の使用は一般的ではなく、頻繁に使用するとアプリのパフォーマンスが大幅に低下する可能性があります</strong>。アプリが React の API のみを使用し、サードパーティのライブラリとの結合がない場合、<code>flushSync</code> は不要のはずです。<p>しかし、これはブラウザの API などのサードパーティのコードとの統合に役立つことがあります。<p>一部のブラウザの API は、コールバック内の結果がコールバックの終了時点までに同期的に DOM に書き込まれ、ブラウザがレンダーされた DOM を操作できるようになることを期待しています。ほとんどの場合 React はこれを自動的に処理します。しかし、一部のケースでは同期的な更新を強制する必要があるかもしれません。<p>例えば、ブラウザの <code>onbeforeprint</code> API を用いると、印刷ダイアログが開く直前にページを変更することができます。これは、ドキュメントが印刷用により良く表示されるよう、カスタム印刷スタイルを適用する際に有用です。以下の例では、<code>onbeforeprint</code> コールバック内で <code>flushSync</code> を使用して、React の state を即座に DOM に「フラッシュ」します。これにより、印刷ダイアログが開いた時点では、<code>isPrinting</code> として "yes" が表示されます。</p><sandpack><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useState<span class="token punctuation">,</span> useEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> flushSync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">PrintApp</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>isPrinting<span class="token punctuation">,</span> setIsPrinting<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">handleBeforePrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">flushSync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token function">setIsPrinting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function">handleAfterPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setIsPrinting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeprint'</span><span class="token punctuation">,</span> handleBeforePrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">'afterprint'</span><span class="token punctuation">,</span> handleAfterPrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeprint'</span><span class="token punctuation">,</span> handleBeforePrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'afterprint'</span><span class="token punctuation">,</span> handleAfterPrint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span>h1<span class="token operator">></span>isPrinting<span class="token operator">:</span> <span class="token punctuation">{</span>isPrinting <span class="token operator">?</span> <span class="token string">'yes'</span> <span class="token operator">:</span> <span class="token string">'no'</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>h1<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token method function property-access">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token maybe-class-name">Print</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></sandpack><p><code>flushSync</code> がない場合、印刷ダイアログが表示される時点での <code>isPrinting</code> は "no" になります。これは、React が更新を非同期的にバッチ（束ね）処理するため、state の更新処理がなされる前に印刷ダイアログが表示されるからです。</p><pitfall><p><code>flushSync</code> はパフォーマンスを大幅に低下させ、保留中のサスペンスバウンダリのフォールバックが予期せず表示されてしまう可能性があります。<p>ほとんどの場合、<code>flushSync</code> の使用は避けることができるので、<code>flushSync</code> は最後の手段として使用してください。</p></pitfall><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>