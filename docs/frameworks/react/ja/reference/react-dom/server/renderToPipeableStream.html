<!doctype html><html lang="ja"><meta charset="utf-8"><title>renderToPipeableStream</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="rendertopipeablestream"><h1 id="rendertopipeablestream">renderToPipeableStream</h1><intro><p><code>renderToPipeableStream</code> は React ツリーをパイプ可能な <a href="https://nodejs.org/api/stream.html">Node.js ストリーム</a>にレンダーします。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe<span class="token punctuation">,</span> abort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span>reactNode<span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token punctuation">)</span></code></pre></intro><inlinetoc><note><p>この API は Node.js 専用です。Deno やモダンなエッジランタイムなどの <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">Web Stream</a> を用いる環境では、<a href="/reference/react-dom/server/renderToReadableStream"><code>renderToReadableStream</code></a> を代わりに使用してください。</p></note><section class="level2"aria-labelledby="リファレンス-reference"><h2 id="リファレンス-reference">リファレンス {/<em>reference</em>/}</h2><section class="level3"aria-labelledby="rendertopipeablestreamreactnode-options-rendertopipeablestream"><h3 id="rendertopipeablestreamreactnode-options-rendertopipeablestream"><code>renderToPipeableStream(reactNode, options?)</code> {/<em>rendertopipeablestream</em>/}</h3><p><code>renderToPipeableStream</code> を呼び出して、React ツリーを HTML として <a href="https://nodejs.org/api/stream.html#writable-streams">Node.js ストリーム</a>にレンダーします。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToPipeableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>クライアント側では、このようにサーバ生成された HTML を操作可能にするために <a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a> を用います。<p><a href="#usage">さらに例を見る</a><section class="level4"aria-labelledby="引数-parameters"><h4 id="引数-parameters">引数 {/<em>parameters</em>/}</h4><ul><li><p><code>reactNode</code>: HTML へとレンダーしたい React ノード。例えば、<code>&#x3C;App /></code> のような JSX 要素です。これはドキュメント全体を表すことが期待されているため、<code>App</code> コンポーネントは <code>&#x3C;html></code> タグをレンダーする必要があります。<li><p><strong>省略可能</strong> <code>options</code>: ストリーム関連のオプションが含まれたオブジェクト。<ul><li><strong>省略可能</strong> <code>bootstrapScriptContent</code>: 指定された場合、この文字列がインラインの <code>&#x3C;script></code> タグ内に配置されます。<li><strong>省略可能</strong> <code>bootstrapScripts</code>: ページ上に出力する <code>&#x3C;script></code> タグに対応する URL 文字列の配列。これを使用して、<a href="/reference/react-dom/client/hydrateRoot"><code>hydrateRoot</code></a> を呼び出す <code>&#x3C;script></code> を含めます。クライアントで React をまったく実行したくない場合は省略します。<li><strong>省略可能</strong> <code>bootstrapModules</code>: <code>bootstrapScripts</code> と同様ですが、代わりに <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules"><code>&#x3C;script type="module"></code></a> を出力します。<li><strong>省略可能</strong> <code>identifierPrefix</code>: React が <a href="/reference/react/useId"><code>useId</code></a> によって生成する ID に使用する文字列プレフィックス。同じページ上に複数のルートを使用する際に、競合を避けるために用います。<a href="/reference/react-dom/client/hydrateRoot#parameters"><code>hydrateRoot</code></a> にも同じプレフィックスを渡す必要があります。<li><strong>省略可能</strong> <code>namespaceURI</code>: このストリームのルート<a href="https://developer.mozilla.org/en-US/docs/Web/API/Document/createElementNS#important_namespace_uris">ネームスペース URI</a> 文字列。デフォルトでは通常の HTML です。SVG の場合は <code>'http://www.w3.org/2000/svg'</code>、MathML の場合は <code>'http://www.w3.org/1998/Math/MathML'</code> を渡します。<li><strong>省略可能</strong> <code>nonce</code>: <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src"><code>script-src</code> Content-Security-Policy</a> を用いてスクリプトを許可するための <a href="http://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#nonce"><code>nonce</code></a> 文字列。<li><strong>省略可能</strong> <code>onAllReady</code>: <a href="#specifying-what-goes-into-the-shell">シェル</a>とすべての追加<a href="#streaming-more-content-as-it-loads">コンテンツ</a>の両方を含むすべてのレンダーが完了したときに呼び出されるコールバック。<a href="#waiting-for-all-content-to-load-for-crawlers-and-static-generation">クローラや静的生成向け</a>の場合に、<code>onShellReady</code> の代わりに利用できます。ここからストリーミングを開始する場合、プログレッシブなローディングがなくなり、ストリームには最終的な HTML が含まれるようになります。<li><strong>省略可能</strong> <code>onError</code>: サーバエラーが発生するたびに発火するコールバック。<a href="#recovering-from-errors-outside-the-shell">復帰可能なエラー</a>の場合も<a href="#recovering-from-errors-inside-the-shell">そうでないエラー</a>の場合もあります。デフォルトでは <code>console.error</code> のみを呼び出します。これを上書きして<a href="#logging-crashes-on-the-server">クラッシュレポートをログに記録する</a>場合でも <code>console.error</code> を呼び出すようにしてください。また、シェルが出力される前に<a href="#setting-the-status-code">ステータスコードを調整する</a>ためにも使用できます。<li><strong>省略可能</strong> <code>onShellReady</code>: <a href="#specifying-what-goes-into-the-shell">初期シェル</a>がレンダーされた直後に呼び出されるコールバック。ここで<a href="#setting-the-status-code">ステータスコードのセット</a>を行い、<code>pipe</code> をコールしてストリーミングを開始できます。React はシェルを送信した後に、<a href="#streaming-more-content-as-it-loads">追加コンテンツ</a>と、ローディングフォールバックをそれで置換するためのインライン <code>&#x3C;script></code> タグをストリーミングします。<li><strong>省略可能</strong> <code>onShellError</code>: 初期シェルのレンダー中にエラーが発生すると呼び出されるコールバック。引数としてエラーを受け取ります。ストリームからのバイト列送信はまだ起きておらず、<code>onShellReady</code> や <code>onAllReady</code> はコールされなくなるため、<a href="#recovering-from-errors-inside-the-shell">フォールバック用の HTML シェルを出力</a>することができます。<li><strong>省略可能</strong> <code>progressiveChunkSize</code>: チャンクのバイト数。<a href="https://github.com/facebook/react/blob/14c2be8dac2d5482fda8a0906a31d239df8551fc/packages/react-server/src/ReactFizzServer.js#L210-L225">デフォルトの推論方法についてはこちらを参照してください</a>。</ul></ul></section><section class="level4"aria-labelledby="返り値-returns"><h4 id="返り値-returns">返り値 {/<em>returns</em>/}</h4><p><code>renderToPipeableStream</code> は以下の 2 つのメソッドを含んだオブジェクトを返します。<ul><li><code>pipe</code>: HTML を <a href="https://nodejs.org/api/stream.html#writable-streams">Node.js の Writable ストリーム</a>に出力します。<code>pipe</code> の呼び出しは、ストリーミングを有効にしたい場合は <code>onShellReady</code> で、クローラや静的生成向けの出力を行いたい場合は <code>onAllReady</code> で行ってください。<li><code>abort</code>: <a href="#aborting-server-rendering">サーバでのレンダーを中止</a>してクライアントで残りをレンダーするために使用します。</ul></section></section></section><section class="level2"aria-labelledby="使用法-usage"><h2 id="使用法-usage">使用法 {/<em>usage</em>/}</h2><section class="level3"aria-labelledby="react-ツリーを-html-として-nodejs-ストリームにレンダーする-rendering-a-react-tree-as-html-to-a-nodejs-stream"><h3 id="react-ツリーを-html-として-nodejs-ストリームにレンダーする-rendering-a-react-tree-as-html-to-a-nodejs-stream">React ツリーを HTML として Node.js ストリームにレンダーする {/<em>rendering-a-react-tree-as-html-to-a-nodejs-stream</em>/}</h3><p><code>renderToPipeableStream</code> を呼び出して、React ツリーを HTML として <a href="https://developer.mozilla.org/en-US/docs/Web/API/ReadableStream">Node.js ストリーム</a> にレンダーします。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> renderToPipeableStream <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/server'</span><span class="token punctuation">;</span>

<span class="token comment">// The route handler syntax depends on your backend framework</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><codestep step="{1}">ルートコンポーネント</codestep>と<codestep step="{2}">ブートストラップ <code>&#x3C;script></code> パス</codestep>のリストを指定する必要があります。ルートコンポーネントは、<strong>ルートの <code>&#x3C;html></code> タグを含んだドキュメント全体</strong>を返すようにします。<p>例えば以下のような形になるでしょう。<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta charSet<span class="token operator">=</span><span class="token string">"utf-8"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1"</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"/styles.css"</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>title<span class="token operator">></span><span class="token maybe-class-name">My</span> app<span class="token operator">&#x3C;</span><span class="token operator">/</span>title<span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>body<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Router</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>body<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>React は <a href="https://developer.mozilla.org/en-US/docs/Glossary/Doctype">doctype</a> とあなたが指定した<codestep step="{2}">ブートストラップ <code>&#x3C;script></code> タグ</codestep>を結果の HTML ストリームに注入します。<pre class="language-html"><code class="language-html"><span class="token doctype"><span class="token punctuation">&#x3C;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>html</span><span class="token punctuation">></span></span>
  <span class="token comment">&#x3C;!-- ... HTML from your components ... --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/main.js<span class="token punctuation">"</span></span> <span class="token attr-name">async</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>クライアント側では、ブートストラップスクリプトは <a href="/reference/react-dom/client/hydrateRoot#hydrating-an-entire-document"><code>hydrateRoot</code> を呼び出して <code>document</code> 全体のハイドレーションを行う</a>必要があります。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>これにより、サーバで生成された HTML にイベントリスナが追加され、操作可能になります。</p><deepdive><section class="level4"aria-labelledby="ビルド出力から-css-と-js-のアセットパスを読み取る-reading-css-and-js-asset-paths-from-the-build-output"><h4 id="ビルド出力から-css-と-js-のアセットパスを読み取る-reading-css-and-js-asset-paths-from-the-build-output">ビルド出力から CSS と JS のアセットパスを読み取る {/<em>reading-css-and-js-asset-paths-from-the-build-output</em>/}</h4><p>ビルド後に、最終的なアセット URL（JavaScript や CSS ファイルなど）にはよくハッシュ化が行われます。例えば、<code>styles.css</code> が <code>styles.123456.css</code> になることがあります。静的なアセットのファイル名をハッシュ化することで、同じアセットがビルドごとに異なるファイル名になることが保証されます。これが有用なのは、ある特定の名前を持つファイルの内容が不変になり、静的なアセットの長期的なキャッシングを安全に行えるようになるためです。<p>しかし、ビルド後までアセット URL が分からない場合、それらをソースコードに含めることができません。例えば、先ほどのように JSX に <code>"/styles.css"</code> をハードコーディングする方法は動作しません。ソースコードにそれらを含めないようにするため、ルートコンポーネントが、props 経由で渡されたマップから実際のファイル名を読み取るようにすることができます。<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">App</span></span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> assetMap <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span>html<span class="token operator">></span>
      <span class="token operator">&#x3C;</span>head<span class="token operator">></span>
        <span class="token spread operator">...</span>
        <span class="token operator">&#x3C;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">[</span><span class="token string">'styles.css'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token operator">></span><span class="token operator">&#x3C;</span><span class="token operator">/</span>link<span class="token operator">></span>
        <span class="token spread operator">...</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>head<span class="token operator">></span>
      <span class="token spread operator">...</span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>html<span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>サーバ上では、<code>&#x3C;App assetMap={assetMap} /></code> のようにレンダーし、アセット URL を含む <code>assetMap</code> を渡します。<pre class="language-js"><code class="language-js"><span class="token comment">// You'd need to get this JSON from your build tooling, e.g. read it from the build output.</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>サーバで <code>&#x3C;App assetMap={assetMap} /></code> のようにレンダーしているので、クライアントでも <code>assetMap</code> を使ってレンダーしてハイドレーションエラーを避ける必要があります。このためには以下のように <code>assetMap</code> をシリアライズしてクライアントに渡します。<pre class="language-js"><code class="language-js"><span class="token comment">// You'd need to get this JSON from your build tooling.</span>
<span class="token keyword">const</span> assetMap <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token string-property property">'styles.css'</span><span class="token operator">:</span> <span class="token string">'/styles.123456.css'</span><span class="token punctuation">,</span>
  <span class="token string-property property">'main.js'</span><span class="token operator">:</span> <span class="token string">'/main.123456.js'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span>assetMap<span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// Careful: It's safe to stringify() this because this data isn't user-generated.</span>
    <span class="token literal-property property">bootstrapScriptContent</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">window.assetMap = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>assetMap<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span>assetMap<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>上記の例では、<code>bootstrapScriptContent</code> オプションを使って<code>&#x3C;script></code> タグを追加して、クライアント上でグローバル <code>window.assetMap</code> 変数をセットしています。これにより、クライアントのコードが同じ <code>assetMap</code> を読み取れるようになります。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> hydrateRoot <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react-dom/client'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token maybe-class-name">App</span></span> <span class="token keyword module">from</span> <span class="token string">'./App.js'</span><span class="token punctuation">;</span>

<span class="token function">hydrateRoot</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">,</span> <span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> assetMap<span class="token operator">=</span><span class="token punctuation">{</span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">assetMap</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>クライアントとサーバの両方が props として同じ <code>assetMap</code> を使って <code>App</code> をレンダーするため、ハイドレーションエラーは発生しません。</section></deepdive></section><section class="level3"aria-labelledby="ロードが進むにつれてコンテンツをストリーミングする-streaming-more-content-as-it-loads"><h3 id="ロードが進むにつれてコンテンツをストリーミングする-streaming-more-content-as-it-loads">ロードが進むにつれてコンテンツをストリーミングする {/<em>streaming-more-content-as-it-loads</em>/}</h3><p>ストリーミングにより、サーバ上ですべてのデータがロードされる前に、ユーザがコンテンツを見始められるようにすることができます。例えば以下のようなプロフィールページがあり、カバー、フレンド・写真が含まれたサイドバー、投稿のリストを表示しているところを考えましょう。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>ここで、<code>&#x3C;Posts /></code> のデータを読み込むのに時間がかかるとしましょう。理想的には、投稿の読み込みを待つことなく、プロフィールページの残りのコンテンツをユーザに表示したいでしょう。これを実現するには、<a href="/reference/react/Suspense#displaying-a-fallback-while-content-is-loading"><code>Posts</code> を <code>&#x3C;Suspense></code> バウンダリで囲みます</a>。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>これにより React に、<code>Posts</code> のデータが読み込まれる前に HTML をストリーミング開始するよう指示します。React はまず、ローディングフォールバック (<code>PostsGlimmer</code>) の HTML を送信します。次に <code>Posts</code> のデータ読み込みが完了したら、残りの HTML と、ローディングフォールバックをそれで置換するためのインライン <code>&#x3C;script></code> タグを送信します。ユーザから見ると、ページにはまず <code>PostsGlimmer</code> が表示され、後からそれが <code>Posts</code> に置き換わることになります。<p>さらに、より細かく読み込みシーケンスを制御するために<a href="/reference/react/Suspense#revealing-nested-content-as-it-loads"><code>&#x3C;Suspense></code> バウンダリをネストさせることもできます</a>。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>この例では、React はページのストリーミングをさらに素早く開始できます。最初にレンダーが完了している必要があるのは、<code>&#x3C;Suspense></code> バウンダリで囲まれていない <code>ProfileLayout</code> と <code>ProfileCover</code> だけです。<code>Sidebar</code>、<code>Friends</code>、<code>Photos</code> がデータを読み込む必要がある場合、React は <code>BigSpinner</code> のフォールバック HTML を代わりに送信します。その後、より多くのデータが利用可能になるにつれ、より多くのコンテンツが表示されていき、最終的にすべてが表示されます。<p>ストリーミングでは、ブラウザで React 自体が読み込まれるのを待つ必要も、アプリが操作可能になるのを待つ必要もありません。サーバからの HTML コンテンツは、あらゆる <code>&#x3C;script></code> タグが読み込まれる前にプログレッシブに表示されます。<p><a href="https://github.com/reactwg/react-18/discussions/37">HTML ストリーミングの動作について詳しく読む</a></p><note><p><strong>サスペンスコンポーネントをアクティブ化できるのはサスペンス対応のデータソースだけです</strong>。これには以下が含まれます：<ul><li><a href="https://relay.dev/docs/guided-tour/rendering/loading-states/">Relay</a> や <a href="https://nextjs.org/docs/getting-started/react-essentials">Next.js</a> のようなサスペンス対応のフレームワークでのデータフェッチ<li><a href="/reference/react/lazy"><code>lazy</code></a> を用いたコンポーネントコードの遅延ロード<li><a href="/reference/react/use"><code>use</code></a> を用いたプロミス (Promise) からの値の読み取り</ul><p>サスペンスはエフェクトやイベントハンドラ内でデータフェッチが行われた場合にはそれを<strong>検出しません</strong>。<p>上記の <code>Posts</code> コンポーネントで実際にデータをロードする方法は、使用するフレームワークによって異なります。サスペンス対応のフレームワークを使用している場合、詳細はデータフェッチに関するドキュメンテーション内に記載されているはずです。<p>使い方の規約のある (opinionated) フレームワークを使用せずにサスペンスを使ったデータフェッチを行うことは、まだサポートされていません。サスペンス対応のデータソースを実装するための要件はまだ不安定であり、ドキュメント化されていません。データソースをサスペンスと統合するための公式な API は、React の将来のバージョンでリリースされる予定です。</p></note></section><section class="level3"aria-labelledby="シェルに何を含めるかの指定-specifying-what-goes-into-the-shell"><h3 id="シェルに何を含めるかの指定-specifying-what-goes-into-the-shell">シェルに何を含めるかの指定 {/<em>specifying-what-goes-into-the-shell</em>/}</h3><p>アプリの全 <code>&#x3C;Suspense></code> バウンダリより外にある部分のことを<em>シェル (shell)</em> と呼びます。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Friends</span> <span class="token operator">/</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photos</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Sidebar</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
          <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>これが、ユーザに見える最初のローディング中状態を決定します。<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">BigSpinner</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span></code></pre><p>もしルート部分でアプリ全体を <code>&#x3C;Suspense></code> バウンダリでラップしてしまうと、シェルとしてはそのスピナだけが含まれることになります。しかしこれはあまり快適なユーザ体験にはなりません。大きなスピナが画面に表示されることは、もう少しだけ待ってから実際のレイアウトを表示することよりも遅く不快に感じられるためです。したがって、<code>&#x3C;Suspense></code> 境界は適切に配置して、シェルが<em>ミニマルかつ完全</em>に感じられるように必要があるでしょう。例えばページレイアウト全体のスケルトンのようなものです。<p>シェル全体のレンダーが完了したときに <code>onShellReady</code> コールバックが呼び出されます。通常、ここでストリーミングを開始します。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>onShellReady</code> が呼び出される時点では、ネストされた <code>&#x3C;Suspense></code> バウンダリ内のコンポーネントはまだデータをロード中かもしれません。</section><section class="level3"aria-labelledby="サーバ上でのクラッシュログの記録-logging-crashes-on-the-server"><h3 id="サーバ上でのクラッシュログの記録-logging-crashes-on-the-server">サーバ上でのクラッシュログの記録 {/<em>logging-crashes-on-the-server</em>/}</h3><p>デフォルトでは、サーバ上のすべてのエラーはコンソールにログとして記録されます。この挙動をオーバーライドして、クラッシュレポートをログとして記録することができます。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>カスタムの <code>onError</code> 実装を提供する場合、上記のようにエラーをコンソールにもログとして記録することを忘れないでください。</section><section class="level3"aria-labelledby="シェル内のエラーからの復帰-recovering-from-errors-inside-the-shell"><h3 id="シェル内のエラーからの復帰-recovering-from-errors-inside-the-shell">シェル内のエラーからの復帰 {/<em>recovering-from-errors-inside-the-shell</em>/}</h3><p>この例では、シェルとして <code>ProfileLayout</code>、<code>ProfileCover</code>、および <code>PostsGlimmer</code> が含まれています。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>これらのコンポーネントをレンダーする際にエラーが発生した場合、React はクライアントに送信できる意味のある HTML を提供できません。最終手段として、<code>onShellError</code> をオーバーライドして、サーバレンダリングに依存しないフォールバック HTML を送信しましょう。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>シェルの生成中にエラーが発生した場合、<code>onError</code> と <code>onShellError</code> の両方が発火します。エラーレポートには <code>onError</code> を使用し、フォールバックの HTML ドキュメントを送信するためには <code>onShellError</code> を使用します。フォールバック HTML はエラーページである必要はありません。代わりに、クライアントのみでアプリをレンダーするための代替シェルを含めることも可能です。</section><section class="level3"aria-labelledby="シェル外のエラーからの復帰-recovering-from-errors-outside-the-shell"><h3 id="シェル外のエラーからの復帰-recovering-from-errors-outside-the-shell">シェル外のエラーからの復帰 {/<em>recovering-from-errors-outside-the-shell</em>/}</h3><p>この例では、<code>&#x3C;Posts /></code> コンポーネントは <code>&#x3C;Suspense></code> でラップされているため、シェルの一部では<em>ありません</em>。<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">ProfilePage</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ProfileCover</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PostsGlimmer</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Posts</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">ProfileLayout</span><span class="token operator">></span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>Posts</code> コンポーネントまたはその内部のどこかでエラーが発生した場合、React はそこからの<a href="/reference/react/Suspense#providing-a-fallback-for-server-errors-and-client-only-content">復帰を試みます</a>。<ol><li>最も近い <code>&#x3C;Suspense></code> バウンダリ (<code>PostsGlimmer</code>) のローディングフォールバックを HTML として出力します。<li>サーバ上で <code>Posts</code> のコンテンツをレンダーしようとするのを諦めます。<li>JavaScript コードがクライアント上でロードされると、React はクライアント上で <code>Posts</code> のレンダーを<em>再試行</em>します。</ol><p>クライアント上で <code>Posts</code> のレンダーを再試行して<em>再度</em>失敗した場合、React はクライアント上でエラーをスローします。レンダー中にスローされる他のすべてのエラーと同様に、<a href="/reference/react/Component#static-getderivedstatefromerror">最も近い親のエラーバウンダリ</a>がユーザにエラーをどのように提示するかを決定します。つまり、エラーが復帰不能であることが確定するまで、ユーザにはローディングインジケータが見えることになります。<p>クライアント上での <code>Posts</code> のレンダー再試行が成功した場合、サーバからのローディングフォールバックはクライアントでのレンダー出力で置き換えられます。ユーザにはサーバエラーが発生したことは分かりません。ただし、サーバの <code>onError</code> コールバックとクライアントの <a href="/reference/react-dom/client/hydrateRoot#hydrateroot"><code>onRecoverableError</code></a> コールバックが発火するため、エラーについて通知を受け取ることができます。</section><section class="level3"aria-labelledby="ステータスコードの設定-setting-the-status-code"><h3 id="ステータスコードの設定-setting-the-status-code">ステータスコードの設定 {/<em>setting-the-status-code</em>/}</h3><p>ストリーミングにはトレードオフも存在します。ユーザがコンテンツを早く見ることができるように、できるだけ早くページのストリーミングを開始したいでしょう。一方で、ストリーミングを開始すると、レスポンスのステータスコードを設定することができなくなります。<p>シェル（すべての <code>&#x3C;Suspense></code> バウンダリより上の部分）とそれ以外のコンテンツに<a href="#specifying-what-goes-into-the-shell">アプリを分割する</a>ことで、この問題はすでに部分的に解決されています。シェルでエラーが発生した場合、<code>onShellError</code> コールバックが呼び出され、エラーのステータスコードをセットすることができます。それ以外の場合は、アプリがクライアント上で復帰できる可能性があるため、"OK" を送信できるのです。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>シェルの<em>外側</em>（つまり <code>&#x3C;Suspense></code> バウンダリの内側）のコンポーネントでエラーが発生した場合、React はレンダーを停止しません。これは、<code>onError</code> コールバックは発火するものの、その後 <code>onShellError</code> ではなく <code>onShellReady</code> が発火することを意味します。これは<a href="#recovering-from-errors-outside-the-shell">上記で説明したように</a>、React がそのエラーをクライアント上で復帰しようとするからです。<p>ただしお望みであれば、何らかのエラーが起きたという事実に基づいたステータスコードを設定することもできます。<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>これは、初期のシェルコンテンツの生成中に既にシェルの外側で発生したエラーが捕捉できるだけなので、完全ではありません。あるコンテンツでエラーが発生したかどうかを知ることが重要であれば、それをシェルに移動させることができます。</section><section class="level3"aria-labelledby="エラーの種類によって処理を分ける-handling-different-errors-in-different-ways"><h3 id="エラーの種類によって処理を分ける-handling-different-errors-in-different-ways">エラーの種類によって処理を分ける {/<em>handling-different-errors-in-different-ways</em>/}</h3><p>カスタムの <code>Error</code> サブクラスを<a href="https://javascript.info/custom-errors">作成</a>し、<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/instanceof"><code>instanceof</code></a> 演算子を使用してどんなエラーがスローされたかをチェックすることができます。例えば、カスタムの <code>NotFoundError</code> を定義し、コンポーネントからそれをスローすることができます。その後、<code>onError</code>、<code>onShellReady</code>, <code>onShellError</code> のコールバック中でエラーの種類に応じて異なる処理を行うことができます。<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> caughtError <span class="token operator">=</span> <span class="token keyword null nil">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>didError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>caughtError <span class="token keyword">instanceof</span> <span class="token class-name">NotFoundError</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token number">404</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    caughtError <span class="token operator">=</span> error<span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>しかしシェルを出力してストリーミングを開始してしまうと、ステータスコードを変更できなくなりますので注意してください。</section><section class="level3"aria-labelledby="クローラや静的生成向けに全コンテンツの読み込みを待機する-waiting-for-all-content-to-load-for-crawlers-and-static-generation"><h3 id="クローラや静的生成向けに全コンテンツの読み込みを待機する-waiting-for-all-content-to-load-for-crawlers-and-static-generation">クローラや静的生成向けに全コンテンツの読み込みを待機する {/<em>waiting-for-all-content-to-load-for-crawlers-and-static-generation</em>/}</h3><p>ストリーミングにより、利用可能になった順でコンテンツをユーザが見えるようになるため、ユーザ体験が向上します。<p>しかし、クローラがページを訪れた場合や、ビルド時にページを生成している場合には、コンテンツを徐々に表示するのではなく、すべてのコンテンツを最初にロードしてから最終的な HTML 出力を生成したいでしょう。<p><code>onAllReady</code> コールバックを用いることで、すべてのコンテンツが読み込まれるまで待機を行うことができます。<pre class="language-js"><code class="language-js"><span class="token keyword">let</span> didError <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> isCrawler <span class="token operator">=</span> <span class="token comment">// ... depends on your bot detection strategy ...</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> pipe <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">bootstrapScripts</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/main.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function">onShellReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isCrawler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onShellError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'&#x3C;h1>Something went wrong&#x3C;/h1>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onAllReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>isCrawler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token property-access">statusCode</span> <span class="token operator">=</span> didError <span class="token operator">?</span> <span class="token number">500</span> <span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">;</span>
      response<span class="token punctuation">.</span><span class="token method function property-access">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>      
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">onError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    didError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">logServerCrashReport</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>通常のユーザは、ストリームで読み込まれるコンテンツを段階的に受け取ります。クローラは、全データが読み込まれた後の最終的な HTML 出力を受け取ります。しかし、これはクローラが<em>すべての</em>データを待つ必要があることを意味し、その中には読み込みが遅いものやエラーが発生するものも含まれるかもしれません。アプリケーションによっては、クローラにもシェルを送信することを選択しても構いません。</section><section class="level3"aria-labelledby="サーバレンダリングの中止-aborting-server-rendering"><h3 id="サーバレンダリングの中止-aborting-server-rendering">サーバレンダリングの中止 {/<em>aborting-server-rendering</em>/}</h3><p>タイムアウト後にサーバでのレンダーを「諦める」ように強制することが可能です。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> pipe<span class="token punctuation">,</span> abort <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">renderToPipeableStream</span><span class="token punctuation">(</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">App</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>React は、残りのローディング中フォールバックを HTML として直ちに出力し、クライアント上で残りをレンダーしようと試みます。 <span style="float:footnote"><a href="../../../index.html#toc">Go to TOC</a></span></section></section></inlinetoc></section>