<!doctype html><html lang="ja"><meta charset="utf-8"><title>"React v18.0"</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="react-v180"><h1 id="react-v180">"React v18.0"</h1><p>author: The React Team date: 2022/03/08 description: React 18 is now available on npm! In our last post, we shared step-by-step instructions for upgrading your app to React 18. In this post, we'll give an overview of what's new in React 18, and what it means for the future.<p>March 29, 2022 by <a href="/community/team">The React Team</a></p><intro><p>React 18 が npm で利用可能になりました！ 前回の投稿にて、<a href="/blog/2022/03/08/react-18-upgrade-guide">アプリを React 18 にアップグレードする</a>ためのステップバイステップガイドを共有しました。この投稿では、React 18 の新機能や、将来に向けての展望をお伝えします。</p></intro><p>この最新のメジャーバージョンには、自動バッチング (automatic batching) のような自動で有効になる機能改善、startTransition のような新たな API、そしてサスペンス (suspense) に対応したストリーミングでのサーバサイドレンダリング機能が含まれています。<p>React 18 の機能の多くが基盤としているのは新たに加わった並行レンダラ (concurrent renderer) であり、これが強力な新機能群を実現するために裏で働くようになっています。React の並行処理機能はオプトインであり、並行処理機能を使う場合にのみ有効になるものですが、これは皆さんのアプリ作成方法に大きな影響を与えるものであると思っています。<p>我々は React で並行処理をサポートするために何年ものあいだ研究開発を重ねてきており、特に既存ユーザが段階的に採用できる方法を提供することに関しては注意を払ってきました。昨年の夏に <a href="/blog/2021/06/08/the-plan-for-react-18">React 18 ワーキンググループ</a>を作成し、エキスパートやコミュニティからフィードバックを集め、React のエコシステム全体がスムースにアップグレードできるようにしてきました。<p>また、React Conf 2021 でも多くのことを共有してきました。<ul><li><a href="https://www.youtube.com/watch?v=FZ0cG47msEk&#x26;list=PLNG_1j3cPCaZZ7etkzWA7JfdmKWT0pMsa">キーノート</a>では、素晴らしいユーザ体験を開発者が簡単に構築できるようにするという我々の使命に React 18 がどう関わるのかについて説明しています。<li><a href="https://twitter.com/shrutikapoor08">Shruti Kapoor</a> は <a href="https://www.youtube.com/watch?v=ytudH8je5ko&#x26;list=PLNG_1j3cPCaZZ7etkzWA7JfdmKWT0pMsa&#x26;index=2">React 18 の新機能の使い方についてデモを行っています</a>。<li><a href="https://twitter.com/shaundai">Shaundai Person</a> は<a href="https://www.youtube.com/watch?v=pj5N-Khihgc&#x26;list=PLNG_1j3cPCaZZ7etkzWA7JfdmKWT0pMsa&#x26;index=3">サスペンスを用いたストリーミングサーバレンダリング</a>についての概要を説明しています。</ul><p>以下が、並行レンダー機能をはじめとする、このリリースで期待される新要素の概要です。</p><note><p>React Native ユーザ向け：React 18 は新たなアーキテクチャの React Native の一部としてリリースされます。詳細については<a href="https://www.youtube.com/watch?v=FZ0cG47msEk&#x26;t=1530s">こちらの React Conf キーノート</a>を参照してください。*</p></note><section class="level2"aria-labelledby="react-の並行処理機能とは-what-is-concurrent-react"><h2 id="react-の並行処理機能とは-what-is-concurrent-react">React の並行処理機能とは？ {/<em>what-is-concurrent-react</em>/}</h2><p>React 18 で加わった中で最も重要なものとはすなわち「並行処理機能」ですが、これはできることなら皆さんが全く考えないで済むのが望ましいことです。ただしアプリケーション開発者にとっては概ねその通りでしょうが、ライブラリのメンテナにとっては話はちょっと複雑かもしれません。<p>並行処理は、それ自体が何か機能だというわけではありません。これは、同時に UI の複数のバージョンを React が準備しておけるようにするための、新たな裏方のメカニズムです。並行処理機能そのものは実装の詳細 (implementation detail) に過ぎず、それが有用なのはそれで実現できる様々な機能が存在するからこそだ、と考えてください。React は内部の実装において priority queue や multiple buffering などの洗練された手法を用いています。ですがこれらのコンセプトは公開 API のどこにも現れません。<p>我々が API を設計する際には、開発者に実装の詳細を見せないように努力しています。React 開発者としてみなさんはユーザ体験を<em>どんな</em>見た目にしたいかを考えることに集中し、その見た目を<em>どのように</em>実現するのかは React が受け持ちます。React 開発者が、裏で並行処理機能がどのように働いているのかを知る必要はありません。<p>しかし、React の並行処理機能は、普通の「実装の詳細」と比べてより重要なものであり、React のコアのレンダリングモデルに対する本質的な変更です。ですので並行処理の動作について詳しく知ることがもの凄く重要ということではないにせよ、どのようなものかについて高レベルの概観を知っておくことは有用かもしれません。<p>React の並行処理機能の重要な特性は、処理を中断可能であるということです。React 18 にアップグレードしても、何らかの並行処理機能を加えるまでは、更新は React の以前のバージョンと同じく、まとめて、中断されず、かつ同期的にレンダーされます。同期的なレンダーでは、更新のレンダーが始まったら、ユーザが結果を画面で見られるようになるまでそれを中断することはできません。<p>並行レンダーにおいては、これが必ずしも正しくなくなります。React は更新のレンダーを開始し、途中で一時停止し、後で再開することができます。途中まで終わったレンダーを完全に捨ててしまうこともありえます。レンダーが中断したとしても、React は UI の見た目に一貫性があることを保証します。これを実現するために、React はツリー全体の評価が終わるまで DOM の書き換えをせずに待機します。これにより、React はメインスレッドをブロックせずにバックグラウンドで次の画面を用意しておけるようになります。つまり、大きなレンダー作業の最中でもユーザの入力に UI が即座に反応できるということであり、ユーザ体験がスムースになります。<p>もう 1 つの例は、state の再利用です。React の並行処理機能により、画面から UI の一部分をいったん削除し、前回の state を再利用しながら後で戻す、ということが可能です。例えば、ユーザがタブを切り替えて画面から離れて戻ってきた場合、React は以前の画面を以前と同様の state で復帰させる必要があります。将来のマイナーリリースにおいて、このパターンを実装した <code>&#x3C;Offscreen></code> というコンポーネントを新たに加える予定です。同様に、<code>&#x3C;Offscreen></code> を使ってバックグラウンドで新しい UI を用意し、ユーザが表示させようとする前に準備完了にしておく、ということもできるようになるでしょう。<p>並行レンダーは React における新しいパワフルなツールであり、サスペンス、トランジション、ストリーミング付きサーバーレンダリングといった新たな機能のほとんどはこれを活用して構築されています。しかし React 18 はこの新しい基盤の上に我々が構築しようとしているものの始まりに過ぎません。</section><section class="level2"aria-labelledby="並行処理機能の段階的な採用-gradually-adopting-concurrent-features"><h2 id="並行処理機能の段階的な採用-gradually-adopting-concurrent-features">並行処理機能の段階的な採用 {/<em>gradually-adopting-concurrent-features</em>/}</h2><p>厳密には、並行レンダーは破壊的変更です。並行レンダーは中断可能なため、それが有効になるとコンポーネントはわずかに異なった動作をします。<p>我々はテストにおいて、数千のコンポーネントを React 18 のためにアップグレードしました。そこで分かったことは、ほとんどすべての既存のコンポーネントは並行レンダーにおいても「普通に」動作するということです。しかしいくつかのコンポーネントでは移行のための追加作業が必要です。変更は通常小さなものですが、自分のペースで更新作業を行うことも可能です。React 18 の新たなレンダーの挙動は、<strong>あなたのアプリ内で新機能を使っている部分でのみ有効化されます</strong>。<p>大まかな移行作業の流れとしては、まず既存コードの挙動を壊さずにアプリが React 18 で動作するようにします。それから自分のペースで並行処理機能を徐々に追加し始めることができます。<a href="./strict-mode.html"><code>&#x3C;StrictMode></code></a> を利用すれば、並行処理に関連するバグに開発時に気付きやすいようにできます。strict モードは本番での動作に影響を与えませんが、開発中には追加の警告を表示したり、べき等 (idempotent) であるべき関数を 2 回呼び出したりします。すべての間違いを捕捉することはできませんが、最もよくある間違いを防ぐのに効果的です。<p>React 18 にアップグレード後、並行処理機能をすぐに使い始めることができます。例えばユーザの入力をブロックせずに画面遷移を行うために startTransition を使うことができます。あるいは高価な再レンダーの頻度を落とすために useDeferredValue を使うことも可能です。<p>しかし長期的には、あなたのアプリに並行処理を加えるためのメインの方法は、並行処理に対応したライブラリやフレームワークを使うことになるだろうと考えています。ほとんどの場合、あなたが並行処理の API を直接触ることはないはずです。例えば新しい画面に遷移するたびに毎回開発者が startTransition をコールするのではなく、ルータのライブラリがナビゲーションを startTransition で自動でラップするようになるでしょう。<p>ライブラリがアップグレードされて並行処理機能対応になるまでには、多少時間がかかるかもしれません。並行処理機能をライブラリが活用しやすくするために新しい API を提供しています。当面は、React エコシステムが徐々に移行していくまで、ライブラリメンテナが作業するのをお待ちください。<p>詳細は、前回の投稿をご覧ください：<a href="/blog/2022/03/08/react-18-upgrade-guide">React 18 アップグレードガイド</a>.</section><section class="level2"aria-labelledby="データフレームワークにおけるサスペンス-suspense-in-data-frameworks"><h2 id="データフレームワークにおけるサスペンス-suspense-in-data-frameworks">データフレームワークにおけるサスペンス {/<em>suspense-in-data-frameworks</em>/}</h2><p>React 18 では、Relay、Next.js、Hydrogen、Remix のような、使い方の規約がある (opinionated) フレームワークにおいて、データ取得のためのサスペンスを使い始めることができます。単発的なデータ取得にサスペンスを使うことも技術的には可能ですが、現時点では一般的な戦略としてはお勧めしません。<p>将来的には、上記のようなフレームワークを用いなくてもあなたのデータにサスペンスを使ってアクセスしやすくするため、新たに基本機能を提供するかもしれません。しかしサスペンスは、ルータやデータレイヤ、サーバレンダリング環境といったあなたのアプリのアーキテクチャと深く結合して利用される場合に、最も効果を発揮します。長期的にも、ライブラリやフレームワークが React のエコシステムにおいて重要な働きをすることを期待しています。<p>React の以前のバージョンと同様、サスペンスはクライアントで React.lazy を使ってコードを分割する際にも利用できます。しかし我々がサスペンスを使って実現したいと構想しているのは、コードのロードよりもずっと多くのことです。目標は、サスペンスのサポートを拡張していき、いずれはサスペンスによるひとつの宣言的なフォールバックが、あらゆる非同期的な操作（コード、データ、画像などのロード）を扱えるようにすることです。</section><section class="level2"aria-labelledby="サーバコンポーネントはまだ開発中です-server-components-is-still-in-development"><h2 id="サーバコンポーネントはまだ開発中です-server-components-is-still-in-development">サーバコンポーネントはまだ開発中です {/<em>server-components-is-still-in-development</em>/}</h2><p><a href="/blog/2020/12/21/data-fetching-with-react-server-components.html"><strong>サーバコンポーネント</strong></a> は実装予定の機能であり、クライアントサイドアプリにおけるリッチなインタラクティビティと伝統的なサーバレンダリングによるパフォーマンス改善とを兼ね備えた、クライアント・サーバ両方にまたがるアプリの開発を可能にするものです。サーバコンポーネントは React の並行処理機能と本質的に結合してはいませんが、サスペンスやストリーミングサーバレンダリングのような並行処理機能と併用した際に最もうまく働くようデザインされています。<p>サーバコンポーネントはまだ実験的機能ですが、18.x のマイナーリリースで初期バージョンをリリースできる見込みです。それまでは、プロポーザルを推し進めて広く採用できる準備が整うよう、Next.js、Hydrogen、Remix のようなフレームワークと協力していきます。</section><section class="level2"aria-labelledby="react-18-の新要素-whats-new-in-react-18"><h2 id="react-18-の新要素-whats-new-in-react-18">React 18 の新要素 {/<em>whats-new-in-react-18</em>/}</h2><section class="level3"aria-labelledby="新機能自動バッチング-new-feature-automatic-batching"><h3 id="新機能自動バッチング-new-feature-automatic-batching">新機能：自動バッチング {/<em>new-feature-automatic-batching</em>/}</h3><p>バッチングとは React がパフォーマンスのために複数のステート更新をグループ化して、単一の再レンダーにまとめることを指します。自動バッチング以前は、React のイベントハンドラ内での更新のみバッチ処理されていました。promise や setTimeout、ネイティブのイベントハンドラやその他あらゆるイベント内で起きる更新はデフォルトではバッチ処理されていませんでした。自動バッチングにより、これらの更新も自動でバッチ処理されるようになります：<pre class="language-js"><code class="language-js"><span class="token comment">// Before: only React events were batched.</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// React will render twice, once for each state update (no batching)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// After: updates inside of timeouts, promises,</span>
<span class="token comment">// native event handlers or any other event are batched.</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setCount</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token arrow operator">=></span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token parameter">f</span> <span class="token arrow operator">=></span> <span class="token operator">!</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// React will only re-render once at the end (that's batching!)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>詳細については、<a href="https://github.com/reactwg/react-18/discussions/21">Automatic batching for fewer renders in React 18</a> を参照してください。</section><section class="level3"aria-labelledby="新機能トランジション-new-feature-transitions"><h3 id="新機能トランジション-new-feature-transitions">新機能：トランジション {/<em>new-feature-transitions</em>/}</h3><p>トランジション（transition; 段階的推移）とは React における新たな概念であり、緊急性の高い更新 (urgent update) と高くない更新 (non-urgent update) を区別するためのものです。<ul><li><strong>緊急性の高い更新</strong>とはタイプ、クリック、プレスといったユーザ操作を直接反映するものです。<li><strong>トランジションによる更新</strong>は UI をある画面から別の画面に段階的に遷移させるものです。</ul><p>タイプ、クリック、プレスのような緊急性の高い更新は、物理的な物体の挙動に関する我々の直観に反しないよう、即座に反応する必要があり、そうでないと「おかしい」と認識されてしまいます。一方でトランジション内では、ユーザは画面上であらゆる中間の値が見えることを期待していません。<p>例えば、ドロップダウン内でフィルタを選択した場合、フィルタボタン自体はクリックした瞬間に反応することを期待するでしょう。しかしフィルタの結果は、ボタンの反応とは別に徐々に現れても構いません。小さな遅延は認識できませんし、あって構わないものです。また、前のレンダーが終わっていない段階で再びフィルタを変更した場合、最終的な結果以外は気にしません。<p>典型的には、最良のユーザ体験のためには、あるひとつのユーザ入力は緊急性の高い更新と高くない更新の両方を引き起こすようにするべきです。input イベント内で startTransition API を用い、React にどの更新の緊急性が高く、どれが「トランジション」なのかを伝えることができます：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> startTransition <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token comment">// Urgent: Show what was typed</span>
<span class="token function">setInputValue</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Mark any state updates inside as transitions</span>
<span class="token function">startTransition</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// Transition: Show the results</span>
  <span class="token function">setSearchQuery</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>startTransition でラップした更新は緊急性の低いものとして扱われ、クリックやキー押下のような緊急性の高い更新がやってきた場合には中断されます。トランジションがユーザによって中断された場合（例えば素早く複数のタイプが起こった場合）、React は完了しないままに古くなったレンダーを破棄して、最後の更新のみレンダーします。<ul><li><code>useTransition</code>: トランジションを開始するためのフックであり、保留中かどうかの状態を追跡するための値も含まれます。<li><code>startTransition</code>: フックが使えない場合にトランジションを開始するためのメソッドです。</ul><p>トランジションを使うと並行レンダー機能にオプトインし、更新が中断可能になります。また、コンテンツが再サスペンドした場合、バックグラウンドでトランジション中のコンテンツをレンダーしつつ、現在のコンテンツを表示し続けるよう React に伝えます（詳細については <a href="https://github.com/reactjs/rfcs/blob/main/text/0213-suspense-in-react-18.md">サスペンス RFC</a> を参照）。<p><a href="./react-api.html#transitions">トランジションのドキュメントはこちら</a>。</section><section class="level3"aria-labelledby="サスペンスの新機能-new-suspense-features"><h3 id="サスペンスの新機能-new-suspense-features">サスペンスの新機能 {/<em>new-suspense-features</em>/}</h3><p>サスペンスにより、コンポーネントツリーの一部がまだ表示できない場合に、ロード中という状態を宣言的に記述できるようになります：<pre class="language-js"><code class="language-js"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Suspense</span> fallback<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Spinner</span> <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">}</span><span class="token operator">></span>
  <span class="token operator">&#x3C;</span><span class="token maybe-class-name">Comments</span> <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&#x3C;</span><span class="token operator">/</span><span class="token maybe-class-name">Suspense</span><span class="token operator">></span></code></pre><p>サスペンスにより、「UI ロード中状態」というものが、React のプログラミングモデルで宣言的に記述可能な主要コンセプトに昇格します。その上により高レベルな機能を構築していけるようになります。<p>我々は数年前に機能限定版のサスペンスを導入しました。しかしサポートされているユースケースは React.lazy によるコード分割のみであり、サーバでのレンダーにおいては一切サポートされていませんでした。<p>React 18 ではサーバ側でのサスペンスのサポートを追加し、並行レンダリング機能を用いてその能力を向上させました。<p>React 18 におけるサスペンスはトランジション API と併用した場合に能力を発揮します。トランジション中でサスペンドが発生すると、React は既に見えているコンテンツがフォールバックによって隠されてしまわないようにするのです。代わりに、十分なデータがロードされるまでレンダーを遅らせて、望ましくないロード中状態が見えないようにします。<p>詳しくは、<a href="https://github.com/reactjs/rfcs/blob/main/text/0213-suspense-in-react-18.md">Suspense in React 18</a> の RFC を参照してください。</section><section class="level3"aria-labelledby="新たなクライアントおよびサーバ用のレンダー-api-new-client-and-server-rendering-apis"><h3 id="新たなクライアントおよびサーバ用のレンダー-api-new-client-and-server-rendering-apis">新たなクライアントおよびサーバ用のレンダー API {/<em>new-client-and-server-rendering-apis</em>/}</h3><p>このリリースを機に、クライアントおよびサーバ用に公開している API を再設計することにしました。これにより React 18 の新しい API にアップグレードするまでの間、React 17 の古い API を利用し続けることができるようになります。<section class="level4"aria-labelledby="react-dom-client-react-dom-client"><h4 id="react-dom-client-react-dom-client">React DOM Client {/<em>react-dom-client</em>/}</h4><p>以下の新たな API は <code>react-dom/client</code> からエクスポートされるようになっています：<ul><li><code>createRoot</code>: <code>render</code> したり <code>unmount</code> したりできる新たなルートを作成するための新メソッドです。<code>ReactDOM.render</code> の代わりに利用してください。これを使わないと React 18 の新機能は動作しません。<li><code>hydrateRoot</code>: サーバでレンダーされたアプリをハイドレーションするための新メソッドです。<code>ReactDOM.hydrate</code> の代わりに、新たな React DOM サーバ API と併せて利用してください。これを使わないと React 18 の新機能は動作しません。</ul><p><code>createRoot</code> と <code>hydrateRoot</code> のいずれも、<code>onRecoverableError</code> という新たなオプションを受け取るようになっており、レンダーあるいはハイドレーション中に起きたエラーから React が復帰した場合に通知を受けてログを残したい場合に利用できます。デフォルトでは React は <a href="https://developer.mozilla.org/en-US/docs/Web/API/reportError"><code>reportError</code></a> か、古いブラウザの場合は <code>console.error</code> を利用します。<p><a href="/reference/react-dom/client">React DOM Client のドキュメントはこちら</a>。</section><section class="level4"aria-labelledby="react-dom-server-react-dom-server"><h4 id="react-dom-server-react-dom-server">React DOM Server {/<em>react-dom-server</em>/}</h4><p>以下の新たな API は <code>react-dom/client</code> からエクスポートされるようになっており、サーバでサスペンスをストリーミングする機能を完全にサポートしています：<ul><li><code>renderToPipeableStream</code>: Node 環境でのストリーミング用。<li><code>renderToReadableStream</code>: Deno や Cloudflare Workers のようなモダンなエッジランタイム環境用。</ul><p>既存の <code>renderToString</code> メソッドは今後も動作しますが、推奨されません。<p><a href="/reference/react-dom/server">React DOM Server のドキュメントはこちら</a>。</section></section><section class="level3"aria-labelledby="strict-モードの新たな挙動-new-strict-mode-behaviors"><h3 id="strict-モードの新たな挙動-new-strict-mode-behaviors">Strict モードの新たな挙動 {/<em>new-strict-mode-behaviors</em>/}</h3><p>将来的に、React が state を保ったままで UI の一部分を追加・削除できるような機能を導入したいと考えています。例えば、ユーザがタブを切り替えて画面を離れてから戻ってきた場合に、React が以前の画面をすぐに表示できるようにしたいのです。これを可能にするため、React は同じ state を使用してツリーをアンマウント・再マウントします。<p>この機能により、React の標準状態でのパフォーマンスが向上しますが、コンポーネントは副作用が何度も登録されたり破棄されたりすることに対して耐性を持つことが必要になります。ほとんどの副作用は何の変更もなく動作しますが、一部の副作用は一度しか登録・破棄されないものと想定しています。<p>この問題に気付きやすくするために、React 18 は strict モードに新しい開発時専用のチェックを導入します。この新しいチェックは、コンポーネントが初めてマウントされるたびに、すべてのコンポーネントを自動的にアンマウント・再マウントし、かつ 2 回目のマウントで以前の state を復元します。<p>これまでは、React はコンポーネントをマウントして以下のように副作用を作成してきました：<pre class="language-text"><code class="language-text">* React がコンポーネントをマウント
  * レイアウト副作用 (layout effect) を作成
  * （通常の）副作用を作成</code></pre><p>React 18 の strict モードでは、開発時にコンポーネントがマウントされた場合、React はコンポーネントの即時アンマウント・再マウントをシミュレーションします：<pre class="language-text"><code class="language-text">* React がコンポーネントをマウント
    * レイアウト副作用を作成
    * 副作用を作成
* マウントされたコンポーネント内で副作用の破棄をシミュレート
    * レイアウト副作用を破棄
    * 副作用を破棄
* マウントされたコンポーネント内で以前の state を復元し副作用の再生成をシミュレート
    * レイアウト副作用を作成
    * 副作用の作成用コードの実行</code></pre><p><a href="/reference/react/StrictMode#fixing-bugs-found-by-re-running-effects-in-development">state 再利用可能性の保証についてのドキュメントはこちら</a>。</section><section class="level3"aria-labelledby="新たなフック-new-hooks"><h3 id="新たなフック-new-hooks">新たなフック {/<em>new-hooks</em>/}</h3><section class="level4"aria-labelledby="useid-useid"><h4 id="useid-useid">useId {/<em>useid</em>/}</h4><p><code>useId</code> はハイドレーション時の不整合を防ぎつつクライアントとサーバで一意な ID を生成するためのフックです。これは主に、一意な ID を必要とするアクセシビリティ API を組み込むようなコンポーネントライブラリで有用なものです。これにより React 17 およびそれ以前から既に存在した問題が解決されますが、React 18 では新しいストリーミング対応のサーバレンダラが HTML を順番通りに送信しなくなるため、この問題はより重要です。<a href="./hooks-reference.html#useid">こちらのドキュメントを参照</a>。<blockquote><p>補足<p><code>useId</code> は<a href="/learn/rendering-lists#where-to-get-your-key">リスト内の key</a> を作成するのに使うためのものでは<strong>ありません</strong>。key はあなたのデータから作成されるべきです。</blockquote></section><section class="level4"aria-labelledby="usetransition-usetransition"><h4 id="usetransition-usetransition">useTransition {/<em>usetransition</em>/}</h4><p><code>useTransition</code> と <code>startTransition</code> により、一部の更新は緊急性が低いということをマークできるようになります。その他の更新はデフォルトで緊急性が高いものとして扱われます。React は緊急性の高い更新（例えばテキスト入力の更新）が、緊急性の低い更新（例えば検索結果のリストのレンダー）を中断できるようになります。<a href="/reference/react/useTransition">こちらのドキュメントを参照</a>。</section><section class="level4"aria-labelledby="usedeferredvalue-usedeferredvalue"><h4 id="usedeferredvalue-usedeferredvalue">useDeferredValue {/<em>usedeferredvalue</em>/}</h4><p><code>useDeferredValue</code> により、ツリー内の緊急性の低い更新の再レンダーを遅延させることができます。デバウンス (debounce) に似ていますが、それと比べていくつかの利点があります。遅延時間が固定でないため、最初のレンダーが画面に反映された時点ですぐに遅延されていた方のレンダーを始められるのです。また遅延されたレンダーは中断可能であり、ユーザインプットをブロックしません。<a href="/reference/react/useDeferredValue">こちらのドキュメントを参照</a>。</section><section class="level4"aria-labelledby="usesyncexternalstore-usesyncexternalstore"><h4 id="usesyncexternalstore-usesyncexternalstore">useSyncExternalStore {/<em>usesyncexternalstore</em>/}</h4><p><code>useSyncExternalStore</code> は、外部ストアへの更新を強制的に同期的に行うことで、外部ストアが並行読み取りを行えるようにします。これにより外部のデータソースに購読する際に <code>useEffect</code> を使う必要性がなくなるので、React 外部の状態を扱うあらゆるライブラリにとって推奨されるものです。<a href="/reference/react/useSyncExternalStore">こちらのドキュメントを参照</a>。<blockquote><p>補足<p><code>useSyncExternalStore</code> はアプリケーションコードではなくライブラリで使用されることを意図しています。</blockquote></section><section class="level4"aria-labelledby="useinsertioneffect-useinsertioneffect"><h4 id="useinsertioneffect-useinsertioneffect">useInsertionEffect {/<em>useinsertioneffect</em>/}</h4><p><code>useInsertionEffect</code> は、CSS-in-JS ライブラリがレンダー時にスタイルを注入する際のパフォーマンス上の問題に対処できるようにするための新しいフックです。すでに CSS-in-JS ライブラリを構築しているのでなければ、これを使うことはまずないでしょう。このフックは、DOM が書き換えられた後、レイアウト副作用 (layout effect) が新しいレイアウトを読み込む前に実行されます。これにより React 17 およびそれ以前から既に存在した問題が解決されますが、React 18 では並行レンダー中にブラウザに処理が渡り、そこでレイアウトが再計算される可能性があるため、より重要です。<a href="/reference/react/useInsertionEffect">こちらのドキュメントを参照</a>。<blockquote><p>補足<p><code>useInsertionEffect</code> はアプリケーションコードではなくライブラリで使用されることを意図しています。</blockquote></section></section></section><section class="level2"aria-labelledby="アップグレード方法-how-to-upgrade"><h2 id="アップグレード方法-how-to-upgrade">アップグレード方法 {/<em>how-to-upgrade</em>/}</h2><p>ステップバイステップのガイド、および破壊的変更・注目すべき変更の全リストについては <a href="/blog/2022/03/08/react-18-upgrade-guide">React 18 アップグレードガイド</a>を参照してください。</section><section class="level2"aria-labelledby="changelog-changelog"><h2 id="changelog-changelog">Changelog {/<em>changelog</em>/}</h2><section class="level3"aria-labelledby="react-react"><h3 id="react-react">React {/<em>react</em>/}</h3><ul><li>Add <code>useTransition</code> and <code>useDeferredValue</code> to separate urgent updates from transitions. (<a href="https://github.com/facebook/react/pull/10426">#10426</a>, <a href="https://github.com/facebook/react/pull/10715">#10715</a>, <a href="https://github.com/facebook/react/pull/15593">#15593</a>, <a href="https://github.com/facebook/react/pull/15272">#15272</a>, <a href="https://github.com/facebook/react/pull/15578">#15578</a>, <a href="https://github.com/facebook/react/pull/15769">#15769</a>, <a href="https://github.com/facebook/react/pull/17058">#17058</a>, <a href="https://github.com/facebook/react/pull/18796">#18796</a>, <a href="https://github.com/facebook/react/pull/19121">#19121</a>, <a href="https://github.com/facebook/react/pull/19703">#19703</a>, <a href="https://github.com/facebook/react/pull/19719">#19719</a>, <a href="https://github.com/facebook/react/pull/19724">#19724</a>, <a href="https://github.com/facebook/react/pull/20672">#20672</a>, <a href="https://github.com/facebook/react/pull/20976">#20976</a> by <a href="https://github.com/acdlite">@acdlite</a>, <a href="https://github.com/lunaruan">@lunaruan</a>, <a href="https://github.com/rickhanlonii">@rickhanlonii</a>, and <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Add <code>useId</code> for generating unique IDs. (<a href="https://github.com/facebook/react/pull/17322">#17322</a>, <a href="https://github.com/facebook/react/pull/18576">#18576</a>, <a href="https://github.com/facebook/react/pull/22644">#22644</a>, <a href="https://github.com/facebook/react/pull/22672">#22672</a>, <a href="https://github.com/facebook/react/pull/21260">#21260</a> by <a href="https://github.com/acdlite">@acdlite</a>, <a href="https://github.com/lunaruan">@lunaruan</a>, and <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Add <code>useSyncExternalStore</code> to help external store libraries integrate with React. (<a href="https://github.com/facebook/react/pull/15022">#15022</a>, <a href="https://github.com/facebook/react/pull/18000">#18000</a>, <a href="https://github.com/facebook/react/pull/18771">#18771</a>, <a href="https://github.com/facebook/react/pull/22211">#22211</a>, <a href="https://github.com/facebook/react/pull/22292">#22292</a>, <a href="https://github.com/facebook/react/pull/22239">#22239</a>, <a href="https://github.com/facebook/react/pull/22347">#22347</a>, <a href="https://github.com/facebook/react/pull/23150">#23150</a> by <a href="https://github.com/acdlite">@acdlite</a>, <a href="https://github.com/bvaughn">@bvaughn</a>, and <a href="https://github.com/drarmstr">@drarmstr</a>)<li>Add <code>startTransition</code> as a version of <code>useTransition</code> without pending feedback. (<a href="https://github.com/facebook/react/pull/19696">#19696</a> by <a href="https://github.com/rickhanlonii">@rickhanlonii</a>)<li>Add <code>useInsertionEffect</code> for CSS-in-JS libraries. (<a href="https://github.com/facebook/react/pull/21913">#21913</a> by <a href="https://github.com/rickhanlonii">@rickhanlonii</a>)<li>Make Suspense remount layout effects when content reappears. (<a href="https://github.com/facebook/react/pull/19322">#19322</a>, <a href="https://github.com/facebook/react/pull/19374">#19374</a>, <a href="https://github.com/facebook/react/pull/19523">#19523</a>, <a href="https://github.com/facebook/react/pull/20625">#20625</a>, <a href="https://github.com/facebook/react/pull/21079">#21079</a> by <a href="https://github.com/acdlite">@acdlite</a>, <a href="https://github.com/bvaughn">@bvaughn</a>, and <a href="https://github.com/lunaruan">@lunaruan</a>)<li>Make <code>&#x3C;StrictMode></code> re-run effects to check for restorable state. (<a href="https://github.com/facebook/react/pull/19523">#19523</a> , <a href="https://github.com/facebook/react/pull/21418">#21418</a> by <a href="https://github.com/bvaughn">@bvaughn</a> and <a href="https://github.com/lunaruan">@lunaruan</a>)<li>Assume Symbols are always available. (<a href="https://github.com/facebook/react/pull/23348">#23348</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Remove <code>object-assign</code> polyfill. (<a href="https://github.com/facebook/react/pull/23351">#23351</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Remove unsupported <code>unstable_changedBits</code> API. (<a href="https://github.com/facebook/react/pull/20953">#20953</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Allow components to render undefined. (<a href="https://github.com/facebook/react/pull/21869">#21869</a> by <a href="https://github.com/rickhanlonii">@rickhanlonii</a>)<li>Flush <code>useEffect</code> resulting from discrete events like clicks synchronously. (<a href="https://github.com/facebook/react/pull/21150">#21150</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Suspense <code>fallback={undefined}</code> now behaves the same as <code>null</code> and isn't ignored. (<a href="https://github.com/facebook/react/pull/21854">#21854</a> by <a href="https://github.com/rickhanlonii">@rickhanlonii</a>)<li>Consider all <code>lazy()</code> resolving to the same component equivalent. (<a href="https://github.com/facebook/react/pull/20357">#20357</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Don't patch console during first render. (<a href="https://github.com/facebook/react/pull/22308">#22308</a> by <a href="https://github.com/lunaruan">@lunaruan</a>)<li>Improve memory usage. (<a href="https://github.com/facebook/react/pull/21039">#21039</a> by <a href="https://github.com/bgirard">@bgirard</a>)<li>Improve messages if string coercion throws (Temporal.*, Symbol, etc.) (<a href="https://github.com/facebook/react/pull/22064">#22064</a> by <a href="https://github.com/justingrant">@justingrant</a>)<li>Use <code>setImmediate</code> when available over <code>MessageChannel</code>. (<a href="https://github.com/facebook/react/pull/20834">#20834</a> by <a href="https://github.com/gaearon">@gaearon</a>)<li>Fix context failing to propagate inside suspended trees. (<a href="https://github.com/facebook/react/pull/23095">#23095</a> by <a href="https://github.com/gaearon">@gaearon</a>)<li>Fix <code>useReducer</code> observing incorrect props by removing the eager bailout mechanism. (<a href="https://github.com/facebook/react/pull/22445">#22445</a> by <a href="https://github.com/josephsavona">@josephsavona</a>)<li>Fix <code>setState</code> being ignored in Safari when appending iframes. (<a href="https://github.com/facebook/react/pull/23111">#23111</a> by <a href="https://github.com/gaearon">@gaearon</a>)<li>Fix a crash when rendering <code>ZonedDateTime</code> in the tree. (<a href="https://github.com/facebook/react/pull/20617">#20617</a> by <a href="https://github.com/dimaqq">@dimaqq</a>)<li>Fix a crash when document is set to <code>null</code> in tests. (<a href="https://github.com/facebook/react/pull/22695">#22695</a> by <a href="https://github.com/SimenB">@SimenB</a>)<li>Fix <code>onLoad</code> not triggering when concurrent features are on. (<a href="https://github.com/facebook/react/pull/23316">#23316</a> by <a href="https://github.com/gnoff">@gnoff</a>)<li>Fix a warning when a selector returns <code>NaN</code>. (<a href="https://github.com/facebook/react/pull/23333">#23333</a> by <a href="https://github.com/hachibeeDI">@hachibeeDI</a>)<li>Fix a crash when document is set to <code>null</code> in tests. (<a href="https://github.com/facebook/react/pull/22695">#22695</a> by <a href="https://github.com/SimenB">@SimenB</a>)<li>Fix the generated license header. (<a href="https://github.com/facebook/react/pull/23004">#23004</a> by <a href="https://github.com/vitaliemiron">@vitaliemiron</a>)<li>Add <code>package.json</code> as one of the entry points. (<a href="https://github.com/facebook/react/pull/22954">#22954</a> by <a href="https://github.com/Jack-Works">@Jack</a>)<li>Allow suspending outside a Suspense boundary. (<a href="https://github.com/facebook/react/pull/23267">#23267</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Log a recoverable error whenever hydration fails. (<a href="https://github.com/facebook/react/pull/23319">#23319</a> by <a href="https://github.com/acdlite">@acdlite</a>)</ul></section><section class="level3"aria-labelledby="react-dom-react-dom"><h3 id="react-dom-react-dom">React DOM {/<em>react-dom</em>/}</h3><ul><li>Add <code>createRoot</code> and <code>hydrateRoot</code>. (<a href="https://github.com/facebook/react/pull/10239">#10239</a>, <a href="https://github.com/facebook/react/pull/11225">#11225</a>, <a href="https://github.com/facebook/react/pull/12117">#12117</a>, <a href="https://github.com/facebook/react/pull/13732">#13732</a>, <a href="https://github.com/facebook/react/pull/15502">#15502</a>, <a href="https://github.com/facebook/react/pull/15532">#15532</a>, <a href="https://github.com/facebook/react/pull/17035">#17035</a>, <a href="https://github.com/facebook/react/pull/17165">#17165</a>, <a href="https://github.com/facebook/react/pull/20669">#20669</a>, <a href="https://github.com/facebook/react/pull/20748">#20748</a>, <a href="https://github.com/facebook/react/pull/20888">#20888</a>, <a href="https://github.com/facebook/react/pull/21072">#21072</a>, <a href="https://github.com/facebook/react/pull/21417">#21417</a>, <a href="https://github.com/facebook/react/pull/21652">#21652</a>, <a href="https://github.com/facebook/react/pull/21687">#21687</a>, <a href="https://github.com/facebook/react/pull/23207">#23207</a>, <a href="https://github.com/facebook/react/pull/23385">#23385</a> by <a href="https://github.com/acdlite">@acdlite</a>, <a href="https://github.com/bvaughn">@bvaughn</a>, <a href="https://github.com/gaearon">@gaearon</a>, <a href="https://github.com/lunaruan">@lunaruan</a>, <a href="https://github.com/rickhanlonii">@rickhanlonii</a>, <a href="https://github.com/trueadm">@trueadm</a>, and <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Add selective hydration. (<a href="https://github.com/facebook/react/pull/14717">#14717</a>, <a href="https://github.com/facebook/react/pull/14884">#14884</a>, <a href="https://github.com/facebook/react/pull/16725">#16725</a>, <a href="https://github.com/facebook/react/pull/16880">#16880</a>, <a href="https://github.com/facebook/react/pull/17004">#17004</a>, <a href="https://github.com/facebook/react/pull/22416">#22416</a>, <a href="https://github.com/facebook/react/pull/22629">#22629</a>, <a href="https://github.com/facebook/react/pull/22448">#22448</a>, <a href="https://github.com/facebook/react/pull/22856">#22856</a>, <a href="https://github.com/facebook/react/pull/23176">#23176</a> by <a href="https://github.com/acdlite">@acdlite</a>, <a href="https://github.com/gaearon">@gaearon</a>, <a href="https://github.com/salazarm">@salazarm</a>, and <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Add <code>aria-description</code> to the list of known ARIA attributes. (<a href="https://github.com/facebook/react/pull/22142">#22142</a> by <a href="https://github.com/mahyareb">@mahyareb</a>)<li>Add <code>onResize</code> event to video elements. (<a href="https://github.com/facebook/react/pull/21973">#21973</a> by <a href="https://github.com/rileyjshaw">@rileyjshaw</a>)<li>Add <code>imageSizes</code> and <code>imageSrcSet</code> to known props. (<a href="https://github.com/facebook/react/pull/22550">#22550</a> by <a href="https://github.com/eps1lon">@eps1lon</a>)<li>Allow non-string <code>&#x3C;option></code> children if <code>value</code> is provided. (<a href="https://github.com/facebook/react/pull/21431">#21431</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Fix <code>aspectRatio</code> style not being applied. (<a href="https://github.com/facebook/react/pull/21100">#21100</a> by <a href="https://github.com/gaearon">@gaearon</a>)<li>Warn if <code>renderSubtreeIntoContainer</code> is called. (<a href="https://github.com/facebook/react/pull/23355">#23355</a> by <a href="https://github.com/acdlite">@acdlite</a>)</ul></section><section class="level3"aria-labelledby="react-dom-server-react-dom-server-1"><h3 id="react-dom-server-react-dom-server-1">React DOM Server {/<em>react-dom-server-1</em>/}</h3><ul><li>Add the new streaming renderer. (<a href="https://github.com/facebook/react/pull/14144">#14144</a>, <a href="https://github.com/facebook/react/pull/20970">#20970</a>, <a href="https://github.com/facebook/react/pull/21056">#21056</a>, <a href="https://github.com/facebook/react/pull/21255">#21255</a>, <a href="https://github.com/facebook/react/pull/21200">#21200</a>, <a href="https://github.com/facebook/react/pull/21257">#21257</a>, <a href="https://github.com/facebook/react/pull/21276">#21276</a>, <a href="https://github.com/facebook/react/pull/22443">#22443</a>, <a href="https://github.com/facebook/react/pull/22450">#22450</a>, <a href="https://github.com/facebook/react/pull/23247">#23247</a>, <a href="https://github.com/facebook/react/pull/24025">#24025</a>, <a href="https://github.com/facebook/react/pull/24030">#24030</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Fix context providers in SSR when handling multiple requests. (<a href="https://github.com/facebook/react/pull/23171">#23171</a> by <a href="https://github.com/frandiox">@frandiox</a>)<li>Revert to client render on text mismatch. (<a href="https://github.com/facebook/react/pull/23354">#23354</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Deprecate <code>renderToNodeStream</code>. (<a href="https://github.com/facebook/react/pull/23359">#23359</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)<li>Fix a spurious error log in the new server renderer. (<a href="https://github.com/facebook/react/pull/24043">#24043</a> by <a href="https://github.com/eps1lon">@eps1lon</a>)<li>Fix a bug in the new server renderer. (<a href="https://github.com/facebook/react/pull/22617">#22617</a> by <a href="https://github.com/shuding">@shuding</a>)<li>Ignore function and symbol values inside custom elements on the server. (<a href="https://github.com/facebook/react/pull/21157">#21157</a> by <a href="https://github.com/sebmarkbage">@sebmarkbage</a>)</ul></section><section class="level3"aria-labelledby="react-dom-test-utils-react-dom-test-utils"><h3 id="react-dom-test-utils-react-dom-test-utils">React DOM Test Utils {/<em>react-dom-test-utils</em>/}</h3><ul><li>Throw when <code>act</code> is used in production. (<a href="https://github.com/facebook/react/pull/21686">#21686</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Support disabling spurious act warnings with <code>global.IS_REACT_ACT_ENVIRONMENT</code>. (<a href="https://github.com/facebook/react/pull/22561">#22561</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Expand act warning to cover all APIs that might schedule React work. (<a href="https://github.com/facebook/react/pull/22607">#22607</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Make <code>act</code> batch updates. (<a href="https://github.com/facebook/react/pull/21797">#21797</a> by <a href="https://github.com/acdlite">@acdlite</a>)<li>Remove warning for dangling passive effects. (<a href="https://github.com/facebook/react/pull/22609">#22609</a> by <a href="https://github.com/acdlite">@acdlite</a>)</ul></section><section class="level3"aria-labelledby="react-refresh-react-refresh"><h3 id="react-refresh-react-refresh">React Refresh {/<em>react-refresh</em>/}</h3><ul><li>Track late-mounted roots in Fast Refresh. (<a href="https://github.com/facebook/react/pull/22740">#22740</a> by <a href="https://github.com/anc95">@anc95</a>)<li>Add <code>exports</code> field to <code>package.json</code>. (<a href="https://github.com/facebook/react/pull/23087">#23087</a> by <a href="https://github.com/otakustay">@otakustay</a>)</ul></section><section class="level3"aria-labelledby="server-components-experimental-server-components-experimental"><h3 id="server-components-experimental-server-components-experimental">Server Components (Experimental) {/<em>server-components-experimental</em>/}</h3><ul><li>Add Server Context support. (<a href="https://github.com/facebook/react/pull/23244">#23244</a> by <a href="https://github.com/salazarm">@salazarm</a>)<li>Add <code>lazy</code> support. (<a href="https://github.com/facebook/react/pull/24068">#24068</a> by <a href="https://github.com/gnoff">@gnoff</a>)<li>Update webpack plugin for webpack 5 (<a href="https://github.com/facebook/react/pull/22739">#22739</a> by <a href="https://github.com/michenly">@michenly</a>)<li>Fix a mistake in the Node loader. (<a href="https://github.com/facebook/react/pull/22537">#22537</a> by <a href="https://github.com/btea">@btea</a>)<li>Use <code>globalThis</code> instead of <code>window</code> for edge environments. (<a href="https://github.com/facebook/react/pull/22777">#22777</a> by <a href="https://github.com/huozhi">@huozhi</a>) <span style="float:footnote"><a href="../../../../index.html#toc">Go to TOC</a></span></ul></section></section></section>