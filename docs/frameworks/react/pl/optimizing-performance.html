<!doctypehtml><html lang="pl"><meta charset="utf-8"><title>Optymalizacja wydajności</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css"><section id="optymalizacja-wydajności"class="level1"><h1>Optymalizacja wydajności</h1><p>React używa "pod maską" kilku sprytnych sztuczek, dzięki którym może zminimalizować liczbę kosztownych operacji na modelu DOM potrzebnych do zaktualizowania interfejsu. W wielu aplikacjach użycie Reacta powinno zapewnić satysfakcjonującą szybkość interfejsu bez stosowania wielu skomplikowanych optymalizacji wydajnościowych. Mimo wszystko, jeśli okaże się inaczej, istnieje kilka sposobów na przyspieszenie twojej aplikacji reactowej.<section id="use-the-production-build"class="level2"><h2>Użyj kodu produkcyjnego</h2><p>Jeśli testujesz wydajność swojej aplikacji lub odczuwasz problemy z jej wydajnością, upewnij się, że używasz zminifikowanego kodu produkcyjnego (ang. <em>production build</em>).<p>Domyślnie React dorzuca do kodu wiele ostrzeżeń, które przydają się podczas pisania aplikacji. Niestety z ich powodu React jest cięższy i wolniejszy, dlatego zaleca się wrzucać na produkcję tylko wygenerowany kod produkcyjny.<p>Jeśli masz wątpliwości co do tego, czy twój proces budowania aplikacji jest ustawiony poprawnie, sprawdź to instalując <a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi">React Developer Tools dla Chrome'a</a>. Jeśli po instalacji odwiedzisz stronę korzystającą z kodu produkcyjnego, ikona wtyczki będzie miała ciemne tło:</p><img src="./docs/devtools-prod.png"style="max-width:100%"alt="React DevTools na stronie korzystającej z produkcyjnej wersji Reacta"><p>Jeśli jednak strona będzie korzystać z trybu deweloperskiego, ikona będzie czerwona:</p><img src="./docs/devtools-dev.png"style="max-width:100%"alt="React DevTools na stronie korzystajhącej z deweloperskiej wersji Reacta"><p>Co do zasady, trybu deweloperskiego powinno używać się podczas tworzenia aplikacji, a kod produkcyjny wrzucać tam, gdzie będą z niego korzystać docelowi użytkownicy.<p>Poniżej znajdziesz więcej instrukcji dotyczących budowania aplikacji produkcyjnej.<section id="create-react-app"class="level3"><h3>Create React App</h3><p>Jeśli twój projekt powstał przy pomocy <a href="https://github.com/facebookincubator/create-react-app">Create React App</a>, uruchom polecenie:<pre class="language-text"><code class="language-text">npm run build</code></pre><p>Stworzy ono kod produkcyjny twojej aplikacji i umieści go w folderze <code>build/</code>.<p>Pamiętaj, aby używać powyższej komendy tylko przed wrzuceniem kodu na produkcję. Do normalnej pracy nad aplikacją uruchamiaj <code>npm start</code>.</section><section id="single-file-builds"class="level3"><h3>Jednoplikowe zbudowane paczki</h3><p>React oraz React DOM są dostępne jako pojedyncze pliki, wprost gotowe do użycia na produkcji:<pre class="language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react@18/umd/react.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://unpkg.com/react-dom@18/umd/react-dom.production.min.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&#x3C;/</span>script</span><span class="token punctuation">></span></span></code></pre><p>Pamiętaj, że tylko pliki o nazwie kończącej się na <code>.production.min.js</code> są przystosowane do działania na produkcji.</section><section id="brunch"class="level3"><h3>Brunch</h3><p>Aby uzyskać najwydajniejszy build produkcyjny przy użyciu narzędzia Brunch, zainstaluj do niego wtyczkę <a href="https://github.com/brunch/terser-brunch"><code>terser-brunch</code></a>:<pre class="language-text"><code class="language-text"># Jeśli używasz npma
npm install --save-dev terser-brunch

# Jeśli używasz Yarna
yarn add --dev terser-brunch</code></pre><p>Następnie stwórz kod produkcyjny dodając flagę <code>-p</code> do komendy <code>build</code>:<pre class="language-text"><code class="language-text">brunch build -p</code></pre><p>Pamiętaj, że uruchamianie powyższej komendy jest koniecznie tylko wtedy, gdy chcesz stworzyć kod produkcyjny. Do codziennej pracy nie korzystaj z flagi <code>-p</code> ani nie używaj tej wtyczki, ponieważ spowoduje to ukrycie przydatnych ostrzeżeń reactowych oraz spowolni sam proces budowania aplikacji.</section><section id="browserify"class="level3"><h3>Browserify</h3><p>Aby uzyskać najwydajniejszy build produkcyjny przy użyciu narzędzia Browserify, zainstaluj kilka wtyczek:<pre class="language-text"><code class="language-text"># Jeśli używasz npma
npm install --save-dev envify terser uglifyify 

# Jeśli używasz Yarna
yarn add --dev envify terser uglifyify </code></pre><p>Aby stworzyć kod produkcyjny, dodaj poniższe transformacje <strong>(kolejność ma znaczenie)</strong>:<ul><li>Transformacja <a href="https://github.com/hughsk/envify"><code>envify</code></a> ustawia poprawne środowisko dla procesu budowania. Użyj jej globalnie (<code>-g</code>).<li>Transformacja <a href="https://github.com/hughsk/uglifyify"><code>uglifyify</code></a> usuwa importy deweloperskie. Również i jej użyj globalnie (<code>-g</code>).<li>Na koniec powstały kod jest przepuszczany przez <a href="https://github.com/terser-js/terser"><code>terser</code></a>, który dekoruje (ang. <em>mangle</em>) kod (<a href="https://github.com/hughsk/uglifyify#motivationusage">przeczytaj dlaczego</a>).</ul><p>Na przykład:<pre class="language-text"><code class="language-text">browserify ./index.js \
  -g [ envify --NODE_ENV production ] \
  -g uglifyify \
  | terser --compress --mangle > ./bundle.js</code></pre><p>Pamiętaj, że uruchamianie powyższej komendy jest koniecznie tylko wtedy, gdy chcesz stworzyć kod produkcyjny. Do codziennej pracy nie korzystaj z tych wtyczek, ponieważ spowoduje to ukrycie przydatnych ostrzeżeń reactowych oraz spowolni sam proces budowania aplikacji.</section><section id="rollup"class="level3"><h3>Rollup</h3><p>Aby uzyskać najwydajniejszy build produkcyjny przy użyciu narzędzia Rollup, zainstaluj kilka wtyczek:<pre class="language-bash"><code class="language-bash"><span class="token comment"># Jeśli używasz npma</span>
<span class="token function">npm</span> <span class="token function">install</span> --save-dev rollup-plugin-commonjs rollup-plugin-replace rollup-plugin-terser

<span class="token comment"># Jeśli używasz Yarna</span>
<span class="token function">yarn</span> <span class="token function">add</span> --dev rollup-plugin-commonjs rollup-plugin-replace rollup-plugin-terser</code></pre><p>Aby stworzyć kod produkcyjny, dodaj poniższe wtyczki <strong>(kolejność ma znaczenie)</strong>:<ul><li>Wtyczka <a href="https://github.com/rollup/rollup-plugin-replace"><code>replace</code></a> ustawia poprawne środowisko dla procesu budowania.<li>Wtyczka <a href="https://github.com/rollup/rollup-plugin-commonjs"><code>commonjs</code></a> dodaje do Rollupa wsparcie dla CommonJS.<li>Wtyczka <a href="https://github.com/TrySound/rollup-plugin-terser"><code>terser</code></a> kompresuje i dekoruje (ang. <em>mangle</em>) kod wynikowy.</ul><pre class="language-js"><code class="language-js"><span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token comment">// ...</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup-plugin-replace'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token string-property property">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup-plugin-commonjs'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rollup-plugin-terser'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">]</span></code></pre><p>Kompletny przykład konfiguracji możesz <a href="https://gist.github.com/Rich-Harris/cb14f4bc0670c47d00d191565be36bf0">zobaczyć w tym giście</a>.<p>Pamiętaj, że uruchamianie powyższej komendy jest koniecznie tylko wtedy, gdy chcesz stworzyć kod produkcyjny. Do codziennej pracy nie korzystaj z wtyczki <code>terser</code> ani z <code>replace</code> z ustawioną wartością na <code>'production'</code>, ponieważ spowoduje to ukrycie przydatnych ostrzeżeń reactowych oraz spowolni sam proces budowania aplikacji.</section><section id="webpack"class="level3"><h3>webpack</h3><blockquote><p><strong>Uwaga:</strong><p>Jeśli korzystasz z Create React App, przeczytaj <a href="#create-react-app">tę instrukcję</a>.<br>Poniższa sekcja dotyczy sytuacji, w której webpack jest konfigurowany bezpośrednio.</blockquote><p>Webpack w wersji 4+ minifikuje kod domyślnie w trybie produkcyjnym.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">TerserPlugin</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">/* dodatkowe opcje */</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Więcej na ten temat możesz przeczytać w <a href="https://webpack.js.org/guides/production/">dokumentacji webpacka</a>.<p>Pamiętaj, że uruchamianie powyższej komendy jest koniecznie tylko wtedy, gdy chcesz stworzyć kod produkcyjny. Do codziennej pracy nie korzystaj z wtyczki <code>TerserPlugin</code>, ponieważ spowoduje to ukrycie przydatnych ostrzeżeń reactowych oraz spowolni sam proces budowania aplikacji.</section></section><section id="profiling-components-with-the-devtools-profiler"class="level2"><h2>Profilowanie komponentów za pomocą Profilera z React DevTools</h2><p><code>react-dom</code> 16.5+ oraz <code>react-native</code> 0.57+ zapewniają zwiększone możliwości profilowania w trybie deweloperskim w połączeniu z Profilerem wtyczki React DevTools. Ogólne informacje na temat Profilera można znaleźć w poście <a href="/blog/2018/09/10/introducing-the-react-profiler.html">"Introducing the React Profiler"</a> (pol. "Wprowadzenie do React Profilera"). Filmik opowiadający o profilerze jest także <a href="https://www.youtube.com/watch?v=nySib7ipZdk">dostępny na YouTube</a>.<p>Jeśli jeszcze nie masz zainstalowanej wtyczki React DevTools, możesz znaleźć ją tutaj:<ul><li><a href="https://chrome.google.com/webstore/detail/react-developer-tools/fmkadmapgofadopljbjfkapdkoienihi?hl=pl">Wtyczka do Chrome'a</a><li><a href="https://addons.mozilla.org/en-GB/firefox/addon/react-devtools/">Wtyczka do Firefoksa</a><li><a href="https://www.npmjs.com/package/react-devtools">Niezależna paczka Node'owa</a></ul><blockquote><p>Uwaga<p>Profiler do kodu produkcyjnego jest również dostępny w paczce <code>react-dom</code> pod ścieżką <code>react-dom/profiling</code>. Więcej informacji na temat jego użycia znajdziesz na <a href="https://fb.me/react-profiling">fb.me/react-profiling</a></blockquote><blockquote><p>Uwaga<p>Przed wersją 17 Reakta używaliśmy standardowego <a href="https://developer.mozilla.org/en-US/docs/Web/API/User_Timing_API">User Timing API (pol. <em>API do pomiarów czasowych</em>)</a> w celu profilowania komponentów za pomocą zakładki "Performance" (pol. <em>Wydajność</em>) w Chromie. Szczegółowy poradnik dotyczący tego tematu znajdziesz w <a href="https://calibreapp.com/blog/react-performance-profiling-optimization">tym artykule autorstwa Bena Schwarza</a>.</blockquote></section><section id="virtualize-long-lists"class="level2"><h2>Wirtualizacja długich list</h2><p>Jeśli twoja aplikacja renderuje długie listy z danymi (setki lub tysiące wierszy), zalecamy użycie techniki zwanej "okienkowaniem" (ang. <em>windowing</em>). Technika ta renderuje w danym momencie jedynie niewielką część wszystkich wierszy, co może znacząco wpłynąć na zredukowanie czasu ponownego renderowania komponentów oraz zmniejszenie liczby tworzonych węzłów DOM.<p><a href="https://react-window.now.sh/">react-window</a> oraz <a href="https://bvaughn.github.io/react-virtualized/">react-virtualized</a> to popularne biblioteki "okienkujące". Dostarczają kilka generycznych komponentów służących do wyświetlania list, siatek i tabel. Jeśli potrzebujesz czegoś bardziej szytego na miarę do swojej aplikacji, możesz napisać własny komponent okienkujący, jak <a href="https://medium.com/@paularmstrong/twitter-lite-and-high-performance-react-progressive-web-apps-at-scale-d28a00e780a3">zrobił to Twitter</a>.</section><section id="avoid-reconciliation"class="level2"><h2>Unikaj rekoncyliacji</h2><p>React buduje i zarządza wewnętrzną reprezentacją renderowanego UI. Zawiera ona elementy reactowe zwracane przez komponenty aplikacji. Dzięki niej React może unikać niepotrzebnych operacji, jak np. tworzenia węzłów DOM i modyfikowania istniejących. Tego typu operacje są wolniejsze niż analogiczne operacje na obiektach javascriptowych. Czasem do tej reprezentacji odnosimy się jako "wirtualny DOM" (ang. <em>virtual DOM</em>), lecz podobna występuje w React Native.<p>Kiedy zmieniają się właściwości lub stan komponentu, React decyduje, czy należy zaktualizować DOM, poprzez porównanie poprzednio zwróconego elementu z tym zwróconym po zmianie. Jeśli nie są takie same, następuje aktualizacja modelu DOM.<p>Nawet pomimo tego, że React aktualizuje jedynie zmodyfikowane węzły DOM, ponowne wyrenderowanie zajmuje trochę czasu. W wielu przypadkach nie jest to problemem, jednak czasami spowolnienie jest widoczne gołym okiem. Można temu zaradzić nadpisując metodę cyklu życia komponentu o nazwie <code>shouldComponentUpdate</code>, która wywoływana jest tuż przed rozpoczęciem ponownego renderowania. Domyślna implementacja tej metody zwraca zawsze <code>true</code>, wymuszając na Reakcie każdorazowe ponowne renderowanie:<pre class="language-javascript"><code class="language-javascript"><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Jeśli wiesz, że w niektórych przypadkach twój komponent nie musi być aktualizowany, możesz nadpisać <code>shouldComponentUpdate</code> w taki sposób, aby zwracało <code>false</code>. Dzięki temu React pominie cały proces renderowania, wraz z wywołaniem metody <code>render()</code>, na tym komponencie i na wszystkich jego potomkach.<p>W większości przypadków, zamiast pisania własnej implementacji metody <code>shouldComponentUpdate()</code>, wystarczy odziedziczyć po klasie <a href="./react-api.html#reactpurecomponent"><code>React.PureComponent</code></a>. Daje to ten sam efekt, co zaimplementowanie metody <code>shouldComponentUpdate()</code> w taki sposób, aby wykonywała płytkie porównanie (ang. <em>shallow comparison</em>) na aktualnym oraz poprzednim zestawie właściwości i stanu.</section><section id="shouldcomponentupdate-in-action"class="level2"><h2>shouldComponentUpdate w akcji</h2><p>Załóżmy, że mamy takie poddrzewo komponentów. Dla każdego z nich <code>SCU</code> oznacza wartość zwróconą przez metodę <code>shouldComponentUpdate</code>, a <code>vDOMEq</code> określa, czy wyrenderowane elementy były takie same. Natomiast kolor kółka określa, czy dany komponent musiał zostać sprawdzony przez mechanizm rekoncyliacji, czy nie.<figure><img src="./docs/should-component-update.png"style="max-width:100%"></figure><p>Ponieważ <code>shouldComponentUpdate</code> zwróciło <code>false</code> dla poddrzewa w węźle C2, React nie musiał renderować C2, a co za tym idzie, nie musiał nawet wywoływać metody <code>shouldComponentUpdate</code> na C4 i C5.<p>Dla C1 i C3 <code>shouldComponentUpdate</code> zwróciło <code>true</code>, więc React musiał zejść głębiej do liści drzewa i je sprawdzić. Metoda <code>shouldComponentUpdate</code> komponentu C6 zwróciła <code>true</code>, a ponieważ wyrenderowane elementy różniły się od siebie, React musiał zaktualizować DOM.<p>Ostatnim interesującym przypadkiem jest C8. React musiał wyrenderować ten komponent, ale wyrenderowany element był taki sam jak poprzednio, w związku z czym nie trzeba było aktualizować modelu DOM.<p>Zwróć uwagę, że React musiał nanieść poprawki w modelu DOM tylko dla C6, co było nieuniknione. W przypadku C8 nastąpiło wczesne przerwanie, ponieważ wyrenderowane elementy były takie same, natomiast w poddrzewie C2 oraz węźle C7 React nie musiał nawet niczego porównywać, gdyż <code>shouldComponentUpdate</code> zwróciło <code>false</code>, przez co <code>render</code> nie zostało wywołane w ogóle.</section><section id="examples"class="level2"><h2>Przykłady</h2><p>Jeśli twój komponent zmienia się tylko przy zmianie wartości <code>props.color</code> lub <code>state.count</code>, możesz je sprawdzić wewnątrz metody <code>shouldComponentUpdate</code>:<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">CounterButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">color</span> <span class="token operator">!==</span> nextProps<span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">!==</span> nextState<span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>button
        color<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token literal-property property">Licznik</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>W powyższym kodzie <code>shouldComponentUpdate</code> sprawdza jedynie, czy zmieniły się wartości <code>props.color</code> lub <code>state.count</code>. Jeśli nie, wówczas nie ma potrzeby renderować komponentu ponownie. Gdyby komponent nieco się rozrósł, można by zastosować "płytkie porównanie" (ang. <em>shallow comparison</em>) wszystkich pól z <code>props</code> i <code>state</code>, aby stwierdzić, czy należy komponent wyrenderować ponownie. Ten wzorzec jest na tyle popularny, że wyposażyliśmy Reacta w klasę pomocniczą, która to robi. Wystarczy, że twój komponent będzie dziedziczył po klasie <code>React.PureComponent</code>, a płytkie porównanie nastąpi automatycznie. Poniższy kod pokazuje prostszy sposób na uzyskanie tego samego efektu:<pre class="language-js"><code class="language-js"><span class="token keyword">class</span> <span class="token class-name">CounterButton</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>button
        color<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">color</span><span class="token punctuation">}</span>
        onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">count</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">></span>
        <span class="token literal-property property">Licznik</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">count</span><span class="token punctuation">}</span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>button<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>W wielu przypadkach, zamiast pisać własną implementację metody <code>shouldComponentUpdate</code>, możesz z powodzeniem skorzystać z klasy <code>React.PureComponent</code>. Pamiętaj jednak, że wykonuje ona płytkie porównanie, więc na nic się zda, kiedy właściwości lub stan są modyfikowane w sposób, którego ono nie wykrywa.<p>Problem może pojawić się przy bardziej złożonych strukturach danych. Na przykład, załóżmy, że mamy komponent <code>ListOfWords</code>, który wypisuje słowa po przecinku, oraz nadrzędny komponent <code>WordAdder</code>, który pozwala kliknąć na guzik i dodać tym samym nowe słowo do listy. Poniższy kod <em>nie</em> zadziała poprawnie:<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ListOfWords</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>PureComponent</span> <span class="token punctuation">{</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">&#x3C;</span>div<span class="token operator">></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">props</span><span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">WordAdder</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">words</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'marklar'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">handleClick</span><span class="token punctuation">.</span><span class="token method function property-access">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Ten fragment jest źle napisany i zawiera błąd</span>
    <span class="token keyword">const</span> words <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">;</span>
    words<span class="token punctuation">.</span><span class="token method function property-access">push</span><span class="token punctuation">(</span><span class="token string">'marklar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token literal-property property">words</span><span class="token operator">:</span> words<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&#x3C;</span>div<span class="token operator">></span>
        <span class="token operator">&#x3C;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">handleClick</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token maybe-class-name">ListOfWords</span> words<span class="token operator">=</span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&#x3C;</span><span class="token operator">/</span>div<span class="token operator">></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Problem polega na tym, że <code>PureComponent</code> używa prostego porównania starej i nowej wartości <code>this.props.words</code>. Jako że ten kod mutuje tablicę <code>words</code> wewnątrz metody <code>handleClick</code>, stara i nowa wartość dla <code>this.props.words</code> będą identyczne, nawet pomimo faktu, iż słowa w tablicy uległy zmianie. Na skutek tego <code>ListOfWords</code> nie zostanie zaktualizowany, pomimo że zmieniła się lista słów, które należy wyrenderować.</section><section id="the-power-of-not-mutating-data"class="level2"><h2>Potęga niemutowania danych</h2><p>Najprostszym sposobem na uniknięcie tego problemu jest uniknięcie mutowania wartości, których używasz jako właściwości lub stan. Na przykład, powyższą metodę <code>handleClick</code> można napisać z użyciem <code>concat</code>:<pre class="language-javascript"><code class="language-javascript"><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">words</span><span class="token operator">:</span> state<span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">.</span><span class="token method function property-access">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'marklar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Standard ES6 dostarcza między innymi <a href="https://developer.mozilla.org/pl/docs/Web/JavaScript/Referencje/Operatory/Sk%C5%82adnia_rozwini%C4%99cia">operator rozwinięcia (ang. <em>spread operator</em>)</a> dla tablic, który może uprościć ten zapis. Jeśli korzystasz z Create React App, składnia ta jest dostępna domyślnie.<pre class="language-js"><code class="language-js"><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">words</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>state<span class="token punctuation">.</span><span class="token property-access">words</span><span class="token punctuation">,</span> <span class="token string">'marklar'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>W podobny sposób możesz zmienić kod, który mutuje obiekty, tak, aby uniknąć mutacji. Na przykład, załóżmy, że mamy obiekt o nazwie <code>colormap</code> i chcemy napisać funkcję, która zmienia wartość <code>colormap.right</code> na <code>'blue'</code>. Możemy napisać:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  colormap<span class="token punctuation">.</span><span class="token property-access">right</span> <span class="token operator">=</span> <span class="token string">'blue'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Aby uniknąć mutowania oryginalnego obiektu, możemy użyć metody <a href="https://developer.mozilla.org/pl/docs/Web/JavaScript/Referencje/Obiekty/Object/assign">Object.assign</a>:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> colormap<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>updateColorMap</code> zwraca teraz nowy obiekt, zamiast mutować stary. Metoda <code>Object.assign</code> jest dostępna w standardzie ES6 i wymaga polyfilla.<p><a href="https://developer.mozilla.org/pl/docs/Web/JavaScript/Referencje/Operatory/Sk%C5%82adnia_rozwini%C4%99cia">Składnia rozwinięcia obiektu</a> sprawia, że aktualizowanie obiektów bez ich mutowania jest łatwiejsze:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span><span class="token spread operator">...</span>colormap<span class="token punctuation">,</span> <span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Ta funkcjonalność została dodana do JavaScriptu w ES2018.<p>Jeśli korzystasz z Create React App, zarówno <code>Object.assign</code>, jak i składnia rozwinięcia obiektu są dostępne domyślnie.<p>Jeśli działasz na głęboko zagnieżdżonych obiektach, aktualizowanie ich w niemutowalny sposób może okazać się karkołomne. Z pomocą przychodzą <a href="https://github.com/mweststrate/immer">Immer</a> oraz <a href="https://github.com/kolodny/immutability-helper">immutability-helper</a>. Biblioteki te pozwalają pisać czytelny kod bez utraty korzyści płynących z niemutowalności (ang. <em>immutability</em>). <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>