<!doctype html><html lang="en"><meta charset="utf-8"><title>Environment API</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="environment-api"><h1 id="environment-api">Environment API</h1>warning Experimental Initial work for this API was introduced in Vite 5.1 with the name "Vite Runtime API". This guide describes a revised API, renamed to Environment API. This API will be released in Vite 6 as experimental. You can already test it in the latest `vite@6.0.0-beta.x` version.<p>Resources:<ul><li><a href="https://github.com/vitejs/vite/discussions/16358">Feedback discussion</a> where we are gathering feedback about the new APIs.<li><a href="https://github.com/vitejs/vite/pull/16471">Environment API PR</a> where the new API were implemented and reviewed.</ul><p>Please share with us your feedback as you test the proposal.<section class="level2"aria-labelledby="formalizing-environments"><h2 id="formalizing-environments">Formalizing Environments</h2><p>Vite 6 formalizes the concept of Environments. Until Vite 5, there were two implicit Environments (<code>client</code> and <code>ssr</code>). The new Environment API allows users to create as many environments as needed to map the way their apps work in production. This new capabilities required a big internal refactoring, but a big effort has been placed on backward compatibility. The initial goal of Vite 6 is to move the ecosystem to the new major as smoothly as possible, delaying the adoption of these new experimental APIs until enough users have migrated and frameworks and plugin authors have validated the new design.</section><section class="level2"aria-labelledby="closing-the-gap-between-build-and-dev"><h2 id="closing-the-gap-between-build-and-dev">Closing the gap between build and dev</h2><p>For a simple SPA, there is a single environment. The app will run in the user browser. During dev, except for Vite's requiring a modern browser, the environment matches closely the production runtime. In Vite 6, it would still be possible to use Vite without users knowing about environments. The usual vite config works for the default client environment in this case.<p>In a typical server side rendered Vite app, there are two environments. The client environment is running the app in the browser, and the node environment runs the server that performs SSR. When running Vite in dev mode, the server code is executed in the same Node process as the Vite dev server giving a close approximation of the production environment. But an app can run servers in other JS runtimes, like <a href="https://github.com/cloudflare/workerd">Cloudflare's workerd</a>. And it is also common for modern apps to have more than two environments (for example, an app could be running by a browser, a node server, and an edge server). Vite 5 didn't allow for these cases to be properly represented.<p>Vite 6 allows users to configure their app during build and dev to map all of its environments. During dev, a single Vite dev server can now be used to run code in multiple different environments concurrently. The app source code is still transformed by Vite dev server. On top of the shared HTTP server, middlewares, resolved config, and plugins pipeline, the Vite server now has a set of independent dev environments. Each of them is configured to match the production environment as closely as possible, and is connected to a dev runtime where the code is executed (for workerd, the server code can now run in miniflare locally). In the client, the browser imports and executes the code. In other environments, a module runner fetches and evaluates the transformed code.<figure><img src="../images/vite-environments.svg"alt="Vite Environments"><figcaption aria-hidden="true">Vite Environments</figcaption></figure></section><section class="level2"aria-labelledby="environment-configuration"><h2 id="environment-configuration">Environment Configuration</h2><p>Environments are explicitly configured with the <code>environments</code> config option.<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">environments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">conditions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// configure the Client environment</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">ssr</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">dev</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">optimizeDeps</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// configure the SSR environment</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rsc</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">noExternal</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// configure a custom environment</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><p>All environment configs extend from user's root config, allowing users add defaults for all environments at the root level. This is quite useful for the common use case of configuring a Vite client only app, that can be done without going through <code>environments.client</code>.<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">conditions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// configure a default for all environments</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><p>The <code>EnvironmentOptions</code> interface exposes all the per-environment options. There are <code>SharedEnvironmentOptions</code> that apply to both <code>build</code> and <code>dev</code>, like <code>resolve</code>. And there are <code>DevEnvironmentOptions</code> and <code>BuildEnvironmentOptions</code> for dev and build specific options (like <code>dev.optimizeDeps</code> or <code>build.outDir</code>).<pre class="language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">EnvironmentOptions</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">SharedEnvironmentOptions</span></span> <span class="token punctuation">{</span>
  dev<span class="token operator">:</span> <span class="token maybe-class-name">DevOptions</span>
  build<span class="token operator">:</span> <span class="token maybe-class-name">BuildOptions</span>
<span class="token punctuation">}</span></code></pre><p>As we explained, Environment specific options defined at the root level of user config are used for the default client environment (the <code>UserConfig</code> interface extends from the <code>EnvironmentOptions</code> interface). And environments can be configured explicitly using the <code>environments</code> record. The <code>client</code> and <code>ssr</code> environments are always present during dev, even if an empty object is set to <code>environments</code>. This allows backward compatibility with <code>server.ssrLoadModule(url)</code> and <code>server.moduleGraph</code>. During build, the <code>client</code> environment is always present, and the <code>ssr</code> environment is only present if it is explicitly configured (using <code>environments.ssr</code> or for backward compatibility <code>build.ssr</code>).<pre class="language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">UserConfig</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">EnvironmentOptions</span></span> <span class="token punctuation">{</span>
  environments<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token maybe-class-name">EnvironmentOptions</span><span class="token operator">></span>
  <span class="token comment">// other options</span>
<span class="token punctuation">}</span></code></pre>info<p>The <code>ssr</code> top level property has many options in common with <code>EnvironmentOptions</code>. This option was created for the same use case as <code>environments</code> but only allowed configuration of a small number of options. We're going to deprecate it in favour of a unified way to define environment configuration.</section><section class="level2"aria-labelledby="custom-environment-instances"><h2 id="custom-environment-instances">Custom environment instances</h2><p>Low level configuration APIs are available so runtime providers can provide environments for their runtimes.<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createCustomEnvironment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite-environment-provider'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">environments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">build</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">outDir</span><span class="token operator">:</span> <span class="token string">'/dist/client'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token literal-property property">ssr</span><span class="token operator">:</span> <span class="token function">createCustomEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">build</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">outDir</span><span class="token operator">:</span> <span class="token string">'/dist/ssr'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="backward-compatibility"><h2 id="backward-compatibility">Backward Compatibility</h2><p>The current Vite server API are not yet deprecated and are backward compatible with Vite 5. The new Environment API is experimental.<p>The <code>server.moduleGraph</code> returns a mixed view of the client and ssr module graphs. Backward compatible mixed module nodes will be returned from all its methods. The same scheme is used for the module nodes passed to <code>handleHotUpdate</code>.<p>We don't recommend switching to Environment API yet. We are aiming for a good portion of the user base to adopt Vite 6 before so plugins don't need to maintain two versions. Checkout the future breaking changes section for information on future deprecations and upgrade path:<ul><li><a href="/changes/this-environment-in-hooks"><code>this.environment</code> in Hooks</a><li><a href="/changes/hotupdate-hook">HMR <code>hotUpdate</code> Plugin Hook</a><li><a href="/changes/per-environment-apis">Move to per-environment APIs</a><li><a href="/changes/ssr-using-modulerunner">SSR using <code>ModuleRunner</code> API</a><li><a href="/changes/shared-plugins-during-build">Shared plugins during build</a></ul></section><section class="level2"aria-labelledby="target-users"><h2 id="target-users">Target users</h2><p>This guide provides the basic concepts about environments for end users.<p>Plugin authors have a more consistent API available to interact with the current environment configuration. If you're building on top of Vite, the <a href="./api-environment-plugins.md">Environment API Plugins Guide</a> guide describes the way extended plugin APIs available to support multiple custom environments.<p>Frameworks could decide to expose environments at different levels. If you're a framework author, continue reading the <a href="./api-environment-frameworks">Environment API Frameworks Guide</a> to learn about the Environment API programmatic side.<p>For Runtime providers, the <a href="./api-environment-runtimes.md">Environment API Runtimes Guide</a> explains how to offer custom environment to be consumed by frameworks and users. <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>