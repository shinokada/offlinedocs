<!doctype html><html lang="en"><meta charset="utf-8"><title>Environment API for Plugins</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="environment-api-for-plugins"><h1 id="environment-api-for-plugins">Environment API for Plugins</h1>warning Experimental Initial work for this API was introduced in Vite 5.1 with the name "Vite Runtime API". This guide describes a revised API, renamed to Environment API. This API will be released in Vite 6 as experimental. You can already test it in the latest `vite@6.0.0-beta.x` version.<p>Resources:<ul><li><a href="https://github.com/vitejs/vite/discussions/16358">Feedback discussion</a> where we are gathering feedback about the new APIs.<li><a href="https://github.com/vitejs/vite/pull/16471">Environment API PR</a> where the new API were implemented and reviewed.</ul><p>Please share with us your feedback as you test the proposal.<section class="level2"aria-labelledby="accessing-the-current-environment-in-hooks"><h2 id="accessing-the-current-environment-in-hooks">Accessing the current environment in hooks</h2><p>Given that there were only two Environments until Vite 6 (<code>client</code> and <code>ssr</code>), a <code>ssr</code> boolean was enough to identify the current environment in Vite APIs. Plugin Hooks received a <code>ssr</code> boolean in the last options parameter, and several APIs expected an optional last <code>ssr</code> parameter to properly associate modules to the correct environment (for example <code>server.moduleGraph.getModuleByUrl(url, { ssr })</code>).<p>With the advent of configurable environments, we now have a uniform way to access their options and instance in plugins. Plugin hooks now expose <code>this.environment</code> in their context, and APIs that previously expected a <code>ssr</code> boolean are now scoped to the proper environment (for example <code>environment.moduleGraph.getModuleByUrl(url)</code>).<p>The Vite server has a shared plugin pipeline, but when a module is processed it is always done in the context of a given environment. The <code>environment</code> instance is available in the plugin context.<p>A plugin could use the <code>environment</code> instance to change how a module is processed depending on the configuration for the environment (which can be accessed using <code>environment.config</code>).<pre class="language-ts"><code class="language-ts">  <span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">environment</span><span class="token punctuation">.</span><span class="token property-access">config</span><span class="token punctuation">.</span><span class="token property-access">resolve</span><span class="token punctuation">.</span><span class="token property-access">conditions</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="registering-new-environments-using-hooks"><h2 id="registering-new-environments-using-hooks">Registering new environments using hooks</h2><p>Plugins can add new environments in the <code>config</code> hook (for example to have a separate module graph for <a href="https://react.dev/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-server-components">RSC</a>):<pre class="language-ts"><code class="language-ts">  <span class="token function">config</span><span class="token punctuation">(</span>config<span class="token operator">:</span> <span class="token maybe-class-name">UserConfig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token property-access">environments</span><span class="token punctuation">.</span><span class="token property-access">rsc</span> <span class="token operator">??=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span></code></pre><p>An empty object is enough to register the environment, default values from the root level environment config.</section><section class="level2"aria-labelledby="configuring-environment-using-hooks"><h2 id="configuring-environment-using-hooks">Configuring environment using hooks</h2><p>While the <code>config</code> hook is running, the complete list of environments isn't yet known and the environments can be affected by both the default values from the root level environment config or explicitly through the <code>config.environments</code> record. Plugins should set default values using the <code>config</code> hook. To configure each environment, they can use the new <code>configEnvironment</code> hook. This hook is called for each environment with its partially resolved config including resolution of final defaults.<pre class="language-ts"><code class="language-ts">  <span class="token function">configEnvironment</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token maybe-class-name">EnvironmentOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'rsc'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      options<span class="token punctuation">.</span><span class="token property-access">resolve</span><span class="token punctuation">.</span><span class="token property-access">conditions</span> <span class="token operator">=</span> <span class="token comment">// ...</span></code></pre></section><section class="level2"aria-labelledby="the-hotupdate-hook"><h2 id="the-hotupdate-hook">The <code>hotUpdate</code> hook</h2><ul><li><strong>Type:</strong> <code>(this: { environment: DevEnvironment }, options: HotUpdateOptions) => Array&#x3C;EnvironmentModuleNode> | void | Promise&#x3C;Array&#x3C;EnvironmentModuleNode> | void></code><li><strong>See also:</strong> <a href="./api-hmr">HMR API</a></ul><p>The <code>hotUpdate</code> hook allows plugins to perform custom HMR update handling for a given environment. When a file changes, the HMR algorithm is run for each environment in series according to the order in <code>server.environments</code>, so the <code>hotUpdate</code> hook will be called multiple times. The hook receives a context object with the following signature:<pre class="language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">HotUpdateContext</span></span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'create'</span> <span class="token operator">|</span> <span class="token string">'update'</span> <span class="token operator">|</span> <span class="token string">'delete'</span>
  file<span class="token operator">:</span> <span class="token builtin">string</span>
  timestamp<span class="token operator">:</span> <span class="token builtin">number</span>
  modules<span class="token operator">:</span> <span class="token known-class-name class-name">Array</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">EnvironmentModuleNode</span><span class="token operator">></span>
  <span class="token function-variable function">read</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span>
  server<span class="token operator">:</span> <span class="token maybe-class-name">ViteDevServer</span>
<span class="token punctuation">}</span></code></pre><ul><li><p><code>this.environment</code> is the module execution environment where a file update is currently being processed.<li><p><code>modules</code> is an array of modules in this environment that are affected by the changed file. It's an array because a single file may map to multiple served modules (e.g. Vue SFCs).<li><p><code>read</code> is an async read function that returns the content of the file. This is provided because, on some systems, the file change callback may fire too fast before the editor finishes updating the file, and direct <code>fs.readFile</code> will return empty content. The read function passed in normalizes this behavior.</ul><p>The hook can choose to:<ul><li><p>Filter and narrow down the affected module list so that the HMR is more accurate.<li><p>Return an empty array and perform a full reload:<pre class="language-js"><code class="language-js"><span class="token function">hotUpdate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> modules<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">environment</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">!==</span> <span class="token string">'client'</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>

  <span class="token comment">// Invalidate modules manually</span>
  <span class="token keyword">const</span> invalidatedModules <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mod <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">environment</span><span class="token punctuation">.</span><span class="token property-access">moduleGraph</span><span class="token punctuation">.</span><span class="token method function property-access">invalidateModule</span><span class="token punctuation">(</span>
      mod<span class="token punctuation">,</span>
      invalidatedModules<span class="token punctuation">,</span>
      timestamp<span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">environment</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'full-reload'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><li><p>Return an empty array and perform complete custom HMR handling by sending custom events to the client:<pre class="language-js"><code class="language-js"><span class="token function">hotUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">environment</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">!==</span> <span class="token string">'client'</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">environment</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'custom'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">event</span><span class="token operator">:</span> <span class="token string">'special-update'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><p>Client code should register the corresponding handler using the <a href="./api-hmr">HMR API</a> (this could be injected by the same plugin's <code>transform</code> hook):<pre class="language-js"><code class="language-js"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">hot</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'special-update'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// perform custom update</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></ul></section><section class="level2"aria-labelledby="per-environment-plugins"><h2 id="per-environment-plugins">Per-environment Plugins</h2><p>A plugin can define what are the environments it should apply to with the <code>applyToEnvironment</code> function.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">UnoCssPlugin</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// shared global state</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token function">buildStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// init per environment state with WeakMap&#x3C;Environment,Data>, this.environment</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">configureServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// use global hooks normally</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">applyToEnvironment</span><span class="token punctuation">(</span><span class="token parameter">environment</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// return true if this plugin should be active in this environment</span>
      <span class="token comment">// if the function isn't provided, the plugin is active in all environments</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">resolveId</span><span class="token punctuation">(</span><span class="token parameter">id<span class="token punctuation">,</span> importer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// only called for environments this plugin apply to</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="environment-in-build-hooks"><h2 id="environment-in-build-hooks">Environment in build hooks</h2><p>In the same way as during dev, plugin hooks also receive the environment instance during build, replacing the <code>ssr</code> boolean. This also works for <code>renderChunk</code>, <code>generateBundle</code>, and other build only hooks.</section><section class="level2"aria-labelledby="shared-plugins-during-build"><h2 id="shared-plugins-during-build">Shared plugins during build</h2><p>Before Vite 6, the plugins pipelines worked in a different way during dev and build:<ul><li><strong>During dev:</strong> plugins are shared<li><strong>During Build:</strong> plugins are isolated for each environment (in different processes: <code>vite build</code> then <code>vite build --ssr</code>).</ul><p>This forced frameworks to share state between the <code>client</code> build and the <code>ssr</code> build through manifest files written to the file system. In Vite 6, we are now building all environments in a single process so the way the plugins pipeline and inter-environment communication can be aligned with dev.<p>In a future major (Vite 7 or 8), we aim to have complete alignment:<ul><li><strong>During both dev and build:</strong> plugins are shared, with <a href="#per-environment-plugins">per-environment filtering</a></ul><p>There will also be a single <code>ResolvedConfig</code> instance shared during build, allowing for caching at entire app build process level in the same way as we have been doing with <code>WeakMap&#x3C;ResolvedConfig, CachedData></code> during dev.<p>For Vite 6, we need to do a smaller step to keep backward compatibility. Ecosystem plugins are currently using <code>config.build</code> instead of <code>environment.config.build</code> to access configuration, so we need to create a new <code>ResolvedConfig</code> per environment by default. A project can opt-in into sharing the full config and plugins pipeline setting <code>builder.sharedConfigBuild</code> to <code>true</code>.<p>This option would only work of a small subset of projects at first, so plugin authors can opt-in for a particular plugin to be shared by setting the <code>sharedDuringBuild</code> flag to <code>true</code>. This allows for easily sharing state both for regular plugins:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">myPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Share state among all environments in dev and build</span>
  <span class="token keyword">const</span> sharedState <span class="token operator">=</span> <span class="token spread operator">...</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'shared-plugin'</span><span class="token punctuation">,</span>
    <span class="token function">transform</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Opt-in into a single instance for all environments</span>
    <span class="token literal-property property">sharedDuringBuild</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>