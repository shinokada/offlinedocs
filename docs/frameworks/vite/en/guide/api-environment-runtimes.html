<!doctype html><html lang="en"><meta charset="utf-8"><title>Environment API for Runtimes</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="environment-api-for-runtimes"><h1 id="environment-api-for-runtimes">Environment API for Runtimes</h1>warning Experimental Initial work for this API was introduced in Vite 5.1 with the name "Vite Runtime API". This guide describes a revised API, renamed to Environment API. This API will be released in Vite 6 as experimental. You can already test it in the latest `vite@6.0.0-beta.x` version.<p>Resources:<ul><li><a href="https://github.com/vitejs/vite/discussions/16358">Feedback discussion</a> where we are gathering feedback about the new APIs.<li><a href="https://github.com/vitejs/vite/pull/16471">Environment API PR</a> where the new API were implemented and reviewed.</ul><p>Please share with us your feedback as you test the proposal.<section class="level2"aria-labelledby="environment-factories"><h2 id="environment-factories">Environment factories</h2><p>Environments factories are intended to be implemented by Environment providers like Cloudflare, and not by end users. Environment factories return a <code>EnvironmentOptions</code> for the most common case of using the target runtime for both dev and build environments. The default environment options can also be set so the user doesn't need to do it.<pre class="language-ts"><code class="language-ts"><span class="token keyword">function</span> <span class="token function">createWorkedEnvironment</span><span class="token punctuation">(</span>
  userConfig<span class="token operator">:</span> <span class="token maybe-class-name">EnvironmentOptions</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">EnvironmentOptions</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      resolve<span class="token operator">:</span> <span class="token punctuation">{</span>
        conditions<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">/*...*/</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      dev<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">createEnvironment</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">return</span> <span class="token function">createWorkerdDevEnvironment</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            hot<span class="token operator">:</span> <span class="token function">customHotChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      build<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token function">createEnvironment</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">return</span> <span class="token function">createWorkerdBuildEnvironment</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    userConfig<span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>Then the config file can be written as:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createWorkerdEnvironment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite-environment-workerd'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">environments</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">ssr</span><span class="token operator">:</span> <span class="token function">createWorkerdEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">build</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">outDir</span><span class="token operator">:</span> <span class="token string">'/dist/ssr'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">rsc</span><span class="token operator">:</span> <span class="token function">createWorkerdEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">build</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">outDir</span><span class="token operator">:</span> <span class="token string">'/dist/rsc'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><p>and frameworks can use an environment with the workerd runtime to do SSR using:<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> ssrEnvironment <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token property-access">environments</span><span class="token punctuation">.</span><span class="token property-access">ssr</span></code></pre></section><section class="level2"aria-labelledby="creating-a-new-environment-factory"><h2 id="creating-a-new-environment-factory">Creating a new environment factory</h2><p>A Vite dev server exposes two environments by default: a <code>client</code> environment and an <code>ssr</code> environment. The client environment is a browser environment by default, and the module runner is implemented by importing the virtual module <code>/@vite/client</code> to client apps. The SSR environment runs in the same Node runtime as the Vite server by default and allows application servers to be used to render requests during dev with full HMR support.<p>The transformed source code is called a module, and the relationships between the modules processed in each environment are kept in a module graph. The transformed code for these modules is sent to the runtimes associated with each environment to be executed. When a module is evaluated in the runtime, its imported modules will be requested triggering the processing of a section of the module graph.<p>A Vite Module Runner allows running any code by processing it with Vite plugins first. It is different from <code>server.ssrLoadModule</code> because the runner implementation is decoupled from the server. This allows library and framework authors to implement their layer of communication between the Vite server and the runner. The browser communicates with its corresponding environment using the server Web Socket and through HTTP requests. The Node Module runner can directly do function calls to process modules as it is running in the same process. Other environments could run modules connecting to a JS runtime like workerd, or a Worker Thread as Vitest does.<p>One of the goals of this feature is to provide a customizable API to process and run code. Users can create new environment factories using the exposed primitives.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DevEnvironment</span><span class="token punctuation">,</span> <span class="token maybe-class-name">RemoteEnvironmentTransport</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite'</span>

<span class="token keyword">function</span> <span class="token function">createWorkerdDevEnvironment</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> config<span class="token operator">:</span> <span class="token maybe-class-name">ResolvedConfig</span><span class="token punctuation">,</span> context<span class="token operator">:</span> <span class="token maybe-class-name">DevEnvironmentContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hot <span class="token operator">=</span> <span class="token comment">/* ... */</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token comment">/* ... */</span>
  <span class="token keyword">const</span> transport <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RemoteEnvironmentTransport</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">send</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token arrow operator">=></span> connection<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token arrow operator">=></span> connection<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> workerdDevEnvironment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DevEnvironment</span></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      resolve<span class="token operator">:</span> <span class="token punctuation">{</span> conditions<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'custom'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token spread operator">...</span>context<span class="token punctuation">.</span><span class="token property-access">options</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    hot<span class="token punctuation">,</span>
    remoteRunner<span class="token operator">:</span> <span class="token punctuation">{</span>
      transport<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> workerdDevEnvironment
<span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="modulerunner"><h2 id="modulerunner"><code>ModuleRunner</code></h2><p>A module runner is instantiated in the target runtime. All APIs in the next section are imported from <code>vite/module-runner</code> unless stated otherwise. This export entry point is kept as lightweight as possible, only exporting the minimal needed to create module runners.<p><strong>Type Signature:</strong><pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ModuleRunner</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> options<span class="token operator">:</span> <span class="token maybe-class-name">ModuleRunnerOptions</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> evaluator<span class="token operator">:</span> <span class="token maybe-class-name">ModuleEvaluator</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> debug<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ModuleRunnerDebugger</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * URL to execute. Accepts file path, server path, or id relative to the root.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword module">import</span><span class="token operator">&#x3C;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span>
  <span class="token doc-comment comment">/**
   * Clear all caches including HMR listeners.
   */</span>
  <span class="token keyword">public</span> <span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token doc-comment comment">/**
   * Clears all caches, removes all HMR listeners, and resets source map support.
   * This method doesn't stop the HMR connection.
   */</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span>
  <span class="token doc-comment comment">/**
   * Returns `true` if the runner has been closed by calling `close()` method.
   */</span>
  <span class="token keyword">public</span> <span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
<span class="token punctuation">}</span></code></pre><p>The module evaluator in <code>ModuleRunner</code> is responsible for executing the code. Vite exports <code>ESModulesEvaluator</code> out of the box, it uses <code>new AsyncFunction</code> to evaluate the code. You can provide your own implementation if your JavaScript runtime doesn't support unsafe evaluation.<p>Module runner exposes <code>import</code> method. When Vite server triggers <code>full-reload</code> HMR event, all affected modules will be re-executed. Be aware that Module Runner doesn't update <code>exports</code> object when this happens (it overrides it), you would need to run <code>import</code> or get the module from <code>evaluatedModules</code> again if you rely on having the latest <code>exports</code> object.<p><strong>Example Usage:</strong><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ModuleRunner</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ESModulesEvaluator</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite/module-runner'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> root<span class="token punctuation">,</span> fetchModule <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./rpc-implementation.js'</span>

<span class="token keyword">const</span> moduleRunner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleRunner</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    root<span class="token punctuation">,</span>
    fetchModule<span class="token punctuation">,</span>
    <span class="token comment">// you can also provide hmr.connection to support HMR</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ESModulesEvaluator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> moduleRunner<span class="token punctuation">.</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'/src/entry-point.js'</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="modulerunneroptions"><h2 id="modulerunneroptions"><code>ModuleRunnerOptions</code></h2><pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ModuleRunnerOptions</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * Root of the project
   */</span>
  root<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token doc-comment comment">/**
   * A set of methods to communicate with the server.
   */</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">RunnerTransport</span>
  <span class="token doc-comment comment">/**
   * Configure how source maps are resolved. Prefers `node` if `process.setSourceMapsEnabled` is available.
   * Otherwise it will use `prepareStackTrace` by default which overrides `Error.prepareStackTrace` method.
   * You can provide an object to configure how file contents and source maps are resolved for files that were not processed by Vite.
   */</span>
  sourcemapInterceptor<span class="token operator">?</span><span class="token operator">:</span>
    <span class="token operator">|</span> <span class="token boolean">false</span>
    <span class="token operator">|</span> <span class="token string">'node'</span>
    <span class="token operator">|</span> <span class="token string">'prepareStackTrace'</span>
    <span class="token operator">|</span> <span class="token maybe-class-name">InterceptorOptions</span>
  <span class="token doc-comment comment">/**
   * Disable HMR or configure HMR options.
   */</span>
  hmr<span class="token operator">?</span><span class="token operator">:</span>
    <span class="token operator">|</span> <span class="token boolean">false</span>
    <span class="token operator">|</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * Configure how HMR communicates between the client and the server.
         */</span>
        connection<span class="token operator">:</span> <span class="token maybe-class-name">ModuleRunnerHMRConnection</span>
        <span class="token doc-comment comment">/**
         * Configure HMR logger.
         */</span>
        logger<span class="token operator">?</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token operator">|</span> <span class="token maybe-class-name">HMRLogger</span>
      <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * Custom module cache. If not provided, it creates a separate module cache for each module runner instance.
   */</span>
  evaluatedModules<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">EvaluatedModules</span>
<span class="token punctuation">}</span></code></pre></section><section class="level2"aria-labelledby="moduleevaluator"><h2 id="moduleevaluator"><code>ModuleEvaluator</code></h2><p><strong>Type Signature:</strong><pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ModuleEvaluator</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * Number of prefixed lines in the transformed code.
   */</span>
  startOffset<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token doc-comment comment">/**
   * Evaluate code that was transformed by Vite.
   * <span class="token keyword">@param</span> <span class="token parameter">context</span> Function context
   * <span class="token keyword">@param</span> <span class="token parameter">code</span> Transformed code
   * <span class="token keyword">@param</span> <span class="token parameter">id</span> ID that was used to fetch the module
   */</span>
  <span class="token function">runInlinedModule</span><span class="token punctuation">(</span>
    context<span class="token operator">:</span> <span class="token maybe-class-name">ModuleRunnerContext</span><span class="token punctuation">,</span>
    code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span>
  <span class="token doc-comment comment">/**
   * evaluate externalized module.
   * <span class="token keyword">@param</span> <span class="token parameter">file</span> File URL to the external module
   */</span>
  <span class="token function">runExternalModule</span><span class="token punctuation">(</span>file<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span>
<span class="token punctuation">}</span></code></pre><p>Vite exports <code>ESModulesEvaluator</code> that implements this interface by default. It uses <code>new AsyncFunction</code> to evaluate code, so if the code has inlined source map it should contain an <a href="https://tc39.es/ecma262/#sec-createdynamicfunction">offset of 2 lines</a> to accommodate for new lines added. This is done automatically by the <code>ESModulesEvaluator</code>. Custom evaluators will not add additional lines.</section><section class="level2"aria-labelledby="runnertransport"><h2 id="runnertransport">RunnerTransport</h2><p><strong>Type Signature:</strong><pre class="language-ts"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">RunnerTransport</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * A method to get the information about the module.
   */</span>
  fetchModule<span class="token operator">:</span> <span class="token maybe-class-name">FetchFunction</span>
<span class="token punctuation">}</span></code></pre><p>Transport object that communicates with the environment via an RPC or by directly calling the function. By default, you need to pass an object with <code>fetchModule</code> method - it can use any type of RPC inside of it, but Vite also exposes bidirectional transport interface via a <code>RemoteRunnerTransport</code> class to make the configuration easier. You need to couple it with the <code>RemoteEnvironmentTransport</code> instance on the server like in this example where module runner is created in the worker thread:</p>code-group<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> parentPort <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'node:worker_threads'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> fileURLToPath <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'node:url'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ESModulesEvaluator</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ModuleRunner</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">RemoteRunnerTransport</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite/module-runner'</span>

<span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ModuleRunner</span></span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    root<span class="token operator">:</span> <span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transport<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RemoteRunnerTransport</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token function-variable function">send</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token arrow operator">=></span> parentPort<span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token arrow operator">=></span> parentPort<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">,</span>
      timeout<span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ESModulesEvaluator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">BroadcastChannel</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'node:worker_threads'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createServer<span class="token punctuation">,</span> <span class="token maybe-class-name">RemoteEnvironmentTransport</span><span class="token punctuation">,</span> <span class="token maybe-class-name">DevEnvironment</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite'</span>

<span class="token keyword">function</span> <span class="token function">createWorkerEnvironment</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> worker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Worker</span></span><span class="token punctuation">(</span><span class="token string">'./worker.js'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DevEnvironment</span></span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    hot<span class="token operator">:</span> <span class="token comment">/* custom hot channel */</span><span class="token punctuation">,</span>
    remoteRunner<span class="token operator">:</span> <span class="token punctuation">{</span>
      transport<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RemoteEnvironmentTransport</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">send</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token arrow operator">=></span> worker<span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onMessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token arrow operator">=></span> worker<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword control-flow">await</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  environments<span class="token operator">:</span> <span class="token punctuation">{</span>
    worker<span class="token operator">:</span> <span class="token punctuation">{</span>
      dev<span class="token operator">:</span> <span class="token punctuation">{</span>
        createEnvironment<span class="token operator">:</span> createWorkerEnvironment<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p><code>RemoteRunnerTransport</code> and <code>RemoteEnvironmentTransport</code> are meant to be used together, but you don't have to use them at all. You can define your own function to communicate between the runner and the server. For example, if you connect to the environment via an HTTP request, you can call <code>fetch().json()</code> in <code>fetchModule</code> function:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ESModulesEvaluator</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ModuleRunner</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vite/module-runner'</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ModuleRunner</span></span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    root<span class="token operator">:</span> <span class="token function">fileURLToPath</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transport<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">async</span> <span class="token function">fetchModule</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> importer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://my-vite-server/fetch?id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#x26;importer=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>importer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword control-flow">return</span> response<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ESModulesEvaluator</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> runner<span class="token punctuation">.</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'/entry.js'</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="modulerunnerhmrconnection"><h2 id="modulerunnerhmrconnection">ModuleRunnerHMRConnection</h2><p><strong>Type Signature:</strong><pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ModuleRunnerHMRConnection</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * Checked before sending messages to the server.
   */</span>
  <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
  <span class="token doc-comment comment">/**
   * Send a message to the server.
   */</span>
  <span class="token function">send</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token maybe-class-name">HotPayload</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
  <span class="token doc-comment comment">/**
   * Configure how HMR is handled when this connection triggers an update.
   * This method expects that the connection will start listening for HMR updates and call this callback when it's received.
   */</span>
  <span class="token function">onUpdate</span><span class="token punctuation">(</span><span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token maybe-class-name">HotPayload</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span></code></pre><p>This interface defines how HMR communication is established. Vite exports <code>ServerHMRConnector</code> from the main entry point to support HMR during Vite SSR. The <code>isReady</code> and <code>send</code> methods are usually called when the custom event is triggered (like, <code>import.meta.hot.send("my-event")</code>).<p><code>onUpdate</code> is called only once when the new module runner is initiated. It passed down a method that should be called when connection triggers the HMR event. The implementation depends on the type of connection (as an example, it can be <code>WebSocket</code>/<code>EventEmitter</code>/<code>MessageChannel</code>), but it usually looks something like this:<pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">onUpdate</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">connection</span><span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'hmr'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">callback</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>The callback is queued and it will wait for the current update to be resolved before processing the next update. Unlike the browser implementation, HMR updates in a module runner will wait until all listeners (like, <code>vite:beforeUpdate</code>/<code>vite:beforeFullReload</code>) are finished before updating the modules. <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>