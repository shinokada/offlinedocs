<!doctype html><html lang="en"><meta charset="utf-8"><title>Migration from v4</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="migration-from-v4"><h1 id="migration-from-v4">Migration from v4</h1><section class="level2"aria-labelledby="nodejs-support"><h2 id="nodejs-support">Node.js Support</h2><p>Vite no longer supports Node.js 14 / 16 / 17 / 19, which reached its EOL. Node.js 18 / 20+ is now required.</section><section class="level2"aria-labelledby="rollup-4"><h2 id="rollup-4">Rollup 4</h2><p>Vite is now using Rollup 4 which also brings along its breaking changes, in particular:<ul><li>Import assertions (<code>assertions</code> prop) has been renamed to import attributes (<code>attributes</code> prop).<li>Acorn plugins are no longer supported.<li>For Vite plugins, <code>this.resolve</code> <code>skipSelf</code> option is now <code>true</code> by default.<li>For Vite plugins, <code>this.parse</code> now only supports the <code>allowReturnOutsideFunction</code> option for now.</ul><p>Read the full breaking changes in <a href="https://github.com/rollup/rollup/releases/tag/v4.0.0">Rollup's release notes</a> for build-related changes in <a href="/config/build-options.md#build-rollupoptions"><code>build.rollupOptions</code></a>.<p>If you are using TypeScript, make sure to set <code>moduleResolution: 'bundler'</code> (or <code>node16</code>/<code>nodenext</code>) as Rollup 4 requires it. Or you can set <code>skipLibCheck: true</code> instead.</section><section class="level2"aria-labelledby="deprecate-cjs-node-api"><h2 id="deprecate-cjs-node-api">Deprecate CJS Node API</h2><p>The CJS Node API of Vite is deprecated. When calling <code>require('vite')</code>, a deprecation warning is now logged. You should update your files or frameworks to import the ESM build of Vite instead.<p>In a basic Vite project, make sure:<ol><li>The <code>vite.config.js</code> file content is using the ESM syntax.<li>The closest <code>package.json</code> file has <code>"type": "module"</code>, or use the <code>.mjs</code>/<code>.mts</code> extension, e.g. <code>vite.config.mjs</code> or <code>vite.config.mts</code>.</ol><p>For other projects, there are a few general approaches:<ul><li><strong>Configure ESM as default, opt-in to CJS if needed:</strong> Add <code>"type": "module"</code> in the project <code>package.json</code>. All <code>*.js</code> files are now interpreted as ESM and needs to use the ESM syntax. You can rename a file with the <code>.cjs</code> extension to keep using CJS instead.<li><strong>Keep CJS as default, opt-in to ESM if needed:</strong> If the project <code>package.json</code> does not have <code>"type": "module"</code>, all <code>*.js</code> files are interpreted as CJS. You can rename a file with the <code>.mjs</code> extension to use ESM instead.<li><strong>Dynamically import Vite:</strong> If you need to keep using CJS, you can dynamically import Vite using <code>import('vite')</code> instead. This requires your code to be written in an <code>async</code> context, but should still be manageable as Vite's API is mostly asynchronous.</ul><p>See the <a href="/guide/troubleshooting.html#vite-cjs-node-api-deprecated">troubleshooting guide</a> for more information.</section><section class="level2"aria-labelledby="rework-define-and-importmetaenv-replacement-strategy"><h2 id="rework-define-and-importmetaenv-replacement-strategy">Rework <code>define</code> and <code>import.meta.env.*</code> replacement strategy</h2><p>In Vite 4, the <a href="/config/shared-options.md#define"><code>define</code></a> and <a href="/guide/env-and-mode.md#env-variables"><code>import.meta.env.*</code></a> features use different replacement strategies in dev and build:<ul><li>In dev, both features are injected as global variables to <code>globalThis</code> and <code>import.meta</code> respectively.<li>In build, both features are statically replaced with a regex.</ul><p>This results in a dev and build inconsistency when trying to access the variables, and sometimes even caused failed builds. For example:<pre class="language-js"><code class="language-js"><span class="token comment">// vite.config.js</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">define</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">__APP_VERSION__</span><span class="token operator">:</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span><span class="token string">'1.0.0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> __APP_VERSION__ <span class="token punctuation">}</span>
<span class="token comment">// dev: { __APP_VERSION__: "1.0.0" } ✅</span>
<span class="token comment">// build: { "1.0.0" } ❌</span>

<span class="token keyword">const</span> docs <span class="token operator">=</span> <span class="token string">'I like import.meta.env.MODE'</span>
<span class="token comment">// dev: "I like import.meta.env.MODE" ✅</span>
<span class="token comment">// build: "I like "production"" ❌</span></code></pre><p>Vite 5 fixes this by using <code>esbuild</code> to handle the replacements in builds, aligning with the dev behaviour.<p>This change should not affect most setups, as it's already documented that <code>define</code> values should follow esbuild's syntax:<blockquote><p>To be consistent with esbuild behavior, expressions must either be a JSON object (null, boolean, number, string, array, or object) or a single identifier.</blockquote><p>However, if you prefer to keep statically replacing values directly, you can use <a href="https://github.com/rollup/plugins/tree/master/packages/replace"><code>@rollup/plugin-replace</code></a>.</section><section class="level2"aria-labelledby="general-changes"><h2 id="general-changes">General Changes</h2><section class="level3"aria-labelledby="ssr-externalized-modules-value-now-matches-production"><h3 id="ssr-externalized-modules-value-now-matches-production">SSR externalized modules value now matches production</h3><p>In Vite 4, SSR externalized modules are wrapped with <code>.default</code> and <code>.__esModule</code> handling for better interoperability, but it doesn't match the production behaviour when loaded by the runtime environment (e.g. Node.js), causing hard-to-catch inconsistencies. By default, all direct project dependencies are SSR externalized.<p>Vite 5 now removes the <code>.default</code> and <code>.__esModule</code> handling to match the production behaviour. In practice, this shouldn't affect properly-packaged dependencies, but if you encounter new issues loading modules, you can try these refactors:<pre class="language-js"><code class="language-js"><span class="token comment">// Before:</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> foo <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'bar'</span>

<span class="token comment">// After:</span>
<span class="token keyword module">import</span> <span class="token imports">_bar</span> <span class="token keyword module">from</span> <span class="token string">'bar'</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token operator">=</span> _bar</code></pre><pre class="language-js"><code class="language-js"><span class="token comment">// Before:</span>
<span class="token keyword module">import</span> <span class="token imports">foo</span> <span class="token keyword module">from</span> <span class="token string">'bar'</span>

<span class="token comment">// After:</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> _foo</span> <span class="token keyword module">from</span> <span class="token string">'bar'</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> _foo<span class="token punctuation">.</span><span class="token keyword module">default</span></code></pre><p>Note that these changes matches the Node.js behaviour, so you can also run the imports in Node.js to test it out. If you prefer to stick with the previous behaviour, you can set <code>legacy.proxySsrExternalModules</code> to <code>true</code>.</section><section class="level3"aria-labelledby="workerplugins-is-now-a-function"><h3 id="workerplugins-is-now-a-function"><code>worker.plugins</code> is now a function</h3><p>In Vite 4, <a href="/config/worker-options.md#worker-plugins"><code>worker.plugins</code></a> accepted an array of plugins (<code>(Plugin | Plugin[])[]</code>). From Vite 5, it needs to be configured as a function that returns an array of plugins (<code>() => (Plugin | Plugin[])[]</code>). This change is required so parallel worker builds run more consistently and predictably.</section><section class="level3"aria-labelledby="allow-path-containing--to-fallback-to-indexhtml"><h3 id="allow-path-containing--to-fallback-to-indexhtml">Allow path containing <code>.</code> to fallback to index.html</h3><p>In Vite 4, accessing a path in dev containing <code>.</code> did not fallback to index.html even if <a href="/config/shared-options.md#apptype"><code>appType</code></a> is set to <code>'spa'</code> (default). From Vite 5, it will fallback to index.html.<p>Note that the browser will no longer show a 404 error message in the console if you point the image path to a non-existent file (e.g. <code>&#x3C;img src="./file-does-not-exist.png"></code>).</section><section class="level3"aria-labelledby="align-dev-and-preview-html-serving-behaviour"><h3 id="align-dev-and-preview-html-serving-behaviour">Align dev and preview HTML serving behaviour</h3><p>In Vite 4, the dev and preview servers serve HTML based on its directory structure and trailing slash differently. This causes inconsistencies when testing your built app. Vite 5 refactors into a single behaviour like below, given the following file structure:<pre class="language-text"><code class="language-text">├── index.html
├── file.html
└── dir
    └── index.html</code></pre><table><thead><tr><th>Request<th>Before (dev)<th>Before (preview)<th>After (dev &#x26; preview)<tbody><tr><td><code>/dir/index.html</code><td><code>/dir/index.html</code><td><code>/dir/index.html</code><td><code>/dir/index.html</code><tr><td><code>/dir</code><td><code>/index.html</code> (SPA fallback)<td><code>/dir/index.html</code><td><code>/index.html</code> (SPA fallback)<tr><td><code>/dir/</code><td><code>/dir/index.html</code><td><code>/dir/index.html</code><td><code>/dir/index.html</code><tr><td><code>/file.html</code><td><code>/file.html</code><td><code>/file.html</code><td><code>/file.html</code><tr><td><code>/file</code><td><code>/index.html</code> (SPA fallback)<td><code>/file.html</code><td><code>/file.html</code><tr><td><code>/file/</code><td><code>/index.html</code> (SPA fallback)<td><code>/file.html</code><td><code>/index.html</code> (SPA fallback)</table></section><section class="level3"aria-labelledby="manifest-files-are-now-generated-in-vite-directory-by-default"><h3 id="manifest-files-are-now-generated-in-vite-directory-by-default">Manifest files are now generated in <code>.vite</code> directory by default</h3><p>In Vite 4, the manifest files (<a href="/config/build-options.md#build-manifest"><code>build.manifest</code></a> and <a href="/config/build-options.md#build-ssrmanifest"><code>build.ssrManifest</code></a>) were generated in the root of <a href="/config/build-options.md#build-outdir"><code>build.outDir</code></a> by default.<p>From Vite 5, they will be generated in the <code>.vite</code> directory in the <code>build.outDir</code> by default. This change helps deconflict public files with the same manifest file names when they are copied to the <code>build.outDir</code>.</section><section class="level3"aria-labelledby="corresponding-css-files-are-not-listed-as-top-level-entry-in-manifestjson-file"><h3 id="corresponding-css-files-are-not-listed-as-top-level-entry-in-manifestjson-file">Corresponding CSS files are not listed as top level entry in manifest.json file</h3><p>In Vite 4, the corresponding CSS file for a JavaScript entry point was also listed as a top-level entry in the manifest file (<a href="/config/build-options.md#build-manifest"><code>build.manifest</code></a>). These entries were unintentionally added and only worked for simple cases.<p>In Vite 5, corresponding CSS files can only be found within the JavaScript entry file section. When injecting the JS file, the corresponding CSS files <a href="/guide/backend-integration.md#:~:text=%3C!%2D%2D%20if%20production%20%2D%2D%3E%0A%3Clink%20rel%3D%22stylesheet%22%20href%3D%22/assets/%7B%7B%20manifest%5B%27main.js%27%5D.css%20%7D%7D%22%20/%3E%0A%3Cscript%20type%3D%22module%22%20src%3D%22/assets/%7B%7B%20manifest%5B%27main.js%27%5D.file%20%7D%7D%22%3E%3C/script%3E">should be injected</a>. When the CSS should be injected separately, it must be added as a separate entry point.</section><section class="level3"aria-labelledby="cli-shortcuts-require-an-additional-enter-press"><h3 id="cli-shortcuts-require-an-additional-enter-press">CLI shortcuts require an additional <code>Enter</code> press</h3><p>CLI shortcuts, like <code>r</code> to restart the dev server, now require an additional <code>Enter</code> press to trigger the shortcut. For example, <code>r + Enter</code> to restart the dev server.<p>This change prevents Vite from swallowing and controlling OS-specific shortcuts, allowing better compatibility when combining the Vite dev server with other processes, and avoids the <a href="https://github.com/vitejs/vite/pull/14342">previous caveats</a>.</section><section class="level3"aria-labelledby="update-experimentaldecorators-and-usedefineforclassfields-typescript-behaviour"><h3 id="update-experimentaldecorators-and-usedefineforclassfields-typescript-behaviour">Update <code>experimentalDecorators</code> and <code>useDefineForClassFields</code> TypeScript behaviour</h3><p>Vite 5 uses esbuild 0.19 and removes the compatibility layer for esbuild 0.18, which changes how <a href="https://www.typescriptlang.org/tsconfig#experimentalDecorators"><code>experimentalDecorators</code></a> and <a href="https://www.typescriptlang.org/tsconfig#useDefineForClassFields"><code>useDefineForClassFields</code></a> are handled.<ul><li><p><strong><code>experimentalDecorators</code> is not enabled by default</strong><p>You need to set <code>compilerOptions.experimentalDecorators</code> to <code>true</code> in <code>tsconfig.json</code> to use decorators.<li><p><strong><code>useDefineForClassFields</code> defaults depend on the TypeScript <code>target</code> value</strong><p>If <code>target</code> is not <code>ESNext</code> or <code>ES2022</code> or newer, or if there's no <code>tsconfig.json</code> file, <code>useDefineForClassFields</code> will default to <code>false</code> which can be problematic with the default <code>esbuild.target</code> value of <code>esnext</code>. It may transpile to <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Classes/Static_initialization_blocks#browser_compatibility">static initialization blocks</a> which may not be supported in your browser.<p>As such, it is recommended to set <code>target</code> to <code>ESNext</code> or <code>ES2022</code> or newer, or set <code>useDefineForClassFields</code> to <code>true</code> explicitly when configuring <code>tsconfig.json</code>.</ul><pre class="language-jsonc"><code class="language-jsonc">{
  "compilerOptions": {
    // Set true if you use decorators
    "experimentalDecorators": true,
    // Set true if you see parsing errors in your browser
    "useDefineForClassFields": true
  }
}</code></pre></section><section class="level3"aria-labelledby="remove---https-flag-and-https-true"><h3 id="remove---https-flag-and-https-true">Remove <code>--https</code> flag and <code>https: true</code></h3><p>The <code>--https</code> flag sets <code>server.https: true</code> and <code>preview.https: true</code> internally. This config was meant to be used together with the automatic https certification generation feature which <a href="https://v3.vitejs.dev/guide/migration.html#automatic-https-certificate-generation">was dropped in Vite 3</a>. Hence, this config is no longer useful as it will start a Vite HTTPS server without a certificate.<p>If you use <a href="https://github.com/vitejs/vite-plugin-basic-ssl"><code>@vitejs/plugin-basic-ssl</code></a> or <a href="https://github.com/liuweiGL/vite-plugin-mkcert"><code>vite-plugin-mkcert</code></a>, they will already set the <code>https</code> config internally, so you can remove <code>--https</code>, <code>server.https: true</code>, and <code>preview.https: true</code> in your setup.</section><section class="level3"aria-labelledby="remove-resolvepackageentry-and-resolvepackagedata-apis"><h3 id="remove-resolvepackageentry-and-resolvepackagedata-apis">Remove <code>resolvePackageEntry</code> and <code>resolvePackageData</code> APIs</h3><p>The <code>resolvePackageEntry</code> and <code>resolvePackageData</code> APIs are removed as they exposed Vite's internals and blocked potential Vite 4.3 optimizations in the past. These APIs can be replaced with third-party packages, for example:<ul><li><code>resolvePackageEntry</code>: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import.meta/resolve"><code>import.meta.resolve</code></a> or the <a href="https://github.com/wooorm/import-meta-resolve"><code>import-meta-resolve</code></a> package.<li><code>resolvePackageData</code>: Same as above, and crawl up the package directory to get the root <code>package.json</code>. Or use the community <a href="https://github.com/svitejs/vitefu"><code>vitefu</code></a> package.</ul><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> resolve <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'import-meta-env'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> findDepPkgJsonPath <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitefu'</span>
<span class="token keyword module">import</span> <span class="token imports">fs</span> <span class="token keyword module">from</span> <span class="token string">'node:fs'</span>

<span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token string">'my-lib'</span>
<span class="token keyword">const</span> basedir <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token method function property-access">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// `resolvePackageEntry`:</span>
<span class="token keyword">const</span> packageEntry <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> basedir<span class="token punctuation">)</span>

<span class="token comment">// `resolvePackageData`:</span>
<span class="token keyword">const</span> packageJsonPath <span class="token operator">=</span> <span class="token function">findDepPkgJsonPath</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> basedir<span class="token punctuation">)</span>
<span class="token keyword">const</span> packageJson <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>packageJsonPath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></section></section><section class="level2"aria-labelledby="removed-deprecated-apis"><h2 id="removed-deprecated-apis">Removed Deprecated APIs</h2><ul><li>Default exports of CSS files (e.g <code>import style from './foo.css'</code>): Use the <code>?inline</code> query instead<li><code>import.meta.globEager</code>: Use <code>import.meta.glob('*', { eager: true })</code> instead<li><code>ssr.format: 'cjs'</code> and <code>legacy.buildSsrCjsExternalHeuristics</code> (<a href="https://github.com/vitejs/vite/discussions/13816">#13816</a>)<li><code>server.middlewareMode: 'ssr'</code> and <code>server.middlewareMode: 'html'</code>: Use <a href="/config/shared-options.md#apptype"><code>appType</code></a> + <a href="/config/server-options.md#server-middlewaremode"><code>server.middlewareMode: true</code></a> instead (<a href="https://github.com/vitejs/vite/pull/8452">#8452</a>)</ul></section><section class="level2"aria-labelledby="advanced"><h2 id="advanced">Advanced</h2><p>There are some changes which only affect plugin/tool creators.<ul><li><a href="https://github.com/vitejs/vite/pull/14119">[#14119] refactor!: merge <code>PreviewServerForHook</code> into <code>PreviewServer</code> type</a><ul><li>The <code>configurePreviewServer</code> hook now accepts the <code>PreviewServer</code> type instead of <code>PreviewServerForHook</code> type.</ul><li><a href="https://github.com/vitejs/vite/pull/14818">[#14818] refactor(preview)!: use base middleware</a><ul><li>Middlewares added from the returned function in <code>configurePreviewServer</code> now does not have access to the <code>base</code> when comparing the <code>req.url</code> value. This aligns the behaviour with the dev server. You can check the <code>base</code> from the <code>configResolved</code> hook if needed.</ul><li><a href="https://github.com/vitejs/vite/pull/14834">[#14834] fix(types)!: expose httpServer with Http2SecureServer union</a><ul><li><code>http.Server | http2.Http2SecureServer</code> is now used instead of <code>http.Server</code> where appropriate.</ul></ul><p>Also there are other breaking changes which only affect few users.<ul><li><a href="https://github.com/vitejs/vite/pull/14098">[#14098] fix!: avoid rewriting this (reverts #5312)</a><ul><li>Top level <code>this</code> was rewritten to <code>globalThis</code> by default when building. This behavior is now removed.</ul><li><a href="https://github.com/vitejs/vite/pull/14231">[#14231] feat!: add extension to internal virtual modules</a><ul><li>Internal virtual modules' id now has an extension (<code>.js</code>).</ul><li><a href="https://github.com/vitejs/vite/pull/14583">[#14583] refactor!: remove exporting internal APIs</a><ul><li>Removed accidentally exported internal APIs: <code>isDepsOptimizerEnabled</code> and <code>getDepOptimizationConfig</code><li>Removed exported internal types: <code>DepOptimizationResult</code>, <code>DepOptimizationProcessing</code>, and <code>DepsOptimizer</code><li>Renamed <code>ResolveWorkerOptions</code> type to <code>ResolvedWorkerOptions</code></ul><li><a href="https://github.com/vitejs/vite/pull/5657">[#5657] fix: return 404 for resources requests outside the base path</a><ul><li>In the past, Vite responded to requests outside the base path without <code>Accept: text/html</code>, as if they were requested with the base path. Vite no longer does that and responds with 404 instead.</ul><li><a href="https://github.com/vitejs/vite/pull/14723">[#14723] fix(resolve)!: remove special .mjs handling</a><ul><li>In the past, when a library <code>"exports"</code> field maps to an <code>.mjs</code> file, Vite will still try to match the <code>"browser"</code> and <code>"module"</code> fields to fix compatibility with certain libraries. This behavior is now removed to align with the exports resolution algorithm.</ul><li><a href="https://github.com/vitejs/vite/pull/14733">[#14733] feat(resolve)!: remove <code>resolve.browserField</code></a><ul><li><code>resolve.browserField</code> has been deprecated since Vite 3 in favour of an updated default of <code>['browser', 'module', 'jsnext:main', 'jsnext']</code> for <a href="/config/shared-options.md#resolve-mainfields"><code>resolve.mainFields</code></a>.</ul><li><a href="https://github.com/vitejs/vite/pull/14855">[#14855] feat!: add isPreview to ConfigEnv and resolveConfig</a><ul><li>Renamed <code>ssrBuild</code> to <code>isSsrBuild</code> in the <code>ConfigEnv</code> object.</ul><li><a href="https://github.com/vitejs/vite/pull/14945">[#14945] fix(css): correctly set manifest source name and emit CSS file</a><ul><li>CSS file names are now generated based on the chunk name.</ul></ul></section><section class="level2"aria-labelledby="migration-from-v3"><h2 id="migration-from-v3">Migration from v3</h2><p>Check the <a href="https://v4.vitejs.dev/guide/migration.html">Migration from v3 Guide</a> in the Vite v4 docs first to see the needed changes to port your app to Vite v4, and then proceed with the changes on this page. <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>