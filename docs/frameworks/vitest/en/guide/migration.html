<!doctype html><html lang="en"><meta charset="utf-8"><title>Migration Guide | Guide</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="outline"content="deep"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="migration-guide"><h1 id="migration-guide">Migration Guide</h1><section class="level2"aria-labelledby="migrating-to-vitest-20"><h2 id="migrating-to-vitest-20">Migrating to Vitest 2.0</h2><section class="level3"aria-labelledby="default-pool-is-forks"><h3 id="default-pool-is-forks">Default Pool is <code>forks</code></h3><p>Vitest 2.0 changes the default configuration for <code>pool</code> to <code>'forks'</code> for better stability. You can read the full motivation in <a href="https://github.com/vitest-dev/vitest/pull/5047">PR</a>.<p>If you've used <code>poolOptions</code> without specifying a <code>pool</code>, you might need to update the configuration:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    poolOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      threads<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// [!code --]</span>
        singleThread<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// [!code --]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// [!code --]</span>
      forks<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
        singleFork<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="hooks-are-running-in-a-stack"><h3 id="hooks-are-running-in-a-stack">Hooks are Running in a Stack</h3><p>Before Vitest 2.0, all hooks ran in parallel. In 2.0, all hooks run serially. Additionally, <code>afterAll</code>/<code>afterEach</code> hooks run in reverse order.<p>To revert to the parallel execution of hooks, change <a href="../config.html#sequence-hooks"><code>sequence.hooks</code></a> to <code>'parallel'</code>:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    sequence<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
      hooks<span class="token operator">:</span> <span class="token string">'parallel'</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="suiteconcurrent-runs-all-tests-concurrently"><h3 id="suiteconcurrent-runs-all-tests-concurrently"><code>suite.concurrent</code> Runs All Tests Concurrently</h3><p>Previously, specifying <code>concurrent</code> on a suite would group concurrent tests by suites, running them sequentially. Now, following Jest's behavior, all tests run concurrently (subject to <a href="../config.html#maxconcurrency"><code>maxConcurrency</code></a> limits).</section><section class="level3"aria-labelledby="v8-coverages-coverageignoreemptylines-is-enabled-by-default"><h3 id="v8-coverages-coverageignoreemptylines-is-enabled-by-default">V8 Coverage's <code>coverage.ignoreEmptyLines</code> is Enabled by Default</h3><p>The default value of <code>coverage.ignoreEmptyLines</code> is now true. This significant change may affect code coverage reports, requiring adjustments to coverage thresholds for some projects. This adjustment only affects the default setting when <code>coverage.provider</code> is <code>'v8'</code>.</section><section class="level3"aria-labelledby="removal-of-the-watchexclude-option"><h3 id="removal-of-the-watchexclude-option">Removal of the <code>watchExclude</code> Option</h3><p>Vitest uses Vite's watcher. Exclude files or directories by adding them to <code>server.watch.ignored</code>:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  server<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
    watch<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
      ignored<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'!node_modules/examplejs'</span><span class="token punctuation">]</span> <span class="token comment">// [!code ++]</span>
    <span class="token punctuation">}</span> <span class="token comment">// [!code ++]</span>
  <span class="token punctuation">}</span> <span class="token comment">// [!code ++]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="--segfault-retry-removed"><h3 id="--segfault-retry-removed"><code>--segfault-retry</code> Removed</h3><p>With the changes to default pool, this option is no longer needed. If you experience segfault errors, try switching to <code>'forks'</code> pool. If the problem persists, please open a new issue with a reproduction.</section><section class="level3"aria-labelledby="empty-task-in-suite-tasks-removed"><h3 id="empty-task-in-suite-tasks-removed">Empty Task In Suite Tasks Removed</h3><p>This is the change to the advanced <a href="/advanced/runner#your-task-function">task API</a>. Previously, traversing <code>.suite</code> would eventually lead to the empty internal suite that was used instead of a file task.<p>This makes <code>.suite</code> optional; if the task is defined at the top level, it will not have a suite. You can fallback to the <code>.file</code> property that is now present on all tasks (including the file task itself, so be careful not to fall into the endless recursion).<p>This change also removes the file from <code>expect.getState().currentTestName</code> and makes <code>expect.getState().testPath</code> required.</section><section class="level3"aria-labelledby="taskmeta-is-added-to-the-json-reporter"><h3 id="taskmeta-is-added-to-the-json-reporter"><code>task.meta</code> is Added to the JSON Reporter</h3><p>JSON reporter now prints <code>task.meta</code> for every assertion result.</section><section class="level3"aria-labelledby="simplified-generic-types-of-mock-functions-eg-vifn-mock"><h3 id="simplified-generic-types-of-mock-functions-eg-vifn-mock">Simplified Generic Types of Mock Functions (e.g. <code>vi.fn&#x3C;T></code>, <code>Mock&#x3C;T></code>)</h3><p>Previously <code>vi.fn&#x3C;TArgs, TReturn></code> accepted two generic types separately for arguments and return value. This is changed to directly accept a function type <code>vi.fn&#x3C;T></code> to simplify the usage.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">Mock</span></span><span class="token punctuation">,</span> vi <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> add <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token arrow operator">=></span> x <span class="token operator">+</span> y

<span class="token comment">// using vi.fn&#x3C;T></span>
<span class="token keyword">const</span> mockAdd <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">fn</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Parameters</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> add<span class="token operator">></span><span class="token punctuation">,</span> <span class="token maybe-class-name">ReturnType</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> add<span class="token operator">>></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
<span class="token keyword">const</span> mockAdd <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">fn</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> add<span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span>

<span class="token comment">// using Mock&#x3C;T></span>
<span class="token keyword">const</span> mockAdd<span class="token operator">:</span> <span class="token maybe-class-name">Mock</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Parameters</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> add<span class="token operator">></span><span class="token punctuation">,</span> <span class="token maybe-class-name">ReturnType</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> add<span class="token operator">>></span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
<span class="token keyword">const</span> mockAdd<span class="token operator">:</span> <span class="token maybe-class-name">Mock</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> add<span class="token operator">></span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span></code></pre></section><section class="level3"aria-labelledby="accessing-resolved-mockresults"><h3 id="accessing-resolved-mockresults">Accessing Resolved <code>mock.results</code></h3><p>Previously Vitest resolved <code>mock.results</code> values if the function returned a Promise. Now there is a separate <a href="/api/mock#mock-settledresults"><code>mock.settledResults</code></a> property that populates only when the returned Promise is resolved or rejected.<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span>
<span class="token keyword control-flow">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">results</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 'result' // [!code --]</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">results</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 'Promise&#x3C;result>' // [!code ++]</span>

<span class="token keyword">const</span> settledResult <span class="token operator">=</span> fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">settledResults</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">// 'result'</span></code></pre><p>With this change, we also introduce new <a href="/api/expect#tohaveresolved"><code>toHaveResolved*</code></a> matchers similar to <code>toHaveReturned</code> to make migration easier if you used <code>toHaveReturned</code> before:<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span>
<span class="token keyword control-flow">await</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturned</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
<span class="token function">expect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveResolved</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span></code></pre></section><section class="level3"aria-labelledby="browser-mode"><h3 id="browser-mode">Browser Mode</h3><p>Vitest Browser Mode had a lot of changes during the beta cycle. You can read about our philosophy on the Browser Mode in the <a href="https://github.com/vitest-dev/vitest/discussions/5828">GitHub discussion page</a>.<p>Most of the changes were additive, but there were some small breaking changes:<ul><li><code>none</code> provider was renamed to <code>preview</code> <a href="https://github.com/vitest-dev/vitest/pull/5826">#5842</a><li><code>preview</code> provider is now a default <a href="https://github.com/vitest-dev/vitest/pull/5826">#5842</a><li><code>indexScripts</code> is renamed to <code>orchestratorScripts</code> <a href="https://github.com/vitest-dev/vitest/pull/5842">#5842</a></ul></section><section class="level3"aria-labelledby="deprecated-options-removed"><h3 id="deprecated-options-removed">Deprecated Options Removed</h3><p>Some deprecated options were removed:<ul><li><code>vitest typecheck</code> command - use <code>vitest --typecheck</code> instead<li><code>VITEST_JUNIT_CLASSNAME</code> and <code>VITEST_JUNIT_SUITE_NAME</code> env variables (use reporter options instead)<li>check for <code>c8</code> coverage (use coverage-v8 instead)<li>export of <code>SnapshotEnvironment</code> from <code>vitest</code> - import it from <code>vitest/snapshot</code> instead<li><code>SpyInstance</code> is removed in favor of <code>MockInstance</code></ul></section></section><section class="level2"aria-labelledby="migrating-to-vitest-10"><h2 id="migrating-to-vitest-10">Migrating to Vitest 1.0</h2><section class="level3"aria-labelledby="minimum-requirements"><h3 id="minimum-requirements">Minimum Requirements</h3><p>Vitest 1.0 requires Vite 5.0 and Node.js 18 or higher.<p>All <code>@vitest/*</code> sub packages require Vitest version 1.0.</section><section class="level3"aria-labelledby="snapshots-update-3961"><h3 id="snapshots-update-3961">Snapshots Update <a href="https://github.com/vitest-dev/vitest/pull/3961">#3961</a></h3><p>Quotes in snapshots are no longer escaped, and all snapshots use backtick quotes (`) even if the string is just a single line.<ol><li>Quotes are no longer escaped:</ol><pre class="language-diff"><code class="language-diff">expect({ foo: 'bar' }).toMatchInlineSnapshot(`
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> Object {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    \\"foo\\": \\"bar\\",
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "foo": "bar",
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>`)</code></pre><ol start="2"><li>One-line snapshots now use "`" quotes instead of ':</ol><pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> expect('some string').toMatchInlineSnapshot('"some string"')
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> expect('some string').toMatchInlineSnapshot(`"some string"`)</span></span></code></pre><p>There were also <a href="https://github.com/vitest-dev/vitest/pull/4076">changes</a> to <code>@vitest/snapshot</code> package. If you are not using it directly, you don't need to change anything.<ul><li>You no longer need to extend <code>SnapshotClient</code> just to override <code>equalityCheck</code> method: just pass it down as <code>isEqual</code> when initiating an instance<li><code>client.setTest</code> was renamed to <code>client.startCurrentRun</code><li><code>client.resetCurrent</code> was renamed to <code>client.finishCurrentRun</code></ul></section><section class="level3"aria-labelledby="pools-are-standardized-4172"><h3 id="pools-are-standardized-4172">Pools are Standardized <a href="https://github.com/vitest-dev/vitest/pull/4172">#4172</a></h3><p>We removed a lot of configuration options to make it easier to configure the runner to your needs. Please, have a look at migration examples if you rely on <code>--threads</code> or other related flags.<ul><li><code>--threads</code> is now <code>--pool=threads</code><li><code>--no-threads</code> is now <code>--pool=forks</code><li><code>--single-thread</code> is now <code>--poolOptions.threads.singleThread</code><li><code>--experimental-vm-threads</code> is now <code>--pool=vmThreads</code><li><code>--experimental-vm-worker-memory-limit</code> is now <code>--poolOptions.vmThreads.memoryLimit</code><li><code>--isolate</code> is now <code>--poolOptions.&#x3C;pool-name>.isolate</code> and <code>browser.isolate</code><li><code>test.maxThreads</code> is now <code>test.poolOptions.&#x3C;pool-name>.maxThreads</code><li><code>test.minThreads</code> is now <code>test.poolOptions.&#x3C;pool-name>.minThreads</code><li><code>test.useAtomics</code> is now <code>test.poolOptions.&#x3C;pool-name>.useAtomics</code><li><code>test.poolMatchGlobs.child_process</code> is now <code>test.poolMatchGlobs.forks</code><li><code>test.poolMatchGlobs.experimentalVmThreads</code> is now <code>test.poolMatchGlobs.vmThreads</code></ul><pre class="language-diff"><code class="language-diff">{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> scripts: {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    "test": "vitest --no-threads"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    // For identical behaviour:
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "test": "vitest --pool forks --poolOptions.forks.singleFork"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    // Or multi parallel forks:
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "test": "vitest --pool forks"
</span></span>
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}</code></pre><pre class="language-diff"><code class="language-diff">{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> scripts: {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    "test": "vitest --experimental-vm-threads"
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "test": "vitest --pool vmThreads"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}</code></pre><pre class="language-diff"><code class="language-diff">{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> scripts: {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    "test": "vitest --isolate false"
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "test": "vitest --poolOptions.threads.isolate false"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}</code></pre><pre class="language-diff"><code class="language-diff">{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> scripts: {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    "test": "vitest --no-threads --isolate false"
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    "test": "vitest --pool forks --poolOptions.forks.isolate false"
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}</code></pre></section><section class="level3"aria-labelledby="changes-to-coverage-4265-4442"><h3 id="changes-to-coverage-4265-4442">Changes to Coverage <a href="https://github.com/vitest-dev/vitest/pull/4265">#4265</a>, <a href="https://github.com/vitest-dev/vitest/pull/4442">#4442</a></h3><p>Option <code>coverage.all</code> is now enabled by default. This means that all project files matching <code>coverage.include</code> pattern will be processed even if they are not executed.<p>Coverage thresholds API's shape was changed, and it now supports specifying thresholds for specific files using glob patterns:<pre class="language-diff"><code class="language-diff">export default defineConfig({
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> test: {
</span><span class="token prefix unchanged"> </span><span class="token line">   coverage: {
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">      perFile: true,
</span><span class="token prefix deleted">-</span><span class="token line">      thresholdAutoUpdate: true,
</span><span class="token prefix deleted">-</span><span class="token line">      100: true,
</span><span class="token prefix deleted">-</span><span class="token line">      lines: 100,
</span><span class="token prefix deleted">-</span><span class="token line">      functions: 100,
</span><span class="token prefix deleted">-</span><span class="token line">      branches: 100,
</span><span class="token prefix deleted">-</span><span class="token line">      statements: 100,
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      thresholds: {
</span><span class="token prefix inserted">+</span><span class="token line">        perFile: true,
</span><span class="token prefix inserted">+</span><span class="token line">        autoUpdate: true,
</span><span class="token prefix inserted">+</span><span class="token line">        100: true,
</span><span class="token prefix inserted">+</span><span class="token line">        lines: 100,
</span><span class="token prefix inserted">+</span><span class="token line">        functions: 100,
</span><span class="token prefix inserted">+</span><span class="token line">        branches: 100,
</span><span class="token prefix inserted">+</span><span class="token line">        statements: 100,
</span><span class="token prefix inserted">+</span><span class="token line">      }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   }
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>})</code></pre></section><section class="level3"aria-labelledby="mock-types-4400"><h3 id="mock-types-4400">Mock Types <a href="https://github.com/vitest-dev/vitest/pull/4400">#4400</a></h3><p>A few types were removed in favor of Jest-style "Mock" naming.<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> import { EnhancedSpy, SpyInstance } from 'vitest'
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import { MockInstance } from 'vitest'</span></span></code></pre><blockquote>`SpyInstance` is deprecated in favor of `MockInstance` and will be removed in the next major release.</blockquote></section><section class="level3"aria-labelledby="timer-mocks-3925"><h3 id="timer-mocks-3925">Timer mocks <a href="https://github.com/vitest-dev/vitest/pull/3925">#3925</a></h3><p><code>vi.useFakeTimers()</code> no longer automatically mocks <a href="https://nodejs.org/api/process.html#processnexttickcallback-args"><code>process.nextTick</code></a>. It is still possible to mock <code>process.nextTick</code> by explicitly specifying it by using <code>vi.useFakeTimers({ toFake: ['nextTick'] })</code>.<p>However, mocking <code>process.nextTick</code> is not possible when using <code>--pool=forks</code>. Use a different <code>--pool</code> option if you need <code>process.nextTick</code> mocking.</section></section><section class="level2"aria-labelledby="migrating-from-jest"><h2 id="migrating-from-jest">Migrating from Jest</h2><p>Vitest has been designed with a Jest compatible API, in order to make the migration from Jest as simple as possible. Despite those efforts, you may still run into the following differences:<section class="level3"aria-labelledby="globals-as-a-default"><h3 id="globals-as-a-default">Globals as a Default</h3><p>Jest has their <a href="https://jestjs.io/docs/api">globals API</a> enabled by default. Vitest does not. You can either enable globals via <a href="../config.html#globals">the <code>globals</code> configuration setting</a> or update your code to use imports from the <code>vitest</code> module instead.<p>If you decide to keep globals disabled, be aware that common libraries like <a href="https://testing-library.com/"><code>testing-library</code></a> will not run auto DOM <a href="https://testing-library.com/docs/svelte-testing-library/api/#cleanup">cleanup</a>.</section><section class="level3"aria-labelledby="module-mocks"><h3 id="module-mocks">Module Mocks</h3><p>When mocking a module in Jest, the factory argument's return value is the default export. In Vitest, the factory argument has to return an object with each export explicitly defined. For example, the following <code>jest.mock</code> would have to be updated as follows:<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./some-path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'hello'</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./some-path'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
  <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span></code></pre><p>For more details please refer to the <a href="/api/vi#vi-mock"><code>vi.mock</code> api section</a>.</section><section class="level3"aria-labelledby="auto-mocking-behaviour"><h3 id="auto-mocking-behaviour">Auto-Mocking Behaviour</h3><p>Unlike Jest, mocked modules in <code>&#x3C;root>/__mocks__</code> are not loaded unless <code>vi.mock()</code> is called. If you need them to be mocked in every test, like in Jest, you can mock them inside <a href="../config.html#setupfiles"><code>setupFiles</code></a>.</section><section class="level3"aria-labelledby="importing-the-original-of-a-mocked-package"><h3 id="importing-the-original-of-a-mocked-package">Importing the Original of a Mocked Package</h3><p>If you are only partially mocking a package, you might have previously used Jest's function <code>requireActual</code>. In Vitest, you should replace these calls with <code>vi.importActual</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token punctuation">{</span> cloneDeep <span class="token punctuation">}</span> <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token method function property-access">requireActual</span><span class="token punctuation">(</span><span class="token string">'lodash/cloneDeep'</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> cloneDeep <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">importActual</span><span class="token punctuation">(</span><span class="token string">'lodash/cloneDeep'</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span></code></pre></section><section class="level3"aria-labelledby="extends-mocking-to-external-libraries"><h3 id="extends-mocking-to-external-libraries">Extends mocking to external libraries</h3><p>Where Jest does it by default, when mocking a module and wanting this mocking to be extended to other external libraries that use the same module, you should explicitly tell which 3rd-party library you want to be mocked, so the external library would be part of your source code, by using <a href="https://vitest.dev/config/#server-deps-inline">server.deps.inline</a>.<pre class="language-text"><code class="language-text">server.deps.inline: ["lib-name"]</code></pre></section><section class="level3"aria-labelledby="expectgetstatecurrenttestname"><h3 id="expectgetstatecurrenttestname">expect.getState().currentTestName</h3><p>Vitest's <code>test</code> names are joined with a <code>></code> symbol to make it easier to distinguish tests from suites, while Jest uses an empty space (<code></code>).<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> `${describeTitle} ${testTitle}`
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> `${describeTitle} > ${testTitle}`</span></span></code></pre></section><section class="level3"aria-labelledby="envs"><h3 id="envs">Envs</h3><p>Just like Jest, Vitest sets <code>NODE_ENV</code> to <code>test</code>, if it wasn't set before. Vitest also has a counterpart for <code>JEST_WORKER_ID</code> called <code>VITEST_POOL_ID</code> (always less than or equal to <code>maxThreads</code>), so if you rely on it, don't forget to rename it. Vitest also exposes <code>VITEST_WORKER_ID</code> which is a unique ID of a running worker - this number is not affected by <code>maxThreads</code>, and will increase with each created worker.</section><section class="level3"aria-labelledby="replace-property"><h3 id="replace-property">Replace property</h3><p>If you want to modify the object, you will use <a href="https://jestjs.io/docs/jest-object#jestreplacepropertyobject-propertykey-value">replaceProperty API</a> in Jest, you can use <a href="../api.html#vi-stubenv"><code>vi.stubEnv</code></a> or <a href="/api/vi#vi-spyon"><code>vi.spyOn</code></a> to do the same also in Vitest.</section><section class="level3"aria-labelledby="done-callback"><h3 id="done-callback">Done Callback</h3><p>From Vitest v0.10.0, the callback style of declaring tests is deprecated. You can rewrite them to use <code>async</code>/<code>await</code> functions, or use Promise to mimic the callback style.<pre class="language-text"><code class="language-text">it('should work', (done) => {  // [!code --]
it('should work', () => new Promise(done => { // [!code ++]
  // ...
  done()
}) // [!code --]
})) // [!code ++]</code></pre></section><section class="level3"aria-labelledby="hooks"><h3 id="hooks">Hooks</h3><p><code>beforeAll</code>/<code>beforeEach</code> hooks may return <a href="../api.html#setup-and-teardown">teardown function</a> in Vitest. Because of that you may need to rewrite your hooks declarations, if they return something other than <code>undefined</code> or <code>null</code>:<pre class="language-ts"><code class="language-ts"><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">setActivePinia</span><span class="token punctuation">(</span><span class="token function">createTestingPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span> <span class="token function">setActivePinia</span><span class="token punctuation">(</span><span class="token function">createTestingPinia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span></code></pre><p>In Jest hooks are called sequentially (one after another). By default, Vitest runs hooks in parallel. To use Jest's behavior, update <a href="../config.html#sequence-hooks"><code>sequence.hooks</code></a> option:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    sequence<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// [!code ++]</span>
      hooks<span class="token operator">:</span> <span class="token string">'list'</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
    <span class="token punctuation">}</span> <span class="token comment">// [!code ++]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="types"><h3 id="types">Types</h3><p>Vitest doesn't have an equivalent to <code>jest</code> namespace, so you will need to import types directly from <code>vitest</code>:<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> fn<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Mock</span></span><span class="token operator">&#x3C;</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">number</span><span class="token operator">></span> <span class="token comment">// [!code --]</span>
<span class="token keyword module">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Mock</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span> <span class="token comment">// [!code ++]</span>
<span class="token keyword">let</span> fn<span class="token operator">:</span> <span class="token maybe-class-name">Mock</span><span class="token operator">&#x3C;</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">number</span><span class="token operator">></span> <span class="token comment">// [!code ++]</span></code></pre></section><section class="level3"aria-labelledby="timers"><h3 id="timers">Timers</h3><p>Vitest doesn't support Jest's legacy timers.</section><section class="level3"aria-labelledby="timeout"><h3 id="timeout">Timeout</h3><p>If you used <code>jest.setTimeout</code>, you would need to migrate to <code>vi.setConfig</code>:<pre class="language-ts"><code class="language-ts">jest<span class="token punctuation">.</span><span class="token method function property-access">setTimeout</span><span class="token punctuation">(</span><span class="token number">5_000</span><span class="token punctuation">)</span> <span class="token comment">// [!code --]</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">setConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span> testTimeout<span class="token operator">:</span> <span class="token number">5_000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// [!code ++]</span></code></pre></section><section class="level3"aria-labelledby="vue-snapshots"><h3 id="vue-snapshots">Vue Snapshots</h3><p>This is not a Jest-specific feature, but if you previously were using Jest with vue-cli preset, you will need to install <a href="https://github.com/eddyerburgh/jest-serializer-vue"><code>jest-serializer-vue</code></a> package, and use it inside <a href="../config.html#setupfiles">setupFiles</a>:</p>code-group ```js [vite.config.js] import { defineConfig } from 'vite'<p>export default defineConfig({ test: { setupFiles: ['./tests/unit/setup.js'] } })<pre class="language-text"><code class="language-text">```js [tests/unit/setup.js]
import vueSnapshotSerializer from 'jest-serializer-vue'

expect.addSnapshotSerializer(vueSnapshotSerializer)</code></pre><p>Otherwise your snapshots will have a lot of escaped <code>"</code> characters. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>