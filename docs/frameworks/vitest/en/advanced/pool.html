<!doctype html><html lang="en"><meta charset="utf-8"><title>Custom Pool</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="custom-pool"><h1 id="custom-pool">Custom Pool</h1><blockquote>This is advanced API. If you are just running tests, you probably don't need this. It is primarily used by library authors.</blockquote><p>Vitest runs tests in pools. By default, there are several pools:<ul><li><code>threads</code> to run tests using <code>node:worker_threads</code> (isolation is provided with a new worker context)<li><code>forks</code> to run tests using <code>node:child_process</code> (isolation is provided with a new <code>child_process.fork</code> process)<li><code>vmThreads</code> to run tests using <code>node:worker_threads</code> (but isolation is provided with <code>vm</code> module instead of a new worker context)<li><code>browser</code> to run tests using browser providers<li><code>typescript</code> to run typechecking on tests</ul><p>You can provide your own pool by specifying a file path:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// will run every file with a custom pool by default</span>
    pool<span class="token operator">:</span> <span class="token string">'./my-custom-pool.ts'</span><span class="token punctuation">,</span>
    <span class="token comment">// you can provide options using `poolOptions` object</span>
    poolOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      myCustomPool<span class="token operator">:</span> <span class="token punctuation">{</span>
        customProperty<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// you can also specify pool for a subset of files</span>
    poolMatchGlobs<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">[</span><span class="token string">'**/*.custom.test.ts'</span><span class="token punctuation">,</span> <span class="token string">'./my-custom-pool.ts'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><section class="level2"aria-labelledby="api"><h2 id="api">API</h2><p>The file specified in <code>pool</code> option should export a function (can be async) that accepts <code>Vitest</code> interface as its first option. This function needs to return an object matching <code>ProcessPool</code> interface:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ProcessPool</span><span class="token punctuation">,</span> <span class="token maybe-class-name">WorkspaceProject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ProcessPool</span></span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token function-variable function">runTests</span><span class="token operator">:</span> <span class="token punctuation">(</span>files<span class="token operator">:</span> <span class="token punctuation">[</span>project<span class="token operator">:</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> testFile<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> invalidates<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span>
  close<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span>
<span class="token punctuation">}</span></code></pre><p>The function is called only once (unless the server config was updated), and it's generally a good idea to initialize everything you need for tests inside that function and reuse it when <code>runTests</code> is called.<p>Vitest calls <code>runTest</code> when new tests are scheduled to run. It will not call it if <code>files</code> is empty. The first argument is an array of tuples: the first element is a reference to a workspace project and the second one is an absolute path to a test file. Files are sorted using <a href="../config.html#sequence.sequencer"><code>sequencer</code></a> before <code>runTests</code> is called. It's possible (but unlikely) to have the same file twice, but it will always have a different project - this is implemented via <a href="/guide/workspace"><code>vitest.workspace.ts</code></a> configuration.<p>Vitest will wait until <code>runTests</code> is executed before finishing a run (i.e., it will emit <a href="/guide/reporters"><code>onFinished</code></a> only after <code>runTests</code> is resolved).<p>If you are using a custom pool, you will have to provide test files and their results yourself - you can reference <a href="https://github.com/vitest-dev/vitest/blob/main/packages/vitest/src/node/state.ts"><code>vitest.state</code></a> for that (most important are <code>collectFiles</code> and <code>updateTasks</code>). Vitest uses <code>startTests</code> function from <code>@vitest/runner</code> package to do that.<p>To communicate between different processes, you can create methods object using <code>createMethodsRPC</code> from <code>vitest/node</code>, and use any form of communication that you prefer. For example, to use WebSockets with <code>birpc</code> you can write something like this:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createBirpc <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'birpc'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> parse<span class="token punctuation">,</span> stringify <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'flatted'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> createMethodsRPC <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword">function</span> <span class="token function">createRpc</span><span class="token punctuation">(</span>project<span class="token operator">:</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> wss<span class="token operator">:</span> <span class="token maybe-class-name">WebSocketServer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">createBirpc</span><span class="token punctuation">(</span>
    <span class="token function">createMethodsRPC</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token function-variable function">post</span><span class="token operator">:</span> msg <span class="token arrow operator">=></span> wss<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">on</span><span class="token operator">:</span> fn <span class="token arrow operator">=></span> wss<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">,</span>
      serialize<span class="token operator">:</span> stringify<span class="token punctuation">,</span>
      deserialize<span class="token operator">:</span> parse<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>To make sure every test is collected, you would call <code>ctx.state.collectFiles</code> and report it to Vitest reporters:<pre class="language-ts"><code class="language-ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runTests</span><span class="token punctuation">(</span>project<span class="token operator">:</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> tests<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... running tests, put into "files" and "tasks"</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token function">createMethodsRPC</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span>
  <span class="token keyword control-flow">await</span> methods<span class="token punctuation">.</span><span class="token method function property-access">onCollected</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
  <span class="token comment">// most reporters rely on results being updated in "onTaskUpdate"</span>
  <span class="token keyword control-flow">await</span> methods<span class="token punctuation">.</span><span class="token method function property-access">onTaskUpdate</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>You can see a simple example in <a href="https://github.com/vitest-dev/vitest/blob/main/test/run/pool-custom-fixtures/pool/custom-pool.ts">pool/custom-pool.ts</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>