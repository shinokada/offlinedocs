<!doctype html><html lang="en"><meta charset="utf-8"><title>Vi</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="outline"content="deep"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="vi"><h1 id="vi">Vi</h1><p>Vitest provides utility functions to help you out through its <code>vi</code> helper. You can access it globally (when <a href="../config.html#globals">globals configuration</a> is enabled), or import it from <code>vitest</code> directly:<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span></code></pre><section class="level2"aria-labelledby="mock-modules"><h2 id="mock-modules">Mock Modules</h2><p>This section describes the API that you can use when <a href="/guide/mocking#modules">mocking a module</a>. Beware that Vitest doesn't support mocking modules imported using <code>require()</code>.<section class="level3"aria-labelledby="vimock"><h3 id="vimock">vi.mock</h3><ul><li><strong>Type</strong>: <code>(path: string, factory?: MockOptions | ((importOriginal: () => unknown) => unknown)) => void</code><li><strong>Type</strong>: <code>&#x3C;T>(path: Promise&#x3C;T>, factory?: MockOptions | ((importOriginal: () => T) => T | Promise&#x3C;T>)) => void</code></ul><p>Substitutes all imported modules from provided <code>path</code> with another module. You can use configured Vite aliases inside a path. The call to <code>vi.mock</code> is hoisted, so it doesn't matter where you call it. It will always be executed before all imports. If you need to reference some variables outside of its scope, you can define them inside <a href="#vi-hoisted"><code>vi.hoisted</code></a> and reference them inside <code>vi.mock</code>.<blockquote>`vi.mock` works only for modules that were imported with the `import` keyword. It doesn't work with `require`.<p>In order to hoist <code>vi.mock</code>, Vitest statically analyzes your files. It indicates that <code>vi</code> that was not directly imported from the <code>vitest</code> package (for example, from some utility file) cannot be used. Use <code>vi.mock</code> with <code>vi</code> imported from <code>vitest</code>, or enable <a href="../config.html#globals"><code>globals</code></a> config option.<p>Vitest will not mock modules that were imported inside a <a href="../config.html#setupfiles">setup file</a> because they are cached by the time a test file is running. You can call <a href="#vi-resetmodules"><code>vi.resetModules()</code></a> inside <a href="#vi-hoisted"><code>vi.hoisted</code></a> to clear all module caches before running a test file.</blockquote><p>If the <code>factory</code> function is defined, all imports will return its result. Vitest calls factory only once and caches results for all subsequent imports until <a href="#vi-unmock"><code>vi.unmock</code></a> or <a href="#vi-dounmock"><code>vi.doUnmock</code></a> is called.<p>Unlike in <code>jest</code>, the factory can be asynchronous. You can use <a href="#vi-importactual"><code>vi.importActual</code></a> or a helper with the factory passed in as the first argument, and get the original module inside.<p>Since Vitest 2.1, you can also provide an object with a <code>spy</code> property instead of a factory function. If <code>spy</code> is <code>true</code>, then Vitest will automock the module as usual, but it won't override the implementation of exports. This is useful if you just want to assert that the exported method was called correctly by another method.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> calculator <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./src/calculator.ts'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./src/calculator.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> spy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// calls the original implementation,</span>
<span class="token comment">// but allows asserting the behaviour later</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">calculator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturned</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><p>Vitest also supports a module promise instead of a string in the <code>vi.mock</code> and <code>vi.doMock</code> methods for better IDE support. When the file is moved, the path will be updated, and <code>importOriginal</code> inherits the type automatically. Using this signature will also enforce factory return type to be compatible with the original module (keeping exports optional).<pre class="language-ts"><code class="language-ts"><span class="token comment">// @filename: ./path/to/module.js</span>
<span class="token keyword module">export</span> <span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">total</span><span class="token punctuation">(</span><span class="token spread operator">...</span>numbers<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token comment">// @filename: test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token comment">// ---cut---</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>importOriginal<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">importOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// type is inferred</span>
  <span class="token comment">//    ^?</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>mod<span class="token punctuation">,</span>
    <span class="token comment">// replace some exports</span>
    total<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Under the hood, Vitest still operates on a string and not a module object.<p>If you are using TypeScript with <code>paths</code> aliases configured in <code>tsconfig.json</code> however, the compiler won't be able to correctly resolve import types. In order to make it work, make sure to replace all aliased imports, with their corresponding relative paths. Eg. use <code>import('./path/to/module.js')</code> instead of <code>import('@/module')</code>.<blockquote>`vi.mock` is hoisted (in other words, _moved_) to **top of the file**. It means that whenever you write it (be it inside `beforeEach` or `test`), it will actually be called before that.<p>This also means that you cannot use any variables inside the factory that are defined outside the factory.<p>If you need to use variables inside the factory, try <a href="#vi-domock"><code>vi.doMock</code></a>. It works the same way but isn't hoisted. Beware that it only mocks subsequent imports.<p>You can also reference variables defined by <code>vi.hoisted</code> method if it was declared before <code>vi.mock</code>:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> namedExport <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./path/to/module.js'</span>

<span class="token keyword">const</span> mocks <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    namedExport<span class="token operator">:</span> mocks<span class="token punctuation">.</span><span class="token property-access">namedExport</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>namedExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">namedExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>namedExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>mocks<span class="token punctuation">.</span><span class="token property-access">namedExport</span><span class="token punctuation">)</span></code></pre></blockquote><blockquote>If you are mocking a module with default export, you will need to provide a `default` key within the returned factory function object. This is an ES module-specific caveat; therefore, `jest` documentation may differ as `jest` uses CommonJS modules. For example,<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> myDefaultKey<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// etc...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></blockquote><p>If there is a <code>__mocks__</code> folder alongside a file that you are mocking, and the factory is not provided, Vitest will try to find a file with the same name in the <code>__mocks__</code> subfolder and use it as an actual module. If you are mocking a dependency, Vitest will try to find a <code>__mocks__</code> folder in the <a href="../config.html#root">root</a> of the project (default is <code>process.cwd()</code>). You can tell Vitest where the dependencies are located through the <a href="../config.html#deps-moduledirectories"><code>deps.moduleDirectories</code></a> config option.<p>For example, you have this file structure:<pre class="language-text"><code class="language-text">- __mocks__
  - axios.js
- src
  __mocks__
    - increment.js
  - increment.js
- tests
  - increment.test.js</code></pre><p>If you call <code>vi.mock</code> in a test file without a factory or options provided, it will find a file in the <code>__mocks__</code> folder to use as a module:<pre class="language-ts"><code class="language-ts"><span class="token comment">// increment.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// axios is a default export from `__mocks__/axios.js`</span>
<span class="token keyword module">import</span> <span class="token imports">axios</span> <span class="token keyword module">from</span> <span class="token string">'axios'</span>

<span class="token comment">// increment is a named export from `src/__mocks__/increment.js`</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../increment.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'../increment.js'</span><span class="token punctuation">)</span>

axios<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/apples/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></code></pre><blockquote>Beware that if you don't call `vi.mock`, modules **are not** mocked automatically. To replicate Jest's automocking behaviour, you can call `vi.mock` for each required module inside [`setupFiles`](../config.html#setupfiles).</blockquote><p>If there is no <code>__mocks__</code> folder or a factory provided, Vitest will import the original module and auto-mock all its exports. For the rules applied, see <a href="/guide/mocking#automocking-algorithm">algorithm</a>.</section><section class="level3"aria-labelledby="vidomock"><h3 id="vidomock">vi.doMock</h3><ul><li><strong>Type</strong>: <code>(path: string, factory?: MockOptions | ((importOriginal: () => unknown) => unknown)) => void</code><li><strong>Type</strong>: <code>&#x3C;T>(path: Promise&#x3C;T>, factory?: MockOptions | ((importOriginal: () => T) => T | Promise&#x3C;T>)) => void</code></ul><p>The same as <a href="#vi-mock"><code>vi.mock</code></a>, but it's not hoisted to the top of the file, so you can reference variables in the global file scope. The next <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import">dynamic import</a> of the module will be mocked.<blockquote>This will not mock modules that were imported before this was called. Don't forget that all static imports in ESM are always [hoisted](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#hoisting), so putting this before static import will not force it to be called before the import:<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">doMock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span> <span class="token comment">// this will be called _after_ the import statement</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span></code></pre></blockquote><pre class="language-ts"><code class="language-ts"><span class="token comment">// ./increment.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token builtin">number</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> beforeEach<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>

<span class="token comment">// the module is not mocked, because vi.doMock is not called yet</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span>

<span class="token keyword">let</span> mockedIncrement <span class="token operator">=</span> <span class="token number">100</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// you can access variables inside a factory</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">doMock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token operator">++</span>mockedIncrement <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'importing the next module imports mocked one'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// original import WAS NOT MOCKED, because vi.doMock is evaluated AFTER imports</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> increment<span class="token operator">:</span> mockedIncrement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>
  <span class="token comment">// new dynamic import returns mocked module</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="vimocked"><h3 id="vimocked">vi.mocked</h3><ul><li><strong>Type</strong>: <code>&#x3C;T>(obj: T, deep?: boolean) => MaybeMockedDeep&#x3C;T></code><li><strong>Type</strong>: <code>&#x3C;T>(obj: T, options?: { partial?: boolean; deep?: boolean }) => MaybePartiallyMockedDeep&#x3C;T></code></ul><p>Type helper for TypeScript. Just returns the object that was passed.<p>When <code>partial</code> is <code>true</code> it will expect a <code>Partial&#x3C;T></code> as a return value. By default, this will only make TypeScript believe that the first level values are mocked. You can pass down <code>{ deep: true }</code> as a second argument to tell TypeScript that the whole object is mocked, if it actually is.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports">example</span> <span class="token keyword module">from</span> <span class="token string">'./example.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'1 + 1 equals 10'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token property-access">calc</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token method function property-access">calc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viimportactual"><h3 id="viimportactual">vi.importActual</h3><ul><li><strong>Type</strong>: <code>&#x3C;T>(path: string) => Promise&#x3C;T></code></ul><p>Imports module, bypassing all checks if it should be mocked. Can be useful if you want to mock module partially.<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">importActual</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>axios<span class="token punctuation">,</span> get<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viimportmock"><h3 id="viimportmock">vi.importMock</h3><ul><li><strong>Type</strong>: <code>&#x3C;T>(path: string) => Promise&#x3C;MaybeMockedDeep&#x3C;T>></code></ul><p>Imports a module with all of its properties (including nested properties) mocked. Follows the same rules that <a href="#vi-mock"><code>vi.mock</code></a> does. For the rules applied, see <a href="/guide/mocking#automocking-algorithm">algorithm</a>.</section><section class="level3"aria-labelledby="viunmock"><h3 id="viunmock">vi.unmock</h3><ul><li><strong>Type</strong>: <code>(path: string | Promise&#x3C;Module>) => void</code></ul><p>Removes module from the mocked registry. All calls to import will return the original module even if it was mocked before. This call is hoisted to the top of the file, so it will only unmock modules that were defined in <code>setupFiles</code>, for example.</section><section class="level3"aria-labelledby="vidounmock"><h3 id="vidounmock">vi.doUnmock</h3><ul><li><strong>Type</strong>: <code>(path: string | Promise&#x3C;Module>) => void</code></ul><p>The same as <a href="#vi-unmock"><code>vi.unmock</code></a>, but is not hoisted to the top of the file. The next import of the module will import the original module instead of the mock. This will not unmock previously imported modules.<pre class="language-ts"><code class="language-ts"><span class="token comment">// ./increment.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token builtin">number</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>

<span class="token comment">// increment is already mocked, because vi.mock is hoisted</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// this is hoisted, and factory is called before the import on line 1</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// all calls are mocked, and `increment` always returns 100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// this is not hoisted, so other import will return unmocked module</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">doUnmock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>

<span class="token comment">// this STILL returns 100, because `vi.doUnmock` doesn't reevaluate a module</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// the next import is unmocked, now `increment` is the original function that returns count + 1</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> increment<span class="token operator">:</span> unmockedIncrement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>

<span class="token function">unmockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span>
<span class="token function">unmockedIncrement</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">31</span></code></pre></section><section class="level3"aria-labelledby="viresetmodules"><h3 id="viresetmodules">vi.resetModules</h3><ul><li><strong>Type</strong>: <code>() => Vitest</code></ul><p>Resets modules registry by clearing the cache of all modules. This allows modules to be reevaluated when reimported. Top-level imports cannot be re-evaluated. Might be useful to isolate modules where local state conflicts between tests.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./data.js'</span> <span class="token comment">// Will not get reevaluated beforeEach test</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">resetModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'change state'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some/path.js'</span><span class="token punctuation">)</span> <span class="token comment">// Will get reevaluated</span>
  mod<span class="token punctuation">.</span><span class="token method function property-access">changeLocalState</span><span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token method function property-access">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'module has old state'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some/path.js'</span><span class="token punctuation">)</span> <span class="token comment">// Will get reevaluated</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token method function property-access">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'old value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>Does not reset mocks registry. To clear mocks registry, use [`vi.unmock`](#vi-unmock) or [`vi.doUnmock`](#vi-dounmock).</blockquote></section><section class="level3"aria-labelledby="vidynamicimportsettled"><h3 id="vidynamicimportsettled">vi.dynamicImportSettled</h3><p>Wait for all imports to load. Useful, if you have a synchronous call that starts importing a module that you cannot wait otherwise.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// cannot track import because Promise is not returned</span>
<span class="token keyword">function</span> <span class="token function">renderComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./component.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> render <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'operations are resolved'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">renderComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">dynamicImportSettled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">'.component'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">not</span><span class="token punctuation">.</span><span class="token method function property-access">toBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>If during a dynamic import another dynamic import is initiated, this method will wait until all of them are resolved.<p>This method will also wait for the next <code>setTimeout</code> tick after the import is resolved so all synchronous operations should be completed by the time it's resolved.</blockquote></section></section><section class="level2"aria-labelledby="mocking-functions-and-objects"><h2 id="mocking-functions-and-objects">Mocking Functions and Objects</h2><p>This section describes how to work with <a href="/api/mock">method mocks</a> and replace environmental and global variables.<section class="level3"aria-labelledby="vifn"><h3 id="vifn">vi.fn</h3><ul><li><strong>Type:</strong> <code>(fn?: Function) => Mock</code></ul><p>Creates a spy on a function, though can be initiated without one. Every time a function is invoked, it stores its call arguments, returns, and instances. Also, you can manipulate its behavior with <a href="/api/mock">methods</a>. If no function is given, mock will return <code>undefined</code>, when invoked.<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> getApples <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturnedWith</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

getApples<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveNthReturnedWith</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viismockfunction"><h3 id="viismockfunction">vi.isMockFunction</h3><ul><li><strong>Type:</strong> <code>(fn: Function) => boolean</code></ul><p>Checks that a given parameter is a mock function. If you are using TypeScript, it will also narrow down its type.</section><section class="level3"aria-labelledby="viclearallmocks"><h3 id="viclearallmocks">vi.clearAllMocks</h3><p>Will call <a href="/api/mock#mockclear"><code>.mockClear()</code></a> on all spies. This will clear mock history, but not reset its implementation to the default one.</section><section class="level3"aria-labelledby="viresetallmocks"><h3 id="viresetallmocks">vi.resetAllMocks</h3><p>Will call <a href="/api/mock#mockreset"><code>.mockReset()</code></a> on all spies. This will clear mock history and reset its implementation to an empty function (will return <code>undefined</code>).</section><section class="level3"aria-labelledby="virestoreallmocks"><h3 id="virestoreallmocks">vi.restoreAllMocks</h3><p>Will call <a href="/api/mock#mockrestore"><code>.mockRestore()</code></a> on all spies. This will clear mock history and reset its implementation to the original one.</section><section class="level3"aria-labelledby="vispyon"><h3 id="vispyon">vi.spyOn</h3><ul><li><strong>Type:</strong> <code>&#x3C;T, K extends keyof T>(object: T, method: K, accessType?: 'get' | 'set') => MockInstance</code></ul><p>Creates a spy on a method or getter/setter of an object similar to <a href="#vi-fn"><code>vi.fn()</code></a>. It returns a <a href="/api/mock">mock function</a>.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> apples <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> cart <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">42</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> apples<span class="token punctuation">)</span>
apples <span class="token operator">=</span> <span class="token number">1</span>

<span class="token function">expect</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturnedWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><blockquote>You can call [`vi.restoreAllMocks`](#vi-restoreallmocks) inside [`afterEach`](../api.html#aftereach) (or enable [`test.restoreMocks`](../config.html#restoreMocks)) to restore all methods to their original implementations. This will restore the original [object descriptor](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty), so you won't be able to change method's implementation:<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> cart <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">42</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 10</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">restoreAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 42</span>
spy<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// still 42!</span></code></pre></blockquote><blockquote>It is not possible to spy on exported methonds in [Browser Mode](/guide/browser/). Instead, you can spy on every exported method by calling `vi.mock("./file-path.js", { spy: true })`. This will mock every export but keep its implementation intact, allowing you to assert if the method was called correctly.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> calculator <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./src/calculator.ts'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./src/calculator.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> spy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">calculator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturned</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><p>And while it is possible to spy on exports in <code>jsdom</code> or other Node.js environments, this might change in the future.</blockquote></section><section class="level3"aria-labelledby="vi-stubenv"><h3 id="vi-stubenv">vi.stubEnv</h3><ul><li><strong>Type:</strong> <code>&#x3C;T extends string>(name: T, value: T extends "PROD" | "DEV" | "SSR" ? boolean : string | undefined) => Vitest</code></ul><p>Changes the value of environmental variable on <code>process.env</code> and <code>import.meta.env</code>. You can restore its value by calling <code>vi.unstubAllEnvs</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `process.env.NODE_ENV` and `import.meta.env.NODE_ENV`</span>
<span class="token comment">// are "development" before calling "vi.stubEnv"</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token keyword nil">undefined</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>

<span class="token comment">// doesn't change other envs</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'development'</span></code></pre><blockquote>You can also change the value by simply assigning it, but you won't be able to use `vi.unstubAllEnvs` to restore previous value:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">=</span> <span class="token string">'test'</span></code></pre></blockquote></section><section class="level3"aria-labelledby="vi-unstuballenvs"><h3 id="vi-unstuballenvs">vi.unstubAllEnvs</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>Restores all <code>import.meta.env</code> and <code>process.env</code> values that were changed with <code>vi.stubEnv</code>. When it's called for the first time, Vitest remembers the original value and will store it, until <code>unstubAllEnvs</code> is called again.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `process.env.NODE_ENV` and `import.meta.env.NODE_ENV`</span>
<span class="token comment">// are "development" before calling stubEnv</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'staging'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'staging'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'staging'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">unstubAllEnvs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// restores to the value that were stored before the first "stubEnv" call</span>
process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span></code></pre></section><section class="level3"aria-labelledby="vistubglobal"><h3 id="vistubglobal">vi.stubGlobal</h3><ul><li><strong>Type:</strong> <code>(name: string | number | symbol, value: unknown) => Vitest</code></ul><p>Changes the value of global variable. You can restore its original value by calling <code>vi.unstubAllGlobals</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `innerWidth` is "0" before calling stubGlobal</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'innerWidth'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

innerWidth <span class="token operator">===</span> <span class="token number">100</span>
globalThis<span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">===</span> <span class="token number">100</span></code></pre><blockquote>You can also change the value by simply assigning it to `globalThis` or `window` (if you are using `jsdom` or `happy-dom` environment), but you won't be able to use `vi.unstubAllGlobals` to restore original value:<pre class="language-ts"><code class="language-ts">globalThis<span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">=</span> <span class="token number">100</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">=</span> <span class="token number">100</span></code></pre></blockquote></section><section class="level3"aria-labelledby="vi-unstuballglobals"><h3 id="vi-unstuballglobals">vi.unstubAllGlobals</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>Restores all global values on <code>globalThis</code>/<code>global</code> (and <code>window</code>/<code>top</code>/<code>self</code>/<code>parent</code>, if you are using <code>jsdom</code> or <code>happy-dom</code> environment) that were changed with <code>vi.stubGlobal</code>. When it's called for the first time, Vitest remembers the original value and will store it, until <code>unstubAllGlobals</code> is called again.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Mock</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// IntersectionObserver is "undefined" before calling "stubGlobal"</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'IntersectionObserver'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Mock</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
global<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
globalThis<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">unstubAllGlobals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

globalThis<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>
<span class="token string">'IntersectionObserver'</span> <span class="token keyword">in</span> globalThis <span class="token operator">===</span> <span class="token boolean">false</span>
<span class="token comment">// throws ReferenceError, because it's not defined</span>
<span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span></code></pre></section></section><section class="level2"aria-labelledby="fake-timers"><h2 id="fake-timers">Fake Timers</h2><p>This sections descibes how to work with <a href="/guide/mocking#timers">fake timers</a>.<section class="level3"aria-labelledby="viadvancetimersbytime"><h3 id="viadvancetimersbytime">vi.advanceTimersByTime</h3><ul><li><strong>Type:</strong> <code>(ms: number) => Vitest</code></ul><p>This method will invoke every initiated timer until the specified number of milliseconds is passed or the queue is empty - whatever comes first.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span>
<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimersbytimeasync"><h3 id="viadvancetimersbytimeasync">vi.advanceTimersByTimeAsync</h3><ul><li><strong>Type:</strong> <code>(ms: number) => Promise&#x3C;Vitest></code></ul><p>This method will invoke every initiated timer until the specified number of milliseconds is passed or the queue is empty - whatever comes first. This will include asynchronously set timers.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTimeAsync</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span>
<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimerstonexttimer"><h3 id="viadvancetimerstonexttimer">vi.advanceTimersToNextTimer</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>Will call next available timer. Useful to make assertions between each timer call. You can chain call it to manage timers by yourself.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 1</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 2</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimerstonexttimerasync"><h3 id="viadvancetimerstonexttimerasync">vi.advanceTimersToNextTimerAsync</h3><ul><li><strong>Type:</strong> <code>() => Promise&#x3C;Vitest></code></ul><p>Will call next available timer and wait until it's resolved if it was set asynchronously. Useful to make assertions between each timer call.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 1</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 2</span>
<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimerstonextframe-210-vi-advancetimerstonextframe"><h3 id="viadvancetimerstonextframe-210-vi-advancetimerstonextframe">vi.advanceTimersToNextFrame<version>2.1.0</version>{#vi-advancetimerstonextframe}</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>Similar to <a href="https://vitest.dev/api/vi#vi-advancetimersbytime"><code>vi.advanceTimersByTime</code></a>, but will advance timers by the milliseconds needed to execute callbacks currently scheduled with <code>requestAnimationFrame</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> frameRendered <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  frameRendered <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>frameRendered<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="vigettimercount"><h3 id="vigettimercount">vi.getTimerCount</h3><ul><li><strong>Type:</strong> <code>() => number</code></ul><p>Get the number of waiting timers.</section><section class="level3"aria-labelledby="viclearalltimers"><h3 id="viclearalltimers">vi.clearAllTimers</h3><p>Removes all timers that are scheduled to run. These timers will never run in the future.</section><section class="level3"aria-labelledby="vigetmockedsystemtime"><h3 id="vigetmockedsystemtime">vi.getMockedSystemTime</h3><ul><li><strong>Type</strong>: <code>() => Date | null</code></ul><p>Returns mocked current date that was set using <code>setSystemTime</code>. If date is not mocked the method will return <code>null</code>.</section><section class="level3"aria-labelledby="vigetrealsystemtime"><h3 id="vigetrealsystemtime">vi.getRealSystemTime</h3><ul><li><strong>Type</strong>: <code>() => number</code></ul><p>When using <code>vi.useFakeTimers</code>, <code>Date.now</code> calls are mocked. If you need to get real time in milliseconds, you can call this function.</section><section class="level3"aria-labelledby="virunallticks"><h3 id="virunallticks">vi.runAllTicks</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>Calls every microtask that was queued by <code>process.nextTick</code>. This will also run all microtasks scheduled by themselves.</section><section class="level3"aria-labelledby="virunalltimers"><h3 id="virunalltimers">vi.runAllTimers</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>This method will invoke every initiated timer until the timer queue is empty. It means that every timer called during <code>runAllTimers</code> will be fired. If you have an infinite interval, it will throw after 10 000 tries (can be configured with <a href="../config.html#faketimers-looplimit"><code>fakeTimers.loopLimit</code></a>).<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span>
<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="virunalltimersasync"><h3 id="virunalltimersasync">vi.runAllTimersAsync</h3><ul><li><strong>Type:</strong> <code>() => Promise&#x3C;Vitest></code></ul><p>This method will asynchronously invoke every initiated timer until the timer queue is empty. It means that every timer called during <code>runAllTimersAsync</code> will be fired even asynchronous timers. If you have an infinite interval, it will throw after 10 000 tries (can be configured with <a href="../config.html#faketimers-looplimit"><code>fakeTimers.loopLimit</code></a>).<pre class="language-ts"><code class="language-ts"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimersAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: result</span></code></pre></section><section class="level3"aria-labelledby="virunonlypendingtimers"><h3 id="virunonlypendingtimers">vi.runOnlyPendingTimers</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>This method will call every timer that was initiated after <a href="#vi-usefaketimers"><code>vi.useFakeTimers</code></a> call. It will not fire any timer that was initiated during its call.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span></code></pre></section><section class="level3"aria-labelledby="virunonlypendingtimersasync"><h3 id="virunonlypendingtimersasync">vi.runOnlyPendingTimersAsync</h3><ul><li><strong>Type:</strong> <code>() => Promise&#x3C;Vitest></code></ul><p>This method will asynchronously call every timer that was initiated after <a href="#vi-usefaketimers"><code>vi.useFakeTimers</code></a> call, even asynchronous ones. It will not fire any timer that was initiated during its call.<pre class="language-ts"><code class="language-ts"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">runOnlyPendingTimersAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span>
<span class="token comment">// log: 3</span>
<span class="token comment">// log: 1</span></code></pre></section><section class="level3"aria-labelledby="visetsystemtime"><h3 id="visetsystemtime">vi.setSystemTime</h3><ul><li><strong>Type</strong>: <code>(date: string | number | Date) => void</code></ul><p>If fake timers are enabled, this method simulates a user changing the system clock (will affect date related API like <code>hrtime</code>, <code>performance.now</code> or <code>new Date()</code>) - however, it will not fire any timers. If fake timers are not enabled, this method will only mock <code>Date.*</code> calls.<p>Useful if you need to test anything that depends on the current date - for example <a href="https://github.com/moment/luxon/">Luxon</a> calls inside your code.<p>Accepts the same string and number arguments as the <code>Date</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">1998</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viusefaketimers"><h3 id="viusefaketimers">vi.useFakeTimers</h3><ul><li><strong>Type:</strong> <code>(config?: FakeTimerInstallOpts) => Vitest</code></ul><p>To enable mocking timers, you need to call this method. It will wrap all further calls to timers (such as <code>setTimeout</code>, <code>setInterval</code>, <code>clearTimeout</code>, <code>clearInterval</code>, <code>setImmediate</code>, <code>clearImmediate</code>, and <code>Date</code>) until <a href="#vi-userealtimers"><code>vi.useRealTimers()</code></a> is called.<p>Mocking <code>nextTick</code> is not supported when running Vitest inside <code>node:child_process</code> by using <code>--pool=forks</code>. NodeJS uses <code>process.nextTick</code> internally in <code>node:child_process</code> and hangs when it is mocked. Mocking <code>nextTick</code> is supported when running Vitest with <code>--pool=threads</code>.<p>The implementation is based internally on <a href="https://github.com/sinonjs/fake-timers"><code>@sinonjs/fake-timers</code></a>.<blockquote>`vi.useFakeTimers()` does not automatically mock `process.nextTick`. But you can enable it by specifying the option in `toFake` argument: `vi.useFakeTimers({ toFake: ['nextTick'] })`.</blockquote></section><section class="level3"aria-labelledby="vi-isfaketimers"><h3 id="vi-isfaketimers">vi.isFakeTimers</h3><ul><li><strong>Type:</strong> <code>() => boolean</code></ul><p>Returns <code>true</code> if fake timers are enabled.</section><section class="level3"aria-labelledby="viuserealtimers"><h3 id="viuserealtimers">vi.useRealTimers</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>When timers are run out, you may call this method to return mocked timers to its original implementations. All timers that were scheduled before will be discarded.</section></section><section class="level2"aria-labelledby="miscellaneous"><h2 id="miscellaneous">Miscellaneous</h2><p>A set of useful helper functions that Vitest provides.<section class="level3"aria-labelledby="vi-waitfor"><h3 id="vi-waitfor">vi.waitFor</h3><ul><li><strong>Type:</strong> <code>&#x3C;T>(callback: WaitForCallback&#x3C;T>, options?: number | WaitForOptions) => Promise&#x3C;T></code></ul><p>Wait for the callback to execute successfully. If the callback throws an error or returns a rejected promise it will continue to wait until it succeeds or times out.<p>This is very useful when you need to wait for some asynchronous action to complete, for example, when you start a server and need to wait for it to start.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createServer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./server.js'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Server started successfully'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">waitFor</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span><span class="token property-access">isReady</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Server not started'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Server started'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      timeout<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// default is 1000</span>
      interval<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// default is 50</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token property-access">isReady</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>It also works for asynchronous callbacks<pre class="language-ts"><code class="language-ts"><span class="token comment">// @vitest-environment jsdom</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getDOMElementAsync<span class="token punctuation">,</span> populateDOMAsync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./dom.js'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Element exists in a DOM'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// start populating DOM</span>
  <span class="token function">populateDOMAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">waitFor</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// try to get the element until it exists</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">getDOMElementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">HTMLElement</span> <span class="token operator">|</span> <span class="token keyword null nil">null</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token property-access">dataset</span><span class="token punctuation">.</span><span class="token property-access">initialized</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span> element
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timeout<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// default is 1000</span>
    interval<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// default is 50</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeInstanceOf</span><span class="token punctuation">(</span><span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>If <code>vi.useFakeTimers</code> is used, <code>vi.waitFor</code> automatically calls <code>vi.advanceTimersByTime(interval)</code> in every check callback.</section><section class="level3"aria-labelledby="vi-waituntil"><h3 id="vi-waituntil">vi.waitUntil</h3><ul><li><strong>Type:</strong> <code>&#x3C;T>(callback: WaitUntilCallback&#x3C;T>, options?: number | WaitUntilOptions) => Promise&#x3C;T></code></ul><p>This is similar to <code>vi.waitFor</code>, but if the callback throws any errors, execution is immediately interrupted and an error message is received. If the callback returns falsy value, the next check will continue until truthy value is returned. This is useful when you need to wait for something to exist before taking the next step.<p>Look at the example below. We can use <code>vi.waitUntil</code> to wait for the element to appear on the page, and then we can do something with the element.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Element render correctly'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">waitUntil</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">'.element'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      timeout<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// default is 1000</span>
      interval<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// default is 50</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token comment">// do something with the element</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">'.element-child'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="vi-hoisted"><h3 id="vi-hoisted">vi.hoisted</h3><ul><li><strong>Type</strong>: <code>&#x3C;T>(factory: () => T) => T</code></ul><p>All static <code>import</code> statements in ES modules are hoisted to the top of the file, so any code that is defined before the imports will actually be executed after imports are evaluated.<p>However, it can be useful to invoke some side effects like mocking dates before importing a module.<p>To bypass this limitation, you can rewrite static imports into dynamic ones like this:<pre class="language-diff"><code class="language-diff">callFunctionWithSideEffect()
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> import { value } from './some/module.js'
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const { value } = await import('./some/module.js')</span></span></code></pre><p>When running <code>vitest</code>, you can do this automatically by using <code>vi.hoisted</code> method.<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> callFunctionWithSideEffect()
</span></span>import { value } from './some/module.js'
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> vi.hoisted(() => callFunctionWithSideEffect())</span></span></code></pre><p>This method returns the value that was returned from the factory. You can use that value in your <code>vi.mock</code> factories if you need easy access to locally defined variables:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> originalMethod <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./path/to/module.js'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> mockedMethod <span class="token punctuation">}</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> mockedMethod<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> originalMethod<span class="token operator">:</span> mockedMethod <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

mockedMethod<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">originalMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></code></pre><p>Note that this method can also be called asynchronously even if your environment doesn't support top-level await:<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> promised <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/posts'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> response<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="visetconfig"><h3 id="visetconfig">vi.setConfig</h3><ul><li><strong>Type</strong>: <code>RuntimeConfig</code></ul><p>Updates config for the current test file. This method supports only config options that will affect the current test file:<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">setConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  allowOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  testTimeout<span class="token operator">:</span> <span class="token number">10_000</span><span class="token punctuation">,</span>
  hookTimeout<span class="token operator">:</span> <span class="token number">10_000</span><span class="token punctuation">,</span>
  clearMocks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  restoreMocks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  fakeTimers<span class="token operator">:</span> <span class="token punctuation">{</span>
    now<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// supports the whole object</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  maxConcurrency<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  sequence<span class="token operator">:</span> <span class="token punctuation">{</span>
    hooks<span class="token operator">:</span> <span class="token string">'stack'</span>
    <span class="token comment">// supports only "sequence.hooks"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viresetconfig"><h3 id="viresetconfig">vi.resetConfig</h3><ul><li><strong>Type</strong>: <code>RuntimeConfig</code></ul><p>If <a href="#vi-setconfig"><code>vi.setConfig</code></a> was called before, this will reset config to the original state. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>