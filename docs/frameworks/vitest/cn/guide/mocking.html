<!doctype html><html lang="cn"><meta charset="utf-8"><title>Mocking | Guide</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="模拟对象"class="level1"><h1>模拟对象</h1><p>在编写测试时，你可能会因为时间问题，需要创建内部或外部服务的 “假” 版本，这通常被称为 <strong>对象模拟</strong> 操作。Vitest 通过 <strong>vi</strong> 提供了一些实用的函数用于解决这个问题。你可以使用 <code>import { vi } from 'vitest'</code> 或者 <strong>全局配置</strong> 进行访问它 (当 <strong>启用</strong> <a href="../config.html#globals">全局配置</a> 时)。<blockquote>不要忘记在每次测试运行前后清除或恢复模拟对象，以撤消运行测试时模拟对象状态的更改！有关更多信息，请参阅 [`mockReset`](../api.html#mockreset) 文档。</blockquote><p>如果你想从头开始，请查看 <a href="../api.html#vi">API 部分</a> 的 vi 部分，或者继续跟着文档深入了解一下这个对象模拟的世界。<section id="日期"class="level2"><h2>日期</h2><p>有些时候，你可能需要控制日期来确保测试时的一致性。Vitest 使用了 <a href="https://github.com/sinonjs/fake-timers"><code>@sinonjs/fake-timers</code></a> 库来操作计时器以及系统日期。可以在 <a href="../api.html#vi-setsystemtime">此处</a> 找到有关特定 API 的更多详细信息。<section id="示例"class="level3"><h3>示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> businessHours <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">purchase</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentHour <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>open<span class="token punctuation">,</span> close<span class="token punctuation">]</span> <span class="token operator">=</span> businessHours<span class="token punctuation">;</span>

  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">></span> open <span class="token operator">&#x26;&#x26;</span> currentHour <span class="token operator">&#x3C;</span> close<span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Success"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Error"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"purchasing flow"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 告诉 vitest 我们使用模拟时间</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 每次测试运行后恢复日期</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"allows purchases within business hours"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 在工作时间内设置时间</span>
    <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 访问 Date.now() 将生成上面设置的日期</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">purchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Success"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"disallows purchases outside of business hours"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 在工作时间之外设置时间</span>
    <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 访问 Date.now() 将生成上面设置的日期</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">purchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Error"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section></section><section id="函数"class="level2"><h2>函数</h2><p>函数的模拟可以分为两个不同的类别：<em>对象监听(spying) &#x26; 对象模拟</em>。<p>有时你可能只需要验证是否调用了特定函数（以及可能传递了哪些参数）。在这种情况下，我们就需要使用一个对象监听，可以直接使用 <code>vi.spyOn()</code> (<a href="../api.html#vi-spyon">在此处阅读更多信息</a>)。<p>然而，对象监听只能帮助你 <strong>监听</strong> 函数，他们无法改变这些函数的实现。如果我们需要创建一个函数的假（或模拟）版本，可以使用它 <code>vi.fn()</code> (<a href="../api.html#vi-fn">在此处阅读更多信息</a>)。<p>我们使用 <a href="https://github.com/tinylibs/tinyspy">Tinyspy</a> 作为模拟函数的基础，同时也有一套自己的封装来使其与 <code>Jest</code> 兼容。<code>vi.fn()</code> 和 <code>vi.spyOn()</code> 共享相同的方法，但是只有 <code>vi.fn()</code> 的返回结果是可调用的。<section id="示例-1"class="level3"><h3>示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">getLatest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">index <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Simple test message"</span><span class="token punctuation">,</span> <span class="token keyword module">from</span><span class="token operator">:</span> <span class="token string">"Testman"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  getLatest<span class="token punctuation">,</span> <span class="token comment">// 也可以是一个 `getter 或 setter 如果支持`</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"reading messages"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">restoreAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should get the latest message with a spy"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> <span class="token string">"getLatest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">.</span><span class="token method function property-access">getMockName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">"getLatest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token method function property-access">getLatest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    spy<span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">"access-restricted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token method function property-access">getLatest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">"access-restricted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should get with a mock"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span>getLatest<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mock<span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">"access-restricted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">"access-restricted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="了解更多"class="level3"><h3>了解更多</h3><ul><li><a href="https://jestjs.io/docs/mock-function-api">Jest's Mock Functions</a></ul></section></section><section id="全局globals"class="level2"><h2>全局(Globals)</h2><p>你可以通过使用 <a href="../api.html#vi-stubglobal"><code>vi.stubGlobal</code></a> 来模拟 <code>jsdom</code> 或 <code>node</code> 中不存在的全局变量。它将把全局变量的值放入 <code>globalThis</code> 对象。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">IntersectionObserverMock</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  disconnect<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  observe<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  takeRecords<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  unobserve<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">"IntersectionObserver"</span><span class="token punctuation">,</span> <span class="token maybe-class-name">IntersectionObserverMock</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 现在你可以通过 `IntersectionObserver` 或 `window.IntersectionObserver` 访问</span></code></pre></section><section id="模块"class="level2"><h2>模块</h2><p>模拟模块监听在其他代码中调用的第三方库，允许你测试参数、输出甚至重新声明其实现。<p>参见 <a href="../api.html#vi-mock"><code>vi.mock()</code> API 部分</a> 以获得更深入详细 API 描述。<section id="自动模拟算法automocking-algorithm"class="level3"><h3>自动模拟算法(Automocking algorithm)</h3><p>如果你的代码导入了模拟模块，并且没有任何与此模块相关联的 <code>__mocks__</code> 文件或 <code>factory</code>，Vitest 将通过调用模块并模拟每个导出来的模拟模块本身。<p>以下原则适用<ul><li>所有的数组将被清空<li>所有的基础类型和集合将保持不变<li>所有的对象都将被深度克隆<li>类的所有实例及其原型都将被深度克隆</ul></section><section id="示例-2"class="level3"><h3>示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Client</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"pg"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> failure<span class="token punctuation">,</span> success <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./handlers"</span><span class="token punctuation">;</span>

<span class="token comment">// handlers</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// get todos</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getTodos</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// ...clientOptions</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> client<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> client<span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM todos;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    client<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span><span class="token property-access">rowCount</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> item(s) returned</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token property-access">rows</span><span class="token punctuation">,</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">stack</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    client<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> e<span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"pg"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token maybe-class-name">Client</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">connect</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">query</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">end</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Client</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"./handlers"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">success</span><span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">failure</span><span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"get a list of todo items"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> client<span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">clearAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should return items successfully"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">rows</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">rowCount</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">await</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">connect</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM todos;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">end</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"0 item(s) returned"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should throw an error"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Unable to retrieve rows"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">.</span><span class="token method function property-access">mockRejectedValueOnce</span><span class="token punctuation">(</span>mError<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">await</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">connect</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM todos;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">end</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> mError<span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section></section><section id="请求"class="level2"><h2>请求</h2><p>因为 Vitest 运行在 Node 环境中，所以模拟网络请求是一件非常棘手的事情；由于没有办法使用 Web API，因此我们需要一些可以为我们模拟网络行为的包。推荐使用 <a href="https://mswjs.io/">Mock Service Worker</a> 来进行这个操作。它可以模拟 <code>REST</code> 和 <code>GraphQL</code> 网络请求，并且与框架无关。<p>Mock Service Worker (MSW) 通过拦截测试发出的请求进行工作，允许你在不更改任何应用程序代码的情况下使用它。在浏览器中，它使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Worker API</a>。在 Node 中，对于 Vitest，它使用 <a href="https://mswjs.io/docs/api/setup-server#operation">node-request-interceptor</a>。了解有关 MSW 的更多信息，可以去阅读他们的 <a href="https://mswjs.io/docs/">introduction</a>。<section id="配置"class="level3"><h3>配置</h3><p>如下，你可以在你的 <a href="../config.html#setupfiles">配置文件</a> 中使用。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterAll<span class="token punctuation">,</span> afterEach<span class="token punctuation">,</span> beforeAll <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> setupServer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"msw/node"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> graphql<span class="token punctuation">,</span> rest <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"msw"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">"first post title"</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">"first post body"</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> restHandlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  rest<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">"https://rest-endpoint.example/path/to/posts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">res</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> graphqlHandlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  graphql<span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span>
    <span class="token string">"https://graphql-endpoint.example/api/v1/posts"</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token function">res</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token method function property-access">data</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">setupServer</span><span class="token punctuation">(</span><span class="token spread operator">...</span>restHandlers<span class="token punctuation">,</span> <span class="token spread operator">...</span>graphqlHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在所有测试之前启动服务器</span>
<span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> server<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">onUnhandledRequest</span><span class="token operator">:</span> <span class="token string">"error"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 所有测试后关闭服务器</span>
<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> server<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 每次测试后重置处理程序 `对测试隔离很重要`</span>
<span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> server<span class="token punctuation">.</span><span class="token method function property-access">resetHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>使用 <code>onUnhandleRequest: 'error'</code> 配置服务器可以确保每当有没有相应请求处理程序的请求时都会引发错误。</blockquote></section><section id="示例-3"class="level3"><h3>示例</h3><p>我们有一个使用 MSW 的完整工作示例：<a href="https://github.com/vitest-dev/vitest/tree/main/examples/react-testing-lib-msw">React Testing with MSW</a>。</section><section id="了解更多-1"class="level3"><h3>了解更多</h3><p>MSW 能做的还有很多。你可以访问 cookie 和查询参数、定义模拟错误响应等等！要查看您可以使用 MSW 做什么，请阅读 <a href="https://mswjs.io/docs/recipes">their documentation</a>.</section></section><section id="计时器"class="level2"><h2>计时器</h2><p>每当我们的测试代码涉及到 <code>超时</code> 或者间隔时，并不是让我们的测试程序进行等待或者超时。我们也可以通过模拟对 <code>setTimeout</code> 和 <code>setInterval</code> 的调用来使用 “假” 计时器来加速测试。<p>有关更深入的详细 API 描述，参阅 <a href="../api.html#vi-usefaketimers"><code>vi.usefaketimers</code> api 部分</a>。<section id="示例-4"class="level3"><h3>示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">executeAfterTwoHours</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2 hours</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">executeEveryMinute</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1 minute</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> mock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">"executed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">"delayed execution"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">restoreAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should execute the function"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">executeAfterTwoHours</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should not execute the function"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">executeAfterTwoHours</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// advancing by 2ms won't trigger the func</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">not</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"should execute every minute"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">executeEveryMinute</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section></section><section id="备忘单"class="level2"><h2>备忘单</h2>info 下列示例中的 `vi` 是直接从 `vitest` 导入的。如果在你的 [config](/config/) 中将 `globals` 设置为 `true`，则可以全局使用它。<p>我想…<ul><li>监听一个 <code>method</code></ul><pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">SomeClass</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> <span class="token string">"method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>监听模块导出 function</ul><pre class="language-ts"><code class="language-ts"><span class="token comment">// some-path.ts</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token string">"variable"</span><span class="token punctuation">;</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// some-path.test.ts</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"getter"</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">"mocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>监听模块导出 setter/getter</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"getter"</span><span class="token punctuation">,</span> <span class="token string">"get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"setter"</span><span class="token punctuation">,</span> <span class="token string">"set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>模拟模块导出 function</ul><p><code>vi.mock</code> 的示例：<pre class="language-ts"><code class="language-ts"><span class="token comment">// ./some-path.ts</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> method <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"./some-path.ts"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"./some-path.ts"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  method<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote>不要忘记将 `vi.mock` 调用提升到文件顶部。 **不要**将 `vi.mock` 调用放在 `beforeEach` 中，只有其中一个会实际模拟模块。</blockquote><p><code>vi.spyOn</code> 的示例：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"method"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>模拟模块导出 class implementation</ul><p><code>vi.mock</code> and prototype 的示例:<pre class="language-ts"><code class="language-ts"><span class="token comment">// some-path.ts</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">SomeClass</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SomeClass</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"some-path"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token maybe-class-name">SomeClass</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token maybe-class-name">SomeClass</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">someMethod</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">SomeClass</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SomeClass.mock.instances will have SomeClass</span></code></pre><p><code>vi.mock</code> and return value 的示例:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SomeClass</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"some-path"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token maybe-class-name">SomeClass</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    someMethod<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">SomeClass</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// SomeClass.mock.returns will have returned object</span></code></pre><p><code>vi.spyOn</code> 的示例:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">"SomeClass"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// whatever suites you from first two examples</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>监听一个函数是否返回了一个对象</ul><p>使用 cache 的示例:<pre class="language-ts"><code class="language-ts"><span class="token comment">// some-path.ts</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token function-variable function">method</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// useObject.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useObject <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">useObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
obj<span class="token punctuation">.</span><span class="token method function property-access">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// useObject.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useObject <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"some-path"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _cache<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">useObject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _cache <span class="token operator">=</span> <span class="token punctuation">{</span>
        method<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// now everytime useObject() is called it will</span>
    <span class="token comment">// return the same object reference</span>
    <span class="token keyword control-flow">return</span> _cache<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> useObject <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">useObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// obj.method was called inside some-path</span>
<span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>模拟部分 module</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> mocked<span class="token punctuation">,</span> original <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"some-path"</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">"some-path"</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">importActual</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">"some-path"</span><span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">"some-path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>mod<span class="token punctuation">,</span>
    mocked<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">original</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// has original behaviour</span>
<span class="token function">mocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// is a spy function</span></code></pre><ul><li>模拟当前日期</ul><p>要模拟 <code>Date</code> 的时间，你可以使用 <code>vi.setSystemTime</code> 辅助函数。 该值将<strong>不会</strong>在不同的测试之间自动重置。<p>请注意，使用 <code>vi.useFakeTimers</code> 也会更改 <code>Date</code> 的时间。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mockDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>mockDate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>mockDate<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// reset mocked time</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>模拟全局变量</ul><p>你可以通过为 <code>globalThis</code> 赋值或使用 <a href="../api.html#vi-stubglobal"><code>vi.stubGlobal</code></a> 助手来设置全局变量。 使用 <code>vi.stubGlobal</code> 时，<strong>不会</strong>在不同的测试之间自动重置，除非你启用 <a href="../config.html#unstubglobals"><code>unstubGlobals</code></a> 配置选项或调用 <a href="../api.html#vi-unstuballglobals"><code>vi.unstubAllGlobals</code></a>。<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">"__VERSION__"</span><span class="token punctuation">,</span> <span class="token string">"1.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">expect</span><span class="token punctuation">(</span>__VERSION__<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">"1.0.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>模拟 <code>import.meta.env</code></ul><p>要更改环境变量，你只需为其分配一个新值即可。 该值将<strong>不会</strong>在不同的测试之间自动重置。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> beforeEach<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>

<span class="token comment">// you can reset it in beforeEach hook manually</span>
<span class="token keyword">const</span> originalViteEnv <span class="token operator">=</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">;</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span> <span class="token operator">=</span> originalViteEnv<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"changes value"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span> <span class="token operator">=</span> <span class="token string">"staging"</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">"staging"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>如果你想自动重置值，可以使用启用了 <a href="../config.html#unstubEnvs"><code>unstubEnvs</code></a> 配置选项的 <code>vi.stubEnv</code> 助手（或调用 <a href="../api.html#vi-unstuballenvs"><code>vi.unstubAllEnvs</code></a> 在 <code>beforeEach</code> 钩子中手动执行）：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"vitest"</span><span class="token punctuation">;</span>

<span class="token comment">// before running tests "VITE_ENV" is "test"</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span> <span class="token operator">===</span> <span class="token string">"test"</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"changes value"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">"VITE_ENV"</span><span class="token punctuation">,</span> <span class="token string">"staging"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">"staging"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">"the value is restored before running an other test"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// vitest.config.ts</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    unstubAllEnvs<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>