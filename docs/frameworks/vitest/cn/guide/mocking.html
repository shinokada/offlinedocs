<!doctype html><html lang="cn"><meta charset="utf-8"><title>模拟对象 | 指南</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="模拟对象"><h1 id="模拟对象">模拟对象</h1><p>在编写测试时，你可能会因为时间问题，需要创建内部或外部服务的 “假” 版本，这通常被称为 <strong>对象模拟</strong> 操作。Vitest 通过 <strong>vi</strong> 提供了一些实用的函数用于解决这个问题。你可以使用 <code>import { vi } from 'vitest'</code> 或者 <strong>全局配置</strong> 进行访问它 (当 <strong>启用</strong> <a href="../config.html#globals">全局配置</a> 时)。<blockquote>不要忘记在每次测试运行前后清除或恢复模拟对象，以撤消运行测试时模拟对象状态的更改！有关更多信息，请参阅 [`mockReset`](/api/mock.html#mockreset) 文档。</blockquote><p>如果你想从头开始，请查看 <a href="../api.html#vi">API 部分</a> 的 vi 部分，或者继续跟着文档深入了解一下这个对象模拟的世界。<section class="level2"aria-labelledby="日期"><h2 id="日期">日期</h2><p>有些时候，你可能需要控制日期来确保测试时的一致性。Vitest 使用了 <a href="https://github.com/sinonjs/fake-timers"><code>@sinonjs/fake-timers</code></a> 库来操作计时器以及系统日期。可以在 <a href="/api/vi#vi-setsystemtime">此处</a> 找到有关特定 API 的更多详细信息。<section class="level3"aria-labelledby="示例"><h3 id="示例">示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> businessHours <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">]</span>

<span class="token keyword">function</span> <span class="token function">purchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentHour <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>open<span class="token punctuation">,</span> close<span class="token punctuation">]</span> <span class="token operator">=</span> businessHours

  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>currentHour <span class="token operator">></span> open <span class="token operator">&#x26;&#x26;</span> currentHour <span class="token operator">&#x3C;</span> close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Success'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Error'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'purchasing flow'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 告诉 vitest 我们使用模拟时间</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 每次测试运行后恢复日期</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'allows purchases within business hours'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 将时间设置在工作时间之内</span>
    <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>

    <span class="token comment">// 访问 Date.now() 将生成上面设置的日期</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">purchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Success'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'disallows purchases outside of business hours'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// 将时间设置在工作时间之外</span>
    <span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>

    <span class="token comment">// 访问 Date.now() 将生成上面设置的日期</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">purchase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section></section><section class="level2"aria-labelledby="函数"><h2 id="函数">函数</h2><p>函数的模拟可以分为两个不同的类别：<em>对象监听(spying) &#x26; 对象模拟</em>。<p>有时你可能只需要验证是否调用了特定函数（以及可能传递了哪些参数）。在这种情况下，我们就需要使用一个对象监听，可以直接使用 <code>vi.spyOn()</code> (<a href="/api/vi#vi-spyon">在此处阅读更多信息</a>)。<p>然而，对象监听只能帮助你 <strong>监听</strong> 函数，他们无法改变这些函数的实现。如果我们需要创建一个函数的假（或模拟）版本，可以使用它 <code>vi.fn()</code> (<a href="/api/vi#vi-fn">在此处阅读更多信息</a>)。<p>我们使用 <a href="https://github.com/tinylibs/tinyspy">Tinyspy</a> 作为模拟函数的基础，同时也有一套自己的封装来使其与 <code>Jest</code> 兼容。<code>vi.fn()</code> 和 <code>vi.spyOn()</code> 共享相同的方法，但是只有 <code>vi.fn()</code> 的返回结果是可调用的。<section class="level3"aria-labelledby="示例-1"><h3 id="示例-1">示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Simple test message'</span><span class="token punctuation">,</span> <span class="token keyword module">from</span><span class="token operator">:</span> <span class="token string">'Testman'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  getLatest<span class="token punctuation">,</span> <span class="token comment">// 也可以是一个 `getter 或 setter 如果支持`</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getLatest</span><span class="token punctuation">(</span><span class="token parameter">index <span class="token operator">=</span> messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'reading messages'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">restoreAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should get the latest message with a spy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>messages<span class="token punctuation">,</span> <span class="token string">'getLatest'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">.</span><span class="token method function property-access">getMockName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">'getLatest'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token method function property-access">getLatest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span>
      messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    spy<span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'access-restricted'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token method function property-access">getLatest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">'access-restricted'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should get with a mock'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span>getLatest<span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    mock<span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'access-restricted'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token string">'access-restricted'</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">[</span>messages<span class="token punctuation">.</span><span class="token property-access">items</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="了解更多"><h3 id="了解更多">了解更多</h3><ul><li><a href="https://jestjs.io/docs/mock-function-api">Jest's Mock Functions</a></ul></section></section><section class="level2"aria-labelledby="全局globals"><h2 id="全局globals">全局(Globals)</h2><p>你可以通过使用 <a href="/api/vi#stubglobal"><code>vi.stubGlobal</code></a> 来模拟 <code>jsdom</code> 或 <code>node</code> 中不存在的全局变量。它将把全局变量的值放入 <code>globalThis</code> 对象。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">IntersectionObserverMock</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  disconnect<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  observe<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  takeRecords<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  unobserve<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'IntersectionObserver'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">IntersectionObserverMock</span><span class="token punctuation">)</span>

<span class="token comment">// 现在你可以通过 `IntersectionObserver` 或 `window.IntersectionObserver` 访问</span></code></pre></section><section class="level2"aria-labelledby="模块"><h2 id="模块">模块</h2><p>模拟模块监听在其他代码中调用的第三方库，允许你测试参数、输出甚至重新声明其实现。<section class="level3"aria-labelledby="自动模拟算法automocking-algorithm"><h3 id="自动模拟算法automocking-algorithm">自动模拟算法(Automocking algorithm)</h3><p>参见 <a href="/api/vi#vi-mock"><code>vi.mock()</code> API 部分</a> 以获得更深入详细 API 描述。<p>如果你的代码导入了模拟模块，并且没有任何与此模块相关联的 <code>__mocks__</code> 文件或 <code>factory</code>，Vitest 将通过调用模块并模拟每个导出来的模拟模块本身。<p>以下原则适用<ul><li>所有的数组将被清空<li>所有的基础类型和集合将保持不变<li>所有的对象都将被深度克隆<li>类的所有实例及其原型都将被深度克隆</ul></section><section class="level3"aria-labelledby="virtual-modules"><h3 id="virtual-modules">Virtual Modules</h3><p>Vitest 支持模拟 Vite <a href="https://cn.vitejs.dev/guide/api-plugin#virtual-modules-convention">虚拟模块</a>。它的工作方式与 Jest 中处理虚拟模块的方式不同。我们不需要将 <code>virtual: true</code> 传递给 <code>vi.mock</code> 函数，而是需要告诉 Vite 模块存在，否则它将在解析过程中失败。有几种方法可以做到这一点：<ol><li>提供别名</ol><pre class="language-ts"><code class="language-ts"><span class="token comment">// vitest.config.js</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'$app/forms'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'./mocks/forms.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><ol start="2"><li>提供解析虚拟模块的插件</ol><pre class="language-ts"><code class="language-ts"><span class="token comment">// vitest.config.js</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'virtual-modules'</span><span class="token punctuation">,</span>
      <span class="token function">resolveId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token string">'$app/forms'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">return</span> <span class="token string">'virtual:$app/forms'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><p>第二种方法的好处是可以动态创建不同的虚拟入口点。如果将多个虚拟模块重定向到一个文件中，那么所有这些模块都将受到 <code>vi.mock</code> 的影响，因此请确保使用唯一的标识符。</section><section class="level3"aria-labelledby="mocking-pitfalls"><h3 id="mocking-pitfalls">Mocking Pitfalls</h3><p>请注意，对在同一文件的其他方法中调用的方法的模拟调用是不可能的。例如，在此代码中：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token string">'foo'</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">foobar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">bar</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span></code></pre><p>不可能从外部模拟 <code>foo</code> 方法，因为它是直接引用的。因此，此代码对 <code>foobar</code> 内部的 <code>foo</code> 调用没有影响（但会影响其他模块中的 <code>foo</code> 调用）：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mod</span> <span class="token keyword module">from</span> <span class="token string">'./foobar.js'</span>

<span class="token comment">// 这只会影响在原始模块之外的 "foo"</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./foobar.js'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>importOriginal<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token generic-function"><span class="token function">importOriginal</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./foobar.js'</span><span class="token punctuation">)</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 这只会影响在原始模块之外的 "foo"</span>
    <span class="token function-variable function">foo</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'mocked'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>你可以通过直接向 <code>foobar</code> 方法提供实现来确认这种行为：<pre class="language-ts"><code class="language-ts"><span class="token comment">// foobar.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mod</span> <span class="token keyword module">from</span> <span class="token string">'./foobar.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">)</span>

<span class="token comment">// 导出的 foo  引用模拟的方法</span>
mod<span class="token punctuation">.</span><span class="token method function property-access">foobar</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token property-access">foo</span><span class="token punctuation">)</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// foobar.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token string">'foo'</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">foobar</span><span class="token punctuation">(</span>injectedFoo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> injectedFoo <span class="token operator">===</span> foo <span class="token comment">// false</span>
<span class="token punctuation">}</span></code></pre><p>这就是预期行为。当以这种方式包含 mock 时，这通常是不良代码的标志。考虑将代码重构为多个文件，或者使用<a href="https://en.wikipedia.org/wiki/dependency_injection">依赖项注入</a>等技术来改进应用体系结构。</section><section class="level3"aria-labelledby="示例-2"><h3 id="示例-2">示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Client</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'pg'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> failure<span class="token punctuation">,</span> success <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./handlers.js'</span>

<span class="token comment">// get todos</span>
<span class="token keyword module">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// ...clientOptions</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">await</span> client<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> client<span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM todos;'</span><span class="token punctuation">)</span>

    client<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword control-flow">return</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span><span class="token property-access">rowCount</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> item(s) returned</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token property-access">rows</span><span class="token punctuation">,</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token property-access">stack</span><span class="token punctuation">)</span>

    client<span class="token punctuation">.</span><span class="token method function property-access">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword control-flow">return</span> <span class="token function">failure</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> e<span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token maybe-class-name">Client</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">connect</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">query</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token class-name">Client</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">end</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Client</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./handlers.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">success</span><span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">failure</span><span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'get a list of todo items'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> client

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">clearAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return items successfully'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">rows</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">rowCount</span><span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword control-flow">await</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">connect</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM todos;'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">end</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'0 item(s) returned'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should throw an error'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> mError <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Unable to retrieve rows'</span><span class="token punctuation">)</span>
    client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">.</span><span class="token method function property-access">mockRejectedValueOnce</span><span class="token punctuation">(</span>mError<span class="token punctuation">)</span>

    <span class="token keyword control-flow">await</span> <span class="token function">getTodos</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">connect</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">query</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM todos;'</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token property-access">end</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeCalledWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">message</span><span class="token operator">:</span> mError<span class="token punctuation">,</span> <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section></section><section class="level2"aria-labelledby="文件系统"><h2 id="文件系统">文件系统</h2><p>文件系统模拟文件系统可确保测试不依赖于实际文件系统，从而使测试更可靠、更可预测。这种隔离有助于避免先前测试的副作用。它允许测试可能难以或无法用实际文件系统复制的错误条件和边缘情况，如权限问题、磁盘满的情况或读/写错误。<p>Vitest 并不提供任何文件系统模拟 API。您可以使用 <code>vi.mock</code> 手动模拟 <code>fs</code> 模块，但这很难维护。相反，我们建议使用 <a href="https://www.npmjs.com/package/memfs"><code>memfs</code></a> 来为你做这件事。<code>memfs</code> 创建了一个内存文件系统，可以在不接触实际磁盘的情况下模拟文件系统操作。这种方法既快速又安全，可以避免对真实文件系统产生任何潜在的副作用。<section class="level3"aria-labelledby="例子"><h3 id="例子">例子</h3><p>要自动将每个 <code>fs</code> 调用重定向到 <code>memfs</code>，可以在项目根目录下创建 <code>__mocks__/fs.cjs</code> 和 <code>__mocks__/fs/promises.cjs</code> 文件：</section></section>code-group ```ts [__mocks__/fs.cjs] // we can also use `import`, but then // every export should be explicitly defined<p>const { fs } = require('memfs') module.exports = fs<pre class="language-text"><code class="language-text">
```ts [__mocks__/fs/promises.cjs]
// we can also use `import`, but then
// every export should be explicitly defined

const { fs } = require('memfs')
module.exports = fs.promises</code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// read-hello-world.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> readFileSync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'node:fs'</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">readHelloWorld</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// hello-world.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> beforeEach<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> fs<span class="token punctuation">,</span> vol <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'memfs'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> readHelloWorld <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./read-hello-world.js'</span>

<span class="token comment">// tell vitest to use fs mock from __mocks__ folder</span>
<span class="token comment">// this can be done in a setup file if fs should always be mocked</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'node:fs'</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'node:fs/promises'</span><span class="token punctuation">)</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// reset the state of in-memory fs</span>
  vol<span class="token punctuation">.</span><span class="token method function property-access">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return correct text'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token string">'/hello-world.txt'</span>
  fs<span class="token punctuation">.</span><span class="token method function property-access">writeFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">readHelloWorld</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'can return a value multiple times'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// you can use vol.fromJSON to define several files</span>
  vol<span class="token punctuation">.</span><span class="token method function property-access">fromJSON</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">'./dir1/hw.txt'</span><span class="token operator">:</span> <span class="token string">'hello dir1'</span><span class="token punctuation">,</span>
      <span class="token string-property property">'./dir2/hw.txt'</span><span class="token operator">:</span> <span class="token string">'hello dir2'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// default cwd</span>
    <span class="token string">'/tmp'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">readHelloWorld</span><span class="token punctuation">(</span><span class="token string">'/tmp/dir1/hw.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'hello dir1'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">readHelloWorld</span><span class="token punctuation">(</span><span class="token string">'/tmp/dir2/hw.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'hello dir2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><section class="level2"aria-labelledby="请求"><h2 id="请求">请求</h2><p>因为 Vitest 运行在 Node 环境中，所以模拟网络请求是一件非常棘手的事情；由于没有办法使用 Web API，因此我们需要一些可以为我们模拟网络行为的包。推荐使用 <a href="https://mswjs.io/">Mock Service Worker</a> 来进行这个操作。它可以模拟 <code>REST</code> 和 <code>GraphQL</code> 网络请求，并且与框架无关。<p>Mock Service Worker (MSW) 的工作原理是拦截测试请求，让我们可以在不更改任何应用代码的情况下使用它。在浏览器中，它使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">Service Worker API</a> 。在 Node.js 和 Vitest 中，它使用 <a href="https://github.com/mswjs/interceptors"><code>@mswjs/interceptors</code></a> 库。要了解有关 MSW 的更多信息，请阅读他们的 <a href="https://mswjs.io/docs/">introduction</a> 。<section class="level3"aria-labelledby="配置"><h3 id="配置">配置</h3><p>您可以像下面一样在您的 <a href="../config.html#setupfiles">setup file</a><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterAll<span class="token punctuation">,</span> afterEach<span class="token punctuation">,</span> beforeAll <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> setupServer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'msw/node'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">HttpResponse</span><span class="token punctuation">,</span> graphql<span class="token punctuation">,</span> http <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'msw'</span>

<span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">userId</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'first post title'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token string">'first post body'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">]</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> restHandlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  http<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'https://rest-endpoint.example/path/to/posts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">HttpResponse</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> graphqlHandlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  graphql<span class="token punctuation">.</span><span class="token method function property-access">query</span><span class="token punctuation">(</span><span class="token string">'ListPosts'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">HttpResponse</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span> posts <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">setupServer</span><span class="token punctuation">(</span><span class="token spread operator">...</span>restHandlers<span class="token punctuation">,</span> <span class="token spread operator">...</span>graphqlHandlers<span class="token punctuation">)</span>

<span class="token comment">// 在所有测试之前启动服务器</span>
<span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> server<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">onUnhandledRequest</span><span class="token operator">:</span> <span class="token string">'error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 所有测试后关闭服务器</span>
<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> server<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 每次测试后重置处理程序 `对测试隔离很重要`</span>
<span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> server<span class="token punctuation">.</span><span class="token method function property-access">resetHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><blockquote><p>使用 <code>onUnhandleRequest: 'error'</code> 配置服务器可以确保即使某个请求没有相应的请求处理程序，也会抛出错误。</blockquote></section><section class="level3"aria-labelledby="了解更多-1"><h3 id="了解更多-1">了解更多</h3><p>MSW 能做的还有很多。你可以访问 cookie 和查询参数、定义模拟错误响应等等！要查看你可以使用 MSW 做什么，请阅读 <a href="https://mswjs.io/docs">their documentation</a>.</section></section><section class="level2"aria-labelledby="计时器"><h2 id="计时器">计时器</h2><p>每当测试代码涉及到 timeout 或者 interval 时，并不是让我们的测试程序进行等待或者超时。我们也可以通过模拟对 <code>setTimeout</code> 和 <code>setInterval</code> 的调用来使用 "fake" 计时器来加速测试。<p>有关更深入的详细 API 描述，参阅 <a href="/api/vi#vi-usefaketimers"><code>vi.usefaketimers</code> api 部分</a>。<section class="level3"aria-labelledby="示例-3"><h3 id="示例-3">示例</h3><pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> afterEach<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">function</span> <span class="token function">executeAfterTwoHours</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// 2小时</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">executeEveryMinute</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token comment">// 1分钟</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> mock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'executed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'delayed execution'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">restoreAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should execute the function'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">executeAfterTwoHours</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should not execute the function'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">executeAfterTwoHours</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span>
    <span class="token comment">// 前进2毫秒并不会触发方法</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">not</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should execute every minute'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">executeEveryMinute</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section></section><section class="level2"aria-labelledby="classes"><h2 id="classes">Classes</h2><p>您只需调用一次 <code>vi.fn</code> 就能模拟整个类，因为所有的类也都是函数，所以这种方法开箱即用。请注意，目前 Vitest 并不尊重 <code>new</code> 关键字，因此在函数的主体中，<code>new.target</code> 总是 <code>undefined</code>。<pre class="language-ts"><code class="language-ts"><span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Dog</span></span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'animal'</span>
  <span class="token punctuation">}</span>

  <span class="token function">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'bark!'</span>
  <span class="token punctuation">}</span>

  <span class="token function">isHungry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">feed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>我们可以使用 ES5 函数重新创建这个类：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> <span class="token maybe-class-name">Dog</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">=</span> name
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// notice that static methods are mocked directly on the function,</span>
<span class="token comment">// not on the instance of the class</span>
<span class="token class-name"><span class="token maybe-class-name">Dog</span></span><span class="token punctuation">.</span><span class="token property-access">getType</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'mocked animal'</span><span class="token punctuation">)</span>

<span class="token comment">// mock the "speak" and "feed" methods on every instance of a class</span>
<span class="token comment">// all `new Dog()` instances will inherit these spies</span>
<span class="token maybe-class-name">Dog</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">speak</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'loud bark!'</span><span class="token punctuation">)</span>
<span class="token maybe-class-name">Dog</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">feed</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><blockquote>WHEN TO USE? 一般来说，如果类是从另一个模块重新导出的，你会在模块工厂内重新创建这样的类：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Dog</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./dog.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./dog.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token maybe-class-name">Dog</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token maybe-class-name">Dog</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">feed</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// ... other mocks</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Dog</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>该方法也可用于将一个类的实例传递给接受相同接口的函数：<pre class="language-ts"><code class="language-ts"><span class="token comment">// ./src/feed.ts</span>
<span class="token keyword">function</span> <span class="token function">feed</span><span class="token punctuation">(</span>dog<span class="token operator">:</span> <span class="token maybe-class-name">Dog</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ./tests/dog.test.ts</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> feed <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../src/feed.js'</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Dog</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token maybe-class-name">Dog</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">feed</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'can feed dogs'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dogMax <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Dog</span></span><span class="token punctuation">(</span><span class="token string">'Max'</span><span class="token punctuation">)</span>

  <span class="token function">feed</span><span class="token punctuation">(</span>dogMax<span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>dogMax<span class="token punctuation">.</span><span class="token property-access">feed</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>dogMax<span class="token punctuation">.</span><span class="token method function property-access">isHungry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></blockquote><p>现在，当我们创建一个新的 <code>Dog</code> 类实例时，它的 <code>speak</code> 方法（与 <code>feed</code> 并列）已经被模拟：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Dog</span></span><span class="token punctuation">(</span><span class="token string">'Cooper'</span><span class="token punctuation">)</span>
dog<span class="token punctuation">.</span><span class="token method function property-access">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// loud bark!</span>

<span class="token comment">// you can use built-in assertions to check the validity of the call</span>
<span class="token function">expect</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span><span class="token property-access">speak</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>我们可以为特定实例重新分配返回值：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Dog</span></span><span class="token punctuation">(</span><span class="token string">'Cooper'</span><span class="token punctuation">)</span>

<span class="token comment">// "vi.mocked" is a type helper, since</span>
<span class="token comment">// TypeScript doesn't know that Dog is a mocked class,</span>
<span class="token comment">// it wraps any function in a MockInstance&#x3C;T> type</span>
<span class="token comment">// without validating if the function is a mock</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span><span class="token property-access">speak</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'woof woof'</span><span class="token punctuation">)</span>

dog<span class="token punctuation">.</span><span class="token method function property-access">speak</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// woof woof</span></code></pre><p>要模拟属性，我们可以使用 <code>vi.spyOn(dog, 'name', 'get')</code> 方法。这样就可以在被模拟的属性上使用 spy 断言：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Dog</span></span><span class="token punctuation">(</span><span class="token string">'Cooper'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> nameSpy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>dog<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'Max'</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'Max'</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>nameSpy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><blockquote>您还可以使用相同的方法监视获取器和设置器。</blockquote></section><section class="level2"aria-labelledby="备忘单"><h2 id="备忘单">备忘单</h2></section>info 提示 下列示例中的 `vi` 是直接从 `vitest` 导入的。如果在你的 [config](/config/) 中将 `globals` 设置为 `true`，则可以全局使用它。<p>我想…<section class="level3"aria-labelledby="模拟导出变量"><h3 id="模拟导出变量">模拟导出变量</h3><pre class="language-js"><code class="language-js"><span class="token comment">// some-path.js</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> getter <span class="token operator">=</span> <span class="token string">'variable'</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// some-path.test.ts</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'getter'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'mocked'</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="监听模块导出-settergetter"><h3 id="监听模块导出-settergetter">监听模块导出 setter/getter</h3><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">'some-path'</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'getter'</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'setter'</span><span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="模拟模块导出函数"><h3 id="模拟模块导出函数">模拟模块导出函数</h3><ol><li><code>vi.mock</code> 的示例：</ol><blockquote>不要忘记将 `vi.mock` 调用提升到文件顶部。它将始终在所有导入之前执行。</blockquote><pre class="language-ts"><code class="language-ts"><span class="token comment">// ./some-path.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> method <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./some-path.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  method<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><ol start="2"><li><code>vi.spyOn</code> 的示例：</ol><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> exports</span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>exports<span class="token punctuation">,</span> <span class="token string">'method'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="模拟模块导出类实现"><h3 id="模拟模块导出类实现">模拟模块导出类实现</h3><ol><li><code>vi.mock</code> 和 <code>.prototype</code> 的示例:</ol><pre class="language-ts"><code class="language-ts"><span class="token comment">// ./some-path.ts</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">SomeClass</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SomeClass</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some-path.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token maybe-class-name">SomeClass</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token maybe-class-name">SomeClass</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">someMethod</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">SomeClass</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// SomeClass.mock.instances 上将会有 someMethod 方法</span></code></pre><ol start="2"><li><code>vi.spyOn</code> 的示例:</ol><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mod</span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">SomeClass</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token maybe-class-name">SomeClass</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token property-access">someMethod</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> <span class="token string">'SomeClass'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token maybe-class-name">SomeClass</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="监听一个函数是否返回了一个对象"><h3 id="监听一个函数是否返回了一个对象">监听一个函数是否返回了一个对象</h3><ol><li>使用 cache 的示例:</ol><pre class="language-ts"><code class="language-ts"><span class="token comment">// some-path.ts</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">useObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token function-variable function">method</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// useObject.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useObject <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">useObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
obj<span class="token punctuation">.</span><span class="token method function property-access">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// useObject.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> useObject <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some-path.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> _cache
  <span class="token keyword">const</span> <span class="token function-variable function">useObject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _cache <span class="token operator">=</span> <span class="token punctuation">{</span>
        method<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 现在每次调用 useObject() 后，都会</span>
    <span class="token comment">// 返回相同的对象引用</span>
    <span class="token keyword control-flow">return</span> _cache
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> useObject <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token function">useObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// obj.method 在 some-path 内调用</span>
<span class="token function">expect</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token property-access">method</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="模拟部分-module"><h3 id="模拟部分-module">模拟部分 module</h3><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> mocked<span class="token punctuation">,</span> original <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./some-path.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some-path.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>importOriginal<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">importOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>mod<span class="token punctuation">,</span>
    mocked<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">original</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 有原始的行为</span>
<span class="token function">mocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 是一个 spy 函数</span></code></pre><blockquote>别忘了，这只是 [mocks _external_ access](#mocking-pitfalls)。在本例中，如果 `original` 在内部调用 `mocked`，它将始终调用模块中定义的函数，而不是 mock 工厂中的函数。</blockquote></section><section class="level3"aria-labelledby="模拟当前日期"><h3 id="模拟当前日期">模拟当前日期</h3><p>要模拟 <code>Date</code> 的时间，你可以使用 <code>vi.setSystemTime</code> 辅助函数。 该值将<strong>不会</strong>在不同的测试之间自动重置。<p>请注意，使用 <code>vi.useFakeTimers</code> 也会更改 <code>Date</code> 的时间。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mockDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">2022</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>mockDate<span class="token punctuation">)</span>
<span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>now<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>mockDate<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 重置模拟的时间</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="模拟全局变量"><h3 id="模拟全局变量">模拟全局变量</h3><p>你可以通过为 <code>globalThis</code> 赋值或使用 <a href="/api/vi#vi-stubglobal"><code>vi.stubGlobal</code></a> 助手来设置全局变量。 使用 <code>vi.stubGlobal</code> 时，<strong>不会</strong>在不同的测试之间自动重置，除非你启用 <a href="../config.html#unstubglobals"><code>unstubGlobals</code></a> 配置选项或调用 <a href="/api/vi#vi-unstuballglobals"><code>vi.unstubAllGlobals</code></a>。<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'__VERSION__'</span><span class="token punctuation">,</span> <span class="token string">'1.0.0'</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>__VERSION__<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'1.0.0'</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="模拟-importmetaenv"><h3 id="模拟-importmetaenv">模拟 <code>import.meta.env</code></h3><ol><li>要更改环境变量，你只需为其分配一个新值即可。 该值将<strong>不会</strong>在不同的测试之间自动重置。</ol><blockquote>环境变量值将在不同的测试之间**不会**自动重置。</blockquote><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> beforeEach<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> it <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// 你可以在 beforeEach 钩子里手动重置</span>
<span class="token keyword">const</span> originalViteEnv <span class="token operator">=</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span> <span class="token operator">=</span> originalViteEnv
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'changes value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span> <span class="token operator">=</span> <span class="token string">'staging'</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'staging'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><ol start="2"><li>如果你想自动重置值，可以使用启用了 <a href="../config.html#unstubEnvs"><code>unstubEnvs</code></a> 配置选项的 <code>vi.stubEnv</code> 助手（或调用 <a href="/api/vi#vi-unstuballenvs"><code>vi.unstubAllEnvs</code></a> 在 <code>beforeEach</code> 钩子中手动执行）：</ol><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> it<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// 在运行测试之前， "VITE_ENV" 的值是 "test"</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span> <span class="token operator">===</span> <span class="token string">'test'</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'changes value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'VITE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'staging'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'staging'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'the value is restored before running an other test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">VITE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token comment">// vitest.config.ts</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    unstubEnvs<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>