<!doctype html><html lang="cn"><meta charset="utf-8"><title>Snapshot | Guide</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="测试快照"><h1 id="测试快照">测试快照</h1><p>当你希望确保函数的输出不会意外更改时，快照测试是一个非常有用的工具。<p><courselink href="https://vueschool.io/lessons/snapshots-in-vitest?friend=vueuse">Learn Snapshot by video from Vue School</courselink><p>使用快照时，Vitest 将获取给定值的快照，将其比较时将参考存储在测试旁边的快照文件。如果两个快照不匹配，则测试将失败：要么更改是意外的，要么参考快照需要更新到测试结果的新版本。<section class="level2"aria-labelledby="使用快照"><h2 id="使用快照">使用快照</h2><p>要将一个值快照，你可以使用 <code>expect()</code> 的 <a href="../api.html#tomatchsnapshot"><code>toMatchSnapshot()</code></a> API:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> it <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'toUpperCase'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token string">'foobar'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>此测试在第一次运行时，Vitest 会创建一个快照文件，如下所示：<pre class="language-js"><code class="language-js"><span class="token comment">// Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html</span>

exports<span class="token punctuation">[</span><span class="token string">'toUpperCase 1'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'"FOOBAR"'</span></code></pre><p>快照文件应该与代码更改一起提交，并作为代码审查过程的一部分进行审查。在随后的测试运行中，Vitest 会将执行的输出与之前的快照进行比较。如果他们匹配，测试就会通过。如果它们不匹配，要么测试运行时在你的代码中发现了应该修复的错误，要么实现已经更改，需要更新快照。</section><section class="level2"aria-labelledby="内联快照"><h2 id="内联快照">内联快照</h2><blockquote>在异步并发测试中使用快照时，由于 JavaScript 的限制，你需要使用 [测试环境](/guide/test-context.md) 中的 `expect` 来确保检测到正确的测试。</blockquote><p>如同前文，你可以使用 <a href="../api.html#tomatchinlinesnapshot"><code>toMatchInlineSnapshot()</code></a> 将内联快照存储在测试文件中。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> it <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'toUpperCase'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token string">'foobar'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Vitest 不会创建快照文件，而是直接修改测试文件，将快照作为字符串更新到文件中：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> it <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'toUpperCase'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token string">'foobar'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token string">'"FOOBAR"'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>这允许你直接查看期望输出，而无需跨不同的文件跳转。</section><section class="level2"aria-labelledby="更新快照"><h2 id="更新快照">更新快照</h2><blockquote>在异步并发测试中使用快照时，由于 JavaScript 的限制，你需要使用 [测试环境](/guide/test-context.md) 中的 `expect` 来确保检测到正确的测试。</blockquote><p>当接收到的值与快照不匹配时，测试将失败，并显示它们之间的差异。当需要更改快照时，你可能希望从当前状态更新快照。<p>在监听(watch)模式下, 你可以在终端中键入 <code>u</code> 键直接更新失败的快照。<p>或者，你可以在 CLI 中使用 <code>--update</code> 或 <code>-u</code> 标记使 Vitest 进入快照更新模式。<pre class="language-bash"><code class="language-bash">vitest -u</code></pre></section><section class="level2"aria-labelledby="文件快照"><h2 id="文件快照">文件快照</h2><p>调用 <code>toMatchSnapshot()</code> 时，我们将所有快照存储在格式化的快照文件中。这意味着我们需要转义快照字符串中的一些字符（即双引号 <code>"</code> 和反引号 ```）。同时，你可能会丢失快照内容的语法突出显示（如果它们是某种语言）。<p>为了改善这种情况，我们引入 <a href="/api/expect#tomatchfilesnapshot"><code>toMatchFileSnapshot()</code></a> 以在文件中显式快照。这允许你为快照文件分配任何文件扩展名，并使它们更具可读性。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> it <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'render basic'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">renderHTML</span><span class="token punctuation">(</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">class</span><span class="token operator">:</span> <span class="token string">'foo'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">await</span> <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchFileSnapshot</span><span class="token punctuation">(</span><span class="token string">'./test/basic.output.html'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>它将与 <code>./test/basic.output.html</code> 的内容进行比较。并且可以用 <code>--update</code> 标志写回。</section><section class="level2"aria-labelledby="图像快照"><h2 id="图像快照">图像快照</h2><p>快照图像也可以使用 <a href="https://github.com/americanexpress/jest-image-snapshot"><code>jest-image-snapshot</code></a>。<pre class="language-bash"><code class="language-bash"><span class="token function">npm</span> i -D jest-image-snapshot</code></pre><pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'image snapshot'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./test/stubs/input-image.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchImageSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>你可以在 <a href="https://github.com/vitest-dev/vitest/blob/main/examples/image-snapshot"><code>examples/image-snapshot</code></a> 中学习更多案例。</section><section class="level2"aria-labelledby="自定义序列化程序"><h2 id="自定义序列化程序">自定义序列化程序</h2><p>你可以添加自己的逻辑来修改快照的序列化方式。像 Jest 一样，Vitest 为内置的 JavaScript 类型、HTML 元素、ImmutableJS 和 React 元素提供了默认的序列化程序。<p>序列化模块示例：<pre class="language-ts"><code class="language-ts">expect<span class="token punctuation">.</span><span class="token method function property-access">addSnapshotSerializer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function">serialize</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> config<span class="token punctuation">,</span> indentation<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> refs<span class="token punctuation">,</span> printer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// `printer` is a function that serializes a value using existing plugins.</span>
    <span class="token keyword control-flow">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pretty foo: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">printer</span><span class="token punctuation">(</span>val<span class="token punctuation">.</span><span class="token property-access">foo</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">test</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> val <span class="token operator">&#x26;&#x26;</span> <span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">.</span><span class="token method function property-access">hasOwnProperty</span><span class="token punctuation">.</span><span class="token method function property-access">call</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'foo'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>如下所示的测试添加后：<pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'foo snapshot test'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token punctuation">{</span>
    foo<span class="token operator">:</span> <span class="token punctuation">{</span>
      x<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      y<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>你将获得以下快照：<pre class="language-text"><code class="language-text">Pretty foo: Object {
  "x": 1,
  "y": 2,
}</code></pre><p>我们使用的是 Jest 的 <code>pretty-format</code> 来序列化快照。你可以在这里阅读更多相关内容：<a href="https://github.com/facebook/jest/blob/main/packages/pretty-format/README.md#serialize">pretty-format</a>.</section><section class="level2"aria-labelledby="与-jest-的区别"><h2 id="与-jest-的区别">与 Jest 的区别</h2><p>Vitest 提供了与 <a href="https://jestjs.io/docs/snapshot-testing">Jest</a> 几乎兼容的快照功能，除少数例外:<section class="level4"aria-labelledby="1-快照文件中的注释标头不同"><h4 id="1-快照文件中的注释标头不同">1. 快照文件中的注释标头不同</h4><pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> // Jest Snapshot v1, https://goo.gl/fbAQLP
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> // Vitest Snapshot v1, https://vitest.dev/guide/snapshot.html</span></span></code></pre><p>这实际上不会影响功能，但在从 Jest 迁移时可能会影响提交差异。</section><section class="level4"aria-labelledby="2-printbasicprototype-默认为-false"><h4 id="2-printbasicprototype-默认为-false">2. <code>printBasicPrototype</code> 默认为 <code>false</code></h4><p>Jest 和 Vitest 的快照都是由 <a href="https://github.com/facebook/jest/blob/main/packages/pretty-format"><code>pretty-format</code></a> 支持的。在 Vitest 中，我们将 <code>printBasicPrototype</code> 的默认值设置为 <code>false</code> 以提供更清晰的快照输出，在 Jest 版本 &#x3C; 29.0.0 中默认为 <code>true</code>。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'snapshot'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      foo<span class="token operator">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>

  <span class="token comment">// in Jest</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    Array [
      Object {
        "foo": "bar",
      },
    ]
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>

  <span class="token comment">// in Vitest</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toMatchInlineSnapshot</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    [
      {
        "foo": "bar",
      },
    ]
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>我们相信这种预设有更好的可读性和开发体验。如果你仍然喜欢 Jest 的行为，可以通过以下方式更改配置：<pre class="language-ts"><code class="language-ts"><span class="token comment">// vitest.config.js</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    snapshotFormat<span class="token operator">:</span> <span class="token punctuation">{</span>
      printBasicPrototype<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level4"aria-labelledby="3-chevron--is-used-as-a-separator-instead-of-colon--for-custom-messages"><h4 id="3-chevron--is-used-as-a-separator-instead-of-colon--for-custom-messages">3. Chevron <code>></code> is used as a separator instead of colon <code>:</code> for custom messages</h4><p>Vitest uses chevron <code>></code> as a separator instead of colon <code>:</code> for readability, when a custom message is passed during creation of a snapshot file.<p>For the following example test code:<pre class="language-js"><code class="language-js"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'toThrowErrorMatchingSnapshot'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toThrowErrorMatchingSnapshot</span><span class="token punctuation">(</span><span class="token string">'hint'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>In Jest, the snapshot will be:<pre class="language-console"><code class="language-console">exports[`toThrowErrorMatchingSnapshot: hint 1`] = `"error"`;</code></pre><p>In Vitest, the equivalent snapshot will be:<pre class="language-console"><code class="language-console">exports[`toThrowErrorMatchingSnapshot > hint 1`] = `"error"`;</code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>