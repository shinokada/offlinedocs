<!doctype html><html lang="cn"><meta charset="utf-8"><title>常见错误 | 指南</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="常见错误"><h1 id="常见错误">常见错误</h1><section class="level2"aria-labelledby="cannot-find-module-relative-path"><h2 id="cannot-find-module-relative-path">Cannot find module './relative-path'</h2><p>如果你收到一个 <strong>module cannot be found</strong> 的报错，则可能意味着几种不同情况：<ul><li>1.你拼错了路径。确保路径正确。<li>2.你可能依赖于 <code>tsconfig.json</code> 中的 <code>baseUrl</code>。默认情况下，Vite 不考虑 <code>tsconfig.json</code>，因此如果你依赖此行为，你可能需要自己安装 <a href="https://www.npmjs.com/package/vite-tsconfig-paths"><code>vite-tsconfig-paths</code></a> 。</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/config'</span>
<span class="token keyword module">import</span> <span class="token imports">tsconfigPaths</span> <span class="token keyword module">from</span> <span class="token string">'vite-tsconfig-paths'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">tsconfigPaths</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>或者重写你的路径，使它不是相对于 root。<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> import helpers from 'src/helpers'
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import helpers from '../src/helpers'</span></span></code></pre><ul><li><ol start="3"><li>确保你没有使用相对路径的 <a href="../config.html#alias">别名</a>。Vite 将它们视为相对于导入所在的文件而不是根目录。</ol></ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/config'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string-property property">'@/'</span><span class="token operator">:</span> <span class="token string">'./src/'</span><span class="token punctuation">,</span> <span class="token comment">// [!code --]</span>
      <span class="token string-property property">'@/'</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token constant">URL</span></span><span class="token punctuation">(</span><span class="token string">'./src/'</span><span class="token punctuation">,</span> <span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">pathname</span><span class="token punctuation">,</span> <span class="token comment">// [!code ++]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="cannot-mock-mocked-filejs-because-it-is-already-loaded"><h2 id="cannot-mock-mocked-filejs-because-it-is-already-loaded">Cannot mock "./mocked-file.js" because it is already loaded</h2><p>当对已加载的模块调用 <code>vi.mock</code> 方法时，会发生此错误。Vitest 抛出此错误，因为此调用没有效果，因为首选缓存模块。<p>请记住，<code>vi.mock</code> 总是挂起的 - 这意味着模块在测试文件开始执行之前就已经加载了 - 很可能是在安装文件中。要修复此错误，请删除导入或清除安装文件末尾的缓存 - 请注意，在这种情况下，安装文件和测试文件将引用不同的模块。<pre class="language-ts"><code class="language-ts"><span class="token comment">// setupFile.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> sideEffect <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./mocked-file.js'</span>

<span class="token function">sideEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">resetModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="failed-to-terminate-worker"><h2 id="failed-to-terminate-worker">Failed to terminate worker</h2><p>当 NodeJS 的 fetch 与默认的 <a href="../config.html#threads"><code>pool: 'threads'</code></a> 一起使用时，可能会发生此错误。问题可以在 <a href="https://github.com/vitest-dev/vitest/issues/3077">issue#3077</a> 上进行持续更新。<p>作为解决方法，我们可以切换到 <a href="../config.html#forks"><code>pool: 'forks'</code></a> 或 <a href="../config.html#vmforks"><code>pool: 'vmForks'</code></a>。</p>code-group<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/config'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    pool<span class="token operator">:</span> <span class="token string">'forks'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><pre class="language-bash"><code class="language-bash">vitest --pool<span class="token operator">=</span>forks</code></pre></section><section class="level2"aria-labelledby="segfaults-and-native-code-errors"><h2 id="segfaults-and-native-code-errors">Segfaults and native code errors</h2><p>运行 <a href="https://nodejs.org/api/addons.html">原生 NodeJS 模块</a>在 <code>pool: 'threads'</code> 中，可能会遇到来自原生代码的神秘错误。<ul><li><code>Segmentation fault (core dumped)</code><li><code>thread '&#x3C;unnamed>' panicked at 'assertion failed</code><li><code>Abort trap: 6</code><li><code>internal error: entered unreachable code</code></ul><p>在这些情况下，原生模块可能不是为多线程安全而构建的。在解决方案中，你可以切换到 <code>pool: 'forks'</code>，它在多个 <code>node:child_process</code> 而不是多个 <code>node:worker_threads</code> 中运行测试用例。</p>code-group<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/config'</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    pool<span class="token operator">:</span> <span class="token string">'forks'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><pre class="language-bash"><code class="language-bash">vitest --pool<span class="token operator">=</span>forks</code></pre><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>