<!doctype html><html lang="cn"><meta charset="utf-8"><title>Retry-ability | Browser Mode</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="retry-ability"><h1 id="retry-ability">Retry-ability</h1><p>浏览器中的测试由于其异步特性，可能会不一致地失败。因此，即使条件延迟（如超时、网络请求或动画），也必须有办法保证断言成功。为此，Vitest 通过 <a href="/api/expect#poll"><code>expect.poll</code></a>和 <code>expect.element</code> API 提供了可重试的断言：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> screen <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@testing-library/dom'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'error banner is rendered'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">triggerError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// @testing-library provides queries with built-in retry-ability</span>
  <span class="token comment">// It will try to find the banner until it's rendered</span>
  <span class="token keyword">const</span> banner <span class="token operator">=</span> <span class="token keyword control-flow">await</span> screen<span class="token punctuation">.</span><span class="token method function property-access">findByRole</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">error</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// Vitest provides `expect.element` with built-in retry-ability</span>
  <span class="token comment">// It will check `element.textContent` until it's equal to "Error!"</span>
  <span class="token keyword control-flow">await</span> expect<span class="token punctuation">.</span><span class="token method function property-access">element</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveTextContent</span><span class="token punctuation">(</span><span class="token string">'Error!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>`expect.element` 是 `expect.poll(() => element)`的简写，工作方式完全相同。<p><code>toHaveTextContent</code> 和所有其他 <a href="https://github.com/testing-library/jest-dom"><code>@testing-library/jest-dom</code></a>断言在没有内置重试机制的常规<code>expect</code>中仍然可用：<pre class="language-ts"><code class="language-ts"><span class="token comment">// will fail immediately if .textContent is not `'Error!'`</span>
<span class="token function">expect</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveTextContent</span><span class="token punctuation">(</span><span class="token string">'Error!'</span><span class="token punctuation">)</span></code></pre></blockquote><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section>