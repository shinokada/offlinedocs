<!doctype html><html lang="cn"><meta charset="utf-8"><title>Commands | Browser Mode</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="outline"content="deep"><link rel="stylesheet"type="text/css"href="../../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="commands"><h1 id="commands">Commands</h1><p>命令是一个函数，它调用服务器上的另一个函数并将结果传递回浏览器。Vitest 公开了几个可以在浏览器测试中使用的内置命令。<section class="level2"aria-labelledby="内置命令"><h2 id="内置命令">内置命令</h2><section class="level3"aria-labelledby="文件处理"><h3 id="文件处理">文件处理</h3><p>你可以使用 <code>readFile</code> 、<code>writeFile</code> 和 <code>removeFile</code> API 来处理浏览器测试中的文件。所有路径都是相对于测试文件解析的，即使它们是在位于另一个文件中的辅助函数中调用的。<p>默认情况下，Vitest 使用 <code>utf-8</code> 编码，但你可以使用选项覆盖它。<blockquote>此 API 遵循 [`server.fs`](https://vitejs.dev/config/server-options.html#server-fs-allow) 出于安全原因的限制。</blockquote><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> server <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@vitest/browser/context'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> readFile<span class="token punctuation">,</span> writeFile<span class="token punctuation">,</span> removeFile <span class="token punctuation">}</span> <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token property-access">commands</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'handles files'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token string">'./test.txt'</span>

  <span class="token keyword control-flow">await</span> <span class="token function">writeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">'hello world'</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">readFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">await</span> <span class="token function">removeFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section></section><section class="level2"aria-labelledby="cdp-session"><h2 id="cdp-session">CDP Session</h2><p>Vitest 通过 <code>@vitest/browser/context</code> 中导出的 <code>cdp</code> 方法访问原始 Chrome Devtools 协议。它主要用于库作者在其基础上构建工具。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> cdp <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@vitest/browser/context'</span>

<span class="token keyword">const</span> input <span class="token operator">=</span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">createElement</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">)</span>
<span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token punctuation">.</span><span class="token method function property-access">appendChild</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span>
input<span class="token punctuation">.</span><span class="token method function property-access">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">cdp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Input.dispatchKeyEvent'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'keyDown'</span><span class="token punctuation">,</span>
  text<span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveValue</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span></code></pre><blockquote>CDP session仅适用于 `playwright` provider，并且仅在使用 `chromium` 浏览器时有效。有关详细信息，请参阅 playwright 的 [`CDPSession`](https://playwright.dev/docs/api/class-cdpsession)文档。</blockquote></section><section class="level2"aria-labelledby="custom-commands"><h2 id="custom-commands">Custom Commands</h2><p>你也可以通过 <a href="../config.html#browser-commands"><code>browser.commands</code></a> 配置选项添加自己的命令。如果你开发了一个库，你可以通过插件内的 <code>config</code> 钩子来提供它们：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Plugin</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'vitest/config'</span>
<span class="token keyword module">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">BrowserCommand</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword">const</span> myCustomCommand<span class="token operator">:</span> <span class="token maybe-class-name">BrowserCommand</span><span class="token operator">&#x3C;</span><span class="token punctuation">[</span>arg1<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg2<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  testPath<span class="token punctuation">,</span>
  provider
<span class="token punctuation">}</span><span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>provider<span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">===</span> <span class="token string">'playwright'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>testPath<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">)</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> someValue<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">provider </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>provider<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not supported</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function"><span class="token maybe-class-name">BrowserCommands</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Plugin</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'vitest:custom-commands'</span><span class="token punctuation">,</span>
    <span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token punctuation">{</span>
          browser<span class="token operator">:</span> <span class="token punctuation">{</span>
            commands<span class="token operator">:</span> <span class="token punctuation">{</span>
              myCustomCommand<span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>然后，你可以通过从 <code>@vitest/brower/context</code> 导入它，在测试中调用它：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> commands <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@vitest/browser/context'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'custom command works correctly'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> commands<span class="token punctuation">.</span><span class="token method function property-access">myCustomCommand</span><span class="token punctuation">(</span><span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span> someValue<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// if you are using TypeScript, you can augment the module</span>
<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'@vitest/browser/context'</span> <span class="token punctuation">{</span>
  <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">BrowserCommands</span></span> <span class="token punctuation">{</span>
    <span class="token function-variable function">myCustomCommand</span><span class="token operator">:</span> <span class="token punctuation">(</span>arg1<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg2<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token punctuation">{</span>
      someValue<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token operator">></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote>如果自定义命令具有相同的名称，则它们将覆盖内置命令。</blockquote><section class="level3"aria-labelledby="自定义命令-playwright"><h3 id="自定义命令-playwright">自定义命令 <code>playwright</code></h3><p>Vitest 在命令上下文中公开了几个<code>playwright</code>特定属性。<ul><li><code>page</code>引用包含测试 iframe 的完整页面。这是协调器 HTML，为避免出现问题，最好不要碰它。<li><code>frame</code> 是一个异步方法，用于解析测试器 <a href="https://playwright.dev/docs/api/class-frame"><code>Frame</code></a>。它的 API 与 <code>page</code> 类似，但不支持某些方法。如果您需要查询元素，应优先使用 <code>context.iframe</code> 代替，因为它更稳定、更快速。<li><code>iframe</code> 是一个 <a href="https://playwright.dev/docs/api/class-framelocator"><code>FrameLocator</code></a>，用于查询页面上的其他元素。<li><code>context</code> 是指唯一的<a href="https://playwright.dev/docs/api/class-browsercontext">BrowserContext</a>。</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">BrowserCommand</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> myCommand<span class="token operator">:</span> <span class="token maybe-class-name">BrowserCommand</span><span class="token operator">&#x3C;</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  ctx<span class="token punctuation">,</span>
  arg1<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  arg2<span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token property-access">provider</span><span class="token punctuation">.</span><span class="token property-access">name</span> <span class="token operator">===</span> <span class="token string">'playwright'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword control-flow">await</span> ctx<span class="token punctuation">.</span><span class="token property-access">iframe</span><span class="token punctuation">.</span><span class="token method function property-access">findByRole</span><span class="token punctuation">(</span><span class="token string">'alert'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> screenshot <span class="token operator">=</span> <span class="token keyword control-flow">await</span> element<span class="token punctuation">.</span><span class="token method function property-access">screenshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// do something with the screenshot</span>
    <span class="token keyword control-flow">return</span> difference
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote>如果您使用的是 TypeScript，请不要忘记将 `@vitest/browser/providers/playwright` 添加到您的 `tsconfig` "compilerOptions.types" 字段，以便在配置中以及 `userEvent` 和 `page` 选项中获得自动完成功能：<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"types"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"@vitest/browser/providers/playwright"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></blockquote></section><section class="level3"aria-labelledby="自定义命令-webdriverio"><h3 id="自定义命令-webdriverio">自定义命令 <code>webdriverio</code></h3><p>Vitest 在上下文对象上公开了一些 <code>webdriverio</code> 特有属性。<ul><li><code>browser</code> 是 <code>WebdriverIO.Browser</code> API.</ul><p>Vitest 通过在调用命令前调用 <code>browser.switchToFrame</code> 自动将 <code>webdriver</code> 上下文切换到测试 iframe，因此 <code>$</code> 和 <code>$</code> 方法将引用 iframe 内的元素，而不是 orchestrator 中的元素，但非 Webdriver API 仍将引用 parent frame 上下文。<blockquote>如果您使用的是 TypeScript，请不要忘记将 `@vitest/browser/providers/webdriverio` 添加到您的 `tsconfig` "compilerOptions.types" 字段，以获得自动完成功能：<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"types"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"@vitest/browser/providers/webdriverio"</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></blockquote><span style="float:footnote"><a href="../../index.html#toc">Go to TOC</a></span></section></section></section>