<!doctype html><html lang="cn"><meta charset="utf-8"><title>Vi</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="vi"><h1 id="vi">Vi</h1><p>Vitest 提供实用函数来帮助你使用其 <code>vi</code> 助手。你可以全局访问它（当 <a href="../config.html#globals">globals configuration</a> 是 <strong>启用</strong> 时），或者从 <code>vitest</code> 导入：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span></code></pre><section class="level2"aria-labelledby="viadvancetimersbytime"><h2 id="viadvancetimersbytime">vi.advanceTimersByTime</h2><ul><li><p><strong>类型:</strong> <code>(ms: number) => Vitest</code><p>就像 <code>runAllTimers</code> 一样工作，但会在经过几毫秒后结束。例如，这将记录 <code>1, 2, 3</code> 并且不会抛出：<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span></code></pre></ul><section class="level3"aria-labelledby="viadvancetimersbytimeasync"><h3 id="viadvancetimersbytimeasync">vi.advanceTimersByTimeAsync</h3><ul><li><p><strong>类型:</strong> <code>(ms: number) => Promise&#x3C;Vitest></code><p>就像 <code>runAllTimersAsync</code> 一样工作，但会在经过几毫秒后结束。这将包括异步设置的计时器。例如，这将记录 <code>1, 2, 3</code> 并且不会抛出：<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTimeAsync</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span></code></pre></ul></section></section><section class="level2"aria-labelledby="viadvancetimerstonexttimer"><h2 id="viadvancetimerstonexttimer">vi.advanceTimersToNextTimer</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><p>将调用下一个可用的计时器。在每次定时器调用之间进行断言很有用。你可以链式调用它来自己管理定时器。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log 1</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log 2</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log 3</span></code></pre></ul><section class="level3"aria-labelledby="viadvancetimerstonexttimerasync"><h3 id="viadvancetimerstonexttimerasync">vi.advanceTimersToNextTimerAsync</h3><ul><li><p><strong>类型:</strong> <code>() => Promise&#x3C;Vitest></code><p>将调用下一个可用计时器，即使它是异步设置的。在每次定时器调用之间进行断言很有用。你可以链式调用它来自己管理定时器。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log 1</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log 2</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log 3</span></code></pre></ul></section></section><section class="level2"aria-labelledby="vigettimercount"><h2 id="vigettimercount">vi.getTimerCount</h2><ul><li><p><strong>类型:</strong> <code>() => number</code><p>获取等待计时器的数量。</ul></section><section class="level2"aria-labelledby="viclearallmocks"><h2 id="viclearallmocks">vi.clearAllMocks</h2><p>将对所有模拟调用 <a href="/api/mock.html#mockclear"><code>.mockClear()</code></a>。这将清除模拟历史记录，但不会将其实现重置为默认值。</section><section class="level2"aria-labelledby="viclearalltimers"><h2 id="viclearalltimers">vi.clearAllTimers</h2><p>删除计划运行的所有计时器。这些计时器将来永远不会运行。</section><section class="level2"aria-labelledby="vidynamicimportsettled"><h2 id="vidynamicimportsettled">vi.dynamicImportSettled</h2><p>等待所有导入加载。很有用，如果你有一个开始导入模块的同步调用，否则你只能等待。</section><section class="level2"aria-labelledby="vifn"><h2 id="vifn">vi.fn</h2><ul><li><p><strong>类型:</strong> <code>(fn?: Function) => CallableMockInstance</code><p>创建一个函数的模拟，尽管可以在没有一个的情况下启动。每次调用一个函数时，它都会存储它的调用参数、返回值和实例。此外，你可以使用 <a href="#mockinstance-methods">methods</a> 操纵其行为。 如果没有给出函数，mock 将在调用时返回 <code>undefined</code>。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> getApples <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturnedWith</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

getApples<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveNthReturnedWith</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="vigetmockedsystemtime"><h2 id="vigetmockedsystemtime">vi.getMockedSystemTime</h2><ul><li><p><strong>类型</strong>: <code>() => Date | null</code><p>返回使用 <code>setSystemTime</code> 设置的模拟当前日期。如果日期未被模拟，将返回 <code>null</code>。</ul></section><section class="level2"aria-labelledby="vigetrealsystemtime"><h2 id="vigetrealsystemtime">vi.getRealSystemTime</h2><ul><li><p><strong>类型</strong>: <code>() => number</code><p>使用 <code>vi.useFakeTimers</code> 时，<code>Date.now</code> 调用被模拟。如果需要获取毫秒级的实时时间，可以调用该函数。</ul></section><section class="level2"aria-labelledby="vihoisted"><h2 id="vihoisted">vi.hoisted</h2><ul><li><p><strong>类型</strong>: <code>&#x3C;T>(factory: () => T) => T</code><li><p><strong>版本</strong>: Since Vitest 0.31.0<p>ES 模块中的所有静态 <code>import</code> 语句都被提升到文件顶部，因此在导入被评估之后定义的任何代码实际上都将在导入之后执行。<p>然而，在导入模块之前调用一些副作用（例如模拟日期）可能是有用的。<p>为了绕过这个限制，您可以将静态导入重写为动态导入，如下所示：<pre class="language-diff"><code class="language-diff">callFunctionWithSideEffect()
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> import { value } from './some/module.ts'
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const { value } = await import('./some/module.ts')</span></span></code></pre><p>在运行 <code>vitest</code> 时，您可以使用 <code>vi.hoisted</code> 方法自动执行此操作。<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> callFunctionWithSideEffect()
</span></span>import { value } from './some/module.ts'
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> vi.hoisted(() => callFunctionWithSideEffect())</span></span></code></pre><p>此方法返回从工厂返回的值。如果您需要轻松访问本地定义的变量，可以在 <code>vi.mock</code> 工厂中使用该值：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> originalMethod <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./path/to/module.js'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> mockedMethod <span class="token punctuation">}</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> mockedMethod<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> originalMethod<span class="token operator">:</span> mockedMethod <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

mockedMethod<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">originalMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="vimock"><h2 id="vimock">vi.mock</h2><ul><li><p><strong>类型</strong>: <code>(path: string, factory?: () => unknown) => void</code><p>使用提供的 <code>path</code> 替换所有导入的模块为另一个模块。您可以在路径中使用配置的 Vite 别名。对 <code>vi.mock</code> 的调用是提升的，因此您在哪里调用它并不重要。它将始终在所有导入之前执行。如果您需要引用其作用域外的某些变量，可以在 <a href="/api/vi#vi-hoisted"><code>vi.hoisted</code></a> 中定义它们，并在 <code>vi.mock</code> 中引用。<blockquote>`vi.mock` 仅适用于使用 `import` 关键字导入的模块。它不适用于 `require`。<p>Vitest 静态分析你的文件以提升 <code>vi.mock</code>。 这意味着你不能使用不是直接从 <code>vitest</code> 包（例如，从某些实用程序文件）导入的 <code>vi</code>。要解决此问题，请始终将 <code>vi.mock</code> 与从 <code>vitest</code> 导入的 <code>vi</code> 一起使用，或者启用 <a href="../config.html#globals"><code>globals</code></a> 配置选项。</blockquote><blockquote>[浏览器模式](/guide/browser) 当前不支持模拟模块。你可以在 GitHub <a href="https://github.com/vitest-dev/vitest/issues/3046">问题</a>中跟踪此功能。</blockquote><p>如果定义了 <code>factory</code>，则所有导入都将返回其结果。Vitest 只调用一次工厂并缓存所有后续导入的结果，直到调用 <a href="#vi-unmock"><code>vi.unmock</code></a> 或 <a href="#vi-dounmock"><code>vi.doUnmock</code></a> 为止。<p>与 <code>jest</code> 不同，工厂可以是异步的，因此你可以在内部使用 <a href="#vi-importactual"><code>vi.importActual</code></a> 或作为第一个参数接收的助手来获取原始模块。<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>importOriginal<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">importOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>mod<span class="token punctuation">,</span>
    <span class="token comment">// replace some exports</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>`vi.mock` 被提升（换句话说，_moved_）到**文件顶部**。 这意味着无论何时你编写它（无论是在 `beforeEach` 还是 `test` 中），它实际上都会在此之前被调用。<p>这也意味着你不能在工厂内部使用在工厂外部定义的任何变量。<p>如果您需要在工厂内部使用变量，请尝试 <a href="#vi-domock"><code>vi.doMock</code></a>。它的工作方式相同，但不会被提升。请注意，它只会模拟后续导入。<p>如果在 <code>vi.mock</code> 之前声明了 <code>vi.hoisted</code> 方法，您还可以引用由其定义的变量：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> namedExport <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./path/to/module.js'</span>

<span class="token keyword">const</span> mocks <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    namedExport<span class="token operator">:</span> mocks<span class="token punctuation">.</span><span class="token property-access">namedExport</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>namedExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">namedExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>namedExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>mocks<span class="token punctuation">.</span><span class="token property-access">namedExport</span><span class="token punctuation">)</span></code></pre></blockquote><blockquote>如果你正在模拟具有默认导出的模块，则需要在返回的工厂函数对象中提供一个 `default` 键。这是一个特定于 ES 模块的警告，因此 `jest` 文档可能会有所不同，因为 `jest` 使用 CommonJS 模块。 例如，<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> myDefaultKey<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// etc...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></blockquote><p>如果你正在模拟的文件旁边有一个 <code>__mocks__</code> 文件夹，并且没有提供工厂，Vitest 将尝试在 <code>__mocks__</code> 子文件夹中找到一个具有相同名称的文件，并将其用作实际模块。如果你正在模拟一个依赖项，Vitest 将尝试在项目的 <a href="../config.html#root">root</a> 中找到一个 <code>__mocks__</code> 文件夹（默认是 <code>process.cwd()</code>）。<p>例如，你可以看到以下文件结构：<pre class="language-text"><code class="language-text">- __mocks__
  - axios.js
- src
  __mocks__
    - increment.js
  - increment.js
- tests
  - increment.test.js</code></pre><p>如果您在未提供工厂的情况下在测试文件中调用 <code>vi.mock</code>，它将在 <code>__mocks__</code> 文件夹中找到一个文件以用作模块：<pre class="language-ts"><code class="language-ts"><span class="token comment">// increment.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// axios is a default export from `__mocks__/axios.js`</span>
<span class="token keyword module">import</span> <span class="token imports">axios</span> <span class="token keyword module">from</span> <span class="token string">'axios'</span>

<span class="token comment">// increment is a named export from `src/__mocks__/increment.js`</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../increment.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'../increment.js'</span><span class="token punctuation">)</span>

axios<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/apples/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></code></pre><blockquote>请注意，如果您不调用 `vi.mock`，模块**不会**自动模拟。为了复制 Jest 的自动模拟行为，您可以在 [`setupFiles`](../config.html#setupfiles) 中为每个所需的模块调用 `vi.mock`。</blockquote><p>如果没有提供 <code>__mocks__</code> 文件夹或工厂，Vitest 将导入原始模块并自动模拟其所有导出。有关应用的规则，请参阅 <a href="/guide/mocking#automocking-algorithm">algorithm</a>。</ul></section><section class="level2"aria-labelledby="vidomock"><h2 id="vidomock">vi.doMock</h2><ul><li><p><strong>类型</strong>: <code>(path: string, factory?: () => unknown) => void</code><p>与 <a href="#vi-mock"><code>vi.mock</code></a> 相同，但它不会提升到文件顶部，因此您可以在全局文件范围内引用变量。模块的下一次导入将被模拟。这不会模拟在调用之前导入的模块。</ul><pre class="language-ts"><code class="language-ts"><span class="token comment">// ./increment.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token builtin">number</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> beforeEach<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>

<span class="token comment">// the module is not mocked, because vi.doMock is not called yet</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span>

<span class="token keyword">let</span> mockedIncrement <span class="token operator">=</span> <span class="token number">100</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// you can access variables inside a factory</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">doMock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token operator">++</span>mockedIncrement <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'importing the next module imports mocked one'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// original import WAS NOT MOCKED, because vi.doMock is evaluated AFTER imports</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> increment<span class="token operator">:</span> mockedIncrement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>
  <span class="token comment">// new import returns mocked module</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="vimocked"><h2 id="vimocked">vi.mocked</h2><ul><li><p><strong>类型</strong>: <code>&#x3C;T>(obj: T, deep?: boolean) => MaybeMockedDeep&#x3C;T></code><li><p><strong>类型</strong>: <code>&#x3C;T>(obj: T, options?: { partial?: boolean; deep?: boolean }) => MaybePartiallyMockedDeep&#x3C;T></code><p>TypeScript 的类型助手。实际上只是返回传递的对象。<p>当 <code>partial</code> 为 <code>true</code> 时，它将期望 <code>Partial&#x3C;T></code> 作为返回值。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports">example</span> <span class="token keyword module">from</span> <span class="token string">'./example.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'1+1 equals 2'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token property-access">calc</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockRestore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> res <span class="token operator">=</span> example<span class="token punctuation">.</span><span class="token method function property-access">calc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="viimportactual"><h2 id="viimportactual">vi.importActual</h2><ul><li><p><strong>类型</strong>: <code>&#x3C;T>(path: string) => Promise&#x3C;T></code><p>导入模块，绕过所有检查是否应该被模拟。如果你想部分模拟模块，这可能很有用。<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">importActual</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>axios<span class="token punctuation">,</span> get<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="viimportmock"><h2 id="viimportmock">vi.importMock</h2><ul><li><strong>类型</strong>: <code>&#x3C;T>(path: string) => Promise&#x3C;MaybeMockedDeep&#x3C;T>></code></ul><p>导入一个模块，其所有属性（包括嵌套属性）都被模拟。遵循 <a href="#vi-mock"><code>vi.mock</code></a> 遵循的相同规则。有关应用的规则，请参阅 <a href="/guide/mocking#automocking-algorithm">algorithm</a>。</section><section class="level2"aria-labelledby="viresetallmocks"><h2 id="viresetallmocks">vi.resetAllMocks</h2><p>将对所有模拟调用 <a href="/api/mock.html#mockreset"><code>.mockReset()</code></a>。这将清除模拟历史并将其实现重置为空函数（将返回 <code>undefined</code>）。</section><section class="level2"aria-labelledby="viresetconfig"><h2 id="viresetconfig">vi.resetConfig</h2><ul><li><strong>类型</strong>: <code>RuntimeConfig</code></ul><p>如果之前调用了 <a href="#vi-setconfig"><code>vi.setConfig</code></a>，这会将配置重置为原始状态。</section><section class="level2"aria-labelledby="viresetmodules"><h2 id="viresetmodules">vi.resetModules</h2><ul><li><strong>类型</strong>: <code>() => Vitest</code></ul><p>通过清除所有模块的缓存来重置模块注册表。这允许在重新导入时重新评估模块。但是无法重新评估顶级导入。这可能有助于隔离测试之间本地状态冲突的模块。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./data.js'</span> <span class="token comment">// Will not get reevaluated beforeEach test</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">resetModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'change state'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some/path.js'</span><span class="token punctuation">)</span> <span class="token comment">// Will get reevaluated</span>
  mod<span class="token punctuation">.</span><span class="token method function property-access">changeLocalState</span><span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token method function property-access">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'module has old state'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some/path.js'</span><span class="token punctuation">)</span> <span class="token comment">// Will get reevaluated</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token method function property-access">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'old value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>不重置模拟注册表。要清除模拟注册表，请使用 [`vi.unmock`](#vi-unmock) 或 [`vi.doUnmock`](#vi-dounmock)。</blockquote></section><section class="level2"aria-labelledby="virestoreallmocks"><h2 id="virestoreallmocks">vi.restoreAllMocks</h2><p>将对所有模拟调用 <a href="/api/mock.html#mockrestore"><code>.mockRestore()</code></a>。这将清除模拟历史并将其实现重置为原始历史。</section><section class="level2"aria-labelledby="virestorecurrentdate"><h2 id="virestorecurrentdate">vi.restoreCurrentDate</h2><ul><li><p><strong>类型:</strong> <code>() => void</code><p>将 <code>Date</code> 恢复为其本机实现。</ul></section><section class="level2"aria-labelledby="vistubenv"><h2 id="vistubenv">vi.stubEnv</h2><ul><li><p><strong>类型:</strong> <code>(name: string, value: string) => Vitest</code><li><p><strong>版本:</strong> 从 Vitest 0.26.0 开始支持<p>更改 <code>process.env</code> 和 <code>import.meta.env</code> 上的环境变量值。你可以通过调用 <code>vi.unstubAllEnvs</code> 恢复它的值。</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `process.env.NODE_ENV` and `import.meta.env.NODE_ENV`</span>
<span class="token comment">// are "development" before calling "vi.stubEnv"</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token comment">// doesn't change other envs</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'development'</span></code></pre><blockquote>你也可以通过简单地分配它来更改值，但是你将无法使用 `vi.unstubAllEnvs` 来恢复以前的值：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">=</span> <span class="token string">'test'</span></code></pre></blockquote><blockquote>Vitest 将所有 `import.meta.env` 调用转换为 `process.env`，因此它们可以在运行时轻松更改。 Node.js 只支持字符串值作为 env 参数，而 Vite 支持几种内置的 env 作为布尔值（即 `SSR`、`DEV`、`PROD`）。 为了模仿 Vite，将 "truthy" 值设置为 env：`''` 而不是 `false`，`'1'` 而不是 `true`。<p>但请注意，在这种情况下，你不能使用 <code>import.meta.env.DEV === false</code>。使用 <code>!import.meta.env.DEV</code>。这也会影响简单的分配，而不仅仅是 <code>vi.stubEnv</code> 方法。</blockquote></section><section class="level2"aria-labelledby="viunstuballenvs"><h2 id="viunstuballenvs">vi.unstubAllEnvs</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><li><p><strong>版本:</strong> 从 Vitest 0.26.0 开始支持<p>恢复使用 <code>vi.stubEnv</code> 更改的所有 <code>import.meta.env</code> and <code>process.env</code> 值。第一次调用时，Vitest 会记住原始值并存储它，直到再次调用 <code>unstubAllEnvs</code>。</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `process.env.NODE_ENV` and `import.meta.env.NODE_ENV`</span>
<span class="token comment">// are "development" before calling stubEnv</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'staging'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'staging'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'staging'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">unstubAllEnvs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// restores to the value that were stored before the first "stubEnv" call</span>
process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span></code></pre></section><section class="level2"aria-labelledby="vistubglobal"><h2 id="vistubglobal">vi.stubGlobal</h2><ul><li><p><strong>类型:</strong> <code>(name: string | number | symbol, value: unknown) => Vitest</code><p>改变全局变量的值。你可以通过调用 <code>vi.unstubAllGlobals</code> 恢复其原始值。</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `innerWidth` is "0" before calling stubGlobal</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'innerWidth'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

innerWidth <span class="token operator">===</span> <span class="token number">100</span>
globalThis<span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">===</span> <span class="token number">100</span></code></pre><blockquote>你也可以通过简单地将其分配给 `globalThis` 或 `window` 来更改值（如果你使用的是 `jsdom` 或 `happy-dom` 环境），但是你将无法使用 `vi.unstubAllGlobals` 来恢复原始值：<pre class="language-ts"><code class="language-ts">globalThis<span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">=</span> <span class="token number">100</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">=</span> <span class="token number">100</span></code></pre></blockquote></section><section class="level2"aria-labelledby="viunstuballglobals"><h2 id="viunstuballglobals">vi.unstubAllGlobals</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><li><p><strong>版本:</strong> 从 Vitest 0.26.0 开始支持<p>恢复 <code>globalThis</code>/<code>global</code>（和 <code>window</code>/<code>top</code>/<code>self</code>/<code>parent</code>，如果你使用 <code>jsdom</code> 或 <code>happy-dom</code> 环境）的所有全局值被 <code>vi.stubGlobal</code>。第一次调用时，Vitest 会记住原始值并存储它，直到再次调用 <code>unstubAllGlobals</code>。</ul><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Mock</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// IntersectionObserver is "undefined" before calling "stubGlobal"</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'IntersectionObserver'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Mock</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
global<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
globalThis<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">unstubAllGlobals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

globalThis<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>
<span class="token string">'IntersectionObserver'</span> <span class="token keyword">in</span> globalThis <span class="token operator">===</span> <span class="token boolean">false</span>
<span class="token comment">// throws ReferenceError, because it's not defined</span>
<span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span></code></pre></section><section class="level2"aria-labelledby="virunallticks"><h2 id="virunallticks">vi.runAllTicks</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><p>调用由 <code>process.nextTick</code> 排队的每个微任务。这也将运行所有自己安排的微任务。</ul></section><section class="level2"aria-labelledby="virunalltimers"><h2 id="virunalltimers">vi.runAllTimers</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><p>此方法将调用每个启动的计时器，直到计时器队列为空。这意味着在 <code>runAllTimers</code> 期间调用的每个计时器都将被触发。如果你有无限间隔，它将在 10 000 次尝试后抛出。例如，这将记录 <code>1, 2, 3</code>：<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></ul><section class="level3"aria-labelledby="virunalltimersasync"><h3 id="virunalltimersasync">vi.runAllTimersAsync</h3><ul><li><p><strong>类型:</strong> <code>() => Promise&#x3C;Vitest></code><p>此方法将异步调用每个启动的计时器，直到计时器队列为空。这意味着在 <code>runAllTimersAsync</code> 期间调用的每个计时器都将被触发，即使是异步计时器也是如此。如果你有一个无限的间隔，它会在 10 000 次尝试后抛出。例如，这将记录 <code>result</code>：<pre class="language-ts"><code class="language-ts"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimersAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></ul></section></section><section class="level2"aria-labelledby="virunonlypendingtimers"><h2 id="virunonlypendingtimers">vi.runOnlyPendingTimers</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><p>此方法将调用在调用 <code>vi.useFakeTimers()</code> 之后启动的每个计时器。它不会触发在其调用期间启动的任何计时器。例如，这只会记录 <code>1</code>：<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></ul><section class="level3"aria-labelledby="virunonlypendingtimersasync"><h3 id="virunonlypendingtimersasync">vi.runOnlyPendingTimersAsync</h3><ul><li><p><strong>类型:</strong> <code>() => Promise&#x3C;Vitest></code><p>此方法将异步调用在 <code>vi.useFakeTimers()</code> 调用之后启动的每个计时器，甚至是异步计时器。它不会触发在其调用期间启动的任何计时器。例如，这将记录 <code>2, 3, 3, 1</code>：<pre class="language-ts"><code class="language-ts"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">runOnlyPendingTimersAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></ul></section></section><section class="level2"aria-labelledby="visetsystemtime"><h2 id="visetsystemtime">vi.setSystemTime</h2><ul><li><p><strong>类型</strong>: <code>(date: string | number | Date) => void</code><p>将当前日期设置为过去的日期。 所有 <code>Date</code> 调用都将返回此日期。<p>如果你需要测试任何依赖于当前日期的内容，这很有用 - 例如 <a href="https://github.com/moment/luxon/">luxon</a> 在你的代码中调用。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">1998</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="visetconfig"><h2 id="visetconfig">vi.setConfig</h2><ul><li><p><strong>类型</strong>: <code>RuntimeConfig</code><p>更新当前测试文件的配置。在执行测试时，你只能作用于当前值。</ul></section><section class="level2"aria-labelledby="vispyon"><h2 id="vispyon">vi.spyOn</h2><ul><li><p><strong>类型:</strong> <code>&#x3C;T, K extends keyof T>(object: T, method: K, accessType?: 'get' | 'set') => MockInstance</code><p>在对象的方法或 getter/setter 上创建一个模拟。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> apples <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> cart <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">13</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> apples<span class="token punctuation">)</span>
apples <span class="token operator">=</span> <span class="token number">1</span>

<span class="token function">expect</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturnedWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="vistubglobal-1"><h2 id="vistubglobal-1">vi.stubGlobal</h2><ul><li><p><strong>类型</strong>: <code>(key: keyof globalThis &#x26; Window, value: any) => Vitest</code><p>为全局变量赋值。如果你正在使用 <code>jsdom</code> 或 <code>happy-dom</code>，还要将值放在 <code>window</code> 对象上。<p>在 <a href="/guide/mocking.html#globals">"模拟全局变量"部分</a> 中阅读更多内容。</ul></section><section class="level2"aria-labelledby="viunmock"><h2 id="viunmock">vi.unmock</h2><ul><li><p><strong>类型</strong>: <code>(path: string) => void</code><p>从模拟注册表中删除模块。所有对 import 的调用都将返回原始模块，即使它之前被模拟过。此调用被提升（移动）到文件的顶部，因此它只会取消模拟在 <code>setupFiles</code> 中定义的模块，例如。</ul></section><section class="level2"aria-labelledby="vidounmock"><h2 id="vidounmock">vi.doUnmock</h2><ul><li><p><strong>类型</strong>: <code>(path: string) => void</code><p>与 <a href="#vi-unmock"><code>vi.unmock</code></a> 相同，但不会提升到文件顶部。模块的下一次导入将导入原始模块而不是模拟。这不会取消模拟以前导入的模块。</ul><pre class="language-ts"><code class="language-ts"><span class="token comment">// ./increment.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token builtin">number</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>

<span class="token comment">// increment is already mocked, because vi.mock is hoisted</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// this is hoisted, and factory is called before the import on line 1</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// all calls are mocked, and `increment` always returns 100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// this is not hoisted, so other import will return unmocked module</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">doUnmock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>

<span class="token comment">// this STILL returns 100, because `vi.doUnmock` doesn't reevaluate a module</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// the next import is unmocked, now `increment` is the original function that returns count + 1</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> increment<span class="token operator">:</span> unmockedIncrement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>

<span class="token function">unmockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span>
<span class="token function">unmockedIncrement</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">31</span></code></pre></section><section class="level2"aria-labelledby="viusefaketimers"><h2 id="viusefaketimers">vi.useFakeTimers</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><p>要启用模拟计时器，你需要调用此方法。它将包装所有对计时器的进一步调用（例如 <code>setTimeout</code>、<code>setInterval</code>、<code>clearTimeout</code>、<code>clearInterval</code>、<code>nextTick</code>、<code>setImmediate</code>、<code>clearImmediate</code> 和 <code>Date</code>），直到 <a href="#vi-userealtimers"><code>vi. useRealTimers()</code></a> 被调用。<p>该实现在内部基于 <a href="https://github.com/sinonjs/fake-timers"><code>@sinonjs/fake-timers</code></a>。</ul></section><section class="level2"aria-labelledby="viuserealtimers"><h2 id="viuserealtimers">vi.useRealTimers</h2><ul><li><p><strong>类型:</strong> <code>() => Vitest</code><p>当计时器用完时，你可以调用此方法将模拟计时器返回到其原始实现。之前运行的所有计时器都不会恢复。 <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></ul></section></section>