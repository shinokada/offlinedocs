<!doctype html><html lang="cn"><meta charset="utf-8"><title>Vi</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="outline"content="deep"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="vi"><h1 id="vi">Vi</h1><p>Vitest 通过其 <code>vi</code> 辅助工具提供实用功能来帮助你。可以全局访问它（当启用 <a href="../config.html#globals">globals 配置</a> 时），也可以直接从 <code>vitest</code> 中导入：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span></code></pre><section class="level2"aria-labelledby="mock-modules"><h2 id="mock-modules">Mock Modules</h2><p>本节介绍在 <a href="/guide/mocking#modules">模拟模块</a> 时可以使用的 API。请注意，Vitest 不支持模拟使用 <code>require()</code> 导入的模块。<section class="level3"aria-labelledby="vimock"><h3 id="vimock">vi.mock</h3><ul><li><strong>类型</strong>: <code>(path: string, factory?: MockOptions | ((importOriginal: () => unknown) => unknown)) => void</code><li><strong>类型</strong>: <code>&#x3C;T>(path: Promise&#x3C;T>, factory?: MockOptions | ((importOriginal: () => T) => T | Promise&#x3C;T>)) => void</code></ul><p>用另一个模块替换提供的 <code>path</code> 中的所有导入模块。我们可以在路径内使用配置的 Vite 别名。对 <code>vi.mock</code> 的调用是悬挂式的，因此在何处调用并不重要。它总是在所有导入之前执行。如果需要在其作用域之外引用某些变量，可以在 <a href="/api/vi#vi-hoisted"><code>vi.hoisted</code></a>中定义它们，并在 <code>vi.mock</code> 中引用它们。<blockquote>`vi.mock` 仅对使用 `import` 关键字导入的模块有效。它对 `require` 无效。<p>为了提升 <code>vi.mock</code> ，Vitest 会静态分析文件。它会指出不能使用未直接从 <code>vitest</code> 软件包导入的 <code>vi</code> （例如，从某个实用程序文件导入）。使用 <code>vi.mock</code> 与从 <code>vitest</code> 导入的 <code>vi</code> 一起使用，或者启用 <a href="../config.html#globals"><code>globals</code></a> 配置选项。<p>Vitest 不会模拟 <a href="../config.html#setupfiles">setup file</a> 中导入的模块，因为这些模块在运行测试文件时已被缓存。我们可以在 <a href="#vi-hoisted"><code>vi.hoisted</code></a> 中调用 <a href="#vi-resetmodules"><code>vi.resetModules()</code></a> ，在运行测试文件前清除所有模块缓存。</blockquote><p>如果定义了 <code>factory</code> 函数，所有导入都将返回其结果。Vitest 只调用一次 factory，并缓存所有后续导入的结果，直到 <a href="#vi-unmock"><code>vi.unmock</code></a> 或 <a href="#vi-dounmock"><code>vi.doUnmock</code></a> 被调用。<p>与 <code>jest</code> 不同，工厂可以是异步的。你可以使用 <a href="#vi-importactual"><code>vi.importActual</code></a>，或将工厂作为第一个参数传递的助手，并在其中获取原始模块。<p>自 Vitest 2.1 起，您也可以用 <code>spy</code> 属性代替工厂函数来提供对象。如果 <code>spy</code> 属性为 <code>true</code>，Vitest 会像往常一样自动锁定模块，但不会覆盖导出的实现。如果您只想断言导出的方法被另一个方法正确调用，这将非常有用。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> calculator <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./src/calculator.ts'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./src/calculator.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> spy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// calls the original implementation,</span>
<span class="token comment">// but allows asserting the behaviour later</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">calculator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturned</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><p>Vitest 还在 <code>vi.mock</code> 和 <code>vi.doMock</code> 方法中支持 module promise 而非字符串，以获得更好的集成开发环境支持。当文件被移动时，路径会被更新，<code>importOriginal</code> 也会自动继承类型。使用此签名还将强制工厂返回类型与原始模块兼容（但每次导出都是可选的）。<pre class="language-ts"><code class="language-ts"><span class="token comment">// @filename: ./path/to/module.js</span>
<span class="token keyword module">export</span> <span class="token keyword">declare</span> <span class="token keyword">function</span> <span class="token function">total</span><span class="token punctuation">(</span><span class="token spread operator">...</span>numbers<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span>
<span class="token comment">// @filename: test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token comment">// ---cut---</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>importOriginal<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">importOriginal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// type is inferred</span>
  <span class="token comment">//    ^?</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token spread operator">...</span>mod<span class="token punctuation">,</span>
    <span class="token comment">// replace some exports</span>
    total<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>在此钩子下，Vitest 仍然对字符串而不是模块对象进行操作。<p>如果你使用的 TypeScript 在 <code>tsconfig.json</code> 中配置了 <code>paths</code> 别名，编译器将无法正确解析导入类型。 为了使其正常工作，请确保将所有别名导入替换为相应的相对路径。 例如，使用 <code>import('./path/to/module.js')</code>，而不是 <code>import('@/module')</code>。<blockquote>`vi.mock` 被提升（换句话说，_移动_）到**文件的顶部**。这意味着无论何时写入它（无论是在 `beforeEach` 还是 `test`），它都会在此之前被调用。<p>这也意味着不能在 factory 内部使用任何在 factory 外部定义的变量。<p>如果需要在 factory 内部使用变量，请尝试 <a href="#vi-domock"><code>vi.doMock</code></a> 。它以同样的方式工作，但不会被吊起。请注意，它只能模拟后续的导入。<p>如果在 <code>vi.mock</code> 之前声明了 <code>vi.hoisted</code> 方法，也可以引用该方法定义的变量：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> namedExport <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./path/to/module.js'</span>

<span class="token keyword">const</span> mocks <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    namedExport<span class="token operator">:</span> mocks<span class="token punctuation">.</span><span class="token property-access">namedExport</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>namedExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">namedExport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>namedExport<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>mocks<span class="token punctuation">.</span><span class="token property-access">namedExport</span><span class="token punctuation">)</span></code></pre></blockquote><blockquote>如果我们模拟的模块有默认导出，则需要在返回的工厂函数对象中提供一个 `default` 键。这是 ES 模块特有的注意事项；因此，由于 `jest` 使用 CommonJS 模块，`jest` 文档可能会有所不同。例如：<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
    <span class="token keyword module">default</span><span class="token operator">:</span> <span class="token punctuation">{</span> myDefaultKey<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    namedExport<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// etc...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></blockquote>如果要模拟的文件旁边有一个 `__mocks__` 文件夹，且没有提供工厂，Vitest 将尝试在 `__mocks__` 子文件夹中找到一个同名文件，并将其作为实际模块使用。如果模拟的是依赖关系，Vitest 会尝试在项目的 [root](../config.html#root)（默认为 `process.cwd()` ）中找到 `__mocks__` 文件夹。我们可以通过 [`deps.moduleDirectories`](../config.html#deps-moduledirectories) 配置选项告诉 Vitest 依赖项的位置。<p>例如，我们有这样的文件结构：<pre class="language-text"><code class="language-text">- __mocks__
  - axios.js
- src
  __mocks__
    - increment.js
  - increment.js
- tests
  - increment.test.js</code></pre><p>如果在没有提供工厂或选项的测试文件中调用 <code>vi.mock</code> ，它会在 <code>__mocks__</code> 文件夹中找到一个文件作为模块使用：<pre class="language-ts"><code class="language-ts"><span class="token comment">// increment.test.js</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// axios is a default export from `__mocks__/axios.js`</span>
<span class="token keyword module">import</span> <span class="token imports">axios</span> <span class="token keyword module">from</span> <span class="token string">'axios'</span>

<span class="token comment">// increment is a named export from `src/__mocks__/increment.js`</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../increment.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'../increment.js'</span><span class="token punctuation">)</span>

axios<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/apples/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span></code></pre><blockquote><p>请注意，如果不调用 <code>vi.mock</code> ，模块<strong>不会</strong>被自动模拟。要复制 Jest 的自动锁定行为，可以在 <a href="../config.html#setupfiles"><code>setupFiles</code></a> 中为每个所需的模块调用 <code>vi.mock</code> 。</blockquote><p>如果没有提供 <code>__mocks__</code> 文件夹或工厂，Vitest 将导入原始模块并自动模拟其所有输出。有关应用的规则，请参阅<a href="/guide/mocking#%E6%A8%A1%E5%9D%97">模块</a>。</section><section class="level3"aria-labelledby="vidomock"><h3 id="vidomock">vi.doMock</h3><ul><li><strong>类型</strong>: <code>(path: string, factory?: MockOptions | ((importOriginal: () => unknown) => unknown)) => void</code><li><strong>类型</strong>: <code>&#x3C;T>(path: Promise&#x3C;T>, factory?: MockOptions | ((importOriginal: () => T) => T | Promise&#x3C;T>)) => void</code></ul><p>与 <a href="#vi-mock"><code>vi.mock</code></a> 相同，但它不会被移动到文件顶部，因此我们可以引用全局文件作用域中的变量。模块的下一个 <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/import">dynamic import</a> 将被模拟。<blockquote>这将不会模拟在调用此调用之前导入的模块。不要忘记，ESM 中的所有静态导入都是 [hoaded](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/import#hoisting)，因此在静态导入前调用此调用不会强制在导入前调用：<pre class="language-ts"><code class="language-ts"><span class="token comment">// this will be called _after_ the import statement</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">doMock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span></code></pre></blockquote><pre class="language-ts"><code class="language-ts"><span class="token comment">// ./increment.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token builtin">number</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> beforeEach<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>

<span class="token comment">// the module is not mocked, because vi.doMock is not called yet</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span>

<span class="token keyword">let</span> mockedIncrement <span class="token operator">=</span> <span class="token number">100</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// you can access variables inside a factory</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">doMock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token operator">++</span>mockedIncrement <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'importing the next module imports mocked one'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// original import WAS NOT MOCKED, because vi.doMock is evaluated AFTER imports</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> increment<span class="token operator">:</span> mockedIncrement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>
  <span class="token comment">// new dynamic import returns mocked module</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">mockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="vimocked"><h3 id="vimocked">vi.mocked</h3><ul><li><strong>类型</strong>: <code>&#x3C;T>(obj: T, deep?: boolean) => MaybeMockedDeep&#x3C;T></code><li><strong>类型</strong>: <code>&#x3C;T>(obj: T, options?: { partial?: boolean; deep?: boolean }) => MaybePartiallyMockedDeep&#x3C;T></code></ul><p>TypeScript 的类型助手。只返回传入的对象。<p>当 <code>partial</code> 为 <code>true</code> 时，它将期望一个 <code>Partial&#x3C;T></code> 作为返回值。默认情况下，这只会让 TypeScript 认为第一层的值是模拟的。我们可以将 <code>{ deep: true }</code> 作为第二个参数传递给 TypeScript，告诉它整个对象都是模拟的（如果实际上是的话）。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports">example</span> <span class="token keyword module">from</span> <span class="token string">'./example.js'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'1 + 1 equals 10'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">mocked</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token property-access">calc</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>example<span class="token punctuation">.</span><span class="token method function property-access">calc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viimportactual"><h3 id="viimportactual">vi.importActual</h3><ul><li><strong>类型</strong>: <code>&#x3C;T>(path: string) => Promise&#x3C;T></code></ul><p>导入模块，绕过模块是否应被模拟的所有检查。如果我们想部分模拟模块，这一点很有用。<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">importActual</span><span class="token punctuation">(</span><span class="token string">'./example.js'</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span>axios<span class="token punctuation">,</span> get<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viimportmock"><h3 id="viimportmock">vi.importMock</h3><ul><li><strong>类型</strong>: <code>&#x3C;T>(path: string) => Promise&#x3C;MaybeMockedDeep&#x3C;T>></code></ul><p>导入模块并模拟其所有属性（包括嵌套属性）。遵循与 <a href="#vi-mock"><code>vi.mock</code></a> 相同的规则。有关应用的规则，请参阅<a href="/guide/mocking#%E6%A8%A1%E5%9D%97">模块</a>。</section><section class="level3"aria-labelledby="viunmock"><h3 id="viunmock">vi.unmock</h3><ul><li><strong>类型</strong>: <code>(path: string | Promise&#x3C;Module>) => void</code></ul><p>从模拟注册表中删除模块。所有导入调用都将返回原始模块，即使该模块之前已被模拟。该调用会被移动到文件顶端，因此只会解除在 <code>setupFiles</code> 中定义的模块。</section><section class="level3"aria-labelledby="vidounmock"><h3 id="vidounmock">vi.doUnmock</h3><ul><li><strong>类型</strong>: <code>(path: string | Promise&#x3C;Module>) => void</code></ul><p>与 <a href="#vi-unmock"><code>vi.unmock</code></a> 相同，但不会移动到文件顶端。下一次导入模块时，将导入原始模块而非 mock。这不会解除先前导入的模块。<pre class="language-ts"><code class="language-ts"><span class="token comment">// ./increment.js</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token builtin">number</span> <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span></code></pre><pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> increment <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./increment.js'</span>

<span class="token comment">// increment is already mocked, because vi.mock is hoisted</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// this is hoisted, and factory is called before the import on line 1</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">increment</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// all calls are mocked, and `increment` always returns 100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// this is not hoisted, so other import will return unmocked module</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">doUnmock</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>

<span class="token comment">// this STILL returns 100, because `vi.doUnmock` doesn't reevaluate a module</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token function">increment</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">100</span>

<span class="token comment">// the next import is unmocked, now `increment` is the original function that returns count + 1</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> increment<span class="token operator">:</span> unmockedIncrement <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./increment.js'</span><span class="token punctuation">)</span>

<span class="token function">unmockedIncrement</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span>
<span class="token function">unmockedIncrement</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">31</span></code></pre></section><section class="level3"aria-labelledby="viresetmodules"><h3 id="viresetmodules">vi.resetModules</h3><ul><li><strong>类型</strong>: <code>() => Vitest</code></ul><p>通过清除所有模块的缓存来重置模块注册表。这样就可以在重新导入模块时对模块进行重新评估。顶层导入无法重新评估。这可能有助于隔离测试之间存在本地状态冲突的模块。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./data.js'</span> <span class="token comment">// Will not get reevaluated beforeEach test</span>

<span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  vi<span class="token punctuation">.</span><span class="token method function property-access">resetModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'change state'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some/path.js'</span><span class="token punctuation">)</span> <span class="token comment">// Will get reevaluated</span>
  mod<span class="token punctuation">.</span><span class="token method function property-access">changeLocalState</span><span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token method function property-access">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'new value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'module has old state'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mod <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./some/path.js'</span><span class="token punctuation">)</span> <span class="token comment">// Will get reevaluated</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span><span class="token method function property-access">getLocalState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token string">'old value'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>不会重置 mock 注册表。要清除 mock 注册表，请使用 [`vi.unmock`](#vi-unmock) 或 [`vi.doUnmock`](#vi-dounmock) 。</blockquote></section><section class="level3"aria-labelledby="vidynamicimportsettled"><h3 id="vidynamicimportsettled">vi.dynamicImportSettled</h3><p>等待加载所有导入模块。如果有同步调用开始导入一个模块，而如果不这样做就无法等待，那么它就很有用。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// cannot track import because Promise is not returned</span>
<span class="token keyword">function</span> <span class="token function">renderComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword module">import</span><span class="token punctuation">(</span><span class="token string">'./component.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> render <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'operations are resolved'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">renderComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">dynamicImportSettled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">'.component'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">not</span><span class="token punctuation">.</span><span class="token method function property-access">toBeNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote>如果在动态导入过程中又启动了另一个动态导入，则该方法将等待直到所有动态导入都解决为止。<p>该方法还将在导入解析后等待下一个 <code>setTimeout</code> 跟他挂钩，因此所有同步操作都应在解析时完成。</blockquote></section></section><section class="level2"aria-labelledby="模拟函数和对象"><h2 id="模拟函数和对象">模拟函数和对象</h2><p>本节介绍如何使用 <a href="/api/mock">method mock</a> 替换环境变量和全局变量。<section class="level3"aria-labelledby="vifn"><h3 id="vifn">vi.fn</h3><ul><li><strong>类型:</strong> <code>(fn?: Function) => Mock</code></ul><p>创建函数的监视程序，但也可以不创建监视程序。每次调用函数时，它都会存储调用参数、返回值和实例。此外，我们还可以使用 <a href="/api/mock">methods</a> 操纵它的行为。 如果没有给出函数，调用 mock 时将返回 <code>undefined</code>。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> getApples <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token function">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturnedWith</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

getApples<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>getApples<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveNthReturnedWith</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viismockfunction"><h3 id="viismockfunction">vi.isMockFunction</h3><ul><li><strong>类型:</strong> <code>(fn: Function) => boolean</code></ul><p>检查给定参数是否为 mock 函数。如果使用的是 TypeScript ，它还会缩小参数类型的范围。</section><section class="level3"aria-labelledby="viclearallmocks"><h3 id="viclearallmocks">vi.clearAllMocks</h3><p>将对所有 监听(spies) 调用 <a href="/api/mock#mockclear"><code>.mockClear()</code></a>。这将清除 mock 历史记录，但不会将其重置为默认实现。</section><section class="level3"aria-labelledby="viresetallmocks"><h3 id="viresetallmocks">vi.resetAllMocks</h3><p>将对所有 监听(spies) 调用 <a href="/api/mock#mockreset"><code>.mockReset()</code></a>。这将清除 mock 历史记录，并将其重置为空函数（将返回 <code>undefined</code> ）。</section><section class="level3"aria-labelledby="virestoreallmocks"><h3 id="virestoreallmocks">vi.restoreAllMocks</h3><p>将对所有 监听(spies) 调用 <a href="/api/mock#mockrestore"><code>.mockRestore()</code></a>。这将清除 mock 的历史记录，并将其重置为原来的实现。</section><section class="level3"aria-labelledby="vispyon"><h3 id="vispyon">vi.spyOn</h3><ul><li><strong>类型:</strong> <code>&#x3C;T, K extends keyof T>(object: T, method: K, accessType?: 'get' | 'set') => MockInstance</code></ul><p>创建与 <a href="#vi-fn"><code>vi.fn()</code></a> 类似的对象的方法或 getter/setter 的监听(spy) 。它会返回一个 <a href="/api/mock">mock 函数</a> 。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> apples <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> cart <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">42</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> apples<span class="token punctuation">)</span>
apples <span class="token operator">=</span> <span class="token number">1</span>

<span class="token function">expect</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>spy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturnedWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></code></pre><blockquote>你可以在 [`afterEach`](../api.html#aftereach)（或启用 [`test.restoreMocks`](../config.html#restoreMocks) ）中调用 [`vi.restoreAllMocks`](#vi-restoreallmocks) ，将所有方法还原为原始实现。这将还原原始的 [object descriptor](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty) ，因此无法更改方法的实现：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> cart <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">42</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> spy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>cart<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 10</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">restoreAllMocks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 42</span>
spy<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>cart<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// still 42!</span></code></pre></blockquote><blockquote>在[浏览器模式](/guide/browser/)下，无法监视导出的方法。相反，你可以通过调用 `vi.mock("./file-path.js", { spy: true })` 来监视每个导出方法。这将模拟每个导出方法，但保留其完整的实现，从而可以断言该方法是否被正确调用。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> calculator <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./src/calculator.ts'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./src/calculator.ts'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> spy<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">calculator</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span>calculator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveReturned</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span></code></pre><p>虽然有可能在 <code>jsdom</code> 或其他 Node.js 环境中监视导出，但未来可能会发生变化。</blockquote></section><section class="level3"aria-labelledby="vi-stubenv"><h3 id="vi-stubenv">vi.stubEnv</h3><ul><li><strong>类型:</strong> <code>&#x3C;T extends string>(name: T, value: T extends "PROD" | "DEV" | "SSR" ? boolean : string | undefined) => Vitest</code></ul><p>更改 <code>process.env</code> 和 <code>import.meta.env</code> 中环境变量的值。我们可以调用 <code>vi.unstubAllEnvs</code> 恢复其值。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `process.env.NODE_ENV` and `import.meta.env.NODE_ENV`</span>
<span class="token comment">// are "development" before calling "vi.stubEnv"</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token keyword nil">undefined</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>

<span class="token comment">// doesn't change other envs</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">===</span> <span class="token string">'development'</span></code></pre><blockquote>我们也可以通过简单赋值来更改值，但无法使用 `vi.unstubAllEnvs` 恢复以前的值：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">MODE</span> <span class="token operator">=</span> <span class="token string">'test'</span></code></pre></blockquote></section><section class="level3"aria-labelledby="vi-unstuballenvs"><h3 id="vi-unstuballenvs">vi.unstubAllEnvs</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>恢复通过 <code>vi.stubEnv</code> 更改的所有 <code>import.meta.env</code> 和 <code>process.env</code> 值。首次调用时，Vitest 会记住并保存原始值，直到再次调用 <code>unstubAllEnvs</code>。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `process.env.NODE_ENV` and `import.meta.env.NODE_ENV`</span>
<span class="token comment">// are "development" before calling stubEnv</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubEnv</span><span class="token punctuation">(</span><span class="token string">'NODE_ENV'</span><span class="token punctuation">,</span> <span class="token string">'staging'</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'staging'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'staging'</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">unstubAllEnvs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// restores to the value that were stored before the first "stubEnv" call</span>
process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
<span class="token keyword module">import</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span></code></pre></section><section class="level3"aria-labelledby="vistubglobal"><h3 id="vistubglobal">vi.stubGlobal</h3><ul><li><strong>类型:</strong> <code>(name: string | number | symbol, value: unknown) => Vitest</code></ul><p>更改全局变量的值。我们可以调用 <code>vi.unstubAllGlobals</code> 恢复其原始值。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token comment">// `innerWidth` is "0" before calling stubGlobal</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'innerWidth'</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

innerWidth <span class="token operator">===</span> <span class="token number">100</span>
globalThis<span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">===</span> <span class="token number">100</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">===</span> <span class="token number">100</span></code></pre><blockquote>我们也可以通过简单地将其赋值给 `globalThis` 或 `window`（如果我们使用的是 `jsdom` 或 `happy-dom` 环境）来更改该值，但无法使用 `vi.unstubAllGlobals` 恢复原始值：<pre class="language-ts"><code class="language-ts">globalThis<span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">=</span> <span class="token number">100</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access">innerWidth</span> <span class="token operator">=</span> <span class="token number">100</span></code></pre></blockquote></section><section class="level3"aria-labelledby="vi-unstuballglobals"><h3 id="vi-unstuballglobals">vi.unstubAllGlobals</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>恢复 <code>globalThis</code> / <code>global</code>（和 <code>window</code> / <code>top</code> / <code>self</code> / <code>parent</code>，如果我们使用的是 <code>jsdom</code> 或 <code>happy-dom</code> 环境）上所有被 <code>vi.stubGlobal</code> 更改过的全局值。第一次调用时，Vitest 会记住并保存原始值，直到再次调用 <code>unstubAllGlobals</code>。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">Mock</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// IntersectionObserver is "undefined" before calling "stubGlobal"</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">stubGlobal</span><span class="token punctuation">(</span><span class="token string">'IntersectionObserver'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Mock</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
global<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
globalThis<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>
<span class="token comment">// if you are using jsdom or happy-dom</span>
<span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token maybe-class-name">Mock</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">unstubAllGlobals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

globalThis<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">IntersectionObserver</span></span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span>
<span class="token string">'IntersectionObserver'</span> <span class="token keyword">in</span> globalThis <span class="token operator">===</span> <span class="token boolean">false</span>
<span class="token comment">// throws ReferenceError, because it's not defined</span>
<span class="token maybe-class-name">IntersectionObserver</span> <span class="token operator">===</span> <span class="token keyword nil">undefined</span></code></pre></section></section><section class="level2"aria-labelledby="fake-timers"><h2 id="fake-timers">Fake Timers</h2><p>本节介绍如何使用 <a href="/guide/mocking#%E8%AE%A1%E6%97%B6%E5%99%A8">fake timers</a> 。<section class="level3"aria-labelledby="viadvancetimersbytime"><h3 id="viadvancetimersbytime">vi.advanceTimersByTime</h3><ul><li><strong>类型:</strong> <code>(ms: number) => Vitest</code></ul><p>该方法将调用每个启动的定时器，直到超过指定的毫秒数或队列为空（以先到者为准）。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTime</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span>
<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimersbytimeasync"><h3 id="viadvancetimersbytimeasync">vi.advanceTimersByTimeAsync</h3><ul><li><strong>类型:</strong> <code>(ms: number) => Promise&#x3C;Vitest></code></ul><p>该方法将调用每个已启动的定时器，直到超过指定的毫秒数或队列为空（以先到者为准）。这将包括异步设置的计时器。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersByTimeAsync</span><span class="token punctuation">(</span><span class="token number">150</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span>
<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimerstonexttimer"><h3 id="viadvancetimerstonexttimer">vi.advanceTimersToNextTimer</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>将调用下一个可用的定时器。在每次调用定时器之间进行断言非常有用。我们可以调用它来管理自己的定时器。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 1</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 2</span>
  <span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimerstonexttimerasync"><h3 id="viadvancetimerstonexttimerasync">vi.advanceTimersToNextTimerAsync</h3><ul><li><strong>类型:</strong> <code>() => Promise&#x3C;Vitest></code></ul><p>如果定时器是异步设置的，则会调用下一个可用的定时器并等待解决。在每次调用定时器之间进行断言非常有用。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 1</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token property-access">log</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 2</span>
<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextTimerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="viadvancetimerstonextframe-210-vi-advancetimerstonextframe"><h3 id="viadvancetimerstonextframe-210-vi-advancetimerstonextframe">vi.advanceTimersToNextFrame<version>2.1.0</version>{#vi-advancetimerstonextframe}</h3><ul><li><strong>Type:</strong> <code>() => Vitest</code></ul><p>Similar to <a href="https://vitest.dev/api/vi#vi-advancetimersbytime"><code>vi.advanceTimersByTime</code></a>, but will advance timers by the milliseconds needed to execute callbacks currently scheduled with <code>requestAnimationFrame</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> frameRendered <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  frameRendered <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">advanceTimersToNextFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span>frameRendered<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="vigettimercount"><h3 id="vigettimercount">vi.getTimerCount</h3><ul><li><strong>类型:</strong> <code>() => number</code></ul><p>获取等待计时器的数量。</section><section class="level3"aria-labelledby="viclearalltimers"><h3 id="viclearalltimers">vi.clearAllTimers</h3><p>删除所有计划运行的计时器。这些定时器今后将不再运行。</section><section class="level3"aria-labelledby="vigetmockedsystemtime"><h3 id="vigetmockedsystemtime">vi.getMockedSystemTime</h3><ul><li><strong>类型</strong>: <code>() => Date | null</code></ul><p>返回使用 <code>setSystemTime</code> 设置的模拟当前日期。如果没有模拟日期，该方法将返回 <code>null</code> 。</section><section class="level3"aria-labelledby="vigetrealsystemtime"><h3 id="vigetrealsystemtime">vi.getRealSystemTime</h3><ul><li><strong>类型</strong>: <code>() => number</code></ul><p>使用 <code>vi.useFakeTimers</code> 时，会模拟 <code>Date.now</code> 调用。如果需要以毫秒为单位获取实时时间，可以调用此函数。</section><section class="level3"aria-labelledby="virunallticks"><h3 id="virunallticks">vi.runAllTicks</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>调用由 <code>process.nextTick</code> 排在队列中的每个微任务。这也将运行所有自己安排的微任务。</section><section class="level3"aria-labelledby="virunalltimers"><h3 id="virunalltimers">vi.runAllTimers</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>该方法将调用每个已经启动的定时器，直到定时器队列为空。这意味着在 <code>runAllTimers</code> 期间调用的每个定时器都会被触发。如果时间间隔为无限，则会在尝试 10000 次后触发（可使用 <a href="../config.html#faketimers-looplimit"><code>fakeTimers.loopLimit</code></a> 进行配置）。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span>
<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span></code></pre></section><section class="level3"aria-labelledby="virunalltimersasync"><h3 id="virunalltimersasync">vi.runAllTimersAsync</h3><ul><li><strong>类型:</strong> <code>() => Promise&#x3C;Vitest></code></ul><p>该方法将异步调用每个已启动的定时器，直到定时器队列为空。这意味着在 <code>runAllTimersAsync</code> 期间调用的每个定时器都会被触发，即使是异步定时器。如果我们有一个无限的时间间隔、 会在尝试 10000 次后抛出（可使用 <a href="../config.html#faketimers-looplimit"><code>fakeTimers.loopLimit</code></a> ）。<pre class="language-ts"><code class="language-ts"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">runAllTimersAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: result</span></code></pre></section><section class="level3"aria-labelledby="virunonlypendingtimers"><h3 id="virunonlypendingtimers">vi.runOnlyPendingTimers</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>此方法将调用 <a href="#vii-usefaketimers"><code>vi.useFakeTimers</code></a> 调用后启动的所有计时器。它不会调用在调用期间启动的任何计时器。<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: 1</span></code></pre></section><section class="level3"aria-labelledby="virunonlypendingtimersasync"><h3 id="virunonlypendingtimersasync">vi.runOnlyPendingTimersAsync</h3><ul><li><strong>类型:</strong> <code>() => Promise&#x3C;Vitest></code></ul><p>此方法将异步调用 <a href="#vi-usefaketimers"><code>vi.useFakeTimers</code></a> 调用后启动的每个定时器，即使是异步定时器。它不会触发任何在调用期间启动的定时器。<pre class="language-ts"><code class="language-ts"><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">runOnlyPendingTimersAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// log: 2</span>
<span class="token comment">// log: 3</span>
<span class="token comment">// log: 3</span>
<span class="token comment">// log: 1</span></code></pre></section><section class="level3"aria-labelledby="visetsystemtime"><h3 id="visetsystemtime">vi.setSystemTime</h3><ul><li><strong>类型</strong>: <code>(date: string | number | Date) => void</code></ul><p>如果启用了伪计时器，此方法将模拟用户更改系统时钟（将影响与日期相关的 API，如 <code>hrtime</code> 、<code>performance.now</code> 或 <code>new Date()</code> ），但不会触发任何计时器。如果未启用假定时器，该方法将仅模拟 <code>Date.*</code> 调用。<p>如果我们需要测试任何依赖于当前日期的内容 -- 例如在代码中调用 <a href="https://github.com/moment/luxon/">luxon</a> --则非常有用。<p>接受与 <code>Date</code> 相同的字符串和数字参数。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">1998</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
vi<span class="token punctuation">.</span><span class="token method function property-access">setSystemTime</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>

<span class="token function">expect</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>date<span class="token punctuation">.</span><span class="token method function property-access">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">useRealTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viusefaketimers"><h3 id="viusefaketimers">vi.useFakeTimers</h3><ul><li><strong>类型:</strong> <code>(config?: FakeTimerInstallOpts) => Vitest</code></ul><p>要启用模拟定时器，需要调用此方法。在调用 <a href="#vi-userealtimers"><code>vi.useRealTimers()</code></a> 之前，它将封装所有对定时器的进一步调用（如 <code>setTimeout</code> 、<code>setInterval</code> 、<code>clearTimeout</code> 、<code>clearInterval</code> 、<code>setImmediate</code> 、<code>clearImmediate</code> 和 <code>Date</code>）。<p>在 <code>node:child_process</code> 中使用 <code>--pool=forks</code> 运行 Vitest 时，不支持模拟 <code>nextTick</code> 。NodeJS 在 <code>node:child_process</code> 中内部使用了 <code>process.nextTick</code> ，当模拟它时会挂起。使用 <code>--pool=threads</code> 运行 Vitest 时支持模拟 <code>nextTick</code>。<p>内部实现基于 <a href="https://github.com/sinonjs/fake-timers"><code>@sinonjs/fake-timers</code></a> 。<blockquote>`vi.useFakeTimers()` 不再自动模拟 `process.nextTick` 。 仍然可以通过在 `toFake` 参数中指定选项来模拟： `vi.useFakeTimers({ toFake: ['nextTick'] })` 。</blockquote></section><section class="level3"aria-labelledby="vi-isfaketimers"><h3 id="vi-isfaketimers">vi.isFakeTimers</h3><ul><li><strong>类型:</strong> <code>() => boolean</code></ul><p>如果启用了假计时器，则返回 <code>true</code> 。</section><section class="level3"aria-labelledby="viuserealtimers"><h3 id="viuserealtimers">vi.useRealTimers</h3><ul><li><strong>类型:</strong> <code>() => Vitest</code></ul><p>定时器用完后，可以调用此方法将模拟的定时器返回到其原始实现。之前调度的所有计时器都将被丢弃。</section></section><section class="level2"aria-labelledby="miscellaneous"><h2 id="miscellaneous">Miscellaneous</h2><p>Vitest 提供的一组有用的辅助函数。<section class="level3"aria-labelledby="vi-waitfor"><h3 id="vi-waitfor">vi.waitFor</h3><ul><li><strong>类型:</strong> <code>&#x3C;T>(callback: WaitForCallback&#x3C;T>, options?: number | WaitForOptions) => Promise&#x3C;T></code></ul><p>等待回调成功执行。如果回调抛出错误或返回拒绝的承诺，它将继续等待，直到成功或超时。<p>这在需要等待某些异步操作完成时非常有用，例如，在启动服务器并需要等待其启动时。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createServer <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./server.js'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Server started successfully'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">waitFor</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span><span class="token property-access">isReady</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Server not started'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Server started'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      timeout<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// default is 1000</span>
      interval<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// default is 50</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token property-access">isReady</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>它也适用于异步回调。<pre class="language-ts"><code class="language-ts"><span class="token comment">// @vitest-environment jsdom</span>

<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getDOMElementAsync<span class="token punctuation">,</span> populateDOMAsync <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./dom.js'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Element exists in a DOM'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token comment">// start populating DOM</span>
  <span class="token function">populateDOMAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">waitFor</span><span class="token punctuation">(</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token comment">// try to get the element until it exists</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword control-flow">await</span> <span class="token function">getDOMElementAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">HTMLElement</span> <span class="token operator">|</span> <span class="token keyword null nil">null</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token property-access">dataset</span><span class="token punctuation">.</span><span class="token property-access">initialized</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword control-flow">return</span> element
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      timeout<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// default is 1000</span>
      interval<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// default is 50</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeInstanceOf</span><span class="token punctuation">(</span><span class="token maybe-class-name">HTMLElement</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>如果使用了 <code>vi.useFakeTimers</code> , <code>vi.waitFor</code> 会在每次检查回调中自动调用 <code>vi.advanceTimersByTime(interval)</code> 。</section><section class="level3"aria-labelledby="viwaituntil"><h3 id="viwaituntil">vi.waitUntil</h3><ul><li><strong>类型:</strong> <code>&#x3C;T>(callback: WaitUntilCallback&#x3C;T>, options?: number | WaitUntilOptions) => Promise&#x3C;T></code></ul><p>这与 <code>vi.waitFor</code> 类似，但如果回调抛出任何错误，执行将立即中断并收到一条错误信息。如果回调返回虚假值(falsy) ，下一次检查将继续，直到返回真实值(truthy) 。这在需要等待某项内容存在后再执行下一步时非常有用。<p>请看下面的示例。我们可以使用 <code>vi.waitUntil</code> 等待元素出现在页面上，然后对元素进行操作。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> test<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'Element render correctly'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">waitUntil</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">'.element'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    timeout<span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token comment">// default is 1000</span>
    interval<span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token comment">// default is 50</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// do something with the element</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">'.element-child'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBeTruthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="vi-hoisted"><h3 id="vi-hoisted">vi.hoisted</h3><ul><li><strong>类型</strong>: <code>&#x3C;T>(factory: () => T) => T</code></ul><p>ES 模块中的所有静态 <code>import</code> 语句都被提升到文件顶部，因此在导入之前定义的任何代码都将在导入评估之后执行。<p>不过，在导入模块之前，调用一些副作用（如模拟日期）可能会很有用。<p>要绕过这一限制，可以像这样将静态导入重写为动态导入：<pre class="language-diff"><code class="language-diff">callFunctionWithSideEffect()
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> import { value } from './some/module.js'
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const { value } = await import('./some/module.js')</span></span></code></pre><p>运行 <code>vitest</code> 时，可以使用 <code>vi.hoisted</code> 方法自动完成此操作。<pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> callFunctionWithSideEffect()
</span></span>import { value } from './some/module.js'
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> vi.hoisted(() => callFunctionWithSideEffect())</span></span></code></pre><p>该方法返回从工厂返回的值。 如果我们需要轻松访问本地定义的变量，可以在我们的 <code>vi.mock</code> 工厂中使用该值：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> expect<span class="token punctuation">,</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> originalMethod <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./path/to/module.js'</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> mockedMethod <span class="token punctuation">}</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> mockedMethod<span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

vi<span class="token punctuation">.</span><span class="token method function property-access">mock</span><span class="token punctuation">(</span><span class="token string">'./path/to/module.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> originalMethod<span class="token operator">:</span> mockedMethod <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

mockedMethod<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
<span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">originalMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span></code></pre><p>请注意，即使我们的环境不支持顶级等待，也可以异步调用此方法：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> promised <span class="token operator">=</span> <span class="token keyword control-flow">await</span> vi<span class="token punctuation">.</span><span class="token method function property-access">hoisted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://jsonplaceholder.typicode.com/posts'</span><span class="token punctuation">)</span>
  <span class="token keyword control-flow">return</span> response<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="visetconfig"><h3 id="visetconfig">vi.setConfig</h3><ul><li><strong>类型</strong>: <code>RuntimeConfig</code></ul><p>更新当前测试文件的配置。此方法只会影响当前测试文件的配置选项：<pre class="language-ts"><code class="language-ts">vi<span class="token punctuation">.</span><span class="token method function property-access">setConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  allowOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  testTimeout<span class="token operator">:</span> <span class="token number">10_000</span><span class="token punctuation">,</span>
  hookTimeout<span class="token operator">:</span> <span class="token number">10_000</span><span class="token punctuation">,</span>
  clearMocks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  restoreMocks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  fakeTimers<span class="token operator">:</span> <span class="token punctuation">{</span>
    now<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token number">2021</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// supports the whole object</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  maxConcurrency<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  sequence<span class="token operator">:</span> <span class="token punctuation">{</span>
    hooks<span class="token operator">:</span> <span class="token string">'stack'</span><span class="token punctuation">,</span>
    <span class="token comment">// supports only "sequence.hooks"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level3"aria-labelledby="viresetconfig"><h3 id="viresetconfig">vi.resetConfig</h3><ul><li><strong>类型</strong>: <code>RuntimeConfig</code></ul><p>如果之前调用过 <a href="#vi-setconfig"><code>vi.setConfig</code></a> ，则会将配置重置为原始状态。 <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>