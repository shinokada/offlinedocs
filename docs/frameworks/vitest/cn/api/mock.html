<!doctype html><html lang="cn"><meta charset="utf-8"><title>Mock Functions</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="mock-functions"><h1 id="mock-functions">Mock Functions</h1><p>你可以使用 <code>vi.fn</code> 方法创建一个间谍函数（mock）来跟踪其执行。如果要跟踪已创建对象上的方法，可以使用 <code>vi.spyOn</code> 方法：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token punctuation">[</span><span class="token string">'hello world'</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> market <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> getApplesSpy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>market<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span>
market<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
getApplesSpy<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">1</span></code></pre><p>你应该在 <a href="/api/expect"><code>expect</code></a> 上使用间谍断言（例如，<a href="/api/expect#tohavebeencalled"><code>toHaveBeenCalled</code></a>）来断言间谍结果。此 API 参考描述了用于操纵间谍行为的可用属性和方法。<section class="level2"aria-labelledby="getmockname"><h2 id="getmockname">getMockName</h2><ul><li><p><strong>类型:</strong> <code>() => string</code><p>使用它返回给 mock 的名称，方法为 <code>.mockName(name)</code>。</ul></section><section class="level2"aria-labelledby="mockclear"><h2 id="mockclear">mockClear</h2><ul><li><p><strong>类型:</strong> <code>() => MockInstance</code><p>清除每次调用的所有信息。调用它后 <a href="#mock-calls"><code>spy.mock.calls</code></a>，<a href="#mock-results"><code>spy.mock.results</code></a>将返回空数组。如果你需要清理不同断言之间的间谍，这是有用的。<p>如果希望在每次测试之前自动调用此方法，可以在 config 中启用 <a href="../config.html#clearMocks"><code>clearMocks</code></a>设置。</ul></section><section class="level2"aria-labelledby="mockname"><h2 id="mockname">mockName</h2><ul><li><p><strong>类型:</strong> <code>(name: string) => MockInstance</code><p>设置内部模拟名称。有助于查看哪个 mock 未通过断言。</ul></section><section class="level2"aria-labelledby="mockimplementation"><h2 id="mockimplementation">mockImplementation</h2><ul><li><p><strong>类型:</strong> <code>(fn: Function) => MockInstance</code><p>接受一个将用作模拟实现的函数。<p>例如：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mockFn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span>apples <span class="token arrow operator">=></span> apples <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// or: vi.fn(apples => apples + 1);</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">NelliesBucket</span> <span class="token operator">=</span> <span class="token function">mockFn</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">BobsBucket</span> <span class="token operator">=</span> <span class="token function">mockFn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">NelliesBucket</span> <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">// true</span>
<span class="token maybe-class-name">BobsBucket</span> <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">// true</span>

mockFn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">// true</span>
mockFn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">// true</span></code></pre></ul></section><section class="level2"aria-labelledby="mockimplementationonce"><h2 id="mockimplementationonce">mockImplementationOnce</h2><ul><li><p><strong>类型:</strong> <code>(fn: Function) => MockInstance</code><p>接受一个函数，该函数将作为对被模拟函数的一次调用的模拟的实现。可以链式调用，以便多个函数产生不同的结果。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// false</span></code></pre><p>当模拟函数用完实现时，它将调用使用 <code>vi.fn(() => defaultValue)</code> 或者 <code>.mockImplementation(() => defaultValue)</code> 设置的默认实现（如果调用了它们）：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'default'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'second call'</span><span class="token punctuation">)</span>

<span class="token comment">// 'first call', 'second call', 'default', 'default'</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="withimplementation"><h2 id="withimplementation">withImplementation</h2><ul><li><p><strong>类型:</strong> <code>(fn: Function, callback: () => void) => MockInstance</code><li><p><strong>类型:</strong> <code>(fn: Function, callback: () => Promise&#x3C;unknown>) => Promise&#x3C;MockInstance></code><p>在执行回调时临时重写原始模拟实现。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'original'</span><span class="token punctuation">)</span>

myMockFn<span class="token punctuation">.</span><span class="token method function property-access">withImplementation</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'temp'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'temp'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'original'</span></code></pre><p>可以与异步回调一起使用。必须等待该方法之后才能使用原始实现。<pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'async callback'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'original'</span><span class="token punctuation">)</span>

  <span class="token comment">// We await this call since the callback is async</span>
  <span class="token keyword control-flow">await</span> myMockFn<span class="token punctuation">.</span><span class="token method function property-access">withImplementation</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'temp'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'temp'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'original'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>此外，它优先于 <a href="https://cn.vitest.dev/api/mock.html#mockimplementationonce"><code>mockImplementationOnce</code></a>。</ul></section><section class="level2"aria-labelledby="mockrejectedvalue"><h2 id="mockrejectedvalue">mockRejectedValue</h2><ul><li><p><strong>类型:</strong> <code>(value: any) => MockInstance</code><p>当调用异步函数时，接受一个将被拒绝的错误。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockRejectedValue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Async error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// throws "Async error"</span></code></pre></ul></section><section class="level2"aria-labelledby="mockrejectedvalueonce"><h2 id="mockrejectedvalueonce">mockRejectedValueOnce</h2><ul><li><p><strong>类型:</strong> <code>(value: any) => MockInstance</code><p>接受对模拟函数的一次调用将被拒绝的值。如果链接调用，则每次连续调用都将拒绝传递的值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockRejectedValueOnce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Async error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// first call</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// throws "Async error"</span></code></pre></ul></section><section class="level2"aria-labelledby="mockreset"><h2 id="mockreset">mockReset</h2><ul><li><p><strong>类型:</strong> <code>() => MockInstance</code><p>执行 <code>mockClear</code> 的操作，并使内部实现成为空函数（调用时返回 <code>undefined</code>）。当你想要将模拟完全重置回其初始状态时，这非常有用。<p>如果你希望在每次测试之前自动调用此方法，可以在配置中启用 <a href="../config.html#mockReset"><code>mockReset</code></a> 设置。</ul></section><section class="level2"aria-labelledby="mockrestore"><h2 id="mockrestore">mockRestore</h2><ul><li><p><strong>类型:</strong> <code>() => MockInstance</code><p>执行 <code>mockReset</code> 的操作，并将内部实现还原为原始函数。<p>请注意，从 <code>vi.fn()</code> 恢复 mock 会将实现设置为返回 <code>undefined</code> 的空函数。还原 <code>vi.fn(impl)</code> 将使实现还原为 <code>impl</code>。<p>如果你希望在每次测试之前自动调用此方法，可以在配置中启用 <a href="../config.html#restoreMocks"><code>restoreMocks</code></a> 设置。</ul></section><section class="level2"aria-labelledby="mockresolvedvalue"><h2 id="mockresolvedvalue">mockResolvedValue</h2><ul><li><p><strong>类型:</strong> <code>(value: any) => MockInstance</code><p>接受一个将在调用异步函数时解析的值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValue</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 43</span></code></pre></ul></section><section class="level2"aria-labelledby="mockresolvedvalueonce"><h2 id="mockresolvedvalueonce">mockResolvedValueOnce</h2><ul><li><p><strong>类型:</strong> <code>(value: any) => MockInstance</code><p>接受对模拟函数的一次调用将解析的值。如果链式调用，则每个连续调用都将解析传递的值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValue</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'second call'</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// first call</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// second call</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// default</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// default</span></code></pre></ul></section><section class="level2"aria-labelledby="mockreturnthis"><h2 id="mockreturnthis">mockReturnThis</h2><ul><li><p><strong>类型:</strong> <code>() => MockInstance</code><p>设置内部实现以返回 <code>this</code> 上下文。</ul></section><section class="level2"aria-labelledby="mockreturnvalue"><h2 id="mockreturnvalue">mockReturnValue</h2><ul><li><p><strong>类型:</strong> <code>(value: any) => MockInstance</code><p>接受一个当调用模拟函数时将返回的值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mock<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 42</span>
mock<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>
<span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 43</span></code></pre></ul></section><section class="level2"aria-labelledby="mockreturnvalueonce"><h2 id="mockreturnvalueonce">mockReturnValueOnce</h2><ul><li><p><strong>类型:</strong> <code>(value: any) => MockInstance</code><p>接受对模拟函数的一次调用将返回的值。如果链式调用，则每个连续调用都将返回传递的值。如果没有更多的 <code>mockReturnValueOnce</code> 值可供使用，请调用由 <code>mockImplementation</code> 或其他 <code>mockReturn*</code> 方法指定的函数。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token string">'second call'</span><span class="token punctuation">)</span>

<span class="token comment">// 'first call', 'second call', 'default', 'default'</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></ul></section><section class="level2"aria-labelledby="mockcalls"><h2 id="mockcalls">mock.calls</h2><p>这是一个包含每个调用的所有参数的数组。数组的元素是该调用的参数。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">)</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'arg3'</span><span class="token punctuation">,</span> <span class="token string">'arg4'</span><span class="token punctuation">)</span>

fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span>
  <span class="token operator">===</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// first call</span>
    <span class="token punctuation">[</span><span class="token string">'arg3'</span><span class="token punctuation">,</span> <span class="token string">'arg4'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// second call</span>
  <span class="token punctuation">]</span></code></pre></section><section class="level2"aria-labelledby="mocklastcall"><h2 id="mocklastcall">mock.lastCall</h2><p>这包含上次调用的参数。如果未调用 spy，将返回 <code>undefined</code>。</section><section class="level2"aria-labelledby="mockresults"><h2 id="mockresults">mock.results</h2><p>这是一个包含函数 <code>returned</code> 的所有值的数组。数组的元素是具有属性 <code>type</code> 和 <code>value</code> 的对象。可用类型包括：<ul><li><code>'return'</code> - 未发生异常的函数。<li><code>'throw'</code> - 抛出一个值的函数。</ul><p><code>value</code> 属性包含返回的值或引发的错误。如果函数返回了一个 promise ，当它解析时，<code>value</code> 属性将变成 promise 解析到的值。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// returned 'result'</span>

<span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// threw Error</span>
<span class="token punctuation">}</span>
<span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">results</span>
  <span class="token operator">===</span> <span class="token punctuation">[</span>
    <span class="token comment">// first result</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'return'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// last result</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'throw'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span></code></pre></section><section class="level2"aria-labelledby="mockinstances"><h2 id="mockinstances">mock.instances</h2><p>这是一个数组，包含使用 <code>new</code> 关键字调用模拟时实例化的所有实例。注意，这是函数的实际上下文（<code>this</code>），而不是返回值。<blockquote>如果 mock 是用 `new MyClass()` 实例化的，那么 `mock.instances` 将是一个具有一个值的数组：<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">MyClass</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">MyClass</span><span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">instances</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> a</code></pre><p>如果从构造函数返回值，它将不在 <code>instances</code> 数组中，而是在 <code>results</code> 中：<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">Spy</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">Spy</span><span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">instances</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> a
<span class="token maybe-class-name">Spy</span><span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">results</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> a</code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>