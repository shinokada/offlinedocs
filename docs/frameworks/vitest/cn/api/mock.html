<!doctype html><html lang="cn"><meta charset="utf-8"><title>Mock Functions</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="mock-functions"><h1 id="mock-functions">Mock Functions</h1><p>我们可以使用 <code>vi.fn</code> 方法创建一个 mock 函数来跟踪其执行情况。如果要跟踪已创建对象上的方法，可以使用 <code>vi.spyOn</code> 方法：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> vi <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>

<span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token punctuation">[</span><span class="token string">'hello world'</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> market <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">getApples</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token number">100</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> getApplesSpy <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>market<span class="token punctuation">,</span> <span class="token string">'getApples'</span><span class="token punctuation">)</span>
market<span class="token punctuation">.</span><span class="token method function property-access">getApples</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
getApplesSpy<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">===</span> <span class="token number">1</span></code></pre><p>我们应该在 <a href="/api/expect"><code>expect</code></a> 上使用 mock 断言（例如 <a href="/api/expect#tohavebeencalled"><code>toHaveBeenCalled</code></a> ）来断言 mock 结果。在这里我们介绍了用于操作 mock 行为的可用属性和方法。<section class="level2"aria-labelledby="getmockimplementation"><h2 id="getmockimplementation">getMockImplementation</h2><ul><li><strong>类型:</strong> <code>(...args: any) => any</code></ul><p>返回当前的模拟实现（如果有）。<p>如果使用 <a href="/api/vi#vi-fn"><code>vi.fn</code></a> 创建了 mock，它将把向下传递的方法视为 mock 实现。<p>如果使用 <a href="/api/vi#vi-spyon"><code>vi.spyOn</code></a> 创建了 mock，除非提供了自定义实现，否则将返回 <code>undefined</code> 。</section><section class="level2"aria-labelledby="getmockname"><h2 id="getmockname">getMockName</h2><ul><li><strong>类型:</strong> <code>() => string</code></ul><p>用它来返回使用方法 <code>.mockName(name)</code> 给 mock 的名称。</section><section class="level2"aria-labelledby="mockclear"><h2 id="mockclear">mockClear</h2><ul><li><strong>类型:</strong> <code>() => MockInstance</code></ul><p>清除每次调用的所有信息。调用该方法后，<code>.mock</code> 上的所有属性都将返回空状态。此方法不会重置实现。如果需要在不同断言之间清理 mock，该方法非常有用。<p>如果我们希望在每次测试前自动调用该方法，可以在配置中启用 <a href="../config.html#clearmocks">`clearMocks``</a>设置。</section><section class="level2"aria-labelledby="mockname"><h2 id="mockname">mockName</h2><ul><li><strong>类型:</strong> <code>(name: string) => MockInstance</code></ul><p>设置内部 mock 名称。用于在断言失败时查看 mock 名称。</section><section class="level2"aria-labelledby="mockimplementation"><h2 id="mockimplementation">mockImplementation</h2><ul><li><strong>类型:</strong> <code>(fn: Function) => MockInstance</code></ul><p>接受一个函数，该函数将用作 mock 的实现。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mockFn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span>apples <span class="token arrow operator">=></span> apples <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">// or: vi.fn(apples => apples + 1);</span>

<span class="token keyword">const</span> <span class="token maybe-class-name">NelliesBucket</span> <span class="token operator">=</span> <span class="token function">mockFn</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token maybe-class-name">BobsBucket</span> <span class="token operator">=</span> <span class="token function">mockFn</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">NelliesBucket</span> <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">// true</span>
<span class="token maybe-class-name">BobsBucket</span> <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">// true</span>

mockFn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">// true</span>
mockFn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">// true</span></code></pre></section><section class="level2"aria-labelledby="mockimplementationonce"><h2 id="mockimplementationonce">mockImplementationOnce</h2><ul><li><strong>类型:</strong> <code>(fn: Function) => MockInstance</code></ul><p>接受一个函数，该函数将在下一次调用时用作 mock 的实现。可以链式调用多个函数，从而产生不同的结果。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// false</span></code></pre><p>当模拟函数的实现耗尽时，它会调用 <code>vi.fn(() => defaultValue)</code> 或 <code>.mockImplementation(() => defaultValue)</code> 所设置的默认实现（如果它们被调用）：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'default'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'second call'</span><span class="token punctuation">)</span>

<span class="token comment">// 'first call', 'second call', 'default', 'default'</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="withimplementation"><h2 id="withimplementation">withImplementation</h2><ul><li><strong>类型:</strong> <code>(fn: Function, callback: () => void) => MockInstance</code><li><strong>类型:</strong> <code>(fn: Function, callback: () => Promise&#x3C;unknown>) => Promise&#x3C;MockInstance></code></ul><p>在执行回调时，临时覆盖原始模拟实现。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'original'</span><span class="token punctuation">)</span>

myMockFn<span class="token punctuation">.</span><span class="token method function property-access">withImplementation</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'temp'</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'temp'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'original'</span></code></pre><p>可与异步回调一起使用。该方法必须等待，之后才能使用原始实现。<pre class="language-ts"><code class="language-ts"><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'async callback'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'original'</span><span class="token punctuation">)</span>

  <span class="token comment">// We await this call since the callback is async</span>
  <span class="token keyword control-flow">await</span> myMockFn<span class="token punctuation">.</span><span class="token method function property-access">withImplementation</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token string">'temp'</span><span class="token punctuation">,</span>
    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'temp'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>

  <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 'original'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>请注意，该方法优先于 <a href="https://cn.vitest.dev/api/mock.html#mockimplementationonce"><code>mockImplementationOnce</code></a>。</section><section class="level2"aria-labelledby="mockrejectedvalue"><h2 id="mockrejectedvalue">mockRejectedValue</h2><ul><li><strong>类型:</strong> <code>(value: any) => MockInstance</code></ul><p>接受在调用 async 函数时将被拒绝的错误。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockRejectedValue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Async error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// throws "Async error"</span></code></pre></section><section class="level2"aria-labelledby="mockrejectedvalueonce"><h2 id="mockrejectedvalueonce">mockRejectedValueOnce</h2><ul><li><strong>类型:</strong> <code>(value: any) => MockInstance</code></ul><p>接受一个将在下一次函数调用中被剔除的值。如果是链式调用，则每次连续调用都会剔除指定值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockRejectedValueOnce</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Async error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// first call</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// throws "Async error"</span></code></pre></section><section class="level2"aria-labelledby="mockreset"><h2 id="mockreset">mockReset</h2><ul><li><strong>类型:</strong> <code>() => MockInstance</code></ul><p>执行 <code>mockClear</code> 的功能，并使内部实现成为空函数（调用时返回 <code>undefined</code> ）。这也会重置所有 "once" 实现。当我们想将 mock 完全重置为默认状态时，这很有用。<p>如果我们希望在每次测试前自动调用该方法，可以启用配置中的 <a href="../config.html#mockreset"><code>mockReset</code></a> 设置。</section><section class="level2"aria-labelledby="mockrestore"><h2 id="mockrestore">mockRestore</h2><ul><li><strong>类型:</strong> <code>() => MockInstance</code></ul><p>执行与 <code>mockReset</code> 相同的功能，并将内部实现还原为原始函数。<p>请注意，从 <code>vi.fn()</code> 恢复 mock 会将实现设置为返回 <code>undefined</code> 的空函数。还原 <code>vi.fn(impl)</code> 会将实现还原为 <code>impl</code>。<p>如果希望在每次测试前自动调用此方法，可以启用配置中的 <a href="../config.html#restoreMocks"><code>restoreMocks</code></a> 设置。</section><section class="level2"aria-labelledby="mockresolvedvalue"><h2 id="mockresolvedvalue">mockResolvedValue</h2><ul><li><strong>类型:</strong> <code>(value: any) => MockInstance</code></ul><p>接受将在调用 async 函数时解析的值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValue</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 42</span></code></pre></section><section class="level2"aria-labelledby="mockresolvedvalueonce"><h2 id="mockresolvedvalueonce">mockResolvedValueOnce</h2><ul><li><strong>类型:</strong> <code>(value: any) => MockInstance</code></ul><p>接受一个将在下一次函数调用时解析的值。如果是链式调用，则每次连续调用都会解析指定的值。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> asyncMock <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValue</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValueOnce</span><span class="token punctuation">(</span><span class="token string">'second call'</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// first call</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// second call</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// default</span>
<span class="token keyword control-flow">await</span> <span class="token function">asyncMock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// default</span></code></pre></section><section class="level2"aria-labelledby="mockreturnthis"><h2 id="mockreturnthis">mockReturnThis</h2><ul><li><strong>类型:</strong> <code>() => MockInstance</code></ul><p>如果需要在不调用实际实现的情况下从方法中返回 <code>this</code> 上下文，请使用此参数。这是一个简写：<pre class="language-ts"><code class="language-ts">spy<span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="mockreturnvalue"><h2 id="mockreturnvalue">mockReturnValue</h2><ul><li><strong>类型:</strong> <code>(value: any) => MockInstance</code></ul><p>接受一个值，该值将在调用 mock 函数时返回。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> mock <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
mock<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 42</span>
mock<span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token number">43</span><span class="token punctuation">)</span>
<span class="token function">mock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 43</span></code></pre></section><section class="level2"aria-labelledby="mockreturnvalueonce"><h2 id="mockreturnvalueonce">mockReturnValueOnce</h2><ul><li><strong>类型:</strong> <code>(value: any) => MockInstance</code></ul><p>接受将在下一次函数调用中返回的值。如果是链式调用，则每次连续调用都会返回指定值。<p>如果没有更多的 <code>mockReturnValueOnce</code> 值可使用，mock 将返回到预先定义的实现（如果有的话）。<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> myMockFn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValue</span><span class="token punctuation">(</span><span class="token string">'default'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token string">'first call'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token string">'second call'</span><span class="token punctuation">)</span>

<span class="token comment">// 'first call', 'second call', 'default', 'default'</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">myMockFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="mockcalls"><h2 id="mockcalls">mock.calls</h2><p>这是一个数组，包含每次调用的所有参数。数组中的一项就是该调用的参数。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fn <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">)</span>
<span class="token function">fn</span><span class="token punctuation">(</span><span class="token string">'arg3'</span><span class="token punctuation">)</span>

fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">calls</span>
  <span class="token operator">===</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'arg1'</span><span class="token punctuation">,</span> <span class="token string">'arg2'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// first call</span>
    <span class="token punctuation">[</span><span class="token string">'arg3'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// second call</span>
  <span class="token punctuation">]</span></code></pre></section><section class="level2"aria-labelledby="mocklastcall"><h2 id="mocklastcall">mock.lastCall</h2><p>其中包含最后一次调用的参数。如果 mock 未被调用，将返回 <code>undefined</code>。</section><section class="level2"aria-labelledby="mockresults"><h2 id="mockresults">mock.results</h2><p>This is an array containing all values that were <code>returned</code> from the function. One item of the array is an object with properties <code>type</code> and <code>value</code>. Available types are:<p>这是一个数组，包含函数 <code>returned</code> 的所有值。数组中的一项是一个具有 <code>type</code> 和 <code>value</code> 属性的对象。可用的类型有<ul><li><code>'return'</code> - 函数返回时没有抛出。<li><code>'throw'</code> - 函数抛出了一个值。</ul><p><code>value</code> 属性包含返回值或抛出的错误。如果函数返回一个 Promise，<code>value</code> 将是 <em>resolved</em> 值，而不是实际的 <code>Promise</code>，除非它从未被解析。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fn <span class="token operator">=</span> vi
  <span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockReturnValueOnce</span><span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementationOnce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'thrown error'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// returned 'result'</span>

<span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
  <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// threw Error</span>
<span class="token punctuation">}</span>
<span class="token keyword control-flow">catch</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

fn<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">results</span>
  <span class="token operator">===</span> <span class="token punctuation">[</span>
    <span class="token comment">// first result</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'return'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// last result</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'throw'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token known-class-name class-name">Error</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span></code></pre></section><section class="level2"aria-labelledby="mockinvocationcallorder"><h2 id="mockinvocationcallorder">mock.invocationCallOrder</h2><p>模拟的执行顺序。这将返回一个数字数组，所有已定义的 mock 都共享该数组。<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fn1 <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fn2 <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">fn2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">fn1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

fn1<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">invocationCallOrder</span> <span class="token operator">===</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
fn2<span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">invocationCallOrder</span> <span class="token operator">===</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></code></pre></section><section class="level2"aria-labelledby="mockinstances"><h2 id="mockinstances">mock.instances</h2><p>这是一个数组，包含使用 <code>new</code> 关键字调用 mock 时实例化的所有实例。请注意，这是函数的实际上下文（<code>this</code>），而不是返回值。<blockquote>如果使用 `new MyClass()` 对 mock 进行实例化，那么 `mock.instances` 将是一个只有一个值的数组：<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">MyClass</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">MyClass</span><span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">instances</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> a</code></pre><p>如果从构造函数返回一个值，该值不会出现在 <code>instances</code> 数组中，而是会出现在 <code>results</code> 中：<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">Spy</span> <span class="token operator">=</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> vi<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token maybe-class-name">Spy</span><span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">instances</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> a
<span class="token maybe-class-name">Spy</span><span class="token punctuation">.</span><span class="token property-access">mock</span><span class="token punctuation">.</span><span class="token property-access">results</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> a</code></pre></blockquote><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>