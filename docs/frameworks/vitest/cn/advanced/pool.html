<!doctype html><html lang="cn"><meta charset="utf-8"><title>Custom Pool</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="custom-pool"><h1 id="custom-pool">Custom Pool</h1><blockquote>这是高级 API。如果你只需要运行测试，你可能不需要这个。它主要被库的作者使用。</blockquote><p>Vitest 在默认情况下以多种方式运行测试：<ul><li><code>threads</code> 使用 <code>node:worker_threads</code> 运行测试（通过新的 worker 上下文提供隔离）<li><code>forks</code> 使用 <code>node:child_process</code> 运行测试（通过新的 <code>child_process.fork</code> 进程提供隔离）<li><code>vmThreads</code> 使用 <code>node:worker_threads</code> 运行测试（但是通过 <code>vm</code> 模块而不是新的 worker 上下文提供隔离）<li><code>browser</code> 使用浏览器提供程序运行测试<li><code>typescript</code> 在测试中运行类型检查</ul><p>你可以通过指定文件路径来提供自己的池：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  test<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认情况下，将使用自定义池运行每个文件</span>
    pool<span class="token operator">:</span> <span class="token string">'./my-custom-pool.ts'</span><span class="token punctuation">,</span>
    <span class="token comment">// 可以使用 `poolOptions` 对象提供选项</span>
    poolOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      myCustomPool<span class="token operator">:</span> <span class="token punctuation">{</span>
        customProperty<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 还可以为文件子集指定池</span>
    poolMatchGlobs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'**/*.custom.test.ts'</span><span class="token punctuation">,</span> <span class="token string">'./my-custom-pool.ts'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><section class="level2"aria-labelledby="api"><h2 id="api">API</h2><p>在 <code>pool</code> 选项中指定的文件应该导出一个函数（可以是异步的），该函数接受 <code>Vitest</code> 接口作为其第一个选项。这个函数需要返回一个与 <code>ProcessPool</code> 接口匹配的对象：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ProcessPool</span><span class="token punctuation">,</span> <span class="token maybe-class-name">WorkspaceProject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ProcessPool</span></span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token function-variable function">runTests</span><span class="token operator">:</span> <span class="token punctuation">(</span>
    files<span class="token operator">:</span> <span class="token punctuation">[</span>project<span class="token operator">:</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> testFile<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    invalidates<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span>
  close<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span>
<span class="token punctuation">}</span></code></pre><p>这个函数只会被调用一次（除非服务器配置被更新），通常最好在这个函数内初始化测试所需的一切，并在调用 <code>runTests</code> 时重复使用它。<p>Vitest 在安排运行新测试时调用 <code>runTest</code>。如果 <code>files</code> 为空，将不会调用它。第一个参数是一个元组数组：第一个元素是对工作区项目的引用，第二个元素是测试文件的绝对路径。在调用 <code>runTests</code> 之前，文件将使用 <a href="../config.html#sequence.sequencer"><code>sequencer</code></a> 进行排序。可能（但不太可能）会有相同的文件出现两次，但它们将始终属于不同的项目 - 这是通过 <a href="/guide/workspace"><code>vitest.workspace.ts</code></a> 配置实现的。<p>Vitest 会等到 <code>runTests</code> 执行完毕后才结束运行（即只有在 <code>runTests</code> 解决后才会触发 <a href="/guide/reporters"><code>onFinished</code></a>）。<p>如果你正在使用自定义池，需要自行提供测试文件及其结果 - 可以参考 <a href="https://github.com/vitest-dev/vitest/blob/main/packages/vitest/src/node/state.ts"><code>vitest.state</code></a>（最重要的是 <code>collectFiles</code> 和 <code>updateTasks</code>）。Vitest 使用 <code>@vitest/runner</code> 包中的 <code>startTests</code> 函数来执行这些操作。<p>要在不同进程之间进行通信，可以使用 <code>vitest/node</code> 中的 <code>createMethodsRPC</code> 创建方法对象，并使用你喜欢的任何通信形式。例如，要使用 <code>birpc</code> 的 websockets，可以编写类似以下的内容：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createBirpc <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'birpc'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> parse<span class="token punctuation">,</span> stringify <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'flatted'</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> createMethodsRPC <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword">function</span> <span class="token function">createRpc</span><span class="token punctuation">(</span>project<span class="token operator">:</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> wss<span class="token operator">:</span> <span class="token maybe-class-name">WebSocketServer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">createBirpc</span><span class="token punctuation">(</span><span class="token function">createMethodsRPC</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">post</span><span class="token operator">:</span> msg <span class="token arrow operator">=></span> wss<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">on</span><span class="token operator">:</span> fn <span class="token arrow operator">=></span> wss<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">,</span>
    serialize<span class="token operator">:</span> stringify<span class="token punctuation">,</span>
    deserialize<span class="token operator">:</span> parse<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>为了确保收集每个测试，您可以调用 <code>ctx.state.collectFiles</code> 并将其交给 Vitest 报告器：<pre class="language-ts"><code class="language-ts"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">runTests</span><span class="token punctuation">(</span>project<span class="token operator">:</span> <span class="token maybe-class-name">WorkspaceProject</span><span class="token punctuation">,</span> tests<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 运行测试，放入 `files` 和 `tasks` 中</span>
  <span class="token keyword">const</span> methods <span class="token operator">=</span> <span class="token function">createMethodsRPC</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span>
  <span class="token keyword control-flow">await</span> methods<span class="token punctuation">.</span><span class="token method function property-access">onCollected</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span>
  <span class="token comment">// 大多数报告都依赖于在 `onTaskUpdate` 中更新结果</span>
  <span class="token keyword control-flow">await</span> methods<span class="token punctuation">.</span><span class="token method function property-access">onTaskUpdate</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>可以在 <a href="https://github.com/vitest-dev/vitest/blob/main/test/run/pool-custom-fixtures/pool/custom-pool.ts">pool/custom-pool.ts</a> 中看到一个简单的示例。 <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>