<!doctype html><html lang="cn"><meta charset="utf-8"><title>任务元数据</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="任务元数据"><h1 id="任务元数据">任务元数据</h1><blockquote>Vitest 导出了实验性私有 API。重大更改可能不遵循 semver，使用时请固定 Vitest 的版本。</blockquote><p>如果你正在开发自定义报告器或使用 Vitest Node.js API，你可能会发现将在各种上下文中执行的测试中的数据传递给报告器或自定义 Vitest 处理程序很有用。<p>要实现此目的，依靠 <a href="/guide/test-context">测试上下文</a> 是不可行的，因为它无法序列化。但是，使用 Vitest 时，你可以利用每个任务（套件或测试）上可用的 <code>meta</code> 属性在测试和 Node.js 进程之间共享数据。值得注意的是，这种通信只是单向的，因为 <code>meta</code> 属性只能在测试上下文中修改。Node.js 上下文中所做的任何更改在你的测试中都将不可见。<p>你可以在测试上下文中或在套件任务的 <code>beforeAll</code>/<code>afterAll</code> 钩子中填充 <code>meta</code> 属性。<pre class="language-ts"><code class="language-ts"><span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token punctuation">(</span>suite<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  suite<span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">done</span> <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'custom'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> task <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  task<span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">custom</span> <span class="token operator">=</span> <span class="token string">'some-custom-handler'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>一旦测试完成，Vitest 将使用 RPC 将包含结果和 <code>meta</code> 的任务发送到 Node.js 进程。要拦截和处理此任务，你可以利用报告器实现中可用的 <code>onTaskUpdate</code> 方法：<pre class="language-ts"><code class="language-ts"><span class="token comment">// custom-reporter.js</span>
<span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token comment">// you can intercept packs if needed</span>
  <span class="token function">onTaskUpdate</span><span class="token punctuation">(</span>packs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>id<span class="token punctuation">,</span> result<span class="token punctuation">,</span> meta<span class="token punctuation">]</span> <span class="token operator">=</span> packs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// meta is located on every task inside "onFinished"</span>
  <span class="token function">onFinished</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">done</span> <span class="token operator">===</span> <span class="token boolean">true</span>
    files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">tasks</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">custom</span> <span class="token operator">===</span> <span class="token string">'some-custom-handler'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><blockquote>如果短时间内完成多个测试，Vitest 可以同时发送多个任务。</blockquote>danger BEWARE Vitest 使用不同的方法与 Node.js 进程进行通信。<ul><li>如果 Vitest 在工作线程内运行测试，它将通过<a href="https://developer.mozilla.org/en-US/docs/Web/API/MessagePort">消息端口</a>发送数据<li>如果 Vitest 使用子进程，数据将通过 <a href="https://nodejs.org/api/process.html#processsendmessage-sendhandle-options-callback"><code>process.send</code></a> API 作为序列化缓冲区发送<li>如果 Vitest 在浏览器中运行测试，数据将使用 <a href="https://www.npmjs.com/package/flatted">flatted</a> 包进行字符串化</ul><p>该属性也会出现在每个测试的 <code>json</code> 报告中，因此请确保数据可以序列化为 JSON。<p>另外，请确保在设置<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm#error_types">错误属性</a>之前序列化它们。<p>当测试运行完成时，你还可以从 Vitest 状态获取此信息：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> vitest <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">createVitest</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>
<span class="token keyword control-flow">await</span> vitest<span class="token punctuation">.</span><span class="token method function property-access">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
vitest<span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token method function property-access">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">done</span> <span class="token operator">===</span> <span class="token boolean">true</span>
vitest<span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token method function property-access">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">tasks</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token property-access">meta</span><span class="token punctuation">.</span><span class="token property-access">custom</span> <span class="token operator">===</span> <span class="token string">'some-custom-handler'</span></code></pre><p>使用 TypeScript 时，还可以扩展类型定义：<pre class="language-ts"><code class="language-ts"><span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'vitest'</span> <span class="token punctuation">{</span>
  <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">TaskMeta</span></span> <span class="token punctuation">{</span>
    done<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
    custom<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>