<!doctype html><html lang="cn"><meta charset="utf-8"><title>Node API</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"type="text/css"href="../../../../themes/packages/prism-coy-theme/theme_common.css"><section class="level1"aria-labelledby="node-api"><h1 id="node-api">Node API</h1><blockquote>Vitest 暴露了实验性的私有 API。由于可能不遵循语义化版本规范（SemVer），因此可能会出现不兼容的更改，请在使用 Vitest 时锁定版本。</blockquote><section class="level2"aria-labelledby="启动-vitest"><h2 id="启动-vitest">启动 Vitest</h2><p>你可以使用 Vitest 的 Node API 开始运行 Vitest 测试：<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> startVitest <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword">const</span> vitest <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">startVitest</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

<span class="token keyword control-flow">await</span> vitest<span class="token operator">?.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>如果测试可以启动，则 <code>startVitest</code> 函数返回 <code>Vitest</code> 实例。 如果出现以下情况之一，则返回 <code>undefined</code>：<ul><li>Vitest 未找到 <code>vite</code> 包 (通常与 Vitest 一起安装)<li>如果启用了 <code>coverage</code>，并且运行模式为 "test"，但并未安装 "coverage" 包（<code>@vitest/coverage-v8</code> 或 <code>@vitest/coverage-istanbul</code>）<li>如果未安装环境包 (<code>jsdom</code>/<code>happy-dom</code>/<code>@edge-runtime/vm</code>)</ul><p>如果在运行期间返回 <code>undefined</code> 或者测试失败, Vitest 会将 <code>process.exitCode</code> 设置为 <code>1</code>。<p>如果未启用监视模式，Vitest 将会调用 <code>close</code> 方法。<p>如果启用了监视模式并且终端支持 TTY, 则 Vitest 会注册控制台快捷键。<p>你可以将过滤器列表作为第二个参数传递下去。Vitest 将仅运行包含其文件路径中至少一个传递字符串的测试。<p>此外，你可以使用第三个参数传递 CLI 参数，这将覆盖任何测试配置选项。<p>或者，你可以将完整的 Vite 配置作为第四个参数传递进去，这将优先于任何其他用户定义的选项。<p>运行测试后，您可以从 <code>state.getFiles</code> API 获取结果：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> vitest <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">startVitest</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>vitest<span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token method function property-access">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// [{ type: 'file', ... }]</span></code></pre><p>自 Vitest 2.1 起，建议使用<a href="/advanced/reporters#reported-tasks">"Reported Tasks" API</a> 和 <code>state.getFiles</code>。今后，Vitest 将直接返回这些对象：<pre class="language-ts"><code class="language-ts"><span class="token keyword">const</span> vitest <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">startVitest</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">[</span>fileTask<span class="token punctuation">]</span> <span class="token operator">=</span> vitest<span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token method function property-access">getFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> testFile <span class="token operator">=</span> vitest<span class="token punctuation">.</span><span class="token property-access">state</span><span class="token punctuation">.</span><span class="token method function property-access">getReportedEntity</span><span class="token punctuation">(</span>fileTask<span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="创建-vitest"><h2 id="创建-vitest">创建 Vitest</h2><p>你可以使用 <code>createVitest</code> 函数创建自己的 Vitest 实例. 它返回与 <code>startVitest</code> 相同的 <code>Vitest</code> 实例, 但不会启动测试，也不会验证已安装的包。<pre class="language-js"><code class="language-js"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createVitest <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword">const</span> vitest <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">createVitest</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">watch</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="parsecli"><h2 id="parsecli">parseCLI</h2><p>你可以使用此方法来解析 CLI 参数。它接受字符串（其中参数由单个空格分隔）或与 Vitest CLI 使用的格式相同的 CLI 参数的字符串数组。它返回一个过滤器和<code>选项</code>，你可以稍后将其传递给 <code>createVitest</code> 或 <code>startVitest</code> 方法。<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> parseCLI <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token function">parseCLI</span><span class="token punctuation">(</span><span class="token string">'vitest ./files.ts --coverage --browser=chrome'</span><span class="token punctuation">)</span></code></pre></section><section class="level2"aria-labelledby="vitest"><h2 id="vitest">Vitest</h2><p>Vitest 实例需要当前的测试模式。它可以是以下之一：<ul><li>运行运行时测试时为 <code>test</code><li>运行基准测试时为 <code>benchmark</code><li>运行类型测试时为 <code>typecheck</code></ul><section class="level3"aria-labelledby="模式"><h3 id="模式">模式</h3><section class="level4"aria-labelledby="test"><h4 id="test">test</h4><p>测试模式仅会调用 <code>test</code> 或 <code>it</code> 中的函数，并在遇到 <code>bench</code> 时抛出错误。此模式使用配置中的 <code>include</code> 和 <code>exclude</code> 选项查找测试文件。</section><section class="level4"aria-labelledby="benchmark"><h4 id="benchmark">benchmark</h4><p>基准测试模式会调用 <code>bench</code> 函数，并在遇到 <code>test</code> 或 <code>it</code> 时抛出错误。此模式使用配置中的 <code>benchmark.include</code> 和 <code>benchmark.exclude</code> 选项查找基准测试文件。</section><section class="level4"aria-labelledby="typecheck"><h4 id="typecheck">typecheck</h4><p>类型检查模式不会<em>运行</em>测试。它仅分析类型并提供摘要信息。此模式使用配置中的 <code>typecheck.include</code> 和 <code>typecheck.exclude</code> 选项查找要分析的文件。</section></section><section class="level3"aria-labelledby="start"><h3 id="start">start</h3><p>你可以使用 <code>start</code> 方法运行测试或者基准测试。你还可以传递一个字符串数组以筛选测试文件。</section><section class="level3"aria-labelledby="provide"><h3 id="provide"><code>provide</code></h3><p>Vitest 暴露了<code>provide</code>方法，它是<code>vitest.getCoreWorkspaceProject().provide</code>的简写。使用该方法，您可以从主线程向测试传递值。所有值在存储前都会通过 <code>structuredClone</code>进行检查，但值本身不会被克隆。<p>要在测试中接收值，需要从 <code>vitest</code> entrypont 导入 <code>inject</code> 方法：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> inject <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest'</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> <span class="token function">inject</span><span class="token punctuation">(</span><span class="token string">'wsPort'</span><span class="token punctuation">)</span> <span class="token comment">// 3000</span></code></pre><p>为了提高类型安全性，我们鼓励您增强 <code>ProvidedContext</code> 的类型：<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createVitest <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'vitest/node'</span>

<span class="token keyword">const</span> vitest <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">createVitest</span><span class="token punctuation">(</span><span class="token string">'test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  watch<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
vitest<span class="token punctuation">.</span><span class="token method function property-access">provide</span><span class="token punctuation">(</span><span class="token string">'wsPort'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token keyword">declare</span> <span class="token keyword">module</span> <span class="token string">'vitest'</span> <span class="token punctuation">{</span>
  <span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ProvidedContext</span></span> <span class="token punctuation">{</span>
    wsPort<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote>从技术上讲，`provide`是`WorkspaceProject`的一个方法，因此仅限于特定的项目。不过，所有项目都继承了核心项目的值，这使得 `vitest.provide` 成为向测试传递值的通用方法。</blockquote><blockquote>在不想使用公共 API 的情况下，[全局设置文件](../config.html#globalsetup) 也可以使用此方法：<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token keyword">function</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> provide <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">provide</span><span class="token punctuation">(</span><span class="token string">'wsPort'</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></blockquote><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>