<!doctype html><html lang="ja"><meta charset="utf-8"><title>プロキシーの背後の Express</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="guide"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="プロキシーの背後の-express"class="level1"><h1>プロキシーの背後の Express</h1><p>Express アプリケーションをプロキシーの背後で実行する場合、(<a href="../4x/api.html#app.set">app.set()</a> を使用して) アプリケーション変数 <code>trust proxy</code> を次の表にリストされているいずれかの値に設定します。<div class="doc-box doc-info"markdown="1"><p>アプリケーション変数 <code>trust proxy</code> が設定されていない場合でもアプリケーションの実行は失敗しませんが、<code>trust proxy</code> が構成されていない限り、プロキシーの IP アドレスを誤ってクライアント IP アドレスとして登録します。</div><table class="doctable"border="1"markdown="1"><thead><tr><th>型<th>値<tbody><tr><td>真偽値<td markdown="1"><p><code>true</code> の場合、クライアントの IP アドレスは、<code>X-Forwarded-*</code> ヘッダーの左端の項目として理解されます。<p><code>false</code> の場合、アプリケーションはインターネットに直接接続されているものとして理解され、クライアントの IP アドレスは <code>req.connection.remoteAddress</code> から導き出されます。これはデフォルトの設定値です。<tr><td>IP アドレス<td markdown="1"><p>信頼される IP アドレス、サブネット、または IP アドレスとサブネットの配列。次のリストに、事前構成されたサブネット名を示します。<ul><li>loopback - <code>127.0.0.1/8</code>、<code>::1/128</code><li>linklocal - <code>169.254.0.0/16</code>、<code>fe80::/10</code><li>uniquelocal - <code>10.0.0.0/8</code>、<code>172.16.0.0/12</code>、<code>192.168.0.0/16</code>、<code>fc00::/7</code></ul><p>以下のどの方法でも IP アドレスを設定できます。<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token string">'loopback'</span><span class="token punctuation">)</span> <span class="token comment">// specify a single subnet</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token string">'loopback, 123.123.123.123'</span><span class="token punctuation">)</span> <span class="token comment">// specify a subnet and an address</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token string">'loopback, linklocal, uniquelocal'</span><span class="token punctuation">)</span> <span class="token comment">// specify multiple subnets as CSV</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'loopback'</span><span class="token punctuation">,</span> <span class="token string">'linklocal'</span><span class="token punctuation">,</span> <span class="token string">'uniquelocal'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment">// specify multiple subnets as an array</span></code></pre><p>IP アドレスまたはサブネットは、指定されると、アドレス決定プロセスから除外されます。アプリケーション・サーバーに最も近い信頼できない IP アドレスがクライアントの IP アドレスに決定されます。<tr><td>数字<td markdown="1"><p>プロキシー・サーバーから <code>n</code> 番目のホップをクライアントとして信頼します。<tr><td>関数<td markdown="1">カスタムの信頼実装。実行内容を理解している場合にのみ、これを使用してください。<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'trust proxy'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ip</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>ip <span class="token operator">===</span> <span class="token string">'127.0.0.1'</span> <span class="token operator">||</span> ip <span class="token operator">===</span> <span class="token string">'123.123.123.123'</span><span class="token punctuation">)</span> <span class="token keyword control-flow">return</span> <span class="token boolean">true</span> <span class="token comment">// trusted IPs</span>
  <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></table><p><code>trust proxy</code>を有効にすると、次の3つの重要な変更が起こります。<ul><li markdown="1"><p><a href="../api.html#req.hostname">req.hostname</a> の値は、クライアントまたはプロキシーが設定できる <code>X-Forwarded-Host</code> ヘッダーに設定された値から導き出されます。<li markdown="1"><p><code>X-Forwarded-Proto</code> は、<code>https</code> と <code>http</code> のどちらであるか、または無効な名前であるかをアプリケーションに通知するためにリバース・プロキシーによって設定できます。この値は、<a href="../api.html#req.protocol">req.protocol</a> に反映されます。<li markdown="1">[req.ip](../api.html#req.ip) および [req.ips](../api.html#req.ips) の値は、`X-Forwarded-For` のアドレス・リストから取り込まれます。</ul><p><code>trust proxy</code> 設定は、<a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a> パッケージを使用して実装されます。詳細については、資料を参照してください。<p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>