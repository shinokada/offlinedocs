<!doctype html><html lang="ja"><meta charset="utf-8"><title>Express アプリケーション用のプロセス・マネージャー</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="advanced"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="express-アプリケーション用のプロセスマネージャー"class="level1"><h1>Express アプリケーション用のプロセス・マネージャー</h1><p>Express アプリケーションを実動で実行する際、以下のタスクを実行するために<em>プロセス・マネージャー</em> を使用すると便利です。<ul><li>アプリケーションが異常終了した場合に自動的に再始動する。<li>ランタイム・パフォーマンスとリソース使用量に関するインサイトを得る。<li>パフォーマンスを向上させるために設定を動的に変更する。<li>クラスタリングを制御する。</ul><p>プロセス・マネージャーは、アプリケーション・サーバーに似ていて、デプロイメントを容易に行えるようにして、高可用性を実現し、アプリケーションを実行時に管理できるようにする、アプリケーションの「コンテナー」です。<p>Express およびその他の Node.js アプリケーション用の最も一般的なプロセス・マネージャーは次のとおりです。<ul><li><a href="#forever">Forever</a><li><a href="#pm2">PM2</a><li><a href="#strongloop-process-manager">StrongLoop Process Manager</a><li><a href="#systemd">SystemD</a></ul><p>上記の 4 つのツールのいずれを使用しても非常に役立ちますが、StrongLoop Process Manager は、Node.js アプリケーションのライフサイクル全体に対応した包括的な実行時とデプロイメントのソリューションを提供する唯一のツールであり、実動前と実動後のすべてのステップに関するツールを統合インターフェースで提供します。<p>以下に、これらの各ツールについて簡単に説明します。 詳細な比較については、<a href="http://strong-pm.io/compare/">http://strong-pm.io/compare/</a> を参照してください。<section id="forever"class="level2"><h2>Forever</h2><p>Forever は、特定のスクリプトが確実に継続的 (永続的) に実行されるようにするための単純なコマンド・ライン・インターフェース・ツールです。Forever のインターフェースは単純であるため、Node.js アプリケーションおよびスクリプトの小規模なデプロイメントを実行するのに理想的です。<p>詳細については、<a href="https://github.com/foreverjs/forever">https://github.com/foreverjs/forever</a> を参照してください。<section id="インストール"class="level3"><h3>インストール</h3><pre class="language-console"><code class="language-console">$ [sudo] npm install forever -g</code></pre></section><section id="基本的な使用法"class="level3"><h3>基本的な使用法</h3><p>スクリプトを開始するには、次のように <code>forever start</code> コマンドを使用して、スクリプトのパスを指定します。<pre class="language-console"><code class="language-console">$ forever start script.js</code></pre><p>このコマンドは、スクリプトをデーモン・モード (バックグラウンド) で実行します。<p>端末に接続されるようにスクリプトを実行するには、次のように <code>start</code> を省略します。<pre class="language-console"><code class="language-console">$ forever script.js</code></pre><p>次の例に示すように、ロギング・オプション <code>-l</code>、<code>-o</code>、および <code>-e</code> を使用して Forever ツールおよびスクリプトの出力をログに記録することをお勧めします。<pre class="language-console"><code class="language-console">$ forever start -l forever.log -o out.log -e err.log script.js</code></pre><p>Forever によって開始されたスクリプトのリストを表示するには、次のようにします。<pre class="language-console"><code class="language-console">$ forever list</code></pre><p>Forever によって開始されたスクリプトを停止するには、<code>forever stop</code> コマンドを使用して、プロセス索引 (<code>forever list</code> コマンドによってリストされます) を指定します。<pre class="language-console"><code class="language-console">$ forever stop 1</code></pre><p>あるいは、次のようにファイルのパスを指定します。<pre class="language-console"><code class="language-console">$ forever stop script.js</code></pre><p>Forever によって開始されたすべてのスクリプトを停止するには、次のようにします。<pre class="language-console"><code class="language-console">$ forever stopall</code></pre><p>Forever には、さらに多くのオプションがあり、プログラマチック API もあります。</section></section><section id="pm2"class="level2"><h2>PM2</h2><p>PM2 は、ロード・バランサーが組み込まれた、Node.js アプリケーション用の実動プロセス・マネージャーです。PM2 では、アプリケーションの稼働を永続的に維持して、ダウン時間を発生させずに再ロードすることができ、共通のシステム管理タスクを簡単に実行できます。PM2 では、アプリケーションのロギング、モニター、クラスタリングを管理することもできます。<p>詳細については、<a href="https://github.com/Unitech/pm2">https://github.com/Unitech/pm2</a> を参照してください。<section id="インストール-1"class="level3"><h3>インストール</h3><pre class="language-console"><code class="language-console">$ [sudo] npm install pm2 -g</code></pre></section><section id="基本的な使用法-1"class="level3"><h3>基本的な使用法</h3><p><code>pm2</code> コマンドを使用してアプリケーションを開始する場合、アプリケーションのパスを指定する必要があります。ただし、アプリケーションの停止、再始動、または削除を行う場合は、アプリケーションの名前または ID を指定するだけで済みます。<pre class="language-console"><code class="language-console">$ pm2 start npm --name my-app -- start
[PM2] restartProcessId process id 0
┌──────────┬────┬──────┬───────┬────────┬─────────┬────────┬─────────────┬──────────┐
│ App name │ id │ mode │ pid   │ status │ restart │ uptime │ memory      │ watching │
├──────────┼────┼──────┼───────┼────────┼─────────┼────────┼─────────────┼──────────┤
│ my-app   │ 0  │ fork │ 64029 │ online │ 1       │ 0s     │ 17.816 MB   │ disabled │
└──────────┴────┴──────┴───────┴────────┴─────────┴────────┴─────────────┴──────────┘
 Use the `pm2 show &#x3C;id|name>` command to get more details about an app.</code></pre><p><code>pm2</code> コマンドを使用してアプリケーションを開始する場合、アプリケーションは即時にバックグラウンドに送信されます。さまざまな <code>pm2</code> コマンドを使用して、コマンド・ラインからバックグラウンド・アプリケーションを制御できます。<p><code>pm2</code> コマンドを使用してアプリケーションが開始された後、アプリケーションはID を使用して PM2 のプロセス・リストに登録されます。そのため、システム上の別のディレクトリーからID を使用して同じ名前を持つアプリケーションを管理できます。<p>同じ名前を持つ複数のアプリケーションが実行されている場合、<code>pm2</code> コマンドがすべてのアプリケーションに影響を与えることに注意してください。そのため、個々のアプリケーションを管理するには、名前ではなく ID を使用してください。<p>実行中のプロセスをすべてリストするには、次のようにします。<pre class="language-console"><code class="language-console">$ pm2 list</code></pre><p>アプリケーションを停止するには、次のようにします。<pre class="language-console"><code class="language-console">$ pm2 stop 0</code></pre><p>アプリケーションを再始動するには、次のようにします。<pre class="language-console"><code class="language-console">$ pm2 restart 0</code></pre><p>アプリケーションに関する詳細情報を表示するには、次のようにします。<pre class="language-console"><code class="language-console">$ pm2 show 0</code></pre><p>アプリケーションを PM2 のレジストリーから削除するには、次のようにします。<pre class="language-console"><code class="language-console">$ pm2 delete 0</code></pre></section></section><section id="strongloop-process-manager"class="level2"><h2>StrongLoop Process Manager</h2><p>StrongLoop Process Manager (StrongLoop PM) は、Node.js アプリケーション用の実動プロセス・マネージャーです。StrongLoop PM には、ロード・バランシング、モニター、マルチホスト・デプロイメント、およびグラフィカル・コンソールが組み込まれています。 StrongLoop PM は、以下のタスクに使用できます。<ul><li>Node.js アプリケーションを作成してパッケージし、ローカル・システムまたはリモート・システムにデプロイする。<li>CPU プロファイルとヒープ・スナップショットを表示して、パフォーマンスを最適化し、メモリー・リークを診断する。<li>プロセスとクラスターの稼働を永続的に維持する。<li>アプリケーションのパフォーマンス・メトリックを表示する。<li>Nginx が統合されたマルチホスト・デプロイメントを容易に管理する。<li>複数の StrongLoop PM を、Arc から管理される分散マイクロサービス・ランタイムに統合する。</ul><p>StrongLoop PM で作業するには、<code>slc</code> という強力なコマンド・ライン・インターフェース、または Arc というグラフィカル・ツールを使用します。Arc は、オープン・ソースであり、StrongLoop によって専門的なサポートが提供されます。<p>詳細については、<a href="http://strong-pm.io/">http://strong-pm.io/</a> を参照してください。<p>詳細な説明:<ul><li><a href="http://docs.strongloop.com/display/SLC">Operating Node apps (StrongLoop 資料)</a><li><a href="http://docs.strongloop.com/display/SLC/Using+Process+Manager">Using StrongLoop Process Manager</a>.</ul><section id="インストール-2"class="level3"><h3>インストール</h3><pre class="language-console"><code class="language-console">$ [sudo] npm install -g strongloop</code></pre></section><section id="基本的な使用法-2"class="level3"><h3>基本的な使用法</h3><pre class="language-console"><code class="language-console">$ cd my-app
$ slc start</code></pre><p>プロセス・マネージャーとすべてのデプロイ済みアプリケーションを表示するには、次のようにします。<pre class="language-console"><code class="language-console">$ slc ctl
Service ID: 1
Service Name: my-app
Environment variables:
  No environment variables defined
Instances:
    Version  Agent version  Cluster size
     4.1.13      1.5.14           4
Processes:
        ID      PID   WID  Listening Ports  Tracking objects?  CPU profiling?
    1.1.57692  57692   0
    1.1.57693  57693   1     0.0.0.0:3001
    1.1.57694  57694   2     0.0.0.0:3001
    1.1.57695  57695   3     0.0.0.0:3001
    1.1.57696  57696   4     0.0.0.0:3001</code></pre><p>すべての管理対象アプリケーション (サービス) をリストするには、次のようにします。<pre class="language-console"><code class="language-console">$ slc ctl ls
Id          Name         Scale
 1          my-app       1</code></pre><p>アプリケーションを停止するには、次のようにします。<pre class="language-console"><code class="language-console">$ slc ctl stop my-app</code></pre><p>アプリケーションを再始動するには、次のようにします。<pre class="language-console"><code class="language-console">$ slc ctl restart my-app</code></pre><p>「ソフト再始動」も実行できます。実行するとワーカー・プロセスに既存の接続をクローズするための猶予期間を与えた後で、現行のアプリケーションが再始動されます。<pre class="language-console"><code class="language-console">$ slc ctl soft-restart my-app</code></pre><p>アプリケーションを管理対象から削除するには、次のようにします。<pre class="language-console"><code class="language-console">$ slc ctl remove my-app</code></pre></section></section><section id="systemd"class="level2"><h2>SystemD</h2><section id="イントロダクション"class="level3"><h3>イントロダクション</h3><p>SystemDは現代のLinuxディストリビューションにおける、デフォルトのプロセスマネージャです。SystemDに基づいたノードサービスの実行は非常に簡単です。注：このセクションは、<a href="https://www.axllent.org/docs/view/nodejs-service-with-systemd/">Ralph Slooten(@axllent) のブログ記事</a>に基づいています。</section><section id="serviceのセットアップ"class="level3"><h3>serviceのセットアップ</h3><p>Create a file in <code>/etc/systemd/system/express.service</code>:<pre class="language-sh"><code class="language-sh">[Unit]
Description=Express
# Set dependencies to other services (optional)
#After=mongodb.service

[Service]
# Run Grunt before starting the server (optional)
#ExecStartPre=/usr/bin/grunt

# Start the js-file starting the express server
ExecStart=/usr/bin/node server.js
WorkingDirectory=/usr/local/express
Restart=always
RestartSec=10
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=Express
# Change to a non-root user (optional, but recommended)
#User=&#x3C;alternate user>
#Group=&#x3C;alternate group>
# Set environment options
Environment=NODE_ENV=production PORT=8080

[Install]
WantedBy=multi-user.target</code></pre></section><section id="serviceの有効化"class="level3"><h3>serviceの有効化</h3><pre class="language-console"><code class="language-console">$ systemctl enable express.service</code></pre></section><section id="serviceの起動"class="level3"><h3>serviceの起動</h3><pre class="language-console"><code class="language-console">$ systemctl start express.service</code></pre></section><section id="serviceのステータスのチェック"class="level3"><h3>serviceのステータスのチェック</h3><pre class="language-console"><code class="language-console">$ systemctl status express.service</code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>