<!doctype html><html lang="ko"><meta charset="utf-8"><title>상태 검사와 우아한 종료</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="advanced"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="상태-확인와-정상-종료"class="level1"><h1>상태 확인와 정상 종료</h1><section id="정상-종료"class="level2"><h2>정상 종료</h2><p>애플리케이션의 새 버전을 배포할 때, 이전 버전을 교체해야 합니다. 여러분이 사용하는 <a href="pm.html">프로세스 매니저</a>는 애플리케어션에 SIGTERM 신호를 보내 종료를 통보할 것입니다. 애플리케이션이 신호를 받으면, 신규 요청을 받는걸 중단하고, 진행중인 요청을 끝내고, DB 연결이나 파일 사용을 포함한 사용한 리소스를 정리할 것입니다.</section><section id="상태-확인"class="level2"><h2>상태 확인</h2><p>A load balancer uses health checks to determine if an application instance is healthy and can accept requests. For example, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Kubernetes has two health checks</a>: 로드 밸런서는 상태 확인을 애플리케이션이 장상 작동하고 요청을 받을 수 있는지 판단하는데 사용합니다. 예시로, <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Kubernetes는 2개의 상태 확인을 가지고 있습니다.</a><ul><li><code>liveness</code>: 언제 컨테이너를 재시작할지 결정합니다.<li><code>readiness</code>: 컨테이너가 트래픽을 받기 시작할 준비가 되었는지 결정합니다. 컨테이너가 준비되지 않았다면, 서비스 로드 밸런서들에게서 제거됩니다.</ul></section><section id="서드-파티-솔루션"class="level2"><h2>서드 파티 솔루션</h2><section id="terminus"class="level3"><h3>Terminus</h3><p><a href="https://github.com/godaddy/terminus">Terminus</a>는 상용구 코드를 쓸 필요를 제거하기 위해 상태 확인 절차와 정상 종료를 추가하는 오픈소스 프로젝트입니다. 먼저 정상 종료를 위한 자원 청소 로직과 상태 확인 로직만 제공하면 됩니다. 그러면 Terminus가 나머지를 처리할겁니다.<p>아래 명령을 사용해 Terminus를 설치합니다.<pre class="language-console"><code class="language-console">$ npm i @godaddy/terminus --save</code></pre><p>다음은 Terminus를 사용하는 쉬운 예제입니다. 자세한 정보는 <a href="https://github.com/godaddy/terminus">https://github.com/godaddy/terminus</a> 를 참고하세요.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> terminus <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@godaddy/terminus'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">onSignal</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'server is starting cleanup'</span><span class="token punctuation">)</span>
  <span class="token comment">// start cleanup of resource, like databases or file descriptors</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">onHealthCheck</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// checks if the system is healthy, like the db connection is live</span>
  <span class="token comment">// resolves, if health, rejects if not</span>
<span class="token punctuation">}</span>

<span class="token function">terminus</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">signal</span><span class="token operator">:</span> <span class="token string">'SIGINT'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">healthChecks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'/healthcheck'</span><span class="token operator">:</span> onHealthCheck
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  onSignal
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span></code></pre></section><section id="lightship"class="level3"><h3>Lightship</h3><p><a href="https://github.com/gajus/lightship">Lightship</a>은 애플리케이션에 상태, 준비, 생존 확인을 추가하는 오픈소스 프로젝트입니다. Lightship은 스탠드얼론 HTTP 서비스로 분리된 HTTP 서비스를 구동합니다. 이를 통해 확인 절차들을 공개적으로 노출시키지 않고 할 수 있게 해줍니다.<p>아래 명령을 사용해 Lightship을 설치합니다.<pre class="language-console"><code class="language-console">$ npm install lightship</code></pre><p>Lightship을 사용하는 쉬운 예제입니다.<pre class="language-js"><code class="language-js"><span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>
  createLightship
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lightship'</span><span class="token punctuation">)</span>

<span class="token comment">// Lightship will start a HTTP service on port 9000.</span>
<span class="token keyword">const</span> lightship <span class="token operator">=</span> <span class="token function">createLightship</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  lightship<span class="token punctuation">.</span><span class="token method function property-access">signalReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// You can signal that the service is not ready using `lightship.signalNotReady()`.</span></code></pre><p><a href="https://github.com/gajus/lightship">Lightship 문서</a>에서 <a href="https://github.com/gajus/lightship#lightship-usage-kubernetes-container-probe-configuration">Kubernetes 설정</a>에 대한 예시와 <a href="https://github.com/gajus/lightship#using-with-expressjs">Express.js</a>와의 통합 절차에 대한 완전한 예시를 제공합니다. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section></section>