<!doctype html><html lang="en"><meta charset="utf-8"><title>Overriding the Express API</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="guide"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><div id="page-doc"markdown="1"><section id="overriding-the-express-api"class="level1"><h1>Overriding the Express API</h1><p>The Express API consists of various methods and properties on the request and response objects. These are inherited by prototype. There are two extension points for the Express API:<ol><li>The global prototypes at <code>express.request</code> and <code>express.response</code>.<li>App-specific prototypes at <code>app.request</code> and <code>app.response</code>.</ol><p>Altering the global prototypes will affect all loaded Express apps in the same process. If desired, alterations can be made app-specific by only altering the app-specific prototypes after creating a new app.<section id="methods"class="level2"><h2>Methods</h2><p>You can override the signature and behavior of existing methods with your own, by assigning a custom function.<p>Following is an example of overriding the behavior of <a href="../4x/api.html#res.sendStatus">res.sendStatus</a>.<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">sendStatus</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">statusCode<span class="token punctuation">,</span> type<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// code is intentionally kept simple for demonstration purpose</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">contentType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">status</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><p>The above implementation completely changes the original signature of <code>res.sendStatus</code>. It now accepts a status code, encoding type, and the message to be sent to the client.<p>The overridden method may now be used this way:<pre class="language-js"><code class="language-js">res<span class="token punctuation">.</span><span class="token method function property-access">sendStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span> <span class="token string">'{"error":"resource not found"}'</span><span class="token punctuation">)</span></code></pre></section><section id="properties"class="level2"><h2>Properties</h2><p>Properties in the Express API are either:<ol><li>Assigned properties (ex: <code>req.baseUrl</code>, <code>req.originalUrl</code>)<li>Defined as getters (ex: <code>req.secure</code>, <code>req.ip</code>)</ol><p>Since properties under category 1 are dynamically assigned on the <code>request</code> and <code>response</code> objects in the context of the current request-response cycle, their behavior cannot be overridden.<p>Properties under category 2 can be overwritten using the Express API extensions API.<p>The following code rewrites how the value of <code>req.ip</code> is to be derived. Now, it simply returns the value of the <code>Client-IP</code> request header.<pre class="language-js"><code class="language-js"><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">,</span> <span class="token string">'ip'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'Client-IP'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section id="prototype"class="level2"><h2>Prototype</h2><p>In order to provide the Express.js API, the request/response obects passed to Express.js (via <code>app(req, res)</code>, for example) need to inherit from the same prototype chain. By default this is <code>http.IncomingRequest.prototype</code> for the request and <code>http.ServerResponse.prototype</code> for the response.<p>Unless necessary, it is recommended that this be done only at the application level, rather than globally. Also, take care that the prototype that is being used matches the functionality as closely as possible to the default prototypes.<pre class="language-js"><code class="language-js"><span class="token comment">// Use FakeRequest and FakeResponse in place of http.IncomingRequest and http.ServerResponse</span>
<span class="token comment">// for the given app reference</span>
<span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">setPrototypeOf</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">getPrototypeOf</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">request</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FakeRequest</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">)</span>
<span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">setPrototypeOf</span><span class="token punctuation">(</span><span class="token known-class-name class-name">Object</span><span class="token punctuation">.</span><span class="token method function property-access">getPrototypeOf</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">response</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">FakeResponse</span><span class="token punctuation">.</span><span class="token property-access">prototype</span><span class="token punctuation">)</span></code></pre></section></section></div><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span>