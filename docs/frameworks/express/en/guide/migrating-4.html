<!doctype html><html lang="en"><meta charset="utf-8"><title>Migrating to Express 4</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="guide"><meta name="redirect_from"content="/guide/migrating-4.html"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="moving-to-express-4"class="level1"><h1>Moving to Express 4</h1><h2 id="overview">Overview</h2><p>Express 4 is a breaking change from Express 3. That means an existing Express 3 app will <em>not</em> work if you update the Express version in its dependencies.<p>This article covers:<ul class="doclist"><li><a href="#changes">Changes in Express 4</a>.<li><a href="#example-migration">An example</a> of migrating an Express 3 app to Express 4.<li><a href="#app-gen">Upgrading to the Express 4 app generator</a>.</ul><h2 id="changes">Changes in Express 4</h2><p>There are several significant changes in Express 4:<ul class="doclist"><li><a href="#core-changes">Changes to Express core and middleware system.</a> The dependencies on Connect and built-in middleware were removed, so you must add middleware yourself.<li><a href="#routing">Changes to the routing system.</a><li><a href="#other-changes">Various other changes.</a></ul><p>See also:<ul><li><a href="https://github.com/expressjs/express/wiki/New-features-in-4.x">New features in 4.x.</a><li><a href="https://github.com/expressjs/express/wiki/Migrating-from-3.x-to-4.x">Migrating from 3.x to 4.x.</a></ul><h3 id="core-changes">Changes to Express core and middleware system</h3><p>Express 4 no longer depends on Connect, and removes all built-in middleware from its core, except for the <code>express.static</code> function. This means that Express is now an independent routing and middleware web framework, and Express versioning and releases are not affected by middleware updates.<p>Without built-in middleware, you must explicitly add all the middleware that is required to run your app. Simply follow these steps:<ol><li>Install the module: <code>npm install --save &#x3C;module-name></code><li>In your app, require the module: <code>require('module-name')</code><li>Use the module according to its documentation: <code>app.use( ... )</code></ol><p>The following table lists Express 3 middleware and their counterparts in Express 4.<table class="doctable"border="1"><tr><th>Express 3<th>Express 4<tr><td><code>express.bodyParser</code><td><a href="https://github.com/expressjs/body-parser">body-parser</a> + <a href="https://github.com/expressjs/multer">multer</a><tr><td><code>express.compress</code><td><a href="https://github.com/expressjs/compression">compression</a><tr><td><code>express.cookieSession</code><td><a href="https://github.com/expressjs/cookie-session">cookie-session</a><tr><td><code>express.cookieParser</code><td><a href="https://github.com/expressjs/cookie-parser">cookie-parser</a><tr><td><code>express.logger</code><td><a href="https://github.com/expressjs/morgan">morgan</a><tr><td><code>express.session</code><td><a href="https://github.com/expressjs/session">express-session</a><tr><td><code>express.favicon</code><td><a href="https://github.com/expressjs/serve-favicon">serve-favicon</a><tr><td><code>express.responseTime</code><td><a href="https://github.com/expressjs/response-time">response-time</a><tr><td><code>express.errorHandler</code><td><a href="https://github.com/expressjs/errorhandler">errorhandler</a><tr><td><code>express.methodOverride</code><td><a href="https://github.com/expressjs/method-override">method-override</a><tr><td><code>express.timeout</code><td><a href="https://github.com/expressjs/timeout">connect-timeout</a><tr><td><code>express.vhost</code><td><a href="https://github.com/expressjs/vhost">vhost</a><tr><td><code>express.csrf</code><td><a href="https://github.com/expressjs/csurf">csurf</a><tr><td><code>express.directory</code><td><a href="https://github.com/expressjs/serve-index">serve-index</a><tr><td><code>express.static</code><td><a href="https://github.com/expressjs/serve-static">serve-static</a></table><p>Here is the <a href="https://github.com/senchalabs/connect#middleware">complete list</a> of Express 4 middleware.<p>In most cases, you can simply replace the old version 3 middleware with its Express 4 counterpart. For details, see the module documentation in GitHub.<h4 id="app-use"><code>app.use</code> accepts parameters</h4><p>In version 4 you can use a variable parameter to define the path where middleware functions are loaded, then read the value of the parameter from the route handler. For example:<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/book/:id'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'ID:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token property-access">params</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h3 id="routing">The routing system</h3><p>Apps now implicitly load routing middleware, so you no longer have to worry about the order in which middleware is loaded with respect to the <code>router</code> middleware.<p>The way you define routes is unchanged, but the routing system has two new features to help organize your routes:<p>{: .doclist }<ul><li>A new method, <code>app.route()</code>, to create chainable route handlers for a route path.<li>A new class, <code>express.Router</code>, to create modular mountable route handlers.</ul><h4 id="app-route"><code>app.route()</code> method</h4><p>The new <code>app.route()</code> method enables you to create chainable route handlers for a route path. Because the path is specified in a single location, creating modular routes is helpful, as is reducing redundancy and typos. For more information about routes, see <a href="../4x/api.html#router"><code>Router()</code> documentation</a>.<p>Here is an example of chained route handlers that are defined by using the <code>app.route()</code> function.<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">route</span><span class="token punctuation">(</span><span class="token string">'/book'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Get a random book'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">post</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Add a book'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Update the book'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h4 id="express-router"><code>express.Router</code> class</h4><p>The other feature that helps to organize routes is a new class, <code>express.Router</code>, that you can use to create modular mountable route handlers. A <code>Router</code> instance is a complete middleware and routing system; for this reason it is often referred to as a "mini-app".<p>The following example creates a router as a module, loads middleware in it, defines some routes, and mounts it on a path on the main app.<p>For example, create a router file named <code>birds.js</code> in the app directory, with the following content:<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Router</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// middleware specific to this router</span>
router<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Time: '</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// define the home page route</span>
router<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'Birds home page'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// define the about route</span>
router<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/about'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'About birds'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> router</code></pre><p>Then, load the router module in the app:<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> birds <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./birds'</span><span class="token punctuation">)</span>

<span class="token comment">// ...</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token string">'/birds'</span><span class="token punctuation">,</span> birds<span class="token punctuation">)</span></code></pre><p>The app will now be able to handle requests to the <code>/birds</code> and <code>/birds/about</code> paths, and will call the <code>timeLog</code> middleware that is specific to the route.<h3 id="other-changes">Other changes</h3><p>The following table lists other small but important changes in Express 4:<table class="doctable"border="1"><tr><th>Object<th>Description<tr><td>Node.js<td>Express 4 requires Node.js 0.10.x or later and has dropped support for Node.js 0.8.x.<tr><td markdown="1">`http.createServer()`<td markdown="1">The `http` module is no longer needed, unless you need to directly work with it (socket.io/SPDY/HTTPS). The app can be started by using the `app.listen()` function.<tr><td markdown="1">`app.configure()`<td markdown="1">The `app.configure()` function has been removed. Use the `process.env.NODE_ENV` or `app.get('env')` function to detect the environment and configure the app accordingly.<tr><td markdown="1">`json spaces`<td markdown="1">The `json spaces` application property is disabled by default in Express 4.<tr><td markdown="1">`req.accepted()`<td markdown="1">Use `req.accepts()`, `req.acceptsEncodings()`, `req.acceptsCharsets()`, and `req.acceptsLanguages()`.<tr><td markdown="1">`res.location()`<td markdown="1">No longer resolves relative URLs.<tr><td markdown="1">`req.params`<td markdown="1">Was an array; now an object.<tr><td markdown="1">`res.locals`<td markdown="1">Was a function; now an object.<tr><td markdown="1">`res.headerSent`<td markdown="1">Changed to `res.headersSent`.<tr><td markdown="1">`app.route`<td markdown="1">Now available as `app.mountpath`.<tr><td markdown="1">`res.on('header')`<td markdown="1">Removed.<tr><td markdown="1">`res.charset`<td markdown="1">Removed.<tr><td markdown="1">`res.setHeader('Set-Cookie', val)`<td markdown="1">Functionality is now limited to setting the basic cookie value. Use `res.cookie()` for added functionality.</table><h2 id="example-migration">Example app migration</h2><p>Here is an example of migrating an Express 3 application to Express 4. The files of interest are <code>app.js</code> and <code>package.json</code>.<h3 id="">Version 3 app</h3><h4 id=""><code>app.js</code></h4><p>Consider an Express v.3 application with the following <code>app.js</code> file:<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/user'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// all environments</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'pug'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">favicon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">methodOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">'your secret here'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">router</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// development only</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'env'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span><span class="token property-access">index</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token property-access">list</span><span class="token punctuation">)</span>

http<span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Express server listening on port '</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><h4 id=""><code>package.json</code></h4><p>The accompanying version 3 <code>package.json</code> file might look something like this:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"application-name"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
  <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node app.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"3.12.0"</span><span class="token punctuation">,</span>
    <span class="token property">"pug"</span><span class="token operator">:</span> <span class="token string">"*"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h3 id="">Process</h3><p>Begin the migration process by installing the required middleware for the Express 4 app and updating Express and Pug to their respective latest version with the following command:<pre class="language-console"><code class="language-console">$ npm install serve-favicon morgan method-override express-session body-parser multer errorhandler express@latest pug@latest --save</code></pre><p>Make the following changes to <code>app.js</code>:<ol><li><p>The built-in Express middleware functions <code>express.favicon</code>, <code>express.logger</code>, <code>express.methodOverride</code>, <code>express.session</code>, <code>express.bodyParser</code> and <code>express.errorHandler</code> are no longer available on the <code>express</code> object. You must install their alternatives manually and load them in the app.<li><p>You no longer need to load the <code>app.router</code> function. It is not a valid Express 4 app object, so remove the <code>app.use(app.router);</code> code.<li><p>Make sure that the middleware functions are loaded in the correct order - load <code>errorHandler</code> after loading the app routes.</ol><h3 id="">Version 4 app</h3><h4 id=""><code>package.json</code></h4><p>Running the above <code>npm</code> command will update <code>package.json</code> as follows:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"application-name"</span><span class="token punctuation">,</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"0.0.1"</span><span class="token punctuation">,</span>
  <span class="token property">"private"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"start"</span><span class="token operator">:</span> <span class="token string">"node app.js"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"body-parser"</span><span class="token operator">:</span> <span class="token string">"^1.5.2"</span><span class="token punctuation">,</span>
    <span class="token property">"errorhandler"</span><span class="token operator">:</span> <span class="token string">"^1.1.1"</span><span class="token punctuation">,</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"^4.8.0"</span><span class="token punctuation">,</span>
    <span class="token property">"express-session"</span><span class="token operator">:</span> <span class="token string">"^1.7.2"</span><span class="token punctuation">,</span>
    <span class="token property">"pug"</span><span class="token operator">:</span> <span class="token string">"^2.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"method-override"</span><span class="token operator">:</span> <span class="token string">"^2.1.2"</span><span class="token punctuation">,</span>
    <span class="token property">"morgan"</span><span class="token operator">:</span> <span class="token string">"^1.2.2"</span><span class="token punctuation">,</span>
    <span class="token property">"multer"</span><span class="token operator">:</span> <span class="token string">"^0.1.3"</span><span class="token punctuation">,</span>
    <span class="token property">"serve-favicon"</span><span class="token operator">:</span> <span class="token string">"^2.0.1"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><h4 id=""><code>app.js</code></h4><p>Then, remove invalid code, load the required middleware, and make other changes as necessary. The <code>app.js</code> file will look like this:<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> routes <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/user'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> favicon <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'serve-favicon'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> methodOverride <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'method-override'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-session'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> bodyParser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> multer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> errorHandler <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'errorhandler'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// all environments</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'views'</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'views'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'view engine'</span><span class="token punctuation">,</span> <span class="token string">'pug'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">favicon</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'/public/favicon.ico'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span><span class="token string">'dev'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">methodOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">resave</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">saveUninitialized</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">secret</span><span class="token operator">:</span> <span class="token string">'uwotm8'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token method function property-access">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">extended</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token method function property-access">static</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> routes<span class="token punctuation">.</span><span class="token property-access">index</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token property-access">list</span><span class="token punctuation">)</span>

<span class="token comment">// error handling middleware should be loaded after the loading the routes</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'env'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token method function property-access">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Express server listening on port '</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><div class="doc-box doc-info"markdown="1">Unless you need to work directly with the `http` module (socket.io/SPDY/HTTPS), loading it is not required, and the app can be simply started this way:<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Express server listening on port '</span> <span class="token operator">+</span> app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></div><h3 id="">Run the app</h3><p>The migration process is complete, and the app is now an Express 4 app. To confirm, start the app by using the following command:<pre class="language-console"><code class="language-console">$ node .</code></pre><p>Load <a href="http://localhost:3000">http://localhost:3000</a> and see the home page being rendered by Express 4.<h2 id="app-gen">Upgrading to the Express 4 app generator</h2><p>The command-line tool to generate an Express app is still <code>express</code>, but to upgrade to the new version, you must uninstall the Express 3 app generator and then install the new <code>express-generator</code>.<h3 id="">Installing</h3><p>If you already have the Express 3 app generator installed on your system, you must uninstall it:<pre class="language-console"><code class="language-console">$ npm uninstall -g express</code></pre><p>Depending on how your file and directory privileges are configured, you might need to run this command with <code>sudo</code>.<p>Now install the new generator:<pre class="language-console"><code class="language-console">$ npm install -g express-generator</code></pre><p>Depending on how your file and directory privileges are configured, you might need to run this command with <code>sudo</code>.<p>Now the <code>express</code> command on your system is updated to the Express 4 generator.<h3 id="">Changes to the app generator</h3><p>Command options and use largely remain the same, with the following exceptions:<p>{: .doclist }<ul><li>Removed the <code>--sessions</code> option.<li>Removed the <code>--jshtml</code> option.<li>Added the <code>--hogan</code> option to support <a href="http://twitter.github.io/hogan.js/">Hogan.js</a>.</ul><h3 id="">Example</h3><p>Execute the following command to create an Express 4 app:<pre class="language-console"><code class="language-console">$ express app4</code></pre><p>If you look at the contents of the <code>app4/app.js</code> file, you will notice that all the middleware functions (except <code>express.static</code>) that are required for the app are loaded as independent modules, and the <code>router</code> middleware is no longer explicitly loaded in the app.<p>You will also notice that the <code>app.js</code> file is now a Node.js module, in contrast to the standalone app that was generated by the old generator.<p>After installing the dependencies, start the app by using the following command:<pre class="language-console"><code class="language-console">$ npm start</code></pre><p>If you look at the npm start script in the <code>package.json</code> file, you will notice that the actual command that starts the app is <code>node ./bin/www</code>, which used to be <code>node app.js</code> in Express 3.<p>Because the <code>app.js</code> file that was generated by the Express 4 generator is now a Node.js module, it can no longer be started independently as an app (unless you modify the code). The module must be loaded in a Node.js file and started via the Node.js file. The Node.js file is <code>./bin/www</code> in this case.<p>Neither the <code>bin</code> directory nor the extensionless <code>www</code> file is mandatory for creating an Express app or starting the app. They are just suggestions made by the generator, so feel free to modify them to suit your needs.<p>To get rid of the <code>www</code> directory and keep things the "Express 3 way", delete the line that says <code>module.exports = app;</code> at the end of the <code>app.js</code> file, then paste the following code in its place:<pre class="language-js"><code class="language-js">app<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3000</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Express server listening on port '</span> <span class="token operator">+</span> server<span class="token punctuation">.</span><span class="token method function property-access">address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">port</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Ensure that you load the <code>debug</code> module at the top of the <code>app.js</code> file by using the following code:<pre class="language-js"><code class="language-js"><span class="token keyword">var</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'app4'</span><span class="token punctuation">)</span></code></pre><p>Next, change <code>"start": "node ./bin/www"</code> in the <code>package.json</code> file to <code>"start": "node app.js"</code>.<p>You have now moved the functionality of <code>./bin/www</code> back to <code>app.js</code>. This change is not recommended, but the exercise helps you to understand how the <code>./bin/www</code> file works, and why the <code>app.js</code> file no longer starts on its own. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>