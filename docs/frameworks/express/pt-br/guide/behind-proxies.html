<!doctype html><html lang="pt-br"><meta charset="utf-8"><title>Express atrás de proxies</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="guide"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="express-atrás-de-proxies"class="level1"><h1>Express atrás de proxies</h1><p>Ao executar um aplicativo do Express atrás de um proxy, configure (usando <a href="../4x/api.html#app.set">app.set()</a>) a variável do aplicativo <code>trust proxy</code> para um dos valores listados na seguinte tabela.<div class="doc-box doc-info"markdown="1">Apesar de a execução do aplicativo não falhar se a variável do aplicativo `trust proxy` não estiver configurada, ele irá registrar incorretamente o endereço de IP do proxy como o endereço de IP do cliente a não ser que o `trust proxy` esteja configurado.</div><table class="doctable"border="1"markdown="1"><thead><tr><th>Tipo<th>Valor<tbody><tr><td>Booleano<td markdown="1">Se `true`, o endereço de IP do cliente será compreendido como a entrada mais a esquerda no cabeçalho `X-Forwarded-*`.<p>Se <code>false</code>, o aplicativo é compreendido como exposto diretamente à Internet e o endereço de IP do cliente é derivado a partir do <code>req.connection.remoteAddress</code>. Esta é a configuração padrão.<tr><td>Endereços IP<td markdown="1">Um endereço de IP, sub-rede, ou uma matriz de endereços de IP e sub-redes confiáveis. A lista a seguir mostra os nomes de sub-rede pré-configurados:<ul><li>loopback - <code>127.0.0.1/8</code>, <code>::1/128</code><li>linklocal - <code>169.254.0.0/16</code>, <code>fe80::/10</code><li>uniquelocal - <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code>, <code>fc00::/7</code></ul><p>É possível configurar endereços de IP de qualquer uma das formas a seguir:<pre><code class="language-js"translate="no">app.set('trust proxy', 'loopback') // specify a single subnet
app.set('trust proxy', 'loopback, 123.123.123.123') // specify a subnet and an address
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // specify multiple subnets as CSV
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // specify multiple subnets as an array</code>
</pre><p>Quando especificados, os endereços de IP ou sub-redes são excluídos do processo de determinação de endereço, e o endereço de IP não confiável mais próximos do servidor de aplicativos é determinado como o endereço de IP do cliente.<tr><td>Número<td markdown="1">Confia no `n`-ésimo hop a partir do servidor de proxy frontal como o cliente.<tr><td>Função<td markdown="1">Implementação de confiança customizada. Use apenas se souber o que está fazendo.<pre><code class="language-js"translate="no">app.set('trust proxy', function (ip) {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true; // trusted IPs
  else return false;
});</code>
</pre></table><p>Configurando um valor não-<code>false</code> para o <code>trust proxy</code> resulta em três mudanças importantes:<ul><li markdown="1">O valor de [req.hostname](../api.html#req.hostname) é derivado do valor configurado no cabeçalho `X-Forwarded-Host`, que pode ser configurado pelo cliente ou pelo proxy.<li markdown="1">`X-Forwarded-Proto` pode ser configurado pelo proxy reverso para dizer ao aplicativo se ele é `https` ou `http` ou até um nome inválido. Este valor é refletido pelo [req.protocol](../api.html#req.protocol).<li markdown="1">Os valores [req.ip](../api.html#req.ip) e [req.ips](../api.html#req.ips) são populados com a lista de endereços do `X-Forwarded-For`.</ul><p>A configuração do <code>trust proxy</code> é implementada usando o pacote <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a>. Para obter mais informações, consulte a documentação. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>