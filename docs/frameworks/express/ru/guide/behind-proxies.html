<!doctype html><html lang="ru"><meta charset="utf-8"><title>Express за прокси</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="layout"content="page"><meta name="menu"content="guide"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="express-за-прокси"class="level1"><h1>Express за прокси</h1><p>При запуске приложения Express за прокси-сервером, необходимо указать (с помощью <a href="../4x/api.html#app.set">app.set()</a>) для переменной приложения <code>trust proxy</code> одно из значений, приведенных в таблице ниже.<div class="doc-box doc-info"markdown="1">Хотя приложение будет запущено и без указания значения переменной приложения `trust proxy`, отсутствие заданного значения `trust proxy` приведет к некорректной регистрации IP-адреса прокси в качестве клиентского IP-адреса.</div><table class="doctable"border="1"markdown="1"><thead><tr><th>Тип<th>Значение<tbody><tr><td>Булевский<td markdown="1">Если указано значение `true`, клиентским IP-адресом считается первая слева запись в заголовке `X-Forwarded-*`.<p>Если указано значение <code>false</code>, приложение считается имеющим прямой выход в Интернет, и IP-адрес клиента будет производным от <code>req.connection.remoteAddress</code>. Это значение используется по умолчанию.<tr><td>IP-адреса<td markdown="1">IP-адрес, подсеть или массив IP-адресов и подсетей, считающихся надежными. В приведенном ниже списке перечислены предварительно заданные имена подсетей:<ul><li>loopback - <code>127.0.0.1/8</code>, <code>::1/128</code><li>linklocal - <code>169.254.0.0/16</code>, <code>fe80::/10</code><li>uniquelocal - <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code>, <code>fc00::/7</code></ul><p>IP-адреса можно задать любым из указанных ниже способов:<pre><code class="language-js"translate="no">app.set('trust proxy', 'loopback') // specify a single subnet
app.set('trust proxy', 'loopback, 123.123.123.123') // specify a subnet and an address
app.set('trust proxy', 'loopback, linklocal, uniquelocal') // specify multiple subnets as CSV
app.set('trust proxy', ['loopback', 'linklocal', 'uniquelocal']) // specify multiple subnets as an array</code>
</pre><p>Если IP-адреса или подсети указаны, они исключаются из процесса определения адреса, и незащищенный IP-адрес, ближайший к серверу приложений, будет определен как IP-адрес клиента.<tr><td>Число<td markdown="1">Считать защищенным `n`-й элемент пути от прокси-сервера со стороны клиента, в качестве клиента.<tr><td>Функция<td markdown="1">Реализация нестандартного механизма защиты. Используйте этот метод, только если вы уверены в своих знаниях.<pre><code class="language-js"translate="no">app.set('trust proxy', function (ip) {
  if (ip === '127.0.0.1' || ip === '123.123.123.123') return true; // trusted IPs
  else return false;
});</code>
</pre></table><p>Установка значения, отличного от <code>false</code>, для <code>trust proxy</code> ведет к трем существенным изменениям:<ul><li markdown="1">Значение [req.hostname](../api.html#req.hostname) является производным от значения, указанного в заголовке `X-Forwarded-Host`, который может быть задан клиентом или прокси.<li markdown="1">Заголовок `X-Forwarded-Proto` может быть задан обратным прокси-сервером и указывает приложению на использование протокола `https`, или `http`, или даже недопустимого имени. Это значение отражается в [req.protocol](../api.html#req.protocol).<li markdown="1">Значения [req.ip](../api.html#req.ip) и [req.ips](../api.html#req.ips) заполняются собой списком адресов, взятых из `X-Forwarded-For`.</ul><p>Параметр <code>trust proxy</code> реализуется с помощью пакета <a href="https://www.npmjs.com/package/proxy-addr">proxy-addr</a>. Дополнительная информация приведена в документации к нему. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>