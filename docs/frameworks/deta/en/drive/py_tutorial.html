<!doctype html><html id="py_tutorial"lang="en"><meta charset="utf-8"><title>Python Tutorial</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><p>import Tabs from '@theme/Tabs'; import TabItem from '@theme/TabItem';<section id="building-a-simple-image-server-with-deta-drive"class="level2"><h2>Building a Simple Image Server with Deta Drive</h2><section id="setup"class="level3"><h3>Setup</h3><p>To get started, create a directory <code>image-server</code> and change the current directory into it.<pre class="language-shell"><code class="language-shell">$ <span class="token function">mkdir</span> image-server <span class="token operator">&#x26;&#x26;</span> <span class="token builtin class-name">cd</span> image-server</code></pre><p>Before we begin, let's install all the necessary dependencies for this project. Create a <code>requirements.txt</code> with the following lines:<pre class="language-json"><code class="language-json">fastapi
uvicorn
deta
python-multipart</code></pre><blockquote>If you are using Deta Drive within a Deta Micro, you should ignore `uvicorn`, but you must include `deta` in your `requirements.txt` file to install the lastest sdk version, other than that it won't work.work.</blockquote><p>We are using <code>FastAPI</code> to build our simple image server, and <code>python-multipart</code> allows us access the uploaded files.<p>Run the following command to install the dependencies.<pre class="language-shell"><code class="language-shell">$ pip <span class="token function">install</span> -r requirements.txt</code></pre><p>To configure the app, import the dependencies and instantiate drive in <code>main.py</code><pre class="language-python"><code class="language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> File<span class="token punctuation">,</span> UploadFile
<span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> HTMLResponse<span class="token punctuation">,</span> StreamingResponse
<span class="token keyword">from</span> deta <span class="token keyword">import</span> Deta

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>
deta <span class="token operator">=</span> Deta<span class="token punctuation">(</span>Project_Key<span class="token punctuation">)</span>  <span class="token comment"># configure your Deta project </span>
drive <span class="token operator">=</span> deta<span class="token punctuation">.</span>Drive<span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token comment"># access to your drive</span></code></pre><p>We have everything we need to ðŸš€</section><section id="uploading-images"class="level3"><h3>Uploading Images</h3><p>First, we need to render a HTML snippet to display the file upload interface.<p>We'll expose a function that renders the HTML snippet on the base route <code>/</code><pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">,</span> response_class<span class="token operator">=</span>HTMLResponse<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> 
    <span class="token operator">&#x3C;</span>form action<span class="token operator">=</span><span class="token operator">/</span>upload enctype<span class="token operator">=</span>multipart<span class="token operator">/</span>form<span class="token operator">-</span>data method<span class="token operator">=</span>post<span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token builtin">input</span> name<span class="token operator">=</span><span class="token builtin">file</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">file</span><span class="token operator">></span>
        <span class="token operator">&#x3C;</span><span class="token builtin">input</span> <span class="token builtin">type</span><span class="token operator">=</span>submit<span class="token operator">></span>
    <span class="token operator">&#x3C;</span><span class="token operator">/</span>form<span class="token operator">></span>
    </code></pre><p>We are simply rendering a form that sends a HTTP <code>POST</code> request to the route <code>/upload</code> with file data.<p>Let's complete file upload by creating a function to handle <code>/upload</code><pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token operator">/</span>upload<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">upload_img</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">:</span> UploadFile <span class="token operator">=</span> File<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span>filename
    f <span class="token operator">=</span> <span class="token builtin">file</span><span class="token punctuation">.</span><span class="token builtin">file</span>
    res <span class="token operator">=</span> drive<span class="token punctuation">.</span>put<span class="token punctuation">(</span>name<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
    <span class="token keyword">return</span> res</code></pre><p>Thanks to the amazing tools from FastAPI, we can simply wrap the input around <code>UploadFile</code> and <code>File</code> to access the image data. We can retrieve the name as well as bytes from <code>file</code> and store it in Drive.</section><section id="downloading-images"class="level3"><h3>Downloading images</h3><p>To download images, we can simply use <code>drive.get(name)</code><p>If we tie a <code>GET</code> request to the <code>/download</code> path with a param giving a name (i.e <code>/download/space.png</code>), we can return the image over HTTP.<pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>get</span><span class="token punctuation">(</span><span class="token operator">/</span>download<span class="token operator">/</span><span class="token punctuation">{</span>name<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">download_img</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    res <span class="token operator">=</span> drive<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
    <span class="token keyword">return</span> StreamingResponse<span class="token punctuation">(</span>res<span class="token punctuation">.</span>iter_chunks<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span> media_type<span class="token operator">=</span>image<span class="token operator">/</span>png<span class="token punctuation">)</span></code></pre><p>You can learn more about <code>StreamingResponse</code> <a href="https://fastapi.tiangolo.com/advanced/custom-response/#streamingresponse">here</a>.</section><section id="running-the-server"class="level3"><h3>Running the server</h3><p>To run the server locally, navigate to the terminal in the project directory (<code>image-server</code>) and run the following command:<pre class="language-shell"><code class="language-shell">$ uvicorn main:app</code></pre><p>Your image server is now ready! You can interact with it at <code>/</code> and check it out!</p><img src="/img/drive/drive-py-tut.png"alt="//"> <img src="/img/drive/drive-py-tut-1.png"alt="/download/tut.jpg/"><pre class="language-shell"><code class="language-shell">
<span class="token function">curl</span> -X <span class="token string">'POST'</span> <span class="token punctuation">\</span>
  <span class="token string">'http://127.0.0.1:8000/upload'</span> <span class="token punctuation">\</span>
  -H <span class="token string">'accept: application/json'</span> <span class="token punctuation">\</span>
  -H <span class="token string">'Content-Type: multipart/form-data'</span> <span class="token punctuation">\</span>
  -F <span class="token string">'file=@space.png;type=image/png'</span>

Response 
space.png


<span class="token function">curl</span> -X <span class="token string">'GET'</span> <span class="token punctuation">\</span>
  <span class="token string">'http://127.0.0.1:8000/download/space.png'</span> <span class="token punctuation">\</span>
  -H <span class="token string">'accept: application/json'</span>

Response 
The server should respond with the image.</code></pre></section></section><section id="issues"class="level2"><h2>Issues</h2><p>If you run into any issues, consider reporting them in our <a href="https://github.com/orgs/deta/discussions">Github Discussions</a>.<span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>