<!doctype html><html id="expiring_items"lang="en"><meta charset="utf-8"><title>Expiring Items</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><p>import Tabs from '@theme/Tabs'; import TabItem from '@theme/TabItem';<p>Deta Base supports storing items with an expiration timestamp. Items with an expired timestamp will be automatically deleted from your Base.<section id="storing"class="level2"><h2>Storing</h2><p>Items specify the expiration timestamp value in a field name <code>__expires</code> in the item itself. The value is a <a href="https://en.wikipedia.org/wiki/Unix_time">Unix time</a>, a number.<p>For e.g.<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  key<span class="token operator">:</span> item_key<span class="token punctuation">,</span>
  msg<span class="token operator">:</span> this will be deleted<span class="token punctuation">,</span>
  __expires<span class="token operator">:</span> <span class="token number">1672531200</span>
<span class="token punctuation">}</span></code></pre><p>The item above will be deleted automatically on <code>2023-01-01 00:00:00 GMT</code> (the equivalent date of the timestamp above).<p>You can use the <a href="./sdk.md">Base SDK</a> to <a href="./sdk#put"><code>put</code></a>, <a href="./sdk#put_many"><code>put_many</code></a> or <a href="./sdk#insert"><code>insert</code></a> items with an expiration timestamp (or the <a href="./HTTP.md">HTTP API</a> directly).<blockquote>Storing an item with an already expired timestamp will not fail but the item will be immediately deleted.</blockquote><blockquote>Base SDKs might offer higher level methods with easier APIs to specify the expiration timestamp. If they do so, they still store the timestamp in the item itself as mentioned above.</blockquote><section id="examples"class="level3"><h3>Examples</h3><p>&#x3C;Tabs groupId=lang defaultValue=js values={[ { label: 'JavaScript', value: 'js', }, { label: 'Python', value: 'py', }, { label: 'Go', value: 'go', }, { label: 'HTTP', value: 'http', }, ]}<blockquote></blockquote><tabitem value="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token maybe-class-name">Deta</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'deta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function"><span class="token maybe-class-name">Deta</span></span><span class="token punctuation">(</span>project_key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Base</span></span><span class="token punctuation">(</span><span class="token string">'examples'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> item <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">'value'</span><span class="token operator">:</span> <span class="token string">'temp'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// expire in 300 seconds</span>
<span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">put</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'temp_key'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">expireIn</span><span class="token operator">:</span><span class="token number">300</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// expire at date</span>
<span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">put</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token string">'temp_key'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">expireAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2023-01-01T00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></tabitem><tabitem value="py"><pre class="language-py"><code class="language-py"><span class="token keyword">import</span> datetime
<span class="token keyword">from</span> deta <span class="token keyword">import</span> Deta

db <span class="token operator">=</span> Deta<span class="token punctuation">(</span>project_key<span class="token punctuation">)</span><span class="token punctuation">.</span>Base<span class="token punctuation">(</span>examples<span class="token punctuation">)</span>

item <span class="token operator">=</span> <span class="token punctuation">{</span>key<span class="token punctuation">:</span> temp_key<span class="token punctuation">,</span> value<span class="token punctuation">:</span> temp<span class="token punctuation">}</span>

<span class="token comment"># expire in 300 seconds</span>
db<span class="token punctuation">.</span>put<span class="token punctuation">(</span>item<span class="token punctuation">,</span> expire_in<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>

<span class="token comment"># expire at date</span>
expire_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span><span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span>01T00<span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>put<span class="token punctuation">(</span>item<span class="token punctuation">,</span> expire_at<span class="token operator">=</span>expire_at<span class="token punctuation">)</span></code></pre></tabitem><tabitem value="go"><pre class="language-go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
  log
  time
  
  github<span class="token punctuation">.</span>com<span class="token operator">/</span>deta<span class="token operator">/</span>deta<span class="token operator">-</span><span class="token keyword">go</span><span class="token operator">/</span>deta
  github<span class="token punctuation">.</span>com<span class="token operator">/</span>deta<span class="token operator">/</span>deta<span class="token operator">-</span><span class="token keyword">go</span><span class="token operator">/</span>service<span class="token operator">/</span>base
<span class="token punctuation">)</span>

<span class="token keyword">type</span> TmpData <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  Key <span class="token builtin">string</span> <span class="token string">`json: key`</span>
  Value <span class="token builtin">string</span> <span class="token string">`json:value`</span>
  <span class="token comment">// json struct tag `__expires` for expiration timestamp</span>
  <span class="token comment">// 'omitempty' to prevent default 0 value</span>
  Expires <span class="token builtin">int64</span> <span class="token string">`json:__expires,omitempty`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// errors ignored for brevity</span>
  d<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> deta<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>deta<span class="token punctuation">.</span><span class="token function">WithProjectKey</span><span class="token punctuation">(</span>project_key<span class="token punctuation">)</span><span class="token punctuation">)</span>
  db<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> base<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> examples<span class="token punctuation">)</span>

  tmp <span class="token operator">:=</span> <span class="token operator">&#x26;</span>TmpData<span class="token punctuation">{</span>
    Key<span class="token punctuation">:</span> temp_key<span class="token punctuation">,</span>
    Value<span class="token punctuation">:</span> temp<span class="token punctuation">,</span>
    Expires<span class="token punctuation">:</span> time<span class="token punctuation">.</span><span class="token function">Date</span><span class="token punctuation">(</span><span class="token number">2023</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>UTC<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Unix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
  <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>
  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>failed to put item<span class="token punctuation">:</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span> 
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></tabitem><tabitem value="http"><pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> -X PUT https://database.deta.sh/v1/test_project_id/examples/items <span class="token punctuation">\</span>
    -H Content-Type: application/json <span class="token punctuation">\</span>
    -H X-Api-Key: test_project_key <span class="token punctuation">\</span>
    -d <span class="token punctuation">{</span>items:<span class="token punctuation">[</span><span class="token punctuation">{</span>key: temp_key, value: temp, __expires: <span class="token number">1672531200</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre></tabitem></section></section><section id="retrieving"class="level2"><h2>Retrieving</h2><p>When you retrieve items with an expiration timestamp, the timestamp value will be present in the <code>__expires</code> field. The value is a <a href="https://en.wikipedia.org/wiki/Unix_time">Unix time</a>.<p><code>Get</code> and <code>Query</code> operations will not retrieve already expired items.<section id="examples-1"class="level3"><h3>Examples</h3><p>&#x3C;Tabs groupId=lang defaultValue=js values={[ { label: 'JavaScript', value: 'js', }, { label: 'Python', value: 'py', }, { label: 'Go', value: 'go', }, { label: 'HTTP', value: 'http', }, ]}<blockquote></blockquote><tabitem value="js"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> __expires <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span>temp_key<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></tabitem><tabitem value="py"><pre class="language-py"><code class="language-py">expires <span class="token operator">=</span> db<span class="token punctuation">.</span>get<span class="token punctuation">(</span>temp_key<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span>__expires<span class="token punctuation">)</span></code></pre></tabitem><tabitem value="go"><pre class="language-go"><code class="language-go">dest <span class="token operator">:=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span>
  Key     <span class="token builtin">string</span> <span class="token string">`json:key`</span>
  Expires <span class="token builtin">int64</span>  <span class="token string">`json:__expires,omitempty`</span>
<span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>temp_key<span class="token punctuation">,</span> <span class="token operator">&#x26;</span>dest<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>failed to get item<span class="token punctuation">:</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

expires <span class="token operator">:=</span> dest<span class="token punctuation">.</span>Expires</code></pre></tabitem><tabitem value="http"><pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> https://database.deta.sh/v1/test_project_id/examples/items/temp_key <span class="token punctuation">\</span>
    -H X-Api-Key: test_project_key

<span class="token punctuation">{</span>key: temp_key, value: temp, __expires: <span class="token number">1672531200</span><span class="token punctuation">}</span></code></pre></tabitem></section></section><section id="updating"class="level2"><h2>Updating</h2><p>You can update the expiration timestamp with a new timestamp by updating the value of the <code>__expires</code> as long as the item has not already expired.<p>Updating other fields of the item <strong>does not</strong> update (or renew) the expiration timestamp. You <strong>must</strong> update the value of <code>__expires</code> field.<p>You can use the <a href="./sdk.md">Base SDK</a> to <a href="./sdk#update"><code>update</code></a> the expiration timestamp (or the <a href="./HTTP.md">HTTP API</a> directly).<section id="examples-2"class="level3"><h3>Examples</h3><p>&#x3C;Tabs groupId=lang defaultValue=js values={[ { label: 'JavaScript', value: 'js', }, { label: 'Python', value: 'py', }, { label: 'Go', value: 'go', }, { label: 'HTTP', value: 'http', }, ]}<blockquote></blockquote><tabitem value="js"><pre class="language-js"><code class="language-js"><span class="token comment">// update item to expire in 300 seconds from now </span>
<span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> temp_key<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">expireIn</span><span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// update item to expire at date</span>
<span class="token keyword control-flow">await</span> db<span class="token punctuation">.</span><span class="token method function property-access">update</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> temp_key<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">expireAt</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2023-01-01T00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></tabitem><tabitem value="py"><pre class="language-py"><code class="language-py"><span class="token comment"># update item to expire in 300 seconds from now</span>
db<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> temp_key<span class="token punctuation">,</span> expire_in<span class="token operator">=</span><span class="token number">300</span><span class="token punctuation">)</span>

<span class="token comment"># update item to expire at date</span>
expire_at <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span><span class="token number">2023</span><span class="token operator">-</span><span class="token number">01</span><span class="token operator">-</span>01T00<span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">)</span>
db<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> temp_key<span class="token punctuation">,</span> expire_at<span class="token operator">=</span>expire_at<span class="token punctuation">)</span></code></pre></tabitem><tabitem value="go"><pre class="language-go"><code class="language-go">updates <span class="token operator">:=</span> base<span class="token punctuation">.</span>Updates<span class="token punctuation">{</span>
  __expires<span class="token punctuation">:</span> <span class="token number">1672531200</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> err <span class="token operator">:=</span> db<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>temp_key<span class="token punctuation">,</span> updates<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
  log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>failed to update item<span class="token punctuation">:</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre></tabitem><tabitem value="http"><pre class="language-shell"><code class="language-shell"><span class="token function">curl</span> -X PATCH https://database.data.sh/v1/test_project_id/examples/items/temp_key <span class="token punctuation">\</span>
    -H Content-Type: application/json <span class="token punctuation">\</span>
    -H X-Api-Key: test_project_key <span class="token punctuation">\</span>
    -d <span class="token punctuation">{</span>set: <span class="token punctuation">{</span>__expires: <span class="token number">1672531200</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></tabitem></section></section><section id="issues"class="level2"><h2>Issues</h2><p>If you run into any issues, consider reporting them in our <a href="https://github.com/orgs/deta/discussions">Github Discussions</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section>