<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Windows - Code signing guide locally &#x26; with GitHub Actions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="sidebar_label" content="Windows Code Signing">
    <meta name="sidebar_position" content="2">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/shinokada/prism-coy-theme/main/theme_common.css">
  </head>
  <body>
    <section id="windows---code-signing-guide-locally--with-github-actions" class="level1">
      <h1>Windows - Code signing guide locally &#x26; with GitHub Actions</h1>
      <section id="intro" class="level2">
        <h2>Intro</h2>
        <p>Code signing your application lets users know that they downloaded the official executable of your app and not some 3rd party malware that poses as your app. While it is not required, it improves users' confidence in your app.</p>
      </section>
      <section id="prerequisites" class="level2">
        <h2>Prerequisites</h2>
        <ul>
          <li>Windows - you can likely use other platforms, but this tutorial uses Powershell native features.</li>
          <li>A working Tauri application</li>
          <li>Code signing certificate - you can acquire one of these on services listed in <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/dashboard/code-signing-cert-manage">Microsoft's docs</a>. There are likely additional authorities for non-EV certificates than included in that list, please compare them yourself and choose one at your own risk.
            <ul>
              <li>Please make sure to get a <strong>code signing</strong> certificate, SSL certificates do not work!</li>
            </ul>
          </li>
        </ul>
        <p>This guide assumes that you have a standard code signing certificate> If you have an EV certificate, which generally involves a hardware token, please follow your issuer's documentation instead.</p>
        <blockquote>
          <p>If you sign the app with an EV Certificate, it'll receive an immediate reputation with Microsoft SmartScreen and won't show any warnings to users.</p>
          <p>If you opt for an OV Certificate, which is generally cheaper and available to individuals, Microsoft SmartScreen will still show a warning to users when they download the app. It might take some time until your certificate builds enough reputation. You may opt for <a href="https://www.microsoft.com/en-us/wdsi/filesubmission/">submitting your app</a> to Microsoft for manual review. Although not guaranteed, if the app does not contain any malicious code, Microsoft may grant additional reputation and potentially remove the warning for that specific uploaded file.</p>
        </blockquote>
      </section>
      <section id="getting-started" class="level2">
        <h2>Getting Started</h2>
        <p>There are a few things we have to do to get Windows prepared for code signing. This includes converting our certificate to a specific format, installing this certificate, and decoding the required information from the certificate.</p>
        <section id="a-convert-your-cer-to-pfx" class="level3">
          <h3>A. Convert your <code>.cer</code> to <code>.pfx</code></h3>
          <ol>
            <li>
              <p>You will need the following:</p>
              <ul>
                <li>certificate file (mine is <code>cert.cer</code>)</li>
                <li>private key file (mine is <code>private-key.key</code>)</li>
              </ul>
            </li>
            <li>
              <p>Open up a command prompt and change to your current directory using <code>cd Documents/Certs</code></p>
            </li>
            <li>
              <p>Convert your <code>.cer</code> to a <code>.pfx</code> using <code>openssl pkcs12 -export -in cert.cer -inkey private-key.key -out certificate.pfx</code></p>
            </li>
            <li>
              <p>You should be prompted to enter an export password <strong>DON'T FORGET IT!</strong></p>
            </li>
          </ol>
        </section>
        <section id="b-import-your-pfx-file-into-the-keystore" class="level3">
          <h3>B. Import your <code>.pfx</code> file into the keystore.</h3>
          <p>We now need to import our <code>.pfx</code> file.</p>
          <ol>
            <li>
              <p>Assign your export password to a variable using <code>$WINDOWS_PFX_PASSWORD = 'MYPASSWORD'</code></p>
            </li>
            <li>
              <p>Now Import the certificate using <code>Import-PfxCertificate -FilePath Certs/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_PFX_PASSWORD -Force -AsPlainText)</code></p>
            </li>
          </ol>
        </section>
        <section id="c-prepare-variables" class="level3">
          <h3>C. Prepare Variables</h3>
          <ol>
            <li>We need the SHA-1 thumbprint of the certificate; you can get this using <code>openssl pkcs12 -info -in certificate.pfx</code> and look under for following</li>
          </ol>
          <pre class="language-text"><code class="language-text">Bag Attributes
    localKeyID: A1 B1 A2 B2 A3 B3 A4 B4 A5 B5 A6 B6 A7 B7 A8 B8 A9 B9 A0 B0</code></pre>
          <ol start="2">
            <li>
              <p>You will capture the <code>localKeyID</code> but with no spaces, in this example, it would be <code>A1B1A2B2A3B3A4B4A5B5A6B6A7B7A8B8A9B9A0B0</code>. This is our <code>certificateThumbprint</code>.</p>
            </li>
            <li>
              <p>We need the SHA digest algorithm used for your certificate (Hint: this is likely <code>sha256</code></p>
            </li>
            <li>
              <p>We also need a timestamp URL; this is a time server used to verify the time of the certificate signing. I'm using <code>http://timestamp.comodoca.com</code>, but whoever you got your certificate from likely has one as well.</p>
            </li>
          </ol>
        </section>
      </section>
      <section id="prepare-tauriconfjson-file" class="level2">
        <h2>Prepare <code>tauri.conf.json</code> file</h2>
        <ol>
          <li>
            <p>Now that we have our <code>certificateThumbprint</code>, <code>digestAlgorithm</code>, &#x26; <code>timestampUrl</code> we will open up the <code>tauri.conf.json</code>.</p>
          </li>
          <li>
            <p>In the <code>tauri.conf.json</code> you will look for the <code>tauri</code> -> <code>bundle</code> -> <code>windows</code> section. You see, there are three variables for the information we have captured. Fill it out like below.</p>
          </li>
        </ol>
        <pre class="language-json"><code class="language-json">windows<span class="token operator">:</span> <span class="token punctuation">{</span>
        certificateThumbprint<span class="token operator">:</span> A1B1A2B2A3B3A4B4A5B5A6B6A7B7A8B8A9B9A0B0<span class="token punctuation">,</span>
        digestAlgorithm<span class="token operator">:</span> sha256<span class="token punctuation">,</span>
        timestampUrl<span class="token operator">:</span> http<span class="token operator">:</span><span class="token comment">//timestamp.comodoca.com</span>
<span class="token punctuation">}</span></code></pre>
        <ol start="3">
          <li>
            <p>Save and run <code>yarn | yarn build</code></p>
          </li>
          <li>
            <p>In the console output, you should see the following output.</p>
          </li>
        </ol>
        <pre class="language-text"><code class="language-text">info: signing app
info: running signtool C:\\Program Files (x86)\\Windows Kits\\10\\bin\\10.0.19041.0\\x64\\signtool.exe
info: Done Adding Additional Store\r\nSuccessfully signed: APPLICATION FILE PATH HERE</code></pre>
        <p>Which shows you have successfully signed the <code>.exe</code>.</p>
        <p>And that's it! You have successfully signed your .exe file.</p>
      </section>
      <section id="bonus-sign-your-application-with-github-actions" class="level2">
        <h2>BONUS: Sign your application with GitHub Actions.</h2>
        <p>We can also create a workflow to sign the application with GitHub actions.</p>
        <section id="github-secrets" class="level3">
          <h3>GitHub Secrets</h3>
          <p>We need to add a few GitHub secrets for the proper configuration of the GitHub Action. These can be named however you would like.</p>
          <ul>
            <li>You can view the <a href="https://docs.github.com/en/actions/reference/encrypted-secrets">encrypted secrets</a> guide on how to add GitHub secrets.</li>
          </ul>
          <p>The secrets we used are as follows</p>
          <table>
            <thead>
              <tr>
                <th align="center">GitHub Secrets</th>
                <th align="center">Value for Variable</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td align="center">WINDOWS_CERTIFICATE</td>
                <td align="center">Base64 encoded version of your .pfx certificate, can be done using this command <code>certutil -encode certificate.pfx base64cert.txt</code></td>
              </tr>
              <tr>
                <td align="center">WINDOWS_CERTIFICATE_PASSWORD</td>
                <td align="center">Certificate export password used on creation of certificate .pfx</td>
              </tr>
            </tbody>
          </table>
        </section>
        <section id="workflow-modifications" class="level3">
          <h3>Workflow Modifications</h3>
          <ol>
            <li>
              <p>We need to add a step in the workflow to import the certificate into the Windows environment. This workflow accomplishes the following</p>
              <ol>
                <li>Assign GitHub secrets to environment variables</li>
                <li>Create a new <code>certificate</code> directory</li>
                <li>Import <code>WINDOWS_CERTIFICATE</code> into tempCert.txt</li>
                <li>Use <code>certutil</code> to decode the tempCert.txt from base64 into a <code>.pfx</code> file.</li>
                <li>Remove tempCert.txt</li>
                <li>Import the <code>.pfx</code> file into the Cert store of Windows &#x26; convert the <code>WINDOWS_CERTIFICATE_PASSWORD</code> to a secure string to be used in the import command.</li>
              </ol>
            </li>
            <li>
              <p>We will be using the <a href="https://github.com/tauri-apps/tauri-action"><code>tauri-action</code> publish template</a>.</p>
            </li>
          </ol>
          <pre class="language-yml"><code class="language-yml"><span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'publish'</span>
<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> release

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">publish-tauri</span><span class="token punctuation">:</span>
    <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">fail-fast</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">matrix</span><span class="token punctuation">:</span>
        <span class="token key atrule">platform</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>macos<span class="token punctuation">-</span>latest<span class="token punctuation">,</span> ubuntu<span class="token punctuation">-</span>latest<span class="token punctuation">,</span> windows<span class="token punctuation">-</span>latest<span class="token punctuation">]</span>

    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> matrix.platform <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> setup node
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token number">12</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install Rust stable
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions<span class="token punctuation">-</span>rs/toolchain@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">toolchain</span><span class="token punctuation">:</span> stable
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install webkit2gtk (ubuntu only)
        <span class="token key atrule">if</span><span class="token punctuation">:</span> matrix.platform == 'ubuntu<span class="token punctuation">-</span>latest'
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          sudo apt-get update
          sudo apt-get install -y webkit2gtk-4.0</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install app dependencies and build it
        <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn <span class="token important">&#x26;&#x26;</span> yarn build
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> tauri<span class="token punctuation">-</span>apps/tauri<span class="token punctuation">-</span>action@v0
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">tagName</span><span class="token punctuation">:</span> app<span class="token punctuation">-</span>v__VERSION__ <span class="token comment"># the action automatically replaces \_\_VERSION\_\_ with the app version</span>
          <span class="token key atrule">releaseName</span><span class="token punctuation">:</span> <span class="token string">'App v__VERSION__'</span>
          <span class="token key atrule">releaseBody</span><span class="token punctuation">:</span> <span class="token string">'See the assets to download this version and install.'</span>
          <span class="token key atrule">releaseDraft</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">prerelease</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>
          <ol start="3">
            <li>Right above <code>-name: install app dependencies and build it</code> you will want to add the following step</li>
          </ol>
          <pre class="language-yml"><code class="language-yml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> import windows certificate
  <span class="token key atrule">if</span><span class="token punctuation">:</span> matrix.platform == 'windows<span class="token punctuation">-</span>latest'
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token key atrule">WINDOWS_CERTIFICATE</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.WINDOWS_CERTIFICATE <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">WINDOWS_CERTIFICATE_PASSWORD</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.WINDOWS_CERTIFICATE_PASSWORD <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    New-Item -ItemType directory -Path certificate
    Set-Content -Path certificate/tempCert.txt -Value $env:WINDOWS_CERTIFICATE
    certutil -decode certificate/tempCert.txt certificate/certificate.pfx
    Remove-Item -path certificate -include tempCert.txt
    Import-PfxCertificate -FilePath certificate/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText)</span></code></pre>
          <ol start="4">
            <li>
              <p>Save and push to your repo.</p>
            </li>
            <li>
              <p>Your workflow can now import your windows certificate and import it into the GitHub runner, allowing for automated code-signing!</p>
            </li>
          </ol>
          <p><span style="float: footnote;"><a href="../../index.html#toc">Go to TOC</a></span></p>
        </section>
      </section>
    </section>
  </body>
</html>
