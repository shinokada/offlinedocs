<!doctype html><html lang="fr"><meta charset="utf-8"><title>La propriété serverMiddleware</title><meta name="viewport"content="width=device-width,initial-scale=1"><meta name="navigation.title"content="serverMiddleware"><meta name="description"content="Défini le middleware côté serveur."><meta name="menu"content="serverMiddleware"><meta name="category"content="configuration-glossary"><link rel="stylesheet"href="../../../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="la-propriété-servermiddleware"class="level1"><h1>La propriété serverMiddleware</h1><p>Défini le middleware côté serveur.<hr><ul><li>Type: <code>Array</code><ul><li>Items: <code>String</code> ou <code>Object</code> ou <code>Function</code></ul></ul><p>Nuxt crée en interne une instance <a href="https://github.com/senchalabs/connect">connect</a> à laquelle vous pouvez ajouter votre propre middleware personnalisé. Cela nous permet d'enregistrer des routes supplémentaires (généralement des routes <code>/api</code>) <strong>sans avoir besoin d'un serveur externe</strong>.<p>Parce que Connect itself est un middleware, les middleware enregistrés fonctionneront avec <code>nuxt start</code> et aussi lorsqu'il est utilisé comme un middleware avec des usages programmatiques comme <a href="https://github.com/nuxt-community/express-template">express-template</a>. Les <a href="./directory-structure/modules">Modules</a> nuxt peuvent également fournir <code>serverMiddleware</code> en utilisant <a href="./internals-glossary/internals-module-container#addservermiddleware-middleware">this.addServerMiddleware()</a><p>En plus, nous avons introduit une option <code>prefix</code> dont la valeur par défaut est <code>true</code>. Elle ajoutera la base du routeur aux middlewares de votre serveur.<p><strong>Exemple:</strong><ul><li>Chemin d'accès au middleware du serveur : <code>/server-middleware</code><li>Base du routeur : <code>/admin</code><li>Avec <code>prefix: true</code> (par défaut): <code>/admin/server-middleware</code><li>Avec <code>prefix: false</code>: <code>/server-middleware</code></ul><section id="servermiddleware-vs-middleware"class="level2"><h2>serverMiddleware vs middleware!</h2><p>Ne le confondez pas avec <a href="./directory-structure/middleware#router-middleware">routes middleware</a> qui sont appelés avant chaque route par Vue pour les rendu monopage ou SSR. Les Middleware listés dans la propriété <code>serverMiddleware</code> s'exécutent côté serveur <strong>avant</strong> <code>vue-server-renderer</code> et peuvent être utilisés pour des tâches spécifiques au serveur comme le traitement des requêtes API ou pour le chargement des ressources.<section id="warning"class="level4"><h4>Warning</h4><p>N'ajoutez pas serverMiddleware au répertoire middleware/.<p>Middleware, sont regroupés par webpack dans votre bundle de production et exécutés sur beforeRouteEnter. Si vous ajoutez serverMiddleware au répertoire middleware/, il sera pris à tort par Nuxt en tant que middleware et ajoutera de mauvaises dépendances à votre bundle ou générera des erreurs.</section></section><section id="utilisation"class="level2"><h2>Utilisation</h2><p>Si le middleware est une chaîne de caractères, alors Nuxt essaiera de le résoudre automatiquement et le rendra requis.<pre class="language-js{}[nuxt.config.js]"><code class="language-js{}[nuxt.config.js]">import serveStatic from 'serve-static'

export default {
  serverMiddleware: [
    // Inscrira redirect-ssl dans les package npm
    'redirect-ssl',

    // Inscrira le fichier index du répertoire server-middleware pour gérer /server-middleware/*
    { path: '/server-middleware', handler: '~/server-middleware/index.js' },

    // Nous pouvons également créer des instances personnalisées
    { path: '/static2', handler: serveStatic(__dirname + '/static2') }
  ]
}</code></pre><section id="warning-1"class="level4"><h4>Warning</h4><p>Si vous ne voulez pas que le middleware s'enregistre pour toutes les routes, vous devez l'utiliser sous la forme d'un Object avec un chemin d'accès spécifique, sinon le gestionnaire par défaut nuxt ne fonctionnera pas !</section></section><section id="middleware-de-serveur-personnalisé"class="level2"><h2>Middleware de serveur personnalisé</h2><p>Il est également possible d'écrire des Middleware personnalisés. Pour plus d'informations, voir <a href="https://github.com/senchalabs/connect#appusefn">Connect Docs</a>.<p>Middleware (<code>server-middleware/logger.js</code>):<pre class="language-js{}[server-middleware/logger.js]"><code class="language-js{}[server-middleware/logger.js]">export default function (req, res, next) {
  // req est l'objet de la requête http de Node.js
  console.log(req.url)

  // res est l'objet de réponse http de Node.js

  // next est une fonction à appeler pour invoquer le prochain middleware
  // N'oubliez pas d'appeler le suivant à la fin si votre middleware n'est pas un endpoint !
  next()
}</code></pre><pre class="language-js{}[nuxt.config.js]"><code class="language-js{}[nuxt.config.js]">serverMiddleware: [`~/server-middleware/logger`]</code></pre></section><section id="api-endpoint-personnalisé"class="level2"><h2>API endpoint personnalisé</h2><p>Un middleware de serveur peut également étendre Express. Cela permet la création d'endpoint REST.<pre class="language-js{}[server-middleware/rest.js]"><code class="language-js{}[server-middleware/rest.js]">const bodyParser = require('body-parser')
const app = require('express')()

app.use(bodyParser.json())
app.all('/getJSON', (req, res) => {
  res.json({ data: 'data' })
})

module.exports = app</code></pre><pre class="language-js{}[nuxt.config.js]"><code class="language-js{}[nuxt.config.js]">serverMiddleware: [
  { path: "/server-middleware", handler: "~/server-middleware/rest.js" },
],</code></pre></section><section id="syntaxe-de-lobjet"class="level2"><h2>Syntaxe de l'objet</h2><p>Si le middleware de votre serveur est constitué d'une liste de fonctions mises en correspondance avec des chemins d'accès :<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">serverMiddleware</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'~/server-middleware/a.js'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/b'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'~/server-middleware/b.js'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/c'</span><span class="token punctuation">,</span> <span class="token literal-property property">handler</span><span class="token operator">:</span> <span class="token string">'~/server-middleware/c.js'</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><p>Vous pouvez aussi passer un objet pour les définir, comme suit :<pre class="language-js"><code class="language-js"><span class="token keyword module">export</span> <span class="token keyword module">default</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">serverMiddleware</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'/a'</span><span class="token operator">:</span> <span class="token string">'~/server-middleware/a.js'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'/b'</span><span class="token operator">:</span> <span class="token string">'~/server-middleware/b.js'</span><span class="token punctuation">,</span>
    <span class="token string-property property">'/c'</span><span class="token operator">:</span> <span class="token string">'~/server-middleware/c.js'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>