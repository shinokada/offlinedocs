<!doctype html><html lang="en"><meta charset="utf-8"><title>Complexity</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="complexity"class="level3"><h3>Complexity</h3><blockquote><p>warning <strong>Warning</strong> This chapter applies only to the code first approach.</blockquote><p>Query complexity allows you to define how complex certain fields are, and to restrict queries with a <strong>maximum complexity</strong>. The idea is to define how complex each field is by using a simple number. A common default is to give each field a complexity of <code>1</code>. In addition, the complexity calculation of a GraphQL query can be customized with so-called complexity estimators. A complexity estimator is a simple function that calculates the complexity for a field. You can add any number of complexity estimators to the rule, which are then executed one after another. The first estimator that returns a numeric complexity value determines the complexity for that field.<p>The <code>@nestjs/graphql</code> package integrates very well with tools like <a href="https://github.com/slicknode/graphql-query-complexity">graphql-query-complexity</a> that provides a cost analysis-based solution. With this library, you can reject queries to your GraphQL server that are deemed too costly to execute.<section id="installation"class="level4"><h4>Installation</h4><p>To begin using it, we first install the required dependency.<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save graphql-query-complexity</code></pre></section><section id="getting-started"class="level4"><h4>Getting started</h4><p>Once the installation process is complete, we can define the <code>ComplexityPlugin</code> class:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLSchemaHost</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@nestjs/graphql"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Plugin</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">"@nestjs/apollo"</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloServerPlugin</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">GraphQLRequestListener</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'apollo-server-plugin-base'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token known-class-name class-name">GraphQLError</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  fieldExtensionsEstimator<span class="token punctuation">,</span>
  getComplexity<span class="token punctuation">,</span>
  simpleEstimator<span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'graphql-query-complexity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Plugin</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ComplexityPlugin</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">ApolloServerPlugin</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> gqlSchemaHost<span class="token operator">:</span> <span class="token maybe-class-name">GraphQLSchemaHost</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">requestDidStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">GraphQLRequestListener</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> maxComplexity <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> schema <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">gqlSchemaHost</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      <span class="token keyword">async</span> <span class="token function">didResolveOperation</span><span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> <span class="token dom variable">document</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> complexity <span class="token operator">=</span> <span class="token function">getComplexity</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          schema<span class="token punctuation">,</span>
          operationName<span class="token operator">:</span> request<span class="token punctuation">.</span><span class="token property-access">operationName</span><span class="token punctuation">,</span>
          query<span class="token operator">:</span> <span class="token dom variable">document</span><span class="token punctuation">,</span>
          variables<span class="token operator">:</span> request<span class="token punctuation">.</span><span class="token property-access">variables</span><span class="token punctuation">,</span>
          estimators<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token function">fieldExtensionsEstimator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">simpleEstimator</span><span class="token punctuation">(</span><span class="token punctuation">{</span> defaultComplexity<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>complexity <span class="token operator">></span> maxComplexity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">GraphQLError</span></span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Query is too complex: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>complexity<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Maximum allowed complexity: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxComplexity<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Query Complexity:'</span><span class="token punctuation">,</span> complexity<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>For demonstration purposes, we specified the maximum allowed complexity as <code>20</code>. In the example above, we used 2 estimators, the <code>simpleEstimator</code> and the <code>fieldExtensionsEstimator</code>.<ul><li><code>simpleEstimator</code>: the simple estimator returns a fixed complexity for each field<li><code>fieldExtensionsEstimator</code>: the field extensions estimator extracts the complexity value for each field of your schema</ul><blockquote><p>info <strong>Hint</strong> Remember to add this class to the providers array in any module.</blockquote></section><section id="field-level-complexity"class="level4"><h4>Field-level complexity</h4><p>With this plugin in place, we can now define the complexity for any field by specifying the <code>complexity</code> property in the options object passed into the <code>@Field()</code> decorator, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> complexity<span class="token operator">:</span> <span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></code></pre><p>Alternatively, you can define the estimator function:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">complexity</span><span class="token operator">:</span> <span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token maybe-class-name">ComplexityEstimatorArgs</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token spread operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></code></pre></section><section id="querymutation-level-complexity"class="level4"><h4>Query/Mutation-level complexity</h4><p>In addition, <code>@Query()</code> and <code>@Mutation()</code> decorators may have a <code>complexity</code> property specified like so:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token function-variable function">complexity</span><span class="token operator">:</span> <span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token maybe-class-name">ComplexityEstimatorArgs</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> options<span class="token punctuation">.</span><span class="token property-access">args</span><span class="token punctuation">.</span><span class="token property-access">count</span> <span class="token operator">*</span> options<span class="token punctuation">.</span><span class="token property-access">childComplexity</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">items</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span> count<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">itemsService</span><span class="token punctuation">.</span><span class="token method function property-access">getItems</span><span class="token punctuation">(</span><span class="token punctuation">{</span> count <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>