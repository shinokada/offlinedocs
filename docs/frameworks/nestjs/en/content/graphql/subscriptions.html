<!doctype html><html lang="en"><meta charset="utf-8"><title>Subscriptions</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="subscriptions"class="level3"><h3>Subscriptions</h3><p>In addition to fetching data using queries and modifying data using mutations, the GraphQL spec supports a third operation type, called <code>subscription</code>. GraphQL subscriptions are a way to push data from the server to the clients that choose to listen to real time messages from the server. Subscriptions are similar to queries in that they specify a set of fields to be delivered to the client, but instead of immediately returning a single answer, a channel is opened and a result is sent to the client every time a particular event happens on the server.<p>A common use case for subscriptions is notifying the client side about particular events, for example the creation of a new object, updated fields and so on (read more <a href="https://www.apollographql.com/docs/react/data/subscriptions">here</a>).<section id="enable-subscriptions-with-apollo-driver"class="level4"><h4>Enable subscriptions with Apollo driver</h4><p>To enable subscriptions, set the <code>installSubscriptionHandlers</code> property to <code>true</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
  installSubscriptionHandlers<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><blockquote><p>warning <strong>Warning</strong> The <code>installSubscriptionHandlers</code> configuration option has been removed from the latest version of Apollo server and will be soon deprecated in this package as well. By default, <code>installSubscriptionHandlers</code> will fallback to use the <code>subscriptions-transport-ws</code> (<a href="https://github.com/apollographql/subscriptions-transport-ws">read more</a>) but we strongly recommend using the <code>graphql-ws</code>(<a href="https://github.com/enisdenjo/graphql-ws">read more</a>) library instead.</blockquote><p>To switch to use the <code>graphql-ws</code> package instead, use the following configuration:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
  subscriptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'graphql-ws'</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><blockquote><p>info <strong>Hint</strong> You can also use both packages (<code>subscriptions-transport-ws</code> and <code>graphql-ws</code>) at the same time, for example, for backward compatibility.</blockquote></section><section id="code-first"class="level4"><h4>Code first</h4><p>To create a subscription using the code first approach, we use the <code>@Subscription()</code> decorator (exported from the <code>@nestjs/graphql</code> package) and the <code>PubSub</code> class from the <code>graphql-subscriptions</code> package, which provides a simple <strong>publish/subscribe API</strong>.<p>The following subscription handler takes care of <strong>subscribing</strong> to an event by calling <code>PubSub#asyncIterator</code>. This method takes a single argument, the <code>triggerName</code>, which corresponds to an event topic name.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> pubSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">PubSub</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Author</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthorResolver</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">)</span>
  <span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> All decorators are exported from the <code>@nestjs/graphql</code> package, while the <code>PubSub</code> class is exported from the <code>graphql-subscriptions</code> package.</blockquote><blockquote><p>warning <strong>Note</strong> <code>PubSub</code> is a class that exposes a simple <code>publish</code> and <code>subscribe API</code>. Read more about it <a href="https://www.apollographql.com/docs/graphql-subscriptions/setup.html">here</a>. Note that the Apollo docs warn that the default implementation is not suitable for production (read more <a href="https://github.com/apollographql/graphql-subscriptions#getting-started-with-your-first-subscription">here</a>). Production apps should use a <code>PubSub</code> implementation backed by an external store (read more <a href="https://github.com/apollographql/graphql-subscriptions#pubsub-implementations">here</a>).</blockquote><p>This will result in generating the following part of the GraphQL schema in SDL:<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token attr-name">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Comment</span><span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre><p>Note that subscriptions, by definition, return an object with a single top level property whose key is the name of the subscription. This name is either inherited from the name of the subscription handler method (i.e., <code>commentAdded</code> above), or is provided explicitly by passing an option with the key <code>name</code> as the second argument to the <code>@Subscription()</code> decorator, as shown below.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'commentAdded'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">subscribeToCommentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>This construct produces the same SDL as the previous code sample, but allows us to decouple the method name from the subscription.</section><section id="publishing"class="level4"><h4>Publishing</h4><p>Now, to publish the event, we use the <code>PubSub#publish</code> method. This is often used within a mutation to trigger a client-side update when a part of the object graph has changed. For example:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>posts<span class="token operator">/</span>posts<span class="token punctuation">.</span><span class="token property-access">resolver</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Mutation</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">addComment</span><span class="token punctuation">(</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'postId'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">type</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Int</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> postId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'comment'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">type</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> comment<span class="token operator">:</span> <span class="token maybe-class-name">CommentInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newComment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">commentsService</span><span class="token punctuation">.</span><span class="token method function property-access">addComment</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> postId<span class="token punctuation">,</span> comment <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pubSub<span class="token punctuation">.</span><span class="token method function property-access">publish</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> commentAdded<span class="token operator">:</span> newComment <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> newComment<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>PubSub#publish</code> method takes a <code>triggerName</code> (again, think of this as an event topic name) as the first parameter, and an event payload as the second parameter. As mentioned, the subscription, by definition, returns a value and that value has a shape. Look again at the generated SDL for our <code>commentAdded</code> subscription:<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token attr-name">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Comment</span><span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre><p>This tells us that the subscription must return an object with a top-level property name of <code>commentAdded</code> that has a value which is a <code>Comment</code> object. The important point to note is that the shape of the event payload emitted by the <code>PubSub#publish</code> method must correspond to the shape of the value expected to return from the subscription. So, in our example above, the <code>pubSub.publish('commentAdded', {{ '{' }} commentAdded: newComment {{ '}' }})</code> statement publishes a <code>commentAdded</code> event with the appropriately shaped payload. If these shapes don't match, your subscription will fail during the GraphQL validation phase.</section><section id="filtering-subscriptions"class="level4"><h4>Filtering subscriptions</h4><p>To filter out specific events, set the <code>filter</code> property to a filter function. This function acts similar to the function passed to an array <code>filter</code>. It takes two arguments: <code>payload</code> containing the event payload (as sent by the event publisher), and <code>variables</code> taking any arguments passed in during the subscription request. It returns a boolean determining whether this event should be published to client listeners.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span> title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="mutating-subscription-payloads"class="level4"><h4>Mutating subscription payloads</h4><p>To mutate the published event payload, set the <code>resolve</code> property to a function. The function receives the event payload (as sent by the event publisher) and returns the appropriate value.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">resolve</span><span class="token operator">:</span> value <span class="token arrow operator">=></span> value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Note</strong> If you use the <code>resolve</code> option, you should return the unwrapped payload (e.g., with our example, return a <code>newComment</code> object directly, not a <code>{{ '{' }} commentAdded: newComment {{ '}' }}</code> object).</blockquote><p>If you need to access injected providers (e.g., use an external service to validate the data), use the following construction.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorResolver</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "this" refers to an instance of "AuthorResolver"</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The same construction works with filters:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorResolver</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "this" refers to an instance of "AuthorResolver"</span>
    <span class="token keyword control-flow">return</span> payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="schema-first"class="level4"><h4>Schema first</h4><p>To create an equivalent subscription in Nest, we'll make use of the <code>@Subscription()</code> decorator.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> pubSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">PubSub</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token string">'Author'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthorResolver</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>To filter out specific events based on context and arguments, set the <code>filter</code> property.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>To mutate the published payload, we can use a <code>resolve</code> function.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">resolve</span><span class="token operator">:</span> value <span class="token arrow operator">=></span> value<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If you need to access injected providers (e.g., use an external service to validate the data), use the following construction:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorResolver</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "this" refers to an instance of "AuthorResolver"</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The same construction works with filters:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorResolver</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "this" refers to an instance of "AuthorResolver"</span>
    <span class="token keyword control-flow">return</span> payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">asyncIterator</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The last step is to update the type definitions file.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Author</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span>
  <span class="token attr-name">firstName</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">lastName</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">posts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Post</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span>
  <span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">votes</span><span class="token punctuation">:</span> <span class="token scalar">Int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">author</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Author</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Comment</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">content</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token attr-name">commentAdded</span><span class="token punctuation">(</span><span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Comment</span>
<span class="token punctuation">}</span></code></pre><p>With this, we've created a single <code>commentAdded(title: String!): Comment</code> subscription. You can find a full sample implementation <a href="https://github.com/nestjs/nest/blob/master/sample/12-graphql-schema-first">here</a>.</section><section id="pubsub"class="level4"><h4>PubSub</h4><p>We instantiated a local <code>PubSub</code> instance above. The preferred approach is to define <code>PubSub</code> as a <a href="/fundamentals/custom-providers">provider</a> and inject it through the constructor (using the <code>@Inject()</code> decorator). This allows us to re-use the instance across the whole application. For example, define a provider as follows, then inject <code>'PUB_SUB'</code> where needed.<pre class="language-typescript"><code class="language-typescript"><span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token string">'PUB_SUB'</span><span class="token punctuation">,</span>
  useValue<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">PubSub</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre></section><section id="customize-subscriptions-server"class="level4"><h4>Customize subscriptions server</h4><p>To customize the subscriptions server (e.g., change the path), use the <code>subscriptions</code> options property.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
  subscriptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'subscriptions-transport-ws'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/graphql'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><p>If you're using the <code>graphql-ws</code> package for subscriptions, replace the <code>subscriptions-transport-ws</code> key with <code>graphql-ws</code>, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
  subscriptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'graphql-ws'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      path<span class="token operator">:</span> <span class="token string">'/graphql'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre></section><section id="authentication-over-websockets"class="level4"><h4>Authentication over WebSockets</h4><p>Checking whether the user is authenticated can be done inside the <code>onConnect</code> callback function that you can specify in the <code>subscriptions</code> options.<p>The <code>onConnect</code> will receive as a first argument the <code>connectionParams</code> passed to the <code>SubscriptionClient</code> (read <a href="https://www.apollographql.com/docs/react/data/subscriptions/#5-authenticate-over-websocket-optional">more</a>).<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
  subscriptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'subscriptions-transport-ws'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onConnect</span><span class="token operator">:</span> <span class="token punctuation">(</span>connectionParams<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> authToken <span class="token operator">=</span> connectionParams<span class="token punctuation">.</span><span class="token property-access">authToken</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValid</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Error</span></span><span class="token punctuation">(</span><span class="token string">'Token is not valid'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// extract user information from token</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span>authToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return user info to add them to the context later</span>
        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">context</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> connection <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// connection.context will be equal to what was returned by the "onConnect" callback</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><p>The <code>authToken</code> in this example is only sent once by the client, when the connection is first established. All subscriptions made with this connection will have the same <code>authToken</code>, and thus the same user info.<blockquote><p>warning <strong>Note</strong> There is a bug in <code>subscriptions-transport-ws</code> that allows connections to skip the <code>onConnect</code> phase (read <a href="https://github.com/apollographql/subscriptions-transport-ws/issues/349">more</a>). You should not assume that <code>onConnect</code> was called when the user starts a subscription, and always check that the <code>context</code> is populated.</blockquote><p>If you're using the <code>graphql-ws</code> package, the signature of the <code>onConnect</code> callback will be slightly different:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
  subscriptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token string-property property">'graphql-ws'</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">onConnect</span><span class="token operator">:</span> <span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">Context</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> connectionParams<span class="token punctuation">,</span> extra <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token comment">// user validation will remain the same as in the example above</span>
        <span class="token comment">// when using with graphql-ws, additional context value should be stored in the extra field</span>
        extra<span class="token punctuation">.</span><span class="token property-access">user</span> <span class="token operator">=</span> <span class="token punctuation">{</span> user<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">context</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> extra <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token comment">// you can now access your additional context value through the extra field</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="enable-subscriptions-with-mercurius-driver"class="level4"><h4>Enable subscriptions with Mercurius driver</h4><p>To enable subscriptions, set the <code>subscription</code> property to <code>true</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusDriver</span><span class="token punctuation">,</span>
  subscription<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><blockquote><p>info <strong>Hint</strong> You can also pass the options object to set up a custom emitter, validate incoming connections, etc. Read more <a href="https://github.com/mercurius-js/mercurius/blob/master/docs/api/options.md#plugin-options">here</a> (see <code>subscription</code>).</blockquote></section><section id="code-first-1"class="level4"><h4>Code first</h4><p>To create a subscription using the code first approach, we use the <code>@Subscription()</code> decorator (exported from the <code>@nestjs/graphql</code> package) and the <code>PubSub</code> class from the <code>mercurius</code> package, which provides a simple <strong>publish/subscribe API</strong>.<p>The following subscription handler takes care of <strong>subscribing</strong> to an event by calling <code>PubSub#asyncIterator</code>. This method takes a single argument, the <code>triggerName</code>, which corresponds to an event topic name.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Author</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthorResolver</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">)</span>
  <span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> All decorators used in the example above are exported from the <code>@nestjs/graphql</code> package, while the <code>PubSub</code> class is exported from the <code>mercurius</code> package.</blockquote><blockquote><p>warning <strong>Note</strong> <code>PubSub</code> is a class that exposes a simple <code>publish</code> and <code>subscribe</code> API. Check out <a href="https://github.com/mercurius-js/mercurius/blob/master/docs/subscriptions.md#subscriptions-with-custom-pubsub">this section</a> on how to register a custom <code>PubSub</code> class.</blockquote><p>This will result in generating the following part of the GraphQL schema in SDL:<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token attr-name">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Comment</span><span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre><p>Note that subscriptions, by definition, return an object with a single top level property whose key is the name of the subscription. This name is either inherited from the name of the subscription handler method (i.e., <code>commentAdded</code> above), or is provided explicitly by passing an option with the key <code>name</code> as the second argument to the <code>@Subscription()</code> decorator, as shown below.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'commentAdded'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">subscribeToCommentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>This construct produces the same SDL as the previous code sample, but allows us to decouple the method name from the subscription.</section><section id="publishing-1"class="level4"><h4>Publishing</h4><p>Now, to publish the event, we use the <code>PubSub#publish</code> method. This is often used within a mutation to trigger a client-side update when a part of the object graph has changed. For example:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>posts<span class="token operator">/</span>posts<span class="token punctuation">.</span><span class="token property-access">resolver</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Mutation</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">addComment</span><span class="token punctuation">(</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'postId'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">type</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Int</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> postId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'comment'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">type</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> comment<span class="token operator">:</span> <span class="token maybe-class-name">CommentInput</span><span class="token punctuation">,</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newComment <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">commentsService</span><span class="token punctuation">.</span><span class="token method function property-access">addComment</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> postId<span class="token punctuation">,</span> comment <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">publish</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    topic<span class="token operator">:</span> <span class="token string">'commentAdded'</span><span class="token punctuation">,</span>
    payload<span class="token operator">:</span> <span class="token punctuation">{</span>
      commentAdded<span class="token operator">:</span> newComment
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> newComment<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>As mentioned, the subscription, by definition, returns a value and that value has a shape. Look again at the generated SDL for our <code>commentAdded</code> subscription:<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token attr-name">commentAdded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Comment</span><span class="token operator">!</span>
<span class="token punctuation">}</span></code></pre><p>This tells us that the subscription must return an object with a top-level property name of <code>commentAdded</code> that has a value which is a <code>Comment</code> object. The important point to note is that the shape of the event payload emitted by the <code>PubSub#publish</code> method must correspond to the shape of the value expected to return from the subscription. So, in our example above, the <code>pubSub.publish({{ '{' }} topic: 'commentAdded', payload: {{ '{' }} commentAdded: newComment {{ '}' }} {{ '}' }})</code> statement publishes a <code>commentAdded</code> event with the appropriately shaped payload. If these shapes don't match, your subscription will fail during the GraphQL validation phase.</section><section id="filtering-subscriptions-1"class="level4"><h4>Filtering subscriptions</h4><p>To filter out specific events, set the <code>filter</code> property to a filter function. This function acts similar to the function passed to an array <code>filter</code>. It takes two arguments: <code>payload</code> containing the event payload (as sent by the event publisher), and <code>variables</code> taking any arguments passed in during the subscription request. It returns a boolean determining whether this event should be published to client listeners.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span> title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If you need to access injected providers (e.g., use an external service to validate the data), use the following construction.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span>returns <span class="token arrow operator">=></span> <span class="token maybe-class-name">Comment</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorResolver</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "this" refers to an instance of "AuthorResolver"</span>
    <span class="token keyword control-flow">return</span> payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span> title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="schema-first-1"class="level4"><h4>Schema first</h4><p>To create an equivalent subscription in Nest, we'll make use of the <code>@Subscription()</code> decorator.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> pubSub <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">PubSub</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token string">'Author'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthorResolver</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>To filter out specific events based on context and arguments, set the <code>filter</code> property.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">filter</span><span class="token operator">:</span> <span class="token punctuation">(</span>payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token arrow operator">=></span>
    payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If you need to access injected providers (e.g., use an external service to validate the data), use the following construction:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Subscription</span></span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function">filter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorResolver</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span> variables<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "this" refers to an instance of "AuthorResolver"</span>
    <span class="token keyword control-flow">return</span> payload<span class="token punctuation">.</span><span class="token property-access">commentAdded</span><span class="token punctuation">.</span><span class="token property-access">title</span> <span class="token operator">===</span> variables<span class="token punctuation">.</span><span class="token property-access">title</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">commentAdded</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Context</span></span><span class="token punctuation">(</span><span class="token string">'pubsub'</span><span class="token punctuation">)</span> pubSub<span class="token operator">:</span> <span class="token maybe-class-name">PubSub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> pubSub<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token string">'commentAdded'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The last step is to update the type definitions file.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Author</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span>
  <span class="token attr-name">firstName</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">lastName</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">posts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Post</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span>
  <span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">votes</span><span class="token punctuation">:</span> <span class="token scalar">Int</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">author</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">Int</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Author</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Comment</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
  <span class="token attr-name">content</span><span class="token punctuation">:</span> <span class="token scalar">String</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token attr-name">commentAdded</span><span class="token punctuation">(</span><span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">Comment</span>
<span class="token punctuation">}</span></code></pre><p>With this, we've created a single <code>commentAdded(title: String!): Comment</code> subscription.</section><section id="pubsub-1"class="level4"><h4>PubSub</h4><p>In the examples above, we used the default <code>PubSub</code> emitter (<a href="https://github.com/mcollina/mqemitter">mqemitter</a>) The preferred approach (for production) is to use <code>mqemitter-redis</code>. Alternatively, a custom <code>PubSub</code> implementation can be provided (read more <a href="https://github.com/mercurius-js/mercurius/blob/master/docs/subscriptions.md">here</a>)<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusDriver</span><span class="token punctuation">,</span>
  subscription<span class="token operator">:</span> <span class="token punctuation">{</span>
    emitter<span class="token operator">:</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'mqemitter-redis'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      port<span class="token operator">:</span> <span class="token number">6579</span><span class="token punctuation">,</span>
      host<span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="authentication-over-websockets-1"class="level4"><h4>Authentication over WebSockets</h4><p>Checking whether the user is authenticated can be done inside the <code>verifyClient</code> callback function that you can specify in the <code>subscription</code> options.<p>The <code>verifyClient</code> will receive the <code>info</code> object as a first argument which you can use to retrive the request's headers.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusDriver</span><span class="token punctuation">,</span>
  subscription<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">verifyClient</span><span class="token operator">:</span> <span class="token punctuation">(</span>info<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> authorization <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token property-access">req</span><span class="token punctuation">.</span><span class="token property-access">headers</span><span class="token operator">?.</span>authorization <span class="token keyword module">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>authorization<span class="token operator">?.</span><span class="token method function property-access">startsWith</span><span class="token punctuation">(</span><span class="token string">'Bearer '</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>