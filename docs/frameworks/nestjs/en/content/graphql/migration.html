<!doctype html><html lang="en"><meta charset="utf-8"><title>Migrating to v10</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="migrating-to-v10"class="level3"><h3>Migrating to v10</h3><p>This article provides a set of guidelines for migrating from <code>@nestjs/graphql</code> version 9 to version 10. The focus of this major-version release is to provide a lighter, platform-agnostic core library.<section id="introducing-driver-packages"class="level4"><h4>Introducing "driver" packages</h4><p>In the latest version, we made a decision to break the <code>@nestjs/graphql</code> package up into a few separate libraries, letting you choose whether to use Apollo (<code>@nestjs/apollo</code>), Mercurius (<code>@nestjs/mercurius</code>), or another GraphQL library in your project.<p>This implies that now you have to explicitly specify what driver your application will use.<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Before</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token string">'schema.gql'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// After</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ApolloDriverConfig</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token string">'schema.gql'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="plugins"class="level4"><h4>Plugins</h4><p>Apollo Server plugins let you perform custom operations in response to certain events. Since this is an exclusive Apollo feature, we moved it from the <code>@nestjs/graphql</code> to the newly created <code>@nestjs/apollo</code> package so you'll have to update imports in your application.<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Before</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Plugin</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token comment">// After</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Plugin</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span></code></pre></section><section id="directives"class="level4"><h4>Directives</h4><p><code>schemaDirectives</code> feature has been replaced with the new <a href="https://www.graphql-tools.com/docs/schema-directives">Schema directives API</a> in v8 of <code>@graphql-tools/schema</code> package.<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Before</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SchemaDirectiveVisitor</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@graphql-tools/utils'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defaultFieldResolver<span class="token punctuation">,</span> <span class="token maybe-class-name">GraphQLField</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'graphql'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UpperCaseDirective</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">SchemaDirectiveVisitor</span></span> <span class="token punctuation">{</span>
  <span class="token function">visitFieldDefinition</span><span class="token punctuation">(</span>field<span class="token operator">:</span> <span class="token maybe-class-name">GraphQLField</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token operator">=</span> defaultFieldResolver <span class="token punctuation">}</span> <span class="token operator">=</span> field<span class="token punctuation">;</span>
    field<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">resolve</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token spread operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> resolve<span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> result<span class="token punctuation">.</span><span class="token method function property-access">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// After</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getDirective<span class="token punctuation">,</span> <span class="token maybe-class-name">MapperKind</span><span class="token punctuation">,</span> mapSchema <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@graphql-tools/utils'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> defaultFieldResolver<span class="token punctuation">,</span> <span class="token maybe-class-name">GraphQLSchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'graphql'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">upperDirectiveTransformer</span><span class="token punctuation">(</span>
  schema<span class="token operator">:</span> <span class="token maybe-class-name">GraphQLSchema</span><span class="token punctuation">,</span>
  directiveName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token function">mapSchema</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token maybe-class-name">MapperKind</span><span class="token punctuation">.</span><span class="token constant">OBJECT_FIELD</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token punctuation">(</span>fieldConfig<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> upperDirective <span class="token operator">=</span> <span class="token function">getDirective</span><span class="token punctuation">(</span>
        schema<span class="token punctuation">,</span>
        fieldConfig<span class="token punctuation">,</span>
        directiveName<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>upperDirective<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token operator">=</span> defaultFieldResolver <span class="token punctuation">}</span> <span class="token operator">=</span> fieldConfig<span class="token punctuation">;</span>

        <span class="token comment">// Replace the original resolver with a function that *first* calls</span>
        <span class="token comment">// the original resolver, then converts its result to upper case</span>
        fieldConfig<span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">resolve</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>source<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">resolve</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> result <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword control-flow">return</span> result<span class="token punctuation">.</span><span class="token method function property-access">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword control-flow">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">return</span> fieldConfig<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>To apply this directive implementation to a schema that contains <code>@upper</code> directives, use the <code>transformSchema</code> function:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token spread operator">...</span>
  <span class="token method-variable function-variable method function property-access">transformSchema</span><span class="token operator">:</span> schema <span class="token arrow operator">=></span> <span class="token function">upperDirectiveTransformer</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> <span class="token string">'upper'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre></section><section id="federation"class="level4"><h4>Federation</h4><p><code>GraphQLFederationModule</code> has been removed and replaced with the corresponding driver class:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Before</span>
<span class="token maybe-class-name">GraphQLFederationModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// After</span>
<span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Both <code>ApolloFederationDriver</code> class and <code>ApolloFederationDriverConfig</code> are exported from the <code>@nestjs/apollo</code> package.</blockquote><p>Likewise, instead of using a dedicated <code>GraphQLGatewayModule</code>, simply pass the appropriate <code>driver</code> class to your <code>GraphQLModule</code> settings:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// Before</span>
<span class="token maybe-class-name">GraphQLGatewayModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  gateway<span class="token operator">:</span> <span class="token punctuation">{</span>
    supergraphSdl<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntrospectAndCompose</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      subgraphs<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:3000/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'posts'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:3001/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// After</span>
<span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloGatewayDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloGatewayDriver</span><span class="token punctuation">,</span>
  gateway<span class="token operator">:</span> <span class="token punctuation">{</span>
    supergraphSdl<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntrospectAndCompose</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      subgraphs<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:3000/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'posts'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://localhost:3001/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Both <code>ApolloGatewayDriver</code> class and <code>ApolloGatewayDriverConfig</code> are exported from the <code>@nestjs/apollo</code> package. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>