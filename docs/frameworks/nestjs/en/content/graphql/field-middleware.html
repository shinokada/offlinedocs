<!doctype html><html lang="en"><meta charset="utf-8"><title>Field middleware</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="field-middleware"class="level3"><h3>Field middleware</h3><blockquote><p>warning <strong>Warning</strong> This chapter applies only to the code first approach.</blockquote><p>Field Middleware lets you run arbitrary code <strong>before or after</strong> a field is resolved. A field middleware can be used to convert the result of a field, validate the arguments of a field, or even check field-level roles (for example, required to access a target field for which a middleware function is executed).<p>You can connect multiple middleware functions to a field. In this case, they will be called sequentially along the chain where the previous middleware decides to call the next one. The order of the middleware functions in the <code>middleware</code> array is important. The first resolver is the "most-outer" layer, so it gets executed first and last (similarly to the <code>graphql-middleware</code> package). The second resolver is the "second-outer" layer, so it gets executed second and second to last.<section id="getting-started"class="level4"><h4>Getting started</h4><p>Let's start off by creating a simple middleware that will log a field value before it's sent back to the client:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">FieldMiddleware</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MiddlewareContext</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NextFn</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> loggerMiddleware<span class="token operator">:</span> <span class="token function-variable function"><span class="token maybe-class-name">FieldMiddleware</span></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  ctx<span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareContext</span><span class="token punctuation">,</span>
  next<span class="token operator">:</span> <span class="token maybe-class-name">NextFn</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>MiddlewareContext</code> is an object that consist of the same arguments that are normally received by the GraphQL resolver function (<code>{{ '{' }} source, args, context, info {{ '}' }}</code>), while <code>NextFn</code> is a function that let you execute the next middleware in the stack (bound to this field) or the actual field resolver.</blockquote><blockquote><p>warning <strong>Warning</strong> Field middleware functions cannot inject dependencies nor access Nest's DI container as they are designed to be very lightweight and shouldn't perform any potentially time-consuming operations (like retrieving data from the database). If you need to call external services/query data from the data source, you should do it in a guard/interceptor bounded to a root query/mutation handler and assign it to <code>context</code> object which you can access from within the field middleware (specifically, from the <code>MiddlewareContext</code> object).</blockquote><p>Note that field middleware must match the <code>FieldMiddleware</code> interface. In the example above, we first run the <code>next()</code> function (which executes the actual field resolver and returns a field value) and then, we log this value to our terminal. Also, the value returned from the middleware function completely overrides the previous value and since we don't want to perform any changes, we simply return the original value.<p>With this in place, we can register our middleware directly in the <code>@Field()</code> decorator, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Recipe</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> middleware<span class="token operator">:</span> <span class="token punctuation">[</span>loggerMiddleware<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Now whenever we request the <code>title</code> field of <code>Recipe</code> object type, the original field's value will be logged to the console.<blockquote><p>info <strong>Hint</strong> To learn how you can implement a field-level permissions system with the use of <a href="/graphql/extensions">extensions</a> feature, check out this <a href="/graphql/extensions#using-custom-metadata">section</a>.</blockquote><p>Also, as mentioned above, we can control the field's value from within the middleware function. For demonstration purposes, let's capitalise a recipe's title (if present):<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">return</span> value<span class="token operator">?.</span><span class="token method function property-access">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In this case, every title will be automatically uppercased, when requested.<p>Likewise, you can bind a field middleware to a custom field resolver (a method annotated with the <code>@ResolveField()</code> decorator), as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> middleware<span class="token operator">:</span> <span class="token punctuation">[</span>loggerMiddleware<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">title</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token string">'Placeholder'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Warning</strong> In case enhancers are enabled at the field resolver level (<a href="/graphql/other-features#execute-enhancers-at-the-field-resolver-level">read more</a>), field middleware functions will run before any interceptors, guards, etc., <strong>bounded to the method</strong> (but after the root-level enhancers registered for query or mutation handlers).</blockquote></section><section id="global-field-middleware"class="level4"><h4>Global field middleware</h4><p>In addition to binding a middleware directly to a specific field, you can also register one or multiple middleware functions globally. In this case, they will be automatically connected to all fields of your object types.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  autoSchemaFile<span class="token operator">:</span> <span class="token string">'schema.gql'</span><span class="token punctuation">,</span>
  buildSchemaOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    fieldMiddleware<span class="token operator">:</span> <span class="token punctuation">[</span>loggerMiddleware<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></code></pre><blockquote><p>info <strong>Hint</strong> Globally registered field middleware functions will be executed <strong>before</strong> locally registered ones (those bound directly to specific fields). <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>