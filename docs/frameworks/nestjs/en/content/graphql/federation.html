<!doctype html><html lang="en"><meta charset="utf-8"><title>Federation</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="federation"class="level3"><h3>Federation</h3><p>Federation offers a means of splitting your monolithic GraphQL server into independent microservices. It consists of two components: a gateway and one or more federated microservices. Each microservice holds part of the schema and the gateway merges the schemas into a single schema that can be consumed by the client.<p>To quote the <a href="https://blog.apollographql.com/apollo-federation-f260cf525d21">Apollo docs</a>, Federation is designed with these core principles:<ul><li>Building a graph should be <strong>declarative.</strong> With federation, you compose a graph declaratively from within your schema instead of writing imperative schema stitching code.<li>Code should be separated by <strong>concern</strong>, not by types. Often no single team controls every aspect of an important type like a User or Product, so the definition of these types should be distributed across teams and codebases, rather than centralized.<li>The graph should be simple for clients to consume. Together, federated services can form a complete, product-focused graph that accurately reflects how it’s being consumed on the client.<li>It’s just <strong>GraphQL</strong>, using only spec-compliant features of the language. Any language, not just JavaScript, can implement federation.</ul><blockquote><p>warning <strong>Warning</strong> Federation currently does not support subscriptions.</blockquote><p>In the following sections, we'll set up a demo application that consists of a gateway and two federated endpoints: Users service and Posts service.<section id="federation-with-apollo"class="level4"><h4>Federation with Apollo</h4><p>Start by installing the required dependencies:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @apollo/federation @apollo/subgraph</code></pre></section><section id="schema-first"class="level4"><h4>Schema first</h4><p>The "User service" provides a simple schema. Note the <code>@key</code> directive: it instructs the Apollo query planner that a particular instance of <code>User</code> can be fetched if you specify its <code>id</code>. Also, note that we <code>extend</code> the <code>Query</code> type.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">extend</span> <span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">getUser</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">User</span>
<span class="token punctuation">}</span></code></pre><p>Resolver provides one additional method named <code>resolveReference()</code>. This method is triggered by the Apollo Gateway whenever a related resource requires a User instance. We'll see an example of this in the Posts service later. Please note that the method must be annotated with the <code>@ResolveReference()</code> decorator.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Args</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveReference</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveReference</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">resolveReference</span><span class="token punctuation">(</span>reference<span class="token operator">:</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> id<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Finally, we hook everything up by registering the <code>GraphQLModule</code> passing the <code>ApolloFederationDriver</code> driver in the configuration object:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolver'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
      typePaths<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/*.graphql'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="code-first"class="level4"><h4>Code first</h4><p>Start by adding some extra decorators to the <code>User</code> entity.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Resolver provides one additional method named <code>resolveReference()</code>. This method is triggered by the Apollo Gateway whenever a related resource requires a User instance. We'll see an example of this in the Posts service later. Please note that the method must be annotated with the <code>@ResolveReference()</code> decorator.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Args</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveReference</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveReference</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">resolveReference</span><span class="token punctuation">(</span>reference<span class="token operator">:</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> id<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Finally, we hook everything up by registering the <code>GraphQLModule</code> passing the <code>ApolloFederationDriver</code> driver in the configuration object:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolver'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in this example</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/31-graphql-federation-code-first/users-application">here</a> in code first mode and <a href="https://github.com/nestjs/nest/tree/master/sample/32-graphql-federation-schema-first/users-application">here</a> in schema first mode.</section><section id="federated-example-posts"class="level4"><h4>Federated example: Posts</h4><p>Post service is supposed to serve aggregated posts through the <code>getPosts</code> query, but also extend our <code>User</code> type with the <code>user.posts</code> field.</section><section id="schema-first-1"class="level4"><h4>Schema first</h4><p>"Posts service" references the <code>User</code> type in its schema by marking it with the <code>extend</code> keyword. It also declares one additional property on the <code>User</code> type (<code>posts</code>). Note the <code>@key</code> directive used for matching instances of User, and the <code>@external</code> directive indicating that the <code>id</code> field is managed elsewhere.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Post</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
  <span class="token attr-name">body</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
  <span class="token attr-name">user</span><span class="token punctuation">:</span> <span class="token class-name">User</span>
<span class="token punctuation">}</span>

<span class="token keyword">extend</span> <span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span> <span class="token directive function">@external</span>
  <span class="token attr-name">posts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">extend</span> <span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">getPosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><p>In the following example, the <code>PostsResolver</code> provides the <code>getUser()</code> method that returns a reference containing <code>__typename</code> and some additional properties your application may need to resolve the reference, in this case <code>id</code>. <code>__typename</code> is used by the GraphQL Gateway to pinpoint the microservice responsible for the User type and retrieve the corresponding instance. The "Users service" described above will be requested upon execution of the <code>resolveReference()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Parent</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveField</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.interfaces'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token string">'Post'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PostsResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> postsService<span class="token operator">:</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'getPosts'</span><span class="token punctuation">)</span>
  <span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> post<span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> id<span class="token operator">:</span> post<span class="token punctuation">.</span><span class="token property-access">userId</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Lastly, we must register the <code>GraphQLModule</code>, similarly to what we did in the "Users service" section.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.resolver'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
      typePaths<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/*.graphql'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PostsResolvers</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="code-first-1"class="level4"><h4>Code first</h4><p>First, we will have to declare a class representing the <code>User</code> entity. Although the entity itself lives in another service, we will be using it (extending its definition) here. Note the <code>@extends</code> and <code>@external</code> directives.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@extends'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@external'</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  posts<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Now let's create the corresponding resolver for our extension on the <code>User</code> entity, as follows:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Parent</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveField</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> postsService<span class="token operator">:</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">forAuthor</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>We also have to define the <code>Post</code> entity class:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Int</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Post</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Int</span><span class="token punctuation">)</span>
  authorId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
  user<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>And its resolver:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Args</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveField</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Parent</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PostsResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> postsService<span class="token operator">:</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span>
  <span class="token function">findPost</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
  <span class="token function">user</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> post<span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> id<span class="token operator">:</span> post<span class="token punctuation">.</span><span class="token property-access">authorId</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>And finally, tie it together in a module. Note the schema build options, where we specify that <code>User</code> is an orphaned (external) type.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsResolvers</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.resolvers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolvers</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolvers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in example</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      buildSchemaOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
        orphanedTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PostsResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/31-graphql-federation-code-first/posts-application">here</a> for the code first mode and <a href="https://github.com/nestjs/nest/tree/master/sample/32-graphql-federation-schema-first/posts-application">here</a> for the schema first mode.</section><section id="federated-example-gateway"class="level4"><h4>Federated example: Gateway</h4><p>Start by installing the required dependency:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @apollo/gateway</code></pre><p>The gateway requires a list of endpoints to be specified and it will auto-discover the corresponding schemas. Therefore the implementation of the gateway service will remain the same for both code and schema first approaches.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">IntrospectAndCompose</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@apollo/gateway'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ApolloGatewayDriver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ApolloGatewayDriverConfig</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloGatewayDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloGatewayDriver</span><span class="token punctuation">,</span>
      server<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... Apollo server options</span>
        cors<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      gateway<span class="token operator">:</span> <span class="token punctuation">{</span>
        supergraphSdl<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">IntrospectAndCompose</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          subgraphs<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://user-service/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'posts'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://post-service/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/31-graphql-federation-code-first/gateway">here</a> for the code first mode and <a href="https://github.com/nestjs/nest/tree/master/sample/32-graphql-federation-schema-first/gateway">here</a> for the schema first mode.</section><section id="federation-with-mercurius"class="level4"><h4>Federation with Mercurius</h4><p>Start by installing the required dependencies:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @apollo/subgraph @nestjs/mercurius</code></pre><blockquote><p>info <strong>Note</strong> The <code>@apollo/subgraph</code> package is required to build a subgraph schema (<code>buildSubgraphSchema</code>, <code>printSubgraphSchema</code> functions).</blockquote></section><section id="schema-first-2"class="level4"><h4>Schema first</h4><p>The "User service" provides a simple schema. Note the <code>@key</code> directive: it instructs the Mercurius query planner that a particular instance of <code>User</code> can be fetched if you specify its <code>id</code>. Also, note that we <code>extend</code> the <code>Query</code> type.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">extend</span> <span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">getUser</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">User</span>
<span class="token punctuation">}</span></code></pre><p>Resolver provides one additional method named <code>resolveReference()</code>. This method is triggered by the Mercurius Gateway whenever a related resource requires a User instance. We'll see an example of this in the Posts service later. Please note that the method must be annotated with the <code>@ResolveReference()</code> decorator.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Args</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveReference</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveReference</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">resolveReference</span><span class="token punctuation">(</span>reference<span class="token operator">:</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> id<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Finally, we hook everything up by registering the <code>GraphQLModule</code> passing the <code>MercuriusFederationDriver</code> driver in the configuration object:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mercurius'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolver'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
      typePaths<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/*.graphql'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      federationMetadata<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="code-first-2"class="level4"><h4>Code first</h4><p>Start by adding some extra decorators to the <code>User</code> entity.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Resolver provides one additional method named <code>resolveReference()</code>. This method is triggered by the Mercurius Gateway whenever a related resource requires a User instance. We'll see an example of this in the Posts service later. Please note that the method must be annotated with the <code>@ResolveReference()</code> decorator.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Args</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveReference</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveReference</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">resolveReference</span><span class="token punctuation">(</span>reference<span class="token operator">:</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> id<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">usersService</span><span class="token punctuation">.</span><span class="token method function property-access">findById</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Finally, we hook everything up by registering the <code>GraphQLModule</code> passing the <code>MercuriusFederationDriver</code> driver in the configuration object:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mercurius'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolver'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in this example</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      federationMetadata<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="federated-example-posts-1"class="level4"><h4>Federated example: Posts</h4><p>Post service is supposed to serve aggregated posts through the <code>getPosts</code> query, but also extend our <code>User</code> type with the <code>user.posts</code> field.</section><section id="schema-first-3"class="level4"><h4>Schema first</h4><p>"Posts service" references the <code>User</code> type in its schema by marking it with the <code>extend</code> keyword. It also declares one additional property on the <code>User</code> type (<code>posts</code>). Note the <code>@key</code> directive used for matching instances of User, and the <code>@external</code> directive indicating that the <code>id</code> field is managed elsewhere.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Post</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
  <span class="token attr-name">body</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
  <span class="token attr-name">user</span><span class="token punctuation">:</span> <span class="token class-name">User</span>
<span class="token punctuation">}</span>

<span class="token keyword">extend</span> <span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span> <span class="token directive function">@external</span>
  <span class="token attr-name">posts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">extend</span> <span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">getPosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre><p>In the following example, the <code>PostsResolver</code> provides the <code>getUser()</code> method that returns a reference containing <code>__typename</code> and some additional properties your application may need to resolve the reference, in this case <code>id</code>. <code>__typename</code> is used by the GraphQL Gateway to pinpoint the microservice responsible for the User type and retrieve the corresponding instance. The "Users service" described above will be requested upon execution of the <code>resolveReference()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Parent</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveField</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.interfaces'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token string">'Post'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PostsResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> postsService<span class="token operator">:</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'getPosts'</span><span class="token punctuation">)</span>
  <span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> post<span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> id<span class="token operator">:</span> post<span class="token punctuation">.</span><span class="token property-access">userId</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Lastly, we must register the <code>GraphQLModule</code>, similarly to what we did in the "Users service" section.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mercurius'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.resolver'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
      federationMetadata<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      typePaths<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'**/*.graphql'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PostsResolvers</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="code-first-3"class="level4"><h4>Code first</h4><p>First, we will have to declare a class representing the <code>User</code> entity. Although the entity itself lives in another service, we will be using it (extending its definition) here. Note the <code>@extends</code> and <code>@external</code> directives.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@extends'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@external'</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  posts<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Now let's create the corresponding resolver for our extension on the <code>User</code> entity, as follows:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Parent</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveField</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> postsService<span class="token operator">:</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">public</span> <span class="token function">posts</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> user<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">forAuthor</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>We also have to define the <code>Post</code> entity class:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Int</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Post</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  title<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Int</span><span class="token punctuation">)</span>
  authorId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
  user<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>And its resolver:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Query</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Args</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ResolveField</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Resolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Parent</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Resolver</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PostsResolver</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> postsService<span class="token operator">:</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span>
  <span class="token function">findPost</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Args</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>returns<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">postsService</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ResolveField</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">of</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span>
  <span class="token function">user</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Parent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> post<span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> __typename<span class="token operator">:</span> <span class="token string">'User'</span><span class="token punctuation">,</span> id<span class="token operator">:</span> post<span class="token punctuation">.</span><span class="token property-access">authorId</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>And finally, tie it together in a module. Note the schema build options, where we specify that <code>User</code> is an orphaned (external) type.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mercurius'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsResolvers</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.resolvers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolvers</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolvers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in example</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusFederationDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      federationMetadata<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      buildSchemaOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
        orphanedTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PostsResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="federated-example-gateway-1"class="level4"><h4>Federated example: Gateway</h4><p>The gateway requires a list of endpoints to be specified and it will auto-discover the corresponding schemas. Therefore the implementation of the gateway servce will remain the same for both code and schema first approaches.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">MercuriusGatewayDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">MercuriusGatewayDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mercurius'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">GraphQLModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MercuriusGatewayDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">MercuriusGatewayDriver</span><span class="token punctuation">,</span>
      gateway<span class="token operator">:</span> <span class="token punctuation">{</span>
        services<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://user-service/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'posts'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> <span class="token string">'http://post-service/graphql'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section></section><section id="federation-2"class="level3"><h3>Federation 2</h3><p>To quote the <a href="https://www.apollographql.com/docs/federation/federation-2/new-in-federation-2">Apollo docs</a>, Federation 2 improves developer experience from the original Apollo Federation (called Federation 1 in this doc), which is backward compatible with most original supergraphs.<blockquote><p>warning <strong>Warning</strong> Mercurius doesn't fully support Federation 2. You can see the list of libraries that support Federation 2 <a href="https://www.apollographql.com/docs/federation/supported-subgraphs#javascript--typescript">here</a>.</blockquote><p>In the following sections, we'll upgrade the previous example to Federation 2.<section id="federated-example-users"class="level4"><h4>Federated example: Users</h4><p>One change in Federation 2 is that entities have no originating subgraph, so we don't need to extend <code>Query</code> anymore. For more detail please refer to <a href="https://www.apollographql.com/docs/federation/federation-2/new-in-federation-2#entities">the entities topic</a> in Apollo Federation 2 docs.</section><section id="schema-first-4"class="level4"><h4>Schema first</h4><p>We can simply remove <code>extend</code> keyword from the schema.<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">name</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">getUser</span><span class="token punctuation">(</span><span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token class-name">User</span>
<span class="token punctuation">}</span></code></pre></section><section id="code-first-4"class="level4"><h4>Code first</h4><p>To use Federation 2, we need to specify the federation version in <code>autoSchemaFile</code> option.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolver</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolver'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in this example</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token punctuation">{</span>
        federation<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="federated-example-posts-2"class="level4"><h4>Federated example: Posts</h4><p>With the same reason as above, we don't need to extend <code>User</code> and <code>Query</code> anymore.</section><section id="schema-first-5"class="level4"><h4>Schema first</h4><p>We can simply remove <code>extend</code> and <code>external</code> directives from the schema<pre class="language-graphql"><code class="language-graphql"><span class="token keyword">type</span> <span class="token class-name">Post</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">title</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
  <span class="token attr-name">body</span><span class="token punctuation">:</span> <span class="token scalar">String</span><span class="token operator">!</span>
  <span class="token attr-name">user</span><span class="token punctuation">:</span> <span class="token class-name">User</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token directive function">@key</span><span class="token punctuation">(</span><span class="token attr-name">fields</span><span class="token punctuation">:</span> <span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token attr-name">id</span><span class="token punctuation">:</span> <span class="token scalar">ID</span><span class="token operator">!</span>
  <span class="token attr-name">posts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
  <span class="token attr-name">getPosts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Post</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span></code></pre></section><section id="code-first-5"class="level4"><h4>Code first</h4><p>Since we don't extend <code>User</code> entity anymore, we can simply remove <code>extends</code> and <code>external</code> directives from <code>User</code>.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Directive</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ObjectType</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Field</span><span class="token punctuation">,</span> <span class="token constant">ID</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/graphql'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Post</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./post.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">ObjectType</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Directive</span></span><span class="token punctuation">(</span><span class="token string">'@key(fields: "id")'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token constant">ID</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token maybe-class-name">Post</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  posts<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Post</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Also, similarly to the User service, we need to specify in the <code>GraphQLModule</code> to use Federation 2.<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span>
  <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/apollo'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">User</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./user.entity'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsResolvers</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.resolvers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersResolvers</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.resolvers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PostsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./posts.service'</span><span class="token punctuation">;</span> <span class="token comment">// Not included in example</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">GraphQLModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">forRoot</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ApolloFederationDriverConfig</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      driver<span class="token operator">:</span> <span class="token maybe-class-name">ApolloFederationDriver</span><span class="token punctuation">,</span>
      autoSchemaFile<span class="token operator">:</span> <span class="token punctuation">{</span>
        federation<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      buildSchemaOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
        orphanedTypes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">User</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PostsResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UsersResolver</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PostsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>