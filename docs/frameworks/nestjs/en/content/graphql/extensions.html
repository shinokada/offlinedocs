<!doctype html><html lang="en"><meta charset="utf-8"><title>Extensions</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="extensions"class="level3"><h3>Extensions</h3><blockquote><p>warning <strong>Warning</strong> This chapter applies only to the code first approach.</blockquote><p>Extensions is an <strong>advanced, low-level feature</strong> that lets you define arbitrary data in the types configuration. Attaching custom metadata to certain fields allows you to create more sophisticated, generic solutions. For example, with extensions, you can define field-level roles required to access particular fields. Such roles can be reflected at runtime to determine whether the caller has sufficient permissions to retrieve a specific field.<section id="adding-custom-metadata"class="level4"><h4>Adding custom metadata</h4><p>To attach custom metadata for a field, use the <code>@Extensions()</code> decorator exported from the <code>@nestjs/graphql</code> package.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Extensions</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> role<span class="token operator">:</span> <span class="token maybe-class-name">Role</span><span class="token punctuation">.</span><span class="token constant">ADMIN</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></code></pre><p>In the example above, we assigned the <code>role</code> metadata property the value of <code>Role.ADMIN</code>. <code>Role</code> is a simple TypeScript enum that groups all the user roles available in our system.<p>Note, in addition to setting metadata on fields, you can use the <code>@Extensions()</code> decorator at the class level and method level (e.g., on the query handler).</section><section id="using-custom-metadata"class="level4"><h4>Using custom metadata</h4><p>Logic that leverages the custom metadata can be as complex as needed. For example, you can create a simple interceptor that stores/logs events per method invocation, or a <a href="/graphql/field-middleware">field middleware</a> that matches roles required to retrieve a field with the caller permissions (field-level permissions system).<p>For illustration purposes, let's define a <code>checkRoleMiddleware</code> that compares a user's role (hardcoded here) with a role required to access a target field:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> checkRoleMiddleware<span class="token operator">:</span> <span class="token function-variable function"><span class="token maybe-class-name">FieldMiddleware</span></span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>
  ctx<span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareContext</span><span class="token punctuation">,</span>
  next<span class="token operator">:</span> <span class="token maybe-class-name">NextFn</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> info <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> extensions <span class="token punctuation">}</span> <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token property-access">parentType</span><span class="token punctuation">.</span><span class="token method function property-access">getFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>info<span class="token punctuation">.</span><span class="token property-access">fieldName</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * In a real-world application, the "userRole" variable
   * should represent the caller's (user) role (for example, "ctx.user.role").
   */</span>
  <span class="token keyword">const</span> userRole <span class="token operator">=</span> <span class="token maybe-class-name">Role</span><span class="token punctuation">.</span><span class="token constant">USER</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>userRole <span class="token operator">===</span> extensions<span class="token punctuation">.</span><span class="token property-access">role</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// or just "return null" to ignore</span>
    <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ForbiddenException</span></span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">User does not have sufficient permissions to access "</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>info<span class="token punctuation">.</span><span class="token property-access">fieldName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" field.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword control-flow">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>With this in place, we can register a middleware for the <code>password</code> field, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Field</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> middleware<span class="token operator">:</span> <span class="token punctuation">[</span>checkRoleMiddleware<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Extensions</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> role<span class="token operator">:</span> <span class="token maybe-class-name">Role</span><span class="token punctuation">.</span><span class="token constant">ADMIN</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
password<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>