<!doctype html><html lang="en"><meta charset="utf-8"><title>Pipes</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="pipes"class="level3"><h3>Pipes</h3><p>A pipe is a class annotated with the <code>@Injectable()</code> decorator, which implements the <code>PipeTransform</code> interface.<figure><img src="/Users/shinichiokada/Bash_Projects/markdown-docs-as-pdf/.vivliostyle/nestjs/en/src/assets/Pipe_1.png"></figure><p>Pipes have two typical use cases:<ul><li><strong>transformation</strong>: transform input data to the desired form (e.g., from string to integer)<li><strong>validation</strong>: evaluate input data and if valid, simply pass it through unchanged; otherwise, throw an exception when the data is incorrect</ul><p>In both cases, pipes operate on the <code>arguments</code> being processed by a <a href="controllers#route-parameters">controller route handler</a>. Nest interposes a pipe just before a method is invoked, and the pipe receives the arguments destined for the method and operates on them. Any transformation or validation operation takes place at that time, after which the route handler is invoked with any (potentially) transformed arguments.<p>Nest comes with a number of built-in pipes that you can use out-of-the-box. You can also build your own custom pipes. In this chapter, we'll introduce the built-in pipes and show how to bind them to route handlers. We'll then examine several custom-built pipes to show how you can build one from scratch.<blockquote><p>info <strong>Hint</strong> Pipes run inside the exceptions zone. This means that when a Pipe throws an exception it is handled by the exceptions layer (global exceptions filter and any <a href="/exception-filters">exceptions filters</a> that are applied to the current context). Given the above, it should be clear that when an exception is thrown in a Pipe, no controller method is subsequently executed. This gives you a best-practice technique for validating data coming into the application from external sources at the system boundary.</blockquote><section id="built-in-pipes"class="level4"><h4>Built-in pipes</h4><p>Nest comes with nine pipes available out-of-the-box:<ul><li><code>ValidationPipe</code><li><code>ParseIntPipe</code><li><code>ParseFloatPipe</code><li><code>ParseBoolPipe</code><li><code>ParseArrayPipe</code><li><code>ParseUUIDPipe</code><li><code>ParseEnumPipe</code><li><code>DefaultValuePipe</code><li><code>ParseFilePipe</code></ul><p>They're exported from the <code>@nestjs/common</code> package.<p>Let's take a quick look at using <code>ParseIntPipe</code>. This is an example of the <strong>transformation</strong> use case, where the pipe ensures that a method handler parameter is converted to a JavaScript integer (or throws an exception if the conversion fails). Later in this chapter, we'll show a simple custom implementation for a <code>ParseIntPipe</code>. The example techniques below also apply to the other built-in transformation pipes (<code>ParseBoolPipe</code>, <code>ParseFloatPipe</code>, <code>ParseEnumPipe</code>, <code>ParseArrayPipe</code> and <code>ParseUUIDPipe</code>, which we'll refer to as the <code>Parse*</code> pipes in this chapter).</section><section id="binding-pipes"class="level4"><h4>Binding pipes</h4><p>To use a pipe, we need to bind an instance of the pipe class to the appropriate context. In our <code>ParseIntPipe</code> example, we want to associate the pipe with a particular route handler method, and make sure it runs before the method is called. We do so with the following construct, which we'll refer to as binding the pipe at the method parameter level:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Param</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ParseIntPipe</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>This ensures that one of the following two conditions is true: either the parameter we receive in the <code>findOne()</code> method is a number (as expected in our call to <code>this.catsService.findOne()</code>), or an exception is thrown before the route handler is called.<p>For example, assume the route is called like:<pre class="language-bash"><code class="language-bash">GET localhost:3000/abc</code></pre><p>Nest will throw an exception like this:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"statusCode"</span><span class="token operator">:</span> <span class="token number">400</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Validation failed (numeric string is expected)"</span><span class="token punctuation">,</span>
  <span class="token property">"error"</span><span class="token operator">:</span> <span class="token string">"Bad Request"</span>
<span class="token punctuation">}</span></code></pre><p>The exception will prevent the body of the <code>findOne()</code> method from executing.<p>In the example above, we pass a class (<code>ParseIntPipe</code>), not an instance, leaving responsibility for instantiation to the framework and enabling dependency injection. As with pipes and guards, we can instead pass an in-place instance. Passing an in-place instance is useful if we want to customize the built-in pipe's behavior by passing options:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Param</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ParseIntPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> errorHttpStatusCode<span class="token operator">:</span> <span class="token maybe-class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">NOT_ACCEPTABLE</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Binding the other transformation pipes (all of the <strong>Parse*</strong> pipes) works similarly. These pipes all work in the context of validating route parameters, query string parameters and request body values.<p>For example with a query string parameter:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ParseIntPipe</span><span class="token punctuation">)</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Here's an example of using the <code>ParseUUIDPipe</code> to parse a string parameter and validate if it is a UUID.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':uuid'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Param</span></span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ParseUUIDPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> uuid<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':uuid'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Param</span></span><span class="token punctuation">(</span><span class="token string">'uuid'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ParseUUIDPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> When using <code>ParseUUIDPipe()</code> you are parsing UUID in version 3, 4 or 5, if you only require a specific version of UUID you can pass a version in the pipe options.</blockquote><p>Above we've seen examples of binding the various <code>Parse*</code> family of built-in pipes. Binding validation pipes is a little bit different; we'll discuss that in the following section.<blockquote><p>info <strong>Hint</strong> Also, see <a href="/techniques/validation">Validation techniques</a> for extensive examples of validation pipes.</blockquote></section><section id="custom-pipes"class="level4"><h4>Custom pipes</h4><p>As mentioned, you can build your own custom pipes. While Nest provides a robust built-in <code>ParseIntPipe</code> and <code>ValidationPipe</code>, let's build simple custom versions of each from scratch to see how custom pipes are constructed.<p>We start with a simple <code>ValidationPipe</code>. Initially, we'll have it simply take an input value and immediately return the same value, behaving like an identity function.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>validation<span class="token punctuation">.</span><span class="token property-access">pipe</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PipeTransform</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ArgumentMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ValidationPipe</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">PipeTransform</span></span> <span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ValidationPipe</span></span> <span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>PipeTransform&#x3C;T, R></code> is a generic interface that must be implemented by any pipe. The generic interface uses <code>T</code> to indicate the type of the input <code>value</code>, and <code>R</code> to indicate the return type of the <code>transform()</code> method.</blockquote><p>Every pipe must implement the <code>transform()</code> method to fulfill the <code>PipeTransform</code> interface contract. This method has two parameters:<ul><li><code>value</code><li><code>metadata</code></ul><p>The <code>value</code> parameter is the currently processed method argument (before it is received by the route handling method), and <code>metadata</code> is the currently processed method argument's metadata. The metadata object has these properties:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ArgumentMetadata</span></span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'body'</span> <span class="token operator">|</span> <span class="token string">'query'</span> <span class="token operator">|</span> <span class="token string">'param'</span> <span class="token operator">|</span> <span class="token string">'custom'</span><span class="token punctuation">;</span>
  metatype<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">Type</span><span class="token operator">&#x3C;</span><span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">;</span>
  data<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>These properties describe the currently processed argument.<table><tr><td><code>type</code><td>Indicates whether the argument is a body <code>@Body()</code>, query <code>@Query()</code>, param <code>@Param()</code>, or a custom parameter (read more <a routerlink="/custom-decorators">here</a>).<tr><td><code>metatype</code><td>Provides the metatype of the argument, for example, <code>String</code>. Note: the value is <code>undefined</code> if you either omit a type declaration in the route handler method signature, or use vanilla JavaScript.<tr><td><code>data</code><td>The string passed to the decorator, for example <code>@Body('string')</code>. It's <code>undefined</code> if you leave the decorator parenthesis empty.</table><blockquote><p>warning <strong>Warning</strong> TypeScript interfaces disappear during transpilation. Thus, if a method parameter's type is declared as an interface instead of a class, the <code>metatype</code> value will be <code>Object</code>.</blockquote></section><section id="schema-based-validation"class="level4"><h4>Schema based validation</h4><p>Let's make our validation pipe a little more useful. Take a closer look at the <code>create()</code> method of the <code>CatsController</code>, where we probably would like to ensure that the post body object is valid before attempting to run our service method.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Let's focus in on the <code>createCatDto</code> body parameter. Its type is <code>CreateCatDto</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>create<span class="token operator">-</span>cat<span class="token punctuation">.</span><span class="token property-access">dto</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CreateCatDto</span></span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>We want to ensure that any incoming request to the create method contains a valid body. So we have to validate the three members of the <code>createCatDto</code> object. We could do this inside the route handler method, but doing so is not ideal as it would break the <strong>single responsibility rule</strong> (SRP).<p>Another approach could be to create a <strong>validator class</strong> and delegate the task there. This has the disadvantage that we would have to remember to call this validator at the beginning of each method.<p>How about creating validation middleware? This could work, but unfortunately it's not possible to create <strong>generic middleware</strong> which can be used across all contexts across the whole application. This is because middleware is unaware of the <strong>execution context</strong>, including the handler that will be called and any of its parameters.<p>This is, of course, exactly the use case for which pipes are designed. So let's go ahead and refine our validation pipe.<p><app-banner-courses></app-banner-courses></section><section id="object-schema-validation"class="level4"><h4>Object schema validation</h4><p>There are several approaches available for doing object validation in a clean, <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> way. One common approach is to use <strong>schema-based</strong> validation. Let's go ahead and try that approach.<p>The <a href="https://github.com/sideway/joi">Joi</a> library allows you to create schemas in a straightforward way, with a readable API. Let's build a validation pipe that makes use of Joi-based schemas.<p>Start by installing the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save joi</code></pre><p>In the code sample below, we create a simple class that takes a schema as a <code>constructor</code> argument. We then apply the <code>schema.validate()</code> method, which validates our incoming argument against the provided schema.<p>As noted earlier, a <strong>validation pipe</strong> either returns the value unchanged, or throws an exception.<p>In the next section, you'll see how we supply the appropriate schema for a given controller method using the <code>@UsePipes()</code> decorator. Doing so makes our validation pipe re-usable across contexts, just as we set out to do.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PipeTransform</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">,</span> <span class="token maybe-class-name">BadRequestException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ObjectSchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'joi'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JoiValidationPipe</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">PipeTransform</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> schema<span class="token operator">:</span> <span class="token maybe-class-name">ObjectSchema</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">.</span><span class="token method function property-access">validate</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">BadRequestException</span></span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">BadRequestException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">JoiValidationPipe</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>schema<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">schema</span> <span class="token operator">=</span> schema<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">.</span><span class="token method function property-access">validate</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">BadRequestException</span></span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="binding-validation-pipes"class="level4"><h4>Binding validation pipes</h4><p>Earlier, we saw how to bind transformation pipes (like <code>ParseIntPipe</code> and the rest of the <code>Parse*</code> pipes).<p>Binding validation pipes is also very straightforward.<p>In this case, we want to bind the pipe at the method call level. In our current example, we need to do the following to use the <code>JoiValidationPipe</code>:<ol><li>Create an instance of the <code>JoiValidationPipe</code><li>Pass the context-specific Joi schema in the class constructor of the pipe<li>Bind the pipe to the method</ol><p>We do that using the <code>@UsePipes()</code> decorator as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UsePipes</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">JoiValidationPipe</span></span><span class="token punctuation">(</span>createCatSchema<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UsePipes</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">JoiValidationPipe</span></span><span class="token punctuation">(</span>createCatSchema<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@UsePipes()</code> decorator is imported from the <code>@nestjs/common</code> package.</blockquote></section><section id="class-validator"class="level4"><h4>Class validator</h4><blockquote><p>warning <strong>Warning</strong> The techniques in this section require TypeScript, and are not available if your app is written using vanilla JavaScript.</blockquote><p>Let's look at an alternate implementation for our validation technique.<p>Nest works well with the <a href="https://github.com/typestack/class-validator">class-validator</a> library. This powerful library allows you to use decorator-based validation. Decorator-based validation is extremely powerful, especially when combined with Nest's <strong>Pipe</strong> capabilities since we have access to the <code>metatype</code> of the processed property. Before we start, we need to install the required packages:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save class-validator class-transformer</code></pre><p>Once these are installed, we can add a few decorators to the <code>CreateCatDto</code> class. Here we see a significant advantage of this technique: the <code>CreateCatDto</code> class remains the single source of truth for our Post body object (rather than having to create a separate validation class).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>create<span class="token operator">-</span>cat<span class="token punctuation">.</span><span class="token property-access">dto</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">IsString</span><span class="token punctuation">,</span> <span class="token maybe-class-name">IsInt</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CreateCatDto</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">IsString</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">IsInt</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">IsString</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Read more about the class-validator decorators <a href="https://github.com/typestack/class-validator#usage">here</a>.</blockquote><p>Now we can create a <code>ValidationPipe</code> class that uses these annotations.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>validation<span class="token punctuation">.</span><span class="token property-access">pipe</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PipeTransform</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">,</span> <span class="token maybe-class-name">BadRequestException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> validate <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'class-validator'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> plainToInstance <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'class-transformer'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ValidationPipe</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">PipeTransform</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> metatype <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>metatype <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">toValidate</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> object <span class="token operator">=</span> <span class="token function">plainToInstance</span><span class="token punctuation">(</span>metatype<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> errors <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">validate</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>errors<span class="token punctuation">.</span><span class="token property-access">length</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">BadRequestException</span></span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">toValidate</span><span class="token punctuation">(</span>metatype<span class="token operator">:</span> <span class="token known-class-name class-name">Function</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> types<span class="token operator">:</span> <span class="token known-class-name class-name">Function</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token known-class-name class-name">String</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Boolean</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Number</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Array</span><span class="token punctuation">,</span> <span class="token known-class-name class-name">Object</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> <span class="token operator">!</span>types<span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>metatype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> Above, we have used the <a href="https://github.com/typestack/class-transformer">class-transformer</a> library. It's made by the same author as the <strong>class-validator</strong> library, and as a result, they play very well together.</blockquote><p>Let's go through this code. First, note that the <code>transform()</code> method is marked as <code>async</code>. This is possible because Nest supports both synchronous and <strong>asynchronous</strong> pipes. We make this method <code>async</code> because some of the class-validator validations <a href="https://github.com/typestack/class-validator#custom-validation-classes">can be async</a> (utilize Promises).<p>Next note that we are using destructuring to extract the metatype field (extracting just this member from an <code>ArgumentMetadata</code>) into our <code>metatype</code> parameter. This is just shorthand for getting the full <code>ArgumentMetadata</code> and then having an additional statement to assign the metatype variable.<p>Next, note the helper function <code>toValidate()</code>. It's responsible for bypassing the validation step when the current argument being processed is a native JavaScript type (these can't have validation decorators attached, so there's no reason to run them through the validation step).<p>Next, we use the class-transformer function <code>plainToInstance()</code> to transform our plain JavaScript argument object into a typed object so that we can apply validation. The reason we must do this is that the incoming post body object, when deserialized from the network request, does <strong>not have any type information</strong> (this is the way the underlying platform, such as Express, works). Class-validator needs to use the validation decorators we defined for our DTO earlier, so we need to perform this transformation to treat the incoming body as an appropriately decorated object, not just a plain vanilla object.<p>Finally, as noted earlier, since this is a <strong>validation pipe</strong> it either returns the value unchanged, or throws an exception.<p>The last step is to bind the <code>ValidationPipe</code>. Pipes can be parameter-scoped, method-scoped, controller-scoped, or global-scoped. Earlier, with our Joi-based validation pipe, we saw an example of binding the pipe at the method level. In the example below, we'll bind the pipe instance to the route handler <code>@Body()</code> decorator so that our pipe is called to validate the post body.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ValidationPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Parameter-scoped pipes are useful when the validation logic concerns only one specified parameter.</section><section id="global-scoped-pipes"class="level4"><h4>Global scoped pipes</h4><p>Since the <code>ValidationPipe</code> was created to be as generic as possible, we can realize it's full utility by setting it up as a <strong>global-scoped</strong> pipe so that it is applied to every route handler across the entire application.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token method function property-access">useGlobalPipes</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ValidationPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Notice</strong> In the case of <a href="faq/hybrid-application">hybrid apps</a> the <code>useGlobalPipes()</code> method doesn't set up pipes for gateways and micro services. For "standard" (non-hybrid) microservice apps, <code>useGlobalPipes()</code> does mount pipes globally.</blockquote><p>Global pipes are used across the whole application, for every controller and every route handler.<p>Note that in terms of dependency injection, global pipes registered from outside of any module (with <code>useGlobalPipes()</code> as in the example above) cannot inject dependencies since the binding has been done outside the context of any module. In order to solve this issue, you can set up a global pipe <strong>directly from any module</strong> using the following construction:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_PIPE</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token constant">APP_PIPE</span><span class="token punctuation">,</span>
      useClass<span class="token operator">:</span> <span class="token maybe-class-name">ValidationPipe</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> When using this approach to perform dependency injection for the pipe, note that regardless of the module where this construction is employed, the pipe is, in fact, global. Where should this be done? Choose the module where the pipe (<code>ValidationPipe</code> in the example above) is defined. Also, <code>useClass</code> is not the only way of dealing with custom provider registration. Learn more <a href="/fundamentals/custom-providers">here</a>.</blockquote></section><section id="the-built-in-validationpipe"class="level4"><h4>The built-in ValidationPipe</h4><p>As a reminder, you don't have to build a generic validation pipe on your own since the <code>ValidationPipe</code> is provided by Nest out-of-the-box. The built-in <code>ValidationPipe</code> offers more options than the sample we built in this chapter, which has been kept basic for the sake of illustrating the mechanics of a custom-built pipe. You can find full details, along with lots of examples <a href="/techniques/validation">here</a>.</section><section id="transformation-use-case"class="level4"><h4>Transformation use case</h4><p>Validation isn't the only use case for custom pipes. At the beginning of this chapter, we mentioned that a pipe can also <strong>transform</strong> the input data to the desired format. This is possible because the value returned from the <code>transform</code> function completely overrides the previous value of the argument.<p>When is this useful? Consider that sometimes the data passed from the client needs to undergo some change - for example converting a string to an integer - before it can be properly handled by the route handler method. Furthermore, some required data fields may be missing, and we would like to apply default values. <strong>Transformation pipes</strong> can perform these functions by interposing a processing function between the client request and the request handler.<p>Here's a simple <code>ParseIntPipe</code> which is responsible for parsing a string into an integer value. (As noted above, Nest has a built-in <code>ParseIntPipe</code> that is more sophisticated; we include this as a simple example of a custom transformation pipe).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>parse<span class="token operator">-</span>int<span class="token punctuation">.</span><span class="token property-access">pipe</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PipeTransform</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">,</span> <span class="token maybe-class-name">BadRequestException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ParseIntPipe</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">PipeTransform</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">ArgumentMetadata</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">BadRequestException</span></span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">BadRequestException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ParseIntPipe</span></span> <span class="token punctuation">{</span>
  <span class="token function">transform</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token function">isNaN</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">BadRequestException</span></span><span class="token punctuation">(</span><span class="token string">'Validation failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> val<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>We can then bind this pipe to the selected param as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Param</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ParseIntPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Param</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ParseIntPipe</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Another useful transformation case would be to select an <strong>existing user</strong> entity from the database using an id supplied in the request:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token function">findOne</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Param</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UserByIdPipe</span><span class="token punctuation">)</span> userEntity<span class="token operator">:</span> <span class="token maybe-class-name">UserEntity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> userEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">':id'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Param</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">UserByIdPipe</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">findOne</span><span class="token punctuation">(</span>userEntity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> userEntity<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>We leave the implementation of this pipe to the reader, but note that like all other transformation pipes, it receives an input value (an <code>id</code>) and returns an output value (a <code>UserEntity</code> object). This can make your code more declarative and <a href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> by abstracting boilerplate code out of your handler and into a common pipe.</section><section id="providing-defaults"class="level4"><h4>Providing defaults</h4><p><code>Parse*</code> pipes expect a parameter's value to be defined. They throw an exception upon receiving <code>null</code> or <code>undefined</code> values. To allow an endpoint to handle missing querystring parameter values, we have to provide a default value to be injected before the <code>Parse*</code> pipes operate on these values. The <code>DefaultValuePipe</code> serves that purpose. Simply instantiate a <code>DefaultValuePipe</code> in the <code>@Query()</code> decorator before the relevant <code>Parse*</code> pipe, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'activeOnly'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DefaultValuePipe</span></span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ParseBoolPipe</span><span class="token punctuation">)</span> activeOnly<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'page'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DefaultValuePipe</span></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ParseIntPipe</span><span class="token punctuation">)</span> page<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">{</span> activeOnly<span class="token punctuation">,</span> page <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></section></section>