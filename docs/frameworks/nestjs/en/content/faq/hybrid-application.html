<!doctype html><html lang="en"><meta charset="utf-8"><title>Hybrid application</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="hybrid-application"class="level3"><h3>Hybrid application</h3><p>A hybrid application is one that both listens for HTTP requests, as well as makes use of connected microservices. The <code>INestApplication</code> instance can be connected with <code>INestMicroservice</code> instances through the <code>connectMicroservice()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> microservice <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token method function property-access">connectMicroservice</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">startAllMicroservices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To connect multiple microservice instances, issue the call to <code>connectMicroservice()</code> for each microservice:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// microservice #1</span>
<span class="token keyword">const</span> microserviceTcp <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">connectMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    port<span class="token operator">:</span> <span class="token number">3001</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// microservice #2</span>
<span class="token keyword">const</span> microserviceRedis <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">connectMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">REDIS</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">startAllMicroservices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3001</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To bind <code>@MessagePattern()</code> to only one transport strategy (for example, MQTT) in a hybrid application with multiple microservices, we can pass the second argument of type <code>Transport</code> which is an enum with all the built-in transport strategies defined.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'time.us.*'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">NATS</span><span class="token punctuation">)</span>
<span class="token function">getDate</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">NatsContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subject: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. "time.us.east"</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'time.us'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">)</span>
<span class="token function">getTCPDate</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'time.us.*'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">NATS</span><span class="token punctuation">)</span>
<span class="token function">getDate</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subject: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. "time.us.east"</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'time.us'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">)</span>
<span class="token function">getTCPDate</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>@Payload()</code>, <code>@Ctx()</code>, <code>Transport</code> and <code>NatsContext</code> are imported from <code>@nestjs/microservices</code>.</blockquote><section id="sharing-configuration"class="level4"><h4>Sharing configuration</h4><p>By default a hybrid application will not inherit global pipes, interceptors, guards and filters configured for the main (HTTP-based) application. To inherit these configuration properties from the main application, set the <code>inheritAppConfig</code> property in the second argument (an optional options object) of the <code>connectMicroservice()</code> call, as follow:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> microservice <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token method function property-access">connectMicroservice</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> inheritAppConfig<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>