<!doctype html><html lang="en"><meta charset="utf-8"><title>Kafka</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="kafka"class="level3"><h3>Kafka</h3><p><a href="https://kafka.apache.org/">Kafka</a> is an open source, distributed streaming platform which has three key capabilities:<ul><li>Publish and subscribe to streams of records, similar to a message queue or enterprise messaging system.<li>Store streams of records in a fault-tolerant durable way.<li>Process streams of records as they occur.</ul><p>The Kafka project aims to provide a unified, high-throughput, low-latency platform for handling real-time data feeds. It integrates very well with Apache Storm and Spark for real-time streaming data analysis.<section id="installation"class="level4"><h4>Installation</h4><p>To start building Kafka-based microservices, first install the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save kafkajs</code></pre></section><section id="overview"class="level4"><h4>Overview</h4><p>Like other Nest microservice transport layer implementations, you select the Kafka transporter mechanism using the <code>transport</code> property of the options object passed to the <code>createMicroservice()</code> method, along with an optional <code>options</code> property, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">KAFKA</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token punctuation">{</span>
      brokers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9092'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createMicroservice</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">KAFKA</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token punctuation">{</span>
      brokers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9092'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Transport</code> enum is imported from the <code>@nestjs/microservices</code> package.</blockquote></section><section id="options"class="level4"><h4>Options</h4><p>The <code>options</code> property is specific to the chosen transporter. The <strong>Kafka</strong> transporter exposes the properties described below.<table><tr><td><code>client</code><td>Client configuration options (read more <a href="https://kafka.js.org/docs/configuration"rel="nofollow"target="blank">here</a>)<tr><td><code>consumer</code><td>Consumer configuration options (read more <a href="https://kafka.js.org/docs/consuming#a-name-options-a-options"rel="nofollow"target="blank">here</a>)<tr><td><code>run</code><td>Run configuration options (read more <a href="https://kafka.js.org/docs/consuming"rel="nofollow"target="blank">here</a>)<tr><td><code>subscribe</code><td>Subscribe configuration options (read more <a href="https://kafka.js.org/docs/consuming#frombeginning"rel="nofollow"target="blank">here</a>)<tr><td><code>producer</code><td>Producer configuration options (read more <a href="https://kafka.js.org/docs/producing#options"rel="nofollow"target="blank">here</a>)<tr><td><code>send</code><td>Send configuration options (read more <a href="https://kafka.js.org/docs/producing#options"rel="nofollow"target="blank">here</a>)<tr><td><code>producerOnlyMode</code><td>Feature flag to skip consumer group registration and only act as a producer (<code>boolean</code>)</table></section><section id="client"class="level4"><h4>Client</h4><p>There is a small difference in Kafka compared to other microservice transporters. Instead of the <code>ClientProxy</code> class, we use the <code>ClientKafka</code> class.<p>Like other microservice transporters, you have <a href="https://docs.nestjs.com/microservices/basics#client">several options</a> for creating a <code>ClientKafka</code> instance.<p>One method for creating an instance is to use the <code>ClientsModule</code>. To create a client instance with the <code>ClientsModule</code>, import it and use the <code>register()</code> method to pass an options object with the same properties shown above in the <code>createMicroservice()</code> method, as well as a <code>name</code> property to be used as the injection token. Read more about <code>ClientsModule</code> <a href="https://docs.nestjs.com/microservices/basics#client">here</a>.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ClientsModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'HERO_SERVICE'</span><span class="token punctuation">,</span>
        transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">KAFKA</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          client<span class="token operator">:</span> <span class="token punctuation">{</span>
            clientId<span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
            brokers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9092'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          consumer<span class="token operator">:</span> <span class="token punctuation">{</span>
            groupId<span class="token operator">:</span> <span class="token string">'hero-consumer'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Other options to create a client (either <code>ClientProxyFactory</code> or <code>@Client()</code>) can be used as well. You can read about them <a href="https://docs.nestjs.com/microservices/basics#client">here</a>.<p>Use the <code>@Client()</code> decorator as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Client</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">KAFKA</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token punctuation">{</span>
      clientId<span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
      brokers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9092'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    consumer<span class="token operator">:</span> <span class="token punctuation">{</span>
      groupId<span class="token operator">:</span> <span class="token string">'hero-consumer'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
client<span class="token operator">:</span> <span class="token maybe-class-name">ClientKafka</span><span class="token punctuation">;</span></code></pre></section><section id="message-pattern"class="level4"><h4>Message pattern</h4><p>The Kafka microservice message pattern utilizes two topics for the request and reply channels. The <code>ClientKafka#send()</code> method sends messages with a <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/ReturnAddress.html">return address</a> by associating a <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/CorrelationIdentifier.html">correlation id</a>, reply topic, and reply partition with the request message. This requires the <code>ClientKafka</code> instance to be subscribed to the reply topic and assigned to at least one partition before sending a message.<p>Subsequently, you need to have at least one reply topic partition for every Nest application running. For example, if you are running 4 Nest applications but the reply topic only has 3 partitions, then 1 of the Nest applications will error out when trying to send a message.<p>When new <code>ClientKafka</code> instances are launched they join the consumer group and subscribe to their respective topics. This process triggers a rebalance of topic partitions assigned to consumers of the consumer group.<p>Normally, topic partitions are assigned using the round robin partitioner, which assigns topic partitions to a collection of consumers sorted by consumer names which are randomly set on application launch. However, when a new consumer joins the consumer group, the new consumer can be positioned anywhere within the collection of consumers. This creates a condition where pre-existing consumers can be assigned different partitions when the pre-existing consumer is positioned after the new consumer. As a result, the consumers that are assigned different partitions will lose response messages of requests sent before the rebalance.<p>To prevent the <code>ClientKafka</code> consumers from losing response messages, a Nest-specific built-in custom partitioner is utilized. This custom partitioner assigns partitions to a collection of consumers sorted by high-resolution timestamps (<code>process.hrtime()</code>) that are set on application launch.</section><section id="message-response-subscription"class="level4"><h4>Message response subscription</h4><blockquote><p>warning <strong>Note</strong> This section is only relevant if you use <a href="/microservices/basics#request-response">request-response</a> message style (with the <code>@MessagePattern</code> decorator and the <code>ClientKafka#send</code> method). Subscribing to the response topic is not necessary for the <a href="/microservices/basics#event-based">event-based</a> communication (<code>@EventPattern</code> decorator and <code>ClientKafka#emit</code> method).</blockquote><p>The <code>ClientKafka</code> class provides the <code>subscribeToResponseOf()</code> method. The <code>subscribeToResponseOf()</code> method takes a request's topic name as an argument and adds the derived reply topic name to a collection of reply topics. This method is required when implementing the message pattern.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">subscribeToResponseOf</span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If the <code>ClientKafka</code> instance is created asynchronously, the <code>subscribeToResponseOf()</code> method must be called before calling the <code>connect()</code> method.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">subscribeToResponseOf</span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="incoming"class="level4"><h4>Incoming</h4><p>Nest receives incoming Kafka messages as an object with <code>key</code>, <code>value</code>, and <code>headers</code> properties that have values of type <code>Buffer</code>. Nest then parses these values by transforming the buffers into strings. If the string is "object like", Nest attempts to parse the string as <code>JSON</code>. The <code>value</code> is then passed to its associated handler.</section><section id="outgoing"class="level4"><h4>Outgoing</h4><p>Nest sends outgoing Kafka messages after a serialization process when publishing events or sending messages. This occurs on arguments passed to the <code>ClientKafka</code> <code>emit()</code> and <code>send()</code> methods or on values returned from a <code>@MessagePattern</code> method. This serialization "stringifies" objects that are not strings or buffers by using <code>JSON.stringify()</code> or the <code>toString()</code> prototype method.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
  <span class="token function">killDragon</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> message<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonMessage</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dragonId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token property-access">dragonId</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Mythical Sword'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Key to Dungeon'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>@Payload()</code> is imported from the <code>@nestjs/microservices</code>.</blockquote><p>Outgoing messages can also be keyed by passing an object with the <code>key</code> and <code>value</code> properties. Keying messages is important for meeting the <a href="https://docs.confluent.io/current/ksql/docs/developer-guide/partition-data.html#co-partitioning-requirements">co-partitioning requirement</a>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
  <span class="token function">killDragon</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> message<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonMessage</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> realm <span class="token operator">=</span> <span class="token string">'Nest'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> heroId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token property-access">heroId</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dragonId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token property-access">dragonId</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Mythical Sword'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Key to Dungeon'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        realm
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      key<span class="token operator">:</span> heroId<span class="token punctuation">,</span>
      value<span class="token operator">:</span> items
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Additionally, messages passed in this format can also contain custom headers set in the <code>headers</code> hash property. Header hash property values must be either of type <code>string</code> or type <code>Buffer</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
  <span class="token function">killDragon</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> message<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonMessage</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> realm <span class="token operator">=</span> <span class="token string">'Nest'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> heroId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token property-access">heroId</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> dragonId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token property-access">dragonId</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Mythical Sword'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Key to Dungeon'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      headers<span class="token operator">:</span> <span class="token punctuation">{</span>
        kafka_nestRealm<span class="token operator">:</span> realm
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      key<span class="token operator">:</span> heroId<span class="token punctuation">,</span>
      value<span class="token operator">:</span> items
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="event-based"class="level4"><h4>Event-based</h4><p>While the request-response method is ideal for exchanging messages between services, it is less suitable when your message style is event-based (which in turn is ideal for Kafka) - when you just want to publish events <strong>without waiting for a response</strong>. In that case, you do not want the overhead required by request-response for maintaining two topics.<p>Check out these two sections to learn more about this: <a href="/microservices/basics#event-based">Overview: Event-based</a> and <a href="/microservices/basics#publishing-events">Overview: Publishing events</a>.</section><section id="context"class="level4"><h4>Context</h4><p>In more sophisticated scenarios, you may want to access more information about the incoming request. When using the Kafka transporter, you can access the <code>KafkaContext</code> object.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
<span class="token function">killDragon</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> message<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonMessage</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">KafkaContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Topic: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
<span class="token function">killDragon</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Topic: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>@Payload()</code>, <code>@Ctx()</code> and <code>KafkaContext</code> are imported from the <code>@nestjs/microservices</code> package.</blockquote><p>To access the original Kafka <code>IncomingMessage</code> object, use the <code>getMessage()</code> method of the <code>KafkaContext</code> object, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
<span class="token function">killDragon</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> message<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonMessage</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">KafkaContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> originalMessage <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> partition<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span> <span class="token operator">=</span> originalMessage<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
<span class="token function">killDragon</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> originalMessage <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> headers<span class="token punctuation">,</span> partition<span class="token punctuation">,</span> timestamp <span class="token punctuation">}</span> <span class="token operator">=</span> originalMessage<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Where the <code>IncomingMessage</code> fulfills the following interface:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">IncomingMessage</span></span> <span class="token punctuation">{</span>
  topic<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  partition<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  timestamp<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  size<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  attributes<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  offset<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  key<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span>
  headers<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If your handler involves a slow processing time for each received message you should consider using the <code>heartbeat</code> callback. To retrieve the <code>heartbeat</code> function, use the <code>getHeartbeat()</code> method of the <code>KafkaContext</code>, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'hero.kill.dragon'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">killDragon</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> message<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonMessage</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">KafkaContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> heartbeat <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Do some slow processing</span>
  <span class="token keyword control-flow">await</span> <span class="token function">doWorkPart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Send heartbeat to not exceed the sessionTimeout</span>
  <span class="token keyword control-flow">await</span> <span class="token function">heartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Do some slow processing again</span>
  <span class="token keyword control-flow">await</span> <span class="token function">doWorkPart2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="naming-conventions"class="level4"><h4>Naming conventions</h4><p>The Kafka microservice components append a description of their respective role onto the <code>client.clientId</code> and <code>consumer.groupId</code> options to prevent collisions between Nest microservice client and server components. By default the <code>ClientKafka</code> components append <code>-client</code> and the <code>ServerKafka</code> components append <code>-server</code> to both of these options. Note how the provided values below are transformed in that way (as shown in the comments).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createMicroservice</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">KAFKA</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token punctuation">{</span>
      clientId<span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span> <span class="token comment">// hero-server</span>
      brokers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9092'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    consumer<span class="token operator">:</span> <span class="token punctuation">{</span>
      groupId<span class="token operator">:</span> <span class="token string">'hero-consumer'</span> <span class="token comment">// hero-consumer-server</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>And for the client:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Client</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">KAFKA</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> <span class="token punctuation">{</span>
      clientId<span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span> <span class="token comment">// hero-client</span>
      brokers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'localhost:9092'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    consumer<span class="token operator">:</span> <span class="token punctuation">{</span>
      groupId<span class="token operator">:</span> <span class="token string">'hero-consumer'</span> <span class="token comment">// hero-consumer-client</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
client<span class="token operator">:</span> <span class="token maybe-class-name">ClientKafka</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Kafka client and consumer naming conventions can be customized by extending <code>ClientKafka</code> and <code>KafkaServer</code> in your own custom provider and overriding the constructor.</blockquote><p>Since the Kafka microservice message pattern utilizes two topics for the request and reply channels, a reply pattern should be derived from the request topic. By default, the name of the reply topic is the composite of the request topic name with <code>.reply</code> appended.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">subscribeToResponseOf</span><span class="token punctuation">(</span><span class="token string">'hero.get'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hero.get.reply</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Kafka reply topic naming conventions can be customized by extending <code>ClientKafka</code> in your own custom provider and overriding the <code>getResponsePatternName</code> method.</blockquote></section><section id="retriable-exceptions"class="level4"><h4>Retriable exceptions</h4><p>Similar to other transporters, all unhandled exceptions are automatically wrapped into an <code>RpcException</code> and converted to a "user-friendly" format. However, there are edge-cases when you might want to bypass this mechanism and let exceptions be consumed by the <code>kafkajs</code> driver instead. Throwing an exception when processing a message instructs <code>kafkajs</code> to <strong>retry</strong> it (redeliver it) which means that even though the message (or event) handler was triggered, the offset won't be committed to Kafka.<blockquote><p>warning <strong>Warning</strong> For event handlers (event-based communication), all unhandled exceptions are considered <strong>retriable exceptions</strong> by default.</blockquote><p>For this, you can use a dedicated class called <code>KafkaRetriableException</code>, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">KafkaRetriableException</span></span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>KafkaRetriableException</code> class is exported from the <code>@nestjs/microservices</code> package. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>