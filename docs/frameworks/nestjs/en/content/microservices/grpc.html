<!doctype html><html lang="en"><meta charset="utf-8"><title>gRPC</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="grpc"class="level3"><h3>gRPC</h3><p><a href="https://github.com/grpc/grpc-node">gRPC</a> is a modern, open source, high performance RPC framework that can run in any environment. It can efficiently connect services in and across data centers with pluggable support for load balancing, tracing, health checking and authentication.<p>Like many RPC systems, gRPC is based on the concept of defining a service in terms of functions (methods) that can be called remotely. For each method, you define the parameters and return types. Services, parameters, and return types are defined in <code>.proto</code> files using Google's open source language-neutral <a href="https://developers.google.com/protocol-buffers">protocol buffers</a> mechanism.<p>With the gRPC transporter, Nest uses <code>.proto</code> files to dynamically bind clients and servers to make it easy to implement remote procedure calls, automatically serializing and deserializing structured data.<section id="installation"class="level4"><h4>Installation</h4><p>To start building gRPC-based microservices, first install the required packages:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save @grpc/grpc-js @grpc/proto-loader</code></pre></section><section id="overview"class="level4"><h4>Overview</h4><p>Like other Nest microservices transport layer implementations, you select the gRPC transporter mechanism using the <code>transport</code> property of the options object passed to the <code>createMicroservice()</code> method. In the following example, we'll set up a hero service. The <code>options</code> property provides metadata about that service; its properties are described <a href="microservices/grpc#options">below</a>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">GRPC</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
    protoPath<span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'hero/hero.proto'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createMicroservice</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">GRPC</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
    protoPath<span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'hero/hero.proto'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>join()</code> function is imported from the <code>path</code> package; the <code>Transport</code> enum is imported from the <code>@nestjs/microservices</code> package.</blockquote><p>In the <code>nest-cli.json</code> file, we add the <code>assets</code> property that allows us to distribute non-TypeScript files, and <code>watchAssets</code> - to turn on watching all non-TypeScript assets. In our case, we want <code>.proto</code> files to be automatically copied to the <code>dist</code> folder.<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"compilerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"assets"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"**/*.proto"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"watchAssets"</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="options"class="level4"><h4>Options</h4><p>The <strong>gRPC</strong> transporter options object exposes the properties described below.<table><tr><td><code>package</code><td>Protobuf package name (matches <code>package</code> setting from <code>.proto</code> file). Required<tr><td><code>protoPath</code><td>Absolute (or relative to the root dir) path to the <code>.proto</code> file. Required<tr><td><code>url</code><td>Connection url. String in the format <code>ip address/dns name:port</code> (for example, <code>'localhost:50051'</code>) defining the address/port on which the transporter establishes a connection. Optional. Defaults to <code>'localhost:5000'</code><tr><td><code>protoLoader</code><td>NPM package name for the utility to load <code>.proto</code> files. Optional. Defaults to <code>'@grpc/proto-loader'</code><tr><td><code>loader</code><td><code>@grpc/proto-loader</code> options. These provide detailed control over the behavior of <code>.proto</code> files. Optional. See <a href="https://github.com/grpc/grpc-node/blob/master/packages/proto-loader/README.md"rel="nofollow"target="_blank">here</a> for more details<tr><td><code>credentials</code><td>Server credentials. Optional. <a href="https://grpc.io/grpc/node/grpc.ServerCredentials.html"rel="nofollow"target="_blank">Read more here</a></table></section><section id="sample-grpc-service"class="level4"><h4>Sample gRPC service</h4><p>Let's define our sample gRPC service called <code>HeroesService</code>. In the above <code>options</code> object, the<code>protoPath</code> property sets a path to the <code>.proto</code> definitions file <code>hero.proto</code>. The <code>hero.proto</code> file is structured using <a href="https://developers.google.com/protocol-buffers">protocol buffers</a>. Here's what it looks like:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// hero/hero.proto</span>
syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

<span class="token keyword">package</span> hero<span class="token punctuation">;</span>

service <span class="token maybe-class-name">HeroesService</span> <span class="token punctuation">{</span>
  rpc <span class="token function"><span class="token maybe-class-name">FindOne</span></span> <span class="token punctuation">(</span><span class="token maybe-class-name">HeroById</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token maybe-class-name">Hero</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

message <span class="token maybe-class-name">HeroById</span> <span class="token punctuation">{</span>
  int32 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token maybe-class-name">Hero</span> <span class="token punctuation">{</span>
  int32 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Our <code>HeroesService</code> exposes a <code>FindOne()</code> method. This method expects an input argument of type <code>HeroById</code> and returns a <code>Hero</code> message (protocol buffers use <code>message</code> elements to define both parameter types and return types).<p>Next, we need to implement the service. To define a handler that fulfills this definition, we use the <code>@GrpcMethod()</code> decorator in a controller, as shown below. This decorator provides the metadata needed to declare a method as a gRPC service method.<blockquote><p>info <strong>Hint</strong> The <code>@MessagePattern()</code> decorator (<a href="microservices/basics#request-response">read more</a>) introduced in previous microservices chapters is not used with gRPC-based microservices. The <code>@GrpcMethod()</code> decorator effectively takes its place for gRPC-based microservices.</blockquote><pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token string">'HeroesService'</span><span class="token punctuation">,</span> <span class="token string">'FindOne'</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token maybe-class-name">HeroById</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">Metadata</span><span class="token punctuation">,</span> call<span class="token operator">:</span> <span class="token maybe-class-name">ServerUnaryCall</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Hero</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token string">'HeroesService'</span><span class="token punctuation">,</span> <span class="token string">'FindOne'</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@GrpcMethod()</code> decorator is imported from the <code>@nestjs/microservices</code> package, while <code>Metadata</code> and <code>ServerUnaryCall</code> from the <code>grpc</code> package.</blockquote><p>The decorator shown above takes two arguments. The first is the service name (e.g., <code>'HeroesService'</code>), corresponding to the <code>HeroesService</code> service definition in <code>hero.proto</code>. The second (the string <code>'FindOne'</code>) corresponds to the <code>FindOne()</code> rpc method defined within <code>HeroesService</code> in the <code>hero.proto</code> file.<p>The <code>findOne()</code> handler method takes three arguments, the <code>data</code> passed from the caller, <code>metadata</code> that stores gRPC request metadata and <code>call</code> to obtain the <code>GrpcCall</code> object properties such as <code>sendMetadata</code> for send metadata to client.<p>Both <code>@GrpcMethod()</code> decorator arguments are optional. If called without the second argument (e.g., <code>'FindOne'</code>), Nest will automatically associate the <code>.proto</code> file rpc method with the handler based on converting the handler name to upper camel case (e.g., the <code>findOne</code> handler is associated with the <code>FindOne</code> rpc call definition). This is shown below.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token string">'HeroesService'</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token maybe-class-name">HeroById</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">Metadata</span><span class="token punctuation">,</span> call<span class="token operator">:</span> <span class="token maybe-class-name">ServerUnaryCall</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Hero</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token string">'HeroesService'</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>You can also omit the first <code>@GrpcMethod()</code> argument. In this case, Nest automatically associates the handler with the service definition from the proto definitions file based on the <strong>class</strong> name where the handler is defined. For example, in the following code, class <code>HeroesService</code> associates its handler methods with the <code>HeroesService</code> service definition in the <code>hero.proto</code> file based on the matching of the name <code>'HeroesService'</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesService</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token maybe-class-name">HeroById</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">Metadata</span><span class="token punctuation">,</span> call<span class="token operator">:</span> <span class="token maybe-class-name">ServerUnaryCall</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Hero</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesService</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="client"class="level4"><h4>Client</h4><p>Nest applications can act as gRPC clients, consuming services defined in <code>.proto</code> files. You access remote services through a <code>ClientGrpc</code> object. You can obtain a <code>ClientGrpc</code> object in several ways.<p>The preferred technique is to import the <code>ClientsModule</code>. Use the <code>register()</code> method to bind a package of services defined in a <code>.proto</code> file to an injection token, and to configure the service. The <code>name</code> property is the injection token. For gRPC services, use <code>transport: Transport.GRPC</code>. The <code>options</code> property is an object with the same properties described <a href="microservices/grpc#options">above</a>.<pre class="language-typescript"><code class="language-typescript">imports<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token maybe-class-name">ClientsModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'HERO_PACKAGE'</span><span class="token punctuation">,</span>
      transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">GRPC</span><span class="token punctuation">,</span>
      options<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
        protoPath<span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'hero/hero.proto'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>register()</code> method takes an array of objects. Register multiple packages by providing a comma separated list of registration objects.</blockquote><p>Once registered, we can inject the configured <code>ClientGrpc</code> object with <code>@Inject()</code>. Then we use the <code>ClientGrpc</code> object's <code>getService()</code> method to retrieve the service instance, as shown below.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnModuleInit</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> heroesService<span class="token operator">:</span> <span class="token maybe-class-name">HeroesService</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'HERO_PACKAGE'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> client<span class="token operator">:</span> <span class="token maybe-class-name">ClientGrpc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getService</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HeroesService</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'HeroesService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>error <strong>Warning</strong> gRPC Client will not send fields that contain underscore <code>_</code> in their names unless the <code>keepCase</code> options is set to <code>true</code> in the proto loader configuration (<code>options.loader.keepcase</code> in the microservice transporter configuration).</blockquote><p>Notice that there is a small difference compared to the technique used in other microservice transport methods. Instead of the <code>ClientProxy</code> class, we use the <code>ClientGrpc</code> class, which provides the <code>getService()</code> method. The <code>getService()</code> generic method takes a service name as an argument and returns its instance (if available).<p>Alternatively, you can use the <code>@Client()</code> decorator to instantiate a <code>ClientGrpc</code> object, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnModuleInit</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Client</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">GRPC</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'hero'</span><span class="token punctuation">,</span>
      protoPath<span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'hero/hero.proto'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  client<span class="token operator">:</span> <span class="token maybe-class-name">ClientGrpc</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> heroesService<span class="token operator">:</span> <span class="token maybe-class-name">HeroesService</span><span class="token punctuation">;</span>

  <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getService</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HeroesService</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'HeroesService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getHero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Finally, for more complex scenarios, we can inject a dynamically configured client using the <code>ClientProxyFactory</code> class as described <a href="/microservices/basics#client">here</a>.<p>In either case, we end up with a reference to our <code>HeroesService</code> proxy object, which exposes the same set of methods that are defined inside the <code>.proto</code> file. Now, when we access this proxy object (i.e., <code>heroesService</code>), the gRPC system automatically serializes requests, forwards them to the remote system, returns a response, and deserializes the response. Because gRPC shields us from these network communication details, <code>heroesService</code> looks and acts like a local provider.<p>Note, all service methods are <strong>lower camel cased</strong> (in order to follow the natural convention of the language). So, for example, while our <code>.proto</code> file <code>HeroesService</code> definition contains the <code>FindOne()</code> function, the <code>heroesService</code> instance will provide the <code>findOne()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">HeroesService</span></span> <span class="token punctuation">{</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>A message handler is also able to return an <code>Observable</code>, in which case the result values will be emitted until the stream is completed.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>To send gRPC metadata (along with the request), you can pass a second argument, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Metadata</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  metadata<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token string">'yummy_cookie=choco'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroesService</span><span class="token punctuation">.</span><span class="token method function property-access">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Metadata</code> class is imported from the <code>grpc</code> package.</blockquote><p>Please note that this would require updating the <code>HeroesService</code> interface that we've defined a few steps earlier.</section><section id="example"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/04-grpc">here</a>.</section><section id="grpc-streaming"class="level4"><h4>gRPC Streaming</h4><p>gRPC on its own supports long-term live connections, conventionally known as <code>streams</code>. Streams are useful for cases such as Chatting, Observations or Chunk-data transfers. Find more details in the official documentation <a href="https://grpc.io/docs/guides/concepts/">here</a>.<p>Nest supports GRPC stream handlers in two possible ways:<ul><li>RxJS <code>Subject</code> + <code>Observable</code> handler: can be useful to write responses right inside of a Controller method or to be passed down to <code>Subject</code>/<code>Observable</code> consumer<li>Pure GRPC call stream handler: can be useful to be passed to some executor which will handle the rest of dispatch for the Node standard <code>Duplex</code> stream handler.</ul><p><app-banner-enterprise></app-banner-enterprise></section><section id="streaming-sample"class="level4"><h4>Streaming sample</h4><p>Let's define a new sample gRPC service called <code>HelloService</code>. The <code>hello.proto</code> file is structured using <a href="https://developers.google.com/protocol-buffers">protocol buffers</a>. Here's what it looks like:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// hello/hello.proto</span>
syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

<span class="token keyword">package</span> hello<span class="token punctuation">;</span>

service <span class="token maybe-class-name">HelloService</span> <span class="token punctuation">{</span>
  rpc <span class="token function"><span class="token maybe-class-name">BidiHello</span></span><span class="token punctuation">(</span>stream <span class="token maybe-class-name">HelloRequest</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span>stream <span class="token maybe-class-name">HelloResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rpc <span class="token function"><span class="token maybe-class-name">LotsOfGreetings</span></span><span class="token punctuation">(</span>stream <span class="token maybe-class-name">HelloRequest</span><span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span><span class="token maybe-class-name">HelloResponse</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token maybe-class-name">HelloRequest</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> greeting <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

message <span class="token maybe-class-name">HelloResponse</span> <span class="token punctuation">{</span>
  <span class="token builtin">string</span> reply <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>LotsOfGreetings</code> method can be simply implemented with the <code>@GrpcMethod</code> decorator (as in the examples above) since the returned stream can emit multiple values.</blockquote><p>Based on this <code>.proto</code> file, let's define the <code>HelloService</code> interface:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">HelloService</span></span> <span class="token punctuation">{</span>
  <span class="token function">bidiHello</span><span class="token punctuation">(</span>upstream<span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HelloRequest</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HelloResponse</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token function">lotsOfGreetings</span><span class="token punctuation">(</span>
    upstream<span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HelloRequest</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HelloResponse</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">HelloRequest</span></span> <span class="token punctuation">{</span>
  greeting<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">HelloResponse</span></span> <span class="token punctuation">{</span>
  reply<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The proto interface can be automatically generated by the <a href="https://github.com/stephenh/ts-proto">ts-proto</a> package, learn more <a href="https://github.com/stephenh/ts-proto/blob/main/NESTJS.markdown">here</a>.</blockquote></section><section id="subject-strategy"class="level4"><h4>Subject strategy</h4><p>The <code>@GrpcStreamMethod()</code> decorator provides the function parameter as an RxJS <code>Observable</code>. Thus, we can receive and process multiple messages.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcStreamMethod</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">bidiHello</span><span class="token punctuation">(</span>messages<span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">Metadata</span><span class="token punctuation">,</span> call<span class="token operator">:</span> <span class="token maybe-class-name">ServerDuplexStream</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> subject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Subject</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onNext</span> <span class="token operator">=</span> message <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    subject<span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      reply<span class="token operator">:</span> <span class="token string">'Hello, world!'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">onComplete</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> subject<span class="token punctuation">.</span><span class="token method function property-access">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  messages<span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    next<span class="token operator">:</span> onNext<span class="token punctuation">,</span>
    complete<span class="token operator">:</span> onComplete<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword control-flow">return</span> subject<span class="token punctuation">.</span><span class="token method function property-access">asObservable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Warning</strong> For supporting full-duplex interaction with the <code>@GrpcStreamMethod()</code> decorator, the controller method must return an RxJS <code>Observable</code>.</blockquote><blockquote><p>info <strong>Hint</strong> The <code>Metadata</code> and <code>ServerUnaryCall</code> classes/interfaces are imported from the <code>grpc</code> package.</blockquote><p>According to the service definition (in the <code>.proto</code> file), the <code>BidiHello</code> method should stream requests to the service. To send multiple asynchronous messages to the stream from a client, we leverage an RxJS <code>ReplaySubject</code> class.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> helloService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getService</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HelloService</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'HelloService'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> helloRequest$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ReplaySubject</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HelloRequest</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

helloRequest$<span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> greeting<span class="token operator">:</span> <span class="token string">'Hello (1)!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
helloRequest$<span class="token punctuation">.</span><span class="token method function property-access">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> greeting<span class="token operator">:</span> <span class="token string">'Hello (2)!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
helloRequest$<span class="token punctuation">.</span><span class="token method function property-access">complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword control-flow">return</span> helloService<span class="token punctuation">.</span><span class="token method function property-access">bidiHello</span><span class="token punctuation">(</span>helloRequest$<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In the example above, we wrote two messages to the stream (<code>next()</code> calls) and notified the service that we've completed sending the data (<code>complete()</code> call).</section><section id="call-stream-handler"class="level4"><h4>Call stream handler</h4><p>When the method return value is defined as <code>stream</code>, the <code>@GrpcStreamCall()</code> decorator provides the function parameter as <code>grpc.ServerDuplexStream</code>, which supports standard methods like <code>.on('data', callback)</code>, <code>.write(message)</code> or <code>.cancel()</code>. Full documentation on available methods can be found <a href="https://grpc.github.io/grpc/node/grpc-ClientDuplexStream.html">here</a>.<p>Alternatively, when the method return value is not a <code>stream</code>, the <code>@GrpcStreamCall()</code> decorator provides two function parameters, respectively <code>grpc.ServerReadableStream</code> (read more <a href="https://grpc.github.io/grpc/node/grpc-ServerReadableStream.html">here</a>) and <code>callback</code>.<p>Let's start with implementing the <code>BidiHello</code> which should support a full-duplex interaction.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcStreamCall</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">bidiHello</span><span class="token punctuation">(</span>requestStream<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  requestStream<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> message <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    requestStream<span class="token punctuation">.</span><span class="token method function property-access">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      reply<span class="token operator">:</span> <span class="token string">'Hello, world!'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> This decorator does not require any specific return parameter to be provided. It is expected that the stream will be handled similar to any other standard stream type.</blockquote><p>In the example above, we used the <code>write()</code> method to write objects to the response stream. The callback passed into the <code>.on()</code> method as a second parameter will be called every time our service receives a new chunk of data.<p>Let's implement the <code>LotsOfGreetings</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcStreamCall</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">lotsOfGreetings</span><span class="token punctuation">(</span>requestStream<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token function-variable function">callback</span><span class="token operator">:</span> <span class="token punctuation">(</span>err<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token maybe-class-name">HelloResponse</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  requestStream<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> message <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  requestStream<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword null nil">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> reply<span class="token operator">:</span> <span class="token string">'Hello, world!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Here we used the <code>callback</code> function to send the response once processing of the <code>requestStream</code> has been completed.</section><section id="grpc-metadata"class="level4"><h4>gRPC Metadata</h4><p>Metadata is information about a particular RPC call in the form of a list of key-value pairs, where the keys are strings and the values are typically strings but can be binary data. Metadata is opaque to gRPC itself - it lets the client provide information associated with the call to the server and vice versa. Metadata may include authentication tokens, request identifiers and tags for monitoring purposes, and data information such as the number of records in a data set.<p>To read the metadata in <code>@GrpcMethod()</code> handler, use the second argument (metadata), which is of type <code>Metadata</code> (imported from the <code>grpc</code> package).<p>To send back metadata from the handler, use the <code>ServerUnaryCall#sendMetadata()</code> method (third handler argument).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesService</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token maybe-class-name">HeroById</span><span class="token punctuation">,</span> metadata<span class="token operator">:</span> <span class="token maybe-class-name">Metadata</span><span class="token punctuation">,</span> call<span class="token operator">:</span> <span class="token maybe-class-name">ServerUnaryCall</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Hero</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> serverMetadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Metadata</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    serverMetadata<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token string">'yummy_cookie=choco'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    call<span class="token punctuation">.</span><span class="token method function property-access">sendMetadata</span><span class="token punctuation">(</span>serverMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesService</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findOne</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> call<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> serverMetadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Metadata</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'John'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Doe'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    serverMetadata<span class="token punctuation">.</span><span class="token method function property-access">add</span><span class="token punctuation">(</span><span class="token string">'Set-Cookie'</span><span class="token punctuation">,</span> <span class="token string">'yummy_cookie=choco'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    call<span class="token punctuation">.</span><span class="token method function property-access">sendMetadata</span><span class="token punctuation">(</span>serverMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> items<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> id <span class="token operator">===</span> data<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Likewise, to read the metadata in handlers annotated with the <code>@GrpcStreamMethod()</code> handler (<a href="microservices/grpc#subject-strategy">subject strategy</a>), use the second argument (metadata), which is of type <code>Metadata</code> (imported from the <code>grpc</code> package).<p>To send back metadata from the handler, use the <code>ServerDuplexStream#sendMetadata()</code> method (third handler argument).<p>To read metadata from within the <a href="microservices/grpc#call-stream-handler">call stream handlers</a> (handlers annotated with <code>@GrpcStreamCall()</code> decorator), listen to the <code>metadata</code> event on the <code>requestStream</code> reference, as follows:<pre class="language-typescript"><code class="language-typescript">requestStream<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'metadata'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>metadata<span class="token operator">:</span> <span class="token maybe-class-name">Metadata</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> meta <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'X-Meta'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>