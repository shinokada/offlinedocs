<!doctype html><html lang="en"><meta charset="utf-8"><title>RabbitMQ</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="rabbitmq"class="level3"><h3>RabbitMQ</h3><p><a href="https://www.rabbitmq.com/">RabbitMQ</a> is an open-source and lightweight message broker which supports multiple messaging protocols. It can be deployed in distributed and federated configurations to meet high-scale, high-availability requirements. In addition, it's the most widely deployed message broker, used worldwide at small startups and large enterprises.<section id="installation"class="level4"><h4>Installation</h4><p>To start building RabbitMQ-based microservices, first install the required packages:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save amqplib amqp-connection-manager</code></pre></section><section id="overview"class="level4"><h4>Overview</h4><p>To use the RabbitMQ transporter, pass the following options object to the <code>createMicroservice()</code> method:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">RMQ</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    urls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'amqp://localhost:5672'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token string">'cats_queue'</span><span class="token punctuation">,</span>
    queueOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      durable<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createMicroservice</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">RMQ</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    urls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'amqp://localhost:5672'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token string">'cats_queue'</span><span class="token punctuation">,</span>
    queueOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
      durable<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Transport</code> enum is imported from the <code>@nestjs/microservices</code> package.</blockquote></section><section id="options"class="level4"><h4>Options</h4><p>The <code>options</code> property is specific to the chosen transporter. The <strong>RabbitMQ</strong> transporter exposes the properties described below.<table><tr><td><code>urls</code><td>Connection urls<tr><td><code>queue</code><td>Queue name which your server will listen to<tr><td><code>prefetchCount</code><td>Sets the prefetch count for the channel<tr><td><code>isGlobalPrefetchCount</code><td>Enables per channel prefetching<tr><td><code>noAck</code><td>If <code>false</code>, manual acknowledgment mode enabled<tr><td><code>queueOptions</code><td>Additional queue options (read more <a href="https://www.squaremobius.net/amqp.node/channel_api.html#channel_assertQueue"rel="nofollow"target="_blank">here</a>)<tr><td><code>socketOptions</code><td>Additional socket options (read more <a href="https://www.squaremobius.net/amqp.node/channel_api.html#socket-options"rel="nofollow"target="_blank">here</a>)<tr><td><code>headers</code><td>Headers to be sent along with every message</table></section><section id="client"class="level4"><h4>Client</h4><p>Like other microservice transporters, you have <a href="https://docs.nestjs.com/microservices/basics#client">several options</a> for creating a RabbitMQ <code>ClientProxy</code> instance.<p>One method for creating an instance is to use the <code>ClientsModule</code>. To create a client instance with the <code>ClientsModule</code>, import it and use the <code>register()</code> method to pass an options object with the same properties shown above in the <code>createMicroservice()</code> method, as well as a <code>name</code> property to be used as the injection token. Read more about <code>ClientsModule</code> <a href="https://docs.nestjs.com/microservices/basics#client">here</a>.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ClientsModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'MATH_SERVICE'</span><span class="token punctuation">,</span>
        transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">RMQ</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          urls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'amqp://localhost:5672'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          queue<span class="token operator">:</span> <span class="token string">'cats_queue'</span><span class="token punctuation">,</span>
          queueOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
            durable<span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Other options to create a client (either <code>ClientProxyFactory</code> or <code>@Client()</code>) can be used as well. You can read about them <a href="https://docs.nestjs.com/microservices/basics#client">here</a>.</section><section id="context"class="level4"><h4>Context</h4><p>In more sophisticated scenarios, you may want to access more information about the incoming request. When using the RabbitMQ transporter, you can access the <code>RmqContext</code> object.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">RmqContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pattern: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getPattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Pattern: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getPattern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>@Payload()</code>, <code>@Ctx()</code> and <code>RmqContext</code> are imported from the <code>@nestjs/microservices</code> package.</blockquote><p>To access the original RabbitMQ message (with the <code>properties</code>, <code>fields</code>, and <code>content</code>), use the <code>getMessage()</code> method of the <code>RmqContext</code> object, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">RmqContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>To retrieve a reference to the RabbitMQ <a href="https://www.rabbitmq.com/channels.html">channel</a>, use the <code>getChannelRef</code> method of the <code>RmqContext</code> object, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">RmqContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token method function property-access">getChannelRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token method function property-access">getChannelRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="message-acknowledgement"class="level4"><h4>Message acknowledgement</h4><p>To make sure a message is never lost, RabbitMQ supports <a href="https://www.rabbitmq.com/confirms.html">message acknowledgements</a>. An acknowledgement is sent back by the consumer to tell RabbitMQ that a particular message has been received, processed and that RabbitMQ is free to delete it. If a consumer dies (its channel is closed, connection is closed, or TCP connection is lost) without sending an ack, RabbitMQ will understand that a message wasn't processed fully and will re-queue it.<p>To enable manual acknowledgment mode, set the <code>noAck</code> property to <code>false</code>:<pre class="language-typescript"><code class="language-typescript">options<span class="token operator">:</span> <span class="token punctuation">{</span>
  urls<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'amqp://localhost:5672'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  queue<span class="token operator">:</span> <span class="token string">'cats_queue'</span><span class="token punctuation">,</span>
  noAck<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  queueOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
    durable<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre><p>When manual consumer acknowledgements are turned on, we must send a proper acknowledgement from the worker to signal that we are done with a task.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">RmqContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> channel <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getChannelRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> originalMsg <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  channel<span class="token punctuation">.</span><span class="token method function property-access">ack</span><span class="token punctuation">(</span>originalMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> channel <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getChannelRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> originalMsg <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  channel<span class="token punctuation">.</span><span class="token method function property-access">ack</span><span class="token punctuation">(</span>originalMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="record-builders"class="level4"><h4>Record builders</h4><p>To configure message options, you can use the <code>RmqRecordBuilder</code> class (note: this is doable for event-based flows as well). For example, to set <code>headers</code> and <code>priority</code> properties, use the <code>setOptions</code> method, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token string">':cat:'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RmqRecordBuilder</span></span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    headers<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span><span class="token string">'x-version'</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    priority<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token string">'replace-emoji'</span><span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>RmqRecordBuilder</code> class is exported from the <code>@nestjs/microservices</code> package.</blockquote><p>And you can read these values on the server-side as well, by accessing the <code>RmqContext</code>, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'replace-emoji'</span><span class="token punctuation">)</span>
<span class="token function">replaceEmoji</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">RmqContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> properties<span class="token operator">:</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> headers<span class="token punctuation">[</span><span class="token string">'x-version'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'1.0.0'</span> <span class="token operator">?</span> <span class="token string">'🐱'</span> <span class="token operator">:</span> <span class="token string">'🐈'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'replace-emoji'</span><span class="token punctuation">)</span>
<span class="token function">replaceEmoji</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> properties<span class="token operator">:</span> <span class="token punctuation">{</span> headers <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> headers<span class="token punctuation">[</span><span class="token string">'x-version'</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">'1.0.0'</span> <span class="token operator">?</span> <span class="token string">'🐱'</span> <span class="token operator">:</span> <span class="token string">'🐈'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>