<!doctype html><html lang="en"><meta charset="utf-8"><title>Overview</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="overview"class="level3"><h3>Overview</h3><p>In addition to traditional (sometimes called monolithic) application architectures, Nest natively supports the microservice architectural style of development. Most of the concepts discussed elsewhere in this documentation, such as dependency injection, decorators, exception filters, pipes, guards and interceptors, apply equally to microservices. Wherever possible, Nest abstracts implementation details so that the same components can run across HTTP-based platforms, WebSockets, and Microservices. This section covers the aspects of Nest that are specific to microservices.<p>In Nest, a microservice is fundamentally an application that uses a different <strong>transport</strong> layer than HTTP.<figure><img src="/Users/shinichiokada/Bash_Projects/markdown-docs-as-pdf/.vivliostyle/nestjs/en/src/assets/Microservices_1.png"></figure><p>Nest supports several built-in transport layer implementations, called <strong>transporters</strong>, which are responsible for transmitting messages between different microservice instances. Most transporters natively support both <strong>request-response</strong> and <strong>event-based</strong> message styles. Nest abstracts the implementation details of each transporter behind a canonical interface for both request-response and event-based messaging. This makes it easy to switch from one transport layer to another -- for example to leverage the specific reliability or performance features of a particular transport layer -- without impacting your application code.<section id="installation"class="level4"><h4>Installation</h4><p>To start building microservices, first install the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save @nestjs/microservices</code></pre></section><section id="getting-started"class="level4"><h4>Getting started</h4><p>To instantiate a microservice, use the <code>createMicroservice()</code> method of the <code>NestFactory</code> class:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MicroserviceOptions</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MicroserviceOptions</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createMicroservice</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Microservices use the <strong>TCP</strong> transport layer by default.</blockquote><p>The second argument of the <code>createMicroservice()</code> method is an <code>options</code> object. This object may consist of two members:<table><tr><td><code>transport</code><td>Specifies the transporter (for example, <code>Transport.NATS</code>)<tr><td><code>options</code><td>A transporter-specific options object that determines transporter behavior</table><p>The <code>options</code> object is specific to the chosen transporter. The <strong>TCP</strong> transporter exposes the properties described below. For other transporters (e.g, Redis, MQTT, etc.), see the relevant chapter for a description of the available options.<table><tr><td><code>host</code><td>Connection hostname<tr><td><code>port</code><td>Connection port<tr><td><code>retryAttempts</code><td>Number of times to retry message (default: <code>0</code>)<tr><td><code>retryDelay</code><td>Delay between message retry attempts (ms) (default: <code>0</code>)</table></section><section id="patterns"class="level4"><h4>Patterns</h4><p>Microservices recognize both messages and events by <strong>patterns</strong>. A pattern is a plain value, for example, a literal object or a string. Patterns are automatically serialized and sent over the network along with the data portion of a message. In this way, message senders and consumers can coordinate which requests are consumed by which handlers.</section><section id="request-response"class="level4"><h4>Request-response</h4><p>The request-response message style is useful when you need to <strong>exchange</strong> messages between various external services. With this paradigm, you can be certain that the service has actually received the message (without the need to manually implement a message ACK protocol). However, the request-response paradigm is not always the best choice. For example, streaming transporters that use log-based persistence, such as <a href="https://docs.confluent.io/3.0.0/streams/">Kafka</a> or <a href="https://github.com/nats-io/node-nats-streaming">NATS streaming</a>, are optimized for solving a different range of issues, more aligned with an event messaging paradigm (see <a href="https://docs.nestjs.com/microservices/basics#event-based">event-based messaging</a> below for more details).<p>To enable the request-response message type, Nest creates two logical channels - one is responsible for transferring the data while the other waits for incoming responses. For some underlying transports, such as <a href="https://nats.io/">NATS</a>, this dual-channel support is provided out-of-the-box. For others, Nest compensates by manually creating separate channels. There can be overhead for this, so if you do not require a request-response message style, you should consider using the event-based method.<p>To create a message handler based on the request-response paradigm use the <code>@MessagePattern()</code> decorator, which is imported from the <code>@nestjs/microservices</code> package. This decorator should be used only within the <a href="https://docs.nestjs.com/controllers">controller</a> classes since they are the entry points for your application. Using them inside providers won't have any effect as they are simply ignored by Nest runtime.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>math<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MessagePattern</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MathController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Controller</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MessagePattern</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MathController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In the above code, the <code>accumulate()</code> <strong>message handler</strong> listens for messages that fulfill the <code>{{ '{' }} cmd: 'sum' {{ '}' }}</code> message pattern. The message handler takes a single argument, the <code>data</code> passed from the client. In this case, the data is an array of numbers which are to be accumulated.</section><section id="asynchronous-responses"class="level4"><h4>Asynchronous responses</h4><p>Message handlers are able to respond either synchronously or <strong>asynchronously</strong>. Hence, <code>async</code> methods are supported.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>A message handler is also able to return an <code>Observable</code>, in which case the result values will be emitted until the stream is completed.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword module">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword module">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>In the example above, the message handler will respond <strong>3 times</strong> (with each item from the array).</section><section id="event-based"class="level4"><h4>Event-based</h4><p>While the request-response method is ideal for exchanging messages between services, it is less suitable when your message style is event-based - when you just want to publish <strong>events</strong> without waiting for a response. In that case, you do not want the overhead required by request-response for maintaining two channels.<p>Suppose you would like to simply notify another service that a certain condition has occurred in this part of the system. This is the ideal use case for the event-based message style.<p>To create an event handler, we use the <code>@EventPattern()</code> decorator, which is imported from the <code>@nestjs/microservices</code> package.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">EventPattern</span></span><span class="token punctuation">(</span><span class="token string">'user_created'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">handleUserCreated</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">unknown</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// business logic</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">EventPattern</span></span><span class="token punctuation">(</span><span class="token string">'user_created'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">handleUserCreated</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// business logic</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> You can register multiple event handlers for a <strong>single</strong> event pattern and all of them will be automatically triggered in parallel.</blockquote><p>The <code>handleUserCreated()</code> <strong>event handler</strong> listens for the <code>'user_created'</code> event. The event handler takes a single argument, the <code>data</code> passed from the client (in this case, an event payload which has been sent over the network).<p><app-banner-enterprise></app-banner-enterprise></section><section id="decorators"class="level4"><h4>Decorators</h4><p>In more sophisticated scenarios, you may want to access more information about the incoming request. For example, in the case of NATS with wildcard subscriptions, you may want to get the original subject that the producer has sent the message to. Likewise, in Kafka you may want to access the message headers. In order to accomplish that, you can use built-in decorators as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'time.us.*'</span><span class="token punctuation">)</span>
<span class="token function">getDate</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">NatsContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subject: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. "time.us.east"</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'time.us.*'</span><span class="token punctuation">)</span>
<span class="token function">getDate</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subject: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getSubject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. "time.us.east"</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token known-class-name class-name">Date</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>@Payload()</code>, <code>@Ctx()</code> and <code>NatsContext</code> are imported from <code>@nestjs/microservices</code>.</blockquote><blockquote><p>info <strong>Hint</strong> You can also pass in a property key to the <code>@Payload()</code> decorator to extract a specific property from the incoming payload object, for example, <code>@Payload('id')</code>.</blockquote></section><section id="client"class="level4"><h4>Client</h4><p>A client Nest application can exchange messages or publish events to a Nest microservice using the <code>ClientProxy</code> class. This class defines several methods, such as <code>send()</code> (for request-response messaging) and <code>emit()</code> (for event-driven messaging) that let you communicate with a remote microservice. Obtain an instance of this class in one of the following ways.<p>One technique is to import the <code>ClientsModule</code>, which exposes the static <code>register()</code> method. This method takes an argument which is an array of objects representing microservice transporters. Each such object has a <code>name</code> property, an optional <code>transport</code> property (default is <code>Transport.TCP</code>), and an optional transporter-specific <code>options</code> property.<p>The <code>name</code> property serves as an <strong>injection token</strong> that can be used to inject an instance of a <code>ClientProxy</code> where needed. The value of the <code>name</code> property, as an injection token, can be an arbitrary string or JavaScript symbol, as described <a href="https://docs.nestjs.com/fundamentals/custom-providers#non-class-based-provider-tokens">here</a>.<p>The <code>options</code> property is an object with the same properties we saw in the <code>createMicroservice()</code> method earlier.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ClientsModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'MATH_SERVICE'</span><span class="token punctuation">,</span> transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Once the module has been imported, we can inject an instance of the <code>ClientProxy</code> configured as specified via the <code>'MATH_SERVICE'</code> transporter options shown above, using the <code>@Inject()</code> decorator.<pre class="language-typescript"><code class="language-typescript"><span class="token function">constructor</span><span class="token punctuation">(</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'MATH_SERVICE'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> client<span class="token operator">:</span> <span class="token maybe-class-name">ClientProxy</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>ClientsModule</code> and <code>ClientProxy</code> classes are imported from the <code>@nestjs/microservices</code> package.</blockquote><p>At times we may need to fetch the transporter configuration from another service (say a <code>ConfigService</code>), rather than hard-coding it in our client application. To do this, we can register a <a href="/fundamentals/custom-providers">custom provider</a> using the <code>ClientProxyFactory</code> class. This class has a static <code>create()</code> method, which accepts a transporter options object, and returns a customized <code>ClientProxy</code> instance.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token string">'MATH_SERVICE'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mathSvcOptions <span class="token operator">=</span> configService<span class="token punctuation">.</span><span class="token method function property-access">getMathSvcOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">return</span> <span class="token maybe-class-name">ClientProxyFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>mathSvcOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>ClientProxyFactory</code> is imported from the <code>@nestjs/microservices</code> package.</blockquote><p>Another option is to use the <code>@Client()</code> property decorator.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Client</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">TCP</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
client<span class="token operator">:</span> <span class="token maybe-class-name">ClientProxy</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@Client()</code> decorator is imported from the <code>@nestjs/microservices</code> package.</blockquote><p>Using the <code>@Client()</code> decorator is not the preferred technique, as it is harder to test and harder to share a client instance.<p>The <code>ClientProxy</code> is <strong>lazy</strong>. It doesn't initiate a connection immediately. Instead, it will be established before the first microservice call, and then reused across each subsequent call. However, if you want to delay the application bootstrapping process until a connection is established, you can manually initiate a connection using the <code>ClientProxy</code> object's <code>connect()</code> method inside the <code>OnApplicationBootstrap</code> lifecycle hook.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">onApplicationBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>If the connection cannot be created, the <code>connect()</code> method will reject with the corresponding error object.</section><section id="sending-messages"class="level4"><h4>Sending messages</h4><p>The <code>ClientProxy</code> exposes a <code>send()</code> method. This method is intended to call the microservice and returns an <code>Observable</code> with its response. Thus, we can subscribe to the emitted values easily.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">accumulate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">send</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token function">accumulate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pattern <span class="token operator">=</span> <span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>send()</code> method takes two arguments, <code>pattern</code> and <code>payload</code>. The <code>pattern</code> should match one defined in a <code>@MessagePattern()</code> decorator. The <code>payload</code> is a message that we want to transmit to the remote microservice. This method returns a <strong>cold <code>Observable</code></strong>, which means that you have to explicitly subscribe to it before the message will be sent.</section><section id="publishing-events"class="level4"><h4>Publishing events</h4><p>To send an event, use the <code>ClientProxy</code> object's <code>emit()</code> method. This method publishes an event to the message broker.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">emit</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">number</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'user_created'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">UserCreatedEvent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">async</span> <span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span><span class="token punctuation">.</span><span class="token method function property-access">emit</span><span class="token punctuation">(</span><span class="token string">'user_created'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">UserCreatedEvent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>emit()</code> method takes two arguments, <code>pattern</code> and <code>payload</code>. The <code>pattern</code>should match one defined in an <code>@EventPattern()</code> decorator. The <code>payload</code> is an event payload that we want to transmit to the remote microservice. This method returns a <strong>hot <code>Observable</code></strong> (unlike the cold <code>Observable</code> returned by <code>send()</code>), which means that whether or not you explicitly subscribe to the observable, the proxy will immediately try to deliver the event.<p><app-banner-shop></app-banner-shop></section><section id="scopes"class="level4"><h4>Scopes</h4><p>For people coming from different programming language backgrounds, it might be unexpected to learn that in Nest, almost everything is shared across incoming requests. We have a connection pool to the database, singleton services with global state, etc. Remember that Node.js doesn't follow the request/response Multi-Threaded Stateless Model in which every request is processed by a separate thread. Hence, using singleton instances is fully <strong>safe</strong> for our applications.<p>However, there are edge-cases when request-based lifetime of the handler may be the desired behavior, for instance per-request caching in GraphQL applications, request tracking or multi-tenancy. Learn how to control scopes <a href="/fundamentals/injection-scopes">here</a>.<p>Request-scoped handlers and providers can inject <code>RequestContext</code> using the <code>@Inject()</code> decorator in combination with <code>CONTEXT</code> token:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Scope</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Inject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token constant">CONTEXT</span><span class="token punctuation">,</span> <span class="token maybe-class-name">RequestContext</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> scope<span class="token operator">:</span> <span class="token maybe-class-name">Scope</span><span class="token punctuation">.</span><span class="token constant">REQUEST</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token constant">CONTEXT</span><span class="token punctuation">)</span> <span class="token keyword">private</span> ctx<span class="token operator">:</span> <span class="token maybe-class-name">RequestContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>This provides access to the <code>RequestContext</code> object, which has two properties:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">RequestContext</span><span class="token operator">&#x3C;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  pattern<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span>
  data<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>data</code> property is the message payload sent by the message producer. The <code>pattern</code> property is the pattern used to identify an appropriate handler to handle the incoming message.</section><section id="handling-timeouts"class="level4"><h4>Handling timeouts</h4><p>In distributed systems, sometimes microservices might be down or not available. To avoid infinitely long waiting, you can use Timeouts. A timeout is an incredibly useful pattern when communicating with other services. To apply timeouts to your microservice calls, you can use the <a href="https://rxjs.dev">RxJS</a> <code>timeout</code> operator. If the microservice does not respond to the request within a certain time, an exception is thrown, which can be caught and handled appropriately.<p>To solve this problem you have to use <a href="https://github.com/ReactiveX/rxjs"><code>rxjs</code></a> package. Just use the <code>timeout</code> operator in the pipe:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span>
      <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">send</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">TResult</span><span class="token punctuation">,</span> <span class="token maybe-class-name">TInput</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">client</span>
      <span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> data<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>timeout</code> operator is imported from the <code>rxjs/operators</code> package.</blockquote><p>After 5 seconds, if the microservice isn't responding, it will throw an error. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>