<!doctype html><html lang="en"><meta charset="utf-8"><title>Exception filters</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="exception-filters"class="level3"><h3>Exception filters</h3><p>The only difference between the HTTP <a href="/exception-filters">exception filter</a> layer and the corresponding microservices layer is that instead of throwing <code>HttpException</code>, you should use <code>RpcException</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RpcException</span></span><span class="token punctuation">(</span><span class="token string">'Invalid credentials.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>RpcException</code> class is imported from the <code>@nestjs/microservices</code> package.</blockquote><p>With the sample above, Nest will handle the thrown exception and return the <code>error</code> object with the following structure:<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span>
  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"Invalid credentials."</span>
<span class="token punctuation">}</span></code></pre><section id="filters"class="level4"><h4>Filters</h4><p>Microservice exception filters behave similarly to HTTP exception filters, with one small difference. The <code>catch()</code> method must return an <code>Observable</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>rpc<span class="token operator">-</span>exception<span class="token punctuation">.</span><span class="token property-access">filter</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Catch</span><span class="token punctuation">,</span> <span class="token maybe-class-name">RpcExceptionFilter</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ArgumentsHost</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Observable</span><span class="token punctuation">,</span> throwError <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">RpcException</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Catch</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">RpcException</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ExceptionFilter</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">RpcExceptionFilter</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">RpcException</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token operator">:</span> <span class="token maybe-class-name">RpcException</span><span class="token punctuation">,</span> host<span class="token operator">:</span> <span class="token maybe-class-name">ArgumentsHost</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">throwError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> exception<span class="token punctuation">.</span><span class="token method function property-access">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Catch</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> throwError <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Catch</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">RpcException</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ExceptionFilter</span></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">throwError</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> exception<span class="token punctuation">.</span><span class="token method function property-access">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Warning</strong> Global microservice exception filters aren't enabled by default when using a <a href="/faq/hybrid-application">hybrid application</a>.</blockquote><p>The following example uses a manually instantiated method-scoped filter. Just as with HTTP based applications, you can also use controller-scoped filters (i.e., prefix the controller class with a <code>@UseFilters()</code> decorator).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseFilters</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ExceptionFilter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseFilters</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ExceptionFilter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> cmd<span class="token operator">:</span> <span class="token string">'sum'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">accumulate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">(</span>data <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token arrow operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="inheritance"class="level4"><h4>Inheritance</h4><p>Typically, you'll create fully customized exception filters crafted to fulfill your application requirements. However, there might be use-cases when you would like to simply extend the <strong>core exception filter</strong>, and override the behavior based on certain factors.<p>In order to delegate exception processing to the base filter, you need to extend <code>BaseExceptionFilter</code> and call the inherited <code>catch()</code> method.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Catch</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ArgumentsHost</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">BaseRpcExceptionFilter</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Catch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AllExceptionsFilter</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">BaseRpcExceptionFilter</span></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> host<span class="token operator">:</span> <span class="token maybe-class-name">ArgumentsHost</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Catch</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">BaseRpcExceptionFilter</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Catch</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AllExceptionsFilter</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">BaseRpcExceptionFilter</span></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> host<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword control-flow">catch</span><span class="token punctuation">(</span>exception<span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The above implementation is just a shell demonstrating the approach. Your implementation of the extended exception filter would include your tailored <strong>business logic</strong> (e.g., handling various conditions). <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>