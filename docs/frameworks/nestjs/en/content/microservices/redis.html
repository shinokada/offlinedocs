<!doctype html><html lang="en"><meta charset="utf-8"><title>Redis</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="redis"class="level3"><h3>Redis</h3><p>The <a href="https://redis.io/">Redis</a> transporter implements the publish/subscribe messaging paradigm and leverages the <a href="https://redis.io/topics/pubsub">Pub/Sub</a> feature of Redis. Published messages are categorized in channels, without knowing what subscribers (if any) will eventually receive the message. Each microservice can subscribe to any number of channels. In addition, more than one channel can be subscribed to at a time. Messages exchanged through channels are <strong>fire-and-forget</strong>, which means that if a message is published and there are no subscribers interested in it, the message is removed and cannot be recovered. Thus, you don't have a guarantee that either messages or events will be handled by at least one service. A single message can be subscribed to (and received) by multiple subscribers.<figure><img src="/Users/shinichiokada/Bash_Projects/markdown-docs-as-pdf/.vivliostyle/nestjs/en/src/assets/Redis_1.png"></figure><section id="installation"class="level4"><h4>Installation</h4><p>To start building Redis-based microservices, first install the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save ioredis</code></pre></section><section id="overview"class="level4"><h4>Overview</h4><p>To use the Redis transporter, pass the following options object to the <code>createMicroservice()</code> method:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createMicroservice</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">MicroserviceOptions</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">REDIS</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createMicroservice</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">REDIS</span><span class="token punctuation">,</span>
  options<span class="token operator">:</span> <span class="token punctuation">{</span>
    host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Transport</code> enum is imported from the <code>@nestjs/microservices</code> package.</blockquote></section><section id="options"class="level4"><h4>Options</h4><p>The <code>options</code> property is specific to the chosen transporter. The <strong>Redis</strong> transporter exposes the properties described below.<table><tr><td><code>host</code><td>Connection url<tr><td><code>port</code><td>Connection port<tr><td><code>retryAttempts</code><td>Number of times to retry message (default: <code>0</code>)<tr><td><code>retryDelay</code><td>Delay between message retry attempts (ms) (default: <code>0</code>)</table><p>All the properties supported by the official <a href="https://luin.github.io/ioredis/index.html#RedisOptions">ioredis</a> client are also supported by this transporter.</section><section id="client"class="level4"><h4>Client</h4><p>Like other microservice transporters, you have <a href="https://docs.nestjs.com/microservices/basics#client">several options</a> for creating a Redis <code>ClientProxy</code> instance.<p>One method for creating an instance is to use the <code>ClientsModule</code>. To create a client instance with the <code>ClientsModule</code>, import it and use the <code>register()</code> method to pass an options object with the same properties shown above in the <code>createMicroservice()</code> method, as well as a <code>name</code> property to be used as the injection token. Read more about <code>ClientsModule</code> <a href="https://docs.nestjs.com/microservices/basics#client">here</a>.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ClientsModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token string">'MATH_SERVICE'</span><span class="token punctuation">,</span>
        transport<span class="token operator">:</span> <span class="token maybe-class-name">Transport</span><span class="token punctuation">.</span><span class="token constant">REDIS</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
          host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
          port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Other options to create a client (either <code>ClientProxyFactory</code> or <code>@Client()</code>) can be used as well. You can read about them <a href="https://docs.nestjs.com/microservices/basics#client">here</a>.</section><section id="context"class="level4"><h4>Context</h4><p>In more sophisticated scenarios, you may want to access more information about the incoming request. When using the Redis transporter, you can access the <code>RedisContext</code> object.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> data<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token decorator"><span class="token at operator">@</span><span class="token function">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> context<span class="token operator">:</span> <span class="token maybe-class-name">RedisContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Channel: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Payload</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function"><span class="token maybe-class-name">Ctx</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'notifications'</span><span class="token punctuation">)</span>
<span class="token function">getNotifications</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Channel: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>context<span class="token punctuation">.</span><span class="token method function property-access">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> <code>@Payload()</code>, <code>@Ctx()</code> and <code>RedisContext</code> are imported from the <code>@nestjs/microservices</code> package. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>