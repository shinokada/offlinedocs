<!doctype html><html lang="en"><meta charset="utf-8"><title>Adapters</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="adapters"class="level3"><h3>Adapters</h3><p>The WebSockets module is platform-agnostic, hence, you can bring your own library (or even a native implementation) by making use of <code>WebSocketAdapter</code> interface. This interface forces to implement few methods described in the following table:<table><tr><td><code>create</code><td>Creates a socket instance based on passed arguments<tr><td><code>bindClientConnect</code><td>Binds the client connection event<tr><td><code>bindClientDisconnect</code><td>Binds the client disconnection event (optional*)<tr><td><code>bindMessageHandlers</code><td>Binds the incoming message to the corresponding message handler<tr><td><code>close</code><td>Terminates a server instance</table><section id="extend-socketio"class="level4"><h4>Extend socket.io</h4><p>The <a href="https://github.com/socketio/socket.io">socket.io</a> package is wrapped in an <code>IoAdapter</code> class. What if you would like to enhance the basic functionality of the adapter? For instance, your technical requirements require a capability to broadcast events across multiple load-balanced instances of your web service. For this, you can extend <code>IoAdapter</code> and override a single method which responsibility is to instantiate new socket.io servers. But first of all, let's install the required package.<blockquote><p>warning <strong>Warning</strong> To use socket.io with multiple load-balanced instances you either have to disable polling by setting <code>transports: ['websocket']</code> in your clients socket.io configuration or you have to enable cookie based routing in your load balancer. Redis alone is not enough. See <a href="https://socket.io/docs/v4/using-multiple-nodes/#enabling-sticky-session">here</a> for more information.</blockquote><pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save redis socket.io @socket.io/redis-adapter</code></pre><p>Once the package is installed, we can create a <code>RedisIoAdapter</code> class.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">IoAdapter</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/platform-socket.io'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ServerOptions</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'socket.io'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createAdapter <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@socket.io/redis-adapter'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> createClient <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'redis'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">RedisIoAdapter</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">IoAdapter</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> adapterConstructor<span class="token operator">:</span> <span class="token maybe-class-name">ReturnType</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> createAdapter<span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token keyword">async</span> <span class="token function">connectToRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> pubClient <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">redis://localhost:6379</span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> subClient <span class="token operator">=</span> pubClient<span class="token punctuation">.</span><span class="token method function property-access">duplicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>pubClient<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subClient<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">adapterConstructor</span> <span class="token operator">=</span> <span class="token function">createAdapter</span><span class="token punctuation">(</span>pubClient<span class="token punctuation">,</span> subClient<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">createIOServer</span><span class="token punctuation">(</span>port<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> options<span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">ServerOptions</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">createIOServer</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token method function property-access">adapter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">adapterConstructor</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> server<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Afterward, simply switch to your newly created Redis adapter.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> redisIoAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">RedisIoAdapter</span></span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">await</span> redisIoAdapter<span class="token punctuation">.</span><span class="token method function property-access">connectToRedis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">useWebSocketAdapter</span><span class="token punctuation">(</span>redisIoAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="ws-library"class="level4"><h4>Ws library</h4><p>Another available adapter is a <code>WsAdapter</code> which in turn acts like a proxy between the framework and integrate blazing fast and thoroughly tested <a href="https://github.com/websockets/ws">ws</a> library. This adapter is fully compatible with native browser WebSockets and is far faster than socket.io package. Unluckily, it has significantly fewer functionalities available out-of-the-box. In some cases, you may just don't necessarily need them though.<blockquote><p>info <strong>Hint</strong> <code>ws</code> library does not support namespaces (communication channels popularised by <code>socket.io</code>). However, to somehow mimic this feature, you can mount multiple <code>ws</code> servers on different paths (example: <code>@WebSocketGateway({{ '{' }} path: '/users' {{ '}' }})</code>).</blockquote><p>In order to use <code>ws</code>, we firstly have to install the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save @nestjs/platform-ws</code></pre><p>Once the package is installed, we can switch an adapter:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">useWebSocketAdapter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">WsAdapter</span></span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>WsAdapter</code> is imported from <code>@nestjs/platform-ws</code>.</blockquote></section><section id="advanced-custom-adapter"class="level4"><h4>Advanced (custom adapter)</h4><p>For demonstration purposes, we are going to integrate the <a href="https://github.com/websockets/ws">ws</a> library manually. As mentioned, the adapter for this library is already created and is exposed from the <code>@nestjs/platform-ws</code> package as a <code>WsAdapter</code> class. Here is how the simplified implementation could potentially look like:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>ws<span class="token operator">-</span>adapter<span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">WebSocket</span></span> <span class="token keyword module">from</span> <span class="token string">'ws'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">WebSocketAdapter</span><span class="token punctuation">,</span> <span class="token maybe-class-name">INestApplicationContext</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MessageMappingProperties</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/websockets'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Observable</span><span class="token punctuation">,</span> fromEvent<span class="token punctuation">,</span> <span class="token constant">EMPTY</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> mergeMap<span class="token punctuation">,</span> filter <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">WsAdapter</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">WebSocketAdapter</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> app<span class="token operator">:</span> <span class="token maybe-class-name">INestApplicationContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">create</span><span class="token punctuation">(</span>port<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">any</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">WebSocket</span></span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Server</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> port<span class="token punctuation">,</span> <span class="token spread operator">...</span>options <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">bindClientConnect</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> callback<span class="token operator">:</span> <span class="token known-class-name class-name">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token method function property-access">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">bindMessageHandlers</span><span class="token punctuation">(</span>
    client<span class="token operator">:</span> <span class="token maybe-class-name">WebSocket</span><span class="token punctuation">,</span>
    handlers<span class="token operator">:</span> <span class="token maybe-class-name">MessageMappingProperties</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">process</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fromEvent</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>
        <span class="token function">mergeMap</span><span class="token punctuation">(</span>data <span class="token arrow operator">=></span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">bindMessageHandler</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> handlers<span class="token punctuation">,</span> process<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">filter</span><span class="token punctuation">(</span>result <span class="token arrow operator">=></span> result<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">subscribe</span><span class="token punctuation">(</span>response <span class="token arrow operator">=></span> client<span class="token punctuation">.</span><span class="token method function property-access">send</span><span class="token punctuation">(</span><span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">stringify</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">bindMessageHandler</span><span class="token punctuation">(</span>
    buffer<span class="token punctuation">,</span>
    handlers<span class="token operator">:</span> <span class="token maybe-class-name">MessageMappingProperties</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">process</span><span class="token operator">:</span> <span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token known-class-name class-name">JSON</span><span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> messageHandler <span class="token operator">=</span> handlers<span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span>
      handler <span class="token arrow operator">=></span> handler<span class="token punctuation">.</span><span class="token property-access">message</span> <span class="token operator">===</span> message<span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token constant">EMPTY</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> <span class="token function">process</span><span class="token punctuation">(</span>messageHandler<span class="token punctuation">.</span><span class="token method function property-access">callback</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">close</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> When you want to take advantage of <a href="https://github.com/websockets/ws">ws</a> library, use built-in <code>WsAdapter</code> instead of creating your own one.</blockquote><p>Then, we can set up a custom adapter using <code>useWebSocketAdapter()</code> method:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">useWebSocketAdapter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">WsAdapter</span></span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="example"class="level4"><h4>Example</h4><p>A working example that uses <code>WsAdapter</code> is available <a href="https://github.com/nestjs/nest/tree/master/sample/16-gateways-ws">here</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>