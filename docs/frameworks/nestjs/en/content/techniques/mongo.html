<!doctype html><html lang="en"><meta charset="utf-8"><title>Mongo</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="mongo"class="level3"><h3>Mongo</h3><p>Nest supports two methods for integrating with the <a href="https://www.mongodb.com/">MongoDB</a> database. You can either use the built-in <a href="https://github.com/typeorm/typeorm">TypeORM</a> module described <a href="/techniques/database">here</a>, which has a connector for MongoDB, or use <a href="https://mongoosejs.com">Mongoose</a>, the most popular MongoDB object modeling tool. In this chapter we'll describe the latter, using the dedicated <code>@nestjs/mongoose</code> package.<p>Start by installing the <a href="https://github.com/Automattic/mongoose">required dependencies</a>:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i @nestjs/mongoose mongoose</code></pre><p>Once the installation process is complete, we can import the <code>MongooseModule</code> into the root <code>AppModule</code>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MongooseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost/nest'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>The <code>forRoot()</code> method accepts the same configuration object as <code>mongoose.connect()</code> from the Mongoose package, as described <a href="https://mongoosejs.com/docs/connections.html">here</a>.<section id="model-injection"class="level4"><h4>Model injection</h4><p>With Mongoose, everything is derived from a <a href="http://mongoosejs.com/docs/guide.html">Schema</a>. Each schema maps to a MongoDB collection and defines the shape of the documents within that collection. Schemas are used to define <a href="https://mongoosejs.com/docs/models.html">Models</a>. Models are responsible for creating and reading documents from the underlying MongoDB database.<p>Schemas can be created with NestJS decorators, or with Mongoose itself manually. Using decorators to create schemas greatly reduces boilerplate and improves overall code readability.<p>Let's define the <code>CatSchema</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>schemas<span class="token operator">/</span>cat<span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Prop</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Schema</span><span class="token punctuation">,</span> <span class="token maybe-class-name">SchemaFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">HydratedDocument</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">CatDocument</span></span> <span class="token operator">=</span> <span class="token maybe-class-name">HydratedDocument</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Cat</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">CatSchema</span> <span class="token operator">=</span> <span class="token maybe-class-name">SchemaFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForClass</span><span class="token punctuation">(</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Note you can also generate a raw schema definition using the <code>DefinitionsFactory</code> class (from the <code>nestjs/mongoose</code>). This allows you to manually modify the schema definition generated based on the metadata you provided. This is useful for certain edge-cases where it may be hard to represent everything with decorators.</blockquote><p>The <code>@Schema()</code> decorator marks a class as a schema definition. It maps our <code>Cat</code> class to a MongoDB collection of the same name, but with an additional “s” at the end - so the final mongo collection name will be <code>cats</code>. This decorator accepts a single optional argument which is a schema options object. Think of it as the object you would normally pass as a second argument of the <code>mongoose.Schema</code> class' constructor (e.g., <code>new mongoose.Schema(_, options)</code>)). To learn more about available schema options, see <a href="https://mongoosejs.com/docs/guide.html#options">this</a> chapter.<p>The <code>@Prop()</code> decorator defines a property in the document. For example, in the schema definition above, we defined three properties: <code>name</code>, <code>age</code>, and <code>breed</code>. The <a href="https://mongoosejs.com/docs/schematypes.html">schema types</a> for these properties are automatically inferred thanks to TypeScript metadata (and reflection) capabilities. However, in more complex scenarios in which types cannot be implicitly reflected (for example, arrays or nested object structures), types must be indicated explicitly, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token known-class-name class-name">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
tags<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>Alternatively, the <code>@Prop()</code> decorator accepts an options object argument (<a href="https://mongoosejs.com/docs/schematypes.html#schematype-options">read more</a> about the available options). With this, you can indicate whether a property is required or not, specify a default value, or mark it as immutable. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></code></pre><p>In case you want to specify relation to another model, later for populating, you can use <code>@Prop()</code> decorator as well. For example, if <code>Cat</code> has <code>Owner</code> which is stored in a different collection called <code>owners</code>, the property should have type and ref. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mongoose</span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Owner</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../owners/schemas/owner.schema'</span><span class="token punctuation">;</span>

<span class="token comment">// inside the class definition</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Schema</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Types</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">ObjectId</span></span><span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token string">'Owner'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
owner<span class="token operator">:</span> <span class="token maybe-class-name">Owner</span><span class="token punctuation">;</span></code></pre><p>In case there are multiple owners, your property configuration should look as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Schema</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Types</span></span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">ObjectId</span></span><span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token string">'Owner'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
owner<span class="token operator">:</span> <span class="token maybe-class-name">Owner</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>Finally, the <strong>raw</strong> schema definition can also be passed to the decorator. This is useful when, for example, a property represents a nested object which is not defined as a class. For this, use the <code>raw()</code> function from the <code>@nestjs/mongoose</code> package, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  firstName<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  lastName<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
details<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span></code></pre><p>Alternatively, if you prefer <strong>not using decorators</strong>, you can define a schema manually. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">CatSchema</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token known-class-name class-name">Number</span><span class="token punctuation">,</span>
  breed<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>cat.schema</code> file resides in a folder in the <code>cats</code> directory, where we also define the <code>CatsModule</code>. While you can store schema files wherever you prefer, we recommend storing them near their related <strong>domain</strong> objects, in the appropriate module directory.<p>Let's look at the <code>CatsModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MongooseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">,</span> <span class="token maybe-class-name">CatSchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./schemas/cat.schema'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> schema<span class="token operator">:</span> <span class="token maybe-class-name">CatSchema</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>The <code>MongooseModule</code> provides the <code>forFeature()</code> method to configure the module, including defining which models should be registered in the current scope. If you also want to use the models in another module, add MongooseModule to the <code>exports</code> section of <code>CatsModule</code> and import <code>CatsModule</code> in the other module.<p>Once you've registered the schema, you can inject a <code>Cat</code> model into the <code>CatsService</code> using the <code>@InjectModel()</code> decorator:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Model</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">InjectModel</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">,</span> <span class="token maybe-class-name">CatDocument</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./schemas/cat.schema'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CreateCatDto</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./dto/create-cat.dto'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectModel</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span> <span class="token keyword">private</span> catModel<span class="token operator">:</span> <span class="token maybe-class-name">Model</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">CatDocument</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> createdCat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span><span class="token method function property-access">catModel</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> createdCat<span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Model</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> getModelToken <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./schemas/cat.schema'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token function">getModelToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>catModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span> <span class="token operator">=</span> catModel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> createdCat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span><span class="token method function property-access">catModel</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> createdCat<span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="connection"class="level4"><h4>Connection</h4><p>At times you may need to access the native <a href="https://mongoosejs.com/docs/api.html#Connection">Mongoose Connection</a> object. For example, you may want to make native API calls on the connection object. You can inject the Mongoose Connection by using the <code>@InjectConnection()</code> decorator as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">InjectConnection</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Connection</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectConnection</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">private</span> connection<span class="token operator">:</span> <span class="token maybe-class-name">Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="multiple-databases"class="level4"><h4>Multiple databases</h4><p>Some projects require multiple database connections. This can also be achieved with this module. To work with multiple connections, first create the connections. In this case, connection naming becomes <strong>mandatory</strong>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MongooseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      connectionName<span class="token operator">:</span> <span class="token string">'cats'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost/users'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      connectionName<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> Please note that you shouldn't have multiple connections without a name, or with the same name, otherwise they will get overridden.</blockquote><p>With this setup, you have to tell the <code>MongooseModule.forFeature()</code> function which connection should be used.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> schema<span class="token operator">:</span> <span class="token maybe-class-name">CatSchema</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'cats'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>You can also inject the <code>Connection</code> for a given connection:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">InjectConnection</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Connection</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectConnection</span></span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> connection<span class="token operator">:</span> <span class="token maybe-class-name">Connection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>To inject a given <code>Connection</code> to a custom provider (for example, factory provider), use the <code>getConnectionToken()</code> function passing the name of the connection as an argument.<pre class="language-typescript"><code class="language-typescript"><span class="token punctuation">{</span>
  provide<span class="token operator">:</span> <span class="token maybe-class-name">CatsService</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>catsConnection<span class="token operator">:</span> <span class="token maybe-class-name">Connection</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span><span class="token punctuation">(</span>catsConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">getConnectionToken</span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><p>If you are just looking to inject the model from a named database, you can use the connection name as a second parameter to the <code>@InjectModel()</code> decorator.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectModel</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> <span class="token string">'cats'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> catModel<span class="token operator">:</span> <span class="token maybe-class-name">Model</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">CatDocument</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token function">getModelToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> <span class="token string">'cats'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>catModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span> <span class="token operator">=</span> catModel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="hooks-middleware"class="level4"><h4>Hooks (middleware)</h4><p>Middleware (also called pre and post hooks) are functions which are passed control during execution of asynchronous functions. Middleware is specified on the schema level and is useful for writing plugins (<a href="https://mongoosejs.com/docs/middleware.html">source</a>). Calling <code>pre()</code> or <code>post()</code> after compiling a model does not work in Mongoose. To register a hook <strong>before</strong> model registration, use the <code>forFeatureAsync()</code> method of the <code>MongooseModule</code> along with a factory provider (i.e., <code>useFactory</code>). With this technique, you can access a schema object, then use the <code>pre()</code> or <code>post()</code> method to register a hook on that schema. See example below:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeatureAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
        <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token maybe-class-name">CatsSchema</span><span class="token punctuation">;</span>
          schema<span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Hello from pre save'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword control-flow">return</span> schema<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Like other <a href="https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory">factory providers</a>, our factory function can be <code>async</code> and can inject dependencies through <code>inject</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeatureAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
        imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token maybe-class-name">CatsSchema</span><span class="token punctuation">;</span>
          schema<span class="token punctuation">.</span><span class="token method function property-access">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'APP_NAME'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: Hello from pre save</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword control-flow">return</span> schema<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="plugins"class="level4"><h4>Plugins</h4><p>To register a <a href="https://mongoosejs.com/docs/plugins.html">plugin</a> for a given schema, use the <code>forFeatureAsync()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeatureAsync</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
        <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token maybe-class-name">CatsSchema</span><span class="token punctuation">;</span>
          schema<span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'mongoose-autopopulate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword control-flow">return</span> schema<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>To register a plugin for all schemas at once, call the <code>.plugin()</code> method of the <code>Connection</code> object. You should access the connection before models are created; to do this, use the <code>connectionFactory</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MongooseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost/test'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">connectionFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>connection<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
        connection<span class="token punctuation">.</span><span class="token method function property-access">plugin</span><span class="token punctuation">(</span><span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'mongoose-autopopulate'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">return</span> connection<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="discriminators"class="level4"><h4>Discriminators</h4><p><a href="https://mongoosejs.com/docs/discriminators.html">Discriminators</a> are a schema inheritance mechanism. They enable you to have multiple models with overlapping schemas on top of the same underlying MongoDB collection.<p>Suppose you wanted to track different types of events in a single collection. Every event will have a timestamp.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> discriminatorKey<span class="token operator">:</span> <span class="token string">'kind'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Event</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ClickedLinkEvent</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> <span class="token maybe-class-name">SignUpEvent</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  kind<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  time<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">EventSchema</span> <span class="token operator">=</span> <span class="token maybe-class-name">SchemaFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForClass</span><span class="token punctuation">(</span><span class="token maybe-class-name">Event</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The way mongoose tells the difference between the different discriminator models is by the "discriminator key", which is <code>__t</code> by default. Mongoose adds a String path called <code>__t</code> to your schemas that it uses to track which discriminator this document is an instance of. You may also use the <code>discriminatorKey</code> option to define the path for discrimination.</blockquote><p><code>SignedUpEvent</code> and <code>ClickedLinkEvent</code> instances will be stored in the same collection as generic events.<p>Now, let's define the <code>ClickedLinkEvent</code> class, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>click<span class="token operator">-</span>link<span class="token operator">-</span>event<span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ClickedLinkEvent</span></span> <span class="token punctuation">{</span>
  kind<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  time<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">ClickedLinkEventSchema</span> <span class="token operator">=</span> <span class="token maybe-class-name">SchemaFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForClass</span><span class="token punctuation">(</span><span class="token maybe-class-name">ClickedLinkEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>And <code>SignUpEvent</code> class:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>sign<span class="token operator">-</span>up<span class="token operator">-</span>event<span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">SignUpEvent</span></span> <span class="token punctuation">{</span>
  kind<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  time<span class="token operator">:</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Prop</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  user<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">SignUpEventSchema</span> <span class="token operator">=</span> <span class="token maybe-class-name">SchemaFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForClass</span><span class="token punctuation">(</span><span class="token maybe-class-name">SignUpEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>With this in place, use the <code>discriminators</code> option to register a discriminator for a given schema. It works on both <code>MongooseModule.forFeature</code> and <code>MongooseModule.forFeatureAsync</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MongooseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/mongoose'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token maybe-class-name">Event</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
        schema<span class="token operator">:</span> <span class="token maybe-class-name">EventSchema</span><span class="token punctuation">,</span>
        discriminators<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token maybe-class-name">ClickedLinkEvent</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> schema<span class="token operator">:</span> <span class="token maybe-class-name">ClickedLinkEventSchema</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token maybe-class-name">SignUpEvent</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span> schema<span class="token operator">:</span> <span class="token maybe-class-name">SignUpEventSchema</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">EventsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="testing"class="level4"><h4>Testing</h4><p>When unit testing an application, we usually want to avoid any database connection, making our test suites simpler to set up and faster to execute. But our classes might depend on models that are pulled from the connection instance. How do we resolve these classes? The solution is to create mock models.<p>To make this easier, the <code>@nestjs/mongoose</code> package exposes a <code>getModelToken()</code> function that returns a prepared <a href="https://docs.nestjs.com/fundamentals/custom-providers#di-fundamentals">injection token</a> based on a token name. Using this token, you can easily provide a mock implementation using any of the standard <a href="/fundamentals/custom-providers">custom provider</a> techniques, including <code>useClass</code>, <code>useValue</code>, and <code>useFactory</code>. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">CatsService</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token function">getModelToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      useValue<span class="token operator">:</span> catModel<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>In this example, a hardcoded <code>catModel</code> (object instance) will be provided whenever any consumer injects a <code>Model&#x3C;Cat></code> using an <code>@InjectModel()</code> decorator.<p><app-banner-courses></app-banner-courses></section><section id="async-configuration"class="level4"><h4>Async configuration</h4><p>When you need to pass module options asynchronously instead of statically, use the <code>forRootAsync()</code> method. As with most dynamic modules, Nest provides several techniques to deal with async configuration.<p>One technique is to use a factory function:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    uri<span class="token operator">:</span> <span class="token string">'mongodb://localhost/nest'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Like other <a href="https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory">factory providers</a>, our factory function can be <code>async</code> and can inject dependencies through <code>inject</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    uri<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'MONGODB_URI'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Alternatively, you can configure the <code>MongooseModule</code> using a class instead of a factory, as shown below:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  useClass<span class="token operator">:</span> <span class="token maybe-class-name">MongooseConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The construction above instantiates <code>MongooseConfigService</code> inside <code>MongooseModule</code>, using it to create the required options object. Note that in this example, the <code>MongooseConfigService</code> has to implement the <code>MongooseOptionsFactory</code> interface, as shown below. The <code>MongooseModule</code> will call the <code>createMongooseOptions()</code> method on the instantiated object of the supplied class.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MongooseConfigService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">MongooseOptionsFactory</span></span> <span class="token punctuation">{</span>
  <span class="token function">createMongooseOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">MongooseModuleOptions</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      uri<span class="token operator">:</span> <span class="token string">'mongodb://localhost/nest'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>If you want to reuse an existing options provider instead of creating a private copy inside the <code>MongooseModule</code>, use the <code>useExisting</code> syntax.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">MongooseModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRootAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="example"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/06-mongoose">here</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>