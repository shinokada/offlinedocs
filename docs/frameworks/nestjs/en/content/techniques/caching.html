<!doctype html><html lang="en"><meta charset="utf-8"><title>Caching</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="caching"class="level3"><h3>Caching</h3><p>Caching is a great and simple <strong>technique</strong> that helps improve your app's performance. It acts as a temporary data store providing high performance data access.<section id="installation"class="level4"><h4>Installation</h4><p>First install <a href="https://github.com/node-cache-manager/node-cache-manager">required packages</a>:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> cache-manager</code></pre></section><section id="in-memory-cache"class="level4"><h4>In-memory cache</h4><p>Nest provides a unified API for various cache storage providers. The built-in one is an in-memory data store. However, you can easily switch to a more comprehensive solution, like Redis.<p>In order to enable caching, import the <code>CacheModule</code> and call its <code>register()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CacheModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="interacting-with-the-cache-store"class="level4"><h4>Interacting with the Cache store</h4><p>To interact with the cache manager instance, inject it to your class using the <code>CACHE_MANAGER</code> token, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token constant">CACHE_MANAGER</span><span class="token punctuation">)</span> <span class="token keyword">private</span> cacheManager<span class="token operator">:</span> <span class="token maybe-class-name">Cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Cache</code> class is imported from the <code>cache-manager</code>, while <code>CACHE_MANAGER</code> token from the <code>@nestjs/common</code> package.</blockquote><p>The <code>get</code> method on the <code>Cache</code> instance (from the <code>cache-manager</code> package) is used to retrieve items from the cache. If the item does not exist in the cache, <code>null</code> will be returned.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheManager</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To add an item to the cache, use the <code>set</code> method:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheManager</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The default expiration time of the cache is 5 seconds.<p>You can manually specify a TTL (expiration time in seconds) for this specific key, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheManager</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To disable expiration of the cache, set the <code>ttl</code> configuration property to <code>0</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheManager</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To remove an item from the cache, use the <code>del</code> method:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheManager</span><span class="token punctuation">.</span><span class="token method function property-access">del</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>To clear the entire cache, use the <code>reset</code> method:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">cacheManager</span><span class="token punctuation">.</span><span class="token method function property-access">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="auto-caching-responses"class="level4"><h4>Auto-caching responses</h4><blockquote><p>warning <strong>Warning</strong> In <a href="/graphql/quick-start">GraphQL</a> applications, interceptors are executed separately for each field resolver. Thus, <code>CacheModule</code> (which uses interceptors to cache responses) will not work properly.</blockquote><p>To enable auto-caching responses, just tie the <code>CacheInterceptor</code> where you want to cache data.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseInterceptors</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CacheInterceptor</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning<strong>Warning</strong> Only <code>GET</code> endpoints are cached. Also, HTTP server routes that inject the native response object (<code>@Res()</code>) cannot use the Cache Interceptor. See <a href="https://docs.nestjs.com/interceptors#response-mapping">response mapping</a> for more details.</blockquote><p>To reduce the amount of required boilerplate, you can bind <code>CacheInterceptor</code> to all endpoints globally:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CacheModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">CacheInterceptor</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span> <span class="token constant">APP_INTERCEPTOR</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token constant">APP_INTERCEPTOR</span><span class="token punctuation">,</span>
      useClass<span class="token operator">:</span> <span class="token maybe-class-name">CacheInterceptor</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="customize-caching"class="level4"><h4>Customize caching</h4><p>All cached data has its own expiration time (<a href="https://en.wikipedia.org/wiki/Time_to_live">TTL</a>). To customize default values, pass the options object to the <code>register()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  ttl<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// seconds</span>
  max<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">// maximum number of items in cache</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="use-module-globally"class="level4"><h4>Use module globally</h4><p>When you want to use <code>CacheModule</code> in other modules, you'll need to import it (as is standard with any Nest module). Alternatively, declare it as a <a href="https://docs.nestjs.com/modules#global-modules">global module</a> by setting the options object's <code>isGlobal</code> property to <code>true</code>, as shown below. In that case, you will not need to import <code>CacheModule</code> in other modules once it's been loaded in the root module (e.g., <code>AppModule</code>).<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  isGlobal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="global-cache-overrides"class="level4"><h4>Global cache overrides</h4><p>While global cache is enabled, cache entries are stored under a <code>CacheKey</code> that is auto-generated based on the route path. You may override certain cache settings (<code>@CacheKey()</code> and <code>@CacheTTL()</code>) on a per-method basis, allowing customized caching strategies for individual controller methods. This may be most relevant while using <a href="https://docs.nestjs.com/techniques/caching#different-stores">different cache stores.</a><pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheKey</span></span><span class="token punctuation">(</span><span class="token string">'custom_key'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheTTL</span></span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@CacheKey()</code> and <code>@CacheTTL()</code> decorators are imported from the <code>@nestjs/common</code> package.</blockquote><p>The <code>@CacheKey()</code> decorator may be used with or without a corresponding <code>@CacheTTL()</code> decorator and vice versa. One may choose to override only the <code>@CacheKey()</code> or only the <code>@CacheTTL()</code>. Settings that are not overridden with a decorator will use the default values as registered globally (see <a href="https://docs.nestjs.com/techniques/caching#customize-caching">Customize caching</a>).</section><section id="websockets-and-microservices"class="level4"><h4>WebSockets and Microservices</h4><p>You can also apply the <code>CacheInterceptor</code> to WebSocket subscribers as well as Microservice's patterns (regardless of the transport method that is being used).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheKey</span></span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseInterceptors</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CacheInterceptor</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">SubscribeMessage</span></span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token function">handleEvent</span><span class="token punctuation">(</span>client<span class="token operator">:</span> <span class="token maybe-class-name">Client</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheKey</span></span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseInterceptors</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CacheInterceptor</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">SubscribeMessage</span></span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token function">handleEvent</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>However, the additional <code>@CacheKey()</code> decorator is required in order to specify a key used to subsequently store and retrieve cached data. Also, please note that you <strong>shouldn't cache everything</strong>. Actions which perform some business operations rather than simply querying the data should never be cached.<p>Additionally, you may specify a cache expiration time (TTL) by using the <code>@CacheTTL()</code> decorator, which will override the global default TTL value.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheTTL</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseInterceptors</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CacheInterceptor</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">SubscribeMessage</span></span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token function">handleEvent</span><span class="token punctuation">(</span>client<span class="token operator">:</span> <span class="token maybe-class-name">Client</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CacheTTL</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseInterceptors</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CacheInterceptor</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">SubscribeMessage</span></span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token function">handleEvent</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@CacheTTL()</code> decorator may be used with or without a corresponding <code>@CacheKey()</code> decorator.</blockquote></section><section id="adjust-tracking"class="level4"><h4>Adjust tracking</h4><p>By default, Nest uses the request URL (in an HTTP app) or cache key (in websockets and microservices apps, set through the <code>@CacheKey()</code> decorator) to associate cache records with your endpoints. Nevertheless, sometimes you might want to set up tracking based on different factors, for example, using HTTP headers (e.g. <code>Authorization</code> to properly identify <code>profile</code> endpoints).<p>In order to accomplish that, create a subclass of <code>CacheInterceptor</code> and override the <code>trackBy()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HttpCacheInterceptor</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">CacheInterceptor</span></span> <span class="token punctuation">{</span>
  <span class="token function">trackBy</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword nil">undefined</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token string">'key'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="different-stores"class="level4"><h4>Different stores</h4><p>This service takes advantage of <a href="https://github.com/node-cache-manager/node-cache-manager">cache-manager</a> under the hood. The <code>cache-manager</code> package supports a wide-range of useful stores, for example, <a href="https://github.com/dabroek/node-cache-manager-redis-store">Redis store</a>. A full list of supported stores is available <a href="https://github.com/node-cache-manager/node-cache-manager#store-engines">here</a>. To set up the Redis store, simply pass the package together with corresponding options to the <code>register()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ClientOpts</span> <span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'redis'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> redisStore</span> <span class="token keyword module">from</span> <span class="token string">'cache-manager-redis-store'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CacheModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">register</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ClientOpts</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      store<span class="token operator">:</span> redisStore<span class="token punctuation">,</span>

      <span class="token comment">// Store-specific configuration:</span>
      host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
      port<span class="token operator">:</span> <span class="token number">6379</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>warning<strong>Warning</strong> <code>cache-manager-redis-store</code> does not support redis v4. In order for the <code>ClientOpts</code> interface to exist and work correctly you need to install the latest <code>redis</code> 3.x.x major release. See this <a href="https://github.com/dabroek/node-cache-manager-redis-store/issues/40">issue</a> to track the progress of this upgrade.</blockquote></section><section id="async-configuration"class="level4"><h4>Async configuration</h4><p>You may want to asynchronously pass in module options instead of passing them statically at compile time. In this case, use the <code>registerAsync()</code> method, which provides several ways to deal with async configuration.<p>One approach is to use a factory function:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    ttl<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Our factory behaves like all other asynchronous module factories (it can be <code>async</code> and is able to inject dependencies through <code>inject</code>).<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>configService<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    ttl<span class="token operator">:</span> configService<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'CACHE_TTL'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Alternatively, you can use the <code>useClass</code> method:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  useClass<span class="token operator">:</span> <span class="token maybe-class-name">CacheConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The above construction will instantiate <code>CacheConfigService</code> inside <code>CacheModule</code> and will use it to get the options object. The <code>CacheConfigService</code> has to implement the <code>CacheOptionsFactory</code> interface in order to provide the configuration options:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CacheConfigService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">CacheOptionsFactory</span></span> <span class="token punctuation">{</span>
  <span class="token function">createCacheOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">CacheModuleOptions</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      ttl<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>If you wish to use an existing configuration provider imported from a different module, use the <code>useExisting</code> syntax:<pre class="language-typescript"><code class="language-typescript"><span class="token maybe-class-name">CacheModule</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  useExisting<span class="token operator">:</span> <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This works the same as <code>useClass</code> with one critical difference - <code>CacheModule</code> will lookup imported modules to reuse any already-created <code>ConfigService</code>, instead of instantiating its own.<blockquote><p>info <strong>Hint</strong> <code>CacheModule#register</code> and <code>CacheModule#registerAsync</code> and <code>CacheOptionsFactory</code> has an optional generic (type argument) to narrow down store-specific configuration options, making it type safe.</blockquote></section><section id="example"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/20-cache">here</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>