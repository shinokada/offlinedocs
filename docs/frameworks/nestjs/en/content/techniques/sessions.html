<!doctype html><html lang="en"><meta charset="utf-8"><title>Session</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="session"class="level3"><h3>Session</h3><p><strong>HTTP sessions</strong> provide a way to store information about the user across multiple requests, which is particularly useful for <a href="/techniques/mvc">MVC</a> applications.<section id="use-with-express-default"class="level4"><h4>Use with Express (default)</h4><p>First install the <a href="https://github.com/expressjs/session">required package</a> (and its types for TypeScript users):<pre class="language-shell"><code class="language-shell">$ <span class="token function">npm</span> i express-session
$ <span class="token function">npm</span> i -D @types/express-session</code></pre><p>Once the installation is complete, apply the <code>express-session</code> middleware as global middleware (for example, in your <code>main.ts</code> file).<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> session</span> <span class="token keyword module">from</span> <span class="token string">'express-session'</span><span class="token punctuation">;</span>
<span class="token comment">// somewhere in your initialization file</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>
  <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    secret<span class="token operator">:</span> <span class="token string">'my-secret'</span><span class="token punctuation">,</span>
    resave<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    saveUninitialized<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Notice</strong> The default server-side session storage is purposely not designed for a production environment. It will leak memory under most conditions, does not scale past a single process, and is meant for debugging and developing. Read more in the <a href="https://github.com/expressjs/session">official repository</a>.</blockquote><p>The <code>secret</code> is used to sign the session ID cookie. This can be either a string for a single secret, or an array of multiple secrets. If an array of secrets is provided, only the first element will be used to sign the session ID cookie, while all the elements will be considered when verifying the signature in requests. The secret itself should be not easily parsed by a human and would best be a random set of characters.<p>Enabling the <code>resave</code> option forces the session to be saved back to the session store, even if the session was never modified during the request. The default value is <code>true</code>, but using the default has been deprecated, as the default will change in the future.<p>Likewise, enabling the <code>saveUninitialized</code> option Forces a session that is "uninitialized" to be saved to the store. A session is uninitialized when it is new but not modified. Choosing <code>false</code> is useful for implementing login sessions, reducing server storage usage, or complying with laws that require permission before setting a cookie. Choosing <code>false</code> will also help with race conditions where a client makes multiple parallel requests without a session (<a href="https://github.com/expressjs/session#saveuninitialized">source</a>).<p>You can pass several other options to the <code>session</code> middleware, read more about them in the <a href="https://github.com/expressjs/session#options">API documentation</a>.<blockquote><p>info <strong>Hint</strong> Please note that <code>secure: true</code> is a recommended option. However, it requires an https-enabled website, i.e., HTTPS is necessary for secure cookies. If secure is set, and you access your site over HTTP, the cookie will not be set. If you have your node.js behind a proxy and are using <code>secure: true</code>, you need to set <code>"trust proxy"</code> in express.</blockquote><p>With this in place, you can now set and read session values from within the route handlers, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Req</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> request<span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  request<span class="token punctuation">.</span><span class="token property-access">session</span><span class="token punctuation">.</span><span class="token property-access">visits</span> <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token property-access">session</span><span class="token punctuation">.</span><span class="token property-access">visits</span> <span class="token operator">?</span> request<span class="token punctuation">.</span><span class="token property-access">session</span><span class="token punctuation">.</span><span class="token property-access">visits</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@Req()</code> decorator is imported from the <code>@nestjs/common</code>, while <code>Request</code> from the <code>express</code> package.</blockquote><p>Alternatively, you can use the <code>@Session()</code> decorator to extract a session object from the request, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Session</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> session<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  session<span class="token punctuation">.</span><span class="token property-access">visits</span> <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token property-access">visits</span> <span class="token operator">?</span> session<span class="token punctuation">.</span><span class="token property-access">visits</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@Session()</code> decorator is imported from the <code>@nestjs/common</code> package.</blockquote></section><section id="use-with-fastify"class="level4"><h4>Use with Fastify</h4><p>First install the required package:<pre class="language-shell"><code class="language-shell">$ <span class="token function">npm</span> i @fastify/secure-session</code></pre><p>Once the installation is complete, register the <code>fastify-secure-session</code> plugin:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports">secureSession</span> <span class="token keyword module">from</span> <span class="token string">'@fastify/secure-session'</span><span class="token punctuation">;</span>

<span class="token comment">// somewhere in your initialization file</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">create</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">NestFastifyApplication</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
  <span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FastifyAdapter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span>secureSession<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  secret<span class="token operator">:</span> <span class="token string">'averylogphrasebiggerthanthirtytwochars'</span><span class="token punctuation">,</span>
  salt<span class="token operator">:</span> <span class="token string">'mq9hDxBVDbspDR6n'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> You can also pregenerate a key (<a href="https://github.com/fastify/fastify-secure-session">see instructions</a>) or use <a href="https://github.com/fastify/fastify-secure-session#using-keys-with-key-rotation">keys rotation</a>.</blockquote><p>Read more about the available options in the <a href="https://github.com/fastify/fastify-secure-session">official repository</a>.<p>With this in place, you can now set and read session values from within the route handlers, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Req</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> request<span class="token operator">:</span> <span class="token maybe-class-name">FastifyRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> visits <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token property-access">session</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'visits'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request<span class="token punctuation">.</span><span class="token property-access">session</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'visits'</span><span class="token punctuation">,</span> visits <span class="token operator">?</span> visits <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Alternatively, you can use the <code>@Session()</code> decorator to extract a session object from the request, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Session</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> session<span class="token operator">:</span> secureSession<span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Session</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> visits <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'visits'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  session<span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">'visits'</span><span class="token punctuation">,</span> visits <span class="token operator">?</span> visits <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@Session()</code> decorator is imported from the <code>@nestjs/common</code>, while <code>secureSession.Session</code> from the <code>@fastify/secure-session</code> package (import statement: <code>import * as secureSession from '@fastify/secure-session'</code>). <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>