<!doctype html><html lang="en"><meta charset="utf-8"><title>MikroORM</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="mikroorm"class="level3"><h3>MikroORM</h3><p>This recipe is here to help users getting started with MikroORM in Nest. MikroORM is the TypeScript ORM for Node.js based on Data Mapper, Unit of Work and Identity Map patterns. It is a great alternative to TypeORM and migration from TypeORM should be fairly easy. The complete documentation on MikroORM can be found <a href="https://mikro-orm.io/docs">here</a>.<blockquote><p>info <strong>info</strong> <code>@mikro-orm/nestjs</code> is a third party package and is not managed by the NestJS core team. Please, report any issues found with the library in the <a href="https://github.com/mikro-orm/nestjs">appropriate repository</a>.</blockquote><section id="installation"class="level4"><h4>Installation</h4><p>Easiest way to integrate MikroORM to Nest is via <a href="https://github.com/mikro-orm/nestjs"><code>@mikro-orm/nestjs</code> module</a>. Simply install it next to Nest, MikroORM and underlying driver:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i @mikro-orm/core @mikro-orm/nestjs @mikro-orm/mysql <span class="token comment"># for mysql/mariadb</span></code></pre><p>MikroORM also supports <code>postgres</code>, <code>sqlite</code>, and <code>mongo</code>. See the <a href="https://mikro-orm.io/docs/usage-with-sql/">official docs</a> for all drivers.<p>Once the installation process is completed, we can import the <code>MikroOrmModule</code> into the root <code>AppModule</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MikroOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      entities<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./dist/entities'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      entitiesTs<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./src/entities'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      dbName<span class="token operator">:</span> <span class="token string">'my-db-name.sqlite3'</span><span class="token punctuation">,</span>
      type<span class="token operator">:</span> <span class="token string">'sqlite'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>The <code>forRoot()</code> method accepts the same configuration object as <code>init()</code> from the MikroORM package. Check <a href="https://mikro-orm.io/docs/configuration">this page</a> for the complete configuration documentation.<p>Alternatively we can <a href="https://mikro-orm.io/docs/installation#setting-up-the-commandline-tool">configure the CLI</a> by creating a configuration file <code>mikro-orm.config.ts</code> and then call the <code>forRoot()</code> without any arguments. This won't work when you use a build tools that use tree shaking.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MikroOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token spread operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Afterward, the <code>EntityManager</code> will be available to inject across entire project (without importing any module elsewhere).<pre class="language-ts"><code class="language-ts"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">MikroORM</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@mikro-orm/core'</span><span class="token punctuation">;</span>
<span class="token comment">// Import EntityManager from your driver package or `@mikro-orm/knex`</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">EntityManager</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@mikro-orm/mysql'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MyService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> orm<span class="token operator">:</span> <span class="token maybe-class-name">MikroORM</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> em<span class="token operator">:</span> <span class="token maybe-class-name">EntityManager</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>info</strong> Notice that the <code>EntityManager</code> is imported from the <code>@mikro-orm/driver</code> package, where driver is <code>mysql</code>, <code>sqlite</code>, <code>postgres</code> or what driver you are using. In case you have <code>@mikro-orm/knex</code> installed as a dependency, you can also import the <code>EntityManager</code> from there.</blockquote></section><section id="repositories"class="level4"><h4>Repositories</h4><p>MikroORM supports the repository design pattern. For every entity we can create a repository. Read the complete documentation on repositories <a href="https://mikro-orm.io/docs/repositories">here</a>. To define which repositories should be registered in the current scope you can use the <code>forFeature()</code> method. For example, in this way:<blockquote><p>info <strong>info</strong> You should <strong>not</strong> register your base entities via <code>forFeature()</code>, as there are no repositories for those. On the other hand, base entities need to be part of the list in <code>forRoot()</code> (or in the ORM config in general).</blockquote><pre class="language-typescript"><code class="language-typescript"><span class="token comment">// photo.module.ts</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">MikroOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forFeature</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">Photo</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PhotoService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">PhotoController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PhotoModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>and import it into the root <code>AppModule</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// app.module.ts</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">MikroOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token spread operator">...</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PhotoModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>In this way we can inject the <code>PhotoRepository</code> to the <code>PhotoService</code> using the <code>@InjectRepository()</code> decorator:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PhotoService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">InjectRepository</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Photo</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> photoRepository<span class="token operator">:</span> <span class="token maybe-class-name">EntityRepository</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photo</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="using-custom-repositories"class="level4"><h4>Using custom repositories</h4><p>When using custom repositories, we can get around the need for <code>@InjectRepository()</code> decorator by naming our repositories the same way as <code>getRepositoryToken()</code> method do:<pre class="language-ts"><code class="language-ts"><span class="token keyword module">export</span> <span class="token keyword">const</span> getRepositoryToken <span class="token operator">=</span> <span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">(</span>entity<span class="token operator">:</span> <span class="token maybe-class-name">EntityName</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token maybe-class-name">Utils</span><span class="token punctuation">.</span><span class="token method function property-access">className</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">Repository</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></code></pre><p>In other words, as long as we name the repository same was as the entity is called, appending <code>Repository</code> suffix, the repository will be registered automatically in the Nest DI container.<pre class="language-ts"><code class="language-ts"><span class="token comment">// `**./author.entity.ts**`</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Author</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// to allow inference in `em.getRepository()`</span>
  <span class="token punctuation">[</span><span class="token maybe-class-name">EntityRepositoryType</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token maybe-class-name">AuthorRepository</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// `**./author.repository.ts**`</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Repository</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Author</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthorRepository</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">EntityRepository</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Author</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token comment">// your custom methods...</span>
<span class="token punctuation">}</span></code></pre><p>As the custom repository name is the same as what <code>getRepositoryToken()</code> would return, we do not need the <code>@InjectRepository()</code> decorator anymore:<pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MyService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> repo<span class="token operator">:</span> <span class="token maybe-class-name">AuthorRepository</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="load-entities-automatically"class="level4"><h4>Load entities automatically</h4><blockquote><p>info <strong>info</strong> <code>autoLoadEntities</code> option was added in v4.1.0</blockquote><p>Manually adding entities to the entities array of the connection options can be tedious. In addition, referencing entities from the root module breaks application domain boundaries and causes leaking implementation details to other parts of the application. To solve this issue, static glob paths can be used.<p>Note, however, that glob paths are not supported by webpack, so if you are building your application within a monorepo, you won't be able to use them. To address this issue, an alternative solution is provided. To automatically load entities, set the <code>autoLoadEntities</code> property of the configuration object (passed into the <code>forRoot()</code> method) to <code>true</code>, as shown below:<pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MikroOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token spread operator">...</span>
      autoLoadEntities<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>With that option specified, every entity registered through the <code>forFeature()</code> method will be automatically added to the entities array of the configuration object.<blockquote><p>info <strong>info</strong> Note that entities that aren't registered through the <code>forFeature()</code> method, but are only referenced from the entity (via a relationship), won't be included by way of the <code>autoLoadEntities</code> setting.</blockquote><blockquote><p>info <strong>info</strong> Using <code>autoLoadEntities</code> also has no effect on the MikroORM CLI - for that we still need CLI config with the full list of entities. On the other hand, we can use globs there, as the CLI won't go thru webpack.</blockquote></section><section id="serialization"class="level4"><h4>Serialization</h4><blockquote><p>warning <strong>Note</strong> MikroORM wraps every single entity relation in a <code>Reference&#x3C;T></code> or a <code>Collection&#x3C;T></code> object, in order to provide better type-safety. This will make <a href="/techniques/serialization">Nest's built-in serializer</a> blind to any wrapped relations. In other words, if you return MikroORM entities from your HTTP or WebSocket handlers, all of their relations will NOT be serialized.</blockquote><p>Luckily, MikroORM provides a <a href="https://mikro-orm.io/docs/serializing">serialization API</a> which can be used in lieu of <code>ClassSerializerInterceptor</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Book</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Property</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> hidden<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// Equivalent of class-transformer's `@Exclude`</span>
  hiddenField <span class="token operator">=</span> <span class="token known-class-name class-name">Date</span><span class="token punctuation">.</span><span class="token method function property-access">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Property</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> persist<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// Similar to class-transformer's `@Expose()`. Will only exist in memory, and will be serialized.</span>
  count<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">ManyToOne</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">serializer</span><span class="token operator">:</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token arrow operator">=></span> value<span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">,</span>
    serializedName<span class="token operator">:</span> <span class="token string">'authorName'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// Equivalent of class-transformer's `@Transform()`</span>
  author<span class="token operator">:</span> <span class="token maybe-class-name">Author</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="request-scoped-handlers-in-queues"class="level4"><h4>Request scoped handlers in queues</h4><blockquote><p>info <strong>info</strong> <code>@UseRequestContext()</code> decorator was added in v4.1.0</blockquote><p>As mentioned in the <a href="https://mikro-orm.io/docs/identity-map">docs</a>, we need a clean state for each request. That is handled automatically thanks to the <code>RequestContext</code> helper registered via middleware.<p>But middlewares are executed only for regular HTTP request handles, what if we need a request scoped method outside of that? One example of that is queue handlers or scheduled tasks.<p>We can use the <code>@UseRequestContext()</code> decorator. It requires you to first inject the <code>MikroORM</code> instance to current context, it will be then used to create the context for you. Under the hood, the decorator will register new request context for your method and execute it inside the context.<pre class="language-ts"><code class="language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">MyService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">readonly</span> orm<span class="token operator">:</span> <span class="token maybe-class-name">MikroORM</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">UseRequestContext</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// this will be executed in a separate context</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="using-asynclocalstorage-for-request-context"class="level4"><h4>Using <code>AsyncLocalStorage</code> for request context</h4><p>By default, the <code>domain</code> api is used in the <code>RequestContext</code> helper. Since <code>@mikro-orm/core@4.0.3</code>, you can use the new <code>AsyncLocalStorage</code> too, if you are on up to date node version:<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// create new (global) storage instance</span>
<span class="token keyword">const</span> storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">AsyncLocalStorage</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">EntityManager</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">MikroOrmModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// ...</span>
      registerRequestContext<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// disable automatatic middleware</span>
      <span class="token function-variable function">context</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> storage<span class="token punctuation">.</span><span class="token method function property-access">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// use our AsyncLocalStorage instance</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// register the request context middleware</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> orm <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">MikroORM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  storage<span class="token punctuation">.</span><span class="token method function property-access">run</span><span class="token punctuation">(</span>orm<span class="token punctuation">.</span><span class="token property-access">em</span><span class="token punctuation">.</span><span class="token method function property-access">fork</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="testing"class="level4"><h4>Testing</h4><p>The <code>@mikro-orm/nestjs</code> package exposes <code>getRepositoryToken()</code> function that returns prepared token based on a given entity to allow mocking the repository.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">PhotoService</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      provide<span class="token operator">:</span> <span class="token function">getRepositoryToken</span><span class="token punctuation">(</span><span class="token maybe-class-name">Photo</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      useValue<span class="token operator">:</span> mockedRepository<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PhotoModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="example"class="level4"><h4>Example</h4><p>A real world example of NestJS with MikroORM can be found <a href="https://github.com/mikro-orm/nestjs-realworld-example-app">here</a> <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>