<!doctype html><html lang="en"><meta charset="utf-8"><title>SQL (Sequelize)</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="sql-sequelize"class="level3"><h3>SQL (Sequelize)</h3><section id="this-chapter-applies-only-to-typescript"class="level5"><h5>This chapter applies only to TypeScript</h5><blockquote><p><strong>Warning</strong> In this article, you'll learn how to create a <code>DatabaseModule</code> based on the <strong>Sequelize</strong> package from scratch using custom components. As a consequence, this technique contains a lot of overhead that you can avoid by using the dedicated, out-of-the-box <code>@nestjs/sequelize</code> package. To learn more, see <a href="/techniques/database#sequelize-integration">here</a>.</blockquote><p><a href="https://github.com/sequelize/sequelize">Sequelize</a> is a popular Object Relational Mapper (ORM) written in a vanilla JavaScript, but there is a <a href="https://github.com/RobinBuschmann/sequelize-typescript">sequelize-typescript</a> TypeScript wrapper which provides a set of decorators and other extras for the base sequelize.</section><section id="getting-started"class="level4"><h4>Getting started</h4><p>To start the adventure with this library we have to install the following dependencies:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save sequelize sequelize-typescript mysql2
$ <span class="token function">npm</span> <span class="token function">install</span> --save-dev @types/sequelize</code></pre><p>The first step we need to do is create a <strong>Sequelize</strong> instance with an options object passed into the constructor. Also, we need to add all models (the alternative is to use <code>modelPaths</code> property) and <code>sync()</code> our database tables.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token property-access">providers</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Sequelize</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sequelize-typescript'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../cats/cat.entity'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> databaseProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'SEQUELIZE'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> sequelize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Sequelize</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        dialect<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
        host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
        database<span class="token operator">:</span> <span class="token string">'nest'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      sequelize<span class="token punctuation">.</span><span class="token method function property-access">addModels</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">await</span> sequelize<span class="token punctuation">.</span><span class="token method function property-access">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">return</span> sequelize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Following best practices, we declared the custom provider in the separated file which has a <code>*.providers.ts</code> suffix.</blockquote><p>Then, we need to export these providers to make them <strong>accessible</strong> for the rest part of the application.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> databaseProviders <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./database.providers'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>databaseProviders<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>databaseProviders<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">DatabaseModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now we can inject the <code>Sequelize</code> object using <code>@Inject()</code> decorator. Each class that would depend on the <code>Sequelize</code> async provider will wait until a <code>Promise</code> is resolved.</section><section id="model-injection"class="level4"><h4>Model injection</h4><p>In <a href="https://github.com/sequelize/sequelize">Sequelize</a> the <strong>Model</strong> defines a table in the database. Instances of this class represent a database row. Firstly, we need at least one entity:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cat<span class="token punctuation">.</span><span class="token property-access">entity</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Table</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Column</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Model</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'sequelize-typescript'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Table</span></span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Cat</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">Model</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span>
  breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>Cat</code> entity belongs to the <code>cats</code> directory. This directory represents the <code>CatsModule</code>. Now it's time to create a <strong>Repository</strong> provider:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">providers</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cat.entity'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> catsProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'CATS_REPOSITORY'</span><span class="token punctuation">,</span>
    useValue<span class="token operator">:</span> <span class="token maybe-class-name">Cat</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Warning</strong> In the real-world applications you should avoid <strong>magic strings</strong>. Both <code>CATS_REPOSITORY</code> and <code>SEQUELIZE</code> should be kept in the separated <code>constants.ts</code> file.</blockquote><p>In Sequelize, we use static methods to manipulate the data, and thus we created an <strong>alias</strong> here.<p>Now we can inject the <code>CATS_REPOSITORY</code> to the <code>CatsService</code> using the <code>@Inject()</code> decorator:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Inject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CreateCatDto</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./dto/create-cat.dto'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cat.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'CATS_REPOSITORY'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> catsRepository<span class="token operator">:</span> <span class="token keyword">typeof</span> <span class="token maybe-class-name">Cat</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsRepository</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">findAll</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The database connection is <strong>asynchronous</strong>, but Nest makes this process completely invisible for the end-user. The <code>CATS_REPOSITORY</code> provider is waiting for the db connection, and the <code>CatsService</code> is delayed until repository is ready to use. The entire application can start when each class is instantiated.<p>Here is a final <code>CatsModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> catsProviders <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.providers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DatabaseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../database/database.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">DatabaseModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">CatsService</span><span class="token punctuation">,</span>
    <span class="token spread operator">...</span>catsProviders<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Do not forget to import the <code>CatsModule</code> into the root <code>AppModule</code>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>