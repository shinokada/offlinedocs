<!doctype html><html lang="en"><meta charset="utf-8"><title>CQRS</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="cqrs"class="level3"><h3>CQRS</h3><p>The flow of simple <a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> (Create, Read, Update and Delete) applications can be described using the following steps:<ol><li>The <strong>controllers</strong> layer handles HTTP requests and delegates tasks to the services layer.<li>The <strong>services layer</strong> is where most of the business logic lives.<li>Services use <strong>repositories / DAOs</strong> to change / persist entities.<li>Entities act as containers for the values, with setters and getters.</ol><p>In most cases, for small and medium-sized applications, this pattern is sufficient. However, when our requirements become more complex, the <strong>CQRS</strong> model may be more appropriate and scalable. To facilitate that model, Nest provides a lightweight <a href="https://github.com/nestjs/cqrs">CQRS module</a>. This chapter describes how to use it.<section id="installation"class="level4"><h4>Installation</h4><p>First install the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save @nestjs/cqrs</code></pre></section><section id="commands"class="level4"><h4>Commands</h4><p>In this model, each action is called a <strong>Command</strong>. When a command is dispatched, the application reacts to it. Commands can be dispatched from the services layer, or directly from controllers/gateways. Commands are consumed by <strong>Command Handlers</strong>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token operator">-</span>game<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesGameService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> commandBus<span class="token operator">:</span> <span class="token maybe-class-name">CommandBus</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">killDragon</span><span class="token punctuation">(</span>heroId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> killDragonDto<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">commandBus</span><span class="token punctuation">.</span><span class="token method function property-access">execute</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonCommand</span></span><span class="token punctuation">(</span>heroId<span class="token punctuation">,</span> killDragonDto<span class="token punctuation">.</span><span class="token property-access">dragonId</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CommandBus</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesGameService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>commandBus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">commandBus</span> <span class="token operator">=</span> commandBus<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">killDragon</span><span class="token punctuation">(</span>heroId<span class="token punctuation">,</span> killDragonDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">commandBus</span><span class="token punctuation">.</span><span class="token method function property-access">execute</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonCommand</span></span><span class="token punctuation">(</span>heroId<span class="token punctuation">,</span> killDragonDto<span class="token punctuation">.</span><span class="token property-access">dragonId</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Here's a sample service that dispatches <code>KillDragonCommand</code>. Let's see how the command looks:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>kill<span class="token operator">-</span>dragon<span class="token punctuation">.</span><span class="token property-access">command</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonCommand</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> heroId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> dragonId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonCommand</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>heroId<span class="token punctuation">,</span> dragonId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroId</span> <span class="token operator">=</span> heroId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dragonId</span> <span class="token operator">=</span> dragonId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The <code>CommandBus</code> is a <strong>stream</strong> of commands. It delegates commands to the equivalent handlers. Each command must have a corresponding <strong>Command Handler</strong>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>kill<span class="token operator">-</span>dragon<span class="token punctuation">.</span><span class="token property-access">handler</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CommandHandler</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">KillDragonCommand</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonHandler</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">ICommandHandler</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">KillDragonCommand</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> repository<span class="token operator">:</span> <span class="token maybe-class-name">HeroRepository</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonCommand</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> heroId<span class="token punctuation">,</span> dragonId <span class="token punctuation">}</span> <span class="token operator">=</span> command<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span><span class="token punctuation">.</span><span class="token method function property-access">findOneById</span><span class="token punctuation">(</span><span class="token operator">+</span>heroId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    hero<span class="token punctuation">.</span><span class="token method function property-access">killEnemy</span><span class="token punctuation">(</span>dragonId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span><span class="token punctuation">.</span><span class="token method function property-access">persist</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CommandHandler</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">KillDragonCommand</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">HeroRepository</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonHandler</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span> <span class="token operator">=</span> repository<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> heroId<span class="token punctuation">,</span> dragonId <span class="token punctuation">}</span> <span class="token operator">=</span> command<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span><span class="token punctuation">.</span><span class="token method function property-access">findOneById</span><span class="token punctuation">(</span><span class="token operator">+</span>heroId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    hero<span class="token punctuation">.</span><span class="token method function property-access">killEnemy</span><span class="token punctuation">(</span>dragonId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span><span class="token punctuation">.</span><span class="token method function property-access">persist</span><span class="token punctuation">(</span>hero<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>With this approach, every application state change is driven by the occurrence of a <strong>Command</strong>. The logic is encapsulated in handlers. With this approach, we can simply add behavior like logging or persisting commands in the database (e.g., for diagnostics purposes).</section><section id="events"class="level4"><h4>Events</h4><p>Command handlers neatly encapsulate logic. While beneficial, the application structure is still not flexible enough, not <strong>reactive</strong>. To remedy this, we also introduce <strong>events</strong>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>hero<span class="token operator">-</span>killed<span class="token operator">-</span>dragon<span class="token punctuation">.</span><span class="token property-access">event</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroKilledDragonEvent</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> heroId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    <span class="token keyword">public</span> <span class="token keyword">readonly</span> dragonId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroKilledDragonEvent</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>heroId<span class="token punctuation">,</span> dragonId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">heroId</span> <span class="token operator">=</span> heroId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">dragonId</span> <span class="token operator">=</span> dragonId<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Events are asynchronous. They are dispatched either by <strong>models</strong> or directly using <code>EventBus</code>. In order to dispatch events, models have to extend the <code>AggregateRoot</code> class.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>hero<span class="token punctuation">.</span><span class="token property-access">model</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Hero</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AggregateRoot</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">killEnemy</span><span class="token punctuation">(</span>enemyId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// logic</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">HeroKilledDragonEvent</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">,</span> enemyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Hero</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">AggregateRoot</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">=</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">killEnemy</span><span class="token punctuation">(</span>enemyId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// logic</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">HeroKilledDragonEvent</span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">,</span> enemyId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The <code>apply()</code> method does not dispatch events yet because there's no relationship between the model and the <code>EventPublisher</code> class. How do we associate the model and the publisher? By using a publisher <code>mergeObjectContext()</code> method inside our command handler.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>kill<span class="token operator">-</span>dragon<span class="token punctuation">.</span><span class="token property-access">handler</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CommandHandler</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">KillDragonCommand</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonHandler</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">ICommandHandler</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">KillDragonCommand</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> repository<span class="token operator">:</span> <span class="token maybe-class-name">HeroRepository</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> publisher<span class="token operator">:</span> <span class="token maybe-class-name">EventPublisher</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token operator">:</span> <span class="token maybe-class-name">KillDragonCommand</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> heroId<span class="token punctuation">,</span> dragonId <span class="token punctuation">}</span> <span class="token operator">=</span> command<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">publisher</span><span class="token punctuation">.</span><span class="token method function property-access">mergeObjectContext</span><span class="token punctuation">(</span>
      <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span><span class="token punctuation">.</span><span class="token method function property-access">findOneById</span><span class="token punctuation">(</span><span class="token operator">+</span>heroId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    hero<span class="token punctuation">.</span><span class="token method function property-access">killEnemy</span><span class="token punctuation">(</span>dragonId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hero<span class="token punctuation">.</span><span class="token method function property-access">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CommandHandler</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">KillDragonCommand</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">HeroRepository</span><span class="token punctuation">,</span> <span class="token maybe-class-name">EventPublisher</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">KillDragonHandler</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>repository<span class="token punctuation">,</span> publisher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span> <span class="token operator">=</span> repository<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">publisher</span> <span class="token operator">=</span> publisher<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">execute</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> heroId<span class="token punctuation">,</span> dragonId <span class="token punctuation">}</span> <span class="token operator">=</span> command<span class="token punctuation">;</span>
    <span class="token keyword">const</span> hero <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">publisher</span><span class="token punctuation">.</span><span class="token method function property-access">mergeObjectContext</span><span class="token punctuation">(</span>
      <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">repository</span><span class="token punctuation">.</span><span class="token method function property-access">findOneById</span><span class="token punctuation">(</span><span class="token operator">+</span>heroId<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    hero<span class="token punctuation">.</span><span class="token method function property-access">killEnemy</span><span class="token punctuation">(</span>dragonId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    hero<span class="token punctuation">.</span><span class="token method function property-access">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Now everything works as expected. Notice that we need to <code>commit()</code> events since they're not being dispatched immediately. Obviously, an object doesn't have to exist up front. We can easily merge type context as well:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token maybe-class-name">HeroModel</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">publisher</span><span class="token punctuation">.</span><span class="token method function property-access">mergeClassContext</span><span class="token punctuation">(</span><span class="token maybe-class-name">Hero</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">HeroModel</span></span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now the model has the ability to publish events. Additionally, we can emit events manually using <code>EventBus</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">eventBus</span><span class="token punctuation">.</span><span class="token method function property-access">publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">HeroKilledDragonEvent</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>EventBus</code> is an injectable class.</blockquote><p>Each event can have multiple <strong>Event Handlers</strong>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>hero<span class="token operator">-</span>killed<span class="token operator">-</span>dragon<span class="token punctuation">.</span><span class="token property-access">handler</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">EventsHandler</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">HeroKilledDragonEvent</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroKilledDragonHandler</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">IEventHandler</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">HeroKilledDragonEvent</span><span class="token operator">></span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> repository<span class="token operator">:</span> <span class="token maybe-class-name">HeroRepository</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">handle</span><span class="token punctuation">(</span>event<span class="token operator">:</span> <span class="token maybe-class-name">HeroKilledDragonEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// logic</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Now we can move the <strong>write logic</strong> into the event handlers.<blockquote><p>info <strong>Hint</strong> Be aware that when you start using event handlers you get out of the traditional HTTP web context.<ul><li>Errors in <code>CommandHandlers</code> can still be caught by built-in <a href="/exception-filters">Exception filters</a>.<li>Errors in <code>EventHandlers</code> can't be caught by Exception filters: you will have to handle them manually. Either by a simple <code>try/catch</code>, using <a href="/recipes/cqrs#sagas">Sagas</a> by triggering a compensating event, or whatever other solution you choose.<li>HTTP Responses in <code>CommandHandlers</code> can still be sent back to the client.<li>HTTP Responses in <code>EventHandlers</code> cannot. If you want to send information to the client you could use <a href="/websockets/gateways">WebSocket</a>, <a href="/techniques/server-sent-events">SSE</a>, or whatever other solution you choose.</ul></blockquote></section><section id="sagas"class="level4"><h4>Sagas</h4><p>This type of <strong>Event-Driven Architecture</strong> improves application <strong>reactiveness and scalability</strong>. Now, when we have events, we can simply react to them in various ways. <strong>Sagas</strong> are the final building block from an architectural point of view.<p>Sagas are an extremely powerful feature. A single saga may listen for 1..* events. Using the <a href="https://github.com/ReactiveX/rxjs">RxJS</a> library, it can combine, merge, filter or apply other <code>RxJS</code> operators on the event stream. Each saga returns an Observable which contains a command. This command is dispatched <strong>asynchronously</strong>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token operator">-</span>game<span class="token punctuation">.</span><span class="token property-access">saga</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesGameSagas</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Saga</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  dragonKilled <span class="token operator">=</span> <span class="token punctuation">(</span>events$<span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Observable</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ICommand</span><span class="token operator">></span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> events$<span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>
      <span class="token function">ofType</span><span class="token punctuation">(</span><span class="token maybe-class-name">HeroKilledDragonEvent</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DropAncientItemCommand</span></span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">heroId</span><span class="token punctuation">,</span> fakeItemID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesGameSagas</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Saga</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token function-variable function">dragonKilled</span> <span class="token operator">=</span> <span class="token punctuation">(</span>events$<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> events$<span class="token punctuation">.</span><span class="token method function property-access">pipe</span><span class="token punctuation">(</span>
      <span class="token function">ofType</span><span class="token punctuation">(</span><span class="token maybe-class-name">HeroKilledDragonEvent</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DropAncientItemCommand</span></span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token property-access">heroId</span><span class="token punctuation">,</span> fakeItemID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>ofType</code> operator is exported from the <code>@nestjs/cqrs</code> package.</blockquote><p>We declared a rule - when any hero kills the dragon, the ancient item should be dropped. With this in place, <code>DropAncientItemCommand</code> will be dispatched and processed by the appropriate handler.</section><section id="queries"class="level4"><h4>Queries</h4><p>The <code>CqrsModule</code> can also be used for handling queries. The <code>QueryBus</code> follows the same pattern as the <code>CommandsBus</code>. Query handlers should implement the <code>IQueryHandler</code> interface and be marked with the <code>@QueryHandler()</code> decorator.</section><section id="setup"class="level4"><h4>Setup</h4><p>Finally, let's look at how to set up the whole CQRS mechanism.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>heroes<span class="token operator">-</span>game<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">CommandHandlers</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token maybe-class-name">KillDragonHandler</span><span class="token punctuation">,</span> <span class="token maybe-class-name">DropAncientItemHandler</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">EventHandlers</span> <span class="token operator">=</span>  <span class="token punctuation">[</span><span class="token maybe-class-name">HeroKilledDragonHandler</span><span class="token punctuation">,</span> <span class="token maybe-class-name">HeroFoundItemHandler</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CqrsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">HeroesGameController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">HeroesGameService</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">HeroesGameSagas</span><span class="token punctuation">,</span>
    <span class="token spread operator">...</span><span class="token maybe-class-name">CommandHandlers</span><span class="token punctuation">,</span>
    <span class="token spread operator">...</span><span class="token maybe-class-name">EventHandlers</span><span class="token punctuation">,</span>
    <span class="token maybe-class-name">HeroRepository</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">HeroesGameModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="summary"class="level4"><h4>Summary</h4><p><code>CommandBus</code>, <code>QueryBus</code> and <code>EventBus</code> are <strong>Observables</strong>. This means that you can easily subscribe to the whole stream and enrich your application with <strong>Event Sourcing</strong>.</section><section id="example"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/kamilmysliwiec/nest-cqrs-example">here</a>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>