<!doctype html><html lang="en"><meta charset="utf-8"><title>SQL (TypeORM)</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="sql-typeorm"class="level3"><h3>SQL (TypeORM)</h3><section id="this-chapter-applies-only-to-typescript"class="level5"><h5>This chapter applies only to TypeScript</h5><blockquote><p><strong>Warning</strong> In this article, you'll learn how to create a <code>DatabaseModule</code> based on the <strong>TypeORM</strong> package from scratch using custom providers mechanism. As a consequence, this solution contains a lot of overhead that you can omit using ready to use and available out-of-the-box dedicated <code>@nestjs/typeorm</code> package. To learn more, see <a href="/techniques/sql">here</a>.</blockquote><p><a href="https://github.com/typeorm/typeorm">TypeORM</a> is definitely the most mature Object Relational Mapper (ORM) available in the node.js world. Since it's written in TypeScript, it works pretty well with the Nest framework.</section><section id="getting-started"class="level4"><h4>Getting started</h4><p>To start the adventure with this library we have to install all required dependencies:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> <span class="token function">install</span> --save typeorm mysql2</code></pre><p>The first step we need to do is to establish the connection with our database using <code>new DataSource().initialize()</code> class imported from the <code>typeorm</code> package. The <code>initialize()</code> function returns a <code>Promise</code>, and therefore we have to create an <a href="/fundamentals/async-components">async provider</a>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token property-access">providers</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DataSource</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> databaseProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'DATA_SOURCE'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">DataSource</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'mysql'</span><span class="token punctuation">,</span>
        host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
        port<span class="token operator">:</span> <span class="token number">3306</span><span class="token punctuation">,</span>
        username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        database<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
        entities<span class="token operator">:</span> <span class="token punctuation">[</span>
            __dirname <span class="token operator">+</span> <span class="token string">'/../**/*.entity{.ts,.js}'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        synchronize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword control-flow">return</span> dataSource<span class="token punctuation">.</span><span class="token method function property-access">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Warning</strong> Setting <code>synchronize: true</code> shouldn't be used in production - otherwise you can lose production data.</blockquote><blockquote><p>info <strong>Hint</strong> Following best practices, we declared the custom provider in the separated file which has a <code>*.providers.ts</code> suffix.</blockquote><p>Then, we need to export these providers to make them <strong>accessible</strong> for the rest of the application.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> databaseProviders <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./database.providers'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>databaseProviders<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>databaseProviders<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">DatabaseModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now we can inject the <code>DATA_SOURCE</code> object using <code>@Inject()</code> decorator. Each class that would depend on the <code>DATA_SOURCE</code> async provider will wait until a <code>Promise</code> is resolved.</section><section id="repository-pattern"class="level4"><h4>Repository pattern</h4><p>The <a href="https://github.com/typeorm/typeorm">TypeORM</a> supports the repository design pattern, thus each entity has its own Repository. These repositories can be obtained from the database connection.<p>But firstly, we need at least one entity. We are going to reuse the <code>Photo</code> entity from the official documentation.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>photo<span class="token punctuation">.</span><span class="token property-access">entity</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Entity</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Column</span><span class="token punctuation">,</span> <span class="token maybe-class-name">PrimaryGeneratedColumn</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Entity</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Photo</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">PrimaryGeneratedColumn</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>
  description<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  filename<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token string">'int'</span><span class="token punctuation">)</span>
  views<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>

  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Column</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  isPublished<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>Photo</code> entity belongs to the <code>photo</code> directory. This directory represents the <code>PhotoModule</code>. Now, let's create a <strong>Repository</strong> provider:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>photo<span class="token punctuation">.</span><span class="token property-access">providers</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DataSource</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Photo</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./photo.entity'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> photoProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'PHOTO_REPOSITORY'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>dataSource<span class="token operator">:</span> <span class="token maybe-class-name">DataSource</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> dataSource<span class="token punctuation">.</span><span class="token method function property-access">getRepository</span><span class="token punctuation">(</span><span class="token maybe-class-name">Photo</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'DATA_SOURCE'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Warning</strong> In the real-world applications you should avoid <strong>magic strings</strong>. Both <code>PHOTO_REPOSITORY</code> and <code>DATA_SOURCE</code> should be kept in the separated <code>constants.ts</code> file.</blockquote><p>Now we can inject the <code>Repository&#x3C;Photo></code> to the <code>PhotoService</code> using the <code>@Inject()</code> decorator:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>photo<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Inject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Repository</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'typeorm'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Photo</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./photo.entity'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PhotoService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'PHOTO_REPOSITORY'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> photoRepository<span class="token operator">:</span> <span class="token maybe-class-name">Repository</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photo</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Photo</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">photoRepository</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>The database connection is <strong>asynchronous</strong>, but Nest makes this process completely invisible for the end-user. The <code>PhotoRepository</code> is waiting for the db connection, and the <code>PhotoService</code> is delayed until repository is ready to use. The entire application can start when each class is instantiated.<p>Here is a final <code>PhotoModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>photo<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DatabaseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../database/database.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> photoProviders <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./photo.providers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">PhotoService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./photo.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">DatabaseModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token spread operator">...</span>photoProviders<span class="token punctuation">,</span>
    <span class="token maybe-class-name">PhotoService</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PhotoModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Do not forget to import the <code>PhotoModule</code> into the root <code>AppModule</code>. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>