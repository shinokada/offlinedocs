<!doctype html><html lang="en"><meta charset="utf-8"><title>MongoDB (Mongoose)</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="mongodb-mongoose"class="level3"><h3>MongoDB (Mongoose)</h3><blockquote><p><strong>Warning</strong> In this article, you'll learn how to create a <code>DatabaseModule</code> based on the <strong>Mongoose</strong> package from scratch using custom components. As a consequence, this solution contains a lot of overhead that you can omit using ready to use and available out-of-the-box dedicated <code>@nestjs/mongoose</code> package. To learn more, see <a href="/techniques/mongodb">here</a>.</blockquote><p><a href="https://mongoosejs.com">Mongoose</a> is the most popular <a href="https://www.mongodb.org/">MongoDB</a> object modeling tool.<section id="getting-started"class="level4"><h4>Getting started</h4><p>To start the adventure with this library we have to install all required dependencies:<pre class="language-typescript"><code class="language-typescript">$ npm install <span class="token operator">--</span>save mongoose</code></pre><p>The first step we need to do is to establish the connection with our database using <code>connect()</code> function. The <code>connect()</code> function returns a <code>Promise</code>, and therefore we have to create an <a href="/fundamentals/async-components">async provider</a>.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token property-access">providers</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mongoose</span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> databaseProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'DATABASE_CONNECTION'</span><span class="token punctuation">,</span>
    useFactory<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> mongoose<span class="token operator">></span> <span class="token arrow operator">=></span>
      mongoose<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost/nest'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mongoose</span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> databaseProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'DATABASE_CONNECTION'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> mongoose<span class="token punctuation">.</span><span class="token method function property-access">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost/nest'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Following best practices, we declared the custom provider in the separated file which has a <code>*.providers.ts</code> suffix.</blockquote><p>Then, we need to export these providers to make them <strong>accessible</strong> for the rest part of the application.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>database<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> databaseProviders <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./database.providers'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>databaseProviders<span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token spread operator">...</span>databaseProviders<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">DatabaseModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Now we can inject the <code>Connection</code> object using <code>@Inject()</code> decorator. Each class that would depend on the <code>Connection</code> async provider will wait until a <code>Promise</code> is resolved.</section><section id="model-injection"class="level4"><h4>Model injection</h4><p>With Mongoose, everything is derived from a <a href="https://mongoosejs.com/docs/guide.html">Schema</a>. Let's define the <code>CatSchema</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>schemas<span class="token operator">/</span>cat<span class="token punctuation">.</span><span class="token property-access">schema</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> mongoose</span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token maybe-class-name">CatSchema</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose</span><span class="token punctuation">.</span><span class="token method function property-access"><span class="token maybe-class-name">Schema</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token known-class-name class-name">Number</span><span class="token punctuation">,</span>
  breed<span class="token operator">:</span> <span class="token known-class-name class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>CatsSchema</code> belongs to the <code>cats</code> directory. This directory represents the <code>CatsModule</code>.<p>Now it's time to create a <strong>Model</strong> provider:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">providers</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Connection</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatSchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./schemas/cat.schema'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> catsProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'CAT_MODEL'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>connection<span class="token operator">:</span> <span class="token maybe-class-name">Connection</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> connection<span class="token punctuation">.</span><span class="token method function property-access">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">CatSchema</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'DATABASE_CONNECTION'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatSchema</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./schemas/cat.schema'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> catsProviders <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token string">'CAT_MODEL'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">useFactory</span><span class="token operator">:</span> <span class="token punctuation">(</span>connection<span class="token punctuation">)</span> <span class="token arrow operator">=></span> connection<span class="token punctuation">.</span><span class="token method function property-access">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> <span class="token maybe-class-name">CatSchema</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'DATABASE_CONNECTION'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Warning</strong> In the real-world applications you should avoid <strong>magic strings</strong>. Both <code>CAT_MODEL</code> and <code>DATABASE_CONNECTION</code> should be kept in the separated <code>constants.ts</code> file.</blockquote><p>Now we can inject the <code>CAT_MODEL</code> to the <code>CatsService</code> using the <code>@Inject()</code> decorator:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">service</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Model</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Inject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Cat</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./interfaces/cat.interface'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CreateCatDto</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./dto/create-cat.dto'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'CAT_MODEL'</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> catModel<span class="token operator">:</span> <span class="token maybe-class-name">Model</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token operator">></span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> createdCat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span><span class="token method function property-access">catModel</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> createdCat<span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Cat</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token string">'CAT_MODEL'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>catModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span> <span class="token operator">=</span> catModel<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> createdCat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token keyword">this</span></span><span class="token punctuation">.</span><span class="token method function property-access">catModel</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> createdCat<span class="token punctuation">.</span><span class="token method function property-access">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catModel</span><span class="token punctuation">.</span><span class="token method function property-access">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In the above example we have used the <code>Cat</code> interface. This interface extends the <code>Document</code> from the mongoose package:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Document</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'mongoose'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">Cat</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">Document</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">readonly</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  <span class="token keyword">readonly</span> breed<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The database connection is <strong>asynchronous</strong>, but Nest makes this process completely invisible for the end-user. The <code>CatModel</code> class is waiting for the db connection, and the <code>CatsService</code> is delayed until model is ready to use. The entire application can start when each class is instantiated.<p>Here is a final <code>CatsModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> catsProviders <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.providers'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DatabaseModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../database/database.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">DatabaseModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">CatsService</span><span class="token punctuation">,</span>
    <span class="token spread operator">...</span>catsProviders<span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Do not forget to import the <code>CatsModule</code> into the root <code>AppModule</code>.</blockquote></section><section id="example"class="level4"><h4>Example</h4><p>A working example is available <a href="https://github.com/nestjs/nest/tree/master/sample/14-mongoose-base">here</a>.<span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>