<!doctype html><html lang="en"><meta charset="utf-8"><title>Middleware</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="middleware"class="level3"><h3>Middleware</h3><p>Middleware is a function which is called <strong>before</strong> the route handler. Middleware functions have access to the <a href="https://expressjs.com/en/4x/api.html#req">request</a> and <a href="https://expressjs.com/en/4x/api.html#res">response</a> objects, and the <code>next()</code> middleware function in the applicationâ€™s request-response cycle. The <strong>next</strong> middleware function is commonly denoted by a variable named <code>next</code>.<figure><img src="/Users/shinichiokada/Bash_Projects/markdown-docs-as-pdf/.vivliostyle/nestjs/en/src/assets/Middlewares_1.png"></figure><p>Nest middleware are, by default, equivalent to <a href="https://expressjs.com/en/guide/using-middleware.html">express</a> middleware. The following description from the official express documentation describes the capabilities of middleware:<blockquote class="external">Middleware functions can perform the following tasks:<ul><li>execute any code.<li>make changes to the request and the response objects.<li>end the request-response cycle.<li>call the next middleware function in the stack.<li>if the current middleware function does not end the request-response cycle, it must call <code>next()</code> to pass control to the next middleware function. Otherwise, the request will be left hanging.</ul></blockquote><p>You implement custom Nest middleware in either a function, or in a class with an <code>@Injectable()</code> decorator. The class should implement the <code>NestMiddleware</code> interface, while the function does not have any special requirements. Let's start by implementing a simple middleware feature using the class method.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token property-access">middleware</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NextFunction</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LoggerMiddleware</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">NestMiddleware</span></span> <span class="token punctuation">{</span>
  <span class="token function">use</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> res<span class="token operator">:</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token maybe-class-name">NextFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Request...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">LoggerMiddleware</span></span> <span class="token punctuation">{</span>
  <span class="token function">use</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Request...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><section id="dependency-injection"class="level4"><h4>Dependency injection</h4><p>Nest middleware fully supports Dependency Injection. Just as with providers and controllers, they are able to <strong>inject dependencies</strong> that are available within the same module. As usual, this is done through the <code>constructor</code>.</section><section id="applying-middleware"class="level4"><h4>Applying middleware</h4><p>There is no place for middleware in the <code>@Module()</code> decorator. Instead, we set them up using the <code>configure()</code> method of the module class. Modules that include middleware have to implement the <code>NestModule</code> interface. Let's set up the <code>LoggerMiddleware</code> at the <code>AppModule</code> level.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MiddlewareConsumer</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LoggerMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">NestModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareConsumer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LoggerMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>In the above example we have set up the <code>LoggerMiddleware</code> for the <code>/cats</code> route handlers that were previously defined inside the <code>CatsController</code>. We may also further restrict a middleware to a particular request method by passing an object containing the route <code>path</code> and request <code>method</code> to the <code>forRoutes()</code> method when configuring the middleware. In the example below, notice that we import the <code>RequestMethod</code> enum to reference the desired request method type.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MiddlewareConsumer</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LoggerMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">NestModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareConsumer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'cats'</span><span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">RequestMethod</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LoggerMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'cats'</span><span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>configure()</code> method can be made asynchronous using <code>async/await</code> (e.g., you can <code>await</code> completion of an asynchronous operation inside the <code>configure()</code> method body).</blockquote><blockquote><p>warning <strong>Warning</strong> When using the <code>express</code> adapter, the NestJS app will register <code>json</code> and <code>urlencoded</code> from the package <code>body-parser</code> by default. This means if you want to customize that middleware via the <code>MiddlewareConsumer</code>, you need to turn off the global middleware by setting the <code>bodyParser</code> flag to <code>false</code> when creating the application with <code>NestFactory.create()</code>.</blockquote></section><section id="route-wildcards"class="level4"><h4>Route wildcards</h4><p>Pattern based routes are supported as well. For instance, the asterisk is used as a <strong>wildcard</strong>, and will match any combination of characters:<pre class="language-typescript"><code class="language-typescript"><span class="token function">forRoutes</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'ab*cd'</span><span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">ALL</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>'ab*cd'</code> route path will match <code>abcd</code>, <code>ab_cd</code>, <code>abecd</code>, and so on. The characters <code>?</code>, <code>+</code>, <code>*</code>, and <code>()</code> may be used in a route path, and are subsets of their regular expression counterparts. The hyphen ( <code>-</code>) and the dot (<code>.</code>) are interpreted literally by string-based paths.<blockquote><p>warning <strong>Warning</strong> The <code>fastify</code> package uses the latest version of the <code>path-to-regexp</code> package, which no longer supports wildcard asterisks <code>*</code>. Instead, you must use parameters (e.g., <code>(.*)</code>, <code>:splat*</code>).</blockquote></section><section id="middleware-consumer"class="level4"><h4>Middleware consumer</h4><p>The <code>MiddlewareConsumer</code> is a helper class. It provides several built-in methods to manage middleware. All of them can be simply <strong>chained</strong> in the <a href="https://en.wikipedia.org/wiki/Fluent_interface">fluent style</a>. The <code>forRoutes()</code> method can take a single string, multiple strings, a <code>RouteInfo</code> object, a controller class and even multiple controller classes. In most cases you'll probably just pass a list of <strong>controllers</strong> separated by commas. Below is an example with a single controller:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NestModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MiddlewareConsumer</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LoggerMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.controller'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">NestModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token operator">:</span> <span class="token maybe-class-name">MiddlewareConsumer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">LoggerMiddleware</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./common/middleware/logger.middleware'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats/cats.controller'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    consumer
      <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>apply()</code> method may either take a single middleware, or multiple arguments to specify <a href="/middleware#multiple-middleware">multiple middlewares</a>.</blockquote></section><section id="excluding-routes"class="level4"><h4>Excluding routes</h4><p>At times we want to <strong>exclude</strong> certain routes from having the middleware applied. We can easily exclude certain routes with the <code>exclude()</code> method. This method can take a single string, multiple strings, or a <code>RouteInfo</code> object identifying routes to be excluded, as shown below:<pre class="language-typescript"><code class="language-typescript">consumer
  <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token maybe-class-name">LoggerMiddleware</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">exclude</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'cats'</span><span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">GET</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'cats'</span><span class="token punctuation">,</span> method<span class="token operator">:</span> <span class="token maybe-class-name">RequestMethod</span><span class="token punctuation">.</span><span class="token constant">POST</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'cats/(.*)'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>exclude()</code> method supports wildcard parameters using the <a href="https://github.com/pillarjs/path-to-regexp#parameters">path-to-regexp</a> package.</blockquote><p>With the example above, <code>LoggerMiddleware</code> will be bound to all routes defined inside <code>CatsController</code> <strong>except</strong> the three passed to the <code>exclude()</code> method.</section><section id="functional-middleware"class="level4"><h4>Functional middleware</h4><p>The <code>LoggerMiddleware</code> class we've been using is quite simple. It has no members, no additional methods, and no dependencies. Why can't we just define it in a simple function instead of a class? In fact, we can. This type of middleware is called <strong>functional middleware</strong>. Let's transform the logger middleware from class-based into functional middleware to illustrate the difference:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token property-access">middleware</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> <span class="token maybe-class-name">NextFunction</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'express'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span>req<span class="token operator">:</span> <span class="token maybe-class-name">Request</span><span class="token punctuation">,</span> res<span class="token operator">:</span> <span class="token maybe-class-name">Response</span><span class="token punctuation">,</span> next<span class="token operator">:</span> <span class="token maybe-class-name">NextFunction</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">function</span> <span class="token function">logger</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Request...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>And use it within the <code>AppModule</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token punctuation">)</span>
consumer
  <span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Consider using the simpler <strong>functional middleware</strong> alternative any time your middleware doesn't need any dependencies.</blockquote></section><section id="multiple-middleware"class="level4"><h4>Multiple middleware</h4><p>As mentioned above, in order to bind multiple middleware that are executed sequentially, simply provide a comma separated list inside the <code>apply()</code> method:<pre class="language-typescript"><code class="language-typescript">consumer<span class="token punctuation">.</span><span class="token method function property-access">apply</span><span class="token punctuation">(</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">helmet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">forRoutes</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></section><section id="global-middleware"class="level4"><h4>Global middleware</h4><p>If we want to bind middleware to every registered route at once, we can use the <code>use()</code> method that is supplied by the <code>INestApplication</code> instance:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>main<span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Accessing the DI container in a global middleware is not possible. You can use a <a href="middleware#functional-middleware">functional middleware</a> instead when using <code>app.use()</code>. Alternatively, you can use a class middleware and consume it with <code>.forRoutes('*')</code> within the <code>AppModule</code> (or any other module). <span style="float:footnote"><a href="./index.html#toc">Go to TOC</a></span></blockquote></section></section>