<!doctype html><html lang="en"><meta charset="utf-8"><title>Authorization</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="authorization"class="level3"><h3>Authorization</h3><p><strong>Authorization</strong> refers to the process that determines what a user is able to do. For example, an administrative user is allowed to create, edit, and delete posts. A non-administrative user is only authorized to read the posts.<p>Authorization is orthogonal and independent from authentication. However, authorization requires an authentication mechanism.<p>There are many different approaches and strategies to handle authorization. The approach taken for any project depends on its particular application requirements. This chapter presents a few approaches to authorization that can be adapted to a variety of different requirements.<section id="basic-rbac-implementation"class="level4"><h4>Basic RBAC implementation</h4><p>Role-based access control (<strong>RBAC</strong>) is a policy-neutral access-control mechanism defined around roles and privileges. In this section, we'll demonstrate how to implement a very basic RBAC mechanism using Nest <a href="/guards">guards</a>.<p>First, let's create a <code>Role</code> enum representing roles in the system:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>role<span class="token punctuation">.</span><span class="token property-access">enum</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">enum</span> <span class="token maybe-class-name">Role</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">User</span> <span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Admin</span> <span class="token operator">=</span> <span class="token string">'admin'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> In more sophisticated systems, you may store roles within a database, or pull them from the external authentication provider.</blockquote><p>With this in place, we can create a <code>@Roles()</code> decorator. This decorator allows specifying what roles are required to access specific resources.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token property-access">decorator</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SetMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Role</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../enums/role.enum'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">ROLES_KEY</span> <span class="token operator">=</span> <span class="token string">'roles'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Roles</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token spread operator">...</span>roles<span class="token operator">:</span> <span class="token maybe-class-name">Role</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function"><span class="token maybe-class-name">SetMetadata</span></span><span class="token punctuation">(</span><span class="token constant">ROLES_KEY</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SetMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">ROLES_KEY</span> <span class="token operator">=</span> <span class="token string">'roles'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Roles</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token spread operator">...</span>roles<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function"><span class="token maybe-class-name">SetMetadata</span></span><span class="token punctuation">(</span><span class="token constant">ROLES_KEY</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now that we have a custom <code>@Roles()</code> decorator, we can use it to decorate any route handler.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Role</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Admin</span></span><span class="token punctuation">)</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Role</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Admin</span></span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Finally, we create a <code>RolesGuard</code> class which will compare the roles assigned to the current user to the actual roles required by the current route being processed. In order to access the route's role(s) (custom metadata), we'll use the <code>Reflector</code> helper class, which is provided out of the box by the framework and exposed from the <code>@nestjs/core</code> package.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token property-access">guard</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">CanActivate</span><span class="token punctuation">,</span> <span class="token maybe-class-name">ExecutionContext</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Reflector</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">RolesGuard</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">CanActivate</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> reflector<span class="token operator">:</span> <span class="token maybe-class-name">Reflector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> requiredRoles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getAllAndOverride</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Role</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token constant">ROLES_KEY</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>requiredRoles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> requiredRoles<span class="token punctuation">.</span><span class="token method function property-access">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span> <span class="token arrow operator">=></span> user<span class="token punctuation">.</span><span class="token property-access">roles</span><span class="token operator">?.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Dependencies</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Reflector</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Reflector</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">RolesGuard</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>reflector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span> <span class="token operator">=</span> reflector<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> requiredRoles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token method function property-access">getAllAndOverride</span><span class="token punctuation">(</span><span class="token constant">ROLES_KEY</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>requiredRoles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">return</span> requiredRoles<span class="token punctuation">.</span><span class="token method function property-access">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span> <span class="token arrow operator">=></span> user<span class="token punctuation">.</span><span class="token property-access">roles</span><span class="token punctuation">.</span><span class="token method function property-access">includes</span><span class="token punctuation">(</span>role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Refer to the <a href="/fundamentals/execution-context#reflection-and-metadata">Reflection and metadata</a> section of the Execution context chapter for more details on utilizing <code>Reflector</code> in a context-sensitive way.</blockquote><blockquote><p>warning <strong>Notice</strong> This example is named "<strong>basic</strong>" as we only check for the presence of roles on the route handler level. In real-world applications, you may have endpoints/handlers that involve several operations, in which each of them requires a specific set of permissions. In this case, you'll have to provide a mechanism to check roles somewhere within your business-logic, making it somewhat harder to maintain as there will be no centralized place that associates permissions with specific actions.</blockquote><p>In this example, we assumed that <code>request.user</code> contains the user instance and allowed roles (under the <code>roles</code> property). In your app, you will probably make that association in your custom <strong>authentication guard</strong> - see <a href="/security/authentication">authentication</a> chapter for more details.<p>To make sure this example works, your <code>User</code> class must look as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  <span class="token comment">// ...other properties</span>
  roles<span class="token operator">:</span> <span class="token maybe-class-name">Role</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Lastly, make sure to register the <code>RolesGuard</code>, for example, at the controller level, or globally:<pre class="language-typescript"><code class="language-typescript">providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">APP_GUARD</span><span class="token punctuation">,</span>
    useClass<span class="token operator">:</span> <span class="token maybe-class-name">RolesGuard</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><p>When a user with insufficient privileges requests an endpoint, Nest automatically returns the following response:<pre class="language-typescript"><code class="language-typescript"><span class="token punctuation">{</span>
  <span class="token string-property property">"statusCode"</span><span class="token operator">:</span> <span class="token number">403</span><span class="token punctuation">,</span>
  <span class="token string-property property">"message"</span><span class="token operator">:</span> <span class="token string">"Forbidden resource"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"error"</span><span class="token operator">:</span> <span class="token string">"Forbidden"</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> If you want to return a different error response, you should throw your own specific exception instead of returning a boolean value.</blockquote><p><app-banner-courses-auth></app-banner-courses-auth></section><section id="claims-based-authorization"class="level4"><h4>Claims-based authorization</h4><p>When an identity is created it may be assigned one or more claims issued by a trusted party. A claim is a name-value pair that represents what the subject can do, not what the subject is.<p>To implement a Claims-based authorization in Nest, you can follow the same steps we have shown above in the <a href="/security/authorization#basic-rbac-implementation">RBAC</a> section with one significant difference: instead of checking for specific roles, you should compare <strong>permissions</strong>. Every user would have a set of permissions assigned. Likewise, each resource/endpoint would define what permissions are required (for example, through a dedicated <code>@RequirePermissions()</code> decorator) to access them.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">RequirePermissions</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Permission</span><span class="token punctuation">.</span><span class="token constant">CREATE_CAT</span><span class="token punctuation">)</span>
<span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">RequirePermissions</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Permission</span><span class="token punctuation">.</span><span class="token constant">CREATE_CAT</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> In the example above, <code>Permission</code> (similar to <code>Role</code> we have shown in RBAC section) is a TypeScript enum that contains all the permissions available in your system.</blockquote></section><section id="integrating-casl"class="level4"><h4>Integrating CASL</h4><p><a href="https://casl.js.org/">CASL</a> is an isomorphic authorization library which restricts what resources a given client is allowed to access. It's designed to be incrementally adoptable and can easily scale between a simple claim based and fully featured subject and attribute based authorization.<p>To start, first install the <code>@casl/ability</code> package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i @casl/ability</code></pre><blockquote><p>info <strong>Hint</strong> In this example, we chose CASL, but you can use any other library like <code>accesscontrol</code> or <code>acl</code>, depending on your preferences and project needs.</blockquote><p>Once the installation is complete, for the sake of illustrating the mechanics of CASL, we'll define two entity classes: <code>User</code> and <code>Article</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  isAdmin<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>User</code> class consists of two properties, <code>id</code>, which is a unique user identifier, and <code>isAdmin</code>, indicating whether a user has administrator privileges.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">Article</span></span> <span class="token punctuation">{</span>
  id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
  isPublished<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
  authorId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p><code>Article</code> class has three properties, respectively <code>id</code>, <code>isPublished</code>, and <code>authorId</code>. <code>id</code> is a unique article identifier, <code>isPublished</code> indicates whether an article was already published or not, and <code>authorId</code>, which is an ID of a user who wrote the article.<p>Now let's review and refine our requirements for this example:<ul><li>Admins can manage (create/read/update/delete) all entities<li>Users have read-only access to everything<li>Users can update their articles (<code>article.authorId === userId</code>)<li>Articles that are published already cannot be removed (<code>article.isPublished === true</code>)</ul><p>With this in mind, we can start off by creating an <code>Action</code> enum representing all possible actions that the users can perform with entities:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">enum</span> <span class="token maybe-class-name">Action</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">Manage</span> <span class="token operator">=</span> <span class="token string">'manage'</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Create</span> <span class="token operator">=</span> <span class="token string">'create'</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Read</span> <span class="token operator">=</span> <span class="token string">'read'</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Update</span> <span class="token operator">=</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">Delete</span> <span class="token operator">=</span> <span class="token string">'delete'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> <code>manage</code> is a special keyword in CASL which represents "any" action.</blockquote><p>To encapsulate CASL library, let's generate the <code>CaslModule</code> and <code>CaslAbilityFactory</code> now.<pre class="language-bash"><code class="language-bash">$ nest g module casl
$ nest g class casl/casl-ability.factory</code></pre><p>With this in place, we can define the <code>createForUser()</code> method on the <code>CaslAbilityFactory</code>. This method will create the <code>Ability</code> object for a given user:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">Subjects</span></span> <span class="token operator">=</span> <span class="token maybe-class-name">InferSubjects</span><span class="token operator">&#x3C;</span><span class="token keyword">typeof</span> <span class="token maybe-class-name">Article</span> <span class="token operator">|</span> <span class="token keyword">typeof</span> <span class="token maybe-class-name">User</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token string">'all'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">AppAbility</span></span> <span class="token operator">=</span> <span class="token maybe-class-name">Ability</span><span class="token operator">&#x3C;</span><span class="token punctuation">[</span><span class="token maybe-class-name">Action</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Subjects</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CaslAbilityFactory</span></span> <span class="token punctuation">{</span>
  <span class="token function">createForUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> <span class="token maybe-class-name">User</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> can<span class="token punctuation">,</span> cannot<span class="token punctuation">,</span> build <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">AbilityBuilder</span><span class="token operator">&#x3C;</span>
      <span class="token maybe-class-name">Ability</span><span class="token operator">&#x3C;</span><span class="token punctuation">[</span><span class="token maybe-class-name">Action</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Subjects</span><span class="token punctuation">]</span><span class="token operator">></span>
    <span class="token operator">></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Ability</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">AbilityClass</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">AppAbility</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token property-access">isAdmin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Manage</span></span><span class="token punctuation">,</span> <span class="token string">'all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// read-write access to everything</span>
    <span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token punctuation">{</span>
      <span class="token function">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Read</span></span><span class="token punctuation">,</span> <span class="token string">'all'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// read-only access to everything</span>
    <span class="token punctuation">}</span>

    <span class="token function">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Update</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> authorId<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cannot</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Delete</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isPublished<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// Read https://casl.js.org/v5/en/guide/subject-type-detection#use-classes-as-subject-types for details</span>
      <span class="token function-variable function">detectSubjectType</span><span class="token operator">:</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token arrow operator">=></span>
        item<span class="token punctuation">.</span><span class="token property-access">constructor</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">ExtractSubjectType</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Subjects</span><span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> <code>all</code> is a special keyword in CASL that represents "any subject".</blockquote><blockquote><p>info <strong>Hint</strong> <code>Ability</code>, <code>AbilityBuilder</code>, <code>AbilityClass</code>, and <code>ExtractSubjectType</code> classes are exported from the <code>@casl/ability</code> package.</blockquote><blockquote><p>info <strong>Hint</strong> <code>detectSubjectType</code> option let CASL understand how to get subject type out of an object. For more information read <a href="https://casl.js.org/v5/en/guide/subject-type-detection#use-classes-as-subject-types">CASL documentation</a> for details.</blockquote><p>In the example above, we created the <code>Ability</code> instance using the <code>AbilityBuilder</code> class. As you probably guessed, <code>can</code> and <code>cannot</code> accept the same arguments but have different meanings, <code>can</code> allows to do an action on the specified subject and <code>cannot</code> forbids. Both may accept up to 4 arguments. To learn more about these functions, visit the official <a href="https://casl.js.org/v5/en/guide/intro">CASL documentation</a>.<p>Lastly, make sure to add the <code>CaslAbilityFactory</code> to the <code>providers</code> and <code>exports</code> arrays in the <code>CaslModule</code> module definition:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CaslAbilityFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./casl-ability.factory'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CaslAbilityFactory</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CaslAbilityFactory</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CaslModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>With this in place, we can inject the <code>CaslAbilityFactory</code> to any class using standard constructor injection as long as the <code>CaslModule</code> is imported in the host context:<pre class="language-typescript"><code class="language-typescript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> caslAbilityFactory<span class="token operator">:</span> <span class="token maybe-class-name">CaslAbilityFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Then use it in a class as follows.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> ability <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">caslAbilityFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Read</span></span><span class="token punctuation">,</span> <span class="token string">'all'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// "user" has read access to everything</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> Learn more about the <code>Ability</code> class in the official <a href="https://casl.js.org/v5/en/guide/intro">CASL documentation</a>.</blockquote><p>For example, let's say we have a user who is not an admin. In this case, the user should be able to read articles, but creating new ones or removing the existing articles should be prohibited.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token property-access">isAdmin</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ability <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">caslAbilityFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Read</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Delete</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Create</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre><blockquote><p>info <strong>Hint</strong> Although both <code>Ability</code> and <code>AbilityBuilder</code> classes provide <code>can</code> and <code>cannot</code> methods, they have different purposes and accept slightly different arguments.</blockquote><p>Also, as we have specified in our requirements, the user should be able to update its articles:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">User</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
user<span class="token punctuation">.</span><span class="token property-access">id</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> article <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Article</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
article<span class="token punctuation">.</span><span class="token property-access">authorId</span> <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token property-access">id</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> ability <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">caslAbilityFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Update</span></span><span class="token punctuation">,</span> article<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

article<span class="token punctuation">.</span><span class="token property-access">authorId</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Update</span></span><span class="token punctuation">,</span> article<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre><p>As you can see, <code>Ability</code> instance allows us to check permissions in pretty readable way. Likewise, <code>AbilityBuilder</code> allows us to define permissions (and specify various conditions) in a similar fashion. To find more examples, visit the official documentation.</section><section id="advanced-implementing-a-policiesguard"class="level4"><h4>Advanced: Implementing a <code>PoliciesGuard</code></h4><p>In this section, we'll demonstrate how to build a somewhat more sophisticated guard, which checks if a user meets specific <strong>authorization policies</strong> that can be configured on the method-level (you can extend it to respect policies configured on the class-level too). In this example, we are going to use the CASL package just for illustration purposes, but using this library is not required. Also, we will use the <code>CaslAbilityFactory</code> provider that we've created in the previous section.<p>First, let's flesh out the requirements. The goal is to provide a mechanism that allows specifying policy checks per route handler. We will support both objects and functions (for simpler checks and for those who prefer more functional-style code).<p>Let's start off by defining interfaces for policy handlers:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppAbility</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../casl/casl-ability.factory'</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">IPolicyHandler</span></span> <span class="token punctuation">{</span>
  <span class="token function">handle</span><span class="token punctuation">(</span>ability<span class="token operator">:</span> <span class="token maybe-class-name">AppAbility</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">PolicyHandlerCallback</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>ability<span class="token operator">:</span> <span class="token maybe-class-name">AppAbility</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token builtin">boolean</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">type</span> <span class="token class-name"><span class="token maybe-class-name">PolicyHandler</span></span> <span class="token operator">=</span> <span class="token maybe-class-name">IPolicyHandler</span> <span class="token operator">|</span> <span class="token maybe-class-name">PolicyHandlerCallback</span><span class="token punctuation">;</span></code></pre><p>As mentioned above, we provided two possible ways of defining a policy handler, an object (instance of a class that implements the <code>IPolicyHandler</code> interface) and a function (which meets the <code>PolicyHandlerCallback</code> type).<p>With this in place, we can create a <code>@CheckPolicies()</code> decorator. This decorator allows specifying what policies have to be met to access specific resources.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">CHECK_POLICIES_KEY</span> <span class="token operator">=</span> <span class="token string">'check_policy'</span><span class="token punctuation">;</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">CheckPolicies</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token spread operator">...</span>handlers<span class="token operator">:</span> <span class="token maybe-class-name">PolicyHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span>
  <span class="token function"><span class="token maybe-class-name">SetMetadata</span></span><span class="token punctuation">(</span><span class="token constant">CHECK_POLICIES_KEY</span><span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now let's create a <code>PoliciesGuard</code> that will extract and execute all the policy handlers bound to a route handler.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">PoliciesGuard</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">CanActivate</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> reflector<span class="token operator">:</span> <span class="token maybe-class-name">Reflector</span><span class="token punctuation">,</span>
    <span class="token keyword">private</span> caslAbilityFactory<span class="token operator">:</span> <span class="token maybe-class-name">CaslAbilityFactory</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">canActivate</span><span class="token punctuation">(</span>context<span class="token operator">:</span> <span class="token maybe-class-name">ExecutionContext</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token builtin">boolean</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> policyHandlers <span class="token operator">=</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">PolicyHandler</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
        <span class="token constant">CHECK_POLICIES_KEY</span><span class="token punctuation">,</span>
        context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> user <span class="token punctuation">}</span> <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token method function property-access">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> ability <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">caslAbilityFactory</span><span class="token punctuation">.</span><span class="token method function property-access">createForUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword control-flow">return</span> policyHandlers<span class="token punctuation">.</span><span class="token method function property-access">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token arrow operator">=></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">execPolicyHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> ability<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">execPolicyHandler</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> <span class="token maybe-class-name">PolicyHandler</span><span class="token punctuation">,</span> ability<span class="token operator">:</span> <span class="token maybe-class-name">AppAbility</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> handler <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword control-flow">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>ability<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword control-flow">return</span> handler<span class="token punctuation">.</span><span class="token method function property-access">handle</span><span class="token punctuation">(</span>ability<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> In this example, we assumed that <code>request.user</code> contains the user instance. In your app, you will probably make that association in your custom <strong>authentication guard</strong> - see <a href="/security/authentication">authentication</a> chapter for more details.</blockquote><p>Let's break this example down. The <code>policyHandlers</code> is an array of handlers assigned to the method through the <code>@CheckPolicies()</code> decorator. Next, we use the <code>CaslAbilityFactory#create</code> method which constructs the <code>Ability</code> object, allowing us to verify whether a user has sufficient permissions to perform specific actions. We are passing this object to the policy handler which is either a function or an instance of a class that implements the <code>IPolicyHandler</code>, exposing the <code>handle()</code> method that returns a boolean. Lastly, we use the <code>Array#every</code> method to make sure that every handler returned <code>true</code> value.<p>Finally, to test this guard, bind it to any route handler, and register an inline policy handler (functional approach), as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">PoliciesGuard</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CheckPolicies</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>ability<span class="token operator">:</span> <span class="token maybe-class-name">AppAbility</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Read</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">articlesService</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Alternatively, we can define a class which implements the <code>IPolicyHandler</code> interface:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ReadArticlePolicyHandler</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">IPolicyHandler</span></span> <span class="token punctuation">{</span>
  <span class="token function">handle</span><span class="token punctuation">(</span>ability<span class="token operator">:</span> <span class="token maybe-class-name">AppAbility</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> ability<span class="token punctuation">.</span><span class="token method function property-access">can</span><span class="token punctuation">(</span><span class="token maybe-class-name">Action</span><span class="token punctuation">.</span><span class="token property-access"><span class="token maybe-class-name">Read</span></span><span class="token punctuation">,</span> <span class="token maybe-class-name">Article</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>And use it as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">UseGuards</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">PoliciesGuard</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">CheckPolicies</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ReadArticlePolicyHandler</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">articlesService</span><span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>warning <strong>Notice</strong> Since we must instantiate the policy handler in-place using the <code>new</code> keyword, <code>ReadArticlePolicyHandler</code> class cannot use the Dependency Injection. This can be addressed with the <code>ModuleRef#get</code> method (read more <a href="/fundamentals/module-ref">here</a>). Basically, instead of registering functions and instances through the <code>@CheckPolicies()</code> decorator, you must allow passing a <code>Type&#x3C;IPolicyHandler></code>. Then, inside your guard, you could retrieve an instance using a type reference: <code>moduleRef.get(YOUR_HANDLER_TYPE)</code> or even dynamically instantiate it using the <code>ModuleRef#create</code> method. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>