<!doctype html><html lang="en"><meta charset="utf-8"><title>Execution context</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="execution-context"class="level3"><h3>Execution context</h3><p>Nest provides several utility classes that help make it easy to write applications that function across multiple application contexts (e.g., Nest HTTP server-based, microservices and WebSockets application contexts). These utilities provide information about the current execution context which can be used to build generic <a href="/guards">guards</a>, <a href="/exception-filters">filters</a>, and <a href="/interceptors">interceptors</a> that can work across a broad set of controllers, methods, and execution contexts.<p>We cover two such classes in this chapter: <code>ArgumentsHost</code> and <code>ExecutionContext</code>.<section id="argumentshost-class"class="level4"><h4>ArgumentsHost class</h4><p>The <code>ArgumentsHost</code> class provides methods for retrieving the arguments being passed to a handler. It allows choosing the appropriate context (e.g., HTTP, RPC (microservice), or WebSockets) to retrieve the arguments from. The framework provides an instance of <code>ArgumentsHost</code>, typically referenced as a <code>host</code> parameter, in places where you may want to access it. For example, the <code>catch()</code> method of an <a href="https://docs.nestjs.com/exception-filters#arguments-host">exception filter</a> is called with an <code>ArgumentsHost</code>instance.<p><code>ArgumentsHost</code> simply acts as an abstraction over a handler's arguments. For example, for HTTP server applications (when <code>@nestjs/platform-express</code> is being used), the <code>host</code> object encapsulates Express's <code>[request, response, next]</code> array, where <code>request</code> is the request object, <code>response</code> is the response object, and <code>next</code> is a function that controls the application's request-response cycle. On the other hand, for <a href="/graphql/quick-start">GraphQL</a> applications, the <code>host</code> object contains the <code>[root, args, context, info]</code> array.</section><section id="current-application-context"class="level4"><h4>Current application context</h4><p>When building generic <a href="/guards">guards</a>, <a href="/exception-filters">filters</a>, and <a href="/interceptors">interceptors</a> which are meant to run across multiple application contexts, we need a way to determine the type of application that our method is currently running in. Do this with the <code>getType()</code> method of <code>ArgumentsHost</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token method function property-access">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'http'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something that is only important in the context of regular HTTP requests (REST)</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token method function property-access">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'rpc'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something that is only important in the context of Microservice requests</span>
<span class="token punctuation">}</span> <span class="token keyword control-flow">else</span> <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getType</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">GqlContextType</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'graphql'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something that is only important in the context of GraphQL requests</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>GqlContextType</code> is imported from the <code>@nestjs/graphql</code> package.</blockquote><p>With the application type available, we can write more generic components, as shown below.</section><section id="host-handler-arguments"class="level4"><h4>Host handler arguments</h4><p>To retrieve the array of arguments being passed to the handler, one approach is to use the host object's <code>getArgs()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> <span class="token punctuation">[</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">]</span> <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>You can pluck a particular argument by index using the <code>getArgByIndex()</code> method:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> request <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">getArgByIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">getArgByIndex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In these examples we retrieved the request and response objects by index, which is not typically recommended as it couples the application to a particular execution context. Instead, you can make your code more robust and reusable by using one of the <code>host</code> object's utility methods to switch to the appropriate application context for your application. The context switch utility methods are shown below.<pre class="language-typescript"><code class="language-typescript"><span class="token doc-comment comment">/**
 * Switch context to RPC.
 */</span>
<span class="token function">switchToRpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">RpcArgumentsHost</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Switch context to HTTP.
 */</span>
<span class="token function">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">HttpArgumentsHost</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Switch context to WebSockets.
 */</span>
<span class="token function">switchToWs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">WsArgumentsHost</span><span class="token punctuation">;</span></code></pre><p>Let's rewrite the previous example using the <code>switchToHttp()</code> method. The <code>host.switchToHttp()</code> helper call returns an <code>HttpArgumentsHost</code> object that is appropriate for the HTTP application context. The <code>HttpArgumentsHost</code> object has two useful methods we can use to extract the desired objects. We also use the Express type assertions in this case to return native Express typed objects:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> ctx <span class="token operator">=</span> host<span class="token punctuation">.</span><span class="token method function property-access">switchToHttp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> request <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getRequest</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Request</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> response <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getResponse</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">Response</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Similarly <code>WsArgumentsHost</code> and <code>RpcArgumentsHost</code> have methods to return appropriate objects in the microservices and WebSockets contexts. Here are the methods for <code>WsArgumentsHost</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">WsArgumentsHost</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * Returns the data object.
   */</span>
  <span class="token generic-function"><span class="token function">getData</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
  <span class="token doc-comment comment">/**
   * Returns the client object.
   */</span>
  <span class="token generic-function"><span class="token function">getClient</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>Following are the methods for <code>RpcArgumentsHost</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">RpcArgumentsHost</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * Returns the data object.
   */</span>
  <span class="token generic-function"><span class="token function">getData</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>

  <span class="token doc-comment comment">/**
   * Returns the context object.
   */</span>
  <span class="token generic-function"><span class="token function">getContext</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="executioncontext-class"class="level4"><h4>ExecutionContext class</h4><p><code>ExecutionContext</code> extends <code>ArgumentsHost</code>, providing additional details about the current execution process. Like <code>ArgumentsHost</code>, Nest provides an instance of <code>ExecutionContext</code> in places you may need it, such as in the <code>canActivate()</code> method of a <a href="https://docs.nestjs.com/guards#execution-context">guard</a> and the <code>intercept()</code> method of an <a href="https://docs.nestjs.com/interceptors#execution-context">interceptor</a>. It provides the following methods:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ExecutionContext</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">ArgumentsHost</span></span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * Returns the type of the controller class which the current handler belongs to.
   */</span>
  <span class="token generic-function"><span class="token function">getClass</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">Type</span><span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token doc-comment comment">/**
   * Returns a reference to the handler (method) that will be invoked next in the
   * request pipeline.
   */</span>
  <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Function</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>The <code>getHandler()</code> method returns a reference to the handler about to be invoked. The <code>getClass()</code> method returns the type of the <code>Controller</code> class which this particular handler belongs to. For example, in an HTTP context, if the currently processed request is a <code>POST</code> request, bound to the <code>create()</code> method on the <code>CatsController</code>, <code>getHandler()</code> returns a reference to the <code>create()</code> method and <code>getClass()</code> returns the <code>CatsController</code> <strong>type</strong> (not instance).<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> methodKey <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span> <span class="token comment">// "create"</span>
<span class="token keyword">const</span> className <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span> <span class="token comment">// "CatsController"</span></code></pre><p>The ability to access references to both the current class and handler method provides great flexibility. Most importantly, it gives us the opportunity to access the metadata set through the <code>@SetMetadata()</code> decorator from within guards or interceptors. We cover this use case below.<p><app-banner-enterprise></app-banner-enterprise></section><section id="reflection-and-metadata"class="level4"><h4>Reflection and metadata</h4><p>Nest provides the ability to attach <strong>custom metadata</strong> to route handlers through the <code>@SetMetadata()</code> decorator. We can then access this metadata from within our class to make certain decisions.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">SetMetadata</span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">SetMetadata</span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'admin'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>@SetMetadata()</code> decorator is imported from the <code>@nestjs/common</code> package.</blockquote><p>With the construction above, we attached the <code>roles</code> metadata (<code>roles</code> is a metadata key and <code>['admin']</code> is the associated value) to the <code>create()</code> method. While this works, it's not good practice to use <code>@SetMetadata()</code> directly in your routes. Instead, create your own decorators, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token property-access">decorator</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SetMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Roles</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token spread operator">...</span>roles<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function"><span class="token maybe-class-name">SetMetadata</span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">SetMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token function-variable function"><span class="token maybe-class-name">Roles</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token spread operator">...</span>roles<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token function"><span class="token maybe-class-name">SetMetadata</span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> roles<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This approach is much cleaner and more readable, and is strongly typed. Now that we have a custom <code>@Roles()</code> decorator, we can use it to decorate the <code>create()</code> method.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>To access the route's role(s) (custom metadata), we'll use the <code>Reflector</code> helper class, which is provided out of the box by the framework and exposed from the <code>@nestjs/core</code> package. <code>Reflector</code> can be injected into a class in the normal way:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token property-access">guard</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">RolesGuard</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> reflector<span class="token operator">:</span> <span class="token maybe-class-name">Reflector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Dependencies</span></span><span class="token punctuation">(</span><span class="token maybe-class-name">Reflector</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>reflector<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span> <span class="token operator">=</span> reflector<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Hint</strong> The <code>Reflector</code> class is imported from the <code>@nestjs/core</code> package.</blockquote><p>Now, to read the handler metadata, use the <code>get()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>Reflector#get</code> method allows us to easily access the metadata by passing in two arguments: a metadata <strong>key</strong> and a <strong>context</strong> (decorator target) to retrieve the metadata from. In this example, the specified <strong>key</strong> is <code>'roles'</code> (refer back to the <code>roles.decorator.ts</code> file above and the <code>SetMetadata()</code> call made there). The context is provided by the call to <code>context.getHandler()</code>, which results in extracting the metadata for the currently processed route handler. Remember, <code>getHandler()</code> gives us a <strong>reference</strong> to the route handler function.<p>Alternatively, we may organize our controller by applying metadata at the controller level, applying to all routes in the controller class.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsController</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsController</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>In this case, to extract controller metadata, we pass <code>context.getClass()</code> as the second argument (to provide the controller class as the context for metadata extraction) instead of <code>context.getHandler()</code>:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>roles<span class="token punctuation">.</span><span class="token property-access">guard</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">const</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Given the ability to provide metadata at multiple levels, you may need to extract and merge metadata from several contexts. The <code>Reflector</code> class provides two utility methods used to help with this. These methods extract <strong>both</strong> controller and method metadata at once, and combine them in different ways.<p>Consider the following scenario, where you've supplied <code>'roles'</code> metadata at both levels.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsController</span></span> <span class="token punctuation">{</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> createCatDto<span class="token operator">:</span> <span class="token maybe-class-name">CreateCatDto</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Controller</span></span><span class="token punctuation">(</span><span class="token string">'cats'</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">CatsController</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Post</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Roles</span></span><span class="token punctuation">(</span><span class="token string">'admin'</span><span class="token punctuation">)</span>
  <span class="token decorator"><span class="token at operator">@</span><span class="token function">Bind</span></span><span class="token punctuation">(</span><span class="token function"><span class="token maybe-class-name">Body</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">catsService</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span>createCatDto<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>If your intent is to specify <code>'user'</code> as the default role, and override it selectively for certain methods, you would probably use the <code>getAllAndOverride()</code> method.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getAllAndOverride</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>A guard with this code, running in the context of the <code>create()</code> method, with the above metadata, would result in <code>roles</code> containing <code>['admin']</code>.<p>To get metadata for both and merge it (this method merges both arrays and objects), use the <code>getAllAndMerge()</code> method:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> roles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">reflector</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">getAllAndMerge</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token string">'roles'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
  context<span class="token punctuation">.</span><span class="token method function property-access">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  context<span class="token punctuation">.</span><span class="token method function property-access">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This would result in <code>roles</code> containing <code>['user', 'admin']</code>.<p>For both of these merge methods, you pass the metadata key as the first argument, and an array of metadata target contexts (i.e., calls to the <code>getHandler()</code> and/or <code>getClass())</code> methods) as the second argument. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>