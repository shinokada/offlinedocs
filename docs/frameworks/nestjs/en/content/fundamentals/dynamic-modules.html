<!doctype html><html lang="en"><meta charset="utf-8"><title>Dynamic modules</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="dynamic-modules"class="level3"><h3>Dynamic modules</h3><p>The <a href="/modules">Modules chapter</a> covers the basics of Nest modules, and includes a brief introduction to <a href="https://docs.nestjs.com/modules#dynamic-modules">dynamic modules</a>. This chapter expands on the subject of dynamic modules. Upon completion, you should have a good grasp of what they are and how and when to use them.<section id="introduction"class="level4"><h4>Introduction</h4><p>Most application code examples in the <strong>Overview</strong> section of the documentation make use of regular, or static, modules. Modules define groups of components like <a href="/providers">providers</a> and <a href="/controllers">controllers</a> that fit together as a modular part of an overall application. They provide an execution context, or scope, for these components. For example, providers defined in a module are visible to other members of the module without the need to export them. When a provider needs to be visible outside of a module, it is first exported from its host module, and then imported into its consuming module.<p>Let's walk through a familiar example.<p>First, we'll define a <code>UsersModule</code> to provide and export a <code>UsersService</code>. <code>UsersModule</code> is the <strong>host</strong> module for <code>UsersService</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Next, we'll define an <code>AuthModule</code>, which imports <code>UsersModule</code>, making <code>UsersModule</code>'s exported providers available inside <code>AuthModule</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AuthService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">UsersModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AuthService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>These constructs allow us to inject <code>UsersService</code> in, for example, the <code>AuthService</code> that is hosted in <code>AuthModule</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">UsersService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../users/users.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AuthService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> usersService<span class="token operator">:</span> <span class="token maybe-class-name">UsersService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/*
    Implementation that makes use of this.usersService
  */</span>
<span class="token punctuation">}</span></code></pre><p>We'll refer to this as <strong>static</strong> module binding. All the information Nest needs to wire together the modules has already been declared in the host and consuming modules. Let's unpack what's happening during this process. Nest makes <code>UsersService</code> available inside <code>AuthModule</code> by:<ol><li>Instantiating <code>UsersModule</code>, including transitively importing other modules that <code>UsersModule</code> itself consumes, and transitively resolving any dependencies (see <a href="https://docs.nestjs.com/fundamentals/custom-providers">Custom providers</a>).<li>Instantiating <code>AuthModule</code>, and making <code>UsersModule</code>'s exported providers available to components in <code>AuthModule</code> (just as if they had been declared in <code>AuthModule</code>).<li>Injecting an instance of <code>UsersService</code> in <code>AuthService</code>.</ol></section><section id="dynamic-module-use-case"class="level4"><h4>Dynamic module use case</h4><p>With static module binding, there's no opportunity for the consuming module to <strong>influence</strong> how providers from the host module are configured. Why does this matter? Consider the case where we have a general purpose module that needs to behave differently in different use cases. This is analogous to the concept of a "plugin" in many systems, where a generic facility requires some configuration before it can be used by a consumer.<p>A good example with Nest is a <strong>configuration module</strong>. Many applications find it useful to externalize configuration details by using a configuration module. This makes it easy to dynamically change the application settings in different deployments: e.g., a development database for developers, a staging database for the staging/testing environment, etc. By delegating the management of configuration parameters to a configuration module, the application source code remains independent of configuration parameters.<p>The challenge is that the configuration module itself, since it's generic (similar to a "plugin"), needs to be customized by its consuming module. This is where <em>dynamic modules</em> come into play. Using dynamic module features, we can make our configuration module <strong>dynamic</strong> so that the consuming module can use an API to control how the configuration module is customized at the time it is imported.<p>In other words, dynamic modules provide an API for importing one module into another, and customizing the properties and behavior of that module when it is imported, as opposed to using the static bindings we've seen so far.<p><app-banner-shop></app-banner-shop></section><section id="config-module-example"class="level4"><h4>Config module example</h4><p>We'll be using the basic version of the example code from the <a href="https://docs.nestjs.com/techniques/configuration#service">configuration chapter</a> for this section. The completed version as of the end of this chapter is available as a working <a href="https://github.com/nestjs/nest/tree/master/sample/25-dynamic-modules">example here</a>.<p>Our requirement is to make <code>ConfigModule</code> accept an <code>options</code> object to customize it. Here's the feature we want to support. The basic sample hard-codes the location of the <code>.env</code> file to be in the project root folder. Let's suppose we want to make that configurable, such that you can manage your <code>.env</code> files in any folder of your choosing. For example, imagine you want to store your various <code>.env</code> files in a folder under the project root called <code>config</code> (i.e., a sibling folder to <code>src</code>). You'd like to be able to choose different folders when using the <code>ConfigModule</code> in different projects.<p>Dynamic modules give us the ability to pass parameters into the module being imported so we can change its behavior. Let's see how this works. It's helpful if we start from the end-goal of how this might look from the consuming module's perspective, and then work backwards. First, let's quickly review the example of <em>statically</em> importing the <code>ConfigModule</code> (i.e., an approach which has no ability to influence the behavior of the imported module). Pay close attention to the <code>imports</code> array in the <code>@Module()</code> decorator:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config/config.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Let's consider what a <em>dynamic module</em> import, where we're passing in a configuration object, might look like. Compare the difference in the <code>imports</code> array between these two examples:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config/config.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Let's see what's happening in the dynamic example above. What are the moving parts?<ol><li><code>ConfigModule</code> is a normal class, so we can infer that it must have a <strong>static method</strong> called <code>register()</code>. We know it's static because we're calling it on the <code>ConfigModule</code> class, not on an <strong>instance</strong> of the class. Note: this method, which we will create soon, can have any arbitrary name, but by convention we should call it either <code>forRoot()</code> or <code>register()</code>.<li>The <code>register()</code> method is defined by us, so we can accept any input arguments we like. In this case, we're going to accept a simple <code>options</code> object with suitable properties, which is the typical case.<li>We can infer that the <code>register()</code> method must return something like a <code>module</code> since its return value appears in the familiar <code>imports</code> list, which we've seen so far includes a list of modules.</ol><p>In fact, what our <code>register()</code> method will return is a <code>DynamicModule</code>. A dynamic module is nothing more than a module created at run-time, with the same exact properties as a static module, plus one additional property called <code>module</code>. Let's quickly review a sample static module declaration, paying close attention to the module options passed in to the decorator:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">DogsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>Dynamic modules must return an object with the exact same interface, plus one additional property called <code>module</code>. The <code>module</code> property serves as the name of the module, and should be the same as the class name of the module, as shown in the example below.<blockquote><p>info <strong>Hint</strong> For a dynamic module, all properties of the module options object are optional <strong>except</strong> <code>module</code>.</blockquote><p>What about the static <code>register()</code> method? We can now see that its job is to return an object that has the <code>DynamicModule</code> interface. When we call it, we are effectively providing a module to the <code>imports</code> list, similar to the way we would do so in the static case by listing a module class name. In other words, the dynamic module API simply returns a module, but rather than fix the properties in the <code>@Module</code> decorator, we specify them programmatically.<p>There are still a couple of details to cover to help make the picture complete:<ol><li>We can now state that the <code>@Module()</code> decorator's <code>imports</code> property can take not only a module class name (e.g., <code>imports: [UsersModule]</code>), but also a function <strong>returning</strong> a dynamic module (e.g., <code>imports: [ConfigModule.register(...)]</code>).<li>A dynamic module can itself import other modules. We won't do so in this example, but if the dynamic module depends on providers from other modules, you would import them using the optional <code>imports</code> property. Again, this is exactly analogous to the way you'd declare metadata for a static module using the <code>@Module()</code> decorator.</ol><p>Armed with this understanding, we can now look at what our dynamic <code>ConfigModule</code> declaration must look like. Let's take a crack at it.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DynamicModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigModule</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">DynamicModule</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      module<span class="token operator">:</span> <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">,</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>It should now be clear how the pieces tie together. Calling <code>ConfigModule.register(...)</code> returns a <code>DynamicModule</code> object with properties which are essentially the same as those that, until now, we've provided as metadata via the <code>@Module()</code> decorator.<blockquote><p>info <strong>Hint</strong> Import <code>DynamicModule</code> from <code>@nestjs/common</code>.</blockquote><p>Our dynamic module isn't very interesting yet, however, as we haven't introduced any capability to <strong>configure</strong> it as we said we would like to do. Let's address that next.</section><section id="module-configuration"class="level4"><h4>Module configuration</h4><p>The obvious solution for customizing the behavior of the <code>ConfigModule</code> is to pass it an <code>options</code> object in the static <code>register()</code> method, as we guessed above. Let's look once again at our consuming module's <code>imports</code> property:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config/config.module'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>That nicely handles passing an <code>options</code> object to our dynamic module. How do we then use that <code>options</code> object in the <code>ConfigModule</code>? Let's consider that for a minute. We know that our <code>ConfigModule</code> is basically a host for providing and exporting an injectable service - the <code>ConfigService</code> - for use by other providers. It's actually our <code>ConfigService</code> that needs to read the <code>options</code> object to customize its behavior. Let's assume for the moment that we know how to somehow get the <code>options</code> from the <code>register()</code> method into the <code>ConfigService</code>. With that assumption, we can make a few changes to the service to customize its behavior based on the properties from the <code>options</code> object. (<strong>Note</strong>: for the time being, since we <em>haven't</em> actually determined how to pass it in, we'll just hard-code <code>options</code>. We'll fix this in a minute).<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> dotenv</span> <span class="token keyword module">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> fs</span> <span class="token keyword module">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">EnvConfig</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./interfaces'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigService</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> envConfig<span class="token operator">:</span> <span class="token maybe-class-name">EnvConfig</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.env</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> envFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token property-access">folder</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">envConfig</span> <span class="token operator">=</span> dotenv<span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>envFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">envConfig</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Now our <code>ConfigService</code> knows how to find the <code>.env</code> file in the folder we've specified in <code>options</code>.<p>Our remaining task is to somehow inject the <code>options</code> object from the <code>register()</code> step into our <code>ConfigService</code>. And of course, we'll use <em>dependency injection</em> to do it. This is a key point, so make sure you understand it. Our <code>ConfigModule</code> is providing <code>ConfigService</code>. <code>ConfigService</code> in turn depends on the <code>options</code> object that is only supplied at run-time. So, at run-time, we'll need to first bind the <code>options</code> object to the Nest IoC container, and then have Nest inject it into our <code>ConfigService</code>. Remember from the <strong>Custom providers</strong> chapter that providers can <a href="https://docs.nestjs.com/fundamentals/custom-providers#non-service-based-providers">include any value</a> not just services, so we're fine using dependency injection to handle a simple <code>options</code> object.<p>Let's tackle binding the options object to the IoC container first. We do this in our static <code>register()</code> method. Remember that we are dynamically constructing a module, and one of the properties of a module is its list of providers. So what we need to do is define our options object as a provider. This will make it injectable into the <code>ConfigService</code>, which we'll take advantage of in the next step. In the code below, pay attention to the <code>providers</code> array:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">DynamicModule</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigModule</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">register</span><span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">DynamicModule</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      module<span class="token operator">:</span> <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">,</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          provide<span class="token operator">:</span> <span class="token string">'CONFIG_OPTIONS'</span><span class="token punctuation">,</span>
          useValue<span class="token operator">:</span> options<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token maybe-class-name">ConfigService</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Now we can complete the process by injecting the <code>'CONFIG_OPTIONS'</code> provider into the <code>ConfigService</code>. Recall that when we define a provider using a non-class token we need to use the <code>@Inject()</code> decorator <a href="https://docs.nestjs.com/fundamentals/custom-providers#non-class-based-provider-tokens">as described here</a>.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> dotenv</span> <span class="token keyword module">from</span> <span class="token string">'dotenv'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> fs</span> <span class="token keyword module">from</span> <span class="token string">'fs'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">Inject</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">EnvConfig</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./interfaces'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigService</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> envConfig<span class="token operator">:</span> <span class="token maybe-class-name">EnvConfig</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'CONFIG_OPTIONS'</span><span class="token punctuation">)</span> <span class="token keyword">private</span> options<span class="token operator">:</span> <span class="token maybe-class-name">Record</span><span class="token operator">&#x3C;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span><span class="token property-access">env</span><span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.env</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> envFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../../'</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span><span class="token property-access">folder</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">envConfig</span> <span class="token operator">=</span> dotenv<span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token method function property-access">readFileSync</span><span class="token punctuation">(</span>envFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">get</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">envConfig</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>One final note: for simplicity we used a string-based injection token (<code>'CONFIG_OPTIONS'</code>) above, but best practice is to define it as a constant (or <code>Symbol</code>) in a separate file, and import that file. For example:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token constant">CONFIG_OPTIONS</span> <span class="token operator">=</span> <span class="token string">'CONFIG_OPTIONS'</span><span class="token punctuation">;</span></code></pre></section><section id="example"class="level4"><h4>Example</h4><p>A full example of the code in this chapter can be found <a href="https://github.com/nestjs/nest/tree/master/sample/25-dynamic-modules">here</a>.</section><section id="community-guidelines"class="level4"><h4>Community guidelines</h4><p>You may have seen the use for methods like <code>forRoot</code>, <code>register</code>, and <code>forFeature</code> around some of the <code>@nestjs/</code> packages and may be wondering what the difference for all of these methods are. There is no hard rule about this, but the <code>@nestjs/</code> packages try to follow these guidelines:<p>When creating a module with:<ul><li><p><code>register</code>, you are expecting to configure a dynamic module with a specific configuration for use only by the calling module. For example, with Nest's <code>@nestjs/axios</code>: <code>HttpModule.register({{ '{' }} baseUrl: 'someUrl' {{ '}' }})</code>. If, in another module you use <code>HttpModule.register({{ '{' }} baseUrl: 'somewhere else' {{ '}' }})</code>, it will have the different configuration. You can do this for as many modules as you want.<li><p><code>forRoot</code>, you are expecting to configure a dynamic module once and reuse that configuration in multiple places (though possibly unknowingly as it's abstracted away). This is why you have one <code>GraphQLModule.forRoot()</code>, one <code>TypeOrmModule.forRoot()</code>, etc.<li><p><code>forFeature</code>, you are expecting to use the configuration of a dynamic module's <code>forRoot</code> but need to modify some configuration specific to the calling module's needs (i.e. which repository this module should have access to, or the context that a logger should use.)</ul><p>All of these, usually, have their <code>async</code> counterparts as well, <code>registerAsync</code>, <code>forRootAsync</code>, and <code>forFeatureAsync</code>, that mean the same thing, but use Nest's Dependency Injection for the configuration as well.</section><section id="configurable-module-builder"class="level4"><h4>Configurable module builder</h4><p>As manually creating highly configurable, dynamic modules that expose <code>async</code> methods (<code>registerAsync</code>, <code>forRootAsync</code>, etc.) is quite complicated, especially for newcomers, Nest exposes the <code>ConfigurableModuleBuilder</code> class that facilitates this process and lets you construct a module "blueprint" in just a few lines of code.<p>For example, let's take the example we used above (<code>ConfigModule</code>) and convert it to use the <code>ConfigurableModuleBuilder</code>. Before we start, let's make sure we create a dedicated interface that represents what options our <code>ConfigModule</code> takes in.<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">interface</span> <span class="token class-name"><span class="token maybe-class-name">ConfigModuleOptions</span></span> <span class="token punctuation">{</span>
  folder<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>With this in place, create a new dedicated file (alongside the existing <code>config.module.ts</code> file) and name it <code>config.module-definition.ts</code>. In this file, let's utilize the <code>ConfigurableModuleBuilder</code> to construct <code>ConfigModule</code> definition.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token operator">-</span>definition<span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleBuilder</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigModuleOptions</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./interfaces/config-module-options.interface'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ConfigModuleOptions</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleBuilder</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now let's open up the <code>config.module.ts</code> file and modify its implementation to leverage the auto-generated <code>ConfigurableModuleClass</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config.module-definition'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigModule</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleClass</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Extending the <code>ConfigurableModuleClass</code> means that <code>ConfigModule</code> provides now not only the <code>register</code> method (as previously with the custom implementation), but also the <code>registerAsync</code> method which allows consumers asynchronously configure that module, for example, by supplying async factories:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// or alternatively:</span>
    <span class="token comment">// ConfigModule.registerAsync({</span>
    <span class="token comment">//   useFactory: () => {</span>
    <span class="token comment">//     return {</span>
    <span class="token comment">//       folder: './config',</span>
    <span class="token comment">//     }</span>
    <span class="token comment">//   },</span>
    <span class="token comment">//   inject: [...any extra dependencies...]</span>
    <span class="token comment">// }),</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>Lastly, let's update the <code>ConfigService</code> class to inject the generated module options' provider instead of the <code>'CONFIG_OPTIONS'</code> that we used so far.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token constant">MODULE_OPTIONS_TOKEN</span><span class="token punctuation">)</span> <span class="token keyword">private</span> options<span class="token operator">:</span> <span class="token maybe-class-name">ConfigModuleOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token spread operator">...</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="custom-method-key"class="level4"><h4>Custom method key</h4><p><code>ConfigurableModuleClass</code> by default provides the <code>register</code> and its counterpart <code>registerAsync</code> methods. To use a different method name, use the <code>ConfigurableModuleBuilder#setClassMethodName</code> method, as follows:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token operator">-</span>definition<span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ConfigModuleOptions</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setClassMethodName</span><span class="token punctuation">(</span><span class="token string">'forRoot'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setClassMethodName</span><span class="token punctuation">(</span><span class="token string">'forRoot'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This construction will instruct <code>ConfigurableModuleBuilder</code> to generate a class that exposes <code>forRoot</code> and <code>forRootAsync</code> instead. Example:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span> folder<span class="token operator">:</span> <span class="token string">'./config'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &#x3C;-- note the use of "forRoot" instead of "register"</span>
    <span class="token comment">// or alternatively:</span>
    <span class="token comment">// ConfigModule.forRootAsync({</span>
    <span class="token comment">//   useFactory: () => {</span>
    <span class="token comment">//     return {</span>
    <span class="token comment">//       folder: './config',</span>
    <span class="token comment">//     }</span>
    <span class="token comment">//   },</span>
    <span class="token comment">//   inject: [...any extra dependencies...]</span>
    <span class="token comment">// }),</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="custom-options-factory-class"class="level4"><h4>Custom options factory class</h4><p>Since the <code>registerAsync</code> method (or <code>forRootAsync</code> or any other name, depending on the configuration) lets consumer pass a provider definition that resolves to the module configuration, a library consumer could potentially supply a class to be used to construct the configuration object.<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useClass<span class="token operator">:</span> <span class="token maybe-class-name">ConfigModuleOptionsFactory</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>This class, by default, must provide the <code>create()</code> method that returns a module configuration object. However, if your library follows a different naming convention, you can change that behavior and instruct <code>ConfigurableModuleBuilder</code> to expect a different method, for example, <code>createConfigOptions</code>, using the <code>ConfigurableModuleBuilder#setFactoryMethodName</code> method:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token property-access">module</span><span class="token operator">-</span>definition<span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ConfigModuleOptions</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setFactoryMethodName</span><span class="token punctuation">(</span><span class="token string">'createConfigOptions'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">setFactoryMethodName</span><span class="token punctuation">(</span><span class="token string">'createConfigOptions'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now, <code>ConfigModuleOptionsFactory</code> class must expose the <code>createConfigOptions</code> method (instead of <code>create</code>):<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      useClass<span class="token operator">:</span> <span class="token maybe-class-name">ConfigModuleOptionsFactory</span><span class="token punctuation">,</span> <span class="token comment">// &#x3C;-- this class must provide the "createConfigOptions" method</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></section><section id="extra-options"class="level4"><h4>Extra options</h4><p>There are edge-cases when your module may need to take extra options that determine how it is supposed to behave (a nice example of such an option is the <code>isGlobal</code> flag - or just <code>global</code>) that at the same time, shouldn't be included in the <code>MODULE_OPTIONS_TOKEN</code> provider (as they are irrelevant to services/providers registered within that module, for example, <code>ConfigService</code> does not need to know whether its host module is registered as a global module).<p>In such cases, the <code>ConfigurableModuleBuilder#setExtras</code> method can be used. See the following example:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span> <span class="token constant">MODULE_OPTIONS_TOKEN</span> <span class="token punctuation">}</span> <span class="token operator">=</span>
  <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ConfigModuleOptions</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">setExtras</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        isGlobal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>definition<span class="token punctuation">,</span> extras<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token spread operator">...</span>definition<span class="token punctuation">,</span>
        global<span class="token operator">:</span> extras<span class="token punctuation">.</span><span class="token property-access">isGlobal</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In the example above, the first argument passed into the <code>setExtras</code> method is an object containing default values for the "extra" properties. The second argument is a function that takes an auto-generated module definitions (with <code>provider</code>, <code>exports</code>, etc.) and <code>extras</code> object which represents extra properties (either specified by the consumer or defaults). The returned value of this function is a modified module definition. In this specific example, we're taking the <code>extras.isGlobal</code> property and assigning it to the <code>global</code> property of the module definition (which in turn determines whether a module is global or not, read more <a href="/modules#dynamic-modules">here</a>).<p>Now when consuming this module, the additional <code>isGlobal</code> flag can be passed in, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token maybe-class-name">ConfigModule</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      isGlobal<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      folder<span class="token operator">:</span> <span class="token string">'./config'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">AppModule</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p>However, since <code>isGlobal</code> is declared as an "extra" property, it won't be available in the <code>MODULE_OPTIONS_TOKEN</code> provider:<pre class="language-typescript"><code class="language-typescript"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigService</span></span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>
    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token constant">MODULE_OPTIONS_TOKEN</span><span class="token punctuation">)</span> <span class="token keyword">private</span> options<span class="token operator">:</span> <span class="token maybe-class-name">ConfigModuleOptions</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// "options" object will not have the "isGlobal" property</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="extending-auto-generated-methods"class="level4"><h4>Extending auto-generated methods</h4><p>The auto-generated static methods (<code>register</code>, <code>registerAsync</code>, etc.) can be extended if needed, as follows:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Module</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ConfigService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./config.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span>
  <span class="token constant">ASYNC_OPTIONS_TYPE</span><span class="token punctuation">,</span>
  <span class="token constant">OPTIONS_TYPE</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword module">from</span> <span class="token string">'./config.module-definition'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  exports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">ConfigService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">ConfigModule</span></span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleClass</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">register</span><span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token keyword">typeof</span> <span class="token constant">OPTIONS_TYPE</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">DynamicModule</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// your custom logic here</span>
      <span class="token spread operator">...</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">register</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">registerAsync</span><span class="token punctuation">(</span>options<span class="token operator">:</span> <span class="token keyword">typeof</span> <span class="token constant">ASYNC_OPTIONS_TYPE</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token maybe-class-name">DynamicModule</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span>
      <span class="token comment">// your custom logic here</span>
      <span class="token spread operator">...</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token method function property-access">registerAsync</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Note the use of <code>OPTIONS_TYPE</code> and <code>ASYNC_OPTIONS_TYPE</code> types that must be exported from the module definition file:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
  <span class="token maybe-class-name">ConfigurableModuleClass</span><span class="token punctuation">,</span>
  <span class="token constant">MODULE_OPTIONS_TOKEN</span><span class="token punctuation">,</span>
  <span class="token constant">OPTIONS_TYPE</span><span class="token punctuation">,</span>
  <span class="token constant">ASYNC_OPTIONS_TYPE</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ConfigurableModuleBuilder</span><span class="token operator">&#x3C;</span><span class="token maybe-class-name">ConfigModuleOptions</span><span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>