<!doctype html><html lang="en"><meta charset="utf-8"><title>Testing</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="testing"class="level3"><h3>Testing</h3><p>Automated testing is considered an essential part of any serious software development effort. Automation makes it easy to repeat individual tests or test suites quickly and easily during development. This helps ensure that releases meet quality and performance goals. Automation helps increase coverage and provides a faster feedback loop to developers. Automation both increases the productivity of individual developers and ensures that tests are run at critical development lifecycle junctures, such as source code control check-in, feature integration, and version release.<p>Such tests often span a variety of types, including unit tests, end-to-end (e2e) tests, integration tests, and so on. While the benefits are unquestionable, it can be tedious to set them up. Nest strives to promote development best practices, including effective testing, so it includes features such as the following to help developers and teams build and automate tests. Nest:<ul><li>automatically scaffolds default unit tests for components and e2e tests for applications<li>provides default tooling (such as a test runner that builds an isolated module/application loader)<li>provides integration with <a href="https://github.com/facebook/jest">Jest</a> and <a href="https://github.com/visionmedia/supertest">Supertest</a> out-of-the-box, while remaining agnostic to testing tools<li>makes the Nest dependency injection system available in the testing environment for easily mocking components</ul><p>As mentioned, you can use any <strong>testing framework</strong> that you like, as Nest doesn't force any specific tooling. Simply replace the elements needed (such as the test runner), and you will still enjoy the benefits of Nest's ready-made testing facilities.<section id="installation"class="level4"><h4>Installation</h4><p>To get started, first install the required package:<pre class="language-bash"><code class="language-bash">$ <span class="token function">npm</span> i --save-dev @nestjs/testing</code></pre></section><section id="unit-testing"class="level4"><h4>Unit testing</h4><p>In the following example, we test two classes: <code>CatsController</code> and <code>CatsService</code>. As mentioned, <a href="https://github.com/facebook/jest">Jest</a> is provided as the default testing framework. It serves as a test-runner and also provides assert functions and test-double utilities that help with mocking, spying, etc. In the following basic test, we manually instantiate these classes, and ensure that the controller and service fulfill their API contract.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">.</span><span class="token property-access">spec</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'CatsController'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> catsController<span class="token operator">:</span> <span class="token maybe-class-name">CatsController</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> catsService<span class="token operator">:</span> <span class="token maybe-class-name">CatsService</span><span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    catsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    catsController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">CatsController</span></span><span class="token punctuation">(</span>catsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'findAll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an array of cats'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>catsService<span class="token punctuation">,</span> <span class="token string">'findAll'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> catsController<span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'CatsController'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> catsController<span class="token punctuation">;</span>
  <span class="token keyword">let</span> catsService<span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    catsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">CatsService</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    catsController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">CatsController</span></span><span class="token punctuation">(</span>catsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'findAll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an array of cats'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>catsService<span class="token punctuation">,</span> <span class="token string">'findAll'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> catsController<span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> Keep your test files located near the classes they test. Testing files should have a <code>.spec</code> or <code>.test</code> suffix.</blockquote><p>Because the above sample is trivial, we aren't really testing anything Nest-specific. Indeed, we aren't even using dependency injection (notice that we pass an instance of <code>CatsService</code> to our <code>catsController</code>). This form of testing - where we manually instantiate the classes being tested - is often called <strong>isolated testing</strong> as it is independent from the framework. Let's introduce some more advanced capabilities that help you test applications that make more extensive use of Nest features.</section><section id="testing-utilities"class="level4"><h4>Testing utilities</h4><p>The <code>@nestjs/testing</code> package provides a set of utilities that enable a more robust testing process. Let's rewrite the previous example using the built-in <code>Test</code> class:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">controller</span><span class="token punctuation">.</span><span class="token property-access">spec</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Test</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/testing'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'CatsController'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> catsController<span class="token operator">:</span> <span class="token maybe-class-name">CatsController</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> catsService<span class="token operator">:</span> <span class="token maybe-class-name">CatsService</span><span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    catsService <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">CatsService</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    catsController <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">CatsController</span><span class="token operator">></span></span></span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'findAll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an array of cats'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>catsService<span class="token punctuation">,</span> <span class="token string">'findAll'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> catsController<span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Test</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/testing'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsController</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.controller'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./cats.service'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'CatsController'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> catsController<span class="token punctuation">;</span>
  <span class="token keyword">let</span> catsService<span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    catsService <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    catsController <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'findAll'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return an array of cats'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      jest<span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span>catsService<span class="token punctuation">,</span> <span class="token string">'findAll'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token function">expect</span><span class="token punctuation">(</span><span class="token keyword control-flow">await</span> catsController<span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toBe</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The <code>Test</code> class is useful for providing an application execution context that essentially mocks the full Nest runtime, but gives you hooks that make it easy to manage class instances, including mocking and overriding. The <code>Test</code> class has a <code>createTestingModule()</code> method that takes a module metadata object as its argument (the same object you pass to the <code>@Module()</code> decorator). This method returns a <code>TestingModule</code> instance which in turn provides a few methods. For unit tests, the important one is the <code>compile()</code> method. This method bootstraps a module with its dependencies (similar to the way an application is bootstrapped in the conventional <code>main.ts</code> file using <code>NestFactory.create()</code>), and returns a module that is ready for testing.<blockquote><p>info <strong>Hint</strong> The <code>compile()</code> method is <strong>asynchronous</strong> and therefore has to be awaited. Once the module is compiled you can retrieve any <strong>static</strong> instance it declares (controllers and providers) using the <code>get()</code> method.</blockquote><p><code>TestingModule</code> inherits from the <a href="/fundamentals/module-ref">module reference</a> class, and therefore its ability to dynamically resolve scoped providers (transient or request-scoped). Do this with the <code>resolve()</code> method (the <code>get()</code> method can only retrieve static instances).<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

catsService <span class="token operator">=</span> <span class="token keyword control-flow">await</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>Warning</strong> The <code>resolve()</code> method returns a unique instance of the provider, from its own <strong>DI container sub-tree</strong>. Each sub-tree has a unique context identifier. Thus, if you call this method more than once and compare instance references, you will see that they are not equal.</blockquote><blockquote><p>info <strong>Hint</strong> Learn more about the module reference features <a href="/fundamentals/module-ref">here</a>.</blockquote><p>Instead of using the production version of any provider, you can override it with a <a href="/fundamentals/custom-providers">custom provider</a> for testing purposes. For example, you can mock a database service instead of connecting to a live database. We'll cover overrides in the next section, but they're available for unit tests as well.<p><app-banner-courses></app-banner-courses></section><section id="auto-mocking"class="level4"><h4>Auto mocking</h4><p>Nest also allows you to define a mock factory to apply to all of your missing dependencies. This is useful for cases where you have a large number of dependencies in a class and mocking all of them will take a long time and a lot of setup. To make use of this feature, the <code>createTestingModule()</code> will need to be chained up with the <code>useMocker()</code> method, passing a factory for your dependency mocks. This factory can take in an optional token, which is an instance token, any token which is valid for a Nest provider, and returns a mock implementation. The below is an example of creating a generic mocker using <a href="https://www.npmjs.com/package/jest-mock"><code>jest-mock</code></a> and a specific mock for <code>CatsService</code> using <code>jest.fn()</code>.<pre class="language-typescript"><code class="language-typescript"><span class="token comment">// ...</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">ModuleMocker</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MockFunctionMetadata</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'jest-mock'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> moduleMocker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">ModuleMocker</span></span><span class="token punctuation">(</span>global<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'CatsController'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> controller<span class="token operator">:</span> <span class="token maybe-class-name">CatsController</span><span class="token punctuation">;</span>

  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      controllers<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">useMocker</span><span class="token punctuation">(</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'test1'</span><span class="token punctuation">,</span> <span class="token string">'test2'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span>token <span class="token operator">===</span> <span class="token maybe-class-name">CatsService</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword control-flow">return</span> <span class="token punctuation">{</span> findAll<span class="token operator">:</span> jest<span class="token punctuation">.</span><span class="token method function property-access">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">mockResolvedValue</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> token <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> mockMetadata <span class="token operator">=</span> moduleMocker<span class="token punctuation">.</span><span class="token method function property-access">getMetadata</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token keyword module">as</span> <span class="token maybe-class-name">MockFunctionMetadata</span><span class="token operator">&#x3C;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token maybe-class-name">Mock</span> <span class="token operator">=</span> moduleMocker<span class="token punctuation">.</span><span class="token method function property-access">generateFromMetadata</span><span class="token punctuation">(</span>mockMetadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword control-flow">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Mock</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    controller <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsController</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> A general mock factory, like <code>createMock</code> from <a href="https://github.com/golevelup/nestjs/tree/master/packages/testing"><code>@golevelup/ts-jest</code></a> can also be passed directly.</blockquote><p>You can also retrieve these mocks out of the testing container as you normally would custom providers, <code>moduleRef.get(CatsService)</code>.</section><section id="end-to-end-testing"class="level4"><h4>End-to-end testing</h4><p>Unlike unit testing, which focuses on individual modules and classes, end-to-end (e2e) testing covers the interaction of classes and modules at a more aggregate level -- closer to the kind of interaction that end-users will have with the production system. As an application grows, it becomes hard to manually test the end-to-end behavior of each API endpoint. Automated end-to-end tests help us ensure that the overall behavior of the system is correct and meets project requirements. To perform e2e tests we use a similar configuration to the one we just covered in <strong>unit testing</strong>. In addition, Nest makes it easy to use the <a href="https://github.com/visionmedia/supertest">Supertest</a> library to simulate HTTP requests.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span>cats<span class="token punctuation">.</span><span class="token property-access">e2e</span><span class="token operator">-</span>spec<span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> request</span> <span class="token keyword module">from</span> <span class="token string">'supertest'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Test</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/testing'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../../src/cats/cats.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../../src/cats/cats.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">INestApplication</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Cats'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app<span class="token operator">:</span> <span class="token maybe-class-name">INestApplication</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> catsService <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function-variable function">findAll</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">overrideProvider</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">useValue</span><span class="token punctuation">(</span>catsService<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">createNestApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/GET cats</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">getHttpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/cats'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">expect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        data<span class="token operator">:</span> catsService<span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token operator">*</span> <span class="token keyword module">as</span> request</span> <span class="token keyword module">from</span> <span class="token string">'supertest'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Test</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/testing'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../../src/cats/cats.module'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">CatsService</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'../../src/cats/cats.service'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">INestApplication</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Cats'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> app<span class="token operator">:</span> <span class="token maybe-class-name">INestApplication</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> catsService <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function-variable function">findAll</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">[</span><span class="token string">'test'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">CatsModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">overrideProvider</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">useValue</span><span class="token punctuation">(</span>catsService<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">createNestApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/GET cats</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">return</span> <span class="token function">request</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span><span class="token method function property-access">getHttpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">get</span><span class="token punctuation">(</span><span class="token string">'/cats'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token method function property-access">expect</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        data<span class="token operator">:</span> catsService<span class="token punctuation">.</span><span class="token method function property-access">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>info <strong>Hint</strong> If you're using <a href="/techniques/performance">Fastify</a> as your HTTP adapter, it requires a slightly different configuration, and has built-in testing capabilities:<pre class="language-ts"><code class="language-ts"><span class="token keyword">let</span> app<span class="token operator">:</span> <span class="token maybe-class-name">NestFastifyApplication</span><span class="token punctuation">;</span>

<span class="token function">beforeAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  app <span class="token operator">=</span> moduleRef<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createNestApplication</span><span class="token generic class-name"><span class="token operator">&#x3C;</span><span class="token maybe-class-name">NestFastifyApplication</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">FastifyAdapter</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">getHttpAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">ready</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">it</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/GET cats</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">return</span> app
    <span class="token punctuation">.</span><span class="token method function property-access">inject</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      method<span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
      url<span class="token operator">:</span> <span class="token string">'/cats'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token property-access">statusCode</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token property-access">payload</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">toEqual</span><span class="token punctuation">(</span><span class="token comment">/* expectedPayload */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">afterAll</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></blockquote><p>In this example, we build on some of the concepts described earlier. In addition to the <code>compile()</code> method we used earlier, we now use the <code>createNestApplication()</code> method to instantiate a full Nest runtime environment. We save a reference to the running app in our <code>app</code> variable so we can use it to simulate HTTP requests.<p>We simulate HTTP tests using the <code>request()</code> function from Supertest. We want these HTTP requests to route to our running Nest app, so we pass the <code>request()</code> function a reference to the HTTP listener that underlies Nest (which, in turn, may be provided by the Express platform). Hence the construction <code>request(app.getHttpServer())</code>. The call to <code>request()</code> hands us a wrapped HTTP Server, now connected to the Nest app, which exposes methods to simulate an actual HTTP request. For example, using <code>request(...).get('/cats')</code> will initiate a request to the Nest app that is identical to an <strong>actual</strong> HTTP request like <code>get '/cats'</code> coming in over the network.<p>In this example, we also provide an alternate (test-double) implementation of the <code>CatsService</code> which simply returns a hard-coded value that we can test for. Use <code>overrideProvider()</code> to provide such an alternate implementation. Similarly, Nest provides methods to override guards, interceptors, filters and pipes with the<code>overrideGuard()</code>, <code>overrideInterceptor()</code>, <code>overrideFilter()</code>, and <code>overridePipe()</code> methods respectively.<p>Each of the override methods returns an object with 3 different methods that mirror those described for <a href="https://docs.nestjs.com/fundamentals/custom-providers">custom providers</a>:<ul><li><code>useClass</code>: you supply a class that will be instantiated to provide the instance to override the object (provider, guard, etc.).<li><code>useValue</code>: you supply an instance that will override the object.<li><code>useFactory</code>: you supply a function that returns an instance that will override the object.</ul><p>Each of the override method types, in turn, returns the <code>TestingModule</code> instance, and can thus be chained with other methods in the <a href="https://en.wikipedia.org/wiki/Fluent_interface">fluent style</a>. You should use <code>compile()</code> at the end of such a chain to cause Nest to instantiate and initialize the module.<p>Also, sometimes you may want to provide a custom logger e.g. when the tests are run (for example, on a CI server). Use the <code>setLogger()</code> method and pass an object that fulfills the <code>LoggerService</code> interface to instruct the <code>TestModuleBuilder</code> how to log during tests (by default, only "error" logs will be logged to the console).<p>The compiled module has several useful methods, as described in the following table:<table><tr><td><code>createNestApplication()</code><td>Creates and returns a Nest application (<code>INestApplication</code> instance) based on the given module. Note that you must manually initialize the application using the <code>init()</code> method.<tr><td><code>createNestMicroservice()</code><td>Creates and returns a Nest microservice (<code>INestMicroservice</code> instance) based on the given module.<tr><td><code>get()</code><td>Retrieves a static instance of a controller or provider (including guards, filters, etc.) available in the application context. Inherited from the <a href="/fundamentals/module-ref">module reference</a> class.<tr><td><code>resolve()</code><td>Retrieves a dynamically created scoped instance (request or transient) of a controller or provider (including guards, filters, etc.) available in the application context. Inherited from the <a href="/fundamentals/module-ref">module reference</a> class.<tr><td><code>select()</code><td>Navigates through the module's dependency graph; can be used to retrieve a specific instance from the selected module (used along with strict mode (<code>strict: true</code>) in <code>get()</code> method).</table><blockquote><p>info <strong>Hint</strong> Keep your e2e test files inside the <code>test</code> directory. The testing files should have a <code>.e2e-spec</code> suffix.</blockquote></section><section id="overriding-globally-registered-enhancers"class="level4"><h4>Overriding globally registered enhancers</h4><p>If you have a globally registered guard (or pipe, interceptor, or filter), you need to take a few more steps to override that enhancer. To recap the original registration looks like this:<pre class="language-typescript"><code class="language-typescript">providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">APP_GUARD</span><span class="token punctuation">,</span>
    useClass<span class="token operator">:</span> <span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><p>This is registering the guard as a "multi"-provider through the <code>APP_*</code> token. To be able to replace the <code>JwtAuthGuard</code> here, the registration needs to use an existing provider in this slot:<pre class="language-typescript"><code class="language-typescript">providers<span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    provide<span class="token operator">:</span> <span class="token constant">APP_GUARD</span><span class="token punctuation">,</span>
    useExisting<span class="token operator">:</span> <span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">,</span>
    <span class="token comment">// ^^^^^^^^ notice the use of 'useExisting' instead of 'useClass'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span></code></pre><blockquote><p>info <strong>Hint</strong> Change the <code>useClass</code> to <code>useExisting</code> to reference a registered provider instead of having Nest instantiate it behind the token.</blockquote><p>Now the <code>JwtAuthGuard</code> is visible to Nest as a regular provider that can be overridden when creating the <code>TestingModule</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> moduleRef <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">Test</span><span class="token punctuation">.</span><span class="token method function property-access">createTestingModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">overrideProvider</span><span class="token punctuation">(</span><span class="token maybe-class-name">JwtAuthGuard</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">useClass</span><span class="token punctuation">(</span><span class="token maybe-class-name">MockAuthGuard</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">compile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now all your tests will use the <code>MockAuthGuard</code> on every request.</section><section id="testing-request-scoped-instances"class="level4"><h4>Testing request-scoped instances</h4><p><a href="/fundamentals/injection-scopes">Request-scoped</a> providers are created uniquely for each incoming <strong>request</strong>. The instance is garbage-collected after the request has completed processing. This poses a problem, because we can't access a dependency injection sub-tree generated specifically for a tested request.<p>We know (based on the sections above) that the <code>resolve()</code> method can be used to retrieve a dynamically instantiated class. Also, as described <a href="https://docs.nestjs.com/fundamentals/module-ref#resolving-scoped-providers">here</a>, we know we can pass a unique context identifier to control the lifecycle of a DI container sub-tree. How do we leverage this in a testing context?<p>The strategy is to generate a context identifier beforehand and force Nest to use this particular ID to create a sub-tree for all incoming requests. In this way we'll be able to retrieve instances created for a tested request.<p>To accomplish this, use <code>jest.spyOn()</code> on the <code>ContextIdFactory</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword">const</span> contextId <span class="token operator">=</span> <span class="token maybe-class-name">ContextIdFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
jest
  <span class="token punctuation">.</span><span class="token method function property-access">spyOn</span><span class="token punctuation">(</span><span class="token maybe-class-name">ContextIdFactory</span><span class="token punctuation">,</span> <span class="token string">'getByRequest'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token method function property-access">mockImplementation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> contextId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Now we can use the <code>contextId</code> to access a single generated DI container sub-tree for any subsequent request.<pre class="language-typescript"><code class="language-typescript">catsService <span class="token operator">=</span> <span class="token keyword control-flow">await</span> moduleRef<span class="token punctuation">.</span><span class="token method function property-access">resolve</span><span class="token punctuation">(</span><span class="token maybe-class-name">CatsService</span><span class="token punctuation">,</span> contextId<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></section></section>