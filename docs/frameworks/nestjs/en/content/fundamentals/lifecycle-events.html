<!doctype html><html lang="en"><meta charset="utf-8"><title>Lifecycle Events</title><meta name="viewport"content="width=device-width,initial-scale=1"><link rel="stylesheet"href="../../../../../../../../../docs/themes/packages/prism-coy-theme/theme_common.css"><section id="lifecycle-events"class="level3"><h3>Lifecycle Events</h3><p>A Nest application, as well as every application element, has a lifecycle managed by Nest. Nest provides <strong>lifecycle hooks</strong> that give visibility into key lifecycle events, and the ability to act (run registered code on your <code>module</code>, <code>injectable</code> or <code>controller</code>) when they occur.<section id="lifecycle-sequence"class="level4"><h4>Lifecycle sequence</h4><p>The following diagram depicts the sequence of key application lifecycle events, from the time the application is bootstrapped until the node process exits. We can divide the overall lifecycle into three phases: <strong>initializing</strong>, <strong>running</strong> and <strong>terminating</strong>. Using this lifecycle, you can plan for appropriate initialization of modules and services, manage active connections, and gracefully shutdown your application when it receives a termination signal.<figure><img src="/Users/shinichiokada/Bash_Projects/markdown-docs-as-pdf/.vivliostyle/nestjs/en/src/assets/lifecycle-events.png"></figure></section><section id="lifecycle-events-1"class="level4"><h4>Lifecycle events</h4><p>Lifecycle events happen during application bootstrapping and shutdown. Nest calls registered lifecycle hook methods on <code>modules</code>, <code>injectables</code> and <code>controllers</code> at each of the following lifecycle events (<strong>shutdown hooks</strong> need to be enabled first, as described <a href="https://docs.nestjs.com/fundamentals/lifecycle-events#application-shutdown">below</a>). As shown in the diagram above, Nest also calls the appropriate underlying methods to begin listening for connections, and to stop listening for connections.<p>In the following table, <code>onModuleDestroy</code>, <code>beforeApplicationShutdown</code> and <code>onApplicationShutdown</code> are only triggered if you explicitly call <code>app.close()</code> or if the process receives a special system signal (such as SIGTERM) and you have correctly called <code>enableShutdownHooks</code> at application bootstrap (see below <strong>Application shutdown</strong> part).<table><thead><tr><th>Lifecycle hook method<th>Lifecycle event triggering the hook method call<tbody><tr><td><code>onModuleInit()</code><td>Called once the host module's dependencies have been resolved.<tr><td><code>onApplicationBootstrap()</code><td>Called once all modules have been initialized, but before listening for connections.<tr><td><code>onModuleDestroy()</code>*<td>Called after a termination signal (e.g., <code>SIGTERM</code>) has been received.<tr><td><code>beforeApplicationShutdown()</code>*<td>Called after all <code>onModuleDestroy()</code> handlers have completed (Promises resolved or rejected);<br>once complete (Promises resolved or rejected), all existing connections will be closed (<code>app.close()</code> called).<tr><td><code>onApplicationShutdown()</code>*<td>Called after connections close (<code>app.close()</code> resolves).</table><p>* For these events, if you're not calling <code>app.close()</code> explicitly, you must opt-in to make them work with system signals such as <code>SIGTERM</code>. See <a href="fundamentals/lifecycle-events#application-shutdown">Application shutdown</a> below.<blockquote><p>warning <strong>Warning</strong> The lifecycle hooks listed above are not triggered for <strong>request-scoped</strong> classes. Request-scoped classes are not tied to the application lifecycle and their lifespan is unpredictable. They are exclusively created for each request and automatically garbage-collected after the response is sent.</blockquote></section><section id="usage"class="level4"><h4>Usage</h4><p>Each lifecycle hook is represented by an interface. Interfaces are technically optional because they do not exist after TypeScript compilation. Nonetheless, it's good practice to use them in order to benefit from strong typing and editor tooling. To register a lifecycle hook, implement the appropriate interface. For example, to register a method to be called during module initialization on a particular class (e.g., Controller, Provider or Module), implement the <code>OnModuleInit</code> interface by supplying an <code>onModuleInit()</code> method, as shown below:<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span><span class="token punctuation">,</span> <span class="token maybe-class-name">OnModuleInit</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnModuleInit</span></span> <span class="token punctuation">{</span>
  <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The module has been initialized.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Injectable</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword module">export</span> <span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token punctuation">{</span>
  <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The module has been initialized.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></section><section id="asynchronous-initialization"class="level4"><h4>Asynchronous initialization</h4><p>Both the <code>OnModuleInit</code> and <code>OnApplicationBootstrap</code> hooks allow you to defer the application initialization process (return a <code>Promise</code> or mark the method as <code>async</code> and <code>await</code> an asynchronous method completion in the method body).<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token known-class-name class-name">Promise</span><span class="token operator">&#x3C;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></section><section id="application-shutdown"class="level4"><h4>Application shutdown</h4><p>The <code>onModuleDestroy()</code>, <code>beforeApplicationShutdown()</code> and <code>onApplicationShutdown()</code> hooks are called in the terminating phase (in response to an explicit call to <code>app.close()</code> or upon receipt of system signals such as SIGTERM if opted-in). This feature is often used with <a href="https://kubernetes.io/">Kubernetes</a> to manage containers' lifecycles, by <a href="https://www.heroku.com/">Heroku</a> for dynos or similar services.<p>Shutdown hook listeners consume system resources, so they are disabled by default. To use shutdown hooks, you <strong>must enable listeners</strong> by calling <code>enableShutdownHooks()</code>:<pre class="language-typescript"><code class="language-typescript"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">NestFactory</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">AppModule</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">'./app.module'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token maybe-class-name">NestFactory</span><span class="token punctuation">.</span><span class="token method function property-access">create</span><span class="token punctuation">(</span><span class="token maybe-class-name">AppModule</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Starts listening for shutdown hooks</span>
  app<span class="token punctuation">.</span><span class="token method function property-access">enableShutdownHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword control-flow">await</span> app<span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><blockquote><p>warning <strong>warning</strong> Due to inherent platform limitations, NestJS has limited support for application shutdown hooks on Windows. You can expect <code>SIGINT</code> to work, as well as <code>SIGBREAK</code> and to some extent <code>SIGHUP</code> - <a href="https://nodejs.org/api/process.html#process_signal_events">read more</a>. However <code>SIGTERM</code> will never work on Windows because killing a process in the task manager is unconditional, "i.e., there's no way for an application to detect or prevent it". Here's some <a href="https://docs.libuv.org/en/v1.x/signal.html">relevant documentation</a> from libuv to learn more about how <code>SIGINT</code>, <code>SIGBREAK</code> and others are handled on Windows. Also, see Node.js documentation of <a href="https://nodejs.org/api/process.html#process_signal_events">Process Signal Events</a></blockquote><blockquote><p>info <strong>Info</strong> <code>enableShutdownHooks</code> consumes memory by starting listeners. In cases where you are running multiple Nest apps in a single Node process (e.g., when running parallel tests with Jest), Node may complain about excessive listener processes. For this reason, <code>enableShutdownHooks</code> is not enabled by default. Be aware of this condition when you are running multiple instances in a single Node process.</blockquote><p>When the application receives a termination signal it will call any registered <code>onModuleDestroy()</code>, <code>beforeApplicationShutdown()</code>, then <code>onApplicationShutdown()</code> methods (in the sequence described above) with the corresponding signal as the first parameter. If a registered function awaits an asynchronous call (returns a promise), Nest will not continue in the sequence until the promise is resolved or rejected.<pre class="language-typescript"><code class="language-typescript">@<span class="token decorator"><span class="token at operator">@</span><span class="token function">filename</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnApplicationShutdown</span></span> <span class="token punctuation">{</span>
  <span class="token function">onApplicationShutdown</span><span class="token punctuation">(</span>signal<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. "SIGINT"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
@@<span class="token keyword control-flow">switch</span>
<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name"><span class="token maybe-class-name">UsersService</span></span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token maybe-class-name">OnApplicationShutdown</span></span> <span class="token punctuation">{</span>
  <span class="token function">onApplicationShutdown</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>signal<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// e.g. "SIGINT"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><blockquote><p>info <strong>Info</strong> Calling <code>app.close()</code> doesn't terminate the Node process but only triggers the <code>onModuleDestroy()</code> and <code>onApplicationShutdown()</code> hooks, so if there are some intervals, long-running background tasks, etc. the process won't be automatically terminated. <span style="float:footnote"><a href="../index.html#toc">Go to TOC</a></span></blockquote></section></section>